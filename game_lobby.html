<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸŒ¸ LOPPY ä¹å›­ ğŸŒ¸</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        /* === 1. å…¨å±€å­—ä½“ä¸è®¾ç½® === */
        @font-face {
            font-family: 'MyCutieFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --bg-start: #fff1eb;
            --bg-end: #ace0f9;
            --card-bg: rgba(255, 255, 255, 0.9);
            --main-pink: #ff9a9e;
            --soft-pink: #fecfef;
            --text-color: #885a5a;
            --btn-blue: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%);
            --btn-pink: linear-gradient(120deg, #fccb90 0%, #d57eeb 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'MyCutieFont', 'Microsoft YaHei', sans-serif;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* === 2. èƒŒæ™¯é£˜æµ®ç‰¹æ•ˆ === */
        .floating-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; overflow: hidden;
        }
        .floating-item {
            position: absolute; bottom: -50px; font-size: 24px; opacity: 0.7;
            animation: floatUp 15s linear infinite;
            filter: drop-shadow(0 2px 3px rgba(255, 182, 193, 0.4));
        }
        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg) scale(0.8); opacity: 0; }
            100% { transform: translateY(-110vh) rotate(360deg) scale(1.1); opacity: 0; }
        }

        /* === 3. é€šç”¨å¡ç‰‡å®¹å™¨ === */
        .view-container {
            width: 340px;
            padding: 30px;
            background: var(--card-bg);
            border-radius: 30px;
            border: 4px solid #fff;
            outline: 2px dashed var(--main-pink);
            outline-offset: -10px;
            box-shadow: 0 20px 50px rgba(255, 154, 158, 0.2), inset 0 0 20px rgba(255, 255, 255, 0.8);
            text-align: center;
            position: relative;
            z-index: 10;
            display: none; /* é»˜è®¤éšè—ï¼Œé€šè¿‡JSæ§åˆ¶æ˜¾ç¤º */
            animation: popIn 0.4s ease-out;
        }
        
        /* æ¿€æ´»çš„è§†å›¾æ˜¾ç¤º */
        .view-container.active { display: block; }

        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* é¡¶éƒ¨è£…é¥°ç»“ */
        .card-bow {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            font-size: 40px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); z-index: 20;
        }

        /* æ ‡é¢˜ */
        h1, h2 { color: var(--text-color); margin-top: 10px; text-shadow: 2px 2px 0px #fff; }
        h1 { font-size: 36px; margin-bottom: 5px; }
        h2 { font-size: 28px; margin-bottom: 20px; }

        .subtitle {
            display: inline-block; font-size: 14px; color: #fff;
            background: var(--main-pink); padding: 4px 15px;
            border-radius: 20px; margin-bottom: 30px;
            box-shadow: 0 4px 10px rgba(255, 154, 158, 0.4);
        }

        /* === 4. æŒ‰é’®æ ·å¼ === */
        .cute-btn {
            position: relative; width: 100%; padding: 15px; margin-bottom: 15px;
            border-radius: 25px; border: 3px solid #fff; color: white;
            font-size: 18px; font-family: inherit; cursor: pointer;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1); transition: transform 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            text-decoration: none;
        }
        .cute-btn:active { transform: scale(0.95); }
        .btn-blue { background: var(--btn-blue); text-shadow: 1px 1px 2px rgba(74, 144, 226, 0.3); }
        .btn-pink { background: var(--btn-pink); text-shadow: 1px 1px 2px rgba(214, 82, 129, 0.3); }
        .btn-disabled { background: #e0e0e0; cursor: not-allowed; opacity: 0.8; }

        /* === 5. åº•éƒ¨é“¾æ¥ === */
        .divider {
            margin: 20px 0; height: 1px;
            background: repeating-linear-gradient(to right, var(--main-pink) 0, var(--main-pink) 5px, transparent 5px, transparent 10px);
        }
        .back-link {
            display: block; color: var(--text-color); text-decoration: none;
            font-size: 14px; opacity: 0.7; cursor: pointer;
        }
        .back-link:hover { text-decoration: underline; text-decoration-style: wavy; text-decoration-color: var(--main-pink); }

        /* === 6. [PVPç•Œé¢ä¸“å±] å¸ƒå±€ === */
        .connect-box {
            background: #fdfdfd; border-radius: 15px; padding: 12px;
            border: 2px dashed #a1c4fd; margin-bottom: 15px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .id-display {
            font-size: 13px; color: #888; cursor: pointer;
            background: #f0f8ff; padding: 8px; border-radius: 10px;
            word-break: break-all;
        }
        .input-row { display: flex; gap: 8px; width: 100%; align-items: center; }
        .code-input {
            flex: 1; min-width: 0; padding: 10px; border-radius: 12px;
            border: 2px solid #eee; outline: none; font-family: inherit; font-size: 14px;
        }
        .btn-connect {
            flex-shrink: 0; border: none; background: var(--btn-blue); color: white;
            padding: 10px 15px; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 14px; white-space: nowrap;
        }
        
        .arena { display: flex; justify-content: space-around; align-items: flex-end; height: 110px; position: relative; }
        .player { transition: transform 0.2s; position: relative; display: flex; flex-direction: column; align-items: center; }
        .avatar {
            font-size: 45px; background: #fff; width: 70px; height: 70px;
            border-radius: 50%; border: 4px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
        }
        .p-tag { font-size: 12px; color: #fff; background: var(--main-pink); padding: 2px 8px; border-radius: 10px; margin-top: -12px; position: relative; z-index: 2; }
        .p2 { filter: grayscale(1); opacity: 0.6; transition: 0.5s; }
        .p2.connected { filter: grayscale(0); opacity: 1; }

        /* ç‰¹æ•ˆå­— */
        .pop-text {
            position: absolute; top: -20px; font-size: 24px; font-weight: bold;
            opacity: 0; pointer-events: none; color: #ff6b81; width: 100%; text-align: center;
            text-shadow: 2px 2px 0 #fff;
        }
        @keyframes popUp {
            0% { transform: scale(0) translateY(20px); opacity: 1; }
            50% { transform: scale(1.2) translateY(-20px); }
            100% { transform: scale(1) translateY(-50px); opacity: 0; }
        }

        .action-row { display: flex; gap: 10px; margin-top: 10px; }
        .game-btn { flex: 1; padding: 12px; border-radius: 15px; border:none; color:white; font-family:inherit; cursor:pointer; font-size:16px; }

        /* è¿”å›å¤§å…æŒ‰é’® (å·¦ä¸Šè§’) */
        .header-back { position: absolute; top: 15px; left: 15px; font-size: 20px; cursor: pointer; text-decoration: none; }

    </style>
</head>
<body>

    <div class="floating-container" id="floatContainer"></div>

    <div id="view-lobby" class="view-container active">
        <div class="card-bow">ğŸ€</div>
        <h1>GAME LOPPY</h1>
        <div class="subtitle">âœ¨ é­”æ³•å°‘å¥³ç«æŠ€åœº âœ¨</div>

        <div class="btn-group">
            <div class="cute-btn btn-blue" onclick="alert('ğŸ° äººæœºæ¨¡å¼æ­£åœ¨å¼€å‘ä¸­...')">
                <span style="font-size: 22px;">ğŸ°</span> 
                <span>äººæœºè¯•ç‚¼</span>
            </div>

            <div class="cute-btn btn-pvp btn-pink" onclick="switchView('pvp')">
                <span style="font-size: 22px;">ğŸ’•</span> 
                <span>å¯†å‹è¿çº¿</span>
            </div>
        </div>

        <div class="divider"></div>
        <a href="index.html" class="back-link">â†© å›åˆ°ç™¾å®ç®±</a>
    </div>

    <div id="view-pvp" class="view-container">
        <div class="card-bow">ğŸ€</div>
        <div class="header-back" onclick="switchView('lobby')">ğŸ”™</div>

        <h2>âœ¨ å¯†å‹è¿çº¿ âœ¨</h2>

        <div class="connect-box" id="connectPanel">
            <div class="id-display" onclick="copyMyId()">
                æˆ‘çš„é¢‘æ®µ: <span id="myId" style="color:#ff9a9e; font-weight:bold;">ç”Ÿæˆä¸­...</span> (ç‚¹æˆ‘å¤åˆ¶)
            </div>
            <div class="input-row">
                <input type="text" id="friendIdInput" class="code-input" placeholder="ç²˜è´´æœ‹å‹çš„é¢‘æ®µ...">
                <button class="btn-connect" onclick="connectFriend()">ğŸ”— è¿çº¿</button>
            </div>
            <div id="statusMsg" style="font-size:12px; color:#aaa; margin-top:2px;">ç­‰å¾…è¾“å…¥...</div>
        </div>

        <div class="arena">
            <div class="player p1" id="p1">
                <div class="pop-text" id="p1Effect"></div>
                <div class="avatar">ğŸ°</div>
                <div class="p-tag">æˆ‘</div>
            </div>
            <div style="align-self:center; font-size:24px; color:#ff9a9e;">âš¡</div>
            <div class="player p2" id="p2">
                <div class="pop-text" id="p2Effect"></div>
                <div class="avatar">ğŸ¦Š</div>
                <div class="p-tag">å¯†å‹</div>
            </div>
        </div>

        <div class="action-row">
            <button class="game-btn btn-pink btn-disabled" id="btn1" onclick="sendAction('hug')" disabled>âœ¨ è´´è´´</button>
            <button class="game-btn btn-blue btn-disabled" id="btn2" onclick="sendAction('feed')" disabled>ğŸ° æŠ•å–‚</button>
        </div>
    </div>

    <script>
        // === 1. èƒŒæ™¯é£˜æµ®ç‰©ç”Ÿæˆ ===
        const icons = ['ğŸ€', 'ğŸŒ¸', 'ğŸ“', 'ğŸ§', 'âœ¨', 'ğŸ­', 'ğŸ§¸', 'ğŸ’–'];
        const container = document.getElementById('floatContainer');
        for (let i = 0; i < 15; i++) {
            const el = document.createElement('div');
            el.className = 'floating-item';
            el.innerText = icons[Math.floor(Math.random() * icons.length)];
            el.style.left = Math.random() * 100 + '%';
            el.style.fontSize = (Math.random() * 16 + 16) + 'px';
            el.style.animationDuration = (Math.random() * 10 + 8) + 's';
            el.style.animationDelay = (Math.random() * 5) + 's';
            container.appendChild(el);
        }

        // === 2. ç•Œé¢åˆ‡æ¢é€»è¾‘ (æ ¸å¿ƒ) ===
        function switchView(viewName) {
            // éšè—æ‰€æœ‰è§†å›¾
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            // æ˜¾ç¤ºç›®æ ‡è§†å›¾
            document.getElementById('view-' + viewName).classList.add('active');
            
            // å¦‚æœæ˜¯è¿›å…¥PVPæ¨¡å¼ï¼Œä¸”Peerè¿˜æ²¡åˆå§‹åŒ–ï¼Œè¿™é‡Œå¯ä»¥åšæ£€æŸ¥ï¼ˆç›®å‰ä»£ç æ˜¯è‡ªåŠ¨åˆå§‹åŒ–çš„ï¼Œæ— éœ€é¢å¤–æ“ä½œï¼‰
        }

        // === 3. è”æœºæ ¸å¿ƒé€»è¾‘ (PeerJS) ===
        let peer = null;
        let conn = null;
        const myIdEl = document.getElementById('myId');
        const statusEl = document.getElementById('statusMsg');
        const p2El = document.getElementById('p2');
        const btn1 = document.getElementById('btn1');
        const btn2 = document.getElementById('btn2');

        // åˆå§‹åŒ– Peer
        peer = new Peer(null, { debug: 2 });

        peer.on('open', (id) => {
            myIdEl.innerText = id;
            statusEl.innerText = "âœ… é¢‘æ®µå·²ç”Ÿæˆï¼Œå¿«å‘ç»™æœ‹å‹ï¼";
        });

        peer.on('connection', (connection) => { setupConnection(connection); });
        peer.on('error', (err) => { statusEl.innerText = "âŒ é”™è¯¯: " + err.type; });

        function connectFriend() {
            const friendId = document.getElementById('friendIdInput').value.trim();
            if (!friendId) return alert('è¯·ç²˜è´´æœ‹å‹çš„IDï¼');
            statusEl.innerText = "â³ è¿æ¥ä¸­...";
            const connection = peer.connect(friendId);
            setupConnection(connection);
        }

        function setupConnection(connection) {
            conn = connection;
            conn.on('open', () => {
                statusEl.innerText = "â¤ï¸ å¯†å‹å·²è¿æ¥ï¼";
                statusEl.style.color = "#ff9a9e";
                p2El.classList.add('connected');
                document.getElementById('connectPanel').style.display = 'none'; // éšè—è¾“å…¥æ¡†
                
                // æ¿€æ´»æŒ‰é’®
                btn1.disabled = false; btn1.classList.remove('btn-disabled');
                btn2.disabled = false; btn2.classList.remove('btn-disabled');
            });

            conn.on('data', (data) => {
                if (data.type === 'hug') triggerEffect('p1', 'âœ¨ è´´è´´ï¼');
                if (data.type === 'feed') triggerEffect('p1', 'ğŸ° å“‡å‘œï¼');
            });

            conn.on('close', () => {
                alert('ğŸ’” å¯¹æ–¹æ–­å¼€äº†è¿æ¥');
                location.reload(); 
            });
        }

        function sendAction(type) {
            if (!conn) return;
            conn.send({ type: type });
            if (type === 'hug') triggerEffect('p2', 'âœ¨ è´´è´´ï¼');
            if (type === 'feed') triggerEffect('p2', 'ğŸ° æŠ•å–‚ï¼');
        }

        function triggerEffect(targetId, text) {
            const player = document.getElementById(targetId);
            const effectEl = document.getElementById(targetId + 'Effect');
            
            effectEl.innerText = text;
            effectEl.style.animation = 'none';
            effectEl.offsetHeight; 
            effectEl.style.animation = 'popUp 0.8s ease-out';

            if (targetId === 'p1' && navigator.vibrate) navigator.vibrate(50);
            
            player.style.transform = "scale(1.2)";
            setTimeout(() => player.style.transform = "scale(1)", 200);
        }

        function copyMyId() {
            const id = myIdEl.innerText;
            if (id === 'ç”Ÿæˆä¸­...') return;
            navigator.clipboard.writeText(id).then(() => {
                statusEl.innerText = "ğŸ“‹ å·²å¤åˆ¶ï¼å»å‘ç»™æœ‹å‹å§~";
            });
        }
    </script>
</body>
</html>
