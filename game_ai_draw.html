<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ¤– AI çµé­‚ç”»æ‰‹</title>
    <style>
        @font-face { font-family: 'MyCutieFont'; src: url('https://files.catbox.moe/cweam3.ttf') format('truetype'); font-display: swap; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'MyCutieFont', sans-serif;
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* é¡¶éƒ¨ */
        .top-bar {
            padding: 15px; background: rgba(255,255,255,0.9); display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px solid #a29bfe; z-index: 100;
        }
        .back-btn { text-decoration: none; font-size: 24px; cursor: pointer; }
        .score-board { font-size: 18px; color: #6c5ce7; font-weight: bold; }

        /* æ¸¸æˆåŒº */
        .main-area { flex: 1; display: flex; flex-direction: column; padding: 10px; gap: 10px; position: relative; }
        
        /* AIå½¢è±¡åŒº */
        .ai-status {
            display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.6); 
            padding: 10px; border-radius: 15px; border: 2px solid #fff;
        }
        .ai-avatar { width: 50px; height: 50px; border-radius: 50%; background: #fff; border: 2px solid #a29bfe; overflow: hidden; }
        .ai-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .ai-bubble { background: #fff; padding: 5px 10px; border-radius: 10px; font-size: 14px; position: relative; color: #555; }
        .ai-bubble::after { content:''; position:absolute; left:-6px; top:50%; margin-top:-6px; border-width:6px; border-style:solid; border-color:transparent #fff transparent transparent; }

        /* ç”»æ¿ */
        .canvas-box {
            flex: 1; background: #fff; border-radius: 20px; border: 4px solid #a29bfe;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        canvas { width: 100%; height: 100%; border-radius: 15px; }

        /* çŒœé¢˜åŒº */
        .guess-area {
            display: flex; gap: 10px; padding: 5px;
        }
        .ipt { flex: 1; padding: 12px; border-radius: 20px; border: 2px solid #fff; outline: none; font-family: inherit; font-size: 16px; background: rgba(255,255,255,0.8); }
        .btn { padding: 0 20px; border-radius: 20px; border: none; background: #a29bfe; color: white; font-weight: bold; cursor: pointer; }

        /* è§’è‰²é€‰æ‹©å¼¹çª— */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #fff; padding: 25px; border-radius: 30px; width: 90%; max-width: 350px;
            text-align: center; border: 4px solid #a29bfe; max-height: 80vh; display: flex; flex-direction: column;
        }
        .char-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; 
            overflow-y: auto; padding: 5px;
        }
        .char-item { 
            border: 2px solid #eee; border-radius: 10px; padding: 5px; cursor: pointer; transition: 0.2s;
        }
        .char-item:hover, .char-item.selected { border-color: #a29bfe; background: #f3e5f5; transform: scale(1.1); }
        .char-img { width: 50px; height: 50px; border-radius: 50%; background: #ddd; margin: 0 auto; object-fit: cover; }
        .char-name { font-size: 12px; margin-top: 5px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* èƒœåˆ©ç‰¹æ•ˆ */
        .confetti { position: absolute; width: 10px; height: 10px; background: #f00; animation: fall 3s linear forwards; pointer-events: none; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

    </style>
</head>
<body>

    <div class="top-bar">
        <a href="game_loppy.html" class="back-btn">ğŸ”™</a>
        <div class="score-board">å¾—åˆ†: <span id="scoreVal">0</span></div>
    </div>

    <div class="main-area">
        <div class="ai-status">
            <div class="ai-avatar" id="aiAvatarDisplay">
                <img src="" id="aiImg" style="display:none">
                <div id="aiEmoji" style="font-size:30px; line-height:50px; text-align:center;">ğŸ¤–</div>
            </div>
            <div class="ai-bubble" id="aiMsg">æ­£åœ¨è¿æ¥ç™¾å®ç®±æ•°æ®åº“...</div>
        </div>

        <div class="canvas-box">
            <canvas id="aiCanvas"></canvas>
        </div>

        <div class="guess-area">
            <input type="text" class="ipt" id="guessInput" placeholder="å®ƒç”»çš„æ˜¯ä»€ä¹ˆï¼Ÿ(å¦‚: è‹¹æœ)" onkeydown="if(event.keyCode==13) checkGuess()">
            <button class="btn" onclick="checkGuess()">æäº¤</button>
        </div>
    </div>

    <div class="modal" id="charModal">
        <div class="modal-box">
            <h2 style="color:#a29bfe;">ğŸ¤– è¯·ç¿»ç‰Œå­</h2>
            <p style="font-size:12px; color:#888;">(ä»ä½ çš„ç™¾å®ç®±é‡Œé€‰ä¸€ä¸ªç”»å¸ˆ)</p>
            
            <div class="char-grid" id="charList">
                <div style="color:#ccc; font-size:12px; grid-column:span 3;">æ­£åœ¨ä»ç™¾å®ç®±æ‘‡äºº...</div>
            </div>

            <button class="btn" style="width:100%; padding:12px;" onclick="startGame()">å¼€å§‹æŒ‘æˆ˜</button>
        </div>
    </div>

    <script>
        // ================= ğŸ¨ ç¬”è§¦æ•°æ®åº“ =================
        const DRAWINGS = {
            "è‹¹æœ": [
                {color: "#ff7675", width: 5, path: [[0.5, 0.3], [0.3, 0.3], [0.2, 0.5], [0.25, 0.7], [0.4, 0.8], [0.5, 0.75], [0.6, 0.8], [0.75, 0.7], [0.8, 0.5], [0.7, 0.3], [0.5, 0.3]]},
                {color: "#00b894", width: 3, path: [[0.5, 0.3], [0.5, 0.15]]},
                {color: "#00b894", width: 3, path: [[0.5, 0.15], [0.6, 0.1]]}
            ],
            "å¤ªé˜³": [
                {color: "#fdcb6e", width: 5, path: [[0.5,0.3], [0.3,0.5], [0.5,0.7], [0.7,0.5], [0.5,0.3]]},
                {color: "#fdcb6e", width: 3, path: [[0.5,0.2], [0.5,0.1]]}, {color: "#fdcb6e", width: 3, path: [[0.5,0.8], [0.5,0.9]]},
                {color: "#fdcb6e", width: 3, path: [[0.2,0.5], [0.1,0.5]]}, {color: "#fdcb6e", width: 3, path: [[0.8,0.5], [0.9,0.5]]},
                {color: "#fdcb6e", width: 3, path: [[0.3,0.3], [0.2,0.2]]}, {color: "#fdcb6e", width: 3, path: [[0.7,0.7], [0.8,0.8]]},
                {color: "#fdcb6e", width: 3, path: [[0.3,0.7], [0.2,0.8]]}, {color: "#fdcb6e", width: 3, path: [[0.7,0.3], [0.8,0.2]]}
            ],
            "çˆ±å¿ƒ": [ {color: "#e84393", width: 5, path: [[0.5, 0.8], [0.2, 0.5], [0.2, 0.3], [0.35, 0.2], [0.5, 0.35], [0.65, 0.2], [0.8, 0.3], [0.8, 0.5], [0.5, 0.8]]} ],
            "æ ‘": [
                {color: "#b76e27", width: 8, path: [[0.5, 0.9], [0.5, 0.6]]},
                {color: "#2ecc71", width: 10, path: [[0.5, 0.6], [0.3, 0.5], [0.2, 0.4], [0.5, 0.2], [0.8, 0.4], [0.7, 0.5], [0.5, 0.6]]}
            ],
            "ç¬‘è„¸": [
                {color: "#000", width: 3, path: [[0.3, 0.4], [0.3, 0.41]]}, {color: "#000", width: 3, path: [[0.7, 0.4], [0.7, 0.41]]},
                {color: "#d63031", width: 3, path: [[0.3, 0.7], [0.4, 0.8], [0.6, 0.8], [0.7, 0.7]]},
                {color: "#0984e3", width: 2, path: [[0.5, 0.1], [0.1, 0.5], [0.5, 0.9], [0.9, 0.5], [0.5, 0.1]]}
            ],
            "æ•°å­—7": [ {color: "#2d3436", width: 5, path: [[0.3, 0.2], [0.7, 0.2], [0.4, 0.8]]} ]
        };

        // é»˜è®¤ä¿åº•è§’è‰² (é˜²æ­¢æ•°æ®åº“ç©ºçš„)
        const DEFAULT_CHARS = [
            { name: "å‘†å‘†Loppy", avatar: "https://files.catbox.moe/fv8f8p.gif", speed: 20 },
            { name: "èªæ˜ç‹ç‹¸", avatar: "https://files.catbox.moe/vdvz1m.gif", speed: 10 }
        ];

        // ================= ğŸ’¾ æ•°æ®åº“è¿æ¥é€»è¾‘ =================
        const DB_NAME = 'MyMagicDB';
        const STORE_NAME = 'items';

        // ä»ç™¾å®ç®±æ•°æ®åº“åŠ è½½è§’è‰²
        function loadCharactersFromTreasureBox() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME); // æ‰“å¼€æ•°æ®åº“

                request.onerror = (event) => {
                    console.log("æ•°æ®åº“æ‰“å¼€å¤±è´¥ (å¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡ç©): " + event.target.errorCode);
                    resolve([]); // å¤±è´¥å°±è¿”å›ç©ºæ•°ç»„ï¼Œç”¨é»˜è®¤çš„
                };

                request.onsuccess = (event) => {
                    const db = event.target.result;
                    // æ£€æŸ¥æœ‰æ²¡æœ‰ items è¡¨
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        resolve([]);
                        return;
                    }
                    const transaction = db.transaction([STORE_NAME], "readonly");
                    const objectStore = transaction.objectStore(STORE_NAME);
                    const getAllRequest = objectStore.getAll();

                    getAllRequest.onsuccess = (event) => {
                        const items = event.target.result;
                        // è½¬æ¢æ ¼å¼ï¼šæå–åå­—ã€å¤´åƒ(å°é¢)ã€ç”Ÿæˆé€Ÿåº¦
                        const chars = items.map(item => {
                            let avatar = "https://files.catbox.moe/fv8f8p.gif"; // é»˜è®¤å›¾
                            // å°è¯•æ‰¾å°é¢å›¾
                            if (item.resources && item.resources.length > 0) {
                                const images = item.resources.filter(r => r.type === 'image');
                                if (images.length > 0) {
                                    const idx = Math.min(item.coverIndex || 0, images.length - 1);
                                    avatar = images[idx].content;
                                }
                            }
                            
                            // éšæœºåˆ†é…ä¸€ä¸ªç”»ç”»é€Ÿåº¦ (5-25ms)
                            let speed = Math.floor(Math.random() * 20) + 5; 
                            
                            return {
                                name: item.name,
                                avatar: avatar,
                                speed: speed
                            };
                        });
                        resolve(chars);
                    };
                };
                
                // å¦‚æœæ•°æ®åº“ç‰ˆæœ¬å‡çº§ (ä¸€èˆ¬ä¸ä¼šè§¦å‘)
                request.onupgradeneeded = (e) => {
                     e.target.transaction.abort();
                     resolve([]);
                };
            });
        }

        // ================= æ¸¸æˆé€»è¾‘ =================
        let canvas, ctx;
        let selectedChar = null;
        let currentWord = "";
        let isDrawing = false;
        let score = 0;

        window.onload = async function() {
            canvas = document.getElementById('aiCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // ğŸ”¥ å¼‚æ­¥åŠ è½½è§’è‰²åˆ—è¡¨
            await initCharList();
            
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
            const list = document.getElementById('charList');
            if(list.children.length > 0) {
                // æ¨¡æ‹Ÿç‚¹å‡»ç¬¬ä¸€ä¸ª
                list.children[0].click();
            }
        };

        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }

        async function initCharList() {
            const list = document.getElementById('charList');
            list.innerHTML = '';
            
            // 1. ä»æ•°æ®åº“è¯»
            const dbChars = await loadCharactersFromTreasureBox();
            
            // 2. åˆå¹¶é»˜è®¤è§’è‰² (æ”¾åœ¨åé¢å½“ä¿åº•)
            const allChars = [...dbChars, ...DEFAULT_CHARS];

            if (allChars.length === 0) {
                list.innerHTML = '<div style="grid-column:span 3;text-align:center;color:#999;">ç™¾å®ç®±é‡Œç©ºç©ºçš„...</div>';
                return;
            }

            allChars.forEach((char, idx) => {
                let div = document.createElement('div');
                div.className = 'char-item';
                // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œä¼ å…¥ char å¯¹è±¡
                div.onclick = () => selectChar(char, div);
                div.innerHTML = `
                    <img src="${char.avatar}" class="char-img">
                    <div class="char-name">${char.name}</div>
                `;
                list.appendChild(div);
            });
        }

        function selectChar(charObj, el) {
            document.querySelectorAll('.char-item').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            selectedChar = charObj;
        }

        function startGame() {
            if (!selectedChar) {
                alert("è¯·å…ˆé€‰ä¸€ä¸ªç”»æ‰‹ï¼");
                return;
            }
            document.getElementById('charModal').style.display = 'none';
            
            document.getElementById('aiEmoji').style.display = 'none';
            const img = document.getElementById('aiImg');
            img.src = selectedChar.avatar;
            img.style.display = 'block';
            
            updateAiMsg(`æˆ‘æ˜¯ ${selectedChar.name}ï¼Œæˆ‘è¦å¼€å§‹ç”»äº†å“¦ï¼`, 1000);
            setTimeout(nextRound, 1500);
        }

        function updateAiMsg(text, delay=0) {
            setTimeout(() => {
                document.getElementById('aiMsg').innerText = text;
            }, delay);
        }

        function nextRound() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('guessInput').value = '';
            
            const keys = Object.keys(DRAWINGS);
            currentWord = keys[Math.floor(Math.random() * keys.length)];
            
            updateAiMsg(`è¿™å±€ç”»ä¸ªç®€å•çš„... çŒœçŒœçœ‹ï¼Ÿ`);
            drawWord(currentWord);
        }

        async function drawWord(word) {
            const strokes = DRAWINGS[word];
            if(!strokes) return;

            isDrawing = true;
            for (let stroke of strokes) {
                if(!isDrawing) break; 
                ctx.beginPath();
                ctx.strokeStyle = stroke.color;
                ctx.lineWidth = stroke.width;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                const points = stroke.path;
                if(points.length === 0) continue;

                const w = canvas.width;
                const h = canvas.height;

                ctx.moveTo(points[0][0] * w, points[0][1] * h);

                for (let i = 1; i < points.length; i++) {
                    // ğŸ”¥ ä½¿ç”¨è§’è‰²çš„ speed å±æ€§æ¥æ§åˆ¶é€Ÿåº¦
                    // é€Ÿåº¦å€¼è¶Šå°ç”»å¾—è¶Šå¿«
                    await new Promise(r => setTimeout(r, selectedChar.speed)); 
                    ctx.lineTo(points[i][0] * w, points[i][1] * h);
                    ctx.stroke();
                }
            }
            updateAiMsg(`ç”»å®Œå•¦ï¼ä½ çŸ¥é“æ˜¯å•¥å—ï¼Ÿ`);
        }

        function checkGuess() {
            const input = document.getElementById('guessInput');
            const val = input.value.trim();
            if(!val) return;

            if (val === currentWord) {
                score += 10;
                document.getElementById('scoreVal').innerText = score;
                isDrawing = false; 
                confettiEffect();
                updateAiMsg(`ğŸ‰ ç­”å¯¹äº†ï¼å°±æ˜¯ ${currentWord}ï¼`);
                input.value = '';
                setTimeout(nextRound, 2000);
            } else {
                updateAiMsg(`ä¸å¯¹å“¦ï¼Œå†çŒœçŒœï¼Ÿ`);
                input.value = '';
                input.style.border = "2px solid red";
                setTimeout(() => input.style.border = "2px solid #fff", 500);
            }
        }

        function confettiEffect() {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff'];
            for(let i=0; i<30; i++) {
                let div = document.createElement('div');
                div.className = 'confetti';
                div.style.left = Math.random() * 100 + 'vw';
                div.style.top = '-10px';
                div.style.background = colors[Math.floor(Math.random()*colors.length)];
                document.body.appendChild(div);
                setTimeout(()=>div.remove(), 3000);
            }
        }
    </script>
</body>
</html>
