<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸƒ èŒèŒæ–—åœ°ä¸» (è”æœºç‰ˆ)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
      @font-face {
    font-family: 'MyCutieFont';
    src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
    font-display: swap;
}

        :root {
            --main-pink: #ff9a9e;
            --bg-gradient: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%);
            --card-ratio: 1.4;
            --card-w: 80px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'MyCutieFont', sans-serif; 
            height: 100vh; overflow: hidden;
            background: var(--bg-gradient);
            display: flex; flex-direction: column;
        }

        /* === é¡¶éƒ¨æ  === */
        .top-bar {
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.6); backdrop-filter: blur(5px); z-index: 100;
        }
        .back-btn { text-decoration: none; font-size: 20px; cursor: pointer; border: none; background: none; }
        .room-info { font-size: 14px; color: #885a5a; font-weight: bold; }

        /* === æ¸¸æˆåŒºåŸŸ === */
        .game-area { flex: 1; position: relative; width: 100%; height: 100%; }

        /* ç©å®¶å¤´åƒ */
        .player {
            position: absolute; width: 80px; text-align: center; transition: all 0.3s;
        }
        .avatar {
            width: 60px; height: 60px; background: #fff; border-radius: 50%;
            border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 35px; display: flex; align-items: center; justify-content: center;
            margin: 0 auto; position: relative;
        }
        .role-icon {
            position: absolute; top: -15px; right: -5px; font-size: 24px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); display: none;
        }
        .p-info {
            background: rgba(255,255,255,0.8); padding: 2px 8px; border-radius: 10px;
            font-size: 12px; margin-top: -10px; display: inline-block; position: relative; z-index: 2;
        }
        .remain-count {
            font-size: 12px; color: #ff6b81; font-weight: bold; background: #fff;
            padding: 2px 5px; border-radius: 4px; border: 1px solid #ff6b81;
            margin-top: 2px; display: none;
        }

        /* ä½ç½®å®šä¹‰ */
        .p-left { left: 10px; top: 30%; }
        .p-right { right: 10px; top: 30%; }
        .p-me { bottom: 160px; left: 50%; transform: translateX(-50%); }

        /* === ç‰Œæ¡Œä¸­å¿ƒ (å‡ºç‰ŒåŒº/åœ°ä¸»ç‰Œ) === */
        .table-center {
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
            width: 60%; height: 150px; pointer-events: none;
        }
        .di-pai-area {
            position: absolute; top: -80px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 5px; opacity: 0; transition: opacity 0.5s;
        }
        .di-pai-card {
            width: 30px; height: 42px; background: #fff; border-radius: 4px;
            font-size: 10px; display: flex; align-items: center; justify-content: center;
            border: 1px solid #ccc;
        }

        /* å‡ºç‰Œå±•ç¤ºåŒº */
        .played-cards {
            position: absolute; display: flex; transform: scale(0.7);
        }
        .pc-left { left: 80px; top: 30%; }
        .pc-right { right: 80px; top: 30%; justify-content: flex-end; }
        .pc-me { bottom: 0; left: 50%; transform: translateX(-50%) scale(0.9); }

        /* === æ‰‹ç‰ŒåŒºåŸŸ === */
        .my-hand {
            position: absolute; bottom: 10px; width: 100%; height: 130px;
            display: flex; justify-content: center; align-items: flex-end;
            padding: 0 20px;
        }
        .card {
            width: var(--card-w); height: calc(var(--card-w) * var(--card-ratio));
            background: #fff; border-radius: 8px;
            border: 1px solid #ddd; box-shadow: -2px 0 5px rgba(0,0,0,0.15);
            margin-left: -45px; cursor: pointer; transition: transform 0.2s;
            display: flex; flex-direction: column; padding: 5px;
            font-weight: bold; position: relative;
            user-select: none;
        }
        .card:first-child { margin-left: 0; }
        .card.selected { transform: translateY(-20px); }
        .card.red { color: #e74c3c; }
        .card.black { color: #2d3436; }
        .card-val { font-size: 18px; }
        .card-suit { font-size: 24px; text-align: center; flex: 1; display: flex; align-items: center; justify-content: center; }
        
        /* æ“æ§æŒ‰é’® */
        .control-bar {
            position: absolute; bottom: 150px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; z-index: 50; pointer-events: auto;
        }
        .btn-game {
            border: none; padding: 10px 25px; border-radius: 20px; font-family: inherit;
            font-size: 16px; cursor: pointer; color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1); transition: 0.1s;
            display: none; /* é»˜è®¤éšè— */
        }
        .btn-green { background: linear-gradient(to bottom, #81ecec, #00cec9); }
        .btn-orange { background: linear-gradient(to bottom, #ffeaa7, #fdcb6e); color: #d35400; }
        .btn-pink { background: linear-gradient(to bottom, #ff9a9e, #ff7675); }
        .btn-game:active { transform: translateY(4px); box-shadow: none; }

        /* è”æœºå¤§å…å¼¹çª— */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #fff; padding: 30px; border-radius: 20px; width: 320px; text-align: center;
            border: 4px solid #ffb7c5; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-btn {
            width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 10px;
            font-family: inherit; font-size: 16px; cursor: pointer; color: white;
        }
        .ipt-room {
            width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 10px;
            margin-top: 10px; text-align: center; outline: none; font-family: inherit;
        }

        /* ç»“ç®—å¼¹çª— */
        #resultModal { display: none; }
        .result-title { font-size: 30px; margin-bottom: 10px; }
        .win { color: #fab1a0; }
        .lose { color: #a29bfe; }

    </style>
</head>
<body>

    <div class="top-bar">
        <a href="game_loppy.html" class="back-btn">ğŸ”™ è¿”å›</a>
        <div class="room-info" id="roomStatus">ç­‰å¾…è”æœº...</div>
    </div>

    <div class="game-area">
        <div class="di-pai-area" id="diPaiArea">
            <div class="di-pai-card"></div>
            <div class="di-pai-card"></div>
            <div class="di-pai-card"></div>
        </div>

        <div class="player p-left">
            <div class="role-icon" id="role1">ğŸ©</div>
            <div class="avatar">ğŸ˜º</div>
            <div class="p-info">
                <div id="name1">ç©å®¶2</div>
                <div class="remain-count" id="count1">17</div>
            </div>
            <div class="played-cards pc-left" id="played1"></div>
        </div>

        <div class="player p-right">
            <div class="role-icon" id="role2">ğŸ‘’</div>
            <div class="avatar">ğŸ¶</div>
            <div class="p-info">
                <div id="name2">ç©å®¶3</div>
                <div class="remain-count" id="count2">17</div>
            </div>
            <div class="played-cards pc-right" id="played2"></div>
        </div>

        <div class="player p-me">
            <div class="role-icon" id="roleMe">ğŸ‘‘</div>
            <div class="played-cards pc-me" id="playedMe"></div>
        </div>

        <div class="control-bar" id="ctrlBar">
            <button class="btn-game btn-orange" id="btnCall" onclick="sendAction('call')">æŠ¢åœ°ä¸»</button>
            <button class="btn-game btn-blue" id="btnPassCall" onclick="sendAction('pass_call')">ä¸æŠ¢</button>
            
            <button class="btn-game btn-pink" id="btnPlay" onclick="attemptPlayCard()">å‡ºç‰Œ</button>
            <button class="btn-game btn-blue" id="btnPass" onclick="sendAction('pass')">ä¸å‡º</button>
        </div>

        <div class="my-hand" id="myHand"></div>
    </div>

    <div class="modal" id="lobbyModal">
        <div class="modal-box">
            <h2 style="color:#ff9a9e;">ğŸƒ èŒèŒæ–—åœ°ä¸»</h2>
            <div id="hostSection">
                <button class="modal-btn" style="background:#a29bfe;" onclick="createRoom()">æˆ‘æ˜¯æˆ¿ä¸» (å»ºæˆ¿)</button>
                <div id="hostInfo" style="display:none; margin-top:10px; font-size:12px; color:#888;">
                    æˆ¿é—´å·: <span id="myRoomId" style="color:#ff9a9e; font-weight:bold; cursor:pointer;">ç”Ÿæˆä¸­...</span>
                    <br>ç­‰å¾…ç©å®¶: <span id="waitCount">0</span>/2
                    <button class="modal-btn" id="startBtn" style="background:#ff7675;" onclick="startGame()" disabled>äººé½äº†ï¼Œå‘ç‰Œï¼</button>
                </div>
            </div>
            <div style="margin:15px 0;border-top:1px dashed #eee;"></div>
            <div id="joinSection">
                <input type="text" class="ipt-room" id="joinInput" placeholder="è¾“å…¥æˆ¿ä¸»ID">
                <button class="modal-btn" style="background:#81ecec; color:#555;" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
            </div>
        </div>
    </div>

    <div class="modal" id="resultModal">
        <div class="modal-box">
            <h2 id="resultTitle" class="result-title">èƒœåˆ©ï¼</h2>
            <p id="resultText">åœ°ä¸»èµ¢äº†ï¼</p>
            <button class="modal-btn" style="background:#ff9a9e;" onclick="location.reload()">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <script>
        // ================= å…¨å±€å˜é‡ & é…ç½® =================
        let peer = null, connList = [], hostConn = null;
        let myId = null, myRoleIndex = -1; // 0=æˆ¿ä¸», 1=å·¦, 2=å³
        let myCards = [];
        let isMyTurn = false;
        let landlordIdx = -1; // è°æ˜¯åœ°ä¸»
        let currentDiPai = []; // åº•ç‰Œ
        let lastPlayed = { idx: -1, cards: [], type: '' }; // ä¸Šä¸€é¦–ç‰Œ

        // ç‰Œå‹æƒé‡: 3-K=3-13, A=14, 2=15, å°ç‹=16, å¤§ç‹=17
        const RANK_MAP = { '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14, '2':15, 'S':16, 'B':17 };
        const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];

        // ================= 1. è”æœºé€»è¾‘ (PeerJS) =================
        peer = new Peer(null, { debug: 2 });
        
        peer.on('open', (id) => {
            myId = id;
            document.getElementById('myRoomId').innerText = id;
        });

        // æˆ¿ä¸»ï¼šç›‘å¬è¿æ¥
        function createRoom() {
            document.getElementById('joinSection').style.display = 'none';
            document.getElementById('hostInfo').style.display = 'block';
            myRoleIndex = 0; // æˆ¿ä¸»æ°¸è¿œæ˜¯0å·ä½

            peer.on('connection', (conn) => {
                connList.push(conn);
                document.getElementById('waitCount').innerText = connList.length;
                
                conn.on('open', () => {
                    // å‘Šè¯‰ç©å®¶ä»–æ˜¯å‡ å·ä½ (1æˆ–2)
                    conn.send({ type: 'WELCOME', idx: connList.length });
                    if(connList.length === 2) document.getElementById('startBtn').disabled = false;
                });

                conn.on('data', (data) => handleData(data));
            });
        }

        // ç©å®¶ï¼šåŠ å…¥æˆ¿é—´
        function joinRoom() {
            const hostId = document.getElementById('joinInput').value.trim();
            if(!hostId) return alert('è¯·è¾“å…¥æˆ¿å·');
            hostConn = peer.connect(hostId);
            
            hostConn.on('open', () => {
                document.getElementById('lobbyModal').style.display = 'none';
                document.getElementById('roomStatus').innerText = "å·²è¿æ¥ï¼Œç­‰å¾…å‘ç‰Œ...";
            });

            hostConn.on('data', (data) => handleData(data));
        }

        // æ¶ˆæ¯åˆ†å‘ä¸­å¿ƒ
        function handleData(data) {
            console.log('æ”¶åˆ°:', data);
            switch(data.type) {
                case 'WELCOME': 
                    myRoleIndex = data.idx; 
                    updateUIByRole();
                    break;
                case 'GAME_START':
                    initGame(data);
                    break;
                case 'TURN_UPDATE':
                    handleTurnUpdate(data);
                    break;
                case 'PLAYER_ACTION':
                    handleRemoteAction(data); // åˆ«äººå‡ºç‰Œäº†
                    break;
                case 'GAME_OVER':
                    showResult(data);
                    break;
                case 'SET_LANDLORD':
                    setLandlord(data);
                    break;
            }
        }

        // ================= 2. æ¸¸æˆæ ¸å¿ƒé€»è¾‘ (æˆ¿ä¸»æ§åˆ¶) =================
        function startGame() {
            // 1. ç”Ÿæˆä¸€å‰¯ç‰Œ
            let deck = [];
            Object.keys(RANK_MAP).forEach(r => {
                if(r === 'S' || r === 'B') {
                    deck.push({ r: r, s: '', v: RANK_MAP[r] }); // å¤§å°ç‹
                } else {
                    SUITS.forEach(s => deck.push({ r: r, s: s, v: RANK_MAP[r] }));
                }
            });
            // 2. æ´—ç‰Œ
            deck.sort(() => Math.random() - 0.5);

            // 3. åˆ†ç‰Œ (æ¯äºº17å¼ ï¼Œåº•ç‰Œ3å¼ )
            const hands = [
                deck.slice(0, 17),
                deck.slice(17, 34),
                deck.slice(34, 51)
            ];
            const diPai = deck.slice(51);

            // 4. å¹¿æ’­å¼€å§‹
            const startData = { type: 'GAME_START', hands: hands, diPai: diPai, turn: 0 }; // 0å·æˆ¿ä¸»å…ˆå«åœ°ä¸»
            handleData(startData); // è‡ªå·±å¤„ç†
            connList.forEach((c, i) => c.send({ ...startData, hands: hands })); // å‘ç»™å…¶ä»–äºº (å…¨å‘è¿‡å»ç®€åŒ–é€»è¾‘ï¼Œå®é™…ä¸Šåº”è¯¥åªå‘å¯¹åº”çš„)
        }

        function initGame(data) {
            document.getElementById('lobbyModal').style.display = 'none';
            document.getElementById('roomStatus').innerText = "æ¸¸æˆå¼€å§‹ï¼";
            
            // å­˜åº•ç‰Œ
            currentDiPai = data.diPai;
            
            // æ‹¿æˆ‘çš„ç‰Œ
            myCards = data.hands[myRoleIndex];
            renderHand();
            
            // æ›´æ–°UIï¼šå‰©ä½™ç‰Œæ•°
            document.getElementById('count1').innerText = 17; document.getElementById('count1').style.display = 'inline-block';
            document.getElementById('count2').innerText = 17; document.getElementById('count2').style.display = 'inline-block';

            // å¦‚æœè½®åˆ°æˆ‘
            if (data.turn === myRoleIndex) startBidding();
        }

        // ================= 3. äº¤äº’é€»è¾‘ (å‡ºç‰Œ/æŠ¢åœ°ä¸») =================
        function startBidding() {
            showBtns(['btnCall', 'btnPassCall']);
            isMyTurn = true;
        }

        function startPlaying() {
            showBtns(['btnPlay', 'btnPass']);
            isMyTurn = true;
        }

        function sendAction(act) {
            if(!isMyTurn) return;
            hideBtns();
            isMyTurn = false;

            const msg = { type: 'PLAYER_ACTION', idx: myRoleIndex, action: act };
            
            // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œç›´æ¥å¹¿æ’­ï¼›å¦‚æœæ˜¯ç©å®¶ï¼Œå‘ç»™æˆ¿ä¸»è½¬å‘
            if(myRoleIndex === 0) broadcast(msg);
            else hostConn.send(msg);
        }

        // å°è¯•å‡ºç‰Œ (æ ¸å¿ƒè§„åˆ™åˆ¤å®š)
        function attemptPlayCard() {
            const selectedEls = document.querySelectorAll('.card.selected');
            if(selectedEls.length === 0) return alert('è¯·é€‰ç‰Œ');

            const selectedCards = Array.from(selectedEls).map(el => JSON.parse(el.dataset.card));
            // æ’åº (å¤§åˆ°å°)
            selectedCards.sort((a, b) => b.v - a.v);

            // --- è§„åˆ™åˆ¤å®š ---
            const typeInfo = getCardType(selectedCards);
            if(!typeInfo) return alert('ç‰Œå‹ä¸åˆæ³•ï¼');

            // ç®¡ç‰Œåˆ¤å®š
            if(lastPlayed.idx !== -1 && lastPlayed.idx !== myRoleIndex) {
                if(!canBeat(typeInfo, lastPlayed.typeInfo)) return alert('æ‰“ä¸è¿‡ä¸Šå®¶ï¼');
            }

            // å‡ºç‰ŒæˆåŠŸ
            // ä»æ‰‹ç‰Œç§»é™¤
            myCards = myCards.filter(c => !selectedCards.some(sc => sc.r === c.r && sc.s === c.s));
            renderHand();
            
            // å‘é€
            const msg = { 
                type: 'PLAYER_ACTION', 
                idx: myRoleIndex, 
                action: 'play', 
                cards: selectedCards,
                typeInfo: typeInfo 
            };
            
            if(myRoleIndex === 0) broadcast(msg);
            else hostConn.send(msg);

            hideBtns();
            isMyTurn = false;
        }

        // å¹¿æ’­ (æˆ¿ä¸»ç”¨)
        function broadcast(msg) {
            handleData(msg); // è‡ªå·±å¤„ç†
            connList.forEach(c => c.send(msg)); // å‘ç»™åˆ«äºº
        }

        // å¤„ç†åˆ«äºº/è‡ªå·±çš„åŠ¨ä½œ
        function handleRemoteAction(data) {
            // æ˜¾ç¤ºå‡ºç‰Œç‰¹æ•ˆ
            const viewIdx = getRelativeIdx(data.idx); // è½¬æ¢è§†è§’ (0=æˆ‘, 1=å·¦, 2=å³)
            const area = ['playedMe', 'played1', 'played2'][viewIdx];
            const areaEl = document.getElementById(area);
            
            areaEl.innerHTML = ''; // æ¸…ç©ºæ—§çš„

            if(data.action === 'pass' || data.action === 'pass_call') {
                areaEl.innerHTML = '<span style="font-size:20px; color:#aaa; font-weight:bold;">ä¸å‡º</span>';
            } else if (data.action === 'call') {
                areaEl.innerHTML = '<span style="font-size:20px; color:#ff9a9e; font-weight:bold;">æŠ¢åœ°ä¸»!</span>';
                if(myRoleIndex === 0) finalizeLandlord(data.idx); // æˆ¿ä¸»å†³å®šåœ°ä¸»
            } else if (data.action === 'play') {
                // æ¸²æŸ“æ‰“å‡ºçš„ç‰Œ
                data.cards.forEach(c => {
                    const card = createCardEl(c);
                    card.style.transform = 'scale(0.6)';
                    card.style.marginLeft = '-30px';
                    areaEl.appendChild(card);
                });
                // æ›´æ–°å…¨å±€è®°å½•
                lastPlayed = { idx: data.idx, typeInfo: data.typeInfo };
                
                // æ›´æ–°å‰©ä½™ç‰Œæ•°
                updateRemainCount(viewIdx, data.cards.length);

                // åˆ¤å®šèƒœè´Ÿ (æˆ¿ä¸»)
                if(myRoleIndex === 0 && (viewIdx === 0 ? myCards.length : getRemainCount(viewIdx) <= 0)) {
                    // ç®€åŒ–ï¼šå¦‚æœæˆ‘æ˜¯æˆ¿ä¸»ï¼Œæˆ‘çœ‹è‡ªå·±ç‰Œæ²¡äº†ï¼Œæˆ–è€…æˆ‘çŸ¥é“åˆ«äººç‰Œæ²¡äº†(éœ€ç»´æŠ¤è®¡æ•°å™¨)
                    // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œåªåœ¨å‰©ä½™ç‰Œæ•° UI æ›´æ–°æ—¶åˆ¤æ–­
                }
            }

            // è½®è½¬
            if(myRoleIndex === 0) nextTurn(data.idx, data.action === 'call');
        }

        // æˆ¿ä¸»æ§åˆ¶æµç¨‹
        function nextTurn(currentIdx, isBidding) {
            let next = (currentIdx + 1) % 3;
            // å¦‚æœæ˜¯å«åˆ†é˜¶æ®µç»“æŸ (è¿™é‡Œç®€åŒ–ä¸ºè°æŠ¢è°å°±æ˜¯åœ°ä¸»)
            if (isBidding) return; 

            // å¹¿æ’­ä¸‹ä¸€ä¸ªæ˜¯è°
            const msg = { type: 'TURN_UPDATE', activeIdx: next };
            broadcast(msg);
        }

        function finalizeLandlord(idx) {
            landlordIdx = idx;
            // å¹¿æ’­åœ°ä¸»
            broadcast({ type: 'SET_LANDLORD', idx: idx, diPai: currentDiPai });
            // åœ°ä¸»è·å¾—åº•ç‰Œ
            if(myRoleIndex === idx) {
                myCards = myCards.concat(currentDiPai);
                myCards.sort((a,b) => b.v - a.v);
                renderHand();
            }
            // æˆ¿ä¸»å¼€å¯å‡ºç‰Œå¾ªç¯
            broadcast({ type: 'TURN_UPDATE', activeIdx: idx });
        }

        function setLandlord(data) {
            // æ˜¾ç¤ºåº•ç‰Œ
            const area = document.getElementById('diPaiArea');
            area.innerHTML = ''; area.style.opacity = 1;
            data.diPai.forEach(c => {
                const el = createCardEl(c); el.style.width='30px'; el.style.height='42px';
                area.appendChild(el);
            });

            // ç»™åœ°ä¸»æˆ´å¸½å­
            const viewIdx = getRelativeIdx(data.idx);
            ['roleMe', 'role1', 'role2'][viewIdx].style.display = 'block'; // æ˜¾ç¤ºçš‡å† 
            if(viewIdx !== 0) updateRemainCount(viewIdx, 0, 20); // æ›´æ–°åœ°ä¸»ç‰Œæ•°æ˜¾ç¤ºä¸º20
        }

        function handleTurnUpdate(data) {
            // æ¸…ç©ºä¸Šå®¶çš„â€œä¸å‡ºâ€æ–‡å­—
            const viewIdx = getRelativeIdx(data.activeIdx);
            document.getElementById(['playedMe', 'played1', 'played2'][viewIdx]).innerHTML = '';

            if (data.activeIdx === myRoleIndex) {
                // å¦‚æœå¤§å®¶éƒ½ä¸è¦ï¼Œæˆ‘è¿™é‡Œæ¸…ç©º lastPlayed
                if (lastPlayed.idx === myRoleIndex) lastPlayed = { idx: -1 };
                startPlaying();
            }
        }

        // ================= 4. ç‰Œå‹è§„åˆ™å¼•æ“ (Liteç‰ˆ) =================
        function getCardType(cards) {
            const len = cards.length;
            if (len === 0) return null;
            const vals = cards.map(c => c.v);
            const isSame = vals.every(v => v === vals[0]);

            // å•å¼ 
            if (len === 1) return { type: '1', val: vals[0] };
            // å¯¹å­ (ä¸å«ç‹)
            if (len === 2 && isSame && vals[0] < 16) return { type: '2', val: vals[0] };
            // ç‹ç‚¸
            if (len === 2 && vals[0] === 17 && vals[1] === 16) return { type: 'rocket', val: 99 };
            // ä¸‰å¼ 
            if (len === 3 && isSame) return { type: '3', val: vals[0] };
            // ç‚¸å¼¹
            if (len === 4 && isSame) return { type: 'bomb', val: vals[0] };
            // ä¸‰å¸¦ä¸€
            if (len === 4) {
                if(vals[0]===vals[2]) return { type: '3+1', val: vals[0] }; // 333+4
                if(vals[1]===vals[3]) return { type: '3+1', val: vals[1] }; // 4+333
            }
            
            // TODO: é¡ºå­ã€è¿å¯¹æš‚ç•¥ï¼Œä¿è¯åŸºç¡€èƒ½ç©
            return null; // ä¸æ”¯æŒçš„ç‰Œå‹
        }

        function canBeat(myType, enemyType) {
            if (!enemyType) return true; // æ²¡äººå‡ºç‰Œï¼Œéšä¾¿å‡º
            if (myType.type === 'rocket') return true;
            if (enemyType.type === 'rocket') return false;
            if (myType.type === 'bomb' && enemyType.type !== 'bomb') return true;
            
            if (myType.type === enemyType.type && myType.val > enemyType.val) return true;
            return false;
        }

        // ================= 5. UI è¾…åŠ©å‡½æ•° =================
        function createCardEl(cardData) {
            const div = document.createElement('div');
            const color = (cardData.s === 'â™¥' || cardData.s === 'â™¦' || cardData.r === 'B') ? 'red' : 'black';
            div.className = `card ${color}`;
            let txt = cardData.r; 
            if(txt==='S') txt='å°ç‹'; if(txt==='B') txt='å¤§ç‹';
            
            div.innerHTML = `<div class="card-val">${txt}</div><div class="card-suit">${cardData.s}</div>`;
            div.dataset.card = JSON.stringify(cardData);
            return div;
        }

        function renderHand() {
            const c = document.getElementById('myHand');
            c.innerHTML = '';
            myCards.forEach(card => {
                const el = createCardEl(card);
                el.onclick = () => el.classList.toggle('selected');
                c.appendChild(el);
            });
        }

        function showBtns(ids) { ids.forEach(id => document.getElementById(id).style.display = 'block'); }
        function hideBtns() { document.querySelectorAll('.btn-game').forEach(b => b.style.display = 'none'); }

        // è·å–ç›¸å¯¹ä½ç½®ï¼šæˆ‘=0, ä¸Šå®¶=1, ä¸‹å®¶=2
        function getRelativeIdx(targetIdx) {
            if (targetIdx === myRoleIndex) return 0;
            if (targetIdx === (myRoleIndex + 2) % 3) return 1; // ä¸Šå®¶(å·¦)
            return 2; // ä¸‹å®¶(å³)
        }

        // æ›´æ–°å‰©ä½™ç‰Œæ•° (ç®€æ˜“å®ç°)
        function updateRemainCount(viewIdx, change, setVal) {
            if(viewIdx === 0) return; // è‡ªå·±ä¸ç”¨æ˜¾ç¤ºæ•°å­—
            const el = document.getElementById('count' + viewIdx);
            let val = setVal !== undefined ? setVal : (parseInt(el.innerText) - change);
            el.innerText = val;
            
            if(val === 0) {
                // ç®€å•çš„èƒœè´Ÿåˆ¤å®š
                const winnerIdx = (myRoleIndex + viewIdx + (viewIdx===1?1:-1)) % 3; // çç®—çš„ï¼Œå®é™…åº”è¯¥å­˜id
                broadcast({ type: 'GAME_OVER', winnerIdx: winnerIdx }); 
            }
        }
        
        // åªæ˜¯ä¸ºäº†ä¸æŠ¥é”™ï¼Œå®é™…éœ€å®Œå–„
        function getRemainCount(viewIdx) { return 99; } 

        function showResult(data) {
            document.getElementById('resultModal').style.display = 'flex';
            const isLandlordWin = data.winnerIdx === landlordIdx;
            const amILandlord = myRoleIndex === landlordIdx;
            const iWin = (isLandlordWin && amILandlord) || (!isLandlordWin && !amILandlord);
            
            const title = document.getElementById('resultTitle');
            if (iWin) { title.innerText = "ğŸ‰ èƒœåˆ©ï¼"; title.className = "result-title win"; }
            else { title.innerText = "ğŸ˜­ å¤±è´¥..."; title.className = "result-title lose"; }
        }

        // åˆå§‹åŒ–UI
        function updateUIByRole() {
            // è¿™é‡Œå¯ä»¥æ ¹æ® myRoleIndex è®¾ç½®åå­—
        }

    </script>
</body>
</html>

