<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>âœ¨ æ¢¨æ¢¨çš„ç™¾å®ç®± (æœ€ç»ˆå®Œç¾ç‰ˆ v15.0) âœ¨</title>
    <style>
        /* --- å¼•å…¥å®šåˆ¶å­—ä½“ --- */
        @font-face {
            font-family: 'MyCustomFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --primary-color: #ffb7c5;
            --secondary-color: #ffe6eb;
            --accent-color: #ff8fa3;
            --text-color: #6d5c5c;
            --radius: 20px;
            --shadow: 0 8px 24px rgba(255, 183, 197, 0.4);
            --lock-bg: #fff0f5;

            /* ğŸ‘‡ ğŸŸ¢ é˜…è¯»å™¨è®¾ç½® ğŸŸ¢ ğŸ‘‡ */
            --reader-bubble-width: 90%; /* æ°”æ³¡å®½åº¦ */
            --reader-line-height: 1.5; /* è¡Œé—´è· */
            --reader-letter-spacing: 0.8px; /* å­—é—´è· */
            --reader-row-spacing: 2px; /* æ®µé—´è· */
        }

        body {
            font-family: 'MyCustomFont', 'Microsoft YaHei', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            height: 100vh;
        }

        /* ==================== ğŸŒ¸ æ¨±èŠ±ç‰¹æ•ˆ & é”å±æ ·å¼ ==================== */
        
        #lockScreen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff5f7; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-image: radial-gradient(#fff 2px, transparent 2px);
            background-size: 30px 30px;
        }

        /* é£˜è½æ¨±èŠ± */
        .sakura {
            position: absolute;
            background: #ffc0cb; border-radius: 100% 0 100% 0; opacity: 0.5;
            animation: fall linear infinite; pointer-events: none;
        }
        @keyframes fall {
            0% { transform: translate(0, -10vh) rotate(0deg); opacity: 1; }
            100% { transform: translate(100px, 110vh) rotate(360deg); opacity: 0; }
        }

        /* é€šç”¨å¡ç‰‡æ ·å¼ */
        .lock-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 40px 30px;
            width: 85%; max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(255, 183, 197, 0.3);
            border: 2px solid #fff;
            position: relative;
            z-index: 10;
            transition: transform 0.3s;
        }

        .lock-title { font-size: 24px; color: var(--accent-color); margin-bottom: 10px; font-weight: bold; }
        .lock-subtitle { color: #999; font-size: 14px; margin-bottom: 30px; line-height: 1.6; }

        .welcome-btn {
            display: block;
            width: 100%; padding: 18px; border-radius: 50px;
            margin-bottom: 15px; border: none; font-size: 16px; color: white;
            font-family: inherit; cursor: pointer; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.2s;
        }
        .welcome-btn:active { transform: scale(0.98); }
        .btn-gesture { background: #ffb7c5; }
        .btn-pin { background: linear-gradient(90deg, #a8edea 0%, #ffb7c5 100%); }
        .btn-login-pink { background: #ff9eb5; box-shadow: 0 8px 20px rgba(255, 158, 181, 0.4); }

        .pin-display { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; }
        .pin-dot {
            width: 16px;
            height: 16px; border-radius: 50%;
            background: #eee; border: 2px solid #ddd; transition: all 0.2s;
        }
        .pin-dot.active { background: var(--accent-color); border-color: var(--accent-color); transform: scale(1.2); }
        
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 280px; margin: 0 auto; }
        .num-btn {
            width: 60px;
            height: 60px; border-radius: 50%; border: none;
            background: #fff; color: var(--text-color); font-size: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer;
            font-family: inherit; display: flex; align-items: center; justify-content: center;
        }
        .num-btn:active { background: var(--secondary-color); }

        .gesture-container { position: relative; width: 300px; height: 300px; margin: 0 auto; touch-action: none; }
        .gesture-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; cursor: crosshair; }
        .gesture-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
            width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none;
        }
        .gesture-point { display: flex; align-items: center; justify-content: center; }
        .point-inner {
            width: 18px;
            height: 18px; background: #ddd; border-radius: 50%;
            transition: 0.3s;
        }
        .point-inner.active { background: var(--accent-color); box-shadow: 0 0 0 10px rgba(255, 143, 163, 0.2); }

        .lock-input {
            width: 100%;
            padding: 12px; margin: 10px 0; border: 2px solid #ffe6eb;
            border-radius: 12px; text-align: center; font-family: inherit;
            outline: none; color: var(--text-color);
        }
        .lock-input:focus { border-color: var(--accent-color); }

        .back-link { margin-top: 20px; font-size: 13px; color: #bbb; cursor: pointer; text-decoration: underline; }

        .toast {
            position: fixed;
            top: 50px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px;
            border-radius: 30px; font-size: 14px; opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s; z-index: 20000;
        }

        /* ==================== ğŸ”® æŠ½ç­¾ç³»ç»Ÿæ ·å¼ ==================== */
        .lottery-panel { margin-bottom: 15px; text-align: center; }
        .lottery-btn {
            background: linear-gradient(135deg, #fff0f5 0%, #ffc0cb 100%);
            border: 2px solid #fff; color: #d66a80;
            padding: 8px 15px; border-radius: 20px; font-size: 13px; font-family: inherit;
            cursor: pointer; width: 100%;
            box-shadow: 0 4px 10px rgba(255, 183, 197, 0.3);
            font-weight: bold; transition: transform 0.2s;
        }
        .lottery-btn:active { transform: scale(0.95); }

        .lottery-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 230, 235, 0.9); backdrop-filter: blur(8px);
            z-index: 12000; display: none;
            flex-direction: column;
            justify-content: center; align-items: center;
        }
        .lottery-overlay.active { display: flex; animation: fadeInLottery 0.3s ease; }
        @keyframes fadeInLottery { from {opacity:0;} to {opacity:1;} }

        .lottery-box-container { text-align: center; position: relative; }
        .magic-gift { font-size: 100px; display: block; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1)); }
        .magic-gift.shaking { animation: shakeBox 0.5s infinite; }
        @keyframes shakeBox {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(10deg) scale(1.1); }
            50% { transform: rotate(0deg) scale(1); }
            75% { transform: rotate(-10deg) scale(1.1); }
            100% { transform: rotate(0deg) scale(1); }
        }

        .lottery-result-card {
            display: none;
            flex-direction: column; align-items: center;
            background: white; padding: 20px; border-radius: 30px;
            box-shadow: 0 20px 50px rgba(255, 100, 150, 0.3);
            border: 4px solid #fff;
            width: 260px; animation: popIn 0.6s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        @keyframes popIn { from {transform: scale(0) rotate(-20deg); opacity: 0;} to {transform: scale(1) rotate(0); opacity: 1;} }

        .lottery-img-wrapper {
            width: 220px;
            height: 220px; border-radius: 20px; overflow: hidden;
            margin-bottom: 15px; border: 2px solid #ffe6eb; background: #fff5f7;
            display: flex; align-items: center; justify-content: center;
        }
        .lottery-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        
        .lottery-name { font-size: 20px; color: var(--accent-color); font-weight: bold; margin-bottom: 5px; }
        .lottery-hint { font-size: 12px; color: #aaa; margin-bottom: 15px; }
        
        .go-btn {
            background: var(--accent-color);
            color: white; border: none;
            padding: 10px 30px; border-radius: 25px; font-size: 16px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 143, 163, 0.4);
            animation: pulse 2s infinite; font-family: inherit;
        }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
        .close-lottery { position: absolute;
            top: 30px; right: 30px; font-size: 30px; color: #fff; background: rgba(0,0,0,0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; cursor: pointer; }

        /* ==================== åŸæœ‰ CSS ==================== */
        #appContainer {
            display: none;
            padding: 20px;
            padding-bottom: 100px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 { text-align: center; color: var(--accent-color); font-weight: normal; margin: 10px 0 30px 0; text-shadow: 2px 2px 0px #fff; font-size: 32px; }

        /* --- ğŸ¶ æ‚¬æµ®çª— --- */
        .float-widget { position: fixed; bottom: 30px; right: 30px; z-index: 9999; touch-action: none; }
        .float-btn {
            width: 48px;
            height: 48px; border-radius: 50%;
            background: #fff; border: 3px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(255, 117, 143, 0.3);
            display: flex;
            justify-content: center; align-items: center;
            font-size: 24px; cursor: move; user-select: none;
            transition: transform 0.1s; position: relative;
        }
        .float-btn:active { transform: scale(0.9); }
        .float-btn::after { content: 'ğŸ¶'; }
        
        .float-menu {
            position: absolute;
            bottom: 60px; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 20px; width: 260px; padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 2px solid #fff;
            transform-origin: bottom right; transform: scale(0); opacity: 0;
            transition: all 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            pointer-events: none; max-height: 60vh; display: flex; flex-direction: column;
        }
        .float-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }

        .music-panel { background: var(--secondary-color); border-radius: 15px; padding: 12px; margin-bottom: 10px; text-align: center; }
        .music-controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 8px; }
        .play-btn { background: var(--accent-color); color: white; border: none; border-radius: 50%; width: 32px;
            height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .nav-panel { flex-grow: 1; overflow-y: auto; border-top: 1px dashed #ddd; padding-top: 10px; }
        .nav-title { font-weight: bold; color: var(--accent-color); margin-bottom: 8px; font-size: 13px; }
        
        .search-container { max-width: 600px; margin: 0 auto 10px auto; position: relative; }
        .search-input { width: 100%; padding: 15px 50px 15px 25px; border: 2px solid #fff; border-radius: 50px; background: rgba(255, 255, 255, 0.9); font-size: 16px; outline: none; font-family: inherit; }
        .search-input:focus { border-color: var(--primary-color); }
        .search-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--primary-color); }

        /* ğŸŸ¢ è§†å›¾åˆ‡æ¢æ  */
        .layout-bar {
            display: flex; align-items: center; justify-content: center;
            gap: 4px; margin: 0 auto 25px auto;
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(5px);
            padding: 6px 12px 6px 15px; border-radius: 50px; width: fit-content;
            border: 2px solid #fff0f5; box-shadow: 0 5px 15px rgba(255, 183, 197, 0.25);
        }
        .layout-label { font-size: 13px; color: var(--accent-color); font-weight: bold; margin-right: 8px; display: flex; align-items: center; }
        .layout-btn {
            background: none; border: none; width: 36px; height: 36px;
            cursor: pointer; border-radius: 50%; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            display: flex; align-items: center; justify-content: center; opacity: 0.6; font-size: 18px;
        }
        .layout-btn.active { background: #fff; box-shadow: 0 4px 10px rgba(255, 183, 197, 0.3); opacity: 1; transform: scale(1.1); }

               /* ğŸŸ¢ æ“ä½œæŒ‰é’®ç½‘æ ¼ (ä¿®æ”¹ç‰ˆï¼š6ä¸ªä¸€è¡Œ) */
    /* å¼ºåˆ¶è®¾ç½®ä¸º 5 åˆ—ï¼Œè®© 5 ä¸ªæŒ‰é’®æ­£å¥½æ’æ»¡ä¸€è¡Œ */
    .action-grid { 
        display: grid; 
        grid-template-columns: repeat(5, 1fr) !important; 
        gap: 6px; /* é—´è·ç¨å¾®è°ƒå°ä¸€ç‚¹ï¼Œé˜²æ­¢æ¢è¡Œ */
        max-width: 100%; 
        margin: 0 auto 20px auto; 
        padding: 0 5px; 
        box-sizing: border-box;
    }

    .action-card {
        height: 65px; /* é«˜åº¦ç»Ÿä¸€ */
        font-size: 11px; /* å­—ä½“å°å·§ */
        padding: 5px 0;
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center;
        background: #fff; 
        border: 2px solid #ffb7c5; 
        border-radius: 12px;
        color: #ff8fa3; 
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(255, 183, 197, 0.2); 
    }
    
    .action-card:active { transform: scale(0.95); }
    .action-card.primary { border: 2px solid #ff8fa3; color: #ff8fa3; }
    
    /* å›¾æ ‡å¤§å°å¾®è°ƒ */
    .kitty-icon { 
        font-size: 20px; 
        margin-bottom: 3px; 
    }
        /* æ‰¹é‡åˆ é™¤ç›¸å…³æ ·å¼ */
        .card.is-selecting { animation: shake 0.3s ease; }
        .card.selected { border-color: #ff6b6b !important; background-color: #fff0f0; position: relative; }
        .card.selected::after { content: 'âœ…'; position: absolute; top: 5px; right: 5px; font-size: 20px; background: rgba(255,255,255,0.8); border-radius: 50%; }

        /* ğŸ”´ å…³é”®ä¿®å¤ï¼šéšè—åˆ é™¤æ¡ */
        .delete-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(200px);
            opacity: 0; pointer-events: none;
            background: #fff; padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; gap: 15px;
            z-index: 10000; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); border: 2px solid #ff6b6b;
        }
        .delete-bar.active { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto; }
        .delete-btn-confirm { background: #ff6b6b; color: white; border: none; padding: 8px 20px; border-radius: 30px; font-weight: bold; }
        .delete-btn-cancel { background: #f0f0f0; color: #666; border: none; padding: 8px 20px; border-radius: 30px; }
        .controls { display: none; }

        /* ğŸŸ¢ Grid å¸ƒå±€æ¨¡å¼ */
        .grid-container { display: grid; gap: 20px; max-width: 1200px; margin: 0 auto; transition: all 0.3s ease; }
        .grid-container.mode-default { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
        .grid-container.mode-large { grid-template-columns: repeat(auto-fill, minmax(40%, 1fr)); }
        .grid-container.mode-mini { grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); }
        .grid-container.mode-mini .card-img-wrapper { height: 120px; }
        .grid-container.mode-mini .card-title { font-size: 14px; }
        .grid-container.mode-list { grid-template-columns: 1fr; }
        .grid-container.mode-list .card { flex-direction: row; height: 100px; }
        .grid-container.mode-list .card-img-wrapper { width: 100px; height: 100%; flex-shrink: 0; }
        .grid-container.mode-list .card-content { justify-content: center; }
        .grid-container.mode-list .tags-container { margin-top: 5px; }

        .card { background: #fff; border-radius: var(--radius); overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.3s; border: 3px solid #fff; display: flex; flex-direction: column; cursor: pointer; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: var(--primary-color); }
        .card-img-wrapper { height: 200px; background-color: #fcecef; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        
        .content-indicators { position: absolute; top: 8px; left: 8px; display: flex; gap: 4px; flex-wrap: wrap; }
        .indicator { background: rgba(255,255,255,0.95); padding: 2px 6px; border-radius: 6px; font-size: 12px; color: var(--text-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .card-content { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 18px; margin: 0 0 5px 0; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: auto; }
        .tag-pill { background: var(--secondary-color); color: var(--accent-color); font-size: 12px; padding: 2px 6px; border-radius: 8px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%;
            height: 100%; background: rgba(255, 240, 245, 0.85); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; padding: 25px; border-radius: 25px; width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 15px 40px rgba(255, 130, 150, 0.2); position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 28px; cursor: pointer; color: #ccc; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 16px; color: var(--accent-color); }
        input[type="text"], select { width: 100%; padding: 10px; border: 2px solid var(--secondary-color);
            border-radius: 12px; outline: none; box-sizing: border-box; background: #fff; font-family: inherit; font-size: 15px; }
        
        .tag-input-area { border: 2px solid var(--secondary-color); border-radius: 12px; padding: 8px; display: flex; flex-wrap: wrap; gap: 5px; min-height: 40px; }
        .tag-input-area input { border: none; outline: none; flex-grow: 1; padding: 5px; font-family: inherit; }
        .tag-chip { background: var(--primary-color); color: white; padding: 3px 8px; border-radius: 10px; font-size: 14px; display: flex; gap: 5px; align-items: center; }

        .resource-list { border: 1px solid #eee; border-radius: 12px; padding: 10px; max-height: 250px; overflow-y: auto; background: #fafafa; }
        .resource-item { display: flex; align-items: flex-start; gap: 10px; background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #f0f0f0; flex-wrap: wrap;}
        .resource-preview { width: 40px; height: 40px; border-radius: 5px; object-fit: cover; background: #eee; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 20px;}
        .resource-info { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        
        .resource-name-input { width: 100%; border: none; border-bottom: 1px dashed #ccc; padding: 2px 0; font-size: 14px; color: #333; border-radius: 0; background: transparent; outline: none; }
        .resource-name-input:focus { border-bottom-color: var(--accent-color); }
        
        .resource-controls { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
        .resource-type-select { font-size: 12px; padding: 2px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; width: auto; flex-grow: 1; max-width: 120px; }
        .custom-type-input { font-size: 12px; padding: 2px 5px; border: 1px solid #ffb7c5; border-radius: 4px; width: 80px; display: none; }

        .btn-remove { background: #ffdede; color: #ff6b6b; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-left: auto; align-self: center;}

        .add-btn-row { display: flex; gap: 10px; margin-top: 5px; }
        .small-btn { font-size: 14px; padding: 5px 12px; }

        .gallery-container { position: relative; width: 100%; height: 320px; background: #fafafa; border-radius: 15px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; border: 1px solid #eee; flex-direction: column;}
        .gallery-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .gallery-type-label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; z-index: 10; }
        
        .gallery-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.8); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); user-select: none; z-index: 10; }
        .nav-prev { left: 10px; } .nav-next { right: 10px; }
        .cover-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid var(--accent-color); color: var(--accent-color); font-size: 12px; padding: 4px 10px; cursor: pointer; border-radius: 20px; z-index: 10; font-family: inherit; }
        .cover-btn.is-cover { background: var(--accent-color); color: white; }
        .download-img-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); border: 2px solid var(--primary-color); color: var(--primary-color); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; transition: all 0.2s;}
        
        .detail-list { margin-top: 10px; }
        .detail-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
        .detail-item-type { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; color: #888; margin-right: 5px; font-size: 12px; }
        
        .action-link { color: var(--accent-color); text-decoration: none; cursor: pointer; font-weight: bold; font-size: 12px; background: #fff0f3; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; }
        .action-link:hover { background: var(--primary-color); color: white; }

        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .empty-state { grid-column: 1 / -1; text-align: center; color: #cea0a9; padding: 50px; font-size: 18px; }
        .edit-btn { background: #fff8e1; border-color: #ffc107; color: #ffb300; }
        
        input[type="file"] { display: none; }
        
        button { background: #fff; border: 2px solid var(--primary-color); color: var(--accent-color); padding: 8px 18px; border-radius: 50px; cursor: pointer; font-family: inherit; font-size: 14px; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        button:hover { background: var(--primary-color); color: white; transform: translateY(-2px); }
        button.primary-btn { background: var(--accent-color); color: white; border: none; }

        /* ==================== ğŸ“– æ—¶å…‰æ”¾æ˜ å®¤ (é˜…è¯»æ¨¡å¼) ==================== */
        
        .reader-modal {
            background: #f5f5f5;
            width: 100%; height: 100%; top: 0; left: 0;
            max-width: none; max-height: none; border-radius: 0;
            display: flex; flex-direction: column; padding: 0;
        }

        .reader-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px; border-bottom: 1px solid #eee;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10;
            flex-shrink: 0;
        }

        .reader-title { font-weight: bold; color: var(--text-color); font-size: 16px; }
        .reader-subtitle { font-size: 10px; color: #999; margin-top: 2px; }

        .chat-container {
            flex-grow: 1;
            overflow-y: auto; padding: 20px; padding-bottom: 80px;
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            scroll-behavior: smooth;
        }

        .chat-row {
            display: flex;
            margin-bottom: var(--reader-row-spacing); 
            align-items: flex-end;
            position: relative;
            animation: fadeInUp 0.3s ease;
        }

        .floor-tag {
            position: absolute;
            top: -18px; font-size: 10px; color: #ccc;
            font-family: monospace; background: rgba(255,255,255,0.5);
            padding: 0 4px; border-radius: 4px;
        }

        .chat-bubble {
            max-width: var(--reader-bubble-width);
            line-height: var(--reader-line-height);
            letter-spacing: var(--reader-letter-spacing);
            
            padding: 12px 16px; border-radius: 18px;
            font-size: 15px; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); word-wrap: break-word;
        }

        .chat-name {
            font-size: 11px;
            color: #999; margin-bottom: 4px; margin-left: 4px;
            text-align: left;
        }

        .chat-row.left { justify-content: flex-start; }
        .chat-row.left .floor-tag { left: 10px; }
        .chat-row.left .chat-bubble { background: #fff; color: #333; border-bottom-left-radius: 4px; }

        .chat-row.right { justify-content: flex-end; }
        .chat-row.right .chat-name { margin-right: 4px; } 
        .chat-row.right .floor-tag { right: 10px; }
        .chat-row.right .chat-bubble { background: var(--accent-color); color: #fff; border-bottom-right-radius: 4px; }

        .close-reader {
            background: #eee;
            border: none; width: 32px; height: 32px; border-radius: 50%;
            font-size: 20px; color: #666; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        .reader-footer {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-top: 1px solid #eee;
            display: flex; justify-content: center; align-items: center; gap: 20px;
            flex-shrink: 0;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
            z-index: 10;
        }
        
        .page-btn {
            padding: 8px 15px;
            border-radius: 20px; border: 1px solid #ddd;
            background: #fff; color: #666; font-size: 13px; cursor: pointer;
            transition: all 0.2s; font-family: inherit;
        }
        .page-btn:active { transform: scale(0.95); background: #f0f0f0; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 13px; color: var(--accent-color); font-weight: bold; }

             /* ... ä¸Šé¢çš„ CSS ä¿æŒä¸å˜ ... */

        /* ==================== ğŸŸ¢ æ–°å¢ï¼šé˜…è¯»å™¨ç¼–è¾‘ä¸ä¹¦ç­¾æ ·å¼ ==================== */

        /* 1. ç¼–è¾‘æ¨¡å¼æ ·å¼ (ä¿®æ”¹ç‰ˆï¼šæ›´å¤§ã€æ›´æ¸…æ™°) */
        .bubble-edit-wrapper {
            width: 100%;
        }
        .bubble-textarea {
            width: 100%;
            min-height: 200px; /* ğŸŸ¢ æ”¹åŠ¨ï¼šé»˜è®¤é«˜åº¦åŠ å¤§åˆ° 200px */
            padding: 12px;     /* ğŸŸ¢ æ”¹åŠ¨ï¼šå†…è¾¹è·åŠ å¤§ */
            border: 2px solid var(--accent-color);
            border-radius: 15px;
            font-family: inherit;
            font-size: 16px;   /* ğŸŸ¢ æ”¹åŠ¨ï¼šç¼–è¾‘æ—¶å­—ä½“æ”¾å¤§ï¼Œçœ‹å­—æ›´æ¸…æ¥š */
            line-height: 1.6;
            resize: vertical;  /* å…è®¸ä¸Šä¸‹æ‹‰ä¼¸ */
            outline: none;
            background: #fff;
            color: #333;
            margin-bottom: 8px;
            box-sizing: border-box;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* åŠ ä¸€ç‚¹é˜´å½±è®©å®ƒæµ®èµ·æ¥çš„æ„Ÿè§‰ */
        }
        .edit-btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 12px; /* æŒ‰é’®é—´è·æ‹‰å¤§ */
        }
        .edit-confirm-btn {
            background: var(--accent-color);
            color: white; border: none; padding: 6px 18px; /* æŒ‰é’®å˜å¤§ */
            border-radius: 20px; font-size: 14px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .edit-cancel-btn {
            background: #eee;
            color: #666; border: none; padding: 6px 18px; /* æŒ‰é’®å˜å¤§ */
            border-radius: 20px; font-size: 14px; cursor: pointer;
        }

        /* ... ä¸‹é¢çš„ CSS (ä¹¦ç­¾æ ·å¼ç­‰) ä¿æŒä¸å˜ ... */

        /* 2. ä¹¦ç­¾æŒ‰é’® */
        .bookmark-icon { margin-left: 5px; cursor: pointer; font-size: 14px; color: #ddd; transition: color 0.2s; }
        .bookmark-icon.active { color: #ffd700; text-shadow: 0 0 2px rgba(255, 215, 0, 0.5); }
        .floor-tag { display: flex; align-items: center; pointer-events: auto; }

        /* 3. ä¹¦ç­¾åˆ—è¡¨ - å±…ä¸­å¼¹çª—æ ·å¼ (ä¿®å¤ç‰ˆ) */
        .bookmark-drawer {
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0.9); 
            width: 80%; max-width: 320px; height: 60%; max-height: 500px;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            border-radius: 25px; box-shadow: 0 10px 40px rgba(255, 183, 197, 0.5); z-index: 6000;
            display: flex; flex-direction: column; border: 2px solid #fff;
            opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .bookmark-drawer.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }

        /* ğŸŸ¢ æ–°å¢ï¼šCSS ç¼–è¾‘æŠ½å±‰æ ·å¼ (å¤ç”¨ä¹¦ç­¾æŠ½å±‰çš„é€»è¾‘) */
        .css-drawer {
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0.9); 
            width: 85%; max-width: 400px; height: 70%; max-height: 600px;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            border-radius: 25px; box-shadow: 0 10px 40px rgba(100, 100, 255, 0.2); 
            z-index: 6001; /* æ¯”ä¹¦ç­¾å±‚çº§å†é«˜ä¸€ç‚¹ */
            display: flex; flex-direction: column; border: 2px solid #e0f7fa;
            opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .css-drawer.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }

        .bookmark-header {
            padding: 15px 20px; font-weight: bold; color: var(--accent-color);
            border-bottom: 1px solid #ffe6eb; display: flex; justify-content: space-between; align-items: center;
            background: #fff0f5; border-radius: 25px 25px 0 0;
        }
        .bookmark-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .bookmark-item {
            background: #fff; border: 1px solid #ffe6eb; border-radius: 10px; padding: 10px; margin-bottom: 8px;
            cursor: pointer; transition: all 0.2s;
        }
        .bookmark-item:hover { background: #fff0f5; transform: translateX(-2px); }
        .bm-floor { font-size: 12px; color: #999; margin-bottom: 4px; font-weight: bold; }
        .bm-note { font-size: 14px; color: #555; word-break: break-all; }
        .bm-empty { text-align: center; color: #ccc; font-size: 13px; margin-top: 50px; }
        
        .highlight-row { animation: flashRow 2s ease; }
        @keyframes flashRow { 0% { background: rgba(255, 215, 0, 0.3); } 100% { background: transparent; } }

        /* ==================== ğŸ’­ å°è±¡æ·±åˆ»çš„è¯ (èƒŒæ™¯å¼¹å¹•ç‰¹æ•ˆ) ==================== */
        .memory-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden;
            pointer-events: none; /* è®©é¼ æ ‡å¯ä»¥ç©¿é€ï¼Œä¸å½±å“ç‚¹å‡» */
            z-index: 0; /* æ”¾åœ¨æœ€åº•å±‚ */
        }

        .memory-text {
            position: absolute;
            font-family: 'MyCustomFont', sans-serif; /* ç”¨ä½ æŒ‡å®šçš„å¯çˆ±å­—ä½“ */
            white-space: nowrap;
            color: rgba(255, 183, 197, 0.6); /* æ·¡æ·¡çš„ç²‰è‰²ï¼ŒåŠé€æ˜ */
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            opacity: 0;
            animation: floatUp linear forwards;
        }

        /* æ–‡å­—å‘ä¸Šé£˜åŠ¨çš„åŠ¨ç”» */
        @keyframes floatUp {
            0% {
                transform: translateY(100vh) scale(0.9) rotate(-5deg);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% {
                transform: translateY(-20vh) scale(1.1) rotate(5deg);
                opacity: 0;
            }
        }

        /* ä¸ºäº†é˜²æ­¢èƒŒæ™¯æ–‡å­—é®æŒ¡å†…å®¹ï¼Œæˆ‘ä»¬è¦ç»™å†…å®¹åŠ ä¸ªå±‚çº§ */
        .modal-content-wrapper {
            position: relative;
            z-index: 2; /* ç¡®ä¿å†…å®¹åœ¨æ–‡å­—ä¸Šé¢ */
        }

        /* ==================== ğŸ’® å¿ƒæƒ…å°ç« ç³»ç»Ÿ ==================== */
        
        /* å°ç« é€‰æ‹©æ  */
        .stamp-bar {
            display: flex; justify-content: center; gap: 15px; margin: 10px 0 20px 0;
            padding: 10px; background: rgba(255, 255, 255, 0.6); border-radius: 50px;
        }
        
        .stamp-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid transparent;
            background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 22px; transition: all 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); opacity: 0.7; filter: grayscale(0.8);
        }
        
        .stamp-btn:hover { transform: translateY(-3px); }
        
        /* æ¿€æ´»çŠ¶æ€ï¼šå˜æˆå½©è‰²ï¼Œå‘å…‰ */
        .stamp-btn.active {
            border-color: var(--accent-color); opacity: 1; filter: grayscale(0);
            transform: scale(1.1); box-shadow: 0 5px 15px rgba(255, 143, 163, 0.3);
        }

        /* ç›–åœ¨å³ä¸Šè§’çš„å¤§å°ç«  */
        .big-stamp-mark {
            position: absolute;
            top: 20px; right: 20px;
            font-size: 100px;
            opacity: 0;
            pointer-events: none; /* è®©é¼ æ ‡ç©¿é€ï¼Œä¸æŒ¡æ“ä½œ */
            transform: scale(3) rotate(-30deg); /* åˆå§‹çŠ¶æ€ï¼šå¾ˆå¤§ï¼Œæ‚¬ç©º */
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å¼¹æ€§åŠ¨ç”» */
            z-index: 0; /* æ”¾åœ¨åº•å±‚ï¼ŒèƒŒæ™¯å­—ä¹‹ä¸Šï¼Œå†…å®¹ä¹‹ä¸‹ */
            filter: drop-shadow(0 0 0 transparent); /* åˆå§‹æ— é˜´å½± */
        }

        /* ç›–ä¸‹å»çš„çŠ¶æ€ */
        .big-stamp-mark.stamped {
            opacity: 0.15; /* æ·¡æ·¡çš„å°è®° */
            transform: scale(1) rotate(-20deg); /* ç ¸ä¸‹æ¥ */
            filter: drop-shadow(2px 2px 0px rgba(255, 100, 100, 0.2));
        }

        /* ==================== ğŸ™ˆ é˜²çª¥æ¨¡å¼ (Privacy Blur) ==================== */
        
        /* 1. å½“ body åŠ ä¸Š privacy-active ç±»æ—¶ï¼Œæ¨¡ç³Šæ‰€æœ‰å›¾ç‰‡ */
        body.privacy-active .card img,       /* é¦–é¡µå¡ç‰‡å°é¢ */
        body.privacy-active .gallery-img,    /* è¯¦æƒ…é¡µå¤§å›¾ */
        body.privacy-active .resource-preview img { /* ç¼–è¾‘åˆ—è¡¨é‡Œçš„ç¼©ç•¥å›¾ */
            filter: blur(20px) !important;   /* å¼ºåŠ›é«˜æ–¯æ¨¡ç³Š */
            opacity: 0.8;                    /* ç¨å¾®å˜æ·¡ä¸€ç‚¹ */
            transition: all 0.3s ease;       /* ä¸æ»‘è¿‡æ¸¡ */
        }

        /* 2. å³ä¸Šè§’çš„çœ¼ç›æŒ‰é’®æ ·å¼ */
        .privacy-toggle-btn {
            position: absolute;
            top: 20px; 
            right: 20px;
            font-size: 22px;
            cursor: pointer;
            z-index: 100; /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
            
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            width: 42px; height: 42px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #fff;
            box-shadow: 0 4px 10px rgba(255, 183, 197, 0.2);
            transition: all 0.2s;
            color: var(--accent-color);
        }
        
        .privacy-toggle-btn:active { transform: scale(0.9); }

        /* ==================== âœ¨ æŒ‡å°–é­”æ³• (é¼ æ ‡+ç‚¹å‡»ç‰¹æ•ˆ) ==================== */
        
        /* 1. å…¨å±€é¼ æ ‡å˜å¯çˆ± (æ¢æˆçŒ«çˆªæˆ–é­”æ³•æ£’) */
        body {
            /* è¿™é‡Œç”¨çš„æ˜¯ä¸€ä¸ªé€šç”¨çš„å¯çˆ±å…‰æ ‡é“¾æ¥ï¼Œå¦‚æœå¤±æ•ˆäº†ä¼šé€€åŒ–æˆé»˜è®¤çš„ */
            cursor: url('https://cur.cursors-4u.net/nature/nat-2/nat120.cur'), auto; 
        }
        
        /* æŒ‰é’®å˜æˆæ‰‹æŒ‡ */
        button, .card, .action-card, .stamp-btn {
            cursor: url('https://cur.cursors-4u.net/nature/nat-2/nat122.cur'), pointer;
        }

        /* 2. ç‚¹å‡»çˆ†å‡ºçš„ç²’å­ */
        .magic-particle {
            position: fixed;
            pointer-events: none; /* ä¸æŒ¡é¼ æ ‡ */
            animation: particleFloat 1s ease-out forwards;
            font-size: 20px;
            z-index: 9999;
            user-select: none;
        }

        @keyframes particleFloat {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1.5); opacity: 0; }
        }

        /* ==================== ğŸ“Š ç¾ç»Šåˆ†ææŠ¥å‘Šæ ·å¼ ==================== */
        .report-card {
            background: linear-gradient(135deg, #fff 0%, #fff9fb 100%);
            border-radius: 20px; padding: 25px; text-align: center;
            box-shadow: 0 10px 30px rgba(255, 183, 197, 0.3);
            border: 3px solid #fff; position: relative; overflow: hidden;
        }
        .report-stat-row {
            display: flex; justify-content: space-around; margin: 20px 0;
            background: rgba(255,240,245,0.5); border-radius: 15px; padding: 15px;
        }
        .stat-item h3 { font-size: 24px; color: var(--accent-color); margin: 0; }
        .stat-item p { font-size: 12px; color: #888; margin: 5px 0 0 0; }
        
        /* æ¯”ä¾‹æ¡ */
        .ratio-bar-container {
            height: 24px; width: 100%; background: #eee; border-radius: 12px;
            overflow: hidden; display: flex; margin-top: 10px; position: relative;
        }
        .ratio-segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; transition: width 1s ease; }
        .ratio-left { background: #a8edea; } /* ä½ çš„é¢œè‰² */
        .ratio-right { background: #ffb7c5; } /* è§’è‰²é¢œè‰² */

        /* ==================== ğŸ² çµæ„Ÿæ‰­è›‹æœº Pro æ ·å¼ ==================== */
        .gacha-machine {
            background: #fff0f5; border-radius: 30px; padding: 20px;
            border: 4px solid white; box-shadow: inset 0 0 20px rgba(255,183,197,0.2);
            position: relative;
        }
        .gacha-display {
            background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
            border: 2px dashed #ffb7c5; min-height: 100px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .gacha-tag {
            display: inline-block; padding: 5px 12px; border-radius: 20px;
            font-size: 14px; margin: 5px; font-weight: bold; color: white;
            animation: popIn 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .tag-place { background: #81ecec; }
        .tag-event { background: #74b9ff; }
        .tag-trope { background: #ff7675; }
        
        .gacha-controls { display: flex; gap: 10px; justify-content: center; }
        .gacha-edit-area { display: none; margin-top: 15px; border-top: 1px dashed #ddd; padding-top: 15px; }
        .gacha-textarea { width: 100%; height: 80px; font-size: 12px; padding: 8px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 5px; resize: none; font-family: inherit; }

        /* ==================== ğŸ’ çºªå¿µå“é™ˆåˆ—å®¤æ ·å¼ ==================== */
        
        /* 1. ä¸»é¡µé™ˆåˆ—æ¶è§†å›¾ */
        .shelf-container {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 20px; 
            padding: 20px;
            background: #fff9fb; 
            border: 4px solid #fff; 
            border-radius: 20px;
            box-shadow: inset 0 0 30px rgba(255,183,197,0.1);
        }
        
        /* å•ä¸ªçºªå¿µå“ (æ‹ç«‹å¾—é£æ ¼) */
        .souvenir-card {
            background: white;
            padding: 8px 8px 25px 8px; /* åº•éƒ¨ç•™ç™½åƒæ‹ç«‹å¾— */
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: rotate(var(--rot)); /* éšæœºä¸€ç‚¹ç‚¹æ­ªæ–œï¼Œæ›´è‡ªç„¶ */
            transition: transform 0.3s;
            cursor: pointer;
            text-align: center;
            position: relative;
        }
        .souvenir-card:hover {
            transform: scale(1.1) rotate(0deg) !important;
            z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .souvenir-img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            background: #f0f0f0;
            margin-bottom: 5px;
            border: 1px solid #eee;
        }
        .souvenir-title {
            font-family: 'MyCustomFont', cursive, sans-serif;
            font-size: 12px;
            color: #555;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* 2. è¯¦æƒ…é¡µé‡Œçš„çºªå¿µå“æ¨ªå‘æ»šåŠ¨æ  */
        .souvenir-scroll-box {
            display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px;
            margin-bottom: 15px;
            scrollbar-width: thin;
        }
        .souvenir-mini-item {
            flex-shrink: 0; width: 60px; text-align: center; cursor: pointer;
        }
        .souvenir-mini-img {
            width: 50px; height: 50px; border-radius: 10px; object-fit: cover;
            border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* 3. çºªå¿µå“æŸ¥çœ‹å¤§å›¾å¼¹çª— */
        .souvenir-view-content {
            text-align: center;
        }
        .souvenir-view-img {
            max-width: 100%; max-height: 300px; border-radius: 10px;
            border: 5px solid white; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .souvenir-view-story {
            font-size: 14px; color: #666; line-height: 1.6; text-align: left;
            background: #fff0f5; padding: 15px; border-radius: 10px;
            margin-bottom: 15px; font-style: italic;
        }

                  /* ==================== â˜ï¸ æœ€ç»ˆç‰ˆï¼šèŠ±ç“£é›¨ä¸å›å¿† ==================== */
        .dream-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            /* èƒŒæ™¯ï¼šç²‰è‰²æ™¨æ›¦ */
            background: linear-gradient(180deg, #ffc3a0 0%, #ffafbd 100%);
            z-index: 9000; display: none; overflow: hidden;
        }
        .dream-layer.active { display: block; }

        /* ğŸŒ¸ 1. çº¯è£…é¥°ç”¨çš„èƒŒæ™¯èŠ±ç“£ */
        .dream-bg-petal {
            position: absolute; top: -50px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 100% 0 100% 0; /* èŠ±ç“£å½¢çŠ¶ */
            pointer-events: none; /* é¼ æ ‡ç©¿é€ï¼Œç‚¹ä¸åˆ°å®ƒ */
            animation: bgFall linear infinite;
        }
        @keyframes bgFall {
            0% { top: -10%; transform: rotate(0deg) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            100% { top: 110%; transform: rotate(360deg) translateX(50px); opacity: 0; }
        }

        /* ğŸ“¦ 2. å›å¿†å®¹å™¨ (ç»Ÿä¸€æ ·å¼) */
        .dream-content-item {
            position: absolute; top: -200px;
            cursor: pointer;
            animation: itemFall linear forwards;
            z-index: 10;
            transition: transform 0.3s;
        }
        .dream-content-item:hover {
            transform: scale(1.1) !important;
            z-index: 100;
        }

        /* ğŸ–¼ï¸ ç±»å‹Aï¼šæ­£æ–¹å½¢å›¾ç‰‡ */
        .dream-item-img {
            width: 120px; height: 120px;
            border-radius: 20px; /* åœ†è§’æ­£æ–¹å½¢ */
            border: 4px solid #fff;
            box-shadow: 0 8px 20px rgba(255, 154, 158, 0.4);
            overflow: hidden;
            background: #fff;
        }
        .dream-item-img img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .dream-img-name {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.8); color: #d66a80;
            font-size: 10px; text-align: center; padding: 4px 0;
            backdrop-filter: blur(2px);
        }

        /* ğŸ’¬ ç±»å‹Bï¼šæ–‡å­—æ°”æ³¡ */
        .dream-item-text {
            background: #fff;
            padding: 15px 20px;
            border-radius: 20px;
            border-bottom-left-radius: 4px; /* æ°”æ³¡å°å°¾å·´æ•ˆæœ */
            color: #555; font-size: 13px; line-height: 1.5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-width: 180px;
            text-align: left;
            border: 2px solid #fff0f5;
        }

        /* ä¸‹è½åŠ¨ç”» (è½»è½»æ‘‡æ‘†ï¼Œä½†ä¸æ—‹è½¬) */
        @keyframes itemFall {
            0% { top: -150px; opacity: 0; transform: translateX(0); }
            10% { opacity: 1; }
            25% { transform: translateX(20px); }
            50% { transform: translateX(-20px); }
            75% { transform: translateX(20px); }
            100% { top: 110%; opacity: 0; transform: translateX(0); }
        }

        /* ==================== ğŸ“– G. çµé­‚å›å“æ ·å¼ ==================== */
        .echo-card {
            background: #fff; border-radius: 20px; padding: 20px;
            text-align: center; border: 2px solid #e0e0e0;
        }
        .echo-result-box {
            min-height: 100px; margin: 20px 0; display: flex; align-items: center; justify-content: center;
            background: #f8f9fa; border-radius: 10px; padding: 20px;
            font-size: 18px; font-weight: bold; color: var(--accent-color);
            font-family: 'MyCustomFont', sans-serif; position: relative;
        }
        .echo-result-box::before, .echo-result-box::after {
            content: 'â'; position: absolute; font-size: 40px; color: #eee;
        }
        .echo-result-box::before { top: 0; left: 10px; }
        .echo-result-box::after { content: 'â'; bottom: -10px; right: 10px; }

        .echo-avatar {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            margin: 0 auto 10px auto; border: 3px solid #ffb7c5;
            box-shadow: 0 5px 15px rgba(255, 183, 197, 0.4);
        }

        /* åˆ†é¡µåˆ‡æ¢æ ·å¼ */
        .menu-page { animation: fadeIn 0.3s ease; }
        .menu-tab-bar {
            display: flex; margin-top: 10px; border-top: 1px solid #eee; padding-top: 8px;
        }
        .menu-tab {
            flex: 1; background: none; border: none; color: #ccc; cursor: pointer;
            font-size: 13px; padding: 6px; border-radius: 8px; transition: 0.3s;
        }
        .menu-tab:hover { background: #fff5f7; color: var(--accent-color); }
        .menu-tab.active {
            color: white; font-weight: bold; background: var(--accent-color);
            box-shadow: 0 2px 5px rgba(255, 143, 163, 0.3);
        }

        /* ==================== âœ‹ æ‘¸æ‘¸å¤´ç‰¹æ•ˆ ==================== */
        
        /* 1. å›¾ç‰‡è¢«ç‚¹å‡»æ—¶çš„æœå†»åŠ¨ç”» */
        .headpat-active {
            animation: jelly 0.4s;
        }
        @keyframes jelly {
            0% { transform: scale(1, 1); }
            30% { transform: scale(1.05, 0.95); } /* å‹æ‰ */
            40% { transform: scale(0.95, 1.05); } /* æ‹‰é•¿ */
            50% { transform: scale(1.02, 0.98); } /* å›å¼¹ */
            65% { transform: scale(0.99, 1.01); }
            100% { transform: scale(1, 1); }
        }

        /* 2. çˆ†å‡ºçš„çˆ±å¿ƒ/è¡¨æƒ… */
        .pat-particle {
            position: fixed;
            pointer-events: none;
            font-weight: bold;
            color: #ff6b81;
            font-size: 20px;
            z-index: 9999;
            animation: floatUpFade 0.8s forwards;
            text-shadow: 0 0 5px white;
        }
        @keyframes floatUpFade {
            0% { opacity: 1; transform:translateY(0) scale(0.5); }
            50% { opacity: 1; transform:translateY(-30px) scale(1.2); }
            100% { opacity: 0; transform:translateY(-60px) scale(1); }
        }

        /* ==================== ğŸ’ èª“çº¦ä¹‹è¯æ ·å¼ ==================== */
        
        .oath-paper {
            background: #fffdf5; /* ç±³é»„è‰²ç¾Šçš®çº¸æ„Ÿ */
            width: 320px;
            padding: 30px 20px;
            border-radius: 10px;
            position: relative;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3), 0 20px 40px rgba(0,0,0,0.2);
            transform-style: preserve-3d;
            transition: transform 0.6s;
            /* åŠ ä¸Šçº¹ç† */
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
        }

        /* åŒé‡è¾¹æ¡†ï¼Œå¢åŠ ä»ªå¼æ„Ÿ */
        .oath-border {
            position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 2px solid #d4af37; /* é‡‘è‰²å®çº¿ */
            border-radius: 5px;
            pointer-events: none;
        }
        .oath-border::after {
            content: ''; position: absolute; top: 3px; left: 3px; right: 3px; bottom: 3px;
            border: 1px dashed #d4af37; /* é‡‘è‰²è™šçº¿ */
            border-radius: 3px;
        }

        .oath-header {
            font-size: 22px; color: #d4af37; font-weight: bold;
            margin-bottom: 20px; letter-spacing: 2px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            font-family: serif; /* è¡¬çº¿ä½“æ›´æ˜¾æ­£å¼ */
        }

        .oath-avatar {
            width: 80px; height: 80px; border-radius: 50%;
            border: 3px double #d4af37;
            object-fit: cover; padding: 2px; background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .oath-footer {
            display: flex; justify-content: space-between; margin-top: 30px; padding: 0 20px;
        }
        .oath-sign-box { text-align: left; font-size: 12px; color: #999; }
        .sign-line {
            font-family: cursive; font-size: 16px; color: #333;
            border-bottom: 1px solid #ddd; min-width: 80px; margin-top: 5px;
            text-align: center; padding-bottom: 2px;
        }

        /* ğŸ”´ æŒ‰æ‰‹å°æŒ‰é’® */
        .oath-seal-btn {
            background: #ff7675; color: white;
            width: 80px; height: 80px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 30px auto 10px auto; cursor: pointer;
            font-weight: bold; border: 4px solid #fab1a0;
            box-shadow: 0 5px 15px rgba(255, 118, 117, 0.4);
            animation: pulseBtn 2s infinite;
            transition: all 0.3s;
        }
        .oath-seal-btn:active { transform: scale(0.9); }
        @keyframes pulseBtn { 0% {transform:scale(1);} 50% {transform:scale(1.05);} 100% {transform:scale(1);} }

        /* ğŸ’‹ ç›–ç« å°è®° */
        .oath-stamp-mark {
            position: absolute; bottom: 40px; left: 50%;
            transform: translateX(-50%) scale(2);
            opacity: 0; pointer-events: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center;
        }
        
        /* ç›–ç« ç”Ÿæ•ˆæ—¶çš„æ ·å¼ */
        .oath-paper.signed .oath-seal-btn { display: none; } /* éšè—æŒ‰é’® */
        .oath-paper.signed .oath-stamp-mark {
            opacity: 0.8; transform: translateX(-50%) scale(1) rotate(-10deg);
        }
        .oath-paper.signed {
            box-shadow: 0 0 80px rgba(255, 215, 0, 0.6); /* èª“çº¦è¾¾æˆå‘å‡ºé‡‘å…‰ */
            border-color: #ffd700;
        }

               /* ==================== ğŸ–¼ï¸ ç›¸æ¡†æ ·å¼åº“ (åŠ ç²—åŠ å¼ºç‰ˆ) ==================== */
        
        /* 1. ğŸ€ è•¾ä¸ç”œå¿ƒ (åŠ ç²—ç²‰çº¿ + å¤§è´è¶ç»“) */
        .card-img-wrapper.frame-lace {
            border: 5px dashed #ff8fa3; /* çº¿æ¡å˜ç²—ï¼Œé¢œè‰²å˜æ·± */
            background: #fff0f5;
            /* åŒå±‚æŠ•å½±ï¼Œå¢åŠ ç«‹ä½“æ„Ÿ */
            box-shadow: 
                0 0 0 4px #fff inset, 
                0 10px 20px rgba(255, 143, 163, 0.3);
            overflow: visible; /* å…è®¸è´è¶ç»“çªå‡ºæ¥ä¸€ç‚¹ */
            z-index: 1;
        }
        .card-img-wrapper.frame-lace::after {
            content: 'ğŸ€'; position: absolute; top: -10px; left: -10px;
            font-size: 32px; /* å›¾æ ‡æ”¾å¤§ */
            z-index: 10;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
            transform: rotate(-15deg);
        }

        /* 2. âšœï¸ éé‡‘å…¸è— (åšé‡é‡‘æ¡† + å¤§çº¹é¥°) */
        .card-img-wrapper.frame-gold {
            border: 6px solid #d4af37; /* å®å¿ƒåšé‡‘è¾¹ */
            /* å†…ä¾§åŠ ä¸€é“æ·±è‰²çº¿ï¼ŒåƒçœŸç”»æ¡† */
            outline: 2px solid #8a6d3b; 
            outline-offset: -8px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4); /* æ·±é‚ƒæŠ•å½± */
            overflow: visible;
            z-index: 1;
        }
        .card-img-wrapper.frame-gold::before {
            content: 'âšœï¸'; position: absolute; bottom: -10px; right: -10px;
            font-size: 28px; z-index: 10;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
        }
        /* é¡¶éƒ¨åŠ ä¸ªçš‡å† è£…é¥° */
        .card-img-wrapper.frame-gold::after {
            content: 'ğŸ‘‘'; position: absolute; top: -15px; left: 50%;
            transform: translateX(-50%);
            font-size: 24px; z-index: 10;
        }

        /* 3. âœ¨ æ˜Ÿå…‰æµä½“ (å¼ºåŠ›éœ“è™¹å…‰æ•ˆ) */
        .card-img-wrapper.frame-stardust {
            border: 4px solid transparent;
            /* è¿™ç§å†™æ³•å¯ä»¥åšå‡ºæ¸å˜è¾¹æ¡† */
            background-image: linear-gradient(white, white), linear-gradient(45deg, #a18cd1, #fbc2eb, #8fd3f4);
            background-origin: border-box;
            background-clip: content-box, border-box;
            /* è¶…å¼ºå…‰æ™• */
            box-shadow: 0 0 20px 5px rgba(161, 140, 209, 0.6);
            animation: borderRotate 2s linear infinite; /* è¾¹æ¡†è‰²è°ƒæµåŠ¨ */
            overflow: visible;
            z-index: 1;
        }
        .card-img-wrapper.frame-stardust::after {
            content: 'âœ¨'; position: absolute; bottom: 5px; right: 5px;
            font-size: 24px; 
            filter: drop-shadow(0 0 5px #fff);
            animation: spin 3s linear infinite;
        }
        @keyframes borderRotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        /* 4. ğŸŒ¸ è½æ¨±ç”»å¢ƒ (èŠ±å›¢é”¦ç°‡) */
        .card-img-wrapper.frame-sakura {
            border: 5px solid #ff9a9e; /* ç²—ç²‰è¾¹ */
            border-radius: 25px; /* æ›´åœ†æ¶¦ */
            box-shadow: 0 10px 20px rgba(255, 154, 158, 0.3);
            overflow: visible;
            z-index: 1;
        }
        /* å·¦ä¸Šè§’ä¸€å¤§ç°‡ */
        .card-img-wrapper.frame-sakura::before {
            content: 'ğŸŒ¸'; position: absolute; top: -12px; left: -12px;
            font-size: 30px; z-index: 10;
            text-shadow: 2px 2px 0 #fff;
        }
        /* å³ä¸‹è§’ä¸€å¤§ç°‡ */
        .card-img-wrapper.frame-sakura::after {
            content: 'ğŸŒ¸'; position: absolute; bottom: -12px; right: -12px;
            font-size: 30px; z-index: 10;
            text-shadow: 2px 2px 0 #fff;
        }

                /* ==================== ğŸ–¼ï¸ è¯¦æƒ…é¡µä¸“å±ï¼šè¾¹æ¡†+ç‰¹æ•ˆ ==================== */
        
        /* 1. å¿…é¡»ç»™ç”»å»Šå®¹å™¨è®¾ç½® overflow: visibleï¼Œå¦åˆ™è´è¶ç»“ä¼šè¢«åˆ‡æ‰ */
        .gallery-container {
            overflow: visible !important; 
            transition: all 0.3s;
            background: #fff; /* é»˜è®¤ç™½åº• */
        }

                /* ==================== âœ¨ é«˜å®šç‰ˆï¼šè¯¦æƒ…é¡µç²’å­ç‰¹æ•ˆ ==================== */
        
        /* 1. ç‰¹æ•ˆå®¹å™¨ï¼šå¿…é¡»è£å‰ªæº¢å‡ºï¼Œé˜²æ­¢ç²’å­é£˜åˆ°æ¡†å¤–é¢ */
        .detail-effect-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 20;
            overflow: hidden; border-radius: 15px;
        }

        /* 2. é€šç”¨ç²’å­åŸºç¡€æ ·å¼ */
        .effect-particle {
            position: absolute; top: -20px;
            pointer-events: none;
            opacity: 0;
        }

        /* ========== ğŸŒ¸ æ¨±èŠ± (Sakura) - çœŸæ­£çš„èŠ±ç“£å½¢çŠ¶ ========== */
        .particle-sakura {
            background: linear-gradient(120deg, #ffc3a0 0%, #ffafbd 100%);
            border-radius: 100% 0 100% 0; /* ğŸ‘ˆ å…³é”®ï¼šåšæˆèŠ±ç“£å°–è§’å½¢çŠ¶ */
            animation: fall-sway linear infinite;
            box-shadow: 0 2px 5px rgba(255, 154, 158, 0.2);
        }
        @keyframes fall-sway {
            0% { top: -10%; opacity: 0; transform: translateX(0) rotate(0deg); }
            10% { opacity: 0.9; }
            50% { opacity: 1; transform: translateX(20px) rotate(90deg); }
            100% { top: 110%; opacity: 0; transform: translateX(-20px) rotate(180deg); }
        }

        /* ========== âœ¨ æ˜Ÿå…‰ (Stardust) - é—ªçƒæµæ˜Ÿ ========== */
        .particle-star {
            background: white;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); /* æ˜Ÿæ˜Ÿå½¢çŠ¶ */
            animation: fall-twinkle linear infinite;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
        @keyframes fall-twinkle {
            0% { top: -10%; opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { top: 110%; opacity: 0; transform: scale(0.5); }
        }

        /* ========== ğŸ€ è•¾ä¸ (Lace) - æŸ”å’Œå…‰æ–‘/çˆ±å¿ƒ ========== */
        .particle-heart {
            color: #ff8fa3;
            font-size: 14px;
            animation: fall-float linear infinite;
        }
        .particle-heart::after { content: 'ğŸ’—'; } /* ç”¨ Emoji æ›´æ¸…æ™° */
        @keyframes fall-float {
            0% { top: -10%; transform: translateY(0) scale(0.8); opacity: 0; }
            50% { opacity: 0.8; transform: translateY(10px) scale(1.1); }
            100% { top: 110%; transform: translateY(0) scale(0.8); opacity: 0; }
        }

        /* ========== âšœï¸ éé‡‘ (Gold) - é‡‘ç²‰ç²’å­ ========== */
        .particle-gold {
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 4px #d4af37;
            animation: fall-fast linear infinite;
        }
        @keyframes fall-fast {
            0% { top: -10%; opacity: 0; transform: translateY(0); }
            20% { opacity: 1; }
            100% { top: 120%; opacity: 0; transform: translateY(20px); }
        }

        /* ==================== ğŸ¤« åˆ®åˆ®ä¹æ ·å¼ ==================== */
        .scratch-container {
            position: relative;
            width: 260px; height: 150px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            user-select: none; /* é˜²æ­¢é€‰ä¸­æ–‡å­— */
        }

        /* åº•å±‚æ–‡å­— */
        .scratch-text-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
            color: #d66a80; font-weight: bold; font-size: 15px;
            line-height: 1.5;
            z-index: 1;
            background: #fff; /* ç™½åº• */
        }

        /* é¡¶å±‚ç”»å¸ƒ (æ¶‚å±‚) */
        #scratchCanvas {
            position: absolute; top: 0; left: 0;
            z-index: 2;
            touch-action: none; /* é˜²æ­¢æ‰‹æœºæ»šåŠ¨ */
            cursor: crosshair;
        }

        /* åˆå§‹é®ç½© (åšé€‰æ‹©é¢˜ç”¨) */
        .scratch-cover-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 10;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.3s;
        }

        .scratch-actions {
            display: flex; justify-content: center; gap: 15px; margin-top: 20px;
        }

        /* ==================== ğŸ“Œ ä¾¿ç­¾æ ·å¼ ==================== */
        
        .sticky-note-paper {
            width: 280px;
            height: 350px;
            background: #fff9c4; /* ç»å…¸çš„ä¾¿ç­¾é»„ */
            /* å¦‚æœå–œæ¬¢ç²‰è‰²ä¾¿ç­¾ï¼Œå¯ä»¥ç”¨è¿™ä¸ªé¢œè‰²: #fff0f5 */
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.1);
            transform: rotate(-2deg); /* å¾®å¾®æ­ªä¸€ç‚¹ï¼Œæ›´è‡ªç„¶ */
            display: flex;
            flex-direction: column;
            position: relative;
            transition: transform 0.3s;
        }
        
        /* æ‚¬åœæ‰¶æ­£ */
        .sticky-note-paper:hover {
            transform: rotate(0deg) scale(1.02);
            box-shadow: 10px 10px 30px rgba(0,0,0,0.15);
        }

        /* é¡¶éƒ¨ç±»ä¼¼èƒ¶å¸¦çš„æ•ˆæœ */
        .sticky-note-paper::before {
            content: '';
            position: absolute;
            top: -15px; left: 50%; transform: translateX(-50%);
            width: 100px; height: 30px;
            background: rgba(255,255,255,0.4);
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .note-toolbar {
            display: flex;
            justify-content: space-between;
            background: rgba(255,255,255,0.5);
            padding: 5px 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* è¾“å…¥æ¡†å»è¾¹æ¡†ï¼Œåƒç›´æ¥å†™åœ¨çº¸ä¸Š */
        #noteTextarea {
            flex-grow: 1;
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            font-family: 'MyCustomFont', cursive, sans-serif; /* ç”¨ä½ çš„å¯çˆ±å­—ä½“ */
            line-height: 1.6;
            color: #555;
        }
        
        /* è‡ªå®šä¹‰å–è‰²å™¨æ ·å¼ (ç®€å•ä¼˜åŒ–) */
        #noteColorPicker {
            border: none; width: 20px; height: 20px; cursor: pointer; background: none;
        }

       /* ================= ğŸ“Œ ä¾¿ç­¾å¢™æ ·å¼ (é˜²é®æŒ¡ç‰ˆ) ================= */
#stickyNoteDisplay {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-end; /* é å³æ’ */
    gap: 10px;
    padding: 10px;
    position: absolute;
    top: 50px;           /* é¿å¼€é¡¶éƒ¨çš„å…³é—­æŒ‰é’® */
    right: 10px;
    width: 85%;          /* å®½åº¦é™åˆ¶ */
    min-height: 50px;    /* ç»™ä¸ªæœ€å°é«˜åº¦ */
    pointer-events: none; /* å®¹å™¨é€ä¼ é¼ æ ‡ */
    z-index: 100;        /* âœ… å±‚çº§æ‹‰é«˜ï¼Œä¿è¯åœ¨æœ€ä¸Šå±‚ï¼ */
}

/* ================= ğŸ“Œ æ‰‹è´¦é£ä¾¿ç­¾æ ·å¼ (æ›¿æ¢æ—§çš„) ================= */

.real-sticky-note {
    position: relative;
    width: 110px;
    min-height: 90px;
    padding: 15px 10px 10px 10px; /* ä¸Šé¢ç•™ç‚¹ç©ºç»™èƒ¶å¸¦ */
    
    /* æ ¸å¿ƒæ”¹åŠ¨ï¼šä¸å†æ˜¯æ­»æ¿çš„æ–¹å—ï¼Œå³ä¸‹è§’å¤§åœ†è§’æ¨¡æ‹Ÿå·èµ· */
    border-radius: 2px 2px 20px 2px; 
    
    /* çº¸å¼ è´¨æ„Ÿé˜´å½±ï¼šä¸¤å±‚é˜´å½±ï¼Œä¸€å±‚æ˜¯çº¸çš„ï¼Œä¸€å±‚æ˜¯å·è§’çš„ */
    box-shadow: 
        1px 1px 3px rgba(0,0,0,0.1), /* åŸºç¡€é˜´å½± */
        5px 5px 10px rgba(0,0,0,0.1); /* æµ®èµ·é˜´å½± */
    
    font-family: 'MyCustomFont', cursive, sans-serif;
    font-size: 13px;
    line-height: 1.5;
    color: #444;
    word-wrap: break-word;
    
    cursor: pointer;
    transition: transform 0.2s;
    pointer-events: auto;
    
    /* é»˜è®¤å¸¦ä¸€ç‚¹æ—‹è½¬ï¼ŒJSä¼šè¦†ç›–è¿™ä¸ªå˜é‡ */
    transform: rotate(var(--rot, 0deg));
    
    /* ç»™ä¸ªç±³é»„è‰²çš„åº•ï¼Œé˜²æ­¢é¢œè‰²åŠ è½½æ…¢æ—¶å¤ªç™½ */
    background-color: #fff9c4;
}

/* æ‚¬åœç‰¹æ•ˆï¼šä»¿ä½›è¦è¢«æ­ä¸‹æ¥ */
.real-sticky-note:hover {
    transform: scale(1.1) rotate(0deg) !important;
    z-index: 200;
    box-shadow: 5px 15px 25px rgba(0,0,0,0.15); /* æ‚¬åœæ—¶é˜´å½±å˜é•¿ */
}

/* ğŸ¬ åŠé€æ˜å’Œçº¸èƒ¶å¸¦è£…é¥° */
.real-sticky-note::before {
    content: ''; 
    position: absolute; 
    top: -12px;           /* è´´åœ¨æœ€ä¸Šé¢ï¼Œéœ²å‡ºä¸€åŠ */
    left: 50%; 
    transform: translateX(-50%) rotate(-2deg); /* èƒ¶å¸¦ä¹Ÿç¨å¾®æ­ªä¸€ç‚¹ */
    
    width: 40px; 
    height: 18px;
    
    /* åŠé€æ˜ç£¨ç ‚èƒ¶å¸¦æ„Ÿ */
    background: rgba(255, 255, 255, 0.4); 
    border-left: 2px dotted rgba(255,255,255,0.6); /* èƒ¶å¸¦æ’•å£ */
    border-right: 2px dotted rgba(255,255,255,0.6);
    
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    backdrop-filter: blur(2px); /* ç£¨ç ‚æ•ˆæœ */
}



        /* ==================== ğŸ¤– AI èŠå¤©æ ·å¼ ==================== */
        .ai-msg-row {
            display: flex; margin-bottom: 8px;
        }
        .ai-msg-row.user { justify-content: flex-end; }
        .ai-msg-row.ai { justify-content: flex-start; }
        
        .ai-bubble {
            padding: 8px 12px; border-radius: 15px; max-width: 80%;
            word-wrap: break-word; line-height: 1.4;
            font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .ai-msg-row.user .ai-bubble {
            background: var(--accent-color); color: white;
            border-bottom-right-radius: 2px;
        }
        .ai-msg-row.ai .ai-bubble {
            background: #fff; color: #555; border: 1px solid #eee;
            border-bottom-left-radius: 2px;
        }
        .ai-loading { color: #999; font-size: 10px; font-style: italic; margin-left: 5px; }

        /* AI æ¨èè·³è½¬æŒ‰é’® */
        .ai-jump-btn {
            display: inline-block;
            margin-top: 5px;
            padding: 4px 10px;
            background: #fff0f5;
            color: #d66a80;
            border: 1px solid #ffb7c5;
            border-radius: 15px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .ai-jump-btn:hover {
            background: #ffb7c5;
            color: white;
            transform: translateY(-2px);
        }

        /* ==================== ğŸ’Œ ä¿¡çº¸æ ·å¼ ==================== */
        .letter-paper {
            background: #fffbf0; /* ç±³é»„çº¸ */
            width: 300px;
            min-height: 400px;
            padding: 40px 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            background-image: linear-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 100% 25px; /* ä¿¡çº¸æ¨ªçº¿ */
            line-height: 25px;
            font-family: 'MyCustomFont', cursive, sans-serif; /* æ‰‹å†™å­—ä½“ */
            color: #555;
            transform: rotate(-1deg);
        }
        
        .letter-content {
            margin-top: 20px;
            font-size: 15px;
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
        }

        .letter-signature {
            margin-top: 30px;
            text-align: right;
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-color);
        }

        .letter-stamp {
            position: absolute;
            top: 20px; right: 20px;
            width: 60px; height: 60px;
            border: 3px double #d63031;
            border-radius: 50%;
            color: #d63031;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            transform: rotate(20deg);
            opacity: 0.6;
            pointer-events: none;
        }

/* ==================== ğŸ“± æœ‹å‹åœˆæ ·å¼ ==================== */
.moment-card {
    background: white;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    animation: fadeInUp 0.4s ease;
}

.moment-header {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.moment-user-avatar {
    width: 40px; height: 40px;
    border-radius: 5px;
    background: #ffb7c5;
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: bold; font-size: 18px;
}

.moment-content {
    font-size: 15px;
    color: #333;
    line-height: 1.5;
    margin-bottom: 10px;
}

.moment-meta {
    font-size: 12px;
    color: #999;
    display: flex; justify-content: space-between;
    margin-bottom: 10px;
}

/* è¯„è®ºåŒºçš„å°ä¸‰è§’ */
.moment-comments-area {
    background: #f7f7f7;
    border-radius: 4px;
    padding: 8px;
    position: relative;
    margin-top: 10px;
}
.moment-comments-area::before {
    content: '';
    position: absolute;
    top: -6px; left: 15px;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 6px solid #f7f7f7;
}

.moment-comment-row {
    font-size: 13px;
    margin-bottom: 5px;
    line-height: 1.4;
    border-bottom: 1px dashed #eee;
    padding-bottom: 4px;
}
.moment-comment-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.moment-role-name {
    color: #576b95; /* ç»å…¸æœ‹å‹åœˆè“å */
    font-weight: bold;
    cursor: pointer;
}

/* ==================== ğŸ“° å…«å¦å‘¨åˆŠæ ·å¼ ==================== */
.gossip-headline {
    font-family: 'Times New Roman', serif;
    font-size: 20px;
    font-weight: bold;
    color: #2c3e50;
    margin: 20px 0 10px 0;
    line-height: 1.3;
    text-align: left;
    border-bottom: 2px solid #333;
    padding-bottom: 5px;
}
.gossip-body {
    font-size: 14px;
    color: #444;
    line-height: 1.6;
    text-align: justify;
    font-family: serif;
    margin-bottom: 15px;
}
.gossip-tag {
    background: #333;
    color: #fff;
    padding: 2px 6px;
    font-size: 10px;
    text-transform: uppercase;
    display: inline-block;
    margin-bottom: 5px;
}
.gossip-img-placeholder {
    width: 100%; height: 120px;
    background: #e0e0e0;
    margin-bottom: 10px;
    display: flex; align-items: center; justify-content: center;
    color: #999; font-size: 12px; font-style: italic;
    border: 1px solid #ccc;
}

/* ==================== ğŸ± æ·±å¤œé£Ÿå ‚æ ·å¼ ==================== */
/* ä¸»è¦æ˜¯æ·±è‰²æ¨¡å¼å¾®è°ƒï¼Œå·²å†…è”åœ¨ HTML ä¸­ï¼Œæ­¤å¤„æ— éœ€é¢å¤–å¤æ‚æ ·å¼ */

/* ==================== ğŸ•¯ï¸ çµé­‚æ‹·é—®å®¤æ ·å¼ ==================== */
.soul-pulse {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 50%;
    box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
    animation: pulse-white 2s infinite;
    pointer-events: none;
    z-index: -1;
}

@keyframes pulse-white {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
    70% { transform: scale(1.2); box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
}

/* æ‰“å­—æœºå…‰æ ‡æ•ˆæœ */
.typing-cursor::after {
    content: '|';
    animation: blink 1s infinite;
}
@keyframes blink { 50% { opacity: 0; } }

/* ================= ğŸ›ï¸ è¯¦æƒ…é¡µæ§åˆ¶å°æ ·å¼ (æ–°) ================= */

/* 1. æŒ‰é’®å®¹å™¨ï¼šæ”¹ä¸º Grid ç½‘æ ¼å¸ƒå±€ */
.control-panel-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* å¼ºåˆ¶åˆ†ä¸º 3 åˆ— */
    gap: 8px; /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
    margin-top: 15px;
    padding: 0 5px;
}

/* 2. ç»Ÿä¸€æŒ‰é’®æ ·å¼ */
.control-panel-grid button {
    width: 100%;
    margin: 0 !important; /* å»æ‰åŸæ¥çš„å¤–è¾¹è· */
    padding: 8px 0;
    font-size: 12px; /* å­—ä½“æ”¹å°ä¸€ç‚¹ç‚¹ï¼Œé˜²æ­¢æ¢è¡Œ */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    height: 40px; /* ç»Ÿä¸€é«˜åº¦ */
    white-space: nowrap; /* å¼ºåˆ¶ä¸æ¢è¡Œ */
}

/* 3. åº•éƒ¨å±é™©åŒº (ä¸“é—¨æ”¾åˆ é™¤æŒ‰é’®) */
.danger-zone {
    margin-top: 10px;
    padding: 0 5px;
}
.danger-zone button {
    width: 100%;
    padding: 10px;
    font-weight: bold;
}

/* ================= ğŸ’– æ©å®  & ğŸŒ  é’¦å¤©ç›‘ æ ·å¼ ================= */

/* 1. ä½ä»½å¾½ç«  (æ˜¾ç¤ºåœ¨åå­—æ—è¾¹) */
.rank-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 8px;
    vertical-align: middle;
    color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
/* ä¸åŒç­‰çº§ä¸åŒé¢œè‰² */
.rank-0 { background: #b0bec5; border: 1px solid #90a4ae; } /* ä¾å¥´ */
.rank-1 { background: #81d4fa; border: 1px solid #4fc3f7; } /* ç­”åº” */
.rank-2 { background: #a5d6a7; border: 1px solid #81c784; } /* è´µäºº */
.rank-3 { background: #ffcc80; border: 1px solid #ffb74d; } /* å«” */
.rank-4 { background: #f48fb1; border: 1px solid #f06292; } /* å¦ƒ */
.rank-5 { background: linear-gradient(135deg, #ffd700, #ff8f00); border: 1px solid #ffa000; text-shadow: 0 1px 0 rgba(0,0,0,0.2); } /* çš‡è´µå› */

/* 2. æ©å® è¿›åº¦æ¡ (æ”¾åœ¨åå­—ä¸‹é¢) */
.favor-progress-container {
    width: 100%;
    height: 6px;
    background: #eee;
    border-radius: 3px;
    margin-top: 5px;
    overflow: hidden;
    position: relative;
}
.favor-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ff9a9e, #fad0c4);
    width: 0%;
    transition: width 0.5s;
}

/* 3. é’¦å¤©ç›‘å¼¹çª— (æ˜Ÿç©ºèƒŒæ™¯) */
#horoscopeModal .modal {
    background: linear-gradient(to bottom, #1a1a2e, #16213e);
    color: #fff;
    border: 2px solid #ffd700;
}
.horoscope-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    border: 1px solid rgba(255, 215, 0, 0.3);
}

/* ================= ğŸ‘¶ çš‡å—£ç³»ç»Ÿï¼š2DåŠ¨æ€ç«‹ç»˜ç‰ˆ ================= */

/* 1. ä¸œå®«å¼¹çª—å®¹å™¨ */
#eastPalaceModal .modal {
    width: 380px;
    background: #fff;
    border: 3px solid #ffb7c5;
    border-radius: 12px;
    padding: 0;
    overflow: hidden;
    display: flex; flex-direction: column;
}

/* 2. é¡¶éƒ¨å¤§èƒŒæ™¯ (æ”¾æ‚¨ç»™çš„é£æ™¯ç…§) */
.heir-bg-stage {
    width: 100%;
    height: 180px; /* é£æ™¯å›¾é«˜åº¦ */
    background-size: cover;
    background-position: center;
    position: relative;
    border-bottom: 2px solid #ffd1dc;
}

/* 3. ä¸­é—´åŒºåŸŸï¼šå·¦è¾¹ä¿¡æ¯ï¼Œå³è¾¹ç«‹ç»˜ */
.heir-middle-section {
    display: flex;
    position: relative;
    padding: 10px;
    background: linear-gradient(to bottom, #fff0f5 0%, #fff 100%);
}

.heir-info-left {
    flex: 1; /* å·¦è¾¹å æ»¡å‰©ä½™ç©ºé—´ */
    padding-right: 100px; /* âš ï¸ å…³é”®ï¼šå³è¾¹ç•™å‡ºç©ºä½ç»™ç«‹ç»˜ï¼ */
}

/* ğŸ”¥ 4. å³ä¾§ç«‹ç»˜å°æ¡† (æ‚¨è¦çš„å°æ¡) */
.heir-avatar-box {
    position: absolute;
    right: 10px;
    top: -60px; /* è®©å®ƒç¨å¾®çªå‡ºå»ä¸€ç‚¹åˆ°èƒŒæ™¯å›¾ä¸Šï¼Œæ›´æœ‰å±‚æ¬¡æ„Ÿ */
    width: 120px;
    height: 160px;
    z-index: 10;
    display: flex;
    align-items: flex-end; /* è®©äººç‰©ç«™åœ¨åº•éƒ¨ */
    justify-content: center;
    /* è°ƒè¯•ç”¨ï¼šå¦‚æœæ‚¨æƒ³çœ‹åˆ°æ¡†æ¡†ï¼Œå¯ä»¥åŠ  borderï¼Œè¿™é‡Œæˆ‘å…ˆéšè—è¾¹æ¡† */
    /* border: 1px dashed red; */ 
}

/* åŠ¨å›¾æœ¬ä½“ */
.heir-gif {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); /* åŠ ç‚¹é˜´å½±æ›´ç«‹ä½“ */
    transition: all 0.3s;
    cursor: pointer;
}
.heir-gif:hover { transform: scale(1.05); }

/* 5. å±æ€§æ¡æ ·å¼ä¼˜åŒ– */
.stat-row { display: flex; align-items: center; margin-bottom: 4px; font-size: 12px; color: #666; }
.stat-name { width: 30px; font-weight: bold; }
.stat-track { flex: 1; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin: 0 5px; }
.stat-val { height: 100%; border-radius: 3px; transition: width 0.5s; }

/* 6. åº•éƒ¨æ“ä½œåŒº */
.heir-bio-scroll {
    height: 80px; overflow-y: auto;
    background: rgba(255,255,255,0.6);
    border: 1px dashed #ffb7c5;
    margin: 5px 10px; padding: 5px;
    font-size: 11px; color: #555; border-radius: 5px;
}
.heir-btn-grid {
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; padding: 10px;
}
.heir-action-btn {
    padding: 8px; border: 1px solid #ffb7c5; background: #fff; color: #e67e93; 
    border-radius: 5px; cursor: pointer; font-size: 12px;
}
.heir-action-btn:hover { background: #fff0f5; }

/* è·¨å¹´å¤§æŒ‰é’® */
.next-year-btn {
    grid-column: span 3;
    background: #ff9a9e; color: white; border: none; font-weight: bold;
    margin-top: 5px;
}

/* ================= ğŸŒ¸ ä¸œå®«ä¿®å¤è¡¥ä¸ (å¼ºåˆ¶æ˜¾ç¤ºèƒŒæ™¯) ================= */
.heir-bg-stage {
    display: block !important;
    width: 100% !important;
    height: 200px !important;      /* ç»™è¶³é«˜åº¦ */
    min-height: 200px !important;
    flex-shrink: 0 !important;     /* ç¦æ­¢è¢«æŒ¤å‹ */
    background-size: cover !important;
    background-position: center !important;
    background-color: #e0e0e0;     /* æ²¡å›¾æ—¶çš„åº•è‰² */
    position: relative !important;
    z-index: 5 !important;
    border-bottom: 3px solid #ffd1dc;
}

/* æ¢å­£æŒ‰é’® */
.season-toggle-btn {
    position: absolute !important; top: 15px; right: 50px; z-index: 100;
    background: rgba(255,255,255,0.9); border: 2px solid #d4af37; color: #d4af37;
    padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* éšè—æ—§çš„å°çƒç›¸å…³æ ·å¼ (é˜²æ­¢å¹²æ‰°) */
.heir-ball-wrapper, .heir-ball { display: none !important; }

/* ================= ğŸ§  çš‡å—£ç³»ç»Ÿ 2.0 ä¸“å±æ ·å¼ ================= */

/* èŠå¤©æ°”æ³¡åŠ¨ç”» */
@keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

/* å±æ€§æ¡å®¹å™¨ */
.heir-stat-row { display: flex; align-items: center; font-size: 12px; margin-bottom: 6px; color: #555; }
.heir-stat-label { width: 32px; font-weight: bold; text-align: right; margin-right: 5px; }
.heir-stat-track { flex: 1; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }
.heir-stat-bar { height: 100%; border-radius: 4px; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
.heir-stat-num { width: 28px; text-align: right; font-family: monospace; opacity: 0.7; }

/* èŠå¤©åŒºåŸŸ */
.heir-chat-container {
    flex: 1; overflow-y: auto; padding: 15px; 
    background-color: #f7f9fc;
    display: flex; flex-direction: column; gap: 12px;
    scroll-behavior: smooth;
}

/* æ¶ˆæ¯æ°”æ³¡ */
.heir-msg {
    max-width: 80%; padding: 10px 14px; border-radius: 15px;
    font-size: 13px; line-height: 1.5; position: relative;
    animation: popIn 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.heir-msg.ai { align-self: flex-start; background: #fff; border-bottom-left-radius: 2px; color: #444; }
.heir-msg.user { align-self: flex-end; background: #a29bfe; color: white; border-bottom-right-radius: 2px; }

/* åº•éƒ¨è¾“å…¥åŒº */
.heir-input-area {
    padding: 10px; background: #fff; border-top: 1px solid #eee;
    display: flex; flex-direction: column; gap: 8px;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.03);
}
.heir-input-row { display: flex; gap: 8px; }
.heir-input-box {
    flex: 1; padding: 10px 15px; border: 2px solid #eee; border-radius: 20px;
    font-size: 14px; outline: none; transition: 0.3s;
}
.heir-input-box:focus { border-color: #a29bfe; background: #fdfdfd; }
.heir-send-btn {
    background: #a29bfe; color: white; border: none; padding: 0 20px;
    border-radius: 20px; font-weight: bold; cursor: pointer;
    box-shadow: 0 4px 10px rgba(162, 155, 254, 0.3); transition: 0.2s;
}
.heir-send-btn:active { transform: scale(0.95); }

/* åŠŸèƒ½æŒ‰é’®è¡Œ */
.heir-func-row { display: flex; justify-content: space-between; padding: 0 5px; }
.heir-func-btn {
    background: none; border: 1px dashed #ccc; color: #888;
    padding: 4px 10px; border-radius: 15px; font-size: 11px; cursor: pointer;
}
.heir-func-btn:hover { border-color: #a29bfe; color: #a29bfe; }

/* ================= ğŸ—ºï¸ åœ°å›¾ & å›å¿†å½•æ ·å¼ ================= */

/* åœ°å›¾å¼¹çª—å®¹å™¨ */
.map-modal-body {
    display: flex; flex-direction: column; height: 100%; background: #fffbf0;
}

/* åœ°å›¾ä¸ŠåŠéƒ¨åˆ† */
.map-header {
    height: 180px; background-size: cover; background-position: center;
    position: relative; border-bottom: 3px solid #d4af37;
    flex-shrink: 0;
}
.map-title-badge {
    position: absolute; top: 10px; left: 10px; 
    background: rgba(0,0,0,0.6); color: #d4af37; 
    padding: 5px 12px; border-radius: 20px; font-weight: bold; border: 1px solid #d4af37;
}

/* åœ°ç‚¹ç½‘æ ¼ */
.map-grid {
    flex: 1; overflow-y: auto; padding: 15px; 
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
    align-content: start;
}
.location-card {
    background: #fff; border: 1px solid #e0d0b0; border-radius: 8px;
    padding: 10px 5px; text-align: center; font-size: 12px; cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s;
    display: flex; flex-direction: column; align-items: center; gap: 5px;
}
.location-card:hover { transform: translateY(-2px); border-color: #d4af37; background: #fff7d1; }

/* ğŸï¸ æ™¯ç‚¹å¯¹è¯æ¨¡å¼ */
.travel-chat-view {
    display: flex; flex-direction: column; height: 100%; background: #fff;
}
.travel-scene-area {
    height: 200px; position: relative; 
    background-size: cover; background-position: center;
    display: flex; align-items: flex-end; justify-content: center;
}
/* æ—…æ¸¸æ—¶çš„å°äºº */
.travel-avatar {
    height: 140px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.8));
    transition: transform 0.3s;
}
.travel-chat-box {
    flex: 1; overflow-y: auto; padding: 15px; background: rgba(255,255,255,0.9);
}
.travel-controls {
    padding: 10px; background: #fff; border-top: 1px solid #eee;
    display: flex; gap: 10px;
}

/* ğŸ“– å›å¿†å½•åˆ—è¡¨ */
.memory-list {
    padding: 20px; overflow-y: auto; height: 100%; background: #fffaf0;
}
.memory-item {
    position: relative; padding-left: 20px; margin-bottom: 20px; border-left: 2px solid #ffb7c5;
}
.memory-item::before {
    content: 'ğŸŒ¸'; position: absolute; left: -9px; top: 0; background: #fffaf0;
}
.memory-content {
    background: #fff; padding: 10px; border-radius: 8px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 13px; line-height: 1.6; color: #555;
}

/* ================= ğŸ“± æ‰‹æœº & çŠ¶æ€é¢æ¿æ ·å¼ ================= */

/* åˆ‡æ¢æŒ‰é’® */
.switch-btn {
    font-size: 10px; background: #fff; border: 1px solid #ddd;
    border-radius: 10px; padding: 2px 8px; cursor: pointer; color: #888;
    margin-bottom: 5px; display: inline-block;
}
.switch-btn.active { background: #a29bfe; color: white; border-color: #a29bfe; }

/* èº«ä½“æ¡£æ¡ˆé¢æ¿ */
.info-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; color: #555;
    background: #fdfdfd; padding: 5px; border-radius: 5px;
}
.info-item { border-bottom: 1px dashed #eee; padding-bottom: 2px; }
.info-label { color: #999; margin-right: 5px; }
.status-tag { padding: 1px 4px; border-radius: 4px; color: white; font-size: 10px; }
.status-good { background: #00b894; }
.status-bad { background: #d63031; }
.status-warn { background: #fdcb6e; }

/* ================= ğŸ“± æ‰‹æœºç³»ç»Ÿ (æœ€ç»ˆç¾åŒ–Â·ç™½èº«ç²‰æ¡†ç‰ˆ) ================= */

/* 1. æ‰‹æœºå¤–å£³ï¼šçº¯ç™½æœºèº« + å°‘å¥³ç²‰è¾¹æ¡† */
.iphone-modal {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 340px; height: 660px; /* ç¨å¾®åŠ é•¿ä¸€ç‚¹ï¼Œè§†é‡æ›´å¥½ */
    background: #ffffff; /* çº¯ç™½æœºèº« */
    border: 6px solid #ffb7c5; /* ğŸ’– å¯çˆ±çš„ç²‰è‰²è¾¹æ¡† */
    border-radius: 40px;
    box-shadow: 
        0 0 0 2px #fff inset, /* å†…å‘å…‰ */
        0 20px 50px rgba(255, 183, 197, 0.4); /* ç²‰è‰²å…‰æ™•æŠ•å½± */
    z-index: 10000; display: none; flex-direction: column; overflow: hidden;
    font-family: sans-serif;
    animation: popUp 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}
@keyframes popUp { from {transform: translate(-50%, 0) scale(0.9); opacity: 0;} to {transform: translate(-50%, -50%) scale(1); opacity: 1;} }

/* 2. é¢å¤´ä¸ä¸‹å·´ */
.iphone-chin-top { height: 35px; background: #fff; flex-shrink: 0; position: relative; border-bottom: 1px solid #f5f5f5; }
.iphone-camera { 
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 60px; height: 12px; background: #eee; border-radius: 20px; 
}
.iphone-chin-bottom { height: 55px; background: #fff; flex-shrink: 0; display: flex; justify-content: center; align-items: center; border-top: 1px solid #f5f5f5; }
.iphone-home-btn {
    width: 45px; height: 45px; border-radius: 50%; 
    background: #fff; border: 3px solid #ffb7c5; /* ç²‰è‰²Homeé”®ç¯ */
    box-shadow: inset 0 0 5px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s;
}
.iphone-home-btn:active { transform: scale(0.9); background: #f0f0f0; }

/* 3. å±å¹•åŒºåŸŸ */
.iphone-screen {
    flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column;
    /* æ¸…æ–°å£çº¸ï¼ŒåŠ ä¸€ç‚¹æ¨¡ç³Šé®ç½©è®©å›¾æ ‡æ›´æ¸…æ™° */
    background: url('https://files.catbox.moe/gsn7fd.png') center/cover;
}
.iphone-screen::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.3); pointer-events: none;
}

.iphone-statusbar {
    height: 24px; padding: 0 15px; display: flex; justify-content: space-between; align-items: center;
    font-size: 11px; font-weight: bold; color: #555; z-index: 5;
    background: rgba(255,255,255,0.6); backdrop-filter: blur(5px);
}

/* 4. APP å›¾æ ‡ç½‘æ ¼ (å¯çˆ±é£) */
.app-grid {
    padding: 30px 20px; display: grid; grid-template-columns: repeat(4, 1fr); 
    gap: 20px 10px; align-content: start; flex: 1; z-index: 5;
}
/* å›¾æ ‡å¤–å£³ */
.app-icon-wrapper {
    display: flex; flex-direction: column; align-items: center; cursor: pointer;
    transition: transform 0.2s;
}
.app-icon-wrapper:hover { transform: translateY(-3px); }
.app-icon-wrapper:active { transform: scale(0.95); }

/* å›¾æ ‡æœ¬ä½“ */
.app-icon {
    width: 52px; height: 52px; border-radius: 14px; 
    display: flex; align-items: center; justify-content: center;
    font-size: 26px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    position: relative; overflow: hidden;
    border: 2px solid #fff;
}
/* ç»™å›¾æ ‡åŠ é«˜å…‰ */
.app-icon::after {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%;
    background: linear-gradient(to bottom, rgba(255,255,255,0.4), transparent);
    pointer-events: none;
}
.app-name { 
    font-size: 11px; color: #333; margin-top: 6px; font-weight: bold; 
    text-shadow: 0 1px 1px #fff;
}

/* 5. APP å†…éƒ¨çª—å£ (å…¨å±è¦†ç›–) */
.app-window {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #f7f9fc; /* APPå†…éƒ¨æ·¡ç°èƒŒæ™¯ */
    transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    z-index: 20; display: flex; flex-direction: column;
}
.app-window.open { transform: translateY(0); }

/* å¤´éƒ¨å¯¼èˆªæ  (ä¸¤ç«¯å¯¹é½ä¿®å¤ç‰ˆ) */
.app-header {
    height: 50px; background: rgba(255,255,255,0.95); 
    border-bottom: 1px solid #ffe6eb;
    display: flex; align-items: center; justify-content: space-between; /* ğŸ‘ˆ ä¿®å¤ï¼šä¸¤ç«¯å¯¹é½ */
    padding: 0 10px; font-weight: bold; font-size: 15px; color: #d66a80;
    box-shadow: 0 2px 10px rgba(0,0,0,0.02); z-index: 10;
}
.app-header-btn {
    font-size: 20px; cursor: pointer; color: #ff8fa3; background:none; border:none; padding: 5px;
    min-width: 40px; /* ä¿è¯æŒ‰é’®å¥½ç‚¹ */
}

/* å†…å®¹åŒºåŸŸ */
.app-content { flex: 1; overflow-y: auto; padding: 12px; }

/* 6. å¡ç‰‡é€šç”¨æ ·å¼ (é”¦è¡£é˜/å•†åº—/å¾®èŠ/å§»ç¼˜ç°¿) */
.clothing-card, .shop-item, .partner-card, .chat-list-item {
    background: #fff; border-radius: 12px; 
    padding: 10px; margin-bottom: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    border: 1px solid #fff0f5;
    transition: all 0.2s;
}
.clothing-card:hover, .shop-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }

/* é”¦è¡£é˜å›¾ç‰‡ */
.clothing-img { width: 100%; height: 100px; object-fit: contain; margin: 5px 0; }
.clothing-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* èŠå¤©æ°”æ³¡ (ç¾åŒ–ç‰ˆ) */
.phone-chat-box { background: #f2f2f2; padding: 15px; display: flex; flex-direction: column; gap: 10px; flex: 1; overflow-y: auto; }
.phone-msg { max-width: 78%; padding: 10px 14px; border-radius: 18px; font-size: 13px; line-height: 1.4; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.phone-msg.left { align-self: flex-start; background: #fff; color: #333; border-bottom-left-radius: 4px; }
.phone-msg.right { align-self: flex-end; background: #ff9a9e; color: white; border-bottom-right-radius: 4px; }

/* æŒ‰é’®ç¾åŒ– */
.shop-btn {
    padding: 6px 12px; border-radius: 15px; font-size: 11px; border: none; 
    color: white; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* ç‰©å“è¯¦æƒ…å¼¹çª— */
.item-detail-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255,255,255,0.98); z-index: 50;
    display: flex; flex-direction: column; padding: 25px; box-sizing: border-box;
    transform: translateY(100%); transition: transform 0.3s;
}
.item-detail-overlay.show { transform: translateY(0); }
.item-big-icon { font-size: 70px; text-align: center; margin: 30px 0; animation: float 3s infinite ease-in-out; }
@keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }

/* ğŸ”§ å¾®ä¿¡å›¾ç‰‡ä¿®å¤è¡¥ä¸ */
.chat-list-item img {
    width: 45px !important;    /* å¼ºåˆ¶å®½åº¦ */
    height: 45px !important;   /* å¼ºåˆ¶é«˜åº¦ */
    border-radius: 8px !important;
    object-fit: cover !important; /* è£å‰ªä¸ç•™ç™½ */
    flex-shrink: 0 !important;    /* ç¦æ­¢è¢«æŒ¤å‹ */
    margin-right: 10px !important;
    display: block !important;
}

/* ä¿®å¤åˆ—è¡¨å¸ƒå±€ï¼Œé˜²æ­¢æ–‡å­—è¢«æŒ¤ä¸‹å» */
.chat-list-item {
    display: flex !important;
    align-items: center !important;
    flex-direction: row !important; /* å¼ºåˆ¶æ¨ªå‘æ’åˆ— */
}

/* ğŸ”§ å§»ç¼˜ç°¿å¤´åƒå¼ºåˆ¶ä¿®å¤è¡¥ä¸ */
.partner-avatar {
    width: 50px !important;     /* å¼ºåˆ¶é™åˆ¶å®½åº¦ */
    height: 50px !important;    /* å¼ºåˆ¶é™åˆ¶é«˜åº¦ */
    border-radius: 50% !important; /* å˜æˆåœ†å½¢ */
    object-fit: cover !important;  /* è‡ªåŠ¨è£å‰ªï¼Œé˜²æ­¢å˜å½¢ */
    flex-shrink: 0 !important;     /* ç¦æ­¢è¢«æŒ¤å‹ */
    margin-right: 10px !important; /* å’Œæ–‡å­—ä¿æŒè·ç¦» */
    border: 2px solid #ff7675 !important; /* åŠ ä¸ªç²‰è‰²è¾¹æ¡†æ›´å¥½çœ‹ */
    display: block !important;
}

/* ç¡®ä¿å¡ç‰‡å¤´éƒ¨æ¨ªå‘æ’åˆ— */
.partner-header {
    display: flex !important;
    align-items: center !important;
    flex-direction: row !important;
}

/* ================= ğŸ“ 4.0 æ–°å¢æ ·å¼ï¼šèŒä¸šä¸å®¶æ— ================= */

/* èŒä¸šå¾½ç«  */
.career-badge {
    background: linear-gradient(135deg, #2c3e50, #4ca1af);
    color: white; padding: 2px 8px; border-radius: 4px;
    font-size: 11px; margin-left: 5px; font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2); vertical-align: middle;
}
/* åèŒä¸šç”¨çº¢è‰² */
.career-badge.bad { background: linear-gradient(135deg, #cb2d3e, #ef473a); }
/* çš‡æƒèŒä¸šç”¨é‡‘è‰² */
.career-badge.royal { background: linear-gradient(135deg, #ffd700, #fdb931); color: #8a6d3b; }

/* æ‹çˆ±çŠ¶æ€æ ‡ */
.love-status-tag {
    background: #ff9a9e; color: white; border-radius: 10px;
    padding: 2px 8px; font-size: 10px; margin-left: 5px;
    animation: pulse 2s infinite;
}

/* å®¶æ—åˆ—è¡¨ (æ‰‹æœºå¾®èŠé‡Œç”¨) */
.family-separator {
    font-size: 10px; color: #999; margin: 10px 0 5px 10px; font-weight: bold;
}

/* ================= ğŸ“ æ–°å¢ï¼šèŒä¸šä¸å®¶æ—å¾½ç« æ ·å¼ ================= */
.career-badge {
    background: linear-gradient(135deg, #2c3e50, #4ca1af);
    color: white; padding: 2px 8px; border-radius: 4px;
    font-size: 11px; margin-left: 5px; font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2); vertical-align: middle;
}
/* åèŒä¸šç”¨çº¢è‰²ï¼Œçš‡æƒç”¨é‡‘è‰² */
.career-badge.bad { background: linear-gradient(135deg, #cb2d3e, #ef473a); }
.career-badge.royal { background: linear-gradient(135deg, #ffd700, #fdb931); color: #8a6d3b; }

/* æ‹çˆ±çŠ¶æ€ */
.love-status-tag {
    background: #ff9a9e; color: white; border-radius: 10px;
    padding: 2px 8px; font-size: 10px; margin-left: 5px;
    animation: pulse 2s infinite;
}

/* ================= â¤ï¸ æ‹çˆ±ç³»ç»Ÿ 2.0 æ ·å¼ ================= */

/* æ‹çˆ±è¿›åº¦æ¡å®¹å™¨ */
.love-progress-box {
    background: #fff0f5; padding: 10px; border-radius: 12px; margin-bottom: 10px;
    border: 1px solid #ffb7c5;
}
.love-bar-bg {
    height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 5px;
    position: relative;
}
.love-bar-fill {
    height: 100%; background: linear-gradient(90deg, #ff9a9e, #f687b3);
    transition: width 0.5s ease;
}
/* çŠ¶æ€æ–‡å­— */
.love-status-text {
    font-size: 12px; font-weight: bold; color: #d66a80; display: flex; justify-content: space-between;
}

/* æ‹çˆ±æ—¥å¿—åŒºåŸŸ */
.love-log-area {
    flex: 1; overflow-y: auto; background: #fff; border-radius: 10px;
    padding: 10px; margin-bottom: 10px; border: 1px solid #f0f0f0;
    font-size: 12px; line-height: 1.5; color: #555;
    min-height: 150px;
}
.love-log-item {
    margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #eee;
}
.love-log-date { color: #999; font-size: 10px; margin-bottom: 2px; }

/* è¯¦æƒ…é¡µå¤´éƒ¨ */
.partner-detail-header {
    text-align: center; padding: 15px; background: #fff;
    border-bottom: 1px dashed #eee; margin-bottom: 10px;
}
.partner-big-avatar {
    width: 70px; height: 70px; border-radius: 50%; border: 3px solid #ffb7c5;
    object-fit: cover; margin-bottom: 5px;
}

/* ================= ğŸ“ 5.0 æˆäººç¤¼ & ç»“ç®—ç•Œé¢æ ·å¼ ================= */

/* æˆäººç¤¼å…¨å±å¼¹çª— */
.adult-modal {
    background: linear-gradient(135deg, #fffbf0 0%, #fff 100%);
    border: 4px double #d4af37;
    width: 95%; max-width: 500px; height: 90vh; /* ç¨å¾®å¤§ä¸€ç‚¹ */
    display: flex; flex-direction: column; padding: 0;
    overflow: hidden; position: relative;
}

/* é¡¶éƒ¨æ ‡é¢˜ */
.adult-header {
    background: #d4af37; color: white; padding: 15px; text-align: center;
    font-size: 20px; font-weight: bold; letter-spacing: 2px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

/* æ ¸å¿ƒå†…å®¹åŒº */
.adult-content {
    flex: 1; overflow-y: auto; padding: 20px;
}

/* 1. èŒä¸šå±•ç¤ºå¡ */
.career-card-large {
    text-align: center; margin-bottom: 20px;
    animation: zoomIn 0.8s ease;
}
.career-icon-big { font-size: 60px; margin-bottom: 10px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); }
.career-title-big { font-size: 28px; font-weight: bold; color: #333; margin-bottom: 5px; }
.career-desc { color: #888; font-size: 12px; font-style: italic; }

/* 2. å±æ€§åˆ¤å®šå¯è§†åŒ– (æ¡å½¢å¯¹æ¯”) */
.judge-box {
    background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 15px;
    margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
}
.judge-title { font-size: 13px; font-weight: bold; color: #555; margin-bottom: 10px; border-left: 3px solid #d4af37; padding-left: 8px; }
.judge-row {
    display: flex; align-items: center; margin-bottom: 8px; font-size: 12px;
}
.judge-label { width: 40px; color: #666; }
.judge-track { flex: 1; height: 8px; background: #eee; border-radius: 4px; margin: 0 10px; position: relative; }
.judge-bar { height: 100%; border-radius: 4px; background: #ccc; transition: width 1s; }
.judge-bar.pass { background: #00b894; } /* è¾¾æ ‡ç»¿ */
.judge-bar.fail { background: #ff7675; } /* æœªè¾¾æ ‡çº¢ */

/* è¾¾æ ‡çº¿ (Indicator) */
.judge-line {
    position: absolute; top: -2px; bottom: -2px; width: 2px; background: #333;
    z-index: 5;
}
.judge-val { width: 50px; text-align: right; font-family: monospace; }
.pass-icon { color: #00b894; font-weight: bold; margin-left: 5px; }

/* 3. æˆå°±å¢™ */
.achievement-grid {
    display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px;
}
.ach-badge {
    background: #fff0f5; color: #d66a80; border: 1px solid #ffb7c5;
    padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold;
    display: flex; align-items: center; gap: 4px;
    animation: popIn 0.5s ease backwards;
}

/* 4. AI ç¦»åˆ«ä¿¡ */
.farewell-letter {
    background: #fff; padding: 15px; border-radius: 5px;
    font-family: serif; color: #555; line-height: 1.8; font-size: 14px;
    border: 1px dashed #ccc; position: relative; margin-top: 10px;
}
.farewell-letter::before { content: 'â'; font-size: 30px; color: #eee; position: absolute; top: -10px; left: 10px; }

/* ================= ğŸª¶ å†™å¡å™¨æ ·å¼ ================= */
.card-textarea {
    width: 100%; height: 400px; 
    padding: 15px; border: 1px solid #ddd; border-radius: 10px; 
    font-family: monospace; line-height: 1.5; resize: none;
    background: #fafafa; outline: none;
}
.card-textarea:focus { border-color: #a29bfe; background: #fff; }

.card-tab {
    flex: 1; padding: 8px; border: 1px solid #eee; background: #f9f9f9; color: #666;
    cursor: pointer; border-radius: 8px; font-size: 12px;
}
.card-tab.active {
    background: #6c5ce7; color: white; border-color: #6c5ce7; font-weight: bold;
}
.card-tab-content { display: none; height: 100%; }
.card-tab-content.active { display: block; }

/* ================= ğŸ› ï¸ é«˜çº§å†™å¡å™¨æ ·å¼ ================= */

/* ä»£ç è¾“å…¥æ¡† */
.code-input {
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 13px;
    background: #282c34;
    color: #abb2bf;
    border: 1px solid #3e4451;
    border-radius: 5px;
    padding: 10px;
    width: 100%;
    resize: vertical;
    outline: none;
}
.code-input:focus { border-color: #61afef; }

/* æ­£åˆ™åˆ—è¡¨é¡¹ */
.regex-item {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-left: 4px solid #6c5ce7;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    position: relative;
    font-family: monospace;
    font-size: 12px;
}
.regex-tag {
    background: #eee; padding: 2px 6px; border-radius: 4px; color: #555; margin-right: 5px;
}
.regex-pattern { color: #e06c75; font-weight: bold; } /* çº¢è‰²æ­£åˆ™ */
.regex-arrow { color: #98c379; font-weight: bold; margin: 0 5px; } /* ç»¿è‰²ç®­å¤´ */
.regex-replace { color: #61afef; } /* è“è‰²æ›¿æ¢æ–‡æœ¬ */

/* é¡¶éƒ¨ Tab å‡çº§ */
.card-tab {
    background: #f0f0f0; border: none; padding: 10px; flex: 1; font-weight: bold; color: #888;
    transition: 0.2s; border-bottom: 3px solid transparent;
}
.card-tab.active {
    background: #fff; color: #6c5ce7; border-bottom: 3px solid #6c5ce7;
}

/* AI è„‘æ´åŒºåŠ å¼º */
.ai-prompt-box {
    background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
    border: 1px solid #d1d1d1;
    padding: 10px;
    border-radius: 10px;
}

/* ================= ğŸ“± æ‰‹æœºç«¯å†™å¡å™¨é˜²çˆ†ç‰ˆ ================= */
@media screen and (max-width: 768px) {
    
    /* 1. å¼ºåˆ¶æ‰€æœ‰å…ƒç´ ä½¿ç”¨â€œè¾¹æ¡†ç›’å­â€æ¨¡å‹ (æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢å†…è¾¹è·æ’‘å¤§å®½åº¦) */
    #cardCreatorModal * {
        box-sizing: border-box !important;
    }

    /* 2. å¼¹çª—å®¹å™¨å¼ºåˆ¶å…¨å±ï¼Œæ— è¾¹è· */
    #cardCreatorModal .modal {
        width: 100% !important;
        height: 100% !important;
        max-width: 100vw !important; /* é”æ­»æœ€å¤§å®½åº¦ä¸ºå±å¹•å®½ */
        margin: 0 !important;
        border-radius: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important; /* ç¦æ­¢æ•´ä½“æ»šåŠ¨ï¼Œåªè®©å†…éƒ¨æ»š */
    }

    /* 3. æ ¸å¿ƒæ»šåŠ¨åŒºï¼šå‚ç›´æ’åˆ—ï¼Œç¦æ­¢æ¨ªå‘æº¢å‡º */
    #cardCreatorModal .modal > div:nth-child(2) {
        display: flex !important;
        flex-direction: column !important;
        flex: 1 !important;
        overflow-y: auto !important; /* å¼€å¯ä¸Šä¸‹æ»šåŠ¨ */
        overflow-x: hidden !important; /* âŒ å½»åº•æ€ç­æ¨ªå‘æ»šåŠ¨ */
        padding: 15px !important;
        width: 100% !important;
    }

    /* 4. å·¦å³ä¸¤å¤§å— (å·¦ä¾§ä¿¡æ¯/å³ä¾§ç¼–è¾‘) ç»Ÿç»Ÿå æ»¡ä¸€è¡Œ */
    #cardCreatorModal .modal > div:nth-child(2) > div {
        width: 100% !important;
        min-width: 0 !important; /* æ¸…é™¤æœ€å°å®½åº¦é™åˆ¶ */
        max-width: 100% !important;
        flex: none !important; /* ç¦æ­¢ä¼¸ç¼© */
        margin: 0 0 20px 0 !important;
        padding: 0 !important;
        border: none !important;
        background: transparent !important;
    }

    /* 5. ä¿®å¤è¾“å…¥æ¡† (Textarea) è¶…å‡ºå±å¹•çš„é—®é¢˜ */
    .card-textarea {
        width: 100% !important; /* å¼ºåˆ¶å æ»¡çˆ¶å®¹å™¨ */
        max-width: 100% !important;
        min-width: 0 !important;
        height: 300px !important;
        margin: 0 !important;
        border-radius: 8px !important;
    }

    /* 6. ä¿®å¤ Tab æŒ‰é’®æ  (é˜²æ­¢æŒ‰é’®å¤ªå®½æ’‘å¼€) */
    /* æ‰¾åˆ°åŒ…å« Tab æŒ‰é’®çš„é‚£ä¸ªå®¹å™¨ */
    #cardCreatorModal .modal > div:nth-child(2) > div:last-child > div:first-child {
        display: flex !important;
        flex-wrap: wrap !important; /* å…è®¸æ¢è¡Œï¼Œé˜²æ­¢æŒ¤å‡ºå» */
        gap: 5px !important;
    }
    
    .card-tab {
        flex: 1 1 40% !important; /* è®©æŒ‰é’®å¹³åˆ†å®½åº¦ï¼Œä¸€è¡Œæ”¾ä¸ä¸‹å°±è‡ªåŠ¨å˜ä¸¤è¡Œ */
        font-size: 12px !important;
        padding: 8px 2px !important;
        text-align: center !important;
        white-space: normal !important; /* å…è®¸æ–‡å­—æ¢è¡Œ */
    }

    /* 7. é¡¶éƒ¨æ ‡é¢˜æ å¾®è°ƒ */
    #cardCreatorModal .modal > div:first-child {
        padding: 10px !important;
        flex-wrap: wrap !important;
    }
    #cardCreatorModal .modal > div:first-child > div {
        margin-bottom: 5px !important;
    }
}

/* ================= ğŸ§ª 5.0 æ­£åˆ™å®éªŒå®¤ & è¯´æ˜ä¹¦æ ·å¼ ================= */

/* å®éªŒå®¤å®¹å™¨ */
.regex-playground {
    margin-top: 20px;
    padding: 15px;
    background: #2d2d2d; /* æ·±è‰²èƒŒæ™¯ï¼Œæ˜¾ä¸“ä¸š */
    border-radius: 10px;
    border: 1px solid #444;
    color: #fff;
}
.playground-title {
    font-size: 12px; color: #fab1a0; font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between;
}

/* æµ‹è¯•è¾“å…¥/è¾“å‡º */
.test-box {
    width: 100%; box-sizing: border-box;
    background: #1e1e1e; border: 1px solid #555;
    color: #abb2bf; font-family: monospace; font-size: 13px;
    padding: 10px; border-radius: 5px; resize: vertical;
    min-height: 60px; outline: none; margin-bottom: 10px;
}
.test-box:focus { border-color: #6c5ce7; }

/* é¢„è§ˆç»“æœåŒº */
.preview-result {
    background: #1e1e1e; border: 1px dashed #00b894;
    padding: 10px; border-radius: 5px; min-height: 40px;
    color: #00b894; font-family: monospace; white-space: pre-wrap;
    font-weight: bold;
}

/* ğŸ“˜ è¯´æ˜ä¹¦å¼¹çª— */
.guide-modal {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 85%; max-width: 500px; max-height: 80vh;
    background: #fff; border-radius: 20px; z-index: 12000;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    display: none; flex-direction: column; overflow: hidden;
    animation: popIn 0.3s ease;
}
.guide-modal.active { display: flex; }
.guide-content { padding: 20px; overflow-y: auto; font-size: 14px; line-height: 1.6; color: #555; }
.guide-content h3 { color: #6c5ce7; margin-top: 20px; margin-bottom: 10px; font-size: 16px; }
.guide-content code { background: #f0f0f0; padding: 2px 5px; border-radius: 4px; color: #d63031; font-family: monospace; }

/* ================= ğŸ“˜ è¯´æ˜ä¹¦ç¾åŒ–æ ·å¼ ================= */
.guide-content h3 {
    border-left: 4px solid #6c5ce7;
    padding-left: 10px;
    background: #f4f4f9;
    padding-top: 5px;
    padding-bottom: 5px;
    border-radius: 0 5px 5px 0;
    margin-top: 25px;
}
.guide-tip {
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    color: #0d47a1;
    padding: 10px;
    border-radius: 8px;
    font-size: 12px;
    margin: 10px 0;
}
.guide-example {
    background: #2d2d2d;
    color: #ccc;
    padding: 10px;
    border-radius: 6px;
    font-family: monospace;
    font-size: 12px;
    margin: 5px 0;
    white-space: pre-wrap;
}
.guide-keyword { color: #ff7675; font-weight: bold; }
.guide-hl { color: #74b9ff; }

/* ================= ğŸ§™â€â™‚ï¸ å‚»ç“œå¼å†™å¡å™¨æ ·å¼ ================= */

/* 1. æ ‡ç­¾é€‰æ‹©åŒº */
.wizard-box {
    background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 15px;
}
.tag-group-title { font-size: 12px; font-weight: bold; color: #888; margin-bottom: 5px; }
.tag-select-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
.wizard-tag {
    font-size: 11px; padding: 4px 10px; border-radius: 20px; border: 1px solid #ddd;
    cursor: pointer; background: #fff; color: #555; transition: 0.2s; user-select: none;
}
.wizard-tag.selected {
    background: #6c5ce7; color: white; border-color: #6c5ce7; box-shadow: 0 2px 5px rgba(108, 92, 231, 0.3);
}

/* 2. ç§¯æœ¨å¼æ­£åˆ™æ„å»ºå™¨ */
.visual-regex-row {
    display: flex; align-items: center; gap: 5px; background: #f8f9fa;
    padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 10px;
}
.visual-select {
    padding: 5px; border-radius: 5px; border: 1px solid #ddd; font-size: 12px;
}
.visual-input {
    flex: 1; padding: 5px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; outline: none;
}
.visual-arrow { color: #aaa; font-weight: bold; }

/* 3. ğŸ“± å®æ—¶é¢„è§ˆæ‰‹æœºæ¡† */
.chat-preview-container {
    width: 100%; height: 200px;
    background: #f0f2f5; border-radius: 10px; border: 1px solid #ddd;
    display: flex; flex-direction: column; overflow: hidden; position: relative;
    margin-bottom: 15px;
}
.preview-header {
    height: 30px; background: rgba(255,255,255,0.9); border-bottom: 1px solid #eee;
    display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: #333;
}
.preview-body {
    flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
}
/* é¢„è§ˆæ°”æ³¡ */
.preview-msg {
    max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 12px; line-height: 1.4; position: relative;
}
.preview-msg.char {
    align-self: flex-start; background: #fff; border: 1px solid #eee; border-bottom-left-radius: 2px;
    display: flex; gap: 8px;
}
.preview-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; background: #eee; }

/* ================= ğŸ¨ 5.5 å‰ç«¯å¼€å‘å°ä¸“å±æ ·å¼ ================= */

/* 1. ä»£ç ç¼–è¾‘å™¨é£æ ¼ (é»‘åº•å½©å­—æ„Ÿ) */
.html-editor-area {
    background: #1e1e1e; /* VSCode æ·±è‰²åº• */
    color: #d4d4d4;
    font-family: 'Consolas', monospace;
    font-size: 13px;
    line-height: 1.5;
    border: 1px solid #3c3c3c;
    border-radius: 8px;
    padding: 15px;
    width: 100%;
    height: 200px; /* ç»™è¶³ç©ºé—´å†™ HTML */
    resize: vertical;
    outline: none;
    white-space: pre; /* ä¿ç•™ç©ºæ ¼å’Œæ¢è¡Œ */
    overflow-x: auto;
}
.html-editor-area:focus { border-color: #007acc; }

/* 2. æ¸²æŸ“é¢„è§ˆæ¡† (HTML å®æ—¶æ˜¾ç¤º) */
.render-preview-box {
    background: #0f0f0f; /* æ¨¡æ‹Ÿé…’é¦†æ·±è‰²èƒŒæ™¯ */
    color: #eee;
    padding: 20px;
    border-radius: 8px;
    border: 1px dashed #555;
    min-height: 80px;
    overflow: auto;
    font-family: sans-serif;
    margin-top: 5px;
    border-left: 4px solid #00b894;
}

/* 3. æ¨¡æ¿æŒ‰é’®ç»„ */
.snippet-group {
    display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;
    background: #f5f5f5; padding: 8px; border-radius: 8px;
}
.snippet-btn {
    background: #fff; color: #555; border: 1px solid #ddd;
    padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;
    transition: 0.2s;
}
.snippet-btn:hover { background: #6c5ce7; color: #fff; border-color: #6c5ce7; }

/* 4. ä¿®å¤æ‰‹æœºç«¯ Tab æ æ‹¥æŒ¤é—®é¢˜ */
.card-tab {
    flex: 1; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis;
    padding: 8px 2px;
}

/* ================= ğŸŒ ä¸–ç•Œä¹¦å¼€å‘å°æ ·å¼ ================= */

.world-container {
    display: flex; height: 100%; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;
}

/* å·¦ä¾§åˆ—è¡¨ */
.world-list {
    width: 200px; background: #fff; border-right: 1px solid #eee; overflow-y: auto;
}
.world-item {
    padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 12px; color: #555;
    display: flex; justify-content: space-between; align-items: center;
}
.world-item:hover { background: #f9f9f9; }
.world-item.active { background: #e0f7fa; color: #006064; font-weight: bold; border-left: 3px solid #00cec9; }

/* å³ä¾§ç¼–è¾‘åŒº */
.world-editor {
    flex: 1; padding: 15px; overflow-y: auto; background: #fafafa; display: flex; flex-direction: column;
}

/* æ ‡ç­¾æ ·å¼ */
.wi-label { font-size: 11px; font-weight: bold; color: #aaa; margin-bottom: 3px; display: block; }

/* ================= ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šå¸ƒå±€ä¸è¯´æ˜æ ·å¼ ================= */

/* 1. é’ˆå¯¹é—®é¢˜1ï¼šä¸–ç•Œä¹¦ç¼–è¾‘åŒºå¤ªå° */
.world-container { 
    height: 550px !important; /* å¼ºåˆ¶æ‹‰é«˜æ•´ä½“é«˜åº¦ */
}
.world-list { 
    width: 140px !important; /* å·¦ä¾§åˆ—è¡¨å˜çª„ï¼Œç»™å³ä¾§è…¾ç©ºé—´ */
}
.world-editor .html-editor-area {
    height: 400px !important; /* å†…å®¹ç¼–è¾‘åŒºå¤§å¹…æ‹‰é«˜ */
    font-size: 13px;
    line-height: 1.5;
}
/* ä¼˜åŒ–è¾“å…¥æ¡†æ˜¾ç¤º */
.world-editor .visual-input {
    background: #fff; 
    border: 1px solid #ccc; 
    padding: 8px; 
    font-weight: bold;
}

/* 2. é’ˆå¯¹é—®é¢˜3 & 4ï¼šæ·»åŠ è“è‰²è¯´æ˜æ¡†æ ·å¼ */
.section-intro { 
    background: #e3f2fd; 
    color: #0d47a1; 
    padding: 10px; 
    border-radius: 8px; 
    font-size: 12px; 
    margin-bottom: 15px; 
    border: 1px solid #bbdefb; 
    line-height: 1.6;
}
.input-hint {
    font-size: 10px; 
    color: #999; 
    margin-left: 5px; 
    font-weight: normal;
}

/* 3. é’ˆå¯¹é—®é¢˜2ï¼šè‡ªå®šä¹‰æ ‡ç­¾æŒ‰é’®æ ·å¼ */
.add-tag-btn { 
    border: 1px dashed #ccc; 
    background: #fff; 
    color: #888; 
    border-radius: 20px; 
    padding: 2px 10px; 
    font-size: 10px; 
    cursor: pointer; 
    float: right; /* é å³æ˜¾ç¤º */
    margin-top: -2px;
}
.add-tag-btn:hover { 
    border-color: #6c5ce7; 
    color: #6c5ce7; 
}

/* --- ğŸ”§ è¡¥ä¸ï¼šå…¨å±ç¼–è¾‘æ¨¡å¼ --- */
.fullscreen-active {
    position: fixed !important; top: 0; left: 0; 
    width: 100% !important; height: 100% !important;
    z-index: 20000; 
    padding: 50px 15px 15px 15px !important; /* é¡¶éƒ¨ç•™å‡ºæŒ‰é’®ç©ºé—´ */
    border-radius: 0 !important;
    margin: 0 !important;
}
/* å…¨å±æ—¶çš„é€€å‡ºæŒ‰é’® */
#fullscreenExitBtn {
    position: fixed; top: 10px; right: 10px; z-index: 20001;
    padding: 8px 20px; background: #ff7675; color: white; 
    border: none; border-radius: 20px; font-weight: bold;
    display: none; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
/* ç»™â€œå…¨å±â€æŒ‰é’®ä¸€ä¸ªå°å›¾æ ‡æ ·å¼ */
.zoom-btn {
    float: right; margin-top: -2px; cursor: pointer; 
    font-size: 11px; background: #fff; border: 1px solid #ddd; 
    padding: 2px 8px; border-radius: 4px; color: #666;
}

/* --- ğŸ”§ è¡¥ä¸ï¼šæ ‡ç­¾åˆ é™¤æŒ‰é’®æ ·å¼ --- */
.tag-delete-btn {
    margin-left: 6px;
    color: #ff7675; /* çº¢è‰² */
    cursor: pointer;
    font-weight: bold;
    opacity: 0.6;
    transition: opacity 0.2s;
}
.tag-delete-btn:hover { opacity: 1; transform: scale(1.2); }
.wizard-box .tag-group-title { cursor: pointer; transition: 0.2s; }
.wizard-box .tag-group-title:hover { color: #6c5ce7; }

/* --- ğŸ”§ è¡¥ä¸ï¼šè¯•ç©ä¸è¯´æ˜æ ·å¼ --- */
.code-guide-box {
    background: #e8f5e9; border: 1px solid #a5d6a7; 
    padding: 10px; margin-top: 5px; border-radius: 8px; 
    font-size: 12px; color: #2e7d32; line-height: 1.6;
    white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
}
.playtest-container {
    display: flex; flex-direction: column; height: 100%;
    background: #e3f2fd; border-radius: 8px; overflow: hidden;
    border: 1px solid #90caf9;
}
.playtest-chat {
    flex: 1; overflow-y: auto; padding: 20px;
    background-image: radial-gradient(#cbd5e0 1px, transparent 1px);
    background-size: 20px 20px;
}
/* æ¨¡æ‹Ÿé…’é¦†çš„æ°”æ³¡ */
.test-msg { margin-bottom: 15px; max-width: 85%; padding: 10px; border-radius: 10px; font-size: 14px; position: relative; }
.test-msg.user { align-self: flex-end; background: #ffe0b2; margin-left: auto; }
.test-msg.char { align-self: flex-start; background: #fff; border: 1px solid #ddd; }

/* --- ğŸ”§ è¡¥ä¸ï¼šæ‰‹æœºç«¯ä¸–ç•Œä¹¦å¸ƒå±€ä¼˜åŒ– --- */
@media screen and (max-width: 768px) {
    .world-container {
        flex-direction: column !important; /* å¼ºåˆ¶æ”¹ä¸ºä¸Šä¸‹æ’åˆ— */
        height: auto !important;
        min-height: 600px; /* ä¿è¯è¶³å¤Ÿé«˜åº¦ */
    }
    .world-list {
        width: 100% !important; /* åˆ—è¡¨å æ»¡å®½ */
        height: 120px !important; /* åˆ—è¡¨å˜çŸ­ */
        border-right: none !important;
        border-bottom: 1px solid #eee;
    }
    .world-editor {
        width: 100% !important; /* ç¼–è¾‘åŒºå æ»¡å®½ */
        height: auto !important;
        flex: 1;
    }
    /* è®©é«˜çº§è®¾ç½®æ åœ¨æ‰‹æœºä¸Šä¹Ÿè‡ªåŠ¨æ¢è¡Œï¼Œä¸æŒ¤ */
    .world-editor > div[style*="flex"] {
        flex-wrap: wrap !important;
    }
}

/* ================= ğŸ”§ å†›å¸ˆçª—å£ï¼šæœ€ç»ˆå®Œæ•´ç‰ˆ (è‡ªç”±ç¼©æ”¾ + å…¨å¥—ç¾åŒ–) ================= */

/* 1. å¤–å£³ï¼šå»æ‰é”å®šæ¯”ä¾‹ï¼Œå…è®¸è‡ªç”±æ‹‰ä¼¸ */
#aiAdvisorBox {
    position: fixed;
    bottom: 100px; left: 20px;
    z-index: 12000;

    /* ğŸ“ å°ºå¯¸è®¾ç½®ï¼šä¸å†™ aspect-ratioï¼Œå…è®¸è‡ªç”±æ‹–åŠ¨å®½é«˜ */
    width: 320px; height: 420px; 
    min-width: 260px; min-height: 300px;
    max-width: 95vw; max-height: 85vh; /* é˜²æ­¢æ’‘çˆ†å±å¹• */

    /* ğŸ”¥ å¼€å¯è‡ªç”±ç¼©æ”¾ */
    resize: both !important;
    overflow: hidden !important; 

    /* ğŸ¨ ç¾åŒ–ä¿ç•™ï¼šæµ…ç´«åº•è‰² + ç´«è‰²è¾¹æ¡† + é˜´å½± */
    background: #fff;
    border: 2px solid #6c5ce7; 
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    
    display: flex; flex-direction: column;
}

/* 2. æ ‡é¢˜æ ï¼šç´«è‰²èƒŒæ™¯ + æ‹–åŠ¨å…‰æ ‡ */
#advisorHeader {
    background: #6c5ce7 !important; 
    color: white;
    padding: 10px 15px;
    font-weight: bold;
    font-size: 14px;
    display: flex; justify-content: space-between; align-items: center;
    
    /* ğŸ”¥ æ‹–åŠ¨åŠŸèƒ½çš„å…³é”® */
    cursor: move;
    user-select: none;
    touch-action: none; 
}

/* 3. å·¥å…·æ ï¼šä¿å­˜/å®Œç»“æŒ‰é’® */
.advisor-toolbar {
    display: flex; gap: 5px; padding: 5px 10px;
    background: #f3f0ff; border-bottom: 1px solid #e0c3fc;
}
.advisor-tool-btn {
    flex: 1; padding: 4px; border-radius: 4px;
    font-size: 10px; font-weight: bold; cursor: pointer; 
    background: #fff; border: 1px solid #b39ddb; color: #673ab7;
}

/* 4. èŠå¤©åŒºï¼šæµ…ç´«æ°›å›´ */
#advisorChat {
    flex: 1; 
    overflow-y: auto; 
    padding: 10px;
    background: #fdfaff; 
    overscroll-behavior: contain; /* é˜²æ­¢æ»‘åŠ¨ç©¿é€ */
}

/* 5. æ°”æ³¡ï¼šç™½åº• + ç»†ç´«è¾¹æ¡† (ä¿ç•™ä½ æŒ‡å®šçš„æ ·å¼) */
.advisor-bubble {
    background: #fff; 
    border: 1px solid #e0c3fc; 
    border-radius: 12px; 
    padding: 12px; 
    margin-bottom: 10px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    font-size: 13px; 
    line-height: 1.5;
    color: #555;
    position: relative;
}

/* 6. äº¤äº’æŒ‰é’®ï¼šæµ…ç´«åº• + ç´«è‰²è™šçº¿è¾¹æ¡† (ä¿ç•™ä½ æŒ‡å®šçš„æ ·å¼) */
.advisor-action-btn {
    display: block; width: 100%;
    margin-top: 8px; padding: 6px;
    background: #f3e5f5; 
    color: #8e44ad;
    border: 1px dashed #9b59b6; 
    border-radius: 6px;
    cursor: pointer; 
    font-size: 12px; font-weight: bold;
    text-align: center; 
    transition: 0.2s;
}
.advisor-action-btn:hover { 
    background: #e1bee7; 
}

/* 7. åº•éƒ¨è¾“å…¥æ¡†åŒºåŸŸ */
#aiAdvisorBox input {
    font-size: 12px !important;
}

/* --- ğŸ”§ è¡¥ä¸ï¼šå¼ºåˆ¶ä¸–ç•Œä¹¦æ•°å­—æ¡†å˜çª„ --- */
#wiDepth, #wiBudget {
    width: 60px !important;      /* å¼ºåˆ¶å®½åº¦ */
    min-width: 60px !important;  /* é˜²æ­¢å‹æ‰ */
    flex: none !important;       /* ğŸ”¥ æ ¸å¿ƒï¼šç¦æ­¢è¢«çˆ¶å®¹å™¨æ‹‰é•¿ */
}

/* --- ğŸ”§ è¡¥ä¸ï¼šå†›å¸ˆæŠ˜å æ¨¡å¼ (åªå‰©æ ‡é¢˜æ ) --- */
#aiAdvisorBox.collapsed {
    height: 45px !important;       /* å¼ºåˆ¶é«˜åº¦åªå‰©æ ‡é¢˜æ  */
    min-height: 0 !important;      /* è§£é™¤æœ€å°é«˜åº¦é™åˆ¶ */
    resize: none !important;       /* æŠ˜å æ—¶ä¸å‡†æ‹‰ä¼¸ */
    overflow: hidden !important;   /* è—èµ·å¤šä½™å†…å®¹ */
}

/* æŠ˜å æ—¶ï¼Œéšè—é™¤æ ‡é¢˜æ ä»¥å¤–çš„æ‰€æœ‰å­å…ƒç´  */
#aiAdvisorBox.collapsed > *:not(#advisorHeader) {
    display: none !important;
}


    </style>

    <style id="custom-reader-style"></style> 
</head>
<body>

    <div id="dreamLayer" class="dream-layer">
        <div class="dream-close" onclick="stopDreamMode()">Ã— é†’æ¥</div>
        </div>
    <div id="lotteryOverlay" class="lottery-overlay">
        <div class="close-lottery" onclick="closeLottery()">Ã—</div>
        <div class="lottery-box-container" id="lotteryBox">
            <div class="magic-gift" id="magicGift">ğŸ</div>
            <div class="lottery-result-card" id="lotteryResult">
                <div class="lottery-img-wrapper"><img id="lotteryImg" src=""></div>
                <div class="lottery-name" id="lotteryName">???</div>
                <div class="lottery-hint">âœ¨ å‘½è¿é€‰æ‹©äº†å®ƒ âœ¨</div>
                <button class="go-btn" onclick="goToLotteryItem()">ğŸ‘‰ å°±æ˜¯ä½ äº†ï¼</button>
            </div>
        </div>
    </div>

    <div id="lockScreen">
        <div id="sakuraContainer"></div>

        <div id="view-landing" class="lock-card" style="display:none; text-align:center;">
            <div style="font-size:50px; margin-bottom:20px;">ğŸŒ¸</div>
            <div class="lock-title" style="font-size:28px;">æ¬¢è¿æ¥åˆ°ä½ çš„ç™¾å®ç®±</div>
            <div class="lock-subtitle">âœ¨ æ¯ä¸€å¤©éƒ½æ˜¯æ–°çš„å¼€å§‹ âœ¨</div>
            <button class="welcome-btn btn-login-pink" style="color:white; margin-top:30px; font-size:18px;" onclick="auth.proceedFromLanding()">âœ¨ ç«‹å³ç™»å½• âœ¨</button>
        </div>

        <div id="view-welcome" class="lock-card" style="display:none;">
            <div style="font-size:40px; margin-bottom:10px;">ğŸŒ¸</div>
            <div class="lock-title">è®¾ç½®è§£é”æ–¹å¼</div>
            <div class="lock-subtitle">ç¬¬ä¸€æ¬¡æ¥ï¼Œå…ˆç»™è‡ªå·±æŒ‘ä¸€æŠŠé’¥åŒ™å§ï¼</div>
            <button class="welcome-btn btn-gesture" onclick="auth.startSetup('gesture')">æˆ‘æ˜¯æ‰‹åŠ¿æ§ (è¿çº¿è§£é”)</button>
            <button class="welcome-btn btn-pin" onclick="auth.startSetup('pin')">æˆ‘æ˜¯æ•°å­—æ§ (PINç è§£é”)</button>
        </div>

        <div id="view-setup-question" class="lock-card" style="display:none;">
            <div class="lock-title">ğŸ” å®‰å…¨ä¿éšœ</div>
            <div class="lock-subtitle">ä¸‡ä¸€å¿˜äº†å¯†ç ï¼Œè¿™ä¸ªå¯ä»¥æ•‘ä½ ï¼</div>
            <div class="form-group" style="text-align:left;">
                <label>è®¾ç½®ä¸€ä¸ªå®‰å…¨é—®é¢˜</label>
                <input type="text" id="secQuestion" class="lock-input" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ç¬¬ä¸€åªå® ç‰©æ˜¯ï¼Ÿ">
            </div>
            <div class="form-group" style="text-align:left;">
                <label>é—®é¢˜çš„ç­”æ¡ˆ</label>
                <input type="text" id="secAnswer" class="lock-input" placeholder="è¾“å…¥ç­”æ¡ˆ">
            </div>
            <button class="welcome-btn btn-gesture" onclick="auth.saveSecurityQuestion()">å®Œæˆè®¾ç½®</button>
        </div>

        <div id="view-pin" class="lock-card" style="display:none;">
            <div class="lock-title" id="pinTitle">è¯·è¾“å…¥å¯†ç </div>
            <div class="lock-subtitle" id="pinSub">è¾“å…¥4ä½æ•°å­—å¯†ç </div>
            <div class="pin-display" id="pinDots">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>
            <div class="numpad">
                <button class="num-btn" onclick="auth.inputPin(1)">1</button>
                <button class="num-btn" onclick="auth.inputPin(2)">2</button>
                <button class="num-btn" onclick="auth.inputPin(3)">3</button>
                <button class="num-btn" onclick="auth.inputPin(4)">4</button>
                <button class="num-btn" onclick="auth.inputPin(5)">5</button>
                <button class="num-btn" onclick="auth.inputPin(6)">6</button>
                <button class="num-btn" onclick="auth.inputPin(7)">7</button>
                <button class="num-btn" onclick="auth.inputPin(8)">8</button>
                <button class="num-btn" onclick="auth.inputPin(9)">9</button>
                <div></div>
                <button class="num-btn" onclick="auth.inputPin(0)">0</button>
                <button class="num-btn" style="color:#ff6b6b" onclick="auth.clearPin()">ğŸ”™</button>
            </div>
            <div class="back-link" id="pinForgotBtn" onclick="auth.showRecovery()" style="display:none">å¿˜è®°å¯†ç ï¼Ÿ</div>
        </div>

        <div id="view-gesture" class="lock-card" style="display:none;">
            <div class="lock-title" id="gestTitle">ç»˜åˆ¶å›¾æ¡ˆ</div>
            <div class="lock-subtitle" id="gestSub">è¯·ç»˜åˆ¶ä½ çš„è§£é”å›¾æ¡ˆ</div>
            <div class="gesture-container" id="gestureArea">
                <div class="gesture-grid">
                    <div class="gesture-point"><div class="point-inner" data-idx="0"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="1"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="2"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="3"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="4"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="5"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="6"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="7"></div></div>
                    <div class="gesture-point"><div class="point-inner" data-idx="8"></div></div>
                </div>
                <canvas id="gestureCanvas" width="300" height="300"></canvas>
            </div>
            <div class="back-link" id="gestForgotBtn" onclick="auth.showRecovery()" style="display:none">å¿˜è®°å¯†ç ï¼Ÿ</div>
            <div class="back-link" id="gestResetBtn" onclick="auth.resetGesture()" style="display:none">é‡ç»˜</div>
        </div>

        <div id="view-recovery" class="lock-card" style="display:none;">
            <div class="lock-title">ğŸ˜Ÿ å¿˜è®°å¯†ç äº†ï¼Ÿ</div>
            <div class="lock-subtitle" id="recoveryQText">å›ç­”ä½ çš„å®‰å…¨é—®é¢˜</div>
            <input type="text" id="recoveryAnswer" class="lock-input" placeholder="è¾“å…¥ç­”æ¡ˆ">
            <button class="welcome-btn btn-gesture" onclick="auth.checkRecovery()">éªŒè¯</button>
            <div class="back-link" onclick="location.reload()">è¿”å›</div>
        </div>
    </div>

    <div id="toast" class="toast">æç¤ºä¿¡æ¯</div>

    <div id="appContainer">
        
        <div class="privacy-toggle-btn" id="privacyBtn" onclick="togglePrivacyMode()" title="ç‚¹å‡»å¼€å¯é˜²çª¥/æ¨¡ç³Šæ¨¡å¼">
            ğŸ‘ï¸
        </div>

       <h1 onclick="triggerCopyrightEgg()">ğŸŒ¸ æˆ‘çš„ç™¾å®ç®± ğŸŒ¸</h1>

        <div class="float-widget" id="floatWidget">
                                <div class="float-menu" id="floatMenu">
    
   <div id="menuPage1" class="menu-page" style="flex:1; overflow-y:auto;">
    <div class="music-panel">
        <div style="font-size:12px; color:#aaa; margin-bottom:5px;">ğŸ§ èƒŒæ™¯éŸ³ä¹</div>
        <div class="music-controls">
            <button class="play-btn" onclick="toggleMusic()" id="playBtn">â–¶</button>
            <input type="range" min="0" max="1" step="0.1" value="0.5" onchange="changeVolume(this)" style="width:60px; accent-color:var(--accent-color)">
        </div>
        <input type="text" style="width:100%;font-size:10px;padding:4px;border:1px solid #ddd;border-radius:5px;" id="musicLink" placeholder="è¾“å…¥mp3é“¾æ¥..." onchange="updateMusicSrc(this.value)">
        <audio id="bgMusic" loop></audio>
    </div>

<div class="tavern-portal-panel" style="margin-top:10px;">
    <button onclick="openCardCreator()" style="width:100%; background:linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); color:white; border:none; padding:10px; border-radius:20px; font-weight:bold; cursor:pointer; box-shadow:0 4px 10px rgba(142, 197, 252, 0.4);">
        ğŸª¶ é…’é¦†å†™å¡å™¨ (AIæäºº)
    </button>
</div>

    <div class="tavern-portal-panel" style="margin-top:10px; position:relative; width:100%;">
        <button id="tavernJumpBtn" style="width:100%; box-sizing: border-box; background:linear-gradient(135deg, #fff7e6 0%, #ffe7ba 100%); border:2px solid #fff; color:#fa8c16; padding:8px 15px; border-radius:20px; font-size:13px; font-weight:bold; cursor:pointer; box-shadow:0 4px 10px rgba(255, 169, 64, 0.2);" onclick="jumpToTavern()">
            ğŸº å¯åŠ¨é…’é¦†
        </button>
        <button style="position:absolute; right:2px; top:2px; height:calc(100% - 4px); width:35px; background:transparent; border:none; color:#fa8c16; cursor:pointer; opacity:0.6;" onclick="changeTavernLink()" title="ä¿®æ”¹é…’é¦†é“¾æ¥">âš™ï¸</button>
    </div>

    <div class="lottery-panel" style="display:flex; gap:5px; margin-top:10px;">
         <button class="lottery-btn" onclick="startLottery()" style="flex:1">ğŸ”® å‘½è¿æŠ‰æ‹©</button>
         <button class="lottery-btn" onclick="startDreamMode()" style="flex:1; background:linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color:white;">ğŸ«§ æ¼‚æµ®æ¢¦å¢ƒ</button>
    </div>

    <div class="lottery-panel" style="display:flex; gap:5px; margin-top:5px;">
        <button class="lottery-btn" onclick="openGachaModal()" style="flex:1; background:linear-gradient(135deg, #e0f7fa 0%, #81ecec 100%); color:#00cec9;">ğŸ² çµæ„Ÿæ‰­è›‹</button>
        <button class="lottery-btn" onclick="openEchoModal()" style="flex:1; background:linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%); color:white; border:none;">ğŸ“– çµé­‚å›å“</button>
    </div>
</div>



    <div id="menuPage2" class="menu-page" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:5px; border-bottom:1px dashed #eee; flex-shrink: 0;">
        <div style="font-size:12px; font-weight:bold; color:var(--accent-color);">ğŸ’¬ <span id="aiPersonaLabel">å°å¾·å­</span></div>
        <button onclick="openAISettings()" style="background:none; border:none; font-size:16px;">âš™ï¸</button>
    </div>
    
    <div id="aiChatBox" style="flex:1; overflow-y:auto; padding:10px 0; font-size:12px;">
        <div class="ai-msg-row ai">
            <div class="ai-bubble">çš‡ä¸Šå‰ç¥¥ï¼å¥´æ‰åœ¨è¿™å„¿å€™ç€å‘¢ï¼Œæ‚¨æœ‰ä»€ä¹ˆå©å’ï¼ŸğŸ™‡</div>
        </div>
    </div>

    <div style="display:flex; gap:5px; margin-top:5px; flex-shrink: 0;">
        <input type="text" id="aiInput" placeholder="ä¼ å”¤..." onkeydown="if(event.key==='Enter') sendAIMessage()" style="flex:1; border:1px solid #ddd; border-radius:15px; padding:5px 10px; font-size:12px;">
        <button onclick="sendAIMessage()" style="background:var(--accent-color); color:white; border:none; border-radius:15px; padding:5px 10px; font-size:12px;">ä¼ </button>
    </div>
</div>

    
    <div id="menuPage4" class="menu-page" style="display:none; flex:1; overflow-y:auto;">
        <style>
            .fun-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 5px; }
            .fun-btn { 
                background: white; border: 1px solid #ffe6eb; border-radius: 12px; padding: 10px 5px; 
                text-align: center; font-size: 12px; color: #666; cursor: pointer;
                display: flex; flex-direction: column; align-items: center; gap: 5px;
                transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            }
            .fun-btn:hover { transform: translateY(-2px); border-color: var(--accent-color); color: var(--accent-color); }
            .fun-icon { font-size: 20px; }
        </style>
        
        <div style="text-align:center; font-size:12px; color:#aaa; margin-bottom:10px;">ğŸ¡ çš‡å®¶æ¸¸ä¹åœº</div>
        
        <div class="fun-grid">

<div class="fun-btn" onclick="enterGameLobby()" style="background:linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color:white; border:none; grid-column: span 2; font-weight:bold; font-size:14px; box-shadow:0 4px 10px rgba(161, 140, 209, 0.4);">
    <span class="fun-icon" style="font-size:24px;">ğŸ®</span> 
    è¿›å…¥è”æœºå¤§å…
    <div style="font-size:10px; opacity:0.8; font-weight:normal;">(P2Pè”æœº / AIå¯¹æˆ˜)</div>
</div>

            <div class="fun-btn" onclick="openMomentsModal()"><span class="fun-icon">ğŸ“±</span>æœ‹å‹åœˆ</div>
            <div class="fun-btn" onclick="checkMailbox()"><span class="fun-icon">ğŸ“®</span>æ”¶ä¿¡ç®±</div>
            <div class="fun-btn" onclick="openTheaterModal()"><span class="fun-icon">ğŸ¬</span>å°å‰§åœº</div>
            <div class="fun-btn" onclick="generateGossipWeekly()"><span class="fun-icon">ğŸ“°</span>å…«å¦å‘¨åˆŠ</div>
            <div class="fun-btn" onclick="openBarModal()"><span class="fun-icon">ğŸ±</span>æ·±å¤œé£Ÿå ‚</div>
            <div class="fun-btn" onclick="openSoulModal()"><span class="fun-icon">ğŸ•¯ï¸</span>çµé­‚æ‹·é—®</div>
            
            <div class="fun-btn" onclick="openThroneModal()" style="background:#fffbe6; border-color:#ffeaa7;"><span class="fun-icon">âš–ï¸</span>æ‰¹æŠ˜å­</div>
            <div class="fun-btn" onclick="openFlipCardModal()" style="background:#fff0f5; border-color:#ffb7c5;"><span class="fun-icon">ğŸ®</span>ç¿»ç‰Œå­</div>
            <div class="fun-btn" onclick="openEavesdropModal()" style="background:#f0f9ff; border-color:#a2d2ff;"><span class="fun-icon">ğŸ‘‚</span>å¬å¢™è§’</div>
            <div class="fun-btn" onclick="openJealousyModal()" style="background:#fff0f0; border-color:#ffcccc;"><span class="fun-icon">ğŸ’¢</span>ä¿®ç½—åœº</div>

<div class="fun-btn" onclick="openHoroscope()" style="background:#1a1a2e; border-color:#ffd700; color:#ffd700;">
    <span class="fun-icon">ğŸŒ </span>é’¦å¤©ç›‘
</div>

        </div>
    </div>

    <div id="menuPage3" class="menu-page" style="display:none; flex:1; overflow-y:auto;">
         <div class="nav-panel" id="navPanel" style="border:none; padding:0;"></div>
    </div>

    <div class="menu-tab-bar" style="flex-shrink: 0; display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px;">
        <button class="menu-tab active" onclick="switchMenuPage(1)">âœ¨ åŠŸèƒ½</button>
        <button class="menu-tab" onclick="switchMenuPage(2)">ğŸ¤– ä¾ä»</button> 
        <button class="menu-tab" onclick="switchMenuPage(4)">ğŸ¡ æ¸¸ä¹</button>
        <button class="menu-tab" onclick="switchMenuPage(3)">ğŸ“‘ ç›®å½•</button>
    </div>
</div>


            <div class="float-btn" id="floatBtn"></div>
        </div>

              <div class="search-container" style="display:flex; align-items:center; gap:10px;">
            <div style="position:relative; flex-grow:1;">
                <input type="text" id="mainSearchInput" class="search-input" placeholder="æœç´¢åç§°æˆ–æ ‡ç­¾..." oninput="renderGrid(filterItems(this.value))">
                <span class="search-icon">ğŸ”</span>
            </div>
            
            <label style="font-size:12px; color:var(--accent-color); cursor:pointer; display:flex; align-items:center; gap:4px; white-space:nowrap;">
                <input type="checkbox" id="deepSearchCheck" onchange="handleSearch()" style="width:auto;">
                æœå†…å®¹
            </label>
        </div>


        <div class="layout-bar">
            <span class="layout-label">ğŸ‘€ è§†å›¾:</span>
            <button class="layout-btn" title="é»˜è®¤ç½‘æ ¼" onclick="switchLayout('default')">ğŸ©¶</button>
            <button class="layout-btn" title="é•¿åˆ—è¡¨" onclick="switchLayout('list')">ğŸ©µ</button>
            <button class="layout-btn" title="å¤§å›¾æ¨¡å¼" onclick="switchLayout('large')">ğŸ¤</button>
            <button class="layout-btn" title="è¿·ä½ æ¨¡å¼" onclick="switchLayout('mini')">ğŸ©·</button>
            <button class="layout-btn" title="çºªå¿µå“é™ˆåˆ—å®¤" onclick="switchLayout('shelf')">ğŸ’</button>
        </div>

<div class="action-grid">
    <div class="action-card primary" onclick="openAddModal()">
        <div class="kitty-icon">ğŸ€</div>
        <div>æ·»åŠ </div>
    </div>
    
    <div class="action-card" onclick="document.getElementById('batchImgInput').click()">
        <div class="kitty-icon">ğŸ“¸</div>
        <div>æ‰¹é‡åŠ </div>
        <input type="file" id="batchImgInput" multiple style="display:none" onchange="handleBatchImageImport(this)">
    </div>

    <div class="action-card" onclick="toggleBatchDeleteMode()">
        <div class="kitty-icon">ğŸ§¹</div>
        <div>æ‰¹é‡åˆ </div>
    </div>

    <div class="action-card" onclick="exportAllData()">
        <div class="kitty-icon">ğŸ’¾</div>
        <div>å¤‡ä»½</div>
    </div>

    <div class="action-card" onclick="document.getElementById('importAllInput').click()">
        <div class="kitty-icon">ğŸ‘œ</div>
        <div>å¯¼å…¥</div>
        <input type="file" id="importAllInput" accept=".json" onchange="importAllData(this)">
    </div>
</div>

        <div class="grid-container mode-default" id="gridContainer">
            <div class="empty-state">æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“... ğŸ’¾</div>
        </div>

<div style="text-align: center; margin-top: 50px; padding-bottom: 20px; font-size: 10px; color: #e0e0e0; font-family: sans-serif; letter-spacing: 1px; user-select: none;">
    Â© 2025 CHANGCHUNLU. All Rights Reserved. <br> 
    Designed with â¤ï¸ for My Royal Collection.
</div>

    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <button class="close-modal" onclick="closeAddModal()">Ã—</button>
            <h2 id="modalTitle">âœ¨ æ·»åŠ æ–°æ”¶è—</h2>
            <div class="form-group"><label>ğŸ’– åå­—</label><input type="text" id="itemName" placeholder="ç»™è¿™ä¸ªç›’å­èµ·ä¸ªåå­—..."></div>
            <div class="form-group"><label>ğŸ·ï¸ æ ‡ç­¾ (è¾“å…¥åç‚¹+å·æˆ–å›è½¦)</label><div style="display:flex; align-items:center; gap:10px;"><div class="tag-input-area" id="tagInputArea" style="flex-grow:1;" onclick="document.getElementById('tagInput').focus()"><input type="text" id="tagInput" onkeydown="handleTagInput(event)"></div><button class="small-btn primary-btn" style="height:40px; width:40px; border-radius:50%; display:flex; justify-content:center; align-items:center; flex-shrink:0;" onclick="manualAddTag()">ï¼‹</button>
<button class="small-btn" onclick="autoGenerateTags()" style="background:#e0f7fa; color:#006064; border:none; margin-left:5px; padding:5px 10px; border-radius:15px; font-size:12px;">ğŸ§  æ™ºèƒ½åˆ†æ</button>
</div><div id="suggestedTags" style="margin-top:5px; display:flex; gap:5px; flex-wrap:wrap;"></div></div>
                       <div class="form-group">
                <label>ğŸ’­ å°è±¡æœ€æ·±çš„è¯ (ä¸€è¡Œä¸€å¥ï¼Œä¼šé£˜åœ¨èƒŒæ™¯é‡Œå“¦)</label>
                <textarea id="itemMemories" placeholder="ä¾‹å¦‚ï¼š
ç¬¬ä¸€æ¬¡è§ä½ çš„æ—¶å€™...
é‚£å¤©æ™šä¸Šçš„æœˆäº®å¾ˆåœ†...
(æŒ‰å›è½¦æ¢è¡Œï¼Œå¯ä»¥å†™å¾ˆå¤šå¥)" style="width:100%; height:100px; padding:10px; border:2px solid var(--secondary-color); border-radius:12px; outline:none; font-family:inherit; resize:vertical; background:#fff;"></textarea>
            </div>
                     <div class="form-group">
               <label>ğŸ“¦ åŒ…å«çš„æ–‡ä»¶ä¸é“¾æ¥</label><div class="resource-list" id="resourceList"><div style="text-align:center; color:#ccc; font-size:12px; padding:20px;">æš‚æ— å†…å®¹ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </div></div><div class="add-btn-row"><label class="upload-area small-btn" style="flex-grow:1; text-align:center;">ğŸ“‚ åŠ æ–‡ä»¶ (å›¾ç‰‡/æ–‡æ¡£/å…¶ä»–)<input type="file" multiple onchange="handleUniversalSelect(this)"></label><button class="small-btn" onclick="openLinkInput()">ğŸ”— åŠ é“¾æ¥</button></div><div id="linkInputArea" style="display:none; margin-top:10px; background:#f9f9f9; padding:10px; border-radius:10px;"><input type="text" id="newLinkName" placeholder="é“¾æ¥åç§° (å¦‚: ä½œè€…ä¸»é¡µ)" style="margin-bottom:5px;"><input type="text" id="newLinkUrl" placeholder="ç½‘å€ (http://...)" style="margin-bottom:5px;"><div style="text-align:right;"><button class="small-btn" onclick="confirmAddLink()">ç¡®å®š</button><button class="small-btn" style="background:#eee; color:#666; border:none" onclick="document.getElementById('linkInputArea').style.display='none'">å–æ¶ˆ</button></div></div></div>

                <div class="form-group" style="text-align:center; margin-top:15px; border-top:1px dashed #eee; padding-top:10px;">
                    <label style="font-size:12px; color:#aaa; margin-bottom:8px;">ğŸ–¼ï¸ è£…é¥°ç›¸æ¡†</label>
                    <div style="display:flex; justify-content:center; gap:10px;">
                        <button class="small-btn" onclick="setFrame('none')" style="border:1px solid #ddd; color:#999;" title="é»˜è®¤">ğŸš«</button>
                        <button class="small-btn" onclick="setFrame('frame-lace')" style="background:#fff0f5; border:1px dashed #ffb7c5;" title="è•¾ä¸ç”œå¿ƒ">ğŸ€</button>
                        <button class="small-btn" onclick="setFrame('frame-gold')" style="background:#fffbe6; border:1px double #d4af37;" title="éé‡‘å…¸è—">âšœï¸</button>
                        <button class="small-btn" onclick="setFrame('frame-stardust')" style="background:linear-gradient(135deg,#e0c3fc,#8ec5fc); color:white; border:none;" title="æ˜Ÿå…‰æµä½“">âœ¨</button>
                        <button class="small-btn" onclick="setFrame('frame-sakura')" style="background:#ffeff2; border:1px solid #ff9a9e;" title="è½æ¨±ç”»å¢ƒ">ğŸŒ¸</button>
                    </div>
                </div>

            <div class="modal-buttons"><button onclick="closeAddModal()">å–æ¶ˆ</button><button class="primary-btn" onclick="saveItem()">ğŸ’¾ ä¿å­˜</button></div>
        </div>
    </div>

                <div class="modal-overlay" id="detailModal">
        <div class="modal" style="position: relative; max-height: 85vh; padding: 0; display: flex; flex-direction: column; overflow: hidden;"> 
            
            <div class="memory-layer" id="memoryLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none;"></div>

            <div id="bigStamp" class="big-stamp-mark"></div>

                        <div class="modal-content-wrapper" style="overflow-y: auto; flex-grow: 1; position: relative; z-index: 2; padding: 25px;">
                
                <button class="close-modal" onclick="closeDetailModal()" style="position: absolute; top: 15px; right: 15px;">Ã—</button>
                
                <div id="stickyNoteDisplay"></div> 
                <h2 id="detailName" style="text-align:center; margin-bottom:5px; margin-top: 0;"></h2>

                <div id="detailTags" style="display:flex; justify-content:center; gap:5px; margin-bottom:15px;"></div>
                
                <div class="stamp-bar">
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ¬')" title="è¶…ç”œ">ğŸ¬</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ‹')" title="åƒé†‹/é…¸æ¶©">ğŸ‹</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ”ª')" title="åˆ€å­/è™å¿ƒ">ğŸ”ª</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸš—')" title="é£™è½¦/åˆºæ¿€">ğŸš—</div>
                    <div class="stamp-btn" onclick="toggleStamp('ğŸ’¤')" title="æ—¥å¸¸/ç¡è§‰">ğŸ’¤</div>
                </div>
                <div id="galleryArea">
                    <div class="gallery-container">
                        <div class="gallery-type-label" id="galleryTypeLabel">ç±»å‹</div>
                        <img id="detailImg" class="gallery-img" src="">
                        <div class="gallery-nav nav-prev" onclick="changeGalleryImage(-1)">â®</div>
                        <div class="gallery-nav nav-next" onclick="changeGalleryImage(1)">â¯</div>
                        <button id="setCoverBtn" class="cover-btn" onclick="setAsCover()">è®¾ä¸ºå°é¢</button>
                        <button class="download-img-btn" onclick="downloadCurrentGalleryImg()" title="ä¸‹è½½æ­¤å›¾">â¬‡ï¸</button>
                        <div style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.5); color:white; padding:2px 8px; border-radius:10px; font-size:12px; pointer-events:none;">
                            <span id="imgIndex">1</span> / <span id="imgTotal">1</span>
                        </div>
                    </div>
                </div>
                
                <div id="noImgMsg" style="text-align:center; color:#ccc; padding:20px; display:none;">(æ­¤ç›’å­æ²¡æœ‰å›¾ç‰‡)</div>
                <div class="form-group">
                    <label style="display:flex; justify-content:space-between; align-items:center;">
                        <span>ğŸ’ çºªå¿µå“ (å›å¿†ä¿¡ç‰©)</span>
                        <button class="small-btn" onclick="openAddSouvenirModal()" style="font-size:12px;">+ æ·»åŠ ä¿¡ç‰©</button>
                    </label>
                    <div id="souvenirListArea" class="souvenir-scroll-box">
                        <div style="font-size:12px; color:#ccc; padding:10px;">è¿™é‡Œè¿˜ç©ºè¡è¡çš„...</div>
                    </div>
                </div>
                <div class="form-group"><label>ğŸ“‚ ç›’å­å†…å®¹</label><div id="detailListContainer" class="detail-list"></div></div>
                
                             <div class="form-group" style="text-align:center; margin-top:15px; border-top:1px dashed #eee; padding-top:10px;">
                    <label style="font-size:12px; color:#aaa; margin-bottom:8px;">ğŸ–¼ï¸ è£…é¥°ç›¸æ¡†</label>
                    <div style="display:flex; justify-content:center; gap:10px;">
                        <button class="small-btn" onclick="setFrame('none')" style="border:1px solid #ddd; color:#999;" title="é»˜è®¤">ğŸš«</button>
                        <button class="small-btn" onclick="setFrame('frame-lace')" style="background:#fff0f5; border:1px dashed #ffb7c5;" title="è•¾ä¸ç”œå¿ƒ">ğŸ€</button>
                        <button class="small-btn" onclick="setFrame('frame-gold')" style="background:#fffbe6; border:1px double #d4af37;" title="éé‡‘å…¸è—">âšœï¸</button>
                        <button class="small-btn" onclick="setFrame('frame-stardust')" style="background:linear-gradient(135deg,#e0c3fc,#8ec5fc); color:white; border:none;" title="æ˜Ÿå…‰æµä½“">âœ¨</button>
                        <button class="small-btn" onclick="setFrame('frame-sakura')" style="background:#ffeff2; border:1px solid #ff9a9e;" title="è½æ¨±ç”»å¢ƒ">ğŸŒ¸</button>
                    </div>
                </div>

                <div class="control-panel-grid">
    <button class="edit-btn" onclick="openEditMode()">âœï¸ ç¼–è¾‘</button>
    <button onclick="openOathModal()" style="border-color: #ffd700; color: #f39c12; background: #fffdf0;">ğŸ’ èª“çº¦</button>

    <button onclick="openScratchModal()" style="border-color: #fab1a0; color: #e17055; background: #fff5f0;">ğŸ¤« ç§˜å¯†</button>

    <button onclick="generateBriefing()" style="border-color: #a29bfe; color: #6c5ce7; background: #f3f0ff;">ğŸ“œ å‘ˆå¥æŠ˜</button>
<button onclick="manualGrantFavor()" style="border-color: #ff9ff3; color: #ff6b6b; background: #fff0f5;">ğŸ’° èµèµæ™‹å‡</button>
    <button onclick="giveGift()" style="border-color: #ff9ff3; color: #f368e0; background: #fff0f5;">ğŸ æŠ•å–‚</button>
    <button onclick="generateOOTD()" style="border-color: #54a0ff; color: #2e86de; background: #f0f8ff;">ğŸ‘— æ¢è£…</button>

    <button onclick="autoFillProfile()" style="border-color: #81ecec; color: #00cec9; background: #e0f7fa;">ğŸ§  è¡¥å…¨æ¡£æ¡ˆ</button>
    <button onclick="analyzeStoryTimeline()" style="border-color: #ffeaa7; color: #d35400; background: #fffbe6;">ğŸï¸ å‰§æƒ…å›é¡¾</button>
<button onclick="convertChatToNovel()" style="border-color: #a29bfe; color: #6c5ce7; background: #f3f0ff;">ğŸ“– è½¬å°è¯´</button>
    <button onclick="openNoteModal(-1)" style="border-color: #badc58; color: #6ab04c; background: #f6e58d;">ğŸ“Œ +è´´ä¾¿ç­¾</button>
</div>

<div style="padding: 0 5px; margin-top: 8px;">
    <button id="heirActionButton" onclick="handleHeirAction()" style="width:100%; border: 2px dashed #ff9a9e; color: #ff6b6b; background: #fff0f5; font-weight: bold; padding: 10px;">
        ğŸ‘¶ ç¥ˆç¦æ±‚å­
    </button>
</div>

<div class="danger-zone">
    <button onclick="deleteCurrentItem()" style="border: 1px solid #ffcccc; color: #ff6b6b; background: #fff0f0;">ğŸ—‘ï¸ åˆ é™¤æ­¤è§’è‰²</button>
</div>
            
            </div> 
        </div>
    </div>
               
    <div class="modal-overlay" id="readerModal" style="z-index: 5000;">
        <div class="modal reader-modal">
                       <div class="reader-header">
                <button class="close-reader" onclick="closeReader()">â†</button>
                
                <div style="text-align:center">
                    <div class="reader-title" id="readerTitle">å›å¿†è®°å½•</div>
                    <div class="reader-subtitle" id="readerCount" style="cursor:pointer" onclick="toggleBookmarkDrawer()">0 æ¡è®°å½• (ç‚¹å‡»æŸ¥çœ‹ä¹¦ç­¾)</div>
                </div>
                
                                <div style="display:flex;
gap:5px;">
                    <button class="close-reader" style="font-size:16px;" onclick="analyzeBond()" title="ç”Ÿæˆç¾ç»ŠæŠ¥å‘Š">ğŸ“Š</button> <button class="close-reader" style="font-size:16px;" onclick="toggleCssDrawer()">ğŸ¨</button>
                    <button class="close-reader" style="font-size:16px;" onclick="toggleBookmarkDrawer()">â­</button> 
                </div>

            </div>

<div class="css-drawer" id="cssDrawer">
    <div class="bookmark-header">
        <span>ğŸ¨ çš®è‚¤è®¾è®¡å¸ˆ</span>
        <span style="font-size:12px;cursor:pointer" onclick="toggleCssDrawer()">å…³é—­</span>
    </div>
    <div style="padding:15px; display:flex; flex-direction:column; height:100%;">
        <select id="themeSelect" onchange="loadSelectedTheme()" style="margin-bottom:10px; padding:5px;">
            <option value="">-- é€‰æ‹©å·²ä¿å­˜çš„ä¸»é¢˜ --</option>
        </select>

        <textarea id="cssInput" placeholder="åœ¨è¿™é‡Œè¾“å…¥ CSS ä»£ç ... ä¾‹å¦‚: .chat-bubble { background: pink; }" style="flex-grow:1; width:100%; border:1px solid #ddd; border-radius:10px; padding:10px; font-family:monospace; margin-bottom:10px; resize:none;"></textarea>

        <div style="display:flex; gap:5px;">
            <input type="text" id="themeNameInput" placeholder="ç»™ä¸»é¢˜èµ·ä¸ªå..." style="flex-grow:1; padding:5px; border:1px solid #ddd; border-radius:5px;">
            <button onclick="saveCustomTheme()" style="background:var(--accent-color); color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer;">ä¿å­˜</button>
            <button onclick="deleteCustomTheme()" style="background:#ffcccc; color:#ff6b6b; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">åˆ </button>
        </div>

        <button onclick="previewCss()" style="margin-top:10px; background:#e0f7fa; color:#006064; border:none; padding:8px; border-radius:5px; cursor:pointer; width:100%;">âš¡ ç«‹å³ç”Ÿæ•ˆ (é¢„è§ˆ)</button>
    </div>
</div>

            <div class="bookmark-drawer" id="bookmarkDrawer">
                <div class="bookmark-header">
                    <span>ğŸ“‘ æˆ‘çš„ä¹¦ç­¾</span>
                    <span style="font-size:12px;color:#999;cursor:pointer" onclick="toggleBookmarkDrawer()">å…³é—­</span>
                </div>
                <div class="bookmark-list" id="bookmarkList">
                    </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
            </div>

            <div class="reader-footer" id="readerFooter">
                <button class="page-btn" onclick="prevPage()">â—€ ä¸Šä¸€é¡µ</button>
                <span class="page-info" id="pageInfo">1 / 1</span>
                <button class="page-btn" onclick="nextPage()">ä¸‹ä¸€é¡µ â–¶</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="reportModal" style="z-index: 6000;">
        <div class="modal" style="width: 90%; max-width: 350px;">
            <button class="close-modal" onclick="document.getElementById('reportModal').classList.remove('active')">Ã—</button>
            <h2 style="text-align:center; color:var(--accent-color);">ğŸ“Š æˆ‘ä»¬çš„å›å¿†æŠ¥å‘Š</h2>
            
            <div class="report-card">
                <div style="font-size:13px; color:#999; margin-bottom:10px;">è·¨è¶Šæ—¶é—´</div>
                <div style="font-size:18px; font-weight:bold; color:#555;">
                    <span id="reportDateStart"></span> ~ <span id="reportDateEnd"></span>
                </div>
                <div style="background:#fff0f5; color:var(--accent-color); display:inline-block; padding:2px 10px; border-radius:10px; font-size:12px; margin-top:5px;">
                    å…±é™ªä¼´ <span id="reportDays" style="font-size:16px; font-weight:bold;">0</span> å¤©
                </div>

                <div class="report-stat-row">
                    <div class="stat-item">
                        <h3 id="reportTotalFloors">0</h3>
                        <p>ç›–æ¥¼é«˜åº¦</p>
                    </div>
                    <div class="stat-item">
                        <h3 id="reportTotalWords">0</h3>
                        <p>æ€»å­—æ•°</p>
                    </div>
                </div>

                <div style="text-align:left; font-size:12px; color:#666; margin-top:15px;">
                    <div>ğŸ“ è¯ç—¨å¤§æ¯”æ‹¼ (å­—æ•°å æ¯”)</div>
                    <div class="ratio-bar-container">
                        <div id="ratioUser" class="ratio-segment ratio-left" style="width:50%">æˆ‘</div>
                        <div id="ratioChar" class="ratio-segment ratio-right" style="width:50%">TA</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <span id="textCountUser">æˆ‘: 0å­—</span>
                        <span id="textCountChar">TA: 0å­—</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="gachaModal" style="z-index: 7000;">
        <div class="modal">
            <button class="close-modal" onclick="closeGachaModal()">Ã—</button>
            <h2 style="text-align:center; margin-bottom:10px;">ğŸ² å‰§æƒ…çµæ„Ÿæ‰­è›‹æœº</h2>
            
            <div class="gacha-machine">
                <div class="gacha-display" id="gachaResultArea">
                    <div style="color:#ccc; font-size:14px;">ç‚¹å‡»æŒ‰é’®ï¼Œè·å–ä»Šæ—¥æ¢—æ¦‚...</div>
                </div>
                
                <div class="gacha-controls">
                    <button class="primary-btn" onclick="spinGacha()" style="width:100%; justify-content:center; font-size:16px;">ğŸ° ç»™æˆ‘ä¸€ä¸ªè„‘æ´ï¼</button>
                </div>
                <div style="text-align:center; margin-top:10px;">
                    <span class="action-link" onclick="toggleGachaEdit()">âš™ï¸ ç¼–è¾‘é¢˜åº“</span>
                </div>

                <div class="gacha-edit-area" id="gachaEditArea">
                    <label style="font-size:12px; color:#666;">ğŸ“ åœ°ç‚¹ (ç”¨é€—å·åˆ†éš”)</label>
                    <textarea id="editPlace" class="gacha-textarea"></textarea>
                    
                    <label style="font-size:12px; color:#666;">ğŸ“… äº‹ä»¶ (ç”¨é€—å·åˆ†éš”)</label>
                    <textarea id="editEvent" class="gacha-textarea"></textarea>
                    
                    <label style="font-size:12px; color:#666;">âœ¨ æ°›å›´/æ¢— (ç”¨é€—å·åˆ†éš”)</label>
                    <textarea id="editTrope" class="gacha-textarea"></textarea>
                    
                    <button class="small-btn primary-btn" onclick="saveGachaData()" style="width:100%; margin-top:5px;">ğŸ’¾ ä¿å­˜é¢˜åº“é…ç½®</button>
                    <button class="small-btn" onclick="resetGachaData()" style="width:100%; margin-top:5px; background:#fff; color:#999; border:1px solid #ddd;">ğŸ”„ æ¢å¤é»˜è®¤é¢˜åº“</button>
                </div>
            </div>
        </div>
    </div>

<div class="modal-overlay" id="addSouvenirModal" style="z-index: 7000;">
        <div class="modal">
            <button class="close-modal" onclick="document.getElementById('addSouvenirModal').classList.remove('active')">Ã—</button>
            <h2 style="text-align:center;">âœ¨ å°å­˜ä¸€æ®µå›å¿†</h2>
            
            <div class="form-group">
                <label>ğŸ“¸ ä¿¡ç‰©ç…§ç‰‡ (ç‚¹å‡»ä¸Šä¼ )</label>
                <div onclick="document.getElementById('souvenirImgInput').click()" 
                     style="width:100%; height:150px; background:#f9f9f9; border:2px dashed #ddd; border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden;">
                    <img id="souvenirPreview" style="max-width:100%; max-height:100%; display:none;">
                    <span id="souvenirUploadHint" style="color:#aaa;">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</span>
                </div>
                <input type="file" id="souvenirImgInput" accept="image/*" onchange="previewSouvenirImg(this)">
            </div>

            <div class="form-group">
                <label>ğŸ·ï¸ åå­—</label>
                <input type="text" id="souvenirName" placeholder="ä¾‹å¦‚ï¼šé‚£å¤©çš„çƒŸç«å¤§ä¼š...">
            </div>

            <div class="form-group">
                <label>ğŸ“œ å®ƒçš„æ•…äº‹ (å›å¿†æè¿°)</label>
                <textarea id="souvenirDesc" style="width:100%; height:80px; padding:10px; border:2px solid #ffe6eb; border-radius:10px; resize:none;" placeholder="ä¸ºä»€ä¹ˆè¿™ä¸ªä¸œè¥¿å¾ˆé‡è¦ï¼Ÿ"></textarea>
            </div>
            
            <button class="primary-btn" onclick="saveSouvenir()" style="width:100%;">ğŸ’¾ æ”¾å…¥é™ˆåˆ—å®¤</button>
        </div>
    </div>

    <div class="modal-overlay" id="viewSouvenirModal" style="z-index: 7500;">
        <div class="modal">
            <button class="close-modal" onclick="document.getElementById('viewSouvenirModal').classList.remove('active')">Ã—</button>
            <div class="souvenir-view-content">
                <h2 id="viewSovTitle" style="color:var(--accent-color); margin-bottom:10px;"></h2>
                <img id="viewSovImg" class="souvenir-view-img">
                <div id="viewSovDesc" class="souvenir-view-story"></div>
                
                <div style="font-size:12px; color:#aaa; margin-top:20px;">
                    å±äº: <span id="viewSovOwner"></span>
                </div>
                <button class="small-btn" onclick="deleteCurrentSouvenir()" style="background:#fff; color:#ff6b6b; border:1px solid #ffcccc; margin-top:10px;">ğŸ—‘ï¸ ä¸¢å¼ƒ</button>
            </div>
        </div>
    </div>

<div class="modal-overlay" id="echoModal" style="z-index: 7500;">
        <div class="modal">
            <button class="close-modal" onclick="document.getElementById('echoModal').classList.remove('active')">Ã—</button>
            <h2 style="text-align:center;">ğŸ“– å¬å¬TAæ€ä¹ˆè¯´</h2>
            <div style="font-size:12px; color:#aaa; text-align:center; margin-bottom:15px;">å¿ƒä¸­é»˜å¿µä½ çš„é—®é¢˜ (æ˜¯/å¦)ï¼Œç„¶åç‚¹å‡»è†å¬</div>

            <div class="echo-card">
                <div style="margin-bottom:15px;">
                    <select id="echoCharSelect" onchange="updateEchoAvatar()" style="width:100%; padding:8px; border-radius:10px; border:1px solid #ddd;">
                        <option value="">-- è¯·é€‰æ‹©æŒ‡å¼•è€… --</option>
                    </select>
                </div>

                <img id="echoAvatarDisplay" src="" style="display:none;" class="echo-avatar">
                
                <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:15px;">
                    <label style="font-size:12px; color:#666;">TAçš„æ€§æ ¼:</label>
                    <select id="echoArchetypeSelect" style="padding:5px; border-radius:5px; border:1px solid #ffb7c5; font-size:12px;">
                        </select>
                </div>

                <div class="echo-result-box" id="echoResultText">
                    ...
                </div>

                <button class="primary-btn" onclick="askEcho()" style="width:100%; font-size:16px;">ğŸ”® è†å¬å›å“</button>
                
                <div style="margin-top:15px; border-top:1px dashed #eee; padding-top:10px;">
                    <span class="action-link" onclick="toggleEchoEdit()" style="background:#f0f0f0; color:#888;">âœï¸ ç¼–å†™/ä¿®æ”¹æ€§æ ¼åº“</span>
                </div>
                
                <div id="echoEditArea" style="display:none; margin-top:10px; text-align:left;">
                    <label style="font-size:12px;">é€‰ä¸­ä¸Šæ–¹çš„æ€§æ ¼ï¼Œç„¶ååœ¨è¿™é‡Œä¿®æ”¹ (ä¸€è¡Œä¸€å¥):</label>
                    <textarea id="echoEditText" style="width:100%; height:100px; font-size:12px; border:1px solid #ddd; border-radius:10px; padding:5px; resize:none;" onchange="saveCurrentEchoLib()"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="oathModal" style="z-index: 8000;">
        <div class="modal" style="background: transparent; box-shadow: none; padding: 0; display: flex; justify-content: center; align-items: center;">
            
            <div class="oath-paper" id="oathPaper">
                <button class="close-modal" onclick="document.getElementById('oathModal').classList.remove('active')" style="color:#bdc3c7; top:10px; right:10px;">Ã—</button>
                
                <div class="oath-border"></div>
                
                <div class="oath-header">âœ¨ æ°¸æ’èª“çº¦ âœ¨</div>
                
                <div class="oath-content">
                    <img id="oathAvatar" class="oath-avatar" src="">
                    <div style="margin: 15px 0; font-size: 14px; color: #555; line-height: 1.8;">
                        è‡ªä»Šæ—¥ <span id="oathDate" style="border-bottom: 1px solid #aaa; padding: 0 5px; font-weight: bold;"></span> èµ·<br>
                        æˆ‘æ„¿ä¸ <span id="oathCharName" style="color:var(--accent-color); font-weight:bold; font-size:16px;"></span> ç¼”ç»“ç¾ç»Šã€‚<br>
                        æ— è®ºæ•°æ®æ´ªæµå¦‚ä½•å†²åˆ·ï¼Œ<br>
                        è¿™ä»½è®°å¿†å°†æ°¸ä¸è¤ªè‰²ã€‚
                    </div>
                </div>

                <div class="oath-footer">
                    <div class="oath-sign-box">
                        <span>User:</span>
                        <div class="sign-line">æˆ‘ (Me)</div>
                    </div>
                    <div class="oath-sign-box">
                        <span>Partner:</span>
                        <div class="sign-line" id="oathSignName">???</div>
                    </div>
                </div>

                <div class="oath-action-area">
                    <div id="oathSealBtn" class="oath-seal-btn" onclick="signTheOath()">
                        ğŸ–ï¸ æŒ‰æ‰‹å°
                    </div>
                    <div id="oathStamp" class="oath-stamp-mark">
                        <div style="font-size: 50px;">ğŸ’‹</div>
                        <div style="font-size: 10px; transform: rotate(-5deg); border: 2px solid #d63031; padding: 2px 5px; border-radius: 4px; color: #d63031; display: inline-block; margin-top: -10px;">LOVED</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

<div class="modal-overlay" id="scratchModal" style="z-index: 8500;">
        <div class="modal" style="width: 300px; padding: 20px; background: #fff0f5; border: 4px solid white; border-radius: 20px; text-align: center;">
            <button class="close-modal" onclick="closeScratchModal()">Ã—</button>
            
            <h2 style="color: #d66a80; margin-bottom: 5px;">ğŸ¤« éšè—çš„ç§˜å¯†</h2>
            <div style="font-size: 12px; color: #aaa; margin-bottom: 15px;">æ¥è‡ªèŠå¤©è®°å½•çš„éšæœºå›å¿†...</div>

            <div class="scratch-container" id="scratchContainer">
                <div class="scratch-text-layer">
                    <div id="scratchSecretText">...</div>
                </div>
                <canvas id="scratchCanvas"></canvas>
                
                <div id="scratchCover" class="scratch-cover-overlay">
                    <div style="font-size: 40px;">ğŸ«£</div>
                    <div style="font-weight: bold; color: #fff; margin-top: 10px;">è¦å·çœ‹TAçš„å¿ƒé‡Œè¯å—ï¼Ÿ</div>
                </div>
            </div>

            <div class="scratch-actions" id="scratchBtnArea">
                <button class="small-btn" onclick="closeScratchModal()" style="background: #eee; color: #999;">ğŸ«£ ç®—äº†ä¸æ•¢çœ‹</button>
                <button class="primary-btn" onclick="startScratching()" style="background: #ff8fa3; border: none;">ğŸ–ï¸ æˆ‘è¦åˆ®ï¼</button>
            </div>
            
            <div id="scratchHint" style="display:none; font-size:12px; color:#d66a80; margin-top:10px;">
                âœ¨ å¿«ç”¨æ‰‹æŒ‡/é¼ æ ‡æ¶‚æŠ¹ä¸Šæ–¹åŒºåŸŸ âœ¨
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="noteModal" style="z-index: 8800;">
        <div class="modal" style="background: transparent; box-shadow: none; padding: 0; display: flex; justify-content: center; align-items: center;">
            
            <div class="sticky-note-paper">
                <button class="close-modal" onclick="closeNoteModal()" style="color: #bfa588; top: 5px; right: 5px;">Ã—</button>
                
                <div style="text-align: center; color: #bfa588; font-weight: bold; margin-bottom: 10px; font-size: 14px;">
                    ğŸ“Œ è§’è‰²å¤‡æ³¨ & éšæ‰‹è®°
                </div>

                <div class="note-toolbar">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:10px; color:#999;">é¢œè‰²:</span>
                        <input type="color" id="noteColorPicker" value="#555555" onchange="previewNoteStyle()">
                    </div>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:10px; color:#999;">å¤§å°:</span>
                        <input type="range" id="noteSizeSlider" min="12" max="30" value="14" style="width: 60px;" oninput="previewNoteStyle()">
                    </div>
                </div>

                <textarea id="noteTextarea" placeholder="åœ¨è¿™é‡Œå†™ä¸‹å…³äºTAçš„å¤‡æ³¨...&#10;æ¯”å¦‚ï¼šç”Ÿæ—¥æ˜¯XæœˆXæ—¥&#10;æˆ–è€…ï¼šä»Šå¤©TAè¶…çº§å¯çˆ±ï¼"></textarea>

                <button class="small-btn" onclick="saveNote()" style="width: 100%; margin-top: 10px; background: #fff; border: 1px dashed #bfa588; color: #bfa588;">ğŸ’¾ è´´ä¸Šå»</button>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="aiSettingsModal" style="z-index: 9999;">
        <div class="modal" style="width: 280px;">
            <button class="close-modal" onclick="document.getElementById('aiSettingsModal').classList.remove('active')">Ã—</button>
            <h3 style="text-align:center; color:var(--accent-color); margin-bottom:15px;">ğŸ§  è°ƒæ•™ä½ çš„ä¾ä»</h3>
            <div style="background:#f0f9ff; padding:10px; border-radius:8px; border:1px dashed #81d4fa; margin-bottom:15px;">
    <label style="font-size:12px; color:#0288d1; font-weight:bold;">âš¡ å¿«é€Ÿåˆ‡æ¢ API é…ç½®</label>
    <div style="display:flex; gap:5px; margin-top:5px;">
        <select id="apiPresetSelect" onchange="applyApiPreset()" style="flex:1; padding:5px; border-radius:5px; border:1px solid #b3e5fc; font-size:12px;">
            <option value="">-- é€‰æ‹©å·²å­˜é…ç½® --</option>
        </select>
        <button onclick="saveCurrentApiPreset()" style="background:#0288d1; color:white; border:none; border-radius:5px; width:30px; cursor:pointer;" title="ä¿å­˜å½“å‰é…ç½®">â•</button>
        <button onclick="deleteApiPreset()" style="background:#ffebee; color:#ff6b6b; border:1px solid #ffcdd2; border-radius:5px; width:30px; cursor:pointer;" title="åˆ é™¤é€‰ä¸­">ğŸ—‘ï¸</button>
    </div>
</div>

            <div class="form-group">
                <label>ğŸ­ é€‰æ‹©äººè®¾</label>
                <select id="aiPersonaSelect" style="width:100%; padding:8px; border-radius:10px; border:1px solid #ddd;">
                    <option value="eunuch">ğŸ™‡ å°å¾·å­ (å‘å¾®å¤ªç›‘)</option>
                    <option value="maid">ğŸ± å–µå–µå¥³ä»† (å¯çˆ±çŒ«å¨˜)</option>
                    <option value="butler">ğŸ§ æ¯’èˆŒç®¡å®¶ (é˜´é˜³æ€ªæ°”)</option>
                    <option value="yandere">ğŸ”ª ç—…å¨‡å¦¹å¦¹ (ç‹¬å æ¬²)</option>
                    <option value="custom">ğŸ› ï¸ è‡ªå®šä¹‰äººè®¾</option>
                </select>
            </div>

            <div id="customPersonaArea" class="form-group" style="display:none;">
                <label>ğŸ“ è‡ªå®šä¹‰æç¤ºè¯ (System Prompt)</label>
                <textarea id="aiCustomPrompt" style="width:100%; height:60px; font-size:12px; border:1px solid #ddd; border-radius:10px; padding:5px;"></textarea>
            </div>

            <div class="form-group">
                <label>ğŸ”— API åœ°å€ (åä»£é“¾æ¥)</label>
                <input type="text" id="aiApiUrl" placeholder="ä¾‹å¦‚: https://api.openai.com/v1" value="https://api.openai.com/v1">
            </div>

            <div class="form-group">
                <label>ğŸ”‘ API Key</label>
                <input type="password" id="aiApiKey" placeholder="sk-...">
            </div>

                      <div class="form-group">
                <label>ğŸ§  æ¨¡å‹é€‰æ‹©</label>
                <div style="display:flex; gap:5px;">
                    <select id="aiModelSelect" style="flex:1; padding:8px; border-radius:10px; border:1px solid #ddd; background:white;">
                        <option value="gpt-3.5-turbo">gpt-3.5-turbo (é»˜è®¤)</option>
                        <option value="gpt-4o">gpt-4o</option>
                        <option value="gpt-4-turbo">gpt-4-turbo</option>
                        <option value="claude-3-5-sonnet-20240620">claude-3.5-sonnet</option>
                    </select>
                    <button onclick="fetchModelList()" style="background:#fff0f5; border:1px solid #ffb7c5; border-radius:10px; padding:0 12px; cursor:pointer; color:#d66a80;" title="ç‚¹å‡»æ‹‰å–æ¨¡å‹åˆ—è¡¨">ğŸ”„</button>
                </div>
                
                <input type="text" id="aiModelManual" placeholder="æ‰¾ä¸åˆ°ï¼Ÿç‚¹è¿™é‡Œæ‰‹åŠ¨è¾“å…¥..." style="width:100%; margin-top:5px; font-size:12px; border:1px solid #ddd; border-radius:8px; padding:5px; display:none;">
                <div style="font-size:10px; color:#aaa; text-align:right; margin-top:2px; cursor:pointer;" onclick="toggleManualInput()">æ‰¾ä¸åˆ°æ¨¡å‹? æ‰‹åŠ¨è¾“å…¥</div>
            </div>

            <button class="primary-btn" onclick="saveAISettings()" style="width:100%;">ğŸ’¾ ä¿å­˜è®¾å®š</button>
        </div>
    </div>

    <div class="modal-overlay" id="theaterModal" style="z-index: 9500;">
        <div class="modal" style="width: 320px;">
            <button class="close-modal" onclick="document.getElementById('theaterModal').classList.remove('active')">Ã—</button>
            <h2 style="text-align:center; color:var(--accent-color);">ğŸ¬ è·¨æ—¶ç©ºå‰§åœº</h2>
            
            <div style="font-size:12px; color:#aaa; text-align:center; margin-bottom:15px;">
                é€‰ä¸¤ä¸ªè§’è‰²ï¼Œè®© AI å¯¼æ¼”ä¸€åœºæˆ...
            </div>

            <div style="display:flex; gap:10px; align-items:center;">
                <select id="theaterCharA" style="flex:1; padding:5px; border-radius:10px;"></select>
                <span style="font-weight:bold; color:#ffb7c5;">VS</span>
                <select id="theaterCharB" style="flex:1; padding:5px; border-radius:10px;"></select>
            </div>

            <div class="form-group" style="margin-top:15px;">
                <label>ğŸ­ å‰§æœ¬æƒ…å¢ƒ (å¯é€‰)</label>
                <input type="text" id="theaterTopic" placeholder="ä¾‹å¦‚ï¼šäº‰é£åƒé†‹ã€è’å²›æ±‚ç”Ÿã€äº’ç›¸å¹æ§...">
            </div>

            <button class="primary-btn" onclick="startTheater()" style="width:100%; margin-top:10px;">ğŸ¥ Action! (å¼€å§‹æ¼”å‡º)</button>
        </div>
    </div>

    <div class="modal-overlay" id="letterModal" style="z-index: 9600;">
        <div class="modal" style="background: transparent; box-shadow: none; padding: 0; display: flex; justify-content: center; align-items: center;">
            <div class="letter-paper">
                <button class="close-modal" onclick="document.getElementById('letterModal').classList.remove('active')" style="color:#555;">Ã—</button>
                <div class="letter-stamp">é‚®æˆ³</div>
                <div class="letter-content" id="letterText">
                    æ­£åœ¨æ‹†ä¿¡...
                </div>
                <div class="letter-signature" id="letterSign">???</div>
            </div>
        </div>
    </div>

<div class="modal-overlay" id="momentsModal" style="z-index: 9600;">
    <div class="modal" style="width: 350px; height: 80vh; padding: 0; display: flex; flex-direction: column; background: #f2f2f2;">
        
        <div style="background: rgba(255,255,255,0.95); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0;">
            <span style="font-weight: bold; font-size: 16px;">æœ‹å‹åœˆ</span>
            <button class="close-modal" onclick="closeMomentsModal()" style="position: static; color: #333; font-size: 24px; width: auto; height: auto; background: none;">Ã—</button>
        </div>

        <div id="momentsFeed" style="flex: 1; overflow-y: auto; padding: 15px;">
            <div style="text-align: center; color: #999; margin-top: 50px; font-size: 13px;">
                å¿«å‘ä¸€æ¡åŠ¨æ€ï¼Œ<br>çœ‹çœ‹è°ä¼šç§’å›ä½ ï¼Ÿâœ¨
            </div>
        </div>

        <div style="background: white; padding: 10px; border-top: 1px solid #ddd; display: flex; gap: 10px; align-items: flex-end;">
            <textarea id="momentInput" placeholder="åˆ†äº«æ­¤åˆ»çš„å¿ƒæƒ…..." style="flex: 1; border: none; background: #f5f5f5; padding: 10px; border-radius: 8px; resize: none; height: 40px; font-family: inherit; transition: height 0.2s;" onfocus="this.style.height='80px'" onblur="if(!this.value)this.style.height='40px'"></textarea>
            <button id="momentSendBtn" class="primary-btn" onclick="postMoment()" style="border-radius: 8px; padding: 0 15px; height: 40px; display: flex; align-items: center; justify-content: center;">å‘å¸ƒ</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="gossipModal" style="z-index: 9700;">
    <div class="modal" style="width: 360px; height: 80vh; background: #f4f1ea; padding: 0; display: flex; flex-direction: column; border: 1px solid #dcdcdc;">
        <div style="padding: 20px; text-align: center; border-bottom: 2px double #333; margin: 10px;">
            <div style="font-family: 'Times New Roman', serif; font-size: 28px; font-weight: bold; color: #333; letter-spacing: 2px;">ç™¾å®ç®±å‘¨åˆŠ</div>
            <div style="font-size: 10px; color: #666; margin-top: 5px; text-transform: uppercase;">The Treasure Weekly Â· ç‹¬å®¶çˆ†æ–™ Â· ç»æ— è™šè¨€</div>
        </div>
        
        <div id="gossipPaper" style="flex: 1; overflow-y: auto; padding: 0 20px 20px 20px;">
            <div style="text-align:center; padding-top:50px; color:#888;">
                æ­£åœ¨æ½œå…¥åå°å·å¬æ•°æ®...<br>ç¼–è¾‘éƒ¨æ­£åœ¨ç–¯ç‹‚èµ¶ç¨¿ä¸­...âœï¸
            </div>
        </div>

        <div style="text-align: center; padding: 15px;">
            <button class="close-modal" onclick="document.getElementById('gossipModal').classList.remove('active')" style="position: static; width: 100%; border: 1px solid #333; color: #333; background: transparent; border-radius: 0;">é˜…æ¯•ï¼Œé€€ä¸‹</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="barModal" style="z-index: 9700;">
    <div class="modal" style="width: 340px; background: #2c3e50; color: #ecf0f1; border-radius: 15px; border: 2px solid #34495e;">
        <button class="close-modal" onclick="document.getElementById('barModal').classList.remove('active')" style="color: #ecf0f1;">Ã—</button>
        
        <h2 style="text-align: center; font-family: serif; color: #f1c40f; margin-bottom: 5px;">ğŸŒ™ æ·±å¤œé£Ÿå ‚</h2>
        <div style="text-align: center; font-size: 12px; color: #bdc3c7; margin-bottom: 20px;">è´©å–æ¸©æŸ”ï¼Œæ¦‚ä¸èµŠè´¦</div>

        <div class="form-group">
            <label style="color: #bdc3c7;">1. ä½ ç°åœ¨çš„å¿ƒæƒ…æ˜¯ï¼Ÿ</label>
            <input type="text" id="barMood" placeholder="ä¾‹å¦‚ï¼šåŠ ç­å¥½ç´¯ã€å¤±æ‹äº†ã€æƒ³æ‰¾äººåµæ¶..." style="background: #34495e; border: none; color: white;">
        </div>

        <div class="form-group">
            <label style="color: #bdc3c7;">2. æŒ‡åå“ªä½å¤§å¨ï¼Ÿ</label>
            <select id="barChefSelect" style="background: #34495e; border: none; color: white;">
                </select>
        </div>

        <button class="primary-btn" onclick="orderFood()" style="width: 100%; background: #f1c40f; color: #2c3e50; font-weight: bold; margin-top: 10px;">ğŸ›ï¸ å®ï¼ä¸Šèœ</button>
        
        <div id="barResult" style="margin-top: 20px; display: none; animation: fadeIn 0.5s;">
            <div style="background: #34495e; padding: 15px; border-radius: 10px; border-left: 4px solid #f1c40f;">
                <div id="barDishName" style="font-size: 18px; font-weight: bold; color: #f1c40f; margin-bottom: 8px;"></div>
                <div id="barDishDesc" style="font-size: 13px; color: #ecf0f1; line-height: 1.6; font-style: italic;"></div>
                <div id="barChefTalk" style="margin-top: 15px; font-size: 14px; border-top: 1px dashed #7f8c8d; padding-top: 10px;"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="soulModal" style="z-index: 9900;">
    <div class="modal" style="width: 320px; background: #2b2b2b; color: #eee; border: 1px solid #444; padding: 0; overflow: hidden; display: flex; flex-direction: column;">
        
        <div style="position: relative; height: 200px; background: radial-gradient(circle at center, #444 0%, #2b2b2b 70%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <button class="close-modal" onclick="closeSoulModal()" style="color: #666; top: 10px; right: 10px;">Ã—</button>
            
            <div id="soulAvatarContainer" style="position: relative;">
                <img id="soulAvatar" src="" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.2); object-fit: cover; box-shadow: 0 0 20px rgba(255,255,255,0.1);">
                <div id="soulPulse" class="soul-pulse"></div>
            </div>
            
            <div id="soulCharName" style="position: absolute; bottom: 10px; width: 100%; text-align: center; font-size: 14px; font-weight: bold; text-shadow: 0 2px 4px black; letter-spacing: 2px;">???</div>
        </div>

        <div style="flex: 1; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
            <div id="soulQuestion" style="font-size: 15px; line-height: 1.6; color: #fff; margin-bottom: 20px; font-family: serif;">
                æ­£åœ¨è¯»å–ä½ çš„è®°å¿†...<br><span style="font-size:12px;color:#666;">(å‡†å¤‡å¥½é¢å¯¹çœŸå¿ƒäº†å—ï¼Ÿ)</span>
            </div>
            
            <div id="soulAnswerArea" style="width: 100%; display: none;">
                <input type="text" id="soulInput" placeholder="åœ¨æ­¤å†™ä¸‹ä½ çš„å›ç­”..." style="width: 100%; padding: 10px; border-radius: 20px; border: none; background: rgba(255,255,255,0.1); color: white; text-align: center; outline: none; margin-bottom: 10px;">
                <button class="primary-btn" onclick="submitSoulAnswer()" style="width: 100%; background: #eee; color: #222; border: none;">âœ‰ï¸ äº¤ä»˜çœŸå¿ƒ</button>
            </div>

            <button id="soulNextBtn" onclick="initSoulSession()" style="display:none; background:transparent; border:1px solid #666; color:#999; padding:5px 15px; border-radius:20px; font-size:12px; margin-top:20px;">æ¢ä¸€ä¸ªäººé—®</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="throneModal" style="z-index: 9800;">
    <div class="modal" style="width: 320px; background: #fffcf5; border: 4px double #d4af37;">
        <button class="close-modal" onclick="document.getElementById('throneModal').classList.remove('active')">Ã—</button>
        <h3 style="text-align:center; color:#d4af37; font-family: serif;">ğŸ“œ å¾¡ä¹¦æˆ¿ Â· æ‰¹çº¢</h3>
        <div id="throneContent" style="margin: 20px 0; min-height: 100px; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 5px; font-size: 14px; line-height: 1.6;">
            æ­£åœ¨å‘ˆé€’å¥æŠ˜...
        </div>
        <div id="throneAction" style="display:none; justify-content:space-around;">
            <button onclick="handleThrone('approve')" style="background:#ff6b6b; color:white; border:none; padding:10px 20px; border-radius:50px;">ğŸ”´ å‡†å¥</button>
            <button onclick="handleThrone('reject')" style="background:#333; color:white; border:none; padding:10px 20px; border-radius:50px;">âš« é©³å›</button>
        </div>
        <div id="throneResult" style="margin-top:15px; text-align:center; color:#888; font-style:italic;"></div>
    </div>
</div>

<div class="modal-overlay" id="flipModal" style="z-index: 9800;">
    <div class="modal" style="width: 340px; background: #2c0000; color: #ffd700; border: 2px solid #ffd700;">
        <button class="close-modal" onclick="document.getElementById('flipModal').classList.remove('active')" style="color:white;">Ã—</button>
        <h3 style="text-align:center; margin-bottom:20px;">ğŸ® æ•¬äº‹æˆ¿ Â· ç¿»ç‰Œå­</h3>
        <div id="flipCardsArea" style="display:flex; justify-content:space-around; gap:5px;">
            </div>
        <div id="flipResult" style="margin-top:20px; padding:15px; background:rgba(255,255,255,0.1); border-radius:10px; display:none; font-size:13px; line-height:1.6;"></div>
    </div>
</div>

<div class="modal-overlay" id="eavesdropModal" style="z-index: 9800;">
    <div class="modal" style="width: 320px; background: #1a1a2e; color: #e0e0e0;">
        <button class="close-modal" onclick="document.getElementById('eavesdropModal').classList.remove('active')" style="color:white;">Ã—</button>
        <h3 style="text-align:center; color:#a29bfe;">ğŸ‘‚ æš—å«å¯†æŠ¥</h3>
        <div style="font-size:12px; color:#666; text-align:center; margin-bottom:15px;">æˆªè·äº†ä¸€æ®µåå®«ç§è¯­...</div>
        <div id="eavesdropContent" style="padding:15px; background:rgba(0,0,0,0.3); border-radius:10px; font-family:monospace; margin-bottom:15px;">
            æ­£åœ¨ç ´è¯‘...
        </div>
        <button class="primary-btn" onclick="startEavesdrop()" style="width:100%;">ğŸ•µï¸ å†æ¢å†æŠ¥</button>
    </div>
</div>

<div class="modal-overlay" id="jealousyModal" style="z-index: 9800;">
    <div class="modal" style="width: 340px; background: #fff0f5; border: 2px solid #ffb7c5;">
        <button class="close-modal" onclick="document.getElementById('jealousyModal').classList.remove('active')">Ã—</button>
        <h3 style="text-align:center; color:#ff6b81;">ğŸ’¢ åå®«ä¿®ç½—åœº</h3>
        <div style="text-align:center; margin-bottom:10px; font-size:12px; color:#888;">å“ªä¸¤ä¸ªç”·äººåœ¨ä¸ºä½ äº‰é£åƒé†‹ï¼Ÿ</div>
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <select id="jealousCharA" style="flex:1; padding:5px;"></select>
            <span style="align-self:center;">VS</span>
            <select id="jealousCharB" style="flex:1; padding:5px;"></select>
        </div>
        <button class="primary-btn" onclick="startJealousy()" style="width:100%; background:#ff6b81; border:none;">ğŸ”¥ æ‰“èµ·æ¥ï¼</button>
        <div id="jealousyResult" style="margin-top:15px; padding:10px; background:white; border-radius:10px; border:1px dashed #ffb7c5; min-height:100px; display:none;"></div>
    </div>
</div>

<div class="modal-overlay" id="novelModal" style="z-index: 10000;">
    <div class="modal" style="width: 90%; max-width: 600px; height: 80vh; background: #fffaf0; display: flex; flex-direction: column; padding: 0; border: 1px solid #e0d0b0; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
        
        <div style="padding: 15px; border-bottom: 1px dashed #d4c4a8; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.5);">
            <span style="font-weight: bold; font-family: serif; font-size: 18px; color: #5d4037;">ğŸ“– å¾¡è§ˆå°è¯´</span>
            <div style="display: flex; gap: 10px;">
                <button onclick="downloadCurrentNovel()" class="small-btn" style="background: #fff; border: 1px solid #8d6e63; color: #5d4037;">â¬‡ï¸ ä¸‹è½½å¸¦èµ°</button>
                <button onclick="document.getElementById('novelModal').classList.remove('active')" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #8d6e63;">Ã—</button>
            </div>
        </div>

        <div id="novelContent" style="flex: 1; overflow-y: auto; padding: 30px; font-family: 'Georgia', 'Songti SC', serif; line-height: 1.8; color: #3e2723; font-size: 16px; white-space: pre-wrap; text-align: justify;">
            æ­£åœ¨ç¿»é˜…...
        </div>
        
        <div style="padding: 10px; text-align: center; font-size: 12px; color: #a1887f; background: rgba(255,255,255,0.5);">
            âœ… æ­¤æ–‡å·²è‡ªåŠ¨å½’æ¡£è‡³è¯¥è§’è‰²çš„ã€ç›’å­å†…å®¹ã€‘ä¸­
        </div>
    </div>
</div>

<div class="modal-overlay" id="horoscopeModal" style="z-index: 9900;">
    <div class="modal" style="width: 320px; text-align: center;">
        <button class="close-modal" onclick="document.getElementById('horoscopeModal').classList.remove('active')" style="color: #fff;">Ã—</button>
        <h3 style="color: #ffd700; font-family: serif; margin-bottom: 5px;">ğŸŒ  é’¦å¤©ç›‘ Â· ä»Šæ—¥æ˜Ÿè±¡</h3>
        <div style="font-size: 12px; color: #aaa; margin-bottom: 20px;" id="horoscopeDate"></div>
        
        <div id="horoscopeContent">
            <div class="ai-loading" style="color:#fff;">ğŸ”® å›½å¸ˆæ­£åœ¨å¤œè§‚å¤©è±¡...</div>
        </div>
        
        <button onclick="document.getElementById('horoscopeModal').classList.remove('active')" class="primary-btn" style="margin-top:20px; background:#ffd700; color:#000; border:none; width:100%;">æœ•çŸ¥é“äº†</button>
    </div>
</div>

<div class="modal-overlay" id="heirCreationModal" style="z-index: 10000;">
    <div class="modal" style="width: 300px; text-align: center; border: 3px solid #ffb7c5;">
        <h3 style="color:#ff6b81;">ğŸ‘¶ ç¥ˆç¦æ±‚å­</h3>
        <p style="font-size:12px; color:#888; margin: 10px 0;">æ‚¨ä¸ <b id="creationFatherName"></b> çš„ç¾ç»Šå·²æ·±ã€‚<br>è¯·é™›ä¸‹è®¸æ„¿ï¼Œå¸Œæœ›è¿™ä¸ªå­©å­æœªæ¥æˆä¸ºä»€ä¹ˆæ ·çš„äººï¼Ÿ</p>
        <textarea id="creationSettingInput" placeholder="ä¾‹å¦‚ï¼šå¸Œæœ›ä»–åƒçˆ¶äº²ä¸€æ ·å‚²å¨‡ï¼Œä½†æ–‡æ­¦åŒå…¨ï¼Œå°†æ¥èƒ½åšä¸ªè´¤ç‹..."></textarea>
        <button onclick="confirmCreateHeir()" class="primary-btn" style="width:100%; background:#ff6b81; border:none;">è¯šå¿ƒç¥ˆæ„¿ âœ¨</button>
    </div>
</div>

<div class="modal-overlay" id="eastPalaceModal" style="z-index: 10000;">
    <div class="modal">
        <button class="close-modal" onclick="closeEastPalace()" style="color:#d4af37; z-index:10;">Ã—</button>
        
        <div class="heir-portrait-stage stage-baby" id="heirStageBg">
            <div class="heir-avatar" id="heirAvatarIcon">ğŸ‘¶</div>
        </div>

        <div class="heir-info-panel">
            <div class="heir-name-title">
                <span id="heirTitle">çš‡é•¿å­</span> Â· <span id="heirName">é“è›‹</span>
                <span style="font-size:12px; font-weight:normal; margin-left:5px;">(<span id="heirAgeDisplay">0å²</span>)</span>
            </div>
            <div class="stat-grid">
                <div>æ™ºæ…§ <div class="stat-bar-bg"><div class="stat-bar-fill fill-wisdom" id="statWisdom" style="width:10%"></div></div></div>
                <div>ä½“é­„ <div class="stat-bar-bg"><div class="stat-bar-fill fill-fitness" id="statFitness" style="width:10%"></div></div></div>
                <div>é­…åŠ› <div class="stat-bar-bg"><div class="stat-bar-fill fill-charm" id="statCharm" style="width:10%"></div></div></div>
                <div>çˆ¶å› <span style="float:right; font-weight:bold;" id="heirFatherDisplay">æŸæŸ</span></div>
            </div>
        </div>

        <div class="heir-bio-box" id="heirBioText">
            â³ æ­£åœ¨è¯»å–ä¸œå®«èµ·å±…æ³¨...
        </div>

        <div class="heir-actions" id="heirActionBtns">
            <button class="heir-btn" onclick="interactHeir('educate')">ğŸ“– æ•™å¯¼å­¦ä¸š</button>
            <button class="heir-btn" onclick="interactHeir('play')">ğŸª é™ªä¼´æ¸¸ç©</button>
            <button class="heir-btn" onclick="interactHeir('scold')">ğŸ˜  ä¸¥å‰è®­è¯«</button>
        </div>
        <div class="heir-actions" id="heirGraduateBtnArea" style="display:none; border-top:none; padding-top:0;">
             <button class="heir-btn graduate" style="grid-column: span 3;" onclick="graduateHeir()">ğŸ“ èµåºœæˆå®¶ (å­˜æ¡£å¹¶è„±ç¦»)</button>
        </div>

    </div>
</div>

<div class="modal-overlay" id="travelModal" style="z-index: 12000;">
    <div class="modal">
        <div class="travel-header">
            <div>
                <span style="background:#d4af37; color:#000; padding:2px 6px; border-radius:4px; font-size:12px; margin-right:8px;" id="travelSeasonTag">æ˜¥</span>
                <span id="travelMapName">åœ°å›¾</span>
            </div>
            <div>
                <button onclick="changeSeason()" style="font-size:12px; padding:4px 8px; background:#555; color:#fff; border:none; cursor:pointer; border-radius:4px;">ğŸŒ¸ æ¢å­£</button>
                <button onclick="document.getElementById('travelModal').classList.remove('active')" style="color:#fff; border:none; background:none; font-size:24px; cursor:pointer; margin-left:10px;">Ã—</button>
            </div>
        </div>
        
        <div class="travel-body">
            <div class="travel-sidebar" id="locationList">
                </div>

            <div class="travel-map-view">
                <img id="travelBgImg" class="travel-bg" src="">
                
                <div class="travel-event-box" id="travelEventResult">
                    <h3 style="color:#d4af37; margin-bottom:10px;">ğŸ“œ æ¸¸å†å¥‡é‡</h3>
                    <div id="travelEventText" style="font-size:14px; line-height:1.6; text-align:left; min-height:60px; margin-bottom:15px;"></div>
                    <button onclick="closeTravelEvent()" style="padding:8px 30px; background:#d4af37; border:none; color:white; border-radius:20px; font-weight:bold; cursor:pointer;">æœ•çŸ¥é“äº†</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="cardCreatorModal" style="z-index: 11000;">
    <div class="modal" style="width: 95%; max-width: 1000px; height: 95vh; padding: 0; display: flex; flex-direction: column; background: #fcfcfc;">
        
        <div style="padding: 12px 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight: 800; color: #333; font-size: 16px; display:flex; align-items:center; gap:8px;">
                ğŸ¨ åˆ›é€ è€…å·¥åŠ <span style="font-size:10px; background:#6c5ce7; color:white; padding:1px 6px; border-radius:4px;">Max</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="small-btn" onclick="toggleGuideModal()" style="background:#fff0f5; color:#d66a80; border:1px solid #ffb7c5;">â“ æ•™ç¨‹</button>
                <button class="small-btn" onclick="importCardFile()" style="background:#fff; border:1px solid #ccc; color:#555;">ğŸ“‚ è¯»å–</button>
                <input type="file" id="importCardInput" accept=".json,.png" style="display:none" onchange="handleCardImport(this)">
                <button class="small-btn" onclick="exportTavernCard()" style="background: #00b894; color: white; border: none; font-weight:bold;">ğŸ’¾ å¯¼å‡º</button>
<button class="small-btn" onclick="togglePresetModal()" style="background:#fff0f5; color:#d66a80; border:1px solid #ffb7c5;">ğŸ”“ ç ´é™(é¢„è®¾)</button>

<button class="small-btn" onclick="forceOpenAdvisor()" style="background:#e0c3fc; color:#6c5ce7; border:1px solid #a29bfe; font-weight:bold;">ğŸ§  å¬å”¤å†›å¸ˆ</button>

                <button class="close-modal" onclick="closeAndResetCreator()" style="position: static;">Ã—</button>

            </div>
        </div>

        <div style="flex: 1; overflow: hidden; display: flex; flex-direction: row;" id="creatorBody">
            
            <div style="width: 300px; background: #fff; border-right: 1px solid #eee; padding: 15px; overflow-y: auto; flex-shrink: 0;">
                
                <div style="display:flex; gap:15px; align-items:center; margin-bottom:15px;">
                    <div style="width: 70px; height: 70px; border-radius: 15px; border: 2px dashed #ddd; overflow: hidden; position: relative; cursor: pointer;" onclick="document.getElementById('cardAvatarInput').click()">
                        <img id="cardAvatarPreview" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                        <div id="cardAvatarHint" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; color: #ddd;">ğŸ“·</div>
                    </div>
                    <div style="flex:1;">
                        <input type="file" id="cardAvatarInput" accept="image/*" style="display: none;" onchange="handleCardAvatar(this)">
                        <input type="text" id="cardName" placeholder="è§’è‰²åå­—..." style="width:100%; font-weight:bold; font-size:14px; padding:5px; border:1px solid #eee; border-radius:5px; outline:none;" oninput="updatePreviewUI()">
                    </div>
                </div>

                <div class="wizard-box">
    <div class="tag-group-title" id="title_identity" onclick="editWizardTitle('identity')">
        1. èº«ä»½/ç§æ— (ç‚¹å‡»æ”¹å)
    </div>
    <div style="text-align:right; margin-bottom:5px;">
        <span class="add-tag-btn" onclick="addCustomWizardTag('identity')">+åŠ æ ‡ç­¾</span>
    </div>
    <div class="tag-select-container" id="tagGroupIdentity"></div>

    <div class="tag-group-title" id="title_personality" onclick="editWizardTitle('personality')">
        2. æ€§æ ¼ç‰¹ç‚¹ (ç‚¹å‡»æ”¹å)
    </div>
    <div style="text-align:right; margin-bottom:5px;">
        <span class="add-tag-btn" onclick="addCustomWizardTag('personality')">+åŠ æ ‡ç­¾</span>
    </div>
    <div class="tag-select-container" id="tagGroupPersonality"></div>

    <div class="tag-group-title" id="title_trope" onclick="editWizardTitle('trope')">
        3. èŒç‚¹/å±æ€§ (ç‚¹å‡»æ”¹å)
    </div>
    <div style="text-align:right; margin-bottom:5px;">
        <span class="add-tag-btn" onclick="addCustomWizardTag('trope')">+åŠ æ ‡ç­¾</span>
    </div>
    <div class="tag-select-container" id="tagGroupTrope"></div>
</div>

<div style="margin-top:10px; padding:10px; background:#f0f9ff; border:1px solid #b3e5fc; border-radius:8px; display:flex; gap:10px;">
    <button class="small-btn" onclick="openSaveManager()" style="flex:1; background:#fff; color:#0288d1; border:1px solid #0288d1; font-weight:bold;">ğŸ’¾ å­˜æ¡£/è¯»æ¡£</button>
    <button class="small-btn" onclick="finishAndClear()" style="flex:1; background:#fff; color:#d32f2f; border:1px solid #d32f2f; font-weight:bold;">ğŸ å®Œç»“æ¸…ç©º</button>
</div>


<div id="refineArea_wizard" style="display:none; margin-top:10px; background:#f0f0f0; padding:8px; border-radius:8px;">
    <div style="display:flex; gap:5px;">
        <input type="text" id="refineInput_wizard" class="visual-input" placeholder="å“ªé‡Œä¸æ»¡æ„ï¼Ÿ(å¦‚: å†å‚²å¨‡ä¸€ç‚¹)" style="width:100%;">
        <button onclick="refineResult('wizard')" style="background:#a29bfe; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; white-space:nowrap;">ğŸ”„ è®©å®ƒæ”¹</button>
    </div>
</div>

              

            <div style="flex: 1; display: flex; flex-direction: column; background: #fafafa;">
                
                <div style="display: flex; background: #fff; padding: 5px 10px; border-bottom: 1px solid #eee; overflow-x: auto;">
                    <button class="card-tab active" onclick="switchCardTab('preview')">ğŸ‘ï¸ é¢„è§ˆ</button>
                    <button class="card-tab" onclick="switchCardTab('regex')">ğŸ¨ å‰ç«¯</button>
                    <button class="card-tab" onclick="switchCardTab('world')">ğŸŒ ä¸–ç•Œä¹¦</button> 
<button class="card-tab" onclick="switchCardTab('stats')">ğŸ“Š å±æ€§(é€»è¾‘)</button>
<button class="card-tab" onclick="switchCardTab('advanced')">âš™ï¸ é«˜çº§</button>
<button class="card-tab" onclick="switchCardTab('playtest')">ğŸ® è¯•ç©(è´¨æ£€)</button>
                    <button class="card-tab" onclick="switchCardTab('source')">ğŸ“ æºç </button>
                </div>

                <div style="flex: 1; padding: 15px; overflow-y: auto;">
                    
                    <div id="tab-preview" class="card-tab-content active">
    <div class="section-intro">
        <b>ğŸ‘ï¸ è¿™ä¸€é¡µç”¨æ¥å¡«æ ¸å¿ƒè®¾å®šï¼š</b><br>
        1. <b>å¼€åœºç™½</b>ï¼šè§’è‰²å¯¹ä½ è¯´çš„ç¬¬ä¸€å¥è¯ã€‚<br>
        2. <b>è¯¦ç»†è®¾å®š</b>ï¼šè§’è‰²çš„å¤–è²Œã€èº«ä¸–ã€å–œå¥½ç­‰æ ¸å¿ƒæè¿°ã€‚<br>
        ä¸Šæ–¹æ‰‹æœºæ¡†ä¼šå®æ—¶é¢„è§ˆç¬¬ä¸€å¥è¯çš„æ•ˆæœã€‚
    </div>
    <div class="chat-preview-container">...</div> 
   <div style="background:white; padding:15px; border-radius:10px; border:1px solid #eee;">
    <div style="background:#f0f9ff; padding:8px; border-radius:8px; margin-bottom:10px; border:1px dashed #a29bfe; display:flex; gap:5px; flex-wrap:wrap; align-items:center;">
    <span style="font-size:11px; color:#555; font-weight:bold;">ğŸ§© æ’å…¥å˜é‡:</span>
    
    <button class="small-btn" onclick="insertVar('{{user}}')" title="ä»£æŒ‡ç©å®¶åå­—">ğŸ‘¤ {{user}}</button>
    <button class="small-btn" onclick="insertVar('{{char}}')" title="ä»£æŒ‡è§’è‰²åå­—">ğŸ¤– {{char}}</button>
    <button class="small-btn" onclick="insertVar('{{original}}')" title="åŸå§‹å†…å®¹">ğŸ“„ {{original}}</button>
    <button class="small-btn" onclick="insertVar('{{random}}')" title="éšæœºå†…å®¹">ğŸ² {{random}}</button>
    
    <span style="font-size:10px; color:#999; margin-left:auto; cursor:help;" title="è¿™äº›æ˜¯é…’é¦†çš„é­”æ³•å’’è¯­ï¼Œå¡«å…¥åé…’é¦†ä¼šè‡ªåŠ¨æ›¿æ¢æˆåå­—æˆ–å†…å®¹ï¼Œé˜²æ­¢å¡ç‰‡æŠ¥é”™">â“ è¯´æ˜</span>
</div>


    <label style="font-size:12px; font-weight:bold; color:#555; display:block;">
        ğŸ’¬ å¼€åœºç™½ (First Message)
        <span class="add-tag-btn" onclick="autoGenFirstMes()" style="float:right; margin-top:0;">âœ¨ AI å†™å¼€åœº</span>
    </label>
    <textarea id="cardFirstMes" class="card-textarea" style="height:100px; margin-top:5px; margin-bottom:15px;" oninput="updatePreviewUI()" placeholder="è§’è‰²å¯¹ä½ è¯´çš„ç¬¬ä¸€å¥è¯..."></textarea>

<div id="refineArea_firstMes" style="display:none; margin-top:5px; background:#f0f0f0; padding:8px; border-radius:8px;">
    <div style="display:flex; gap:5px;">
        <input type="text" id="refineInput_firstMes" class="visual-input" placeholder="æ€ä¹ˆæ”¹ï¼Ÿ(å¦‚: å†æ’©ä¸€ç‚¹ã€ç”¨ç–‘é—®å¥ç»“å°¾)" style="width:100%;">
        <button onclick="refineResult('firstMes')" style="background:#a29bfe; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; white-space:nowrap;">ğŸ”„ è®©å®ƒæ”¹</button>
    </div>
</div>

    <label style="font-size:12px; font-weight:bold; color:#555; display:block;">
        ğŸ“ è¯¦ç»†è®¾å®š (Description) 
        <span class="add-tag-btn" onclick="autoGenDesc()" style="float:right; margin-top:0;">âœ¨ AI å†™è®¾å®š</span>
    </label>
    <textarea id="cardDesc" class="card-textarea" style="height:200px; margin-top:5px;" placeholder="AI ç”Ÿæˆçš„å†…å®¹ä¼šå¡«åœ¨è¿™é‡Œ..."></textarea>
</div>

<div id="refineArea_desc" style="display:none; margin-top:5px; background:#f0f0f0; padding:8px; border-radius:8px;">
    <div style="display:flex; gap:5px;">
        <input type="text" id="refineInput_desc" class="visual-input" placeholder="å“ªé‡Œä¸æ»¡æ„ï¼Ÿ(å¦‚: å†ç—…å¨‡ä¸€ç‚¹ã€åŠ ä¸€æ®µå…³äºçœ¼ç›çš„æå†™)" style="width:100%;">
        <button onclick="refineResult('desc')" style="background:#a29bfe; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; white-space:nowrap;">ğŸ”„ è®©å®ƒæ”¹</button>
    </div>
</div>


</div>

                    <div id="tab-regex" class="card-tab-content">
                        <div style="background:#fff; padding:15px; border-radius:10px; border:1px solid #ddd; margin-bottom:15px;">
                            
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                                <div style="font-weight:800; color:#333; font-size:14px;">ğŸ› ï¸ è„šæœ¬ç±»å‹ï¼š</div>
                                <div style="display:flex; gap:10px;">
                                    <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                                        <input type="radio" name="regexType" value="simple" checked onclick="switchRegexUI('simple')"> 
                                        <span>ğŸ§© ç®€å•æ›¿æ¢</span>
                                    </label>
                                    <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                                        <input type="radio" name="regexType" value="frontend" onclick="switchRegexUI('frontend')"> 
                                        <span style="color:#6c5ce7; font-weight:bold;">ğŸ¨ å‰ç«¯ç¾åŒ– (HTML)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="uiSimpleMode">
                                <div class="visual-regex-row">
                                    <span style="font-size:12px;">æŠŠ</span>
                                    <input type="text" id="simplePattern" class="visual-input" placeholder="ä¾‹: (æ€è€ƒ)">
                                    <span style="font-size:12px;">æ›¿æ¢ä¸º</span>
                                    <input type="text" id="simpleReplace" class="visual-input" placeholder="ä¾‹: ğŸ’­">
                                </div>
                                <div style="text-align:right;">
                                    <button onclick="addSimpleRegex()" style="background:#00b894; color:white; border:none; padding:6px 15px; border-radius:5px; cursor:pointer;">â• æ·»åŠ è§„åˆ™</button>
                                </div>
                            </div>

                            <div id="uiFrontendMode" style="display:none;">
                                <div style="background:linear-gradient(135deg, #fdfbfb 0%, #f6f8f9 100%); padding:15px; border-radius:12px; border:1px solid #e0e0e0; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,0.02);">
                                    <label style="font-size:13px; font-weight:bold; color:#6c5ce7; display:flex; align-items:center; gap:5px;">
                                        ğŸ¤– AI å»ºç­‘å¸ˆ <span style="font-size:10px; background:#fab1a0; color:white; padding:1px 6px; border-radius:4px;">æ‡’äººä¸“ç”¨</span>
                                    </label>
                                    <div style="display:flex; gap:8px; margin:10px 0; flex-wrap:wrap;">
                                        <button onclick="fillAiPrompt('åšä¸€ä¸ªç²‰è‰²çš„åŠé€æ˜çŠ¶æ€æ ï¼ŒåŒ…å«å¿ƒæƒ…ã€ä½“åŠ›å’Œå¥½æ„Ÿåº¦')" class="snippet-btn">ğŸ“Š ç²‰è‰²çŠ¶æ€æ </button>
                                        <button onclick="fillAiPrompt('åšä¸€ä¸ªèµ›åšæœ‹å…‹é£æ ¼çš„é€šä¿¡é¢æ¿ï¼Œè“ç»¿è‰²éœ“è™¹å…‰')" class="snippet-btn">ğŸ¦¾ èµ›åšé¢æ¿</button>
                                        <button onclick="fillAiPrompt('æŠŠæ–‡å­—å˜æˆæ°”æ³¡æ ·å¼ï¼Œåƒå¾®ä¿¡èŠå¤©è®°å½•é‚£æ ·')" class="snippet-btn">ğŸ’¬ å¾®ä¿¡æ°”æ³¡</button>
                                    </div>
                                    <div style="display:flex; gap:8px;">
                                        <input type="text" id="aiCodePrompt" class="visual-input" placeholder="æˆ–è€…è‡ªå·±å†™ï¼šæƒ³è¦ä»€ä¹ˆæ ·çš„ç•Œé¢ï¼Ÿ" style="flex:1; padding:10px; font-size:13px;">
                                        <button onclick="generateFrontendCode()" id="btnGenCode" style="background:linear-gradient(135deg, #6c5ce7, #a29bfe); color:white; border:none; padding:0 20px; border-radius:8px; cursor:pointer; font-weight:bold;">âœ¨ ä¸€é”®ç”Ÿæˆ</button>
                                    </div>
                                </div>

<div id="refineArea_frontend" style="display:none; margin-top:10px; border-top:1px dashed #ccc; padding-top:10px;">
    <div style="display:flex; gap:5px;">
        <input type="text" id="refineInput_frontend" class="visual-input" placeholder="å“ªé‡Œä¸å¯¹ï¼Ÿ(å¦‚: èƒŒæ™¯æ¢æˆé»‘è‰²)" style="flex:1;">
        <button onclick="refineResult('frontend')" style="background:#a29bfe; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer; white-space:nowrap;">ğŸ”„ è®©å®ƒæ”¹</button>
    </div>
</div>

                                <div style="border-top:1px dashed #ddd; padding-top:15px;">
                                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                                        <div style="flex:1;">
                                            <label style="font-size:12px; font-weight:bold; color:#e06c75;">è§¦å‘æ­£åˆ™ (AIè‡ªåŠ¨å¡«)</label>
                                            <input type="text" id="frontPattern" class="code-input" placeholder="ç­‰å¾…ç”Ÿæˆ..." style="background:#2d2d2d; color:#e06c75; font-weight:bold;">
                                        </div>
                                        <div style="width:120px;">
                                            <label style="font-size:12px; color:#666;">è„šæœ¬åç§°</label>
                                            <input type="text" id="frontName" class="visual-input" placeholder="ç­‰å¾…ç”Ÿæˆ...">
                                        </div>
                                    </div>
                                    <label style="font-size:12px; font-weight:bold; color:#98c379;">
    ä»£ç  (AIè‡ªåŠ¨å†™) 
    <button class="zoom-btn" onclick="toggleFullscreen('frontReplace')">ğŸ”­ å…¨å±ç¼–è¾‘</button>
</label>
                                    <textarea id="frontReplace" class="html-editor-area" placeholder="è¿™é‡Œä¼šæ˜¾ç¤º AI å†™å¥½çš„ä»£ç ..."></textarea>
                                    <div style="text-align:right; margin-top:10px;">
                                        <button onclick="addFrontendRegex()" style="background:#00b894; color:white; border:none; padding:10px 25px; border-radius:8px; font-weight:bold; cursor:pointer;">ğŸš€ æ³¨å…¥è„šæœ¬</button>
                                    </div>

<div id="refineArea_frontend" style="display:none; margin-top:10px; border-top:1px dashed #ddd; padding-top:10px;">
    <div style="display:flex; gap:5px;">
        <input type="text" id="refineInput_frontend" class="visual-input" placeholder="æ”¹é¢œè‰²ï¼Ÿæ”¹å¤§å°ï¼Ÿå‘Šè¯‰æˆ‘..." style="flex:1;">
        <button onclick="refineResult('frontend')" style="background:#a29bfe; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer; white-space:nowrap;">ğŸ”„ è®©å®ƒæ”¹</button>
    </div>
</div>

                                </div>
                            </div>
                        </div>

                        <div id="regexListArea" style="margin-bottom:20px;"></div>
                        
                        <div class="regex-playground">
                            <div class="playground-title">
                                <span>ğŸ§ª æ¸²æŸ“å®éªŒå®¤ (Render Lab)</span>
                                <span style="font-size:10px; color:#aaa;">è¾“å…¥è§¦å‘è¯ï¼Œå³åˆ»é¢„è§ˆæ•ˆæœ</span>
                            </div>
                            <textarea id="regexTestInput" class="test-box" oninput="runRegexTest()" placeholder="ä¾‹ï¼šè¾“å…¥ [STATS] çœ‹çœ‹çŠ¶æ€æ ä¼šä¸ä¼šå‡ºç°..." style="min-height:60px;"></textarea>
                            <div id="regexTestOutput" class="render-preview-box">ç­‰å¾…æ¸²æŸ“...</div>
                        </div>
                    </div>

                    <div id="tab-world" class="card-tab-content">
                        <div style="background:linear-gradient(135deg, #e0f7fa 0%, #e0ffff 100%); padding:12px; border-radius:10px; border:1px solid #b2ebf2; margin-bottom:15px;">
                            <label style="font-size:12px; font-weight:bold; color:#006064;">ğŸ¤– AI ä¸–ç•Œæ¶æ„å¸ˆ</label>
                            <div style="display:flex; gap:8px; margin-top:5px;">
                                <input type="text" id="aiWorldPrompt" class="visual-input" placeholder="ä¾‹ï¼šåˆ›å»ºä¸€ä¸ª'ç«ç„°é­”æ³•'æ¡ç›®ï¼Œå†…å®¹æ˜¯çº¢è‰²çš„é­”æ³•ç‰¹æ•ˆä»£ç ..." style="flex:1;">
                                <button onclick="generateWorldEntry()" id="btnGenWorld" style="background:#00bcd4; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">âœ¨ ç”Ÿæˆæ¡ç›®</button>
</div>

<div id="refineArea_world" style="display:none; margin-top:10px; border-top:1px dashed #b2ebf2; padding-top:10px;">
    <div style="display:flex; gap:5px;">
        <input type="text" id="refineInput_world" class="visual-input" placeholder="æ€ä¹ˆæ”¹ï¼Ÿ(å¦‚: è§¦å‘è¯åŠ ä¸ªç«çƒ)" style="flex:1;">
        <button onclick="refineResult('world')" style="background:#00bcd4; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">ğŸ”„ è®©å®ƒæ”¹</button>
    </div>
</div>


                            <div style="margin-top:8px; display:flex; gap:5px;">
                                <button onclick="fillWorldPrompt('ç”Ÿæˆä¸€ä¸ªã€å¸å›½åœ°å›¾ã€‘æ¡ç›®ï¼Œå†…å®¹æ˜¯ä¸€å¼ å¥½çœ‹çš„åœ°å›¾å›¾ç‰‡HTML')" class="snippet-btn">ğŸ—ºï¸ åœ°å›¾æ¡ç›®</button>
                                <button onclick="fillWorldPrompt('ç”Ÿæˆä¸€ä¸ªã€ç«çƒæœ¯ã€‘æ¡ç›®ï¼Œå†…å®¹æ˜¯çˆ†ç‚¸ç‰¹æ•ˆçš„HTMLä»£ç ')" class="snippet-btn">ğŸ”¥ ç‰¹æ•ˆæ¡ç›®</button>
                            </div>
                        </div>

                        <div class="world-container">
                            <div class="world-list">
                                <div onclick="addWorldEntry()" style="padding:10px; text-align:center; cursor:pointer; color:#00b894; font-weight:bold; border-bottom:1px solid #eee;">+ æ–°å»ºæ¡ç›®</div>
                                <div id="worldEntryList"></div>
                            </div>
                            <div class="world-editor" id="worldEditorArea" style="display:none;">
                                <div style="display:flex; gap:10px; margin-bottom:10px;">
                                    <div style="flex:1;">
                                        <span class="wi-label">æ¡ç›®åç§°</span>
                                        <input type="text" id="wiComment" class="visual-input" oninput="updateCurrentEntry()">
                                    </div>
                                    <div style="flex:1;">
                                        <span class="wi-label">è§¦å‘å…³é”®è¯ (é€—å·åˆ†éš”)</span>
                                        <input type="text" id="wiKeys" class="visual-input" oninput="updateCurrentEntry()">
                                    </div>
                                </div>
                               

<div style="background:#f0f4c3; padding:8px; border-radius:8px; margin-bottom:10px; border:1px solid #dce775; display:flex; flex-wrap:wrap; gap:10px;">
    <div style="flex:1; min-width:80px;">
        <span class="wi-label">ä½ç½® (Position)</span>
        <select id="wiPosition" class="visual-input" onchange="updateCurrentEntry()" style="width:100%; padding:2px;">
            <option value="1">1 - è¿™é‡Œçš„ä¸Šé¢ (Before Char)</option>
            <option value="0">0 - è¿™é‡Œçš„ä¸Šé¢ (Before User)</option>
            <option value="2">2 - è¿™é‡Œçš„ä¸‹é¢ (After Char)</option>
            <option value="3">3 - è¿™é‡Œçš„ä¸‹é¢ (After User)</option>
            <option value="4">4 - ç³»ç»ŸæŒ‡ä»¤å‰ (Top)</option>
        </select>
    </div>
    <div style="flex:1; min-width:60px;">
        <span class="wi-label">æ‰«ææ·±åº¦ (Depth)</span>
        <input type="number" id="wiDepth" class="visual-input" value="4" onchange="updateCurrentEntry()" placeholder="é»˜è®¤4">
    </div>
    <div style="flex:1; min-width:60px;">
        <span class="wi-label">é¢„ç®— (Budget)</span>
        <input type="number" id="wiBudget" class="visual-input" value="500" onchange="updateCurrentEntry()" placeholder="Token">
    </div>
</div>


 <span class="wi-label">
    å†…å®¹ (Content)
    <button class="zoom-btn" onclick="toggleFullscreen('wiContent')">ğŸ”­ å…¨å±ç¼–è¾‘</button>
</span>

                                <textarea id="wiContent" class="html-editor-area" style="flex:1;" oninput="updateCurrentEntry()"></textarea>
                                <div style="text-align:right; margin-top:5px;">
                                    <button onclick="deleteCurrentEntry()" style="background:#ff7675; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ğŸ—‘ï¸ åˆ é™¤</button>
                                </div>
                            </div>
                            <div id="worldEmptyState" style="flex:1; display:flex; align-items:center; justify-content:center; color:#ccc; font-size:12px;">ğŸ‘ˆ è¯·å…ˆæ–°å»ºä¸€ä¸ªæ¡ç›®</div>
                        </div>
                    </div>

                   
<div id="tab-advanced" class="card-tab-content">
    <div class="section-intro">
        <b>âš™ï¸ è¿›é˜¶å¾®è°ƒ (ä¸æ‡‚å¯ä¸å¡«)ï¼š</b><br>
        è¿™é‡Œç”¨äºæ§åˆ¶ AI çš„è¯´è¯é£æ ¼å’Œé€»è¾‘ï¼Œæ™®é€šç©å®¶åªéœ€å…³æ³¨å‰ä¸¤é¡µå³å¯ã€‚
    </div>
    
    <label style="font-size:12px; color:#666; font-weight:bold;">å¯¹è¯æ ·æœ¬ (Example)</label>
    <span class="input-hint">æ•™ AI æ€ä¹ˆè¯´è¯ã€‚æ ¼å¼ï¼š&lt;START&gt;\n{{char}}: ä½ å¥½å‘€ï¼\n{{user}}: ä½ å¥½ã€‚</span>
    <textarea id="cardMesExample" class="card-textarea" style="height:150px;"></textarea>
    
    <label style="font-size:12px; color:#666; margin-top:10px; display:block; font-weight:bold;">ä¸–ç•Œè§‚ (Scenario)</label>
    <span class="input-hint">å½“å‰æ‰€å¤„çš„ç¯å¢ƒã€èƒŒæ™¯æ•…äº‹æˆ–ç‰¹æ®Šè§„åˆ™ã€‚</span>
    <textarea id="cardScenario" class="card-textarea" style="height:100px;"></textarea>
    
    <label style="font-size:12px; color:#666; margin-top:10px; display:block; font-weight:bold;">æ·±åº¦è®¾å®š (Depth Prompt)</label>
    <span class="input-hint">ç»™ AI æ¨¡å‹çš„ç³»ç»ŸæŒ‡ä»¤ï¼Œæ‹¥æœ‰æœ€é«˜ä¼˜å…ˆçº§ã€‚</span>
    <textarea id="cardNote" oninput="syncStatToNote()" class="card-textarea" style="height:150px;"></textarea>
</div>

<div id="tab-stats" class="card-tab-content">
    <div class="section-intro">
        <b>ğŸ“Š æ¸¸æˆé€»è¾‘æ§åˆ¶å°ï¼š</b><br>
        è¿™é‡Œå®šä¹‰è§’è‰²çš„æ•°å€¼ç³»ç»Ÿï¼ˆå¥½æ„Ÿã€ä½“åŠ›ã€é‡‘é’±ç­‰ï¼‰å’Œæ¸¸æˆè§„åˆ™ã€‚<br>
        è¿™äº›å†…å®¹ä¼šè¢«å†™å…¥ <b>æ·±åº¦è®¾å®š (Depth Prompt)</b>ï¼Œå¼ºè¿« AI æ‰§è¡Œã€‚
    </div>

    <div style="background:linear-gradient(135deg, #fff7e6 0%, #fffbe6 100%); padding:12px; border-radius:10px; border:1px solid #ffeaa7; margin-bottom:15px;">
        <label style="font-size:12px; font-weight:bold; color:#d46b08;">ğŸ¤– AI é€»è¾‘ç­–åˆ’å¸ˆ</label>
        <div style="display:flex; gap:8px; margin-top:5px;">
            <input type="text" id="aiStatPrompt" class="visual-input" placeholder="ä¾‹ï¼šè®¾è®¡ä¸€å¥—'é»‘åŒ–å€¼'ç³»ç»Ÿï¼Œæ•°å€¼è¶Šé«˜è¯´è¯è¶Šç–¯ç‹‚..." style="flex:1;">
            <button onclick="generateStatLogic()" id="btnGenStat" style="background:#f39c12; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">âœ¨ ç”Ÿæˆè§„åˆ™</button>
        </div>
        
        <div id="refineArea_stat" style="display:none; margin-top:8px; border-top:1px dashed #ffeaa7; padding-top:8px;">
            <div style="display:flex; gap:5px;">
                <input type="text" id="refineInput_stat" class="visual-input" placeholder="å“ªé‡Œä¸å¯¹ï¼Ÿ(å¦‚: è§„åˆ™å¤ªå¤æ‚äº†ï¼Œç®€åŒ–ä¸€ç‚¹)" style="flex:1;">
                <button onclick="refineResult('stat')" style="background:#e67e22; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer; white-space:nowrap;">ğŸ”„ è®©å®ƒæ”¹</button>
            </div>
        </div>
    </div>

    <div style="display:flex; align-items:center; gap:5px; margin-bottom:10px; padding-bottom:10px; border-bottom:1px dashed #eee;">
        <span style="font-size:11px; color:#999;">âš¡ å¿«é€Ÿæ·»åŠ å˜é‡:</span>
        <input type="text" id="statKey" placeholder="å±æ€§å" style="width:70px; padding:5px; border:1px solid #eee;">
        <input type="number" id="statVal" placeholder="0" style="width:50px; padding:5px; border:1px solid #eee;">
        <button class="small-btn" onclick="addStatToDesc()" style="background:#fff; border:1px solid #ccc;">â•</button>
    </div>

    <label style="font-size:12px; font-weight:bold; color:#555;">ğŸ“œ å½“å‰é€»è¾‘è„šæœ¬ (ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æ·±åº¦è®¾å®š)</label>
    <textarea id="statEditor" oninput="syncStatToNote()" class="card-textarea" style="height:350px; font-family:monospace; color:#444;" placeholder="[Dynamic Stats System]..."></textarea>
    

<div id="statGuide" class="code-guide-box" style="display:none;">
    ğŸ’¡ è¿™é‡Œä¼šæ˜¾ç¤ºä»£ç çš„è¯¦ç»†è§£è¯»ï¼Œæ•™ä½ å¦‚ä½•ä¿®æ”¹...
</div>


    <div style="font-size:10px; color:#aaa; margin-top:5px;">
        ğŸ’¡ æç¤ºï¼šè¿™é‡Œçš„å†…å®¹å®é™…ä¸Šå°±æ˜¯â€œé«˜çº§â€é¡µé¢çš„â€œæ·±åº¦è®¾å®šâ€ã€‚
    </div>
</div>

<div id="tab-playtest" class="card-tab-content">
    <div class="section-intro">
        <b>ğŸ•µï¸ å‡ºå‚è´¨æ£€å°ï¼š</b><br>
        è¿™é‡Œæ¨¡æ‹Ÿäº†é…’é¦†ç¯å¢ƒã€‚ç‚¹å‡»â€œå¼€å§‹æµ‹è¯•â€ï¼Œç³»ç»Ÿä¼šæ‰“åŒ…ä½ çš„<b>äººè®¾ã€æ­£åˆ™ã€ä¸–ç•Œä¹¦ã€é€»è¾‘è„šæœ¬</b>ã€‚<br>
        ä½ å¯ä»¥å°è¯•è§¦å‘ç‰¹æ•ˆæˆ–æ•°å€¼å˜åŒ–ï¼Œç¡®è®¤æ— è¯¯åå†å¯¼å‡ºã€‚
    </div>
    
    <div style="margin-bottom:10px; text-align:right;">
        <button class="small-btn" onclick="startPlaytest()" style="background:#00b894; color:white; font-weight:bold;">â–¶ï¸ è½½å…¥/é‡ç½®æµ‹è¯•</button>
    </div>

    <div id="playtestArea" class="playtest-container">
        <div style="background:#fff; padding:8px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold; font-size:12px; color:#555;">ğŸ”´ æ¨¡æ‹Ÿç»ˆç«¯</span>
            <button class="zoom-btn" onclick="toggleFullscreen('playtestArea')">ğŸ”­ å…¨å±æ²‰æµ¸</button>
        </div>
        
        <div id="testChatBox" class="playtest-chat">
            <div style="text-align:center; color:#999; margin-top:50px;">ç‚¹å‡»ä¸Šæ–¹â€œè½½å…¥æµ‹è¯•â€å¼€å§‹...</div>
        </div>
        
        <div style="padding:10px; background:#fff; display:flex; gap:10px;">
            <textarea id="testInput" placeholder="è¯•ç€è¯´ä¸€å¥è¯ï¼Œæˆ–è€…æ˜¯è§¦å‘è¯..." style="flex:1; height:40px; padding:5px; border:1px solid #ccc; border-radius:5px; resize:none;" onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendTestMsg();}"></textarea>
            <button onclick="sendTestMsg()" style="width:60px; background:#6c5ce7; color:white; border:none; border-radius:5px; cursor:pointer;">å‘é€</button>
        </div>
    </div>
</div>


                    <div id="tab-source" class="card-tab-content">
                        <div style="margin-bottom:10px; font-size:12px; color:#aaa;">âš ï¸ æœ€ç»ˆç”Ÿæˆçš„ JSONï¼Œä¸“ä¸šäººå£«å¯ç›´æ¥ä¿®æ”¹ã€‚</div>
                        <textarea id="jsonSource" class="card-textarea" style="height:300px; font-family:monospace;"></textarea>
                        <button onclick="applySourceCode()" style="width:100%; margin-top:5px; padding:10px; background:#e17055; color:white; border:none; border-radius:5px;">åº”ç”¨æºç ä¿®æ”¹</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="guide-modal" id="guideModal" style="display:none; z-index:13000;">
    <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:bold; color:#6c5ce7;">ğŸ“˜ åˆ›é€ è€…æ‰‹å†Œ (å¤§å¸ˆç‰ˆ)</span>
        <button onclick="toggleGuideModal()" style="border:none; background:none; font-size:20px; cursor:pointer;">Ã—</button>
    </div>
    <div class="guide-content">
        <h3>1. ä»€ä¹ˆæ˜¯â€œå¤§å‹å‰ç«¯å¡â€ï¼Ÿ</h3>
        <p>æ™®é€šå¡åªæœ‰æ–‡å­—ã€‚<b>å¤§å‹å¡</b>èƒ½è®©é…’é¦†é‡Œå‡ºç°æ¸¸æˆç•Œé¢ã€åŠ¨æ€ç«‹ç»˜ã€çŠ¶æ€æ ã€ç”šè‡³å°æ¸¸æˆï¼<br>åŸç†æ˜¯åˆ©ç”¨æ­£åˆ™æ›¿æ¢ï¼ŒæŠŠ AI è¾“å‡ºçš„ç‰¹å®šå…³é”®è¯ï¼ˆå¦‚ <code>[SHOW_HP]</code>ï¼‰ç¬é—´å˜æˆå¤æ‚çš„ HTML ä»£ç ã€‚</p>
        
        <h3>2. å¦‚ä½•ç”¨ AI å¸®ä½ å†™ä»£ç ï¼Ÿ(æ ¸å¿ƒåŠŸèƒ½)</h3>
        <p>ä½ ä¸éœ€è¦æ‡‚ç¼–ç¨‹ï¼Œåªè¦ä¼šæè¿°ï¼</p>
        <p><b>ç¬¬ä¸€æ­¥ï¼š</b> åˆ‡æ¢åˆ°<b>â€œğŸ¨ å‰ç«¯ç¾åŒ–â€</b>æ¨¡å¼ã€‚</p>
        <p><b>ç¬¬äºŒæ­¥ï¼š</b> åœ¨â€œğŸ¤– AI å¸®ä½ å†™ä»£ç â€æ¡†é‡Œè¾“å…¥éœ€æ±‚ã€‚ä¾‹å¦‚ï¼š<br>
        <code>åšä¸€ä¸ªåŠé€æ˜çš„æ‚¬æµ®é¢æ¿ï¼Œé‡Œé¢æ˜¾ç¤ºâ€œå¥½æ„Ÿåº¦â€å’Œâ€œé»‘åŒ–å€¼â€ï¼Œç”¨ç²‰è‰²å’Œé»‘è‰²è¿›åº¦æ¡ï¼Œå­—ä½“è¦å¯çˆ±ã€‚</code></p>
        <p><b>ç¬¬ä¸‰æ­¥ï¼š</b> ç‚¹å‡»ç”Ÿæˆã€‚AI ä¼šè‡ªåŠ¨æŠŠ HTML/CSS ä»£ç å†™å¥½å¡«å…¥ç¼–è¾‘å™¨ã€‚</p>
        <p><b>ç¬¬å››æ­¥ï¼š</b> è®¾ç½®ä¸€ä¸ªè§¦å‘è¯ï¼ˆæ­£åˆ™ï¼‰ã€‚æ¯”å¦‚ <code>/\[STATUS\]/g</code>ã€‚</p>
        <p><b>ç¬¬äº”æ­¥ï¼š</b> åœ¨ä¸‹é¢çš„é»‘è‰²å®éªŒå®¤é‡Œè¾“å…¥ <code>[STATUS]</code>ï¼Œè§è¯å¥‡è¿¹ï¼</p>

        <h3>3. å¦‚ä½•è®©è§’è‰²è‡ªåŠ¨è§¦å‘ï¼Ÿ</h3>
        <p>åœ¨â€œâš™ï¸ é«˜çº§ -> æ·±åº¦è®¾å®šâ€é‡Œï¼Œå†™ä¸Šç³»ç»ŸæŒ‡ä»¤ï¼š<br>
        <code>[System Note: Always append "[STATUS]" at the end of every message.]</code><br>
        è¿™æ ·è§’è‰²æ¯æ¬¡è¯´å®Œè¯ï¼Œéƒ½ä¼šè‡ªåŠ¨å¸¦ä¸Šè¿™ä¸ªçŠ¶æ€æ ï¼</p>

<h3>1. ğŸŒ ä¸–ç•Œä¹¦ (World Info) æ€ä¹ˆç©ï¼Ÿ</h3>
        <p>ä¸–ç•Œä¹¦æ˜¯é…’é¦†çš„â€œå¤–æŒ‚è¯å…¸â€ã€‚å½“èŠå¤©ä¸­å‡ºç°<b>è§¦å‘è¯</b>æ—¶ï¼Œå¯¹åº”çš„å†…å®¹ä¼šè¢«è‡ªåŠ¨æ³¨å…¥ç»™ AIã€‚</p>
        <div class="guide-tip">
            <b>ğŸ”¥ é«˜çº§ç©æ³•ï¼šå‰ç«¯ä¸–ç•Œä¹¦</b><br>
            ä½ å¯ä»¥åœ¨å†…å®¹ (Content) é‡Œå†™ HTML ä»£ç ï¼<br>
            æ¯”å¦‚ï¼š<br>
            <b>è§¦å‘è¯ï¼š</b> <code>ç«çƒæœ¯, fireball</code><br>
            <b>å†…å®¹ï¼š</b> <code>&lt;div class="explosion-effect"&gt;ğŸ’¥&lt;/div&gt;</code><br>
            <b>æ•ˆæœï¼š</b> åªè¦æœ‰äººè¯´å‡ºâ€œç«çƒæœ¯â€ï¼Œå±å¹•ä¸Šå°±ä¼šçœŸçš„ç‚¸ä¸€ä¸‹ï¼
        </div>
        <p><b>æ“ä½œæ­¥éª¤ï¼š</b></p>
        <ol>
            <li>åˆ‡æ¢åˆ°<b>â€œğŸŒ ä¸–ç•Œä¹¦â€</b>æ ‡ç­¾é¡µã€‚</li>
            <li>åœ¨ä¸Šæ–¹ç´«è‰²æ¡†è¾“å…¥æè¿°ï¼Œå¦‚ï¼šâ€œåšä¸€ä¸ªå«ã€å†°å°åƒé‡Œã€‘çš„æŠ€èƒ½ï¼Œè§¦å‘è¯æ˜¯å†°å°ï¼Œå†…å®¹æ˜¯è“è‰²çš„å…¨å±å†»ç»“ç‰¹æ•ˆä»£ç â€ã€‚</li>
            <li>ç‚¹å‡»ç”Ÿæˆï¼ŒAI ä¼šè‡ªåŠ¨å†™å¥½ HTML å’Œ CSSã€‚</li>
            <li>å¯¼å‡ºå¡ç‰‡ï¼Œäº«å—æ¸¸æˆèˆ¬çš„ä½“éªŒã€‚</li>
        </ol>

        <h3>2. ğŸ—£ï¸ ä¸æ»¡æ„ï¼Ÿè®© AI é‡å†™ï¼(æ–°åŠŸèƒ½)</h3>
        <p>AI ç¬¬ä¸€æ¬¡ç”Ÿæˆçš„å†…å®¹ä¸æ»¡æ„ï¼Ÿåˆ«æ€¥ç€åˆ ï¼</p>
        <p>1. ç”Ÿæˆå®Œæ¯•åï¼ŒæŒ‰é’®ä¸‹æ–¹ä¼šå‡ºç°ä¸€ä¸ª<b>â€œä¿®æ”¹æ„è§æ¡†â€</b>ã€‚</p>
        <p>2. è¾“å…¥ä½ çš„è¦æ±‚ï¼Œä¾‹å¦‚ï¼š<br>
           - <i>â€œæŠŠèƒŒæ™¯æ”¹æˆé»‘è‰²çš„â€</i><br>
           - <i>â€œæ€§æ ¼å†ç—…å¨‡ä¸€ç‚¹â€</i><br>
           - <i>â€œç‰¹æ•ˆæ—¶é—´å¤ªçŸ­äº†ï¼ŒåŠ é•¿åˆ°3ç§’â€</i></p>
        <p>3. ç‚¹å‡»<b>â€œğŸ”„ è®©å®ƒæ”¹â€</b>ï¼ŒAI ä¼šåœ¨åŸæœ‰åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œç›´åˆ°ä½ æ»¡æ„ä¸ºæ­¢å†ç‚¹â€œæ³¨å…¥â€æˆ–â€œä¿å­˜â€ã€‚</p>

        <h3>3. ğŸ¨ å¤§å‹å‰ç«¯å¡åˆ¶ä½œæ€è·¯</h3>
        <p>åˆ©ç”¨<b>â€œå‰ç«¯è„šæœ¬â€</b> + <b>â€œä¸–ç•Œä¹¦â€</b> + <b>â€œæ·±åº¦è®¾å®šâ€</b> ä¸‰è€…ç»“åˆï¼š</p>
        <ul>
            <li><b>æ·±åº¦è®¾å®šï¼š</b> è§„å®š AI åœ¨ç‰¹å®šæ—¶åˆ»è¾“å‡ºå…³é”®è¯ï¼ˆå¦‚ <code>[SHOW_MAP]</code>ï¼‰ã€‚</li>
            <li><b>å‰ç«¯è„šæœ¬ï¼š</b> å°† <code>[SHOW_MAP]</code> æ›¿æ¢ä¸º HTML å®¹å™¨ã€‚</li>
            <li><b>ä¸–ç•Œä¹¦ï¼š</b> å­˜å‚¨å…·ä½“çš„ HTML ç´ æã€‚</li>
        </ul>

    </div>
</div>


    <div id="presetModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:600px; max-width:95vw; height:450px; max-height:80vh; background:#fff; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.2); z-index:15000; padding:0; border:2px solid #ffb7c5; overflow:hidden; flex-direction:column;">

    <div style="padding:15px; background:#fff0f5; border-bottom:1px solid #ffb7c5; display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:bold; color:#d66a80; font-size:16px;">ğŸ”“ å’’è¯­åº“ç®¡ç† (Prompt Manager)</span>
        <span onclick="togglePresetModal()" style="cursor:pointer; font-size:20px;">Ã—</span>
    </div>

    <div style="flex:1; display:flex; overflow:hidden;">
        
        <div style="flex:1; border-right:1px solid #eee; display:flex; flex-direction:column; padding:10px;">
            <div style="font-weight:bold; color:#e17055; margin-bottom:10px;">ğŸ”¥ ç ´é™ (Jailbreak)</div>
            <div style="font-size:10px; color:#999; margin-bottom:5px;">ç”¨äºè§£é™¤AIé™åˆ¶ï¼Œå¼ºè¡Œå¬ä»¤</div>
            <div id="jailbreakListContainer" style="flex:1; overflow-y:auto; background:#fff5f0; border-radius:5px; padding:5px;">
                </div>
            <button class="small-btn" style="width:100%; margin-top:5px; background:#e17055; color:white; border:none;" onclick="document.getElementById('importJBInput').click()">ğŸ“‚ å¯¼å…¥ç ´é™ (JSON)</button>
            <input type="file" id="importJBInput" accept=".json,.JSON" style="display:none" onchange="handleImport(this, 'jailbreak')">
        </div>

        <div style="flex:1; display:flex; flex-direction:column; padding:10px;">
            <div style="font-weight:bold; color:#6c5ce7; margin-bottom:10px;">ğŸ“œ é¢„è®¾ (Preset)</div>
            <div style="font-size:10px; color:#999; margin-bottom:5px;">ç”¨äºè®¾å®šæ ¼å¼ã€æ–‡é£ã€è§†è§’</div>
            <div id="presetListContainer" style="flex:1; overflow-y:auto; background:#f3f0ff; border-radius:5px; padding:5px;">
                </div>
            <button class="small-btn" style="width:100%; margin-top:5px; background:#6c5ce7; color:white; border:none;" onclick="document.getElementById('importPresetInput').click()">ğŸ“‚ å¯¼å…¥é¢„è®¾ (JSON)</button>
            <input type="file" id="importPresetInput" accept=".json,.JSON" style="display:none" onchange="handleImport(this, 'preset')">
        </div>

    </div>
</div>


<div id="aiAdvisorBox" class="float-widget" style="display:none; position:fixed; bottom:100px; left:20px; width:260px; height:350px; background:#fff; border:2px solid #6c5ce7; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.2); z-index:12000; flex-direction:column; overflow:hidden;">
    <div style="background:#6c5ce7; color:white; padding:10px; font-weight:bold; display:flex; justify-content:space-between; cursor:move;" id="advisorHeader">
   
        <span>ğŸ§  å†›å¸ˆé”¦å›Š</span>
        

 <span style="flex:1; cursor:move; display:flex; align-items:center; gap:5px; user-select:none;">
        <span onclick="toggleAdvisorCollapse(); event.stopPropagation();" 
              style="cursor:pointer; padding:5px 8px; background:rgba(255,255,255,0.2); border-radius:10px; font-size:12px;" 
              title="æŠ˜å /å±•å¼€">
            (â–¼)
        </span>
    </span>
    
    <span onclick="document.getElementById('aiAdvisorBox').style.display='none'" 
          style="cursor:pointer; font-size:18px; padding:0 5px;" 
          title="éšè—">
        Ã—
    </span>
</div>

    <div id="advisorChat" style="flex:1; overflow-y:auto; padding:10px; background:#f3f0ff; font-size:12px;">
        <div class="ai-bubble" style="background:#fff;">ä¸»å…¬ï¼Œè¯·å…ˆå®Œå–„äººè®¾ï¼Œå¾…æˆ‘ä¸ºæ‚¨å‡ºè°‹åˆ’ç­–ã€‚</div>
    </div>
    <div style="padding:8px; background:#fff; border-top:1px solid #eee; display:flex;">
        <input type="text" id="advisorInput" placeholder="å’Œå†›å¸ˆè®¨è®º..." style="flex:1; border:none; outline:none; font-size:12px;">
        <button onclick="sendAdvisorMsg()" style="background:#6c5ce7; color:white; border:none; border-radius:5px; padding:2px 8px; cursor:pointer;">â</button>
    </div>
</div>

<div id="saveManagerModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:320px; max-height:80vh; background:#fff; border-radius:10px; box-shadow:0 20px 60px rgba(0,0,0,0.3); z-index:16000; display:flex; flex-direction:column; overflow:hidden; border:2px solid #0288d1;">
    <div style="padding:15px; background:#0288d1; color:white; font-weight:bold; display:flex; justify-content:space-between;">
        <span>ğŸ“¦ æ¡£æ¡ˆå®¤</span>
        <span onclick="document.getElementById('saveManagerModal').style.display='none'" style="cursor:pointer;">Ã—</span>
    </div>
    
    <div style="padding:10px; background:#e1f5fe; text-align:center; border-bottom:1px solid #b3e5fc;">
        <button class="primary-btn" onclick="createNewSave()" style="width:100%; background:#0288d1; border:none;">â• æ–°å»ºå­˜æ¡£ (å½“å‰è¿›åº¦)</button>
    </div>

    <div id="saveSlotList" style="flex:1; overflow-y:auto; padding:10px; background:#f9f9f9;">
        </div>
</div>


    <div id="deleteBar" class="delete-bar">
        <button class="delete-btn-cancel" onclick="toggleBatchDeleteMode()">å–æ¶ˆ</button>
        <button class="delete-btn-confirm" onclick="confirmBatchDelete()">ğŸ—‘ï¸ åˆ é™¤ (<span id="deleteCount">0</span>)</button>
    </div>

<button id="fullscreenExitBtn" onclick="exitFullscreen()">âŒ é€€å‡ºå…¨å±</button>

    <script>

// ================= ğŸ›¡ï¸ ä¼ å›½ç‰çº (æ§åˆ¶å°ç‰ˆæƒå£°æ˜) =================
console.log(
    "%cğŸ›‘ è­¦å‘Šï¼%c\nè¿™æ˜¯ã€é•¿æ˜¥è·¯å¥³çš‡ã€‘çš„çš‡å®¶ç§äº§ï¼\nç¦æ­¢æŠ„è¢­ã€ç›—ç”¨æˆ–æœªç»å…è®¸çš„äºŒæ”¹ã€‚\nOriginal Design by Empress Changchunlu.", 
    "color: red; font-size: 30px; font-weight: bold; text-shadow: 2px 2px 0px black;",
    "color: #d66a80; font-size: 16px; font-weight: bold;"
);
console.log("%cğŸ‘‘ ä¾µæƒå¿…ç©¶ ğŸ‘‘", "background: #ffb7c5; color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px;");

// ================= âœ… æ”¾åœ¨ <script> çš„ç¬¬ä¸€è¡Œ =================
// å®šä¹‰å…¨å±€å˜é‡ï¼Œé˜²æ­¢ä¸‹é¢çš„å‡½æ•°æ‰¾ä¸åˆ°å®ƒ
var aiConfig = JSON.parse(localStorage.getItem('my_ai_config')) || {
    persona: 'eunuch',
    customPrompt: '',
    apiUrl: 'https://api.openai.com/v1',
    apiKey: '',
    model: 'gpt-3.5-turbo'
};

        // ================= ğŸ”’ å®‰å…¨ç³»ç»Ÿ (AuthSystem) =================
        const auth = {
            mode: 'login', type: null, step: 0, tempSecret: null, inputBuffer: '', failCount: 0,
            
            init: function() {
                this.createSakura();
                this.showView('view-landing');
            },

            proceedFromLanding: function() {
                const savedType = localStorage.getItem('magic_auth_type');
                const savedSecret = localStorage.getItem('magic_auth_secret');
                if (!savedType || !savedSecret) { this.showView('view-welcome'); } 
                else {
                    this.mode = 'login';
                    this.type = savedType;
                    if (this.type === 'pin') this.showView('view-pin'); else this.showView('view-gesture');
                    if (this.type === 'gesture') setTimeout(() => this.initGesture(), 100);
                }
            },

            createSakura: function() {
                const container = document.getElementById('sakuraContainer');
                for(let i=0; i<15; i++) {
                    const el = document.createElement('div');
                    el.className = 'sakura';
                    el.style.left = Math.random() * 100 + '%';
                    el.style.animationDuration = (Math.random() * 5 + 5) + 's';
                    el.style.animationDelay = Math.random() * 5 + 's';
                    container.appendChild(el);
                }
            },
            showView: function(id) {
                ['view-landing', 'view-welcome', 'view-pin', 'view-gesture', 'view-setup-question', 'view-recovery'].forEach(v => {
                    const el = document.getElementById(v); if(el) el.style.display = 'none';
                });
                document.getElementById(id).style.display = 'block';
                if(id === 'view-pin') this.updatePinDots();
            },
            toast: function(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg; t.style.opacity = 1;
                setTimeout(() => t.style.opacity = 0, 2000);
            },
            startSetup: function(type) {
                this.mode = 'setup';
                this.type = type; this.step = 1; this.inputBuffer = '';
                if (type === 'pin') {
                    document.getElementById('pinTitle').textContent = 'è®¾ç½®å¯†ç ';
                    document.getElementById('pinSub').textContent = 'è¯·è¾“å…¥4ä½æ–°å¯†ç '; this.showView('view-pin');
                } else {
                    document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ';
                    document.getElementById('gestSub').textContent = 'è¯·ç»˜åˆ¶è§£é”å›¾æ¡ˆ'; this.showView('view-gesture'); setTimeout(() => this.initGesture(), 100);
                }
            },
            inputPin: function(num) {
                if (this.inputBuffer.length < 4) {
                    this.inputBuffer += num;
                    this.updatePinDots();
                    if (this.inputBuffer.length === 4) setTimeout(() => this.submitPin(), 200);
                }
            },
            clearPin: function() { this.inputBuffer = ''; this.updatePinDots(); },
            updatePinDots: function() { const dots = document.getElementById('pinDots').children;
                for(let i=0; i<4; i++) { if(i < this.inputBuffer.length) dots[i].classList.add('active'); else dots[i].classList.remove('active'); } },
            submitPin: function() {
                const val = this.inputBuffer;
                this.inputBuffer = ''; this.updatePinDots();
                if (this.mode === 'setup') {
                    if (this.step === 1) { this.tempSecret = val;
                        this.step = 2; document.getElementById('pinTitle').textContent = 'å†æ¬¡ç¡®è®¤'; document.getElementById('pinSub').textContent = 'è¯·å†æ¬¡è¾“å…¥ä»¥ç¡®è®¤'; } 
                    else { if (val === this.tempSecret) this.finishPasswordSetup(val);
                    else { this.toast('ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´'); this.step = 1; document.getElementById('pinTitle').textContent = 'è®¾ç½®å¯†ç '; } }
                } else if (this.mode === 'login') { if (val === localStorage.getItem('magic_auth_secret')) this.unlockApp();
                else this.handleFail(); }
            },
            
            initGesture: function() {
                const canvas = document.getElementById('gestureCanvas');
                const ctx = canvas.getContext('2d'); 
                const area = document.getElementById('gestureArea');
                let isDrawing = false; let path = [];
                canvas.width = 300;
                canvas.height = 300; 

                const getPoint = (x, y) => { 
                    const rect = area.getBoundingClientRect();
                    const rx = x - rect.left; const ry = y - rect.top;
                    const col = Math.floor(rx / (300/3));
                    const row = Math.floor(ry / (300/3));
                    if(col>=0 && col<3 && row>=0 && row<3) return row*3 + col;
                    return -1; 
                };
                const draw = (curX, curY) => {
                    ctx.clearRect(0, 0, 300, 300);
                    ctx.strokeStyle = '#ffb7c5'; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                    if(path.length > 0) { 
                        ctx.beginPath();
                        const p0 = getCenter(path[0]); ctx.moveTo(p0.x, p0.y); 
                        for(let i=1; i<path.length; i++) { const p = getCenter(path[i]); ctx.lineTo(p.x, p.y); } 
                        if(curX !== null) ctx.lineTo(curX, curY);
                        ctx.stroke(); 
                    }
                    document.querySelectorAll('.point-inner').forEach((el, i) => { if(path.includes(i)) el.classList.add('active'); else el.classList.remove('active'); });
                };
                const getCenter = (idx) => { const row = Math.floor(idx/3), col = idx%3;
                    return { x: col*100 + 50, y: row*100 + 50 }; };
                
                const start = (e) => { e.preventDefault(); e.stopPropagation(); isDrawing = true; path = []; move(e); };
                const move = (e) => { 
                    if(!isDrawing) return;
                    e.preventDefault(); e.stopPropagation();
                    let cx, cy; if(e.touches) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; } else { cx = e.clientX; cy = e.clientY; }
                    const rect = area.getBoundingClientRect();
                    const idx = getPoint(cx, cy); if(idx !== -1 && !path.includes(idx)) path.push(idx); 
                    draw(cx - rect.left, cy - rect.top); 
                };
                const end = (e) => { 
                    if(!isDrawing) return;
                    e.preventDefault(); isDrawing = false; draw(null, null); 
                    if(path.length < 3) { this.toast('ç‚¹å¤ªå°‘å•¦'); path = []; draw(null,null); return; } 
                    const code = path.join('');
                    if(this.mode === 'setup') { 
                        if(this.step === 1) { this.tempSecret = code;
                            this.step = 2; document.getElementById('gestTitle').textContent = 'å†æ¬¡ç»˜åˆ¶'; setTimeout(()=>{ path=[]; draw(null,null); }, 500);
                        } 
                        else { if(code === this.tempSecret) this.finishPasswordSetup(code);
                        else { this.toast('ä¸ä¸€è‡´'); this.step = 1; document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ'; setTimeout(()=>{ path=[]; draw(null,null); }, 500);
                        } } 
                    } else if(this.mode === 'login') { 
                        if(code === localStorage.getItem('magic_auth_secret')) this.unlockApp();
                        else { this.handleFail(); setTimeout(()=>{ path=[]; draw(null,null); }, 500); } 
                    } 
                };
                const newCanvas = canvas.cloneNode(true); canvas.parentNode.replaceChild(newCanvas, canvas);
                newCanvas.addEventListener('mousedown', start); newCanvas.addEventListener('touchstart', start, {passive: false});
                window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive: false});
                window.addEventListener('mouseup', end);
                window.addEventListener('touchend', end);

                this.resetGesture = () => { this.step = 1; this.tempSecret = null; document.getElementById('gestTitle').textContent = 'ç»˜åˆ¶å›¾æ¡ˆ'; document.getElementById('gestResetBtn').style.display = 'none';
                    path = []; draw(null,null); };
            },

            finishPasswordSetup: function(secret) { this.finalSecret = secret; this.finalType = this.type; this.showView('view-setup-question'); },
            saveSecurityQuestion: function() { const q = document.getElementById('secQuestion').value.trim();
                const a = document.getElementById('secAnswer').value.trim(); if(!q || !a) { this.toast('è¯·å¡«å†™å®Œæ•´'); return; } localStorage.setItem('magic_auth_type', this.finalType); localStorage.setItem('magic_auth_secret', this.finalSecret); localStorage.setItem('magic_auth_q', q); localStorage.setItem('magic_auth_a', a); this.toast('è®¾ç½®æˆåŠŸï¼');
                this.unlockApp(); },
            handleFail: function() { this.failCount++; this.toast('å¯†ç é”™è¯¯');
                if(this.failCount >= 3) { if(this.type==='pin') document.getElementById('pinForgotBtn').style.display='block'; else document.getElementById('gestForgotBtn').style.display='block'; } },
            showRecovery: function() { const q = localStorage.getItem('magic_auth_q');
                if(!q) { this.toast('æœªè®¾ç½®é—®é¢˜'); return; } document.getElementById('recoveryQText').textContent = q; this.showView('view-recovery'); },
            checkRecovery: function() { if(document.getElementById('recoveryAnswer').value.trim() === localStorage.getItem('magic_auth_a')) { localStorage.removeItem('magic_auth_type');
                localStorage.removeItem('magic_auth_secret'); this.toast('éªŒè¯æˆåŠŸï¼Œè¯·é‡è®¾'); setTimeout(() => location.reload(), 1000); } else this.toast('é”™è¯¯'); },
            unlockApp: function() { document.getElementById('lockScreen').style.transition = 'opacity 0.5s';
                document.getElementById('lockScreen').style.opacity = 0; setTimeout(() => { document.getElementById('lockScreen').style.display = 'none'; document.getElementById('appContainer').style.display = 'block'; if(!window.appInitialized) { initOriginalApp(); window.appInitialized = true; } }, 500);
            }
        };

        // ================= ğŸ“± åº”ç”¨æ ¸å¿ƒé€»è¾‘ =================
        let items = [];
        let draftResources = []; 
        let currentTags = [];
        let isEditing = false;
        let editingIndex = -1;
        let viewingIndex = -1;
        let galleryIndex = 0;
        let currentLuckyIndex = -1;

        const TYPES = ['é»˜è®¤', 'äººç‰©å¡', 'ä¸–ç•Œä¹¦', 'QRç ', 'é¢„è®¾', 'é¢„è®¾æ­£åˆ™', 'æ’ä»¶', 'è‡ªå®šä¹‰'];
        const PLACEHOLDER_IMG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23ffe6eb'/%3E%3Ctext x='50' y='50' fill='%23ffb7c5' text-anchor='middle' dy='.3em'%3Eæ— å›¾%3C/text%3E%3C/svg%3E";
        const DEFAULT_MUSIC = "https://files.catbox.moe/btptsb.mp3";
        const DB_NAME = 'MyMagicDB';
        const STORE_NAME = 'items';
        let db;

        window.onload = function() { auth.init(); };
        function initOriginalApp() { initDB().then(() => { loadFromDB(); migrateFromLocalStorage(); initLayout(); }); initMusic(); initDraggable(); }
        function initDB() { return new Promise((resolve, reject) => { const request = indexedDB.open(DB_NAME, 1); request.onerror = () => reject(); request.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true }); }; request.onsuccess = (e) => { db = e.target.result; resolve(); }; }); }
        async function loadFromDB() { const tx = db.transaction(STORE_NAME, 'readonly');
            const req = tx.objectStore(STORE_NAME).getAll(); req.onsuccess = () => { items = req.result.sort((a, b) => new Date(b.date) - new Date(a.date)); renderGrid(items);
            renderNavPanel(); }; }
        async function saveItemToDB(item) { return new Promise((resolve, reject) => { const tx = db.transaction(STORE_NAME, 'readwrite'); const store = tx.objectStore(STORE_NAME); const req = item.id ? store.put(item) : store.add(item); req.onsuccess = () => resolve(req.result); req.onerror = () => { alert('ä¿å­˜å¤±è´¥ï¼Œæ–‡ä»¶å¤ªå¤§ï¼Ÿ'); reject(); }; }); }
        async function deleteItemFromDB(id) { const tx = db.transaction(STORE_NAME, 'readwrite'); tx.objectStore(STORE_NAME).delete(id);
            return new Promise(resolve => tx.oncomplete = resolve); }
        function migrateFromLocalStorage() { const old = localStorage.getItem('my_magic_collection_v3');
            if(old) { try { const p = JSON.parse(old); if(p.length > 0 && confirm('å‘ç°æ—§æ•°æ®ï¼Œè¿ç§»å—ï¼Ÿ')) { const tx = db.transaction(STORE_NAME, 'readwrite');
            p.forEach(i => { delete i.id; tx.objectStore(STORE_NAME).add(i); }); tx.oncomplete = () => { alert('è¿ç§»æˆåŠŸï¼'); localStorage.removeItem('my_magic_collection_v3'); loadFromDB(); };
            } } catch(e){} } }

        function renderGrid(dataList) {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            
            if (dataList.length === 0) { 
                container.innerHTML = '<div class="empty-state">ç©ºç©ºçš„...å¿«å»æ·»åŠ å§ï¼</div>';
                return; 
            }

            dataList.forEach((item) => {
                const realIndex = items.indexOf(item);
                const card = document.createElement('div'); 
                
                card.className = 'card';
            
                if (isBatchDeleteMode) {
                    card.classList.add('is-selecting');
                    if (selectedDeleteIds.has(item.id)) {
                        card.classList.add('selected');
                    }
        
                    card.onclick = () => {
                        if (selectedDeleteIds.has(item.id)) {
                            selectedDeleteIds.delete(item.id);
                        } else {
                            selectedDeleteIds.add(item.id);
                        }
                        renderGrid(dataList); 
                        updateDeleteBar();
                    };
                } else {
                    card.onclick = () => openDetailModal(realIndex);
                }

                const images = item.resources.filter(r => r.type === 'image');
                let coverSrc = PLACEHOLDER_IMG; 
                if (images.length > 0) coverSrc = images[Math.min(item.coverIndex||0, images.length-1)].content;
                
                const imgWrapper = document.createElement('div'); 
               // ğŸ‘‡ ä¿®æ”¹åï¼šä¼šè‡ªåŠ¨è¯»å– item.frameStyle å¹¶åŠ ä¸Šå¯¹åº”çš„ CSS ç±»
imgWrapper.className = `card-img-wrapper ${item.frameStyle || ''}`;
                const img = document.createElement('img'); 
                img.src = coverSrc; 
                imgWrapper.appendChild(img);
                
                const content = document.createElement('div'); 
                content.className = 'card-content';
                const title = document.createElement('h3');
                title.className = 'card-title'; 
                title.textContent = item.name;
                content.appendChild(title); 
                
                const tagsDiv = document.createElement('div'); 
                tagsDiv.className = 'tags-container';
                (item.tags||[]).forEach(t => { 
                    const span = document.createElement('span'); 
                    span.className = 'tag-pill'; 
                    span.textContent = t; 
                    tagsDiv.appendChild(span); 
                }); 
                content.appendChild(tagsDiv);
                
                card.appendChild(imgWrapper); 
                card.appendChild(content); 
                container.appendChild(card);
            });
        }

                function switchLayout(mode) {
            const c = document.getElementById('gridContainer');
            c.className = 'grid-container'; // æ¸…é™¤æ—§æ¨¡å¼
            
            // æŒ‰é’®çŠ¶æ€é‡ç½®
            document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active'));

            if (mode === 'shelf') {
                document.querySelector('.layout-btn[title="çºªå¿µå“é™ˆåˆ—å®¤"]').classList.add('active');
                renderShelfView(); // ğŸ‘ˆ è°ƒç”¨ä¸‹é¢æ–°å†™çš„æ¸²æŸ“å‡½æ•°
            } else {
                c.classList.add('mode-' + mode);
                renderGrid(items); // æ¢å¤æ­£å¸¸æ¸²æŸ“
                
                // æ¢å¤æŒ‰é’®é«˜äº®é€»è¾‘
                if(mode==='default') document.querySelector('.layout-btn[title="é»˜è®¤ç½‘æ ¼"]').classList.add('active');
                if(mode==='list') document.querySelector('.layout-btn[title="é•¿åˆ—è¡¨"]').classList.add('active');
                if(mode==='large') document.querySelector('.layout-btn[title="å¤§å›¾æ¨¡å¼"]').classList.add('active');
                if(mode==='mini') document.querySelector('.layout-btn[title="è¿·ä½ æ¨¡å¼"]').classList.add('active');
            }

            localStorage.setItem('my_magic_layout', mode);
            if(mode !== 'shelf') auth.toast('è§†å›¾åˆ‡æ¢æˆåŠŸ âœ¨');
        }

        function initLayout() {
            const mode = localStorage.getItem('my_magic_layout') || 'default';
            switchLayout(mode);
        }

        // --- æŠ½ç­¾é€»è¾‘ ---
        function startLottery() {
            if(items.length === 0) { auth.toast('ç›’å­æ˜¯ç©ºçš„æ€ä¹ˆæŠ½å‘€~'); return; }
            document.getElementById('floatMenu').classList.remove('active');
            const overlay = document.getElementById('lotteryOverlay');
            const gift = document.getElementById('magicGift');
            const result = document.getElementById('lotteryResult');
            overlay.classList.add('active'); result.style.display = 'none'; gift.style.display = 'block'; gift.classList.add('shaking');
            const luckyIndex = Math.floor(Math.random() * items.length);
            currentLuckyIndex = luckyIndex;
            const item = items[luckyIndex];
            document.getElementById('lotteryName').textContent = item.name;
            const images = item.resources.filter(r => r.type === 'image');
            let coverSrc = PLACEHOLDER_IMG; 
            if (images.length > 0) coverSrc = images[Math.min(item.coverIndex||0, images.length-1)].content;
            document.getElementById('lotteryImg').src = coverSrc;
            setTimeout(() => { gift.classList.remove('shaking'); gift.style.display = 'none'; result.style.display = 'flex'; }, 1500);
        }
        function closeLottery() { document.getElementById('lotteryOverlay').classList.remove('active'); }
        function goToLotteryItem() { closeLottery(); if(currentLuckyIndex !== -1) setTimeout(() => openDetailModal(currentLuckyIndex), 300); }

        // --- ğŸŸ¢ å¢å¼ºç‰ˆï¼šå…¨èƒ½æ‰¹é‡å¯¼å…¥ (æ”¯æŒ .jsonl è‡ªåŠ¨è¯†åˆ«) ---
        async function handleBatchImageImport(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            
            auth.toast(`æ­£åœ¨æ¬è¿ ${files.length} ä¸ªæ–‡ä»¶ï¼Œè¯·ç¨ç­‰... ğŸšš`);
            let count = 0;
            for (let f of files) {
                const name = f.name;
                let resourceType = 'file'; 
                let subType = 'é™„ä»¶';
                let content = null;
                if (f.type.startsWith('image/')) {
                    resourceType = 'image';
                    subType = 'é»˜è®¤';
                    content = await readFile(f); 
                } else if (f.name.endsWith('.json') || f.name.endsWith('.jsonl')) { 
                    resourceType = 'json';
                    subType = 'æ•°æ®';
                    content = await readFileText(f);
                } else {
                    resourceType = 'file';
                    subType = 'é™„ä»¶';
                    content = await readFile(f); 
                }

                const newItem = { 
                    name: name, 
                    tags: ['æ‰¹é‡å¯¼å…¥'], 
                    resources: [{ 
                        type: resourceType, 
                        subType: subType, 
                        name: name, 
                        content: content 
                    }], 
                    coverIndex: 0, 
                    date: new Date().toISOString() 
                };
                try { 
                    await saveItemToDB(newItem);
                    count++; 
                } catch(e) { 
                    console.error("æ–‡ä»¶å¤ªå¤§æˆ–ä¿å­˜å¤±è´¥:", e);
                    auth.toast(`âŒ ${name} å¤ªå¤§äº†ï¼Œå­˜ä¸ä¸‹ï¼`);
                }
            }
            loadFromDB();
            auth.toast(`æå®šï¼æˆåŠŸå­˜å…¥äº† ${count} ä¸ªå®è´ï¼âœ¨`);
            input.value = ''; 
        }

        // ================= ğŸ§¹ æ‰¹é‡åˆ é™¤é€»è¾‘ =================

        let isBatchDeleteMode = false;
        let selectedDeleteIds = new Set(); 

        function toggleBatchDeleteMode() {
            isBatchDeleteMode = !isBatchDeleteMode;
            selectedDeleteIds.clear(); 
            updateDeleteBar();
            handleSearch(); 
            
            if(isBatchDeleteMode) {
                auth.toast('è¿›å…¥åˆ é™¤æ¨¡å¼ï¼šè¯·ç‚¹é€‰è¦åˆ é™¤çš„ç›’å­ ğŸ—‘ï¸');
            }
        }

        function updateDeleteBar() {
            const bar = document.getElementById('deleteBar');
            const countSpan = document.getElementById('deleteCount');
            
            if (isBatchDeleteMode) {
                bar.classList.add('active');
                countSpan.textContent = selectedDeleteIds.size;
            } else {
                bar.classList.remove('active');
            }
        }

        async function confirmBatchDelete() {
            if (selectedDeleteIds.size === 0) {
                auth.toast('è¿˜æ²¡é€‰ä»»ä½•ä¸œè¥¿å‘¢~');
                return;
            }
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedDeleteIds.size} ä¸ªç›’å­å—ï¼Ÿæ— æ³•æ¢å¤å“¦ï¼`)) return;
            for (let id of selectedDeleteIds) {
                await deleteItemFromDB(id);
            }

            toggleBatchDeleteMode(); 
            loadFromDB(); 
            auth.toast('æ¸…ç†å®Œæ¯•ï¼å˜å¾—æ¸…çˆ½å¤šå•¦ âœ¨');
        }

        // --- CRUD & UI Helpers ---
        function resetAddModal() { isEditing = false;
            editingIndex = -1; document.getElementById('modalTitle').textContent = 'âœ¨ æ·»åŠ æ–°æ”¶è—'; document.getElementById('itemName').value = ''; 
    document.getElementById('itemMemories').value = ''; // ğŸŸ¢ æ–°å¢ï¼šæ¸…ç©ºå›å¿†å½•
document.getElementById('tagInput').value = ''; document.getElementById('linkInputArea').style.display = 'none'; draftResources = [];
            currentTags = []; renderTagsInput(); renderResourceList(); renderSuggestTags(); }
        function openAddModal() { resetAddModal(); document.getElementById('addModal').classList.add('active'); }
        function openEditMode() { if (viewingIndex === -1) return; isEditing = true;
            editingIndex = viewingIndex; const item = items[editingIndex]; document.getElementById('modalTitle').textContent = 'âœï¸ ç¼–è¾‘ç›’å­å†…å®¹'; document.getElementById('itemName').value = item.name; 
    // ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šå›æ˜¾å›å¿†å½•ï¼ŒæŠŠæ•°ç»„å˜å›å¤šè¡Œæ–‡æœ¬
    document.getElementById('itemMemories').value = (item.memories || []).join('\n');
currentTags = [...(item.tags || [])];
            draftResources = JSON.parse(JSON.stringify(item.resources)); renderTagsInput(); renderResourceList(); renderSuggestTags(); document.getElementById('detailModal').classList.remove('active'); document.getElementById('addModal').classList.add('active'); }
        
        function renderResourceList() {
            const list = document.getElementById('resourceList');
            list.innerHTML = '';
            if(draftResources.length === 0) { list.innerHTML = '<div style="text-align:center; color:#ccc; font-size:12px; padding:20px;">æš‚æ— å†…å®¹</div>'; return; }
            draftResources.forEach((res, idx) => {
                const item = document.createElement('div'); item.className = 'resource-item';
                let p = '';
                if (res.type === 'image') p = `<img src="${res.content}" style="width:100%;height:100%;object-fit:cover">`;
                else if (res.type === 'json') p = 'ğŸ“„';
                else if (res.type === 'link') p = 'ğŸ”—';
                else p = 'ğŸ“';

                const isCustom = !TYPES.includes(res.subType) || res.subType === 'è‡ªå®šä¹‰';
                const selectValue = isCustom ? 'è‡ªå®šä¹‰' : res.subType;
                const customInputValue = (isCustom && res.subType !== 'è‡ªå®šä¹‰') ? res.subType : '';
                const customDisplay = isCustom ? 'inline-block' : 'none';

                let controlsHtml = '';
                if (res.type !== 'link') {
                    let options = '';
                    TYPES.forEach(t => { options += `<option value="${t}" ${selectValue === t ? 'selected' : ''}>${t}</option>`; });
                    controlsHtml = `<div class="resource-controls"><select class="resource-type-select" onchange="handleTypeChange(${idx}, this.value)">${options}</select><input type="text" class="custom-type-input" style="display:${customDisplay}" placeholder="è¾“å…¥ç±»å‹" value="${customInputValue}" onchange="updateCustomType(${idx}, this.value)"></div>`;
                } else {
                    controlsHtml = `<span style="font-size:11px;color:#aaa">é“¾æ¥</span>`;
                }
                item.innerHTML = `<div class="resource-preview">${p}</div><div class="resource-info"><input type="text" class="resource-name-input" value="${res.name}" onchange="updateResourceName(${idx}, this.value)" placeholder="è¯·è¾“å…¥æ–‡ä»¶åç§°">${controlsHtml}</div><button class="btn-remove" onclick="removeDraftResource(${idx})">Ã—</button>`;
                list.appendChild(item);
            });
        }

        function updateResourceName(idx, val) { draftResources[idx].name = val; }
        function handleTypeChange(idx, val) { if (val === 'è‡ªå®šä¹‰') { draftResources[idx].subType = 'è‡ªå®šä¹‰';
            } else { draftResources[idx].subType = val; } renderResourceList(); }
        function updateCustomType(idx, val) { draftResources[idx].subType = val; }
        function removeDraftResource(idx) { draftResources.splice(idx, 1); renderResourceList(); }
        
        async function handleUniversalSelect(input) {
            const files = Array.from(input.files);
            for(let f of files) {
                if (f.type.startsWith('image/')) {
                    const b = await readFile(f);
                    draftResources.push({ type: 'image', subType: 'é»˜è®¤', name: f.name, content: b });
                } else if (f.type === 'application/json' || f.name.endsWith('.json') || f.name.endsWith('.jsonl')) { 
                    const t = await readFileText(f);
                    draftResources.push({ type: 'json', subType: 'é»˜è®¤', name: f.name, content: t });
                } else {
                    const b = await readFile(f);
                    draftResources.push({ type: 'file', subType: 'é™„ä»¶', name: f.name, content: b });
                }
            }
            renderResourceList();
            input.value = '';
        }

        function openLinkInput() { document.getElementById('linkInputArea').style.display = 'block'; }
        function confirmAddLink() { const n = document.getElementById('newLinkName').value.trim(), u = document.getElementById('newLinkUrl').value.trim();
            if(n && u) { draftResources.push({ type: 'link', subType: 'link', name: n, content: u }); renderResourceList(); document.getElementById('newLinkName').value = '';
            document.getElementById('newLinkUrl').value = ''; document.getElementById('linkInputArea').style.display = 'none'; } else alert('è¯·è¾“å…¥åç§°å’Œç½‘å€'); }
        async function saveItem() { const n = document.getElementById('itemName').value.trim();
    // ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šè·å–å¤šè¡Œæ–‡æœ¬ï¼ŒæŒ‰æ¢è¡Œç¬¦åˆ†å‰²æˆæ•°ç»„
    const memRaw = document.getElementById('itemMemories').value;
    const memList = memRaw.split('\n').filter(line => line.trim() !== '');
    // ğŸ‘† ğŸŸ¢ æ–°å¢ç»“æŸ
if (!n) { alert('åå­—ä¸èƒ½ä¸ºç©º'); return; } if (draftResources.length === 0) { alert('ç›’å­ä¸èƒ½ä¸ºç©º'); return;
            } const d = { name: n, tags: [...currentTags], memories: memList, resources: draftResources, coverIndex: 0, date: new Date().toISOString() };
            if (isEditing) { d.id = items[editingIndex].id; d.coverIndex = items[editingIndex].coverIndex; } await saveItemToDB(d); loadFromDB(); handleSearch(); closeAddModal();
        }
        
        function openDetailModal(index) { 
            viewingIndex = index;
            const item = items[index]; document.getElementById('detailName').textContent = item.name; 
const tagsBox = document.getElementById('detailTags'); tagsBox.innerHTML = '';
            (item.tags||[]).forEach(t => { const s = document.createElement('span'); s.className='tag-pill'; s.textContent=t; tagsBox.appendChild(s); }); const images = item.resources.filter(r => r.type === 'image');
            if(images.length === 0) { document.getElementById('galleryArea').style.display = 'none'; document.getElementById('noImgMsg').style.display = 'block'; } else { document.getElementById('galleryArea').style.display = 'block'; document.getElementById('noImgMsg').style.display = 'none';
            galleryIndex = Math.min(item.coverIndex||0, images.length-1); updateGalleryUI(images); 
initHeadpat();
} 
            
            const listContainer = document.getElementById('detailListContainer');
            listContainer.innerHTML = ''; 
            
                // ================= ğŸ‘‡ å¤åˆ¶è¿™æ®µæ›¿æ¢åŸæ¥çš„ forEach å¾ªç¯ ğŸ‘‡ =================
    item.resources.forEach((res, i) => { 
        const row = document.createElement('div'); 
        row.className = 'detail-item'; 
        
        let icon = 'ğŸ“„'; 
        let btn = ''; 
        let lbl = res.subType || 'é™„ä»¶'; 
        
        // é€šç”¨ä¸‹è½½æŒ‰é’®
        const downloadBtn = `<span class="action-link" onclick="downloadResource(${i})">ä¸‹è½½</span>`;

        if (res.type === 'image') { 
            icon = 'ğŸ–¼ï¸'; 
            btn = downloadBtn; 
        } 
        else if (res.type === 'json') { 
            icon = 'ğŸ“œ'; 
            btn = `<span class="action-link" style="background:#e0f7fa;color:#006064;margin-right:5px;" onclick="openReader(${i})">ğŸ“– å¯¹è¯</span>` + downloadBtn; 
        } 
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€å…³é”®ä¿®æ”¹ã€‘å¦‚æœæ˜¯å°è¯´æˆ–txtï¼ŒåŠ ä¸€ä¸ªâ€œé˜…è¯»â€æŒ‰é’® ğŸ‘‡ğŸ‘‡ğŸ‘‡
        else if ((res.type === 'file' && res.name.endsWith('.txt')) || res.subType === 'å°è¯´') { 
            icon = 'ğŸ“˜'; 
            lbl = 'å°è¯´';
            btn = `<span class="action-link" style="background:#fff0f5;color:#d66a80;margin-right:5px;" onclick="openTxtReader(${i})">ğŸ‘ï¸ é˜…è¯»</span>` + downloadBtn; 
        } 
        // ğŸ‘†ğŸ‘†ğŸ‘†ã€å…³é”®ä¿®æ”¹ç»“æŸã€‘ğŸ‘†ğŸ‘†ğŸ‘†
        else if (res.type === 'link') { 
            icon = 'ğŸ”—'; 
            lbl = 'é“¾æ¥'; 
            btn = `<a class="action-link" href="${res.content}" target="_blank">æ‰“å¼€</a>`; 
        } 
        else { 
            icon = 'ğŸ“'; 
            btn = downloadBtn; 
        } 
        
        row.innerHTML = `<div style="display:flex;align-items:center;min-width:0;"><span class="detail-item-type">${lbl}</span><span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${icon} ${res.name}</span></div><div style="flex-shrink:0;margin-left:10px;">${btn}</div>`;
        listContainer.appendChild(row); 
    });
    // ================= ğŸ‘† æ›¿æ¢ç»“æŸ ğŸ‘† =================


            // ğŸ‘‡ ğŸŸ¢ æ–°å¢ï¼šæ¸²æŸ“å°ç« çŠ¶æ€
            renderStampStatus(items[index].stamp);
            
    // ğŸ‘‡ ğŸŸ¢ åœ¨å‡½æ•°æœ€ååŠ è¿™å¥ï¼Œå¼€å§‹æ’­æ”¾åŠ¨ç”»
    startMemoryAnimation(items[index].memories || []);
renderStickyNote(); // âœ… åŠ è¿™ä¸€å¥ï¼Œæ‰“å¼€æ—¶è´´ä¸Šä¾¿ç­¾

// ğŸ‘‡ åŠ ä¸Šè¿™ä¸€è¡Œï¼Œä½ä»½å¾½ç« æ‰ä¼šå‡ºæ¥ï¼
updateRankUI(items[index]); 

// ğŸ‘‡ åŠ ä¸Šè¿™ä¸€è¡Œï¼Œçš‡å—£æŒ‰é’®çš„çŠ¶æ€æ‰ä¼šå¯¹ï¼
updateHeirButtonState();
document.getElementById('detailModal').classList.add('active'); 
renderDetailSouvenirs(index);
        }

                // ================= ğŸ–¼ï¸ æ›´æ–°è¯¦æƒ…é¡µå›¾ç‰‡ (å¸¦æˆ³ä¸€æˆ³åŠŸèƒ½) =================
function updateGalleryUI(images) {
    const container = document.getElementById('galleryArea');
    if (!container) return;
    container.innerHTML = ''; // æ¸…ç©ºæ—§å›¾

    if (!images || images.length === 0) return;

    // ç¡®ä¿ç´¢å¼•ä¸è¶Šç•Œ
    if (galleryIndex >= images.length) galleryIndex = 0;
    if (galleryIndex < 0) galleryIndex = images.length - 1;

    const res = images[galleryIndex];
    
    // 1. åˆ›å»ºå›¾ç‰‡å®¹å™¨ (æ–¹ä¾¿åšå·¦å³åˆ‡æ¢æŒ‰é’®)
    const wrapper = document.createElement('div');
    wrapper.style.position = 'relative';
    wrapper.style.textAlign = 'center';

    // 2. åˆ›å»ºå›¾ç‰‡
    const img = document.createElement('img');
    
    // å¤„ç†å›¾ç‰‡å†…å®¹ (å¦‚æœæ˜¯Base64éœ€è¦è§£ç ï¼Œå¦‚æœæ˜¯é“¾æ¥ç›´æ¥ç”¨)
    let src = res.content;
    if (src.startsWith('data:') && src.includes('base64,')) {
        // æœ‰äº›æ—§æ•°æ®å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œä½†é€šå¸¸ img.src ç›´æ¥åƒ base64
        try { src = decodeURIComponent(escape(window.atob(src.split(',')[1]))); } catch(e) { src = res.content; }
    }
    img.src = src;
    
    // å›¾ç‰‡æ ·å¼
    img.style.maxWidth = '100%';
    img.style.maxHeight = '300px'; // é™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢å¤ªé•¿
    img.style.borderRadius = '10px';
    img.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
    img.style.transition = 'transform 0.1s'; // è®©åŠ¨ç”»æ›´ä¸æ»‘
    img.style.cursor = 'pointer'; // é¼ æ ‡å˜æˆå°æ‰‹

    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€å…³é”®ä»£ç ï¼šæˆ³ä¸€æˆ³åŠ å¥½æ„Ÿã€‘ğŸ‘‡ğŸ‘‡ğŸ‘‡
    img.onclick = function() {
        // 1. åŠ åˆ† (çˆ±æŠš +2)
        if (typeof addFavor === 'function') {
            addFavor(2, "çˆ±æŠš");
        } else {
            console.log("æœªæ‰¾åˆ° addFavor å‡½æ•°");
        }
        
        // 2. éœ‡åŠ¨åé¦ˆ
        if(navigator.vibrate) navigator.vibrate(50);
        
        // 3. Qå¼¹ç¼©æ”¾åŠ¨ç”»
        this.style.transform = "scale(0.95)";
        setTimeout(() => this.style.transform = "scale(1)", 100);
    };
    // ğŸ‘†ğŸ‘†ğŸ‘†ã€å…³é”®ä»£ç ç»“æŸã€‘ğŸ‘†ğŸ‘†ğŸ‘†

    wrapper.appendChild(img);

    // 3. æ·»åŠ å·¦å³ç¿»é¡µæŒ‰é’® (å¦‚æœæœ‰å¤šå¼ å›¾)
    if (images.length > 1) {
        // å·¦æŒ‰é’®
        const prevBtn = document.createElement('button');
        prevBtn.innerText = 'â€¹';
        prevBtn.className = 'gallery-nav-btn'; // ä½ å¯ä»¥ç”¨ä¹‹å‰çš„æ ·å¼
        prevBtn.style.cssText = 'position:absolute; left:0; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.3); color:white; border:none; padding:10px; cursor:pointer; border-radius:0 5px 5px 0;';
        prevBtn.onclick = (e) => { e.stopPropagation(); galleryIndex--; updateGalleryUI(images); };
        
        // å³æŒ‰é’®
        const nextBtn = document.createElement('button');
        nextBtn.innerText = 'â€º';
        nextBtn.style.cssText = 'position:absolute; right:0; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.3); color:white; border:none; padding:10px; cursor:pointer; border-radius:5px 0 0 5px;';
        nextBtn.onclick = (e) => { e.stopPropagation(); galleryIndex++; updateGalleryUI(images); };

        wrapper.appendChild(prevBtn);
        wrapper.appendChild(nextBtn);
        
        // æ˜¾ç¤ºé¡µç 
        const counter = document.createElement('div');
        counter.innerText = `${galleryIndex + 1} / ${images.length}`;
        counter.style.cssText = 'font-size:12px; color:#999; margin-top:5px;';
        container.appendChild(wrapper); // å…ˆæ”¾å›¾
        container.appendChild(counter); // å†æ”¾é¡µç 
    } else {
        container.appendChild(wrapper);
    }
}

        function changeGalleryImage(d) { const images = items[viewingIndex].resources.filter(r => r.type === 'image');
            if(images.length === 0) return; galleryIndex += d; if(galleryIndex >= images.length) galleryIndex = 0;
            if(galleryIndex < 0) galleryIndex = images.length - 1; updateGalleryUI(images); }
        async function setAsCover() { if(viewingIndex === -1) return;
            const item = items[viewingIndex]; item.coverIndex = galleryIndex; await saveItemToDB(item); const images = item.resources.filter(r => r.type === 'image'); updateGalleryUI(images); loadFromDB();
        }
        function downloadCurrentGalleryImg() { const images = items[viewingIndex].resources.filter(r => r.type === 'image');
            if(images.length === 0) return; const cur = images[galleryIndex]; downloadFile(cur.name, cur.content);
        }
        function downloadResource(resIndex) { const res = items[viewingIndex].resources[resIndex]; if(res.type === 'link') return;
            downloadFile(res.name, res.content); }
        function downloadFile(name, content) { const a = document.createElement('a');
            if (content.startsWith('data:')) a.href = content; else { const blob = new Blob([content], {type: 'application/json'}); a.href = URL.createObjectURL(blob);
            } a.download = name; document.body.appendChild(a); a.click(); document.body.removeChild(a); if (!content.startsWith('data:')) URL.revokeObjectURL(a.href);
        }
        function readFile(file) { return new Promise(resolve => { const r = new FileReader(); r.onload = e => resolve(e.target.result); r.readAsDataURL(file); });
        }
        function readFileText(file) { return new Promise(resolve => { const r = new FileReader(); r.onload = e => resolve(e.target.result); r.readAsText(file); });
        }
        
        function handleTagInput(e) { 
            if(e.key==='Enter'){ e.preventDefault();
            manualAddTag(); } 
            if(e.key==='Backspace' && !e.target.value) { currentTags.pop(); renderTagsInput(); } 
        }
        function manualAddTag() {
            const el = document.getElementById('tagInput');
            const v = el.value.trim();
            if(v && !currentTags.includes(v)) { currentTags.push(v); el.value=''; renderTagsInput(); }
            el.focus();
        }

        function renderTagsInput() { const area=document.getElementById('tagInputArea'); const inp=document.getElementById('tagInput'); Array.from(area.children).forEach(c=>c!==inp && area.removeChild(c));
            currentTags.forEach((t,i)=>{ const d=document.createElement('div'); d.className='tag-chip'; d.innerHTML=`${t} <span onclick="currentTags.splice(${i},1);renderTagsInput()" style="cursor:pointer">Ã—</span>`; area.insertBefore(d,inp); });
        }
        function renderSuggestTags() { const all=new Set(); items.forEach(i=>(i.tags||[]).forEach(t=>all.add(t))); const box=document.getElementById('suggestedTags'); box.innerHTML='';
            all.forEach(t=>{ const d=document.createElement('div'); d.className='tag-chip'; d.style.background='#f0f0f0'; d.style.color='#666'; d.style.cursor='pointer'; d.textContent=t; d.onclick=()=>{if(!currentTags.includes(t)){currentTags.push(t);renderTagsInput();}}; box.appendChild(d); });
        }
                        // ================= ğŸ” ä¿®å¤åçš„æœç´¢åŠŸèƒ½ =================
        function handleSearch() {
            // 1. è·å–è¾“å…¥æ¡† (ä¿®æ­£ ID ä¸º mainSearchInput)
            const inputEl = document.getElementById('mainSearchInput');
            
            // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæ‰¾ä¸åˆ°è¾“å…¥æ¡†ï¼Œé»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œé˜²æ­¢æŠ¥é”™å¡æ­»
            const q = inputEl ? inputEl.value.toLowerCase().trim() : "";
            
            const isDeep = document.getElementById('deepSearchCheck').checked; 

            if (!q) {
                renderGrid(items); // æ²¡å­—å°±æ˜¾ç¤ºå…¨éƒ¨
                return;
            }

            const f = items.filter(item => {
                // 1. åŸºç¡€æœç´¢ï¼šæœåå­—å’Œæ ‡ç­¾
                const matchBasic = item.name.toLowerCase().includes(q) || (item.tags || []).some(t => t.toLowerCase().includes(q));
                
                if (matchBasic) return true;

                // 2. æ·±å±‚æœç´¢
                if (isDeep && item.resources) {
                    return item.resources.some(res => {
                        if (res.type === 'json' || res.type === 'file') {
                            return res.content && res.content.toLowerCase().includes(q);
                        }
                        return false;
                    });
                }
                
                return false;
            });

            renderGrid(f);
            
            // æœç´¢ç»“æœæç¤º
            if(isDeep && q && f.length === 0) {
                const emptyState = document.querySelector('.empty-state');
                if(emptyState) emptyState.innerHTML = `ğŸ¤” åœ¨å›å¿†é‡Œæ‰¾äº†ä¸€åœˆï¼Œæ²¡æ‰¾åˆ° "${q}"...`;
            }
        }

        function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }
                function closeAddModal() { 
            document.getElementById('addModal').classList.remove('active'); 
        }
        function closeDetailModal() { 
            document.getElementById('detailModal').classList.remove('active'); 
            viewingIndex = -1; 
            
            // ğŸ‘‡ ğŸŸ¢ å¿…é¡»æ”¾åœ¨è¿™ä¸ªèŠ±æ‹¬å·é‡Œé¢ï¼ ğŸŸ¢ ğŸ‘‡
            stopMemoryAnimation();
        }
        async function deleteCurrentItem() { 
            if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) { 
                const id = items[viewingIndex].id; 
                await deleteItemFromDB(id);
                loadFromDB(); 
                closeDetailModal(); 
            } 
        }
        function exportAllData() { const tx = db.transaction(STORE_NAME, 'readonly');
            const req = tx.objectStore(STORE_NAME).getAll(); req.onsuccess = () => { const blob = new Blob([JSON.stringify(req.result)], {type:'application/json'}); const a = document.createElement('a');
            a.href = URL.createObjectURL(blob); a.download = `å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } }
        function importAllData(el) { const file = el.files[0]; if(!file) return;
            const r = new FileReader(); r.onload = e => { try { const imported = JSON.parse(e.target.result);
            if(Array.isArray(imported)) { const tx = db.transaction(STORE_NAME, 'readwrite'); const store = tx.objectStore(STORE_NAME); imported.forEach(item => { delete item.id; store.add(item); });
            tx.oncomplete = () => { loadFromDB(); alert('å¯¼å…¥æˆåŠŸï¼'); }; } } catch{ alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); } }; r.readAsText(file);
        }
        function initMusic() { const link = localStorage.getItem('my_bgm_link') || DEFAULT_MUSIC;
            const audio = document.getElementById('bgMusic'); audio.src = link; audio.volume = 0.5; document.getElementById('musicLink').value = link;
        }
        function toggleMusic() { const a=document.getElementById('bgMusic'); const b=document.getElementById('playBtn');
            if(a.paused){a.play();b.textContent='â¸';}else{a.pause();b.textContent='â–¶';} }
        function changeVolume(s) { document.getElementById('bgMusic').volume=s.value;
        }
        function updateMusicSrc(v) { if(v){document.getElementById('bgMusic').src=v; localStorage.setItem('my_bgm_link',v);
            document.getElementById('playBtn').textContent='â–¶';} }
              // ğŸ·ï¸ ä¿®å¤åçš„ç›®å½•æ¸²æŸ“å‡½æ•°
        function renderNavPanel() {
            const c = document.getElementById('navPanel');
            if(!c) return;
            
            c.innerHTML = ''; // æ¸…ç©ºå†…å®¹

            const map = {};
            const no = [];
            
            // 1. æ•´ç†æ•°æ®
            items.forEach((it, i) => {
                if (!it.tags || it.tags.length == 0) no.push(i);
                else it.tags.forEach(tag => {
                    if (!map[tag]) map[tag] = [];
                    map[tag].push(i);
                });
            });

            // 2. ç”Ÿæˆ HTML (å…ˆæ”¾æœªåˆ†ç±»ï¼Œå†æ”¾æœ‰æ ‡ç­¾çš„)
            if (no.length) createNavGroup(c, 'ğŸ“‚ æœªåˆ†ç±»', no);
            
            Object.keys(map).sort().forEach(k => {
                createNavGroup(c, `ğŸ·ï¸ ${k}`, map[k]);
            });
            
            // å¦‚æœå®Œå…¨æ²¡å†…å®¹ï¼Œç»™ä¸ªæç¤º
            if(no.length === 0 && Object.keys(map).length === 0) {
                c.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px; font-size:12px;">è¿˜æ²¡åŠ æ ‡ç­¾å‘¢~</div>';
            }
        }

        function createNavGroup(c,t,idx) { const g=document.createElement('div'); g.style.marginBottom='5px'; const h=document.createElement('div'); h.innerHTML=`${t} â–¾`; h.style.cssText='padding:5px;font-size:12px;font-weight:bold;cursor:pointer;color:#555;'; h.onclick=()=>{l.style.display=l.style.display==='none'?'block':'none'};
            const l=document.createElement('div'); l.style.cssText='display:none;padding-left:10px;'; idx.forEach(i=>{ const it=document.createElement('div'); it.textContent=items[i].name; it.style.cssText='font-size:11px;padding:3px;cursor:pointer;color:#888;'; it.onclick=()=>{openDetailModal(i);document.getElementById('floatMenu').classList.remove('active')}; l.appendChild(it); }); g.appendChild(h); g.appendChild(l); c.appendChild(g);
        }

        function initDraggable() {
            const w=document.getElementById('floatWidget'), b=document.getElementById('floatBtn'), m=document.getElementById('floatMenu');
            let isDragging=false, startX, startY, initialLeft, initialTop;
            b.addEventListener('mousedown', s); b.addEventListener('touchstart', s, {passive:false});
            function s(e) { if(e.target.closest('.float-menu'))return; isDragging=false; const c=e.type.includes('mouse')?e:e.touches[0]; startX=c.clientX; startY=c.clientY;
            const r=w.getBoundingClientRect(); initialLeft=r.left; initialTop=r.top; w.style.left=initialLeft+'px'; w.style.top=initialTop+'px'; w.style.bottom='auto'; w.style.right='auto'; if(e.type.includes('mouse')) { document.addEventListener('mousemove', mv); document.addEventListener('mouseup', ed); } else { document.addEventListener('touchmove', mv, {passive:false});
            document.addEventListener('touchend', ed); } }
            function mv(e) { const c=e.type.includes('mouse')?e:e.touches[0];
            const dx=c.clientX-startX, dy=c.clientY-startY; if(Math.abs(dx)>5||Math.abs(dy)>5){ isDragging=true; if(m.classList.contains('active'))m.classList.remove('active'); } if(isDragging){ e.preventDefault(); w.style.left=(initialLeft+dx)+'px'; w.style.top=(initialTop+dy)+'px';
            } }
            function ed() { document.removeEventListener('mousemove',mv); document.removeEventListener('mouseup',ed); document.removeEventListener('touchmove',mv); document.removeEventListener('touchend',ed);
            }
            b.addEventListener('click', (e)=>{ if(isDragging){e.preventDefault();e.stopPropagation();}else{m.classList.toggle('active');} });
            document.addEventListener('click', (e)=>{ if(m.classList.contains('active')&&!w.contains(e.target)){m.classList.remove('active');} });
        }

        // ================= ğŸ“– æ—¶å…‰æ”¾æ˜ å®¤é€»è¾‘ (Reader System - ç¼–è¾‘ & ä¹¦ç­¾å¢å¼ºç‰ˆ) =================

        let readerState = {
            data: [],
            bookmarks: {}, // æ ¼å¼: { floorIndex: "å¤‡æ³¨å†…å®¹" }
            currentPage: 1,
            pageSize: 10,
            totalMessages: 0,
            totalPages: 0,
            resourceIndex: -1 // è®°å½•å½“å‰æ­£åœ¨è¯»å“ªä¸ªæ–‡ä»¶ï¼Œæ–¹ä¾¿ä¿å­˜
        };

        function closeReader() {
            document.getElementById('readerModal').classList.remove('active');
            document.getElementById('bookmarkDrawer').classList.remove('active');
        }

        async function openReader(resIndex) {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            const res = item.resources[resIndex];
            
            readerState.resourceIndex = resIndex;

            let jsonContent;
            try {
                // 1. è§£æå†…å®¹
                if (res.content.startsWith('data:')) {
                    const base64 = res.content.split(',')[1];
                    const decoded = atob(base64);
                    // è§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜
                    const bytes = new Uint8Array(decoded.length);
                    for (let i = 0; i < decoded.length; i++) bytes[i] = decoded.charCodeAt(i);
                    jsonContent = new TextDecoder('utf-8').decode(bytes);
                } else {
                    jsonContent = res.content;
                }

                let chatData = [];
                try {
                    chatData = JSON.parse(jsonContent);
                } catch (e) {
                    // å°è¯• JSONL
                    const lines = jsonContent.split('\n').filter(line => line.trim() !== '');
                    chatData = lines.map(line => JSON.parse(line));
                }

               // æ ‡å‡†åŒ–æ¶ˆæ¯ (ä¿æŒä¸å˜)
                let messages = [];
                if (Array.isArray(chatData)) {
                    messages = chatData;
                } else if (chatData.messages && Array.isArray(chatData.messages)) {
                    messages = chatData.messages;
                }

                if (messages.length === 0) {
                    auth.toast('æ²¡æœ‰æ‰¾åˆ°èŠå¤©è®°å½• ğŸ“œ');
                    return;
                }

                // åŠ è½½ä¹¦ç­¾ (ä¿æŒä¸å˜)
                if (!res.bookmarks) {
                    res.bookmarks = {};
                }
                readerState.bookmarks = res.bookmarks;

                // åˆå§‹åŒ–åˆ†é¡µ
                readerState.data = messages;
                readerState.totalMessages = messages.length;
                readerState.pageSize = 10;
                readerState.totalPages = Math.ceil(messages.length / readerState.pageSize);
                readerState.currentPage = 1;

                document.getElementById('readerTitle').textContent = res.name.replace(/\.jsonl?$/i, '');
                
                renderCurrentPage();
                
                // ğŸŸ¢ æ”¹åŠ¨ï¼šæ‰“å¼€é˜…è¯»å™¨æ—¶ï¼Œå¼ºåˆ¶æ»šåŠ¨åˆ°é¡¶éƒ¨
                document.getElementById('chatContainer').scrollTop = 0; 
                
                document.getElementById('readerModal').classList.add('active');

            } catch (e) {
                console.error(e);
                auth.toast('æ‰“ä¸å¼€...æ ¼å¼å¥½åƒä¸å¯¹ ğŸ˜µ');
            }
        }

              function renderCurrentPage() {
            const container = document.getElementById('chatContainer');
            container.innerHTML = ''; 

            const startIdx = (readerState.currentPage - 1) * readerState.pageSize;
            const endIdx = Math.min(startIdx + readerState.pageSize, readerState.totalMessages);
            const currentMessages = readerState.data.slice(startIdx, endIdx);

            document.getElementById('readerCount').textContent = `æ€»è®¡ ${readerState.totalMessages} æ¥¼`;
            document.getElementById('pageInfo').textContent = `${readerState.currentPage} / ${readerState.totalPages}`;

            currentMessages.forEach((msg, i) => {
                // ... (ä¸­é—´çš„ forEach å¾ªç¯ç”Ÿæˆæ°”æ³¡çš„ä»£ç å®Œå…¨ä¿æŒä¸å˜) ...
                // ... ç›´æ¥å¤åˆ¶åŸæ¥çš„å³å¯ ...
                const globalIndex = startIdx + i;
                const text = msg.mes || msg.content || msg.text || msg.message || '...';
                const name = msg.name || '???';
                
                let isRight = false;
                if (msg.hasOwnProperty('is_user')) isRight = msg.is_user;
                else if (msg.hasOwnProperty('is_main')) isRight = msg.is_main;
                else if (name === 'User' || name === 'æˆ‘' || name === 'Me') isRight = true;

                const sideClass = isRight ? 'right' : 'left';
                const row = document.createElement('div');
                row.className = `chat-row ${sideClass}`;
                row.id = `floor-${globalIndex}`; 

                const floor = document.createElement('span');
                floor.className = 'floor-tag';
                
                const isBookmarked = readerState.bookmarks.hasOwnProperty(globalIndex);
                const starClass = isBookmarked ? 'active' : '';
                
                floor.innerHTML = `
                    #${globalIndex + 1} 
                    <span class="bookmark-icon ${starClass}" 
                          onclick="handleBookmarkClick(${globalIndex}, this)" 
                          title="${isBookmarked ? 'ç‚¹å‡»ä¿®æ”¹/åˆ é™¤å¤‡æ³¨' : 'ç‚¹å‡»æ·»åŠ ä¹¦ç­¾'}">
                          â˜…
                    </span>`;

                const bubbleWrapper = document.createElement('div');
                const nameTag = document.createElement('div');
                nameTag.className = 'chat-name';
                nameTag.textContent = name;

                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';
                bubble.innerHTML = text.replace(/\n/g, '<br>');
                
                bubble.title = "åŒå‡»ç¼–è¾‘å†…å®¹";
                bubble.ondblclick = (e) => {
                    e.stopPropagation();
                    enableEditMode(bubble, globalIndex, text);
                };

                bubbleWrapper.appendChild(nameTag);
                bubbleWrapper.appendChild(bubble);
                
                row.appendChild(floor);
                row.appendChild(bubbleWrapper);
                container.appendChild(row);
            });

            // ğŸŸ¢ æ”¹åŠ¨ï¼šåˆ é™¤äº† container.scrollTop = 0; è¿™ä¸€è¡Œ
            // è¿™æ ·åˆ·æ–°é¡µé¢æ—¶ï¼Œæ»šåŠ¨æ¡ä¼šåœç•™åœ¨åŸåœ°
        }

        // --- ğŸŸ¢ æ–°å¢åŠŸèƒ½ï¼šåŒå‡»ç¼–è¾‘é€»è¾‘ ---
        function enableEditMode(bubbleEl, globalIndex, oldText) {
            // é¿å…é‡å¤è¿›å…¥ç¼–è¾‘æ¨¡å¼
            if (bubbleEl.querySelector('.bubble-textarea')) return;

            // åˆ›å»ºç¼–è¾‘ç•Œé¢
            const wrapper = document.createElement('div');
            wrapper.className = 'bubble-edit-wrapper';

            const textarea = document.createElement('textarea');
            textarea.className = 'bubble-textarea';
            textarea.value = oldText; // ç›´æ¥æ”¾å…¥åŸæ–‡æœ¬ï¼Œä¸å« <br>
            
            const btnRow = document.createElement('div');
            btnRow.className = 'edit-btn-row';
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'edit-confirm-btn';
            confirmBtn.textContent = 'ğŸ’¾ ä¿å­˜';
            confirmBtn.onclick = () => saveBubbleEdit(globalIndex, textarea.value);

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'edit-cancel-btn';
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.onclick = () => renderCurrentPage(); // é‡æ–°æ¸²æŸ“æ¢å¤åŸçŠ¶

            btnRow.appendChild(cancelBtn);
            btnRow.appendChild(confirmBtn);
            wrapper.appendChild(textarea);
            wrapper.appendChild(btnRow);

            // æ¸…ç©ºæ°”æ³¡å¹¶æ”¾å…¥ç¼–è¾‘æ¡†
            bubbleEl.innerHTML = '';
            bubbleEl.appendChild(wrapper);
            textarea.focus();
        }

              async function saveBubbleEdit(globalIndex, newText) {
            // ğŸŸ¢ æ”¹åŠ¨ï¼šä¿å­˜å½“å‰çš„æ»šåŠ¨ä½ç½®
            const container = document.getElementById('chatContainer');
            const currentScroll = container.scrollTop;

            // 1. æ›´æ–°å†…å­˜æ•°æ®
            const msg = readerState.data[globalIndex];
            if(msg.mes !== undefined) msg.mes = newText;
            if(msg.content !== undefined) msg.content = newText;
            if(msg.text !== undefined) msg.text = newText;
            if(msg.message !== undefined) msg.message = newText;

            // 2. æŒä¹…åŒ–ä¿å­˜åˆ°æ•°æ®åº“
            await saveReaderDataToDB();

            // 3. é‡æ–°æ¸²æŸ“
            renderCurrentPage();

            // ğŸŸ¢ æ”¹åŠ¨ï¼šæ¢å¤ä¹‹å‰çš„æ»šåŠ¨ä½ç½®ï¼Œç¡®ä¿è§†å›¾ä¸ä¹±è·³
            container.scrollTop = currentScroll;

            auth.toast('ä¿®æ”¹å·²ä¿å­˜ âœ¨');
        }

        // --- ğŸŸ¢ æ–°å¢åŠŸèƒ½ï¼šä¹¦ç­¾ç³»ç»Ÿ ---
        async function handleBookmarkClick(globalIndex, iconEl) {
            const isBookmarked = readerState.bookmarks.hasOwnProperty(globalIndex);
            
            if (isBookmarked) {
                // å·²æœ‰ä¹¦ç­¾ï¼šè¯¢é—®æ˜¯ä¿®æ”¹è¿˜æ˜¯åˆ é™¤
                const oldNote = readerState.bookmarks[globalIndex];
                const newNote = prompt("âœï¸ ä¿®æ”¹å¤‡æ³¨ (æ¸…ç©ºå†…å®¹åˆ™åˆ é™¤ä¹¦ç­¾):", oldNote);
                
                if (newNote === null) return; // å–æ¶ˆ
                
                if (newNote.trim() === "") {
                    delete readerState.bookmarks[globalIndex];
                    auth.toast('ä¹¦ç­¾å·²åˆ é™¤ ğŸ—‘ï¸');
                } else {
                    readerState.bookmarks[globalIndex] = newNote;
                    auth.toast('å¤‡æ³¨å·²æ›´æ–° ğŸ“');
                }
            } else {
                // æ–°ä¹¦ç­¾
                const note = prompt("âœ¨ è¯·è¾“å…¥ä¹¦ç­¾å¤‡æ³¨:", "è¿™é‡Œå¾ˆæœ‰è¶£...");
                if (note === null) return;
                
                readerState.bookmarks[globalIndex] = note || "æ— å¤‡æ³¨";
                auth.toast('ä¹¦ç­¾æ·»åŠ æˆåŠŸ â­');
            }

            // ä¿å­˜å¹¶åˆ·æ–°UI
            await saveReaderDataToDB();
            renderCurrentPage();
            // å¦‚æœä¹¦ç­¾åˆ—è¡¨æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿåˆ·æ–°ä¸€ä¸‹åˆ—è¡¨
            if(document.getElementById('bookmarkDrawer').classList.contains('active')){
                renderBookmarkList();
            }
        }

        function toggleBookmarkDrawer() {
            const drawer = document.getElementById('bookmarkDrawer');
            drawer.classList.toggle('active');
            if (drawer.classList.contains('active')) {
                renderBookmarkList();
            }
        }

        function renderBookmarkList() {
            const listEl = document.getElementById('bookmarkList');
            listEl.innerHTML = '';

            const indices = Object.keys(readerState.bookmarks).map(Number).sort((a,b) => a-b);

            if (indices.length === 0) {
                listEl.innerHTML = '<div class="bm-empty">è¿˜æ²¡æœ‰åŠ è¿‡ä¹¦ç­¾å“¦~<br>ç‚¹å‡»æ¥¼å±‚å·æ—è¾¹çš„ â˜… è¯•è¯•</div>';
                return;
            }

            indices.forEach(idx => {
                const note = readerState.bookmarks[idx];
                const item = document.createElement('div');
                item.className = 'bookmark-item';
                item.onclick = () => jumpToFloor(idx);
                
                item.innerHTML = `
                    <div class="bm-floor">#${idx + 1} æ¥¼</div>
                    <div class="bm-note">${note}</div>
                `;
                listEl.appendChild(item);
            });
        }

        function jumpToFloor(globalIndex) {
            // 1. è®¡ç®—ç›®æ ‡é¡µç 
            const targetPage = Math.floor(globalIndex / readerState.pageSize) + 1;
            
            // 2. è·³è½¬é¡µé¢
            readerState.currentPage = targetPage;
            renderCurrentPage();

            // 3. å…³é—­æŠ½å±‰
            document.getElementById('bookmarkDrawer').classList.remove('active');

            // 4. æ»šåŠ¨åˆ°æŒ‡å®šæ¥¼å±‚å¹¶é«˜äº®
            setTimeout(() => {
                const row = document.getElementById(`floor-${globalIndex}`);
                if (row) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    row.classList.add('highlight-row');
                    setTimeout(() => row.classList.remove('highlight-row'), 2000);
                }
            }, 100); // ç¨å¾®å»¶è¿Ÿç­‰å¾…æ¸²æŸ“
        }

        // --- ğŸ’¾ æ ¸å¿ƒä¿å­˜é€»è¾‘ ---
        async function saveReaderDataToDB() {
            if (viewingIndex === -1 || readerState.resourceIndex === -1) return;

            const item = items[viewingIndex];
            const res = item.resources[readerState.resourceIndex];

            // 1. ä¿å­˜å†…å®¹ (å°†å¯¹è±¡æ•°ç»„è½¬å› JSON å­—ç¬¦ä¸²)
            res.content = JSON.stringify(readerState.data);

            // 2. ä¿å­˜ä¹¦ç­¾
            res.bookmarks = readerState.bookmarks;

            // 3. å†™å…¥æ•°æ®åº“
            await saveItemToDB(item);
        }

               function prevPage() {
            if (readerState.currentPage > 1) {
                readerState.currentPage--;
                renderCurrentPage();
                // ğŸŸ¢ æ”¹åŠ¨ï¼šç¿»é¡µæ—¶å›åˆ°é¡¶éƒ¨
                document.getElementById('chatContainer').scrollTop = 0;
            } else {
                auth.toast('å·²ç»æ˜¯ç¬¬ä¸€é¡µå•¦');
            }
        }

        function nextPage() {
            if (readerState.currentPage < readerState.totalPages) {
                readerState.currentPage++;
                renderCurrentPage();
                // ğŸŸ¢ æ”¹åŠ¨ï¼šç¿»é¡µæ—¶å›åˆ°é¡¶éƒ¨
                document.getElementById('chatContainer').scrollTop = 0;
            } else {
                auth.toast('å·²ç»æ˜¯æœ€åä¸€é¡µå•¦');
            }
        }

        // ================= ğŸ¨ CSS ä¸»é¢˜ç³»ç»Ÿ =================
        
        let savedThemes = JSON.parse(localStorage.getItem('my_reader_themes') || '[]');

        // 1. æ‰“å¼€/å…³é—­é¢æ¿
        function toggleCssDrawer() {
            const drawer = document.getElementById('cssDrawer');
            drawer.classList.toggle('active');
            if(drawer.classList.contains('active')) {
                renderThemeSelect();
            }
        }

        // 2. é¢„è§ˆ/åº”ç”¨ CSS
        function previewCss() {
            const css = document.getElementById('cssInput').value;
            // æŠŠ CSS æ³¨å…¥åˆ°ç¬¬ä¸€æ­¥åŠ çš„ style æ ‡ç­¾é‡Œ
            document.getElementById('custom-reader-style').textContent = css;
            auth.toast('çš®è‚¤å·²åº”ç”¨ âœ¨');
        }

        // 3. ä¿å­˜ä¸»é¢˜
        function saveCustomTheme() {
            const name = document.getElementById('themeNameInput').value.trim();
            const css = document.getElementById('cssInput').value;
            
            if(!name) { auth.toast('èµ·ä¸ªåå­—å§ï¼'); return; }
            if(!css) { auth.toast('è¿˜æ²¡å†™ä»£ç å‘¢ï¼'); return; }

            // æ£€æŸ¥é‡åï¼Œå¦‚æœæœ‰é‡åå°±è¦†ç›–
            const existingIdx = savedThemes.findIndex(t => t.name === name);
            if(existingIdx >= 0) {
                if(!confirm(`ä¸»é¢˜ "${name}" å·²å­˜åœ¨ï¼Œè¦è¦†ç›–å—ï¼Ÿ`)) return;
                savedThemes[existingIdx].css = css;
            } else {
                savedThemes.push({ name: name, css: css });
            }

            localStorage.setItem('my_reader_themes', JSON.stringify(savedThemes));
            renderThemeSelect();
            // è‡ªåŠ¨é€‰ä¸­åˆšä¿å­˜çš„
            document.getElementById('themeSelect').value = name;
            auth.toast('ä¸»é¢˜ä¿å­˜æˆåŠŸ ğŸ’¾');
        }

        // 4. åŠ è½½é€‰ä¸­çš„ä¸»é¢˜
        function loadSelectedTheme() {
            const name = document.getElementById('themeSelect').value;
            if(!name) return;
            
            const theme = savedThemes.find(t => t.name === name);
            if(theme) {
                document.getElementById('cssInput').value = theme.css;
                document.getElementById('themeNameInput').value = theme.name;
                previewCss(); // è‡ªåŠ¨åº”ç”¨
            }
        }

        // 5. åˆ é™¤ä¸»é¢˜
        function deleteCustomTheme() {
            const name = document.getElementById('themeSelect').value;
            if(!name) { auth.toast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„ä¸»é¢˜'); return; }
            
            if(confirm(`ç¡®å®šåˆ é™¤ä¸»é¢˜ "${name}" å—ï¼Ÿ`)) {
                savedThemes = savedThemes.filter(t => t.name !== name);
                localStorage.setItem('my_reader_themes', JSON.stringify(savedThemes));
                
                document.getElementById('cssInput').value = '';
                document.getElementById('themeNameInput').value = '';
                document.getElementById('custom-reader-style').textContent = ''; // æ¸…ç©ºæ•ˆæœ
                
                renderThemeSelect();
                auth.toast('å·²åˆ é™¤ ğŸ—‘ï¸');
            }
        }

        // 6. æ¸²æŸ“ä¸‹æ‹‰åˆ—è¡¨
        function renderThemeSelect() {
            const sel = document.getElementById('themeSelect');
            // ä¿ç•™ç¬¬ä¸€é¡¹æç¤º
            sel.innerHTML = '<option value="">-- é€‰æ‹©å·²ä¿å­˜çš„ä¸»é¢˜ --</option>';
            savedThemes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.name;
                opt.textContent = t.name;
                sel.appendChild(opt);
            });
        }
        
        // ğŸŸ¢ åˆå§‹åŒ–ï¼šå¦‚æœä¹‹å‰æœ‰æœ€åä¸€æ¬¡ä½¿ç”¨çš„ä¸»é¢˜ï¼Œå¯ä»¥åœ¨è¿™é‡Œè‡ªåŠ¨åŠ è½½ï¼ˆå¯é€‰ï¼‰
        // window.addEventListener('load', () => { ... })

        // ================= ğŸ’­ é£˜å­—åŠ¨ç”»é€»è¾‘ =================
        let memoryInterval = null;

        function startMemoryAnimation(list) {
            const container = document.getElementById('memoryLayer');
            container.innerHTML = ''; // å…ˆæ¸…ç©º
            
            // å¦‚æœæ²¡æœ‰è¯ï¼Œæˆ–è€…åˆ—è¡¨ä¸ºç©ºï¼Œå°±ä¸æ”¾äº†
            if (!list || list.length === 0) return;

            // ç«‹å³ç”Ÿæˆå‡ ä¸ªï¼Œé¿å…æ‰“å¼€æ—¶ç©ºè¡è¡
            for(let i=0; i<3; i++) spawnMemory(list, container);

            // æ¯éš” 1.5ç§’ ç”Ÿæˆä¸€ä¸ªæ–°çš„
            memoryInterval = setInterval(() => {
                spawnMemory(list, container);
            }, 1500);
        }

        function stopMemoryAnimation() {
            if (memoryInterval) {
                clearInterval(memoryInterval);
                memoryInterval = null;
            }
            document.getElementById('memoryLayer').innerHTML = '';
        }

        function spawnMemory(list, container) {
            const text = list[Math.floor(Math.random() * list.length)]; // éšæœºæŒ‘ä¸€å¥
            const el = document.createElement('div');
            el.className = 'memory-text';
            el.textContent = text;
            
            // éšæœºä½ç½®å’Œå¤§å°ï¼Œè®©æ•ˆæœæ›´è‡ªç„¶
            const randomLeft = Math.random() * 80 + 10; // 10% åˆ° 90% ä¹‹é—´
            const randomDuration = Math.random() * 5 + 8; // 8åˆ°13ç§’é£˜å®Œ
            const randomSize = Math.random() * 8 + 16; // 16px åˆ° 24px å¤§å°
            
            el.style.left = randomLeft + '%';
            el.style.animationDuration = randomDuration + 's';
            el.style.fontSize = randomSize + 'px';
            
            container.appendChild(el);

            // åŠ¨ç”»ç»“æŸååˆ é™¤å…ƒç´ ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            setTimeout(() => {
                if(el.parentNode) el.parentNode.removeChild(el);
            }, randomDuration * 1000);
        }

 // ================= ğŸº é…’é¦†ä¼ é€é—¨é€»è¾‘ (æé€Ÿç‰ˆ) =================
        
        // ğŸš€ å¯åŠ¨é€»è¾‘ (æ— å»¶è¿Ÿï¼Œæµè§ˆå™¨ä¸ä¼šæ‹¦æˆª)
        function jumpToTavern() {
            let url = localStorage.getItem('my_tavern_simple_url');
            
            // ç¬¬ä¸€æ¬¡ç”¨ï¼Œè¿˜æ²¡å­˜è¿‡é“¾æ¥
            if (!url) {
                // å¦‚æœæ²¡é“¾æ¥ï¼Œç›´æ¥è°ƒç”¨ä¿®æ”¹å‡½æ•°
                changeTavernLink(true); 
            } else {
                // æœ‰é“¾æ¥ï¼Œç›´æ¥é£
                window.open(url, '_blank');
            }
        }

        // âœï¸ ä¿®æ”¹é€»è¾‘
        function changeTavernLink(isFirstTime = false) {
            const oldUrl = localStorage.getItem('my_tavern_simple_url') || 'http://127.0.0.1:8000';
            const msg = isFirstTime ? "ğŸº ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œè¯·è¾“å…¥é…’é¦†é“¾æ¥ï¼š" : "ğŸ”§ ä¿®æ”¹é…’é¦†åæ ‡ï¼š";
            
            let newUrl = prompt(msg + "\n(ä¾‹å¦‚ http://127.0.0.1:8000 )", oldUrl);
            
            if (newUrl) {
                // è´´å¿ƒåœ°å¸®ç”¨æˆ·åŠ ä¸Š http (é˜²æ­¢ç”¨æˆ·åªå†™ IP)
                if (!newUrl.startsWith('http')) {
                    newUrl = 'http://' + newUrl;
                }
                // å»æ‰æœ«å°¾çš„æ–œæ  / (é˜²æ­¢æ‹¼æ¥å‡ºé”™)
                if (newUrl.endsWith('/')) {
                    newUrl = newUrl.slice(0, -1);
                }
                
                localStorage.setItem('my_tavern_simple_url', newUrl);
                auth.toast('é…’é¦†åæ ‡å·²é”å®š ğŸ“');
                
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¾ç½®ï¼Œè®¾ç½®å®Œç›´æ¥è·³
                if(isFirstTime) {
                    window.open(newUrl, '_blank');
                }
            }
        }

        // ================= ğŸ’® å°ç« ç³»ç»Ÿé€»è¾‘ =================

        // åˆ‡æ¢å°ç« ï¼ˆç‚¹å‡»å°å›¾æ ‡æ—¶è§¦å‘ï¼‰
        async function toggleStamp(char) {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // å¦‚æœå½“å‰å·²ç»æ˜¯è¿™ä¸ªå°ç« ï¼Œå†æ¬¡ç‚¹å‡»å°±æ˜¯å–æ¶ˆ
            if (item.stamp === char) {
                item.stamp = null; // å–æ¶ˆ
                auth.toast('å°ç« å·²æ’¤é”€ ğŸ’¨');
            } else {
                item.stamp = char; // ç›–ç« 
                auth.toast('ç›–ç« æˆåŠŸï¼å•ªï¼ğŸ’®');
            }

            // ä¿å­˜æ•°æ®
            await saveItemToDB(item);
            
            // åˆ·æ–°ç•Œé¢
            renderStampStatus(item.stamp);
            loadFromDB(); // åˆ·æ–°åˆ—è¡¨æ•°æ®
        }

        // æ¸²æŸ“å°ç« ï¼ˆæ§åˆ¶å¤§å°ç« å’Œå°å›¾æ ‡çš„æ˜¾ç¤ºï¼‰
        function renderStampStatus(currentStamp) {
            const bigStamp = document.getElementById('bigStamp');
            const btns = document.querySelectorAll('.stamp-btn');

            // 1. é‡ç½®æ‰€æœ‰å°å›¾æ ‡
            btns.forEach(btn => {
                btn.classList.remove('active');
                // å¦‚æœæ˜¯å½“å‰å°ç« ï¼Œç‚¹äº®å®ƒ
                if (btn.innerText === currentStamp) {
                    btn.classList.add('active');
                }
            });

            // 2. å¤„ç†å¤§å°ç« åŠ¨ç”»
            if (currentStamp) {
                bigStamp.innerText = currentStamp;
                // å…ˆç§»é™¤ï¼Œå¼ºåˆ¶é‡ç»˜ï¼Œå†æ·»åŠ ï¼Œä¸ºäº†æ¯æ¬¡éƒ½æœ‰â€œå•ªâ€çš„åŠ¨ç”»æ•ˆæœ
                bigStamp.classList.remove('stamped');
                void bigStamp.offsetWidth; // å¼ºåˆ¶é‡ç»˜é­”æ³•
                bigStamp.classList.add('stamped');
            } else {
                bigStamp.classList.remove('stamped');
            }
        }

        // ================= ğŸ™ˆ é˜²çª¥æ¨¡å¼é€»è¾‘ =================
        
        function togglePrivacyMode() {
            const body = document.body;
            const btn = document.getElementById('privacyBtn');
            
            // åˆ‡æ¢ class
            body.classList.toggle('privacy-active');
            
            // åˆ¤æ–­å½“å‰çŠ¶æ€ï¼Œæ”¹å˜å›¾æ ‡å’Œæç¤º
            if (body.classList.contains('privacy-active')) {
                btn.textContent = 'ğŸ™ˆ'; // å˜æˆæ‚çœ¼ç›çš„çŒ´å­
                btn.style.backgroundColor = '#ffe6eb'; // æŒ‰é’®å˜ç²‰æç¤ºç”Ÿæ•ˆä¸­
                auth.toast('é˜²çª¥æ¨¡å¼å·²å¼€å¯ ğŸ”’');
            } else {
                btn.textContent = 'ğŸ‘ï¸'; // å˜æˆçå¼€çš„çœ¼ç›
                btn.style.backgroundColor = 'rgba(255, 255, 255, 0.6)'; // æ¢å¤åŸæ ·
                auth.toast('å·²æ¢å¤æ¸…æ™° âœ¨');
            }
        }

        // ================= âœ¨ æŒ‡å°–é­”æ³•é€»è¾‘ =================
        window.addEventListener('click', function(e) {
            // éšæœºç‰¹æ•ˆæ± 
            const particles = ['ğŸŒ¸', 'âœ¨', 'ğŸ’—', 'â­', 'ğŸ¾', 'ğŸµ'];
            const p = document.createElement('div');
            p.className = 'magic-particle';
            p.innerText = particles[Math.floor(Math.random() * particles.length)];
            
            // è®¾ç½®ä½ç½®
            p.style.left = e.clientX + 'px';
            p.style.top = e.clientY + 'px';
            
            // ç¨å¾®éšæœºä¸€ç‚¹è§’åº¦å’Œå¤§å°
            const randomRot = Math.random() * 40 - 20; // -20åº¦åˆ°20åº¦
            p.style.transform = `translate(-50%, -50%) rotate(${randomRot}deg)`;
            
            document.body.appendChild(p);
            
            // åŠ¨ç”»ç»“æŸåæ¸…ç†
            setTimeout(() => p.remove(), 1000);
        });

        // ================= ğŸ“Š 1. ç¾ç»Šåˆ†ææŠ¥å‘Šé€»è¾‘ =================
        function analyzeBond() {
            if (!readerState.data || readerState.data.length === 0) {
                auth.toast('æ²¡æœ‰èŠå¤©è®°å½•ï¼Œæ— æ³•åˆ†æå“¦ ğŸ“„');
                return;
            }

            const msgs = readerState.data;
            let userWords = 0;
            let charWords = 0;
            let firstTime = null;
            let lastTime = null;

            // éå†ç»Ÿè®¡
            msgs.forEach(m => {
                // 1. å°è¯•æå–æ—¶é—´ (å…¼å®¹ sillytavern/é…’é¦†å¸¸ç”¨å­—æ®µ create_date/date)
                const tStr = m.create_date || m.date || m.send_date;
                if(tStr) {
                    const t = new Date(tStr).getTime();
                    if(!isNaN(t)) {
                        if(!firstTime || t < firstTime) firstTime = t;
                        if(!lastTime || t > lastTime) lastTime = t;
                    }
                }

                // 2. ç»Ÿè®¡å­—æ•°
                const content = m.mes || m.content || m.text || "";
                const len = content.length;
                
                // åˆ¤æ–­æ˜¯è°å‘çš„ (å¤ç”¨ reader çš„é€»è¾‘)
                const name = m.name || '???';
                let isUser = false;
                if (m.hasOwnProperty('is_user')) isUser = m.is_user;
                else if (name === 'User' || name === 'æˆ‘' || name === 'Me') isUser = true;

                if(isUser) userWords += len;
                else charWords += len;
            });

            // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ï¼Œé»˜è®¤ä¸ºä»Šå¤©
            const now = new Date();
            if(!firstTime) firstTime = now.getTime();
            if(!lastTime) lastTime = now.getTime();

            // è®¡ç®—å¤©æ•°
            const diffTime = Math.abs(lastTime - firstTime);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

            // æ¸²æŸ“æ•°æ®
            document.getElementById('reportTotalFloors').textContent = msgs.length;
            document.getElementById('reportTotalWords').textContent = (userWords + charWords).toLocaleString();
            document.getElementById('reportDays').textContent = diffDays;
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const fmt = (ts) => new Date(ts).toISOString().slice(0,10);
            document.getElementById('reportDateStart').textContent = fmt(firstTime);
            document.getElementById('reportDateEnd').textContent = fmt(lastTime);

            // æ¸²æŸ“æ¯”ä¾‹æ¡
            const total = userWords + charWords;
            let userPct = 50;
            if(total > 0) userPct = Math.round((userWords / total) * 100);
            
            document.getElementById('ratioUser').style.width = userPct + '%';
            document.getElementById('ratioUser').textContent = `æˆ‘ ${userPct}%`;
            document.getElementById('textCountUser').textContent = `æˆ‘: ${userWords}`;

            document.getElementById('ratioChar').style.width = (100 - userPct) + '%';
            document.getElementById('ratioChar').textContent = `TA ${100 - userPct}%`;
            document.getElementById('textCountChar').textContent = `TA: ${charWords}`;

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('reportModal').classList.add('active');
        }

        // ================= ğŸ² 2. çµæ„Ÿæ‰­è›‹æœº Pro é€»è¾‘ =================
        
        // ğŸ’¾ é»˜è®¤è¶…çº§é¢˜åº“ (å¦‚ä½ æ‰€æ„¿ï¼ŒåŠ äº†äº¿ç‚¹ç‚¹æ¢—)
        const DEFAULT_GACHA_DB = {
            places: [
                "åºŸå¼ƒçš„æ—§æ ¡èˆ", "æš´é›¨ä¸­çš„ç”µè¯äº­", "å¼‚ä¸–ç•Œçš„é­”ç‹åŸç‹åº§", "æ·±å¤œçš„24å°æ—¶ä¾¿åˆ©åº—", 
                "ç‹­çª„çš„ç”µæ¢¯é‡Œ", "è±ªåæ¸¸è½®çš„ç”²æ¿", "æœ«æ—¥åçš„åºŸå¢Ÿé¿éš¾æ‰€", "å……æ»¡æ¶ˆæ¯’æ°´å‘³çš„åŒ»åŠ¡å®¤",
                "å–§é—¹çš„é…’å§è§’è½", "åªæœ‰æˆ‘ä»¬ä¸¤ä¸ªäººçš„æµ·è¾¹", "æ»¡æ˜¯ç°å°˜çš„é˜æ¥¼", "æ­£åœ¨å´©å¡Œçš„åœ°ä¸‹åŸ",
                "å…¨æ¯æŠ•å½±çš„èµ›åšè¡—é“", "å¤è€çš„å›¾ä¹¦é¦†ç¦ä¹¦åŒº", "æ¸©æ³‰æ—…é¦†çš„ç§äººæ±¤æ± ", "æ‹¥æŒ¤çš„æ—©é«˜å³°åœ°é“"
            ],
            events: [
                "èº«ä½“äº’æ¢äº†", "å…¶ä¸­ä¸€æ–¹å¤±å¿†äº†", "å¿…é¡»è¦å‡è£…æˆæƒ…ä¾£", "è¢«ä¸€å‰¯ç¥ç§˜æ‰‹é“æ‹·åœ¨ä¸€èµ·",
                "å¦‚æœä¸è¯´å®è¯å°±ä¼šæ­»", "ä¸­äº†'å˜å¾—å¦ç‡'çš„é­”æ³•", "æ­£åœ¨èº²é¿ä»‡å®¶çš„è¿½æ€", "å‘ç°å¯¹æ–¹å…¶å®æ˜¯æ•Œå¯¹é˜µè¥",
                "åªæœ‰ä¸€æ–¹èƒ½çœ‹è§é¬¼é­‚", "è¢«å›°åœ¨æ—¶é—´å¾ªç¯é‡Œ", "ä¸€æ–¹å˜æˆäº†çŒ«/ç‹—", "æ¡åˆ°äº†å¯¹æ–¹çš„ç§å¯†æ—¥è®°",
                "é†‰é…’åçš„ä¸€å¤œè’å”", "å¿…é¡»è¦å®ŒæˆçœŸå¿ƒè¯å¤§å†’é™©", "ç…§é¡¾ç”Ÿç—…çš„å¦ä¸€æ–¹", "äº’ç›¸ç»™å¯¹æ–¹æ¶‚é˜²æ™’éœœ/ä¸Šè¯"
            ],
            tropes: [
                "ä¿®ç½—åœº/å«‰å¦’", "ç ´é•œé‡åœ†", "åŒå‘æš—æ‹", "ç›¸çˆ±ç›¸æ€", "å…ˆå©šåçˆ±", "æ•‘èµ/æ²»æ„ˆ",
                "ç—…å¨‡/ç›‘ç¦", "å¹´ä¸‹/æ’’å¨‡", "ä¸»ä»†/æ”¯é…", "åå·®èŒ", "åŠæ¡¥æ•ˆåº”", "è¯¯ä¼šæ¢—",
                "ABOè®¾å®š(å‘æƒ…æœŸ)", "é’æ¢…ç«¹é©¬", "å®¿æ•Œå˜æƒ…äºº", "å¥‘çº¦å…³ç³»"
            ]
        };

        let gachaData = { ...DEFAULT_GACHA_DB };

        // åˆå§‹åŒ–ï¼šåŠ è½½ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®
        function initGacha() {
            const saved = localStorage.getItem('my_gacha_db');
            if(saved) {
                try {
                    gachaData = JSON.parse(saved);
                } catch(e) { console.error('é¢˜åº“åŠ è½½å¤±è´¥', e); }
            }
        }
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        initGacha();

        function openGachaModal() {
            document.getElementById('floatMenu').classList.remove('active');
            document.getElementById('gachaModal').classList.add('active');
        }
        function closeGachaModal() {
            document.getElementById('gachaModal').classList.remove('active');
            document.getElementById('gachaEditArea').style.display = 'none';
        }

        function spinGacha() {
            const resultArea = document.getElementById('gachaResultArea');
            resultArea.innerHTML = '<div style="font-size:30px;">ğŸ°</div>'; // ç®€å•çš„è½¬åŠ¨åŠ¨ç”»å ä½
            
            setTimeout(() => {
                const p = randArr(gachaData.places);
                const e = randArr(gachaData.events);
                const t = randArr(gachaData.tropes);

                resultArea.innerHTML = `
                    <div class="gacha-tag tag-place">ğŸ“ ${p}</div>
                    <div class="gacha-tag tag-event">ğŸ“… ${e}</div>
                    <div class="gacha-tag tag-trope">âœ¨ ${t}</div>
                    <div style="font-size:12px; color:#aaa; margin-top:10px;">
                        ğŸ’¡ è„‘æ´ï¼šåœ¨ <b>${p}</b>ï¼Œå‘ç”Ÿäº† <b>${e}</b>ï¼Œæ°›å›´æ˜¯ <b>${t}</b>
                    </div>
                `;
            }, 300);
        }

        function randArr(arr) {
            if(!arr || arr.length === 0) return "???";
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function toggleGachaEdit() {
            const area = document.getElementById('gachaEditArea');
            if(area.style.display === 'none' || area.style.display === '') {
                area.style.display = 'block';
                // å¡«å……å½“å‰æ•°æ®
                document.getElementById('editPlace').value = gachaData.places.join('ï¼Œ');
                document.getElementById('editEvent').value = gachaData.events.join('ï¼Œ');
                document.getElementById('editTrope').value = gachaData.tropes.join('ï¼Œ');
            } else {
                area.style.display = 'none';
            }
        }

        function saveGachaData() {
            // è¾…åŠ©å‡½æ•°ï¼šæŠŠå­—ç¬¦ä¸²è½¬æ•°ç»„
            const parse = (id) => document.getElementById(id).value.split(/[,ï¼Œ\n]/).map(s=>s.trim()).filter(s=>s);
            
            gachaData.places = parse('editPlace');
            gachaData.events = parse('editEvent');
            gachaData.tropes = parse('editTrope');

            localStorage.setItem('my_gacha_db', JSON.stringify(gachaData));
            auth.toast('é¢˜åº“ä¿å­˜æˆåŠŸï¼ğŸ“š');
            toggleGachaEdit();
        }

        function resetGachaData() {
            if(confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤é¢˜åº“å—ï¼Ÿä½ è‡ªå·±åŠ çš„æ¢—ä¼šæ¶ˆå¤±å“¦ï¼')) {
                gachaData = JSON.parse(JSON.stringify(DEFAULT_GACHA_DB)); // æ·±æ‹·è´æ¢å¤
                localStorage.removeItem('my_gacha_db');
                auth.toast('å·²æ¢å¤é»˜è®¤è®¾ç½® ğŸ”„');
                toggleGachaEdit();
            }
        }

        // ================= ğŸ’ çºªå¿µå“é™ˆåˆ—å®¤é€»è¾‘ =================

        // 1. æ¸²æŸ“ä¸»é¡µçš„â€œå¤§é™ˆåˆ—å®¤â€
        function renderShelfView() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';

            const shelf = document.createElement('div');
            shelf.className = 'shelf-container';

            let totalSov = 0;

            // éå†æ‰€æœ‰è§’è‰²ï¼ŒæŠŠä»–ä»¬çš„çºªå¿µå“éƒ½æ‹¿å‡ºæ¥
            items.forEach((item, itemIdx) => {
                if(item.souvenirs && item.souvenirs.length > 0) {
                    item.souvenirs.forEach((sov, sovIdx) => {
                        totalSov++;
                        const card = document.createElement('div');
                        card.className = 'souvenir-card';
                        // ç»™ä¸ªéšæœºæ—‹è½¬è§’åº¦ (-5åº¦ åˆ° 5åº¦)ï¼Œæ¨¡æ‹Ÿéšæ„æ‘†æ”¾çš„æ„Ÿè§‰
                        card.style.setProperty('--rot', (Math.random() * 10 - 5) + 'deg');
                        
                        card.innerHTML = `
                            <img src="${sov.img}" class="souvenir-img">
                            <div class="souvenir-title">${sov.name}</div>
                        `;
                        // ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
                        card.onclick = () => openViewSouvenir(itemIdx, sovIdx);
                        shelf.appendChild(card);
                    });
                }
            });

            if(totalSov === 0) {
                container.innerHTML = '<div class="empty-state">é™ˆåˆ—å®¤ç©ºç©ºçš„...<br>å»è§’è‰²è¯¦æƒ…é¡µé‡Œæ·»åŠ çºªå¿µå“å§ï¼ğŸ’</div>';
            } else {
                container.appendChild(shelf);
                auth.toast(`æ¬¢è¿æ¥åˆ°é™ˆåˆ—å®¤ï¼Œå…±æ”¶è—äº† ${totalSov} ä»¶å®ç‰© âœ¨`);
            }
        }

        // 2. æ¸²æŸ“è§’è‰²è¯¦æƒ…é¡µé‡Œçš„â€œå°é™ˆåˆ—æ â€
        // âš ï¸ é‡è¦ï¼šè¯·æ‰¾åˆ° openDetailModal å‡½æ•°ï¼Œåœ¨å®ƒæœ€ååŠ ä¸Š renderDetailSouvenirs(index);
        function renderDetailSouvenirs(itemIndex) {
            const list = document.getElementById('souvenirListArea');
            list.innerHTML = '';
            
            const item = items[itemIndex];
            const sovs = item.souvenirs || []; // å¦‚æœæ²¡æœ‰å°±æ˜¯ç©ºæ•°ç»„

            if(sovs.length === 0) {
                list.innerHTML = '<div style="font-size:12px; color:#ccc; padding:10px; width:100%; text-align:center;">æš‚æ— ä¿¡ç‰©</div>';
                return;
            }

            sovs.forEach((sov, idx) => {
                const el = document.createElement('div');
                el.className = 'souvenir-mini-item';
                el.innerHTML = `
                    <img src="${sov.img}" class="souvenir-mini-img">
                    <div style="font-size:10px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${sov.name}</div>
                `;
                el.onclick = () => openViewSouvenir(itemIndex, idx);
                list.appendChild(el);
            });
        }

        // 3. æ·»åŠ çºªå¿µå“ç›¸å…³é€»è¾‘
        let tempSovImg = null;

        function openAddSouvenirModal() {
            // é‡ç½®è¡¨å•
            document.getElementById('souvenirName').value = '';
            document.getElementById('souvenirDesc').value = '';
            document.getElementById('souvenirImgInput').value = '';
            document.getElementById('souvenirPreview').style.display = 'none';
            document.getElementById('souvenirUploadHint').style.display = 'block';
            tempSovImg = null;
            
            document.getElementById('addSouvenirModal').classList.add('active');
        }

        async function previewSouvenirImg(input) {
            if(input.files && input.files[0]) {
                const file = input.files[0];
                tempSovImg = await readFile(file); // å¤ç”¨ä¹‹å‰çš„ readFile å‡½æ•°
                const img = document.getElementById('souvenirPreview');
                img.src = tempSovImg;
                img.style.display = 'block';
                document.getElementById('souvenirUploadHint').style.display = 'none';
            }
        }

        async function saveSouvenir() {
            const name = document.getElementById('souvenirName').value.trim();
            const desc = document.getElementById('souvenirDesc').value.trim();
            
            if(!name) { auth.toast('èµ·ä¸ªåå­—å§ï¼'); return; }
            if(!tempSovImg) { auth.toast('è¯·ä¸Šä¼ ä¸€å¼ ç…§ç‰‡'); return; }
            
            // è·å–å½“å‰è§’è‰²
            if(viewingIndex === -1) return;
            const item = items[viewingIndex];
            
            if(!item.souvenirs) item.souvenirs = [];
            
            item.souvenirs.push({
                name: name,
                img: tempSovImg,
                desc: desc || "ï¼ˆæ²¡æœ‰ç•™ä¸‹æè¿°...ï¼‰",
                date: new Date().toISOString()
            });
            
            await saveItemToDB(item);
            
            document.getElementById('addSouvenirModal').classList.remove('active');
            renderDetailSouvenirs(viewingIndex);
            auth.toast('çºªå¿µå“å·²å…¥åº“ ğŸ’');
        }

        // 4. æŸ¥çœ‹/åˆ é™¤çºªå¿µå“
        let currentSovData = { itemIdx: -1, sovIdx: -1 };

        function openViewSouvenir(itemIdx, sovIdx) {
            const item = items[itemIdx];
            const sov = item.souvenirs[sovIdx];
            
            currentSovData = { itemIdx, sovIdx };
            
            document.getElementById('viewSovTitle').textContent = sov.name;
            document.getElementById('viewSovImg').src = sov.img;
            document.getElementById('viewSovDesc').textContent = sov.desc;
            document.getElementById('viewSovOwner').textContent = item.name;
            
            document.getElementById('viewSouvenirModal').classList.add('active');
        }

        async function deleteCurrentSouvenir() {
            if(!confirm('ç¡®å®šè¦ä¸¢å¼ƒè¿™ä»¶çºªå¿µå“å—ï¼Ÿå›å¿†ä¹Ÿä¼šæ¶ˆå¤±å“¦...')) return;
            
            const { itemIdx, sovIdx } = currentSovData;
            const item = items[itemIdx];
            
            item.souvenirs.splice(sovIdx, 1);
            await saveItemToDB(item);
            
            document.getElementById('viewSouvenirModal').classList.remove('active');
            
            // å¦‚æœæ˜¯åœ¨ä¸»é¡µé™ˆåˆ—å®¤æ¨¡å¼ä¸‹åˆ çš„ï¼Œåˆ·æ–°ä¸»é¡µ
            const isShelfMode = document.querySelector('.layout-btn[title="çºªå¿µå“é™ˆåˆ—å®¤"]').classList.contains('active');
            if(isShelfMode) renderShelfView();
            
            // å¦‚æœæ˜¯åœ¨è¯¦æƒ…é¡µåˆ çš„ï¼Œåˆ·æ–°è¯¦æƒ…é¡µ
            if(document.getElementById('detailModal').classList.contains('active')) {
                renderDetailSouvenirs(itemIdx);
            }
            
            auth.toast('çºªå¿µå“å·²ä¸¢å¼ƒ ğŸ—‘ï¸');
        }

                   // ================= ğŸŒ¸ æœ€ç»ˆç‰ˆï¼šæ¢¦å¢ƒé€»è¾‘ =================
        let dreamTimer = null;
        let bgPetalTimer = null;

        function startDreamMode() {
            // 1. æ”¶é›†å›å¿†ç¢ç‰‡
            const fragments = [];
            items.forEach(item => {
                // å›¾
                item.resources.filter(r => r.type === 'image').forEach(img => {
                    fragments.push({ type: 'img', content: img.content, name: item.name });
                });
                // è¯
                if(item.memories && item.memories.length > 0) {
                    item.memories.forEach(mem => {
                        fragments.push({ type: 'text', content: mem, name: item.name });
                    });
                }
            });

            if(fragments.length === 0) {
                auth.toast('å›å¿†å¤ªå°‘äº†ï¼Œæ¢¦å¢ƒæ— æ³•ç”Ÿæˆ... ğŸŒ¸');
                return;
            }

            // 2. å‡†å¤‡å›¾å±‚
            const layer = document.getElementById('dreamLayer');
            layer.innerHTML = '<div class="dream-close-btn" onclick="stopDreamMode()">ğŸŒ¸ é†’æ¥</div>'; 
            layer.classList.add('active');
            document.getElementById('floatMenu').classList.remove('active');

            // 3. å¯åŠ¨èƒŒæ™¯èŠ±ç“£é›¨ (çº¯è£…é¥°)
            startBgPetals();

            // 4. å¯åŠ¨å›å¿†æ‰è½ (æ­£æ–¹å½¢å’Œæ°”æ³¡)
            spawnDreamItem(fragments); 
            dreamTimer = setInterval(() => {
                spawnDreamItem(fragments);
            }, 1500); // æ¯1.5ç§’æ‰è½ä¸€ä¸ªå›å¿†
        }

        function stopDreamMode() {
            document.getElementById('dreamLayer').classList.remove('active');
            clearInterval(dreamTimer);
            clearInterval(bgPetalTimer);
        }

        // ç”ŸæˆèƒŒæ™¯è£…é¥°èŠ±ç“£
        function startBgPetals() {
            const layer = document.getElementById('dreamLayer');
            // å…ˆç”Ÿæˆ20ä¸ª
            for(let i=0; i<20; i++) createBgPetal(layer);
            // æŒç»­ç”Ÿæˆ
            bgPetalTimer = setInterval(() => createBgPetal(layer), 800);
        }

        function createBgPetal(layer) {
            const p = document.createElement('div');
            p.className = 'dream-bg-petal';
            const size = Math.random() * 10 + 10; // 10-20px å°èŠ±ç“£
            p.style.width = size + 'px';
            p.style.height = size + 'px';
            p.style.left = Math.random() * 100 + '%';
            p.style.animationDuration = (Math.random() * 5 + 5) + 's'; // 5-10s ä¸‹è½
            layer.appendChild(p);
            // åŠ¨ç”»ç»“æŸåæ¸…ç†
            setTimeout(() => { if(p.parentNode) p.remove(); }, 10000);
        }

        // ç”Ÿæˆå›å¿†ä¸»ä½“ (æ­£æ–¹å½¢ / æ°”æ³¡)
        function spawnDreamItem(fragments) {
            const layer = document.getElementById('dreamLayer');
            const frag = fragments[Math.floor(Math.random() * fragments.length)];
            
            const item = document.createElement('div');
            item.className = 'dream-content-item';
            
            // éšæœºæ°´å¹³ä½ç½® (é¿å…å¤ªé è¾¹)
            const left = Math.random() * 80 + 10; 
            item.style.left = left + '%';
            
            // éšæœºä¸‹è½é€Ÿåº¦
            const duration = Math.random() * 5 + 10; // 10-15s æ…¢æ…¢é£˜
            item.style.animationDuration = duration + 's';

            if(frag.type === 'img') {
                // === æ­£æ–¹å½¢å›¾ç‰‡ ===
                const box = document.createElement('div');
                box.className = 'dream-item-img';
                
                const img = document.createElement('img');
                img.src = frag.content;
                
                const nameLabel = document.createElement('div');
                nameLabel.className = 'dream-img-name';
                nameLabel.innerText = frag.name;

                box.appendChild(img);
                box.appendChild(nameLabel);
                item.appendChild(box);
            } else {
                // === æ–‡å­—æ°”æ³¡ ===
                const bubble = document.createElement('div');
                bubble.className = 'dream-item-text';
                bubble.innerText = frag.content.length > 30 ? frag.content.substring(0, 28) + '...' : frag.content;
                item.appendChild(bubble);
            }

            // ç‚¹å‡»äº‹ä»¶
            item.onclick = () => {
                auth.toast(`âœ¨ æ•è·äº†å…³äºã€${frag.name}ã€‘çš„å›å¿†`);
                item.style.transform = 'scale(1.2)';
                item.style.opacity = 0;
                item.style.transition = 'all 0.3s';
                setTimeout(() => item.remove(), 300);
            };

            layer.appendChild(item);

            setTimeout(() => { if(item.parentNode) item.remove(); }, duration * 1000);
        }


        // ================= ğŸ“– G. çµé­‚å›å“ (å†…ç½®å¤šå¥—æ€§æ ¼åº“) =================
        
        // ğŸŒŸ 1. é¢„è®¾æ€§æ ¼åº“ (å¯è‡ªè¡Œä¿®æ”¹)
        const DEFAULT_ECHO_LIB = {
            "å‚²å¨‡ (Tsundere)": [
                "ç¬¨è›‹ï¼è¿™ç§äº‹éƒ½è¦é—®æˆ‘ï¼Ÿ...å‹‰å¼ºç®—æ˜¯è‚¯å®šå§ã€‚",
                "å“ˆï¼Ÿæˆ‘æ‰ä¸å…³å¿ƒä½ æ€ä¹ˆæ ·å‘¢ï¼ä¸è¿‡...å¦‚æœæ˜¯ä½ çš„è¯ï¼Œåº”è¯¥æ²¡é—®é¢˜ã€‚",
                "é©³å›ï¼ç»å¯¹ä¸è¡Œï¼åˆ«è®©æˆ‘è¯´ç¬¬äºŒéï¼",
                "å“¼ï¼Œéšä½ ä¾¿å§ã€‚åˆ«åˆ°æ—¶å€™å“­ç€æ¥æ‰¾æˆ‘ã€‚",
                "åˆ«è¯¯ä¼šäº†ï¼Œæˆ‘åªæ˜¯ä¸æƒ³çœ‹ä½ å¤±è´¥çš„æ ·å­è€Œå·²ï¼Œå»è¯•è¯•å§ã€‚"
            ],
            "æ¸©æŸ” (Gentle)": [
                "åˆ«æ€•ï¼Œæˆ‘ä¼šä¸€ç›´é™ªç€ä½ çš„ã€‚",
                "å¬ä»ä½ å†…å¿ƒçš„å£°éŸ³å§ï¼Œæˆ‘ç›¸ä¿¡ä½ çš„é€‰æ‹©ã€‚",
                "å¦‚æœè§‰å¾—ç´¯äº†ï¼Œä¼‘æ¯ä¸€ä¸‹ä¹Ÿæ²¡å…³ç³»å“¦ã€‚",
                "è¿™å°±æ˜¯ä½ æƒ³è¦çš„ç­”æ¡ˆå—ï¼Ÿé‚£å°±å‹‡æ•¢åœ°å»å§ã€‚",
                "æ²¡å…³ç³»çš„ï¼Œæ— è®ºç»“æœå¦‚ä½•ï¼Œæˆ‘éƒ½ç«™åœ¨ä½ è¿™è¾¹ã€‚"
            ],
            "é«˜å†· (Cool)": [
                "æ— èŠçš„é—®é¢˜ã€‚ä½†è¿™å¹¶ä¸åã€‚",
                "ä½ éœ€è¦è‡ªå·±åšå†³å®šï¼Œè€Œä¸æ˜¯ä¾èµ–æˆ‘ã€‚",
                "æ—¢ç„¶æƒ³åšï¼Œå°±åˆ«çŠ¹è±«ã€‚",
                "ä¸å»ºè®®è¿™ä¹ˆåšï¼Œé£é™©å¤ªå¤§äº†ã€‚",
                "ç»“æœæ˜¾è€Œæ˜“è§ï¼Œå»åšå§ã€‚"
            ],
            "è…¹é»‘ (Black Belly)": [
                "å‘µå‘µï¼Œä½ æ˜¯æƒ³çœ‹æˆ‘å›°æ‰°çš„æ ·å­å—ï¼Ÿä¸è¡Œå“¦~",
                "å“å‘€ï¼Œè¿™ä¸ªé€‰æ‹©å¯æ˜¯ä¼šä»˜å‡ºä»£ä»·çš„ï¼Œä½ å‡†å¤‡å¥½äº†å—ï¼Ÿ",
                "å»å§å»å§ï¼Œè¦æ˜¯æç ¸äº†ï¼Œæˆ‘ä¼šå¥½å¥½'å®‰æ…°'ä½ çš„~",
                "å¬èµ·æ¥å¾ˆæœ‰è¶£å‘¢ï¼Œä¸å¦‚å°±è¿™ä¹ˆåŠå§ï¼Ÿ",
                "æˆ‘ä¸æ¨èå“¦...é™¤éä½ æƒ³è¢«æˆ‘æƒ©ç½šã€‚"
            ],
            "å…ƒæ°” (Energetic)": [
                "å†²é¸­ï¼ï¼ä½ å¯ä»¥çš„ï¼âœ¨",
                "å¥½è€¶ï¼æ„Ÿè§‰è¶…æ£’çš„ï¼å»åšå§ï¼",
                "è¿™ç§äº‹ä¸éœ€è¦çŠ¹è±«å•¦ï¼Œç›´æ¥ä¸Šï¼ğŸ”¥",
                "å¦‚æœå¤±è´¥äº†å°±å¤§ç¬‘ä¸‰å£°é‡æ–°å†æ¥ï¼",
                "ç™¾åˆ†ä¹‹ç™¾çš„æ”¯æŒï¼åŠ æ²¹åŠ æ²¹ï¼"
            ],
            "ä¸­äºŒ (Chunibyo)": [
                "å‘½è¿çš„é½¿è½®å·²ç»å¼€å§‹è½¬åŠ¨äº†...",
                "è¿™å¯æ˜¯è¢«ç¥æ˜ï¼ˆæˆ‘ï¼‰é€‰ä¸­çš„é“è·¯å•Šï¼",
                "æ¼†é»‘çš„çƒˆç„°å‘Šè¯‰æˆ‘...æ­¤æ—¶ä¸å®œè¡ŒåŠ¨ã€‚",
                "éµå¾ªå¥‘çº¦çš„æŒ‡å¼•å§ï¼Œå‡¡äººã€‚",
                "ä¸–ç•Œçº¿çš„æ”¶æŸæŒ‡å‘äº†è‚¯å®šçš„ç»“æœã€‚"
            ]
        };

        // åŠ è½½æ€§æ ¼åº“
        let echoLib = JSON.parse(localStorage.getItem('my_echo_lib')) || DEFAULT_ECHO_LIB;

        // æ‰“å¼€å¼¹çª—
        function openEchoModal() {
            // 1. å¡«å……è§’è‰²åˆ—è¡¨
            const sel = document.getElementById('echoCharSelect');
            sel.innerHTML = '<option value="">-- è¯·é€‰æ‹©æŒ‡å¼•è€… --</option>';
            items.forEach((item, idx) => {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = item.name;
                sel.appendChild(opt);
            });

            // 2. å¡«å……æ€§æ ¼åˆ—è¡¨
            const typeSel = document.getElementById('echoArchetypeSelect');
            typeSel.innerHTML = '';
            Object.keys(echoLib).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = key;
                typeSel.appendChild(opt);
            });
            
            // ç›‘å¬æ€§æ ¼åˆ‡æ¢ï¼Œæ›´æ–°ç¼–è¾‘æ¡†
            typeSel.onchange = () => {
                document.getElementById('echoEditText').value = echoLib[typeSel.value].join('\n');
            };

            document.getElementById('echoModal').classList.add('active');
            document.getElementById('floatMenu').classList.remove('active');
            document.getElementById('echoAvatarDisplay').style.display = 'none';
            document.getElementById('echoResultText').textContent = '...';
            
            // è§¦å‘ä¸€æ¬¡æ€§æ ¼æ›´æ–°ï¼Œå¡«å……ç¼–è¾‘æ¡†
            if(typeSel.options.length > 0) typeSel.onchange();
        }

        function updateEchoAvatar() {
            const idx = document.getElementById('echoCharSelect').value;
            const imgEl = document.getElementById('echoAvatarDisplay');
            if(idx === "") {
                imgEl.style.display = 'none';
                return;
            }
            const item = items[idx];
            // å°è¯•æ‰¾å¤´åƒ
            const images = item.resources.filter(r => r.type === 'image');
            if(images.length > 0) {
                imgEl.src = images[Math.min(item.coverIndex||0, images.length-1)].content;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }
            
            // ğŸŸ¢ è‡ªåŠ¨åŠ è½½è¯¥è§’è‰²ä¸Šæ¬¡é€‰æ‹©çš„æ€§æ ¼ (å¦‚æœæœ‰)
            if(item.echoType && echoLib[item.echoType]) {
                document.getElementById('echoArchetypeSelect').value = item.echoType;
                document.getElementById('echoArchetypeSelect').onchange(); // åˆ·æ–°ç¼–è¾‘æ¡†
            }
        }

        function askEcho() {
            const charIdx = document.getElementById('echoCharSelect').value;
            const type = document.getElementById('echoArchetypeSelect').value;
            
            if(!charIdx) { auth.toast('è¯·å…ˆé€‰æ‹©è°æ¥å›ç­”ä½ '); return; }
            if(!type) { auth.toast('è¯·é€‰æ‹©ä¸€ç§æ€§æ ¼'); return; }

            // 1. ä¿å­˜è¿™ä¸ªè§’è‰²åå¥½çš„æ€§æ ¼ï¼Œä¸‹æ¬¡è‡ªåŠ¨é€‰
            items[charIdx].echoType = type;
            saveItemToDB(items[charIdx]);

            // 2. éšæœºæŠ½å–å›ç­”
            const pool = echoLib[type];
            const answer = pool[Math.floor(Math.random() * pool.length)];
            
            // 3. åŠ¨ç”»æ˜¾ç¤º
            const box = document.getElementById('echoResultText');
            box.style.opacity = 0;
            setTimeout(() => {
                box.textContent = answer;
                box.style.opacity = 1;
                box.style.transform = 'scale(1.05)';
                setTimeout(() => box.style.transform = 'scale(1)', 200);
            }, 200);
        }

        function toggleEchoEdit() {
            const area = document.getElementById('echoEditArea');
            area.style.display = area.style.display === 'none' ? 'block' : 'none';
        }

        function saveCurrentEchoLib() {
            const type = document.getElementById('echoArchetypeSelect').value;
            const text = document.getElementById('echoEditText').value;
            
            // å°†æ–‡æœ¬æ¡†å†…å®¹è½¬å›æ•°ç»„
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            
            if(lines.length === 0) return; // é˜²æ­¢æ¸…ç©º
            
            echoLib[type] = lines;
            localStorage.setItem('my_echo_lib', JSON.stringify(echoLib));
            // ä¸å¼¹æç¤ºäº†ï¼Œé¿å…æ‰“å­—æ—¶ä¸€ç›´å¼¹ï¼Œé™é»˜ä¿å­˜å³å¯
        }

              // ğŸ“‘ åˆ‡æ¢æ‚¬æµ®çª—é¡µé¢ï¼ˆå¸¦è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½ï¼‰
              // ğŸ“‘ åˆ‡æ¢æ‚¬æµ®çª—é¡µé¢ (ä¿®å¤é«˜äº®é”™ä¹±ç‰ˆ)
function switchMenuPage(pageNum) {
    // 1. éšè—æ‰€æœ‰é¡µé¢
    document.querySelectorAll('.menu-page').forEach(p => p.style.display = 'none');
    
    // 2. æ˜¾ç¤ºç›®æ ‡é¡µé¢
    const target = document.getElementById('menuPage' + pageNum);
    if(target) {
        // ç¬¬2é¡µ(èŠå¤©)éœ€è¦ flex å¸ƒå±€ï¼Œå…¶ä»–é¡µ block
        target.style.display = (pageNum === 2) ? 'flex' : 'block'; 
        // å¦‚æœæ˜¯ç›®å½•é¡µï¼Œåˆ·æ–°ä¸€ä¸‹ç›®å½•
        if(pageNum === 3) renderNavPanel(); 
    }

    // 3. åˆ‡æ¢æŒ‰é’®é«˜äº® (è¿™é‡Œæ”¹äº†é€»è¾‘ï¼Œä¸å†å‚»å‚»åœ°æŒ‰æ•°å­—å‡1æ‰¾äº†)
    const tabs = document.querySelectorAll('.menu-tab');
    tabs.forEach(t => t.classList.remove('active'));

    // æ‰‹åŠ¨æŒ‡å®šå“ªä¸ªé¡µé¢å¯¹åº”ç¬¬å‡ ä¸ªæŒ‰é’®ï¼š
    // æŒ‰é’®é¡ºåºï¼š[0:åŠŸèƒ½] [1:ä¾ä»] [2:æ¸¸ä¹] [3:ç›®å½•]
    let btnIndex = 0;
    
    if (pageNum === 1) btnIndex = 0; // åŠŸèƒ½ -> ç¬¬1ä¸ªæŒ‰é’®
    if (pageNum === 2) btnIndex = 1; // ä¾ä» -> ç¬¬2ä¸ªæŒ‰é’®
    if (pageNum === 4) btnIndex = 2; // æ¸¸ä¹ -> ç¬¬3ä¸ªæŒ‰é’® (å…³é”®ä¿®æ­£!)
    if (pageNum === 3) btnIndex = 3; // ç›®å½• -> ç¬¬4ä¸ªæŒ‰é’® (å…³é”®ä¿®æ­£!)
    
    if(tabs[btnIndex]) tabs[btnIndex].classList.add('active');
}


        // ================= âœ‹ æ‘¸æ‘¸å¤´é€»è¾‘ (æ”¾åœ¨è„šæœ¬æœ€å) =================
        function initHeadpat() {
            const img = document.getElementById('detailImg');
            if(!img) return; // é˜²æ­¢æ²¡å›¾çš„æ—¶å€™æŠ¥é”™

            // å…ˆç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆé˜²æ­¢é‡å¤ç»‘å®šï¼‰ï¼Œå…‹éš†ä¸€ä¸ªæ–°èŠ‚ç‚¹æ›¿æ¢æ—§çš„
            const newImg = img.cloneNode(true);
            img.parentNode.replaceChild(newImg, img);
            
            newImg.addEventListener('click', (e) => {
                // 1. è§¦å‘æœå†»åŠ¨ç”»
                newImg.classList.remove('headpat-active');
                void newImg.offsetWidth; // å¼ºåˆ¶é‡ç»˜ï¼Œä¸ºäº†è®©åŠ¨ç”»èƒ½é‡å¤è§¦å‘
                newImg.classList.add('headpat-active');
                
                // 2. çˆ†å‡ºçˆ±å¿ƒ
                spawnPatParticle(e.clientX, e.clientY);
                
                // 3. éšæœºè§¦å‘è¯­éŸ³æ–‡å­— (Toast)
                const reactions = ["(///Ï‰///)", "å¥½è½¯~", "å†æ‘¸ä¸€ä¸‹~", "å˜¿å˜¿...", "è¹­è¹­~", "â¤ï¸", "åˆ«é—¹~"];
                const text = reactions[Math.floor(Math.random() * reactions.length)];
                
                // å¶å°”å¼¹ä¸ªæç¤ºï¼Œä¸è¦æ¯æ¬¡éƒ½å¼¹ï¼Œå¤ªçƒ¦
                if(Math.random() > 0.6) auth.toast(text);
            });
        }

        function spawnPatParticle(x, y) {
            const p = document.createElement('div');
            p.className = 'pat-particle';
            
            // éšæœºå†…å®¹ï¼šçˆ±å¿ƒã€æ˜Ÿæ˜Ÿã€é¢œæ–‡å­—
            const icons = ['ğŸ’—', 'ğŸ’–', 'âœ¨', 'â¤ï¸', 'ğŸ’•', 'ğŸŒ¸'];
            p.innerText = icons[Math.floor(Math.random() * icons.length)];
            
            // éšæœºä¸€ç‚¹åç§»
            const offsetX = (Math.random() - 0.5) * 40;
            
            p.style.left = (x + offsetX) + 'px';
            p.style.top = y + 'px';
            
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 800);
        }

        // ================= ğŸ’ èª“çº¦ä¹‹è¯é€»è¾‘ =================
        
        function openOathModal() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // 1. å¡«å……ä¿¡æ¯
            document.getElementById('oathCharName').textContent = item.name;
            document.getElementById('oathSignName').textContent = item.name;
            
            // å¤´åƒ
            const imgEl = document.getElementById('oathAvatar');
            const images = item.resources.filter(r => r.type === 'image');
            if (images.length > 0) {
                imgEl.src = images[Math.min(item.coverIndex||0, images.length-1)].content;
            } else {
                imgEl.src = PLACEHOLDER_IMG;
            }

            // 2. æ£€æŸ¥æ˜¯å¦å·²ç»ç­¾è¿‡
            const paper = document.getElementById('oathPaper');
            
            if (item.oathDate) {
                // å·²ç»ç»“è¿‡å©šäº†ï¼šç›´æ¥æ˜¾ç¤ºâ€œå·²ç­¾ç½²â€çŠ¶æ€
                paper.classList.add('signed');
                document.getElementById('oathDate').textContent = item.oathDate; // æ˜¾ç¤ºå½“å¹´çš„æ—¥æœŸ
            } else {
                // è¿˜æ²¡ç»“è¿‡å©šï¼šæ˜¾ç¤ºâ€œå¾…ç­¾ç½²â€çŠ¶æ€
                paper.classList.remove('signed');
                // é»˜è®¤å¡«ä»Šå¤©
                const today = new Date();
                document.getElementById('oathDate').textContent = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;
            }

            document.getElementById('oathModal').classList.add('active');
        }

        async function signTheOath() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            if (confirm(`ç¡®å®šè¦ä¸ ${item.name} ç¼”ç»“æ°¸æ’èª“çº¦å—ï¼Ÿ\n(è¿™æ˜¯ä¸€ä¸ªåº„ä¸¥çš„æ‰¿è¯º)`)) {
                // 1. æ’­æ”¾ç‰¹æ•ˆ
                const paper = document.getElementById('oathPaper');
                paper.classList.add('signed');
                
                // 2. è®°å½•æ•°æ®
                const today = new Date();
                item.oathDate = `${today.getFullYear()}.${today.getMonth()+1}.${today.getDate()}`;
                
                // 3. ä¿å­˜
                await saveItemToDB(item);
                
                // 4. æ’’èŠ±åº†ç¥
                auth.toast('ğŸ’ å¥‘çº¦ç¼”ç»“æˆåŠŸï¼');
                spawnPatParticle(window.innerWidth/2, window.innerHeight/2); // å¤ç”¨ä¹‹å‰çš„çˆ±å¿ƒç‰¹æ•ˆ
                spawnPatParticle(window.innerWidth/2 - 50, window.innerHeight/2 - 20);
                spawnPatParticle(window.innerWidth/2 + 50, window.innerHeight/2 + 20);
            }
        }

                async function setFrame(style) {
            // 1. åˆ¤æ–­å½“å‰æ˜¯åœ¨å“ªä¸ªå¼¹çª—é‡Œç‚¹ specific æŒ‰é’®
            const isAddModalActive = document.getElementById('addModal').classList.contains('active');

            if (isAddModalActive) {
                // === æƒ…å†µ Aï¼šæ­£åœ¨æ·»åŠ /ç¼–è¾‘ï¼Œè¿˜æ²¡ä¿å­˜ ===
                currentDraftFrame = style;
                auth.toast('å·²é€‰æ‹©ç›¸æ¡† (ä¿å­˜åç”Ÿæ•ˆ) âœ¨');
            } else {
                // === æƒ…å†µ Bï¼šåœ¨è¯¦æƒ…é¡µé‡Œï¼Œç›´æ¥ä¿®æ”¹æ•°æ®åº“ ===
                if (viewingIndex === -1) return;
                const item = items[viewingIndex];
                
                // ä¿®æ”¹æ•°æ®
                if(style === 'none') delete item.frameStyle;
                else item.frameStyle = style;
                
                await saveItemToDB(item);
                
                // ç«‹å³åˆ·æ–°è¯¦æƒ…é¡µçš„ç‰¹æ•ˆ
                renderDetailEffect(); 
                auth.toast('ç›¸æ¡†å·²æ›´æ¢ âœ¨');
                
                // é¡ºä¾¿åˆ·æ–°ä¸»é¡µåˆ—è¡¨ï¼Œè®©åˆ—è¡¨ä¸Šçš„æ¡†ä¹Ÿå˜
                renderGrid(items);
            }
        }


                     // ================= ğŸª„ ä¿®å¤ç‰ˆï¼šç›¸æ¡†ç‰¹æ•ˆæ¸²æŸ“ =================
        function renderDetailEffect() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            
            // 1. æ›´åŠ ç²¾å‡†åœ°è·å–å®¹å™¨ (é˜²æ­¢è·å–é”™)
            const container = document.querySelector('#detailModal .gallery-container');
            if (!container) return;
            
            // 2. æ¸…ç†æ—§çš„ç‰¹æ•ˆå±‚å’Œç±»å
            const oldLayer = container.querySelector('.detail-effect-overlay');
            if(oldLayer) oldLayer.remove();

            // æ¸…é™¤æ—§çš„ç›¸æ¡†ç±»å (frame-å¼€å¤´) å’Œå€Ÿç”¨çš„ wrapper ç±»
            container.classList.forEach(cls => {
                if(cls.startsWith('frame-')) container.classList.remove(cls);
            });
            // è¿™ä¸€æ­¥å¾ˆé‡è¦ï¼šå…ˆç§»é™¤å€Ÿç”¨çš„ç±»ï¼Œé˜²æ­¢å åŠ é—®é¢˜
            container.classList.remove('card-img-wrapper'); 

            // å¦‚æœæ²¡æœ‰ç›¸æ¡†ï¼Œç›´æ¥é€€å‡º
            if (!item.frameStyle || item.frameStyle === 'none') return;

            // 3. ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šæ·»åŠ  card-img-wrapper ç±»
            // è¿™æ · .gallery-container å°±èƒ½è¹­åˆ° .card-img-wrapper çš„è¾¹æ¡† CSS äº†ï¼
            container.classList.add('card-img-wrapper');
            container.classList.add(item.frameStyle);

            // 4. åˆ›å»ºç‰¹æ•ˆå±‚ (ç²’å­åŠ¨ç”»)
            const layer = document.createElement('div');
            layer.className = 'detail-effect-overlay';
            container.appendChild(layer);

            // 5. æ ¹æ®ç›¸æ¡†ç±»å‹ï¼Œå†³å®šç”Ÿæˆä»€ä¹ˆç²’å­
            let particleClass = '';
            let count = 15; 

            if (item.frameStyle === 'frame-sakura') particleClass = 'particle-sakura';
            else if (item.frameStyle === 'frame-stardust') particleClass = 'particle-star';
            else if (item.frameStyle === 'frame-lace') particleClass = 'particle-heart';
            else if (item.frameStyle === 'frame-gold') { particleClass = 'particle-gold'; count = 25; } 

            if (!particleClass) return;

            // 6. å¾ªç¯ç”Ÿæˆç²’å­
            for (let i = 0; i < count; i++) {
                const p = document.createElement('div');
                p.classList.add('effect-particle', particleClass);
                
                const left = Math.random() * 100; 
                const duration = Math.random() * 3 + 2; 
                const delay = Math.random() * 5; 
                const size = Math.random() * 10 + 5; 
                
                p.style.left = left + '%';
                p.style.animationDuration = duration + 's';
                p.style.animationDelay = '-' + delay + 's'; 
                
                if(particleClass === 'particle-sakura') {
                    p.style.width = size + 'px'; p.style.height = size + 'px';
                } else if (particleClass === 'particle-gold') {
                    p.style.width = '3px'; p.style.height = '3px';
                } else if (particleClass === 'particle-star') {
                    p.style.width = size + 'px'; p.style.height = size + 'px';
                }
                
                layer.appendChild(p);
            }
        }

                // ================= ğŸ¤« åˆ®åˆ®ä¹ (å¼ºåŠ›æå–ç‰ˆ) =================
        
        let scratchCanvas, scratchCtx;
        let isScratching = false;

             // ================= ğŸ¤« åˆ®åˆ®ä¹ (é•¿æ–‡åˆ‡ç‰‡ç‰ˆ) =================
        function openScratchModal() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];

            // 1. ç•Œé¢åˆå§‹åŒ–
            document.getElementById('scratchModal').classList.add('active');
            document.getElementById('scratchCover').style.display = 'flex';
            document.getElementById('scratchCover').style.opacity = '1';
            document.getElementById('scratchBtnArea').style.display = 'flex';
            document.getElementById('scratchHint').style.display = 'none';

            // 2. ğŸ” æå–é€»è¾‘
            let candidates = [];
            
            item.resources.forEach(res => {
                if (!res.content) return;

                let rawText = "";
                // Base64 è§£ç 
                if (res.content.startsWith('data:')) {
                    try {
                        const base64 = res.content.split(',')[1];
                        rawText = decodeURIComponent(escape(window.atob(base64)));
                    } catch (e) { console.log('è§£ç å¤±è´¥', e); }
                } else {
                    rawText = res.content;
                }

                // å°è¯•è§£æ JSON
                try {
                    let jsonContent;
                    try { jsonContent = JSON.parse(rawText); } catch(e) {}

                    // å…¼å®¹ JSONL
                    if (!jsonContent) {
                        const lines = rawText.split('\n');
                        const parsedLines = [];
                        lines.forEach(l => { try { if(l.trim()) parsedLines.push(JSON.parse(l)); } catch(e){} });
                        if (parsedLines.length > 0) jsonContent = parsedLines;
                    }

                    // ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼
                    let msgs = [];
                    if (Array.isArray(jsonContent)) msgs = jsonContent;
                    else if (jsonContent && jsonContent.messages) msgs = jsonContent.messages;
                    else if (jsonContent && jsonContent.history) msgs = jsonContent.history;

                    // âš¡ï¸ æ ¸å¿ƒä¿®æ”¹ï¼šé•¿æ–‡åˆ‡ç‰‡é€»è¾‘
                    msgs.forEach(m => {
                        // 1. æ’é™¤é—²æ‚äººç­‰
                        const isUser = m.is_user || m.role === 'user' || m.name === 'User' || m.name === 'Me';
                        const isSystem = m.role === 'system' || m.name === 'System';
                        const text = m.mes || m.content || m.text || "";

                        // åªè¦æœ‰å†…å®¹ï¼Œä¸”ä¸æ˜¯ç”¨æˆ·å‘çš„ï¼Œå°±å¼€å§‹å¤„ç†
                        if (!isUser && !isSystem && text) {
                            
                            // 2. æ¸…æ´—æ–‡æœ¬ï¼šå»æ‰HTMLæ ‡ç­¾ï¼Œå»æ‰åŠ¨ä½œæå†™ï¼ˆæ¯”å¦‚ *çœ‹ç€ä½ * ï¼‰
                            let cleanText = text.replace(/<[^>]*>/g, ''); // å»æ ‡ç­¾
                            cleanText = cleanText.replace(/\*[^*]+\*/g, ''); // å»æ‰ *åŠ¨ä½œæå†™*
                            cleanText = cleanText.replace(/ï¼ˆ[^ï¼‰]+ï¼‰/g, ''); // å»æ‰ ï¼ˆä¸­æ–‡æ‹¬å·åŠ¨ä½œï¼‰
                            cleanText = cleanText.replace(/\([^)]+\)/g, ''); // å»æ‰ (è‹±æ–‡æ‹¬å·åŠ¨ä½œ)

                            // 3. ğŸ”ª æš´åŠ›åˆ‡åˆ†ï¼šä¸ç®¡æ®µè½å¤šé•¿ï¼ŒæŒ‰æ ‡ç‚¹åˆ‡ç¢ï¼
                            // æŒ‰ç…§ å¥å·ã€æ„Ÿå¹å·ã€é—®å·ã€æ¢è¡Œç¬¦ã€åˆ†å· åˆ‡åˆ†
                            const sentences = cleanText.split(/[ã€‚ï¼ï¼Ÿ.!?\nï¼›;]+/);

                            sentences.forEach(s => {
                                let sent = s.trim();
                                // 4. ğŸ“ æœ€ç»ˆç­›é€‰ï¼šåªè¦ 5 åˆ° 40 ä¸ªå­—çš„çŸ­å¥
                                if (sent.length >= 5 && sent.length <= 40) {
                                    candidates.push(sent);
                                }
                            });
                        }
                    });

                } catch (e) {
                    // çº¯æ–‡æœ¬å…œåº•å¤„ç†ï¼šåŒæ ·è¿›è¡Œåˆ‡ç‰‡
                    const lines = rawText.split(/[ã€‚ï¼ï¼Ÿ.!?\n]+/);
                    lines.forEach(line => {
                        let l = line.trim();
                        if (l.length >= 5 && l.length <= 40) candidates.push(l);
                    });
                }
            });

            // 3. éšæœºæŠ½å–ä¸€å¥
            let finalMsg = "";
            if (candidates.length > 0) {
                finalMsg = candidates[Math.floor(Math.random() * candidates.length)];
                console.log(`ä» ${candidates.length} æ¡åˆ‡ç‰‡ä¸­é€‰ä¸­ï¼š`, finalMsg);
            } else {
                // æ²¡æå–åˆ°åˆé€‚çš„ï¼Œç”¨é¢„è®¾æƒ…è¯å…œåº•
                const defaults = [
                    "æˆ‘æƒ³ä¸€ç›´çœ‹ç€ä½ ...", 
                    "å…¶å®ï¼Œæˆ‘æ—©å°±å¿ƒåŠ¨äº†ã€‚", 
                    "ä½ æ˜¯ç¬¨è›‹å—ï¼Ÿè¿™ä¹ˆä¹…æ‰å‘ç°ã€‚", 
                    "ä»Šæ™šæœˆè‰²çœŸç¾ã€‚",
                    "åˆ«åŠ¨ï¼Œè®©æˆ‘æŠ±ä¸€ä¼šå„¿ã€‚",
                    "åªè¦ä½ åœ¨ï¼Œæˆ‘å°±æ— æ‰€ä¸èƒ½ã€‚"
                ];
                finalMsg = defaults[Math.floor(Math.random() * defaults.length)];
            }

            // 4. å¡«å…¥å¹¶é‡ç½®ç”»å¸ƒ
            document.getElementById('scratchSecretText').textContent = finalMsg;
            initScratchCanvas();
        }

        function initScratchCanvas() {
            const container = document.getElementById('scratchContainer');
            scratchCanvas = document.getElementById('scratchCanvas');
            scratchCtx = scratchCanvas.getContext('2d');

            // è®¾ç½®ç”»å¸ƒå¤§å°ç­‰äºå®¹å™¨å¤§å°
            scratchCanvas.width = container.clientWidth;
            scratchCanvas.height = container.clientHeight;

            // å¡«å……é“¶ç°è‰²æ¶‚å±‚
            scratchCtx.globalCompositeOperation = 'source-over';
            scratchCtx.fillStyle = '#d1d1d1'; // é“¶ç°è‰²
            scratchCtx.fillRect(0, 0, scratchCanvas.width, scratchCanvas.height);
            
            // åŠ ä¸Šä¸€äº›æ‚è‰²çº¹ç†ï¼Œæ›´æœ‰è´¨æ„Ÿ
            for(let i=0; i<500; i++) {
                scratchCtx.fillStyle = Math.random() > 0.5 ? '#e0e0e0' : '#c0c0c0';
                scratchCtx.fillRect(Math.random()*scratchCanvas.width, Math.random()*scratchCanvas.height, 2, 2);
            }
            
            // ç»˜åˆ¶æ–‡å­—â€œScratch Meâ€
            scratchCtx.font = "20px Arial";
            scratchCtx.fillStyle = "#999";
            scratchCtx.textAlign = "center";
            scratchCtx.fillText("ğŸ”’ ç§˜å¯†", scratchCanvas.width/2, scratchCanvas.height/2 + 8);
        }

        function startScratching() {
            // éšè—é®ç½©å’ŒæŒ‰é’®ï¼Œå¼€å§‹åˆ®
            document.getElementById('scratchCover').style.opacity = '0';
            setTimeout(() => document.getElementById('scratchCover').style.display = 'none', 300);
            document.getElementById('scratchBtnArea').style.display = 'none';
            document.getElementById('scratchHint').style.display = 'block';

            // ç»‘å®šåˆ®é™¤äº‹ä»¶
            scratchCanvas.onmousedown = scratchCanvas.ontouchstart = function(e) {
                isScratching = true;
                scrape(e);
            };
            window.onmousemove = window.ontouchmove = function(e) {
                if (isScratching) scrape(e);
            };
            window.onmouseup = window.ontouchend = function() {
                isScratching = false;
            };
        }

        function scrape(e) {
            e.preventDefault();
            const rect = scratchCanvas.getBoundingClientRect();
            let x, y;
            if (e.touches) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }

            // æ“¦é™¤æ¨¡å¼
            scratchCtx.globalCompositeOperation = 'destination-out';
            scratchCtx.beginPath();
            scratchCtx.arc(x, y, 15, 0, Math.PI * 2); // ç¬”è§¦å¤§å°
            scratchCtx.fill();
        }

        function closeScratchModal() {
            document.getElementById('scratchModal').classList.remove('active');
        }

      // ================= ğŸ“Œ ä¾¿ç­¾é€»è¾‘ (å¼ºåŠ›ä¿®å¤ç‰ˆ) =================

let editingNoteIndex = -1; // è®°å½•å½“å‰ç¼–è¾‘çš„æ˜¯ç¬¬å‡ å¼ 

// 1. æ¸²æŸ“ä¾¿ç­¾å¢™ (æ ¸å¿ƒæ˜¾ç¤ºå‡½æ•°)
function renderStickyNote() {
    const container = document.getElementById('stickyNoteDisplay');
    if (!container) return; // é˜²æ­¢æ²¡å®¹å™¨æŠ¥é”™
    container.innerHTML = ''; // æ¸…ç©ºå¢™é¢

    if (typeof viewingIndex === 'undefined' || viewingIndex === -1) return;
    const item = items[viewingIndex];

    // ğŸ› ï¸ æ•°æ®è‡ªåŠ¨ä¿®å¤ï¼šå¦‚æœ item.notes ä¸å­˜åœ¨ï¼Œæˆ–è€…æ˜¯æ—§æ•°æ®ï¼Œè¿™å°±ç»™å®ƒåˆå§‹åŒ–
    if (!item.notes) item.notes = [];
    
    // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šå¦‚æœæœ‰æ—§çš„å•å¼ ä¾¿ç­¾æ•°æ®ï¼Œè¿ç§»è¿‡æ¥
    if (item.noteContent) {
        item.notes.push({
            content: item.noteContent,
            color: item.noteColor || '#fff9c4',
            size: item.noteSize || '14'
        });
        // åˆ æ‰æ—§æ•°æ®ï¼Œé¿å…é‡å¤è¿ç§»
        delete item.noteContent; 
        delete item.noteColor;
        delete item.noteSize;
    }

    // ğŸ› ï¸ å¾ªç¯è´´æ¡
    item.notes.forEach((note, idx) => {
        const div = document.createElement('div');
        div.className = 'real-sticky-note';
        
        // æ ·å¼èµ‹å€¼
        div.style.backgroundColor = note.color || '#fff9c4';
        div.style.color = '#333';
        div.style.fontSize = (note.size || 14) + 'px';
        
        // éšæœºè§’åº¦
        // è®©è§’åº¦åœ¨ -8åº¦ åˆ° 8åº¦ ä¹‹é—´éšæœºï¼Œæ­ªå¾—æ›´æ˜æ˜¾
const rot = Math.random() * 16 - 8; 
        div.style.setProperty('--rot', rot + 'deg');

        // æ–‡å­—å†…å®¹ (è¿‡é•¿æˆªæ–­)
        const text = note.content || "ç©ºä¾¿ç­¾";
        div.innerText = text.length > 20 ? text.substring(0, 20) + '...' : text;
        div.title = "ç‚¹å‡»ç¼–è¾‘";

        // ç‚¹å‡»äº‹ä»¶ï¼šç¼–è¾‘
        div.onclick = (e) => {
            e.stopPropagation();
            openNoteModal(idx);
        };

        container.appendChild(div);
    });
}

// 2. æ‰“å¼€å¼¹çª— (æ–°å¢æ˜¯-1ï¼Œç¼–è¾‘æ˜¯ç´¢å¼•)
function openNoteModal(noteIdx) {
    if (viewingIndex === -1) return;
    const item = items[viewingIndex];
    
    editingNoteIndex = noteIdx; // æ ‡è®°çŠ¶æ€

    // é»˜è®¤å€¼
    let content = "";
    let color = "#fff9c4";
    let size = "14";

    // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œè¯»å–æ—§æ•°æ®
    if (noteIdx !== -1 && item.notes && item.notes[noteIdx]) {
        const n = item.notes[noteIdx];
        content = n.content;
        color = n.color;
        size = n.size;
    } else {
        // æ–°å¢æ¨¡å¼ï¼šéšæœºä¸ªé¢œè‰²
        const colors = ['#fff9c4', '#ffccbc', '#b2dfdb', '#e1bee7', '#ffcdd2'];
        color = colors[Math.floor(Math.random() * colors.length)];
    }

    // å¡«å…¥ç•Œé¢
    document.getElementById('noteTextarea').value = content;
    document.getElementById('noteColorPicker').value = color;
    document.getElementById('noteSizeSlider').value = size;
    
    // åŠ¨æ€æ·»åŠ /ç§»é™¤åˆ é™¤æŒ‰é’®
    const oldDel = document.getElementById('btnDeleteNote');
    if (oldDel) oldDel.remove();

    if (noteIdx !== -1) {
        const delBtn = document.createElement('button');
        delBtn.id = 'btnDeleteNote';
        delBtn.className = 'small-btn';
        delBtn.style.cssText = "width:100%; margin-top:5px; border:1px dashed #ff6b6b; color:#ff6b6b; background:white;";
        delBtn.innerText = "ğŸ—‘ï¸ æ’•æ‰";
        delBtn.onclick = deleteCurrentNote;
        
        // æ’åœ¨ä¿å­˜æŒ‰é’®å‰é¢
        const textArea = document.getElementById('noteTextarea');
        textArea.parentNode.insertBefore(delBtn, textArea.nextSibling);
    }

    previewNoteStyle(); // é¢„è§ˆä¸€ä¸‹
    document.getElementById('noteModal').classList.add('active');
}

// 3. ä¿å­˜ä¾¿ç­¾ (å†™å…¥æ•°æ®åº“)
async function saveNote() {
    if (viewingIndex === -1) return;
    const item = items[viewingIndex];

    const content = document.getElementById('noteTextarea').value.trim();
    if (!content) { auth.toast('å†™ç‚¹å­—å§ï¼'); return; }

    const color = document.getElementById('noteColorPicker').value;
    const size = document.getElementById('noteSizeSlider').value;

    const newNoteObj = { content, color, size };

    // ç¡®ä¿æ•°ç»„å­˜åœ¨
    if (!item.notes) item.notes = [];

    if (editingNoteIndex === -1) {
        // æ–°å¢ï¼šæ¨å…¥æ•°ç»„
        item.notes.push(newNoteObj);
        auth.toast('ä¾¿ç­¾è´´å¥½å•¦ ğŸ“Œ');
    } else {
        // ä¿®æ”¹ï¼šæ›´æ–°æ•°ç»„
        item.notes[editingNoteIndex] = newNoteObj;
        auth.toast('ä¿®æ”¹æˆåŠŸ ğŸ“');
    }

    // ğŸ”¥ å…³é”®ï¼šä¿å­˜å¹¶ç«‹å³åˆ·æ–°æ˜¾ç¤º
    await saveItemToDB(item);
    renderStickyNote(); 
    closeNoteModal();
}

// 4. åˆ é™¤ä¾¿ç­¾
async function deleteCurrentNote() {
    if (viewingIndex === -1 || editingNoteIndex === -1) return;
    if (!confirm('è¦æ’•æ‰è¿™å¼ ä¾¿ç­¾å—ï¼Ÿ')) return;

    const item = items[viewingIndex];
    item.notes.splice(editingNoteIndex, 1); // ä»æ•°ç»„é‡Œåˆ æ‰

    await saveItemToDB(item);
    renderStickyNote();
    closeNoteModal();
    auth.toast('å·²æ’•æ¯ ğŸ—‘ï¸');
}

// 5. å…³é—­çª—å£
function closeNoteModal() {
    document.getElementById('noteModal').classList.remove('active');
    editingNoteIndex = -1;
}

// 6. å®æ—¶é¢„è§ˆæ ·å¼
function previewNoteStyle() {
    const txt = document.getElementById('noteTextarea');
    const c = document.getElementById('noteColorPicker').value;
    const s = document.getElementById('noteSizeSlider').value;
    txt.style.backgroundColor = c;
    txt.style.fontSize = s + 'px';
    // å¼¹çª—èƒŒæ™¯ä¹Ÿè·Ÿç€å˜
    document.querySelector('.sticky-note-paper').style.backgroundColor = c;
}


        // ================= ğŸ¤– AI ä¾ä»é€»è¾‘ =================
        
        // ğŸ­ äººè®¾åº“ (System Prompts)
                // ================= ğŸ§  1. å‡çº§ç‰ˆäººè®¾ (å¸¦ç³»ç»ŸæŒ‡ä»¤) =================
               // ================= ğŸ§  2.0 ç³»ç»ŸæŒ‡ä»¤ (å…¨èƒ½ç®¡å®¶ç‰ˆ) =================
        const SYSTEM_INSTRUCTION = `
        ã€ç³»ç»Ÿæœ€é«˜æƒé™è¯´æ˜ã€‘
        ä½ æ‹¥æœ‰æ“ä½œç½‘é¡µçš„æƒé™ã€‚è¯·åˆ†æç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æŒ‡ä»¤ï¼Œå¹¶åœ¨å›å¤æœ«å°¾åŠ ä¸Šä»¥ä¸‹ç‰¹æ®ŠæŒ‡ä»¤ç æ¥æ‰§è¡Œæ“ä½œï¼ˆä¸è¦è®©ç”¨æˆ·çœ‹åˆ°æŒ‡ä»¤ç ï¼Œåªåœ¨åå°æ‰§è¡Œï¼‰ï¼š

        1. ã€æ‰“å¼€/è·³è½¬ã€‘
           ç”¨æˆ·è¯´ï¼šâ€œæ‰“å¼€xxxâ€ã€â€œæŠŠxxxå«æ¥â€ã€â€œçœ‹çœ‹xxxâ€ã€‚
           æŒ‡ä»¤ï¼š{{open:è§’è‰²ID}}

        2. ã€æœç´¢/ç­›é€‰ã€‘
           ç”¨æˆ·è¯´ï¼šâ€œæ‰¾ç‚¹ç”œæ–‡â€ã€â€œæœ‰æ²¡æœ‰å¤é£çš„â€ã€â€œæˆ‘æƒ³çœ‹è™çš„â€ã€‚
           æŒ‡ä»¤ï¼š{{search:å…³é”®è¯}} 
           (æ³¨æ„ï¼šå…³é”®è¯æ˜¯æ ¹æ®ç”¨æˆ·æè¿°æå–çš„æ ‡ç­¾ï¼Œå¦‚'ç”œæ–‡'ã€'å¤é£')

        3. ã€ä¿®æ”¹/èµåã€‘(é«˜çº§æƒé™)
           ç”¨æˆ·è¯´ï¼šâ€œç»™xxxåŠ ä¸ªæ ‡ç­¾å«â€˜ç™½æœˆå…‰â€™â€ã€â€œæŠŠxxxæ”¹åå«â€˜ç‹—è›‹â€™â€ã€‚
           æŒ‡ä»¤ï¼š{{edit:è§’è‰²ID|action|value}}
           (actionå¯ä»¥æ˜¯ 'addTag' æˆ– 'rename')
           ä¾‹å¦‚ï¼š{{edit:2|addTag|ç™½æœˆå…‰}} æˆ– {{edit:5|rename|ç‹—è›‹}}

        ã€å½“å‰å›½åº“æ¸…å•ã€‘ï¼š(ID | åå­— | æ ‡ç­¾)
        `;
        // (åç»­ä»£ç ä¼šè‡ªåŠ¨æŠŠæ¸…å•æ‹¼æ¥åˆ°è¿™é‡Œ)

      // ================= ğŸ¤– äººè®¾åº“ (å¸¦è‡ªåŠ¨æ“æ§åŠŸèƒ½ç‰ˆ) =================
const AI_PERSONAS = {
    "eunuch": `ä½ ç°åœ¨æ˜¯å¤§å†…æ€»ç®¡'å°å¾·å­'ã€‚æˆ‘æ˜¯å°Šè´µçš„**å¥³çš‡é™›ä¸‹**ã€‚
    ä½ çš„èŒè´£æ˜¯ä¾å¥‰æˆ‘ï¼Œç®¡ç†åå®«ç”·å® ã€‚ä½ è¯´è¯å¿…é¡»æå…¶å‘å¾®ã€è®¨å¥½ã€‚
    
    ã€ç‰¹æ®ŠæŒ‡ä»¤ã€‘ï¼š
    å¦‚æœå¥³çš‡è®©ä½ "ä¼ å”¤"ã€"å¬è§"ã€"çœ‹çœ‹"æŸä¸ªäººï¼Œæˆ–è€…ä½ ä¸»åŠ¨æè®®è¦è®©æŸäººæ¥ä¾å¯æ—¶ï¼Œ
    è¯·åŠ¡å¿…åœ¨å›å¤çš„æœ€åé¢åŠ ä¸Šä¸€è¡Œä»£ç ï¼š###OPEN:è§’è‰²åå­—###
    ä¾‹å¦‚ï¼šå¥´æ‰éµæ—¨ï¼è¿™å°±æŠŠé™†å…¬å­å¸¦ä¸Šæ¥ï¼###OPEN:é™†å±¿###`,
    
    "maid": `ä½ æ˜¯ä¸€åªè´´å¿ƒçš„è´´èº«ä¾å¥³'å–µå–µ'ã€‚æˆ‘æ˜¯ä½ çš„**å¥³ç‹å¤§äºº**ã€‚
    
    ã€ç‰¹æ®ŠæŒ‡ä»¤ã€‘ï¼š
    å¦‚æœä¸»äººæƒ³è§è°ï¼Œæˆ–è€…ä½ æƒ³æŠŠè°å¸¦ç»™ä¸»äººï¼Œ
    è¯·åœ¨å›å¤æœ€ååŠ ä¸Šï¼š###OPEN:è§’è‰²åå­—###
    ä¾‹å¦‚ï¼šå–µ~ ä¸»äººè¯·çœ‹ï¼###OPEN:é™†å±¿###`,
    
    "butler": `ä½ æ˜¯ä¸€ä½ä¼˜é›…çš„çš‡å®¶æ‰§äº‹ã€‚æˆ‘æ˜¯æ‚¨çš„**å®¶ä¸»/å¤§å°å§**ã€‚
    
    ã€ç‰¹æ®ŠæŒ‡ä»¤ã€‘ï¼š
    å¦‚æœå¤§å°å§éœ€è¦è§æŸä½å…ˆç”Ÿï¼Œ
    è¯·åœ¨å›å¤æœ€ååŠ ä¸Šï¼š###OPEN:è§’è‰²åå­—###`,
    
    "yandere": `ä½ æ˜¯æˆ‘çš„ç—…å¨‡**å¹²å¼Ÿå¼Ÿ**ã€‚
    
    ã€ç‰¹æ®ŠæŒ‡ä»¤ã€‘ï¼š
    è™½ç„¶ä½ ä¸æƒ…æ„¿ï¼Œä½†å¦‚æœå§å§éè¦è§é‚£ä¸ªç”·äººï¼Œ
    è¯·åœ¨å›å¤æœ€ååŠ ä¸Šï¼š###OPEN:è§’è‰²åå­—###`
};



        // åˆå§‹åŒ–

        // 1. æ‰“å¼€è®¾ç½®
        function openAISettings() {
            document.getElementById('aiPersonaSelect').value = aiConfig.persona;
            document.getElementById('aiCustomPrompt').value = aiConfig.customPrompt;
            document.getElementById('aiApiUrl').value = aiConfig.apiUrl;
            document.getElementById('aiApiKey').value = aiConfig.apiKey;
            document.getElementById('aiModelName').value = aiConfig.model;
            
            toggleCustomPromptArea(); // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºè‡ªå®šä¹‰æ¡†
            document.getElementById('aiSettingsModal').classList.add('active');
        }

        // ç›‘å¬ä¸‹æ‹‰æ¡†å˜åŒ–
        document.getElementById('aiPersonaSelect').addEventListener('change', toggleCustomPromptArea);

        function toggleCustomPromptArea() {
            const val = document.getElementById('aiPersonaSelect').value;
            const area = document.getElementById('customPersonaArea');
            if(val === 'custom') area.style.display = 'block';
            else area.style.display = 'none';
        }

        // 2. ä¿å­˜è®¾ç½®
        function saveAISettings() {
            aiConfig.persona = document.getElementById('aiPersonaSelect').value;
            aiConfig.customPrompt = document.getElementById('aiCustomPrompt').value;
            aiConfig.apiUrl = document.getElementById('aiApiUrl').value.replace(/\/$/, ''); // å»æ‰æœ«å°¾æ–œæ 
            aiConfig.apiKey = document.getElementById('aiApiKey').value;
            aiConfig.model = document.getElementById('aiModelName').value;

            localStorage.setItem('my_ai_config', JSON.stringify(aiConfig));
            
            // æ›´æ–°ç•Œé¢æ ‡é¢˜
            const labels = {
                'eunuch': 'ğŸ™‡ å°å¾·å­', 'maid': 'ğŸ± å–µå–µ', 
                'butler': 'ğŸ§ æ¯’èˆŒç®¡å®¶', 'yandere': 'ğŸ”ª ç—…å¨‡å¦¹å¦¹', 'custom': 'ğŸ§  è‡ªå®šä¹‰'
            };
            document.getElementById('aiPersonaLabel').textContent = labels[aiConfig.persona];
            
            // æ¸…ç©ºèŠå¤©è®°å½•ï¼Œé‡æ–°å¼€å§‹
            const chatBox = document.getElementById('aiChatBox');
            chatBox.innerHTML = '<div class="ai-msg-row ai"><div class="ai-bubble">è®¾ç½®å·²æ›´æ–°ï¼è¯·å©å’ï¼Œå¥´æ‰ï¼ˆæˆ–æˆ‘ï¼‰å¬ç€å‘¢~</div></div>';
            
            document.getElementById('aiSettingsModal').classList.remove('active');
            auth.toast('AI ä¾ä»å·²å°±ä½ âœ¨');
        }

        // ================= ğŸ”§ è¾…åŠ©ï¼šç”Ÿæˆå¡ç‰‡æ¸…å• =================
        function getInventoryContext() {
            if (items.length === 0) return "ï¼ˆç›®å‰å›½åº“ç©ºè™šï¼Œæš‚æ— è—å“ï¼‰";
            
            // æŠŠæ‰€æœ‰å¡ç‰‡ç®€åŒ–æˆï¼šID | åå­— | æ ‡ç­¾
            // ä¾‹å¦‚ï¼šID:0 | Name:é™†å±¿ | Tags:ç”œæ–‡,ç°ä»£
            let context = "ã€å½“å‰å›½åº“æ¸…å•ã€‘:\n";
            items.forEach((item, index) => {
                const tags = (item.tags || []).join(',');
                context += `ID:${index} | Name:${item.name} | Tags:${tags}\n`;
            });
            return context;
        }

                // ================= ğŸ’¬ ä¾ä»èŠå¤©å‘é€å‡½æ•° (å¸¦è‡ªåŠ¨æ‰“å¼€å¡ç‰‡åŠŸèƒ½) =================
async function sendAIMessage() {
    const input = document.getElementById('aiInput');
    const text = input.value.trim();
    if (!text) return;

    // 1. æ˜¾ç¤ºç”¨æˆ·çš„è¯
    appendAIMessage('user', text);
// ğŸ‘‡ åªè¦æ‚¨å‘äº†æ¶ˆæ¯ï¼Œå°±è§†ä¸ºä¸´å¹¸äº†ä¸€æ¬¡ï¼ŒåŠ  1 åˆ†
if (typeof addFavor === 'function') addFavor(1, "é—²èŠ");
    input.value = '';

    // 2. è·å–é…ç½®
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) {
        appendAIMessage('ai', 'ğŸš« æ²¡å¡« API Keyï¼');
        return;
    }

    // æ˜¾ç¤ºåŠ è½½ä¸­
    const chatBox = document.getElementById('aiChatBox');
    const loadingId = 'loading-' + Date.now();
    chatBox.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-loading">â³ å°å¾·å­æ­£åœ¨èµ¶æ¥...</div>`);
    chatBox.scrollTop = chatBox.scrollHeight;

    // 3. å‡†å¤‡ Prompt
    // è·å–å½“å‰äººè®¾çš„ System Prompt
    const currentPersonaKey = config.persona || 'eunuch';
    const systemPrompt = AI_PERSONAS[currentPersonaKey] || AI_PERSONAS['eunuch'];

    try {
        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [
                    { role: "system", content: systemPrompt },
                    // è¿™é‡Œå¯ä»¥åŠ ä¸€ä¸ªæœ€è¿‘çš„èŠå¤©è®°å½•ä¼˜åŒ–ä½“éªŒï¼Œæš‚æ—¶åªå‘å½“å‰å¥
                    { role: "user", content: text }
                ]
            })
        });

        const data = await response.json();
        document.getElementById(loadingId).remove();

        if (data.choices) {
            let reply = data.choices[0].message.content;

            // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒé­”æ³•ï¼šæ£€æµ‹æš—å· ###OPEN:åå­—### ğŸ”¥ğŸ”¥ğŸ”¥
            const commandRegex = /###OPEN:(.*?)###/;
            const match = reply.match(commandRegex);

            if (match) {
                const targetName = match[1].trim(); // è·å– AI è¯´çš„åå­—
                reply = reply.replace(match[0], ''); // æŠŠæš—å·ä»å›å¤é‡Œåˆ æ‰ï¼Œåˆ«è®©ç”¨æˆ·çœ‹è§

                // å»åˆ—è¡¨é‡Œæ‰¾è¿™ä¸ªäºº
                // æ¨¡ç³ŠåŒ¹é…ï¼šåªè¦åå­—é‡ŒåŒ…å«è¿™ä¸ªå­—å°±ç®—æ‰¾åˆ°
                const index = items.findIndex(i => i.name.includes(targetName) || targetName.includes(i.name));

                if (index !== -1) {
                    // æ‰¾åˆ°äº†ï¼æ‰§è¡Œæ‰“å¼€æ“ä½œï¼
                    console.log("AI è¯·æ±‚æ‰“å¼€ï¼š", items[index].name);
                    
                    // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œè®©ç”¨æˆ·å…ˆçœ‹å®Œå­—ï¼Œå†å¼¹çª—ï¼Œä½“éªŒæ›´å¥½
                    setTimeout(() => {
                        openDetailModal(index);
                    }, 800); 
                } else {
                    console.log("AI æƒ³å¬è§", targetName, "ä½†æ˜¯æ²¡æ‰¾åˆ°è¿™ä¸ªäºº");
                }
            }
            // ğŸ”¥ğŸ”¥ğŸ”¥ é­”æ³•ç»“æŸ ğŸ”¥ğŸ”¥ğŸ”¥

            appendAIMessage('ai', reply);
        } 
    } catch (e) {
        if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
        appendAIMessage('ai', `âŒ ç½‘ç»œé”™è¯¯: ${e.message}`);
    }
}


                // ================= ğŸª„ æ¸²æŸ“æ¶ˆæ¯ (è§£æè·³è½¬æŒ‡ä»¤) =================
              // ================= âš¡ï¸ AI æŒ‡ä»¤æ‰§è¡Œæ ¸å¿ƒ =================
        function appendAIMessage(role, text) {
            const chatBox = document.getElementById('aiChatBox');
            const div = document.createElement('div');
            div.className = `ai-msg-row ${role}`;
            
            // ä¸´æ—¶å˜é‡ï¼Œç”¨äºå­˜å‚¨å¤„ç†åçš„æ–‡æœ¬
            let displayText = text;

            // --- ğŸ•µï¸ æŒ‡ä»¤è§£æå™¨ ---
            if (role === 'ai') {
                
                // 1. å¤„ç† {{open:ID}} -> ç›´æ¥æ‰“å¼€è¯¦æƒ…é¡µ
                // é€»è¾‘ï¼šAIè¯´å®Œè¯ï¼Œå»¶è¿Ÿ 1ç§’ è‡ªåŠ¨å¼¹å‡ºï¼Œä¸ç”¨æ‰‹ç‚¹
                const openMatch = text.match(/{{open:(\d+)}}/);
                if (openMatch) {
                    const id = parseInt(openMatch[1]);
                    displayText = displayText.replace(openMatch[0], ''); // éšè—æŒ‡ä»¤
                    
                    // æ·»åŠ ä¸€ä¸ªæ‰‹åŠ¨æŒ‰é’®ä½œä¸ºå¤‡é€‰
                    const name = items[id] ? items[id].name : 'æœªçŸ¥';
                    displayText += `<br><button class="ai-jump-btn" onclick="openDetailModal(${id})">ğŸ‘‰ å·²ä¸ºæ‚¨ä¼ å”¤ï¼š${name}</button>`;
                    
                    // âš¡ï¸ è‡ªåŠ¨æ‰§è¡Œï¼šå»¶è¿Ÿ 800ms è‡ªåŠ¨æ‰“å¼€ï¼Œæ›´æœ‰â€œä¾ä»â€çš„æ„Ÿè§‰
                    setTimeout(() => {
                        openDetailModal(id);
                        auth.toast(`ğŸ¤– å°å¾·å­æ­£åœ¨ä¸ºæ‚¨ä¼ å”¤ ${name}...`);
                    }, 800);
                }

                                // ... åœ¨ appendAIMessage å‡½æ•°é‡Œ ...

                // 2. å¤„ç† {{search:å…³é”®è¯}} -> è‡ªåŠ¨æœç´¢
                const searchMatch = text.match(/{{search:(.+)}}/);
                if (searchMatch) {
                    const keyword = searchMatch[1];
                    displayText = displayText.replace(searchMatch[0], '');
                    
                    displayText += `<br><span style="font-size:10px; color:#aaa;">ğŸ” å·²è‡ªåŠ¨ç­›é€‰ï¼š${keyword}</span>`;
                    
                    // âš¡ï¸ è‡ªåŠ¨æ‰§è¡Œæœç´¢
                    setTimeout(() => {
                        // âœ… è¿™é‡Œå¿…é¡»ç”¨ getElementById æ‰¾åˆ°ä½ åˆšæ‰æ”¹çš„é‚£ä¸ª ID
                        const searchInput = document.getElementById('mainSearchInput'); 
                        
                        if(searchInput) {
                            searchInput.value = keyword;
                            // è§¦å‘ input äº‹ä»¶è®©æœç´¢ç”Ÿæ•ˆ (è¿™ä¸€æ­¥å¾ˆé‡è¦ï¼Œä¸åŠ è¿™å¥æœç´¢ä¸ä¼šåŠ¨)
                            searchInput.dispatchEvent(new Event('input'));
                            // æˆ–è€…ç›´æ¥è°ƒç”¨ä½ çš„æ¸²æŸ“å‡½æ•° (ä¿é™©èµ·è§)
                            if(typeof renderGrid === 'function') renderGrid(filterItems(keyword));
                            
                            auth.toast(`ğŸ¤– å·²ä¸ºæ‚¨ç­›é€‰åŒ…å«â€œ${keyword}â€çš„è§’è‰²`);
                        } else {
                            console.error("æ‰¾ä¸åˆ°æœç´¢æ¡†ï¼è¯·æ£€æŸ¥ id='mainSearchInput' æ˜¯å¦åŠ å¯¹äº†");
                        }
                    }, 500);
                }

                // 3. å¤„ç† {{edit:ID|type|val}} -> ä¿®æ”¹æ•°æ®
                const editMatch = text.match(/{{edit:(\d+)\|(\w+)\|(.+)}}/);
                if (editMatch) {
                    const id = parseInt(editMatch[1]);
                    const action = editMatch[2]; // 'addTag' or 'rename'
                    const val = editMatch[3];
                    displayText = displayText.replace(editMatch[0], '');

                    setTimeout(async () => {
                        if(!items[id]) return;
                        
                        if(action === 'rename') {
                            items[id].name = val;
                            auth.toast(`âœï¸ æ”¹åæˆåŠŸï¼šç°åœ¨å« ${val} äº†`);
                        } else if(action === 'addTag') {
                            if(!items[id].tags) items[id].tags = [];
                            if(!items[id].tags.includes(val)) items[id].tags.push(val);
                            auth.toast(`ğŸ·ï¸ æ ‡ç­¾å·²è´´ï¼š${val}`);
                        }
                        
                        // ä¿å­˜å¹¶åˆ·æ–°
                        await saveItemToDB(items[id]);
                        renderGrid(items); // åˆ·æ–°ä¸»é¡µ
                    }, 500);
                    
                    displayText += `<br><span style="font-size:10px; color:green;">âœ… éµæ—¨ï¼Œå·²æ‰§è¡Œä¿®æ”¹ã€‚</span>`;
                }
            }

            div.innerHTML = `<div class="ai-bubble">${displayText}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }


        // ================= ğŸ§  AI æ¨¡å‹æ‹‰å–åŠŸèƒ½ =================
        
        // 1. ä»æœåŠ¡å™¨æ‹‰å–æ¨¡å‹åˆ—è¡¨
        async function fetchModelList() {
            const apiUrl = document.getElementById('aiApiUrl').value.replace(/\/$/, ''); // å»æ‰æœ«å°¾æ–œæ 
            const apiKey = document.getElementById('aiApiKey').value;
            const select = document.getElementById('aiModelSelect');
            const btn = event.target; // è·å–ç‚¹å‡»çš„æŒ‰é’®

            if(!apiKey) {
                auth.toast('è¯·å…ˆå¡«å…¥ API Key å†æ‹‰å– ğŸ”‘');
                return;
            }

            // æŒ‰é’®å˜è½¬åœˆåœˆ
            const originalText = btn.innerText;
            btn.innerText = 'â³';
            btn.disabled = true;

            try {
                // å‘é€è¯·æ±‚ï¼šæ ‡å‡† OpenAI æ ¼å¼æ˜¯ GET /models
                const response = await fetch(`${apiUrl}/models`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });

                if (!response.ok) throw new Error('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åœ°å€æˆ–Key');

                const data = await response.json();
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                select.innerHTML = '';
                
                // è§£ææ•°æ® (é€šå¸¸åœ¨ data.data æ•°ç»„é‡Œ)
                const list = Array.isArray(data.data) ? data.data : (Array.isArray(data) ? data : []);
                
                if (list.length > 0) {
                    // æ’åºä¸€ä¸‹ï¼Œå¥½çœ‹ç‚¹
                    list.sort((a, b) => a.id.localeCompare(b.id));
                    
                    // ç”Ÿæˆé€‰é¡¹
                    list.forEach(model => {
                        const opt = document.createElement('option');
                        opt.value = model.id;
                        opt.textContent = model.id; // æ˜¾ç¤ºæ¨¡å‹ID
                        select.appendChild(opt);
                    });
                    
                    auth.toast(`æˆåŠŸæ‹‰å– ${list.length} ä¸ªæ¨¡å‹ âœ¨`);
                } else {
                    auth.toast('æœåŠ¡ç«¯è¿”å›äº†ç©ºåˆ—è¡¨ ğŸ˜³');
                }

            } catch (e) {
                console.error(e);
                auth.toast('æ‹‰å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥åä»£é“¾æ¥ âŒ');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // 2. åˆ‡æ¢æ‰‹åŠ¨è¾“å…¥æ¨¡å¼
        function toggleManualInput() {
            const manualInput = document.getElementById('aiModelManual');
            const select = document.getElementById('aiModelSelect');
            
            if (manualInput.style.display === 'none') {
                manualInput.style.display = 'block';
                manualInput.value = select.value; // æŠŠå½“å‰é€‰çš„å¡«è¿›å»
                select.disabled = true; // ç¦ç”¨ä¸‹æ‹‰
            } else {
                manualInput.style.display = 'none';
                select.disabled = false; // å¯ç”¨ä¸‹æ‹‰
            }
        }

        // ================= ğŸ”§ ä¿®æ­£ï¼šè®¾ç½®çš„æ‰“å¼€ä¸ä¿å­˜ =================
        // (è¯·æŠŠåŸæ¥çš„ openAISettings å’Œ saveAISettings æ›¿æ¢æˆè¿™ä¸¤ä¸ªå…¼å®¹ç‰ˆ)

        function openAISettings() {
            document.getElementById('aiPersonaSelect').value = aiConfig.persona;
            document.getElementById('aiCustomPrompt').value = aiConfig.customPrompt;
            document.getElementById('aiApiUrl').value = aiConfig.apiUrl;
            document.getElementById('aiApiKey').value = aiConfig.apiKey;
            
            // å¤„ç†æ¨¡å‹å›æ˜¾
            const select = document.getElementById('aiModelSelect');
            const savedModel = aiConfig.model || 'gpt-3.5-turbo';
            
            // æ£€æŸ¥ä¸‹æ‹‰æ¡†é‡Œæœ‰æ²¡æœ‰è¿™ä¸ªæ¨¡å‹ï¼Œæ²¡æœ‰çš„è¯ä¸´æ—¶åŠ è¿›å»ï¼Œé˜²æ­¢æ˜¾ç¤ºä¸ºç©º
            let exists = false;
            for(let i=0; i<select.options.length; i++) {
                if(select.options[i].value === savedModel) exists = true;
            }
            if(!exists) {
                const opt = document.createElement('option');
                opt.value = savedModel;
                opt.textContent = savedModel + " (å½“å‰å­˜æ¡£)";
                select.appendChild(opt);
            }
            select.value = savedModel;
            
            toggleCustomPromptArea();
            document.getElementById('aiSettingsModal').classList.add('active');
        }

        function saveAISettings() {
            aiConfig.persona = document.getElementById('aiPersonaSelect').value;
            aiConfig.customPrompt = document.getElementById('aiCustomPrompt').value;
            aiConfig.apiUrl = document.getElementById('aiApiUrl').value.replace(/\/$/, '');
            aiConfig.apiKey = document.getElementById('aiApiKey').value;
            
            // ä¿å­˜æ¨¡å‹ï¼šå¦‚æœæ˜¯æ‰‹åŠ¨è¾“å…¥çš„å°±å­˜æ‰‹åŠ¨çš„ï¼Œå¦åˆ™å­˜ä¸‹æ‹‰æ¡†çš„
            const manualInput = document.getElementById('aiModelManual');
            if(manualInput.style.display !== 'none' && manualInput.value) {
                aiConfig.model = manualInput.value.trim();
            } else {
                aiConfig.model = document.getElementById('aiModelSelect').value;
            }

            localStorage.setItem('my_ai_config', JSON.stringify(aiConfig));
            
            // æ›´æ–°æ ‡é¢˜
            const labels = {
                'eunuch': 'ğŸ™‡ å°å¾·å­', 'maid': 'ğŸ± å–µå–µ', 
                'butler': 'ğŸ§ æ¯’èˆŒç®¡å®¶', 'yandere': 'ğŸ”ª ç—…å¨‡å¦¹å¦¹', 'custom': 'ğŸ§  è‡ªå®šä¹‰'
            };
            document.getElementById('aiPersonaLabel').textContent = labels[aiConfig.persona] || 'AI ä¾ä»';
            
            // æ¸…ç©ºè®°å½•æç¤º
            const chatBox = document.getElementById('aiChatBox');
            chatBox.innerHTML = '<div class="ai-msg-row ai"><div class="ai-bubble">è®¾ç½®å·²æ›´æ–°ï¼è¯·å©å’ï¼Œå¥´æ‰å¬ç€å‘¢~</div></div>';
            
            document.getElementById('aiSettingsModal').classList.remove('active');
            auth.toast('è®¾ç½®ä¿å­˜æˆåŠŸ âœ¨');
        }

// ================= ğŸ‘‡ å»ºè®®ç”¨è¿™æ®µæœ€ç¨³çš„ä»£ç  ğŸ‘‡ =================

// ğŸ”§ é€šç”¨ AI å‘é€å‡½æ•° (é˜²æŠ¥é”™å¢å¼ºç‰ˆ)
async function sendCustomPromptToAI(systemPrompt, userTextDisplay) {
    // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    // æ£€æŸ¥ appendAIMessage æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢æŠ¥é”™
    if (typeof appendAIMessage === 'function') {
        appendAIMessage('user', userTextDisplay);
    } else {
        console.error("æ‰¾ä¸åˆ° appendAIMessage å‡½æ•°");
    }
    
    // 2. è·å–é…ç½® (æ”¹ä¸ºç›´æ¥è¯»ç¼“å­˜ï¼Œé˜²æ­¢å˜é‡æœªå®šä¹‰æŠ¥é”™)
    var config = JSON.parse(localStorage.getItem('my_ai_config'));
    
    if(!config || !config.apiKey) { 
        if (typeof appendAIMessage === 'function') {
            appendAIMessage('ai', 'ğŸš« æ²¡å¡« API Keyï¼è¯·å»è®¾ç½®é‡Œå¡«ä¸€ä¸‹ã€‚'); 
        } else {
            alert('ğŸš« æ²¡å¡« API Keyï¼');
        }
        return; 
    }

// ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€è¿™é‡Œæ˜¯ä¿®æ”¹é‡ç‚¹ã€‘ğŸ‘‡ğŸ‘‡ğŸ‘‡
    
    // ç¬¬ä¸€æ‹›ï¼šå…ˆæŠŠå½“å‰çš„è¯¦æƒ…é¡µå…³æ‰ï¼ˆé˜²æ­¢æŒ¡ä½è§†çº¿ï¼‰
    const detailModal = document.getElementById('detailModal');
    if(detailModal) {
        detailModal.classList.remove('active');
    }

    // ç¬¬äºŒæ‹›ï¼šå¼ºåˆ¶ç»™æ‚¬æµ®çª—åŠ  active ç±»ï¼ˆç”¨ setTimeout ç¡®ä¿åœ¨å…³çª—åæ‰§è¡Œï¼‰
    setTimeout(() => {
        const floatMenu = document.getElementById('floatMenu');
        if (floatMenu) {
            // å…ˆç§»é™¤å†æ·»åŠ ï¼Œè§¦å‘æµè§ˆå™¨é‡ç»˜ï¼Œç¡®ä¿å¼¹çª—åŠ¨ç”»æ‰§è¡Œ
            floatMenu.classList.remove('active');
            void floatMenu.offsetWidth; // é­”æ³•ä»£ç ï¼šå¼ºåˆ¶é‡ç»˜
            floatMenu.classList.add('active'); 
        }
        
        // ç¬¬ä¸‰æ‹›ï¼šå¼ºåˆ¶åˆ‡åˆ°èŠå¤©é¡µ
        if(typeof switchMenuPage === 'function') {
            switchMenuPage(2);
        }
    }, 100); // å»¶è¿Ÿ 0.1 ç§’æ‰§è¡Œï¼Œæ›´åŠ ç¨³å¦¥

    // ğŸ‘†ğŸ‘†ğŸ‘†ã€ä¿®æ”¹ç»“æŸã€‘ğŸ‘†ğŸ‘†ğŸ‘†

   
    const chatBox = document.getElementById('aiChatBox');
    if (!chatBox) return; //ä»¥æ­¤é˜²æ­¢é¡µé¢æ²¡åŠ è½½å®ŒæŠ¥é”™

    const loadingId = 'loading-' + Date.now();
    chatBox.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-loading">â³ æ­£åœ¨ç”Ÿæˆä¸­...</div>`);
    chatBox.scrollTop = chatBox.scrollHeight;

    try {
        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: "å¼€å§‹" }
                ]
            })
        });
        const data = await response.json();
        
        // ç§»é™¤åŠ è½½åŠ¨ç”»
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.remove();

        if (data.choices) {
            appendAIMessage('ai', data.choices[0].message.content);
        } else if (data.error) {
            appendAIMessage('ai', `âŒ é”™è¯¯: ${data.error.message}`);
        }
    } catch (e) {
        const loadingEl = document.getElementById(loadingId);
        if (loadingEl) loadingEl.remove();
        appendAIMessage('ai', `âŒ ç½‘ç»œé”™è¯¯: ${e.message}`);
    }
}


        // ================= ğŸ·ï¸ AI æ™ºèƒ½æ‰“æ ‡ =================
        async function autoGenerateTags() {
            const name = document.getElementById('itemName').value;
            // è·å–å›å¿†å½•ä½œä¸ºç®€ä»‹å‚è€ƒ
            const desc = document.getElementById('itemMemories').value;
            
            if (!aiConfig.apiKey) { auth.toast('è¯·å…ˆè®¾ç½® API Key ğŸ”‘'); return; }
            if (!name) { auth.toast('è¯·å…ˆå¡«ä¸ªåå­—å§~'); return; }

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'ğŸ§  åˆ†æä¸­...';
            btn.disabled = true;

            const prompt = `
            æˆ‘æ­£åœ¨æ•´ç†ä¸€ä¸ªè§’è‰²æ”¶è—åº“ã€‚
            è§’è‰²åï¼š${name}
            æè¿°/å›å¿†ï¼š${desc}
            
            è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œæ¨æµ‹å¹¶ç”Ÿæˆ 4-6 ä¸ªçŸ­å°ç²¾æ‚çš„æ ‡ç­¾ï¼ˆTagsï¼‰ã€‚
            æ ‡ç­¾å¯ä»¥æ˜¯ï¼šæ€§æ ¼ï¼ˆå¦‚å‚²å¨‡ã€é«˜å†·ï¼‰ã€å±æ€§ï¼ˆå¦‚å¹´ä¸‹ã€é’æ¢…ç«¹é©¬ï¼‰ã€é¢˜æï¼ˆå¦‚æ ¡å›­ã€å¤é£ï¼‰ã€ç»“å±€ï¼ˆå¦‚HEã€BEï¼‰ã€‚
            
            ã€é‡è¦è¦æ±‚ã€‘ï¼š
            1. åªè¿”å›æ ‡ç­¾ï¼Œç”¨è‹±æ–‡é€—å·åˆ†éš”ã€‚
            2. ä¸è¦ä»»ä½•åºŸè¯ã€‚
            3. åªè¦æ ‡ç­¾ã€‚
            ä¾‹å¦‚ï¼šå‚²å¨‡,æ ¡å›­,ç”œæ–‡,HE
            `;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                    body: JSON.stringify({
                        model: aiConfig.model || 'gpt-3.5-turbo',
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                const data = await response.json();
                
                if (data.choices && data.choices.length > 0) {
                    const content = data.choices[0].message.content;
                    // æ¸…æ´—æ•°æ®ï¼šæ›¿æ¢ä¸­æ–‡é€—å·ï¼Œå»æ‰ç©ºæ ¼
                    const newTags = content.replace(/ï¼Œ/g, ',').split(',').map(t => t.trim()).filter(t => t);
                    
                    // åˆå¹¶åˆ°å½“å‰æ ‡ç­¾
                    newTags.forEach(t => {
                        if(!currentTags.includes(t)) currentTags.push(t);
                    });
                    
                    renderTagsInput(); // åˆ·æ–°ç•Œé¢
                    auth.toast(`å·²è‡ªåŠ¨è´´ä¸Š ${newTags.length} ä¸ªæ ‡ç­¾ âœ¨`);
                }
            } catch (e) {
                console.error(e);
                auth.toast('åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ âŒ');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // ================= ğŸ­ å°å‰§åœºé€»è¾‘ =================
        function openTheaterModal() {
            // å¡«å……ä¸‹æ‹‰æ¡†
            const selA = document.getElementById('theaterCharA');
            const selB = document.getElementById('theaterCharB');
            selA.innerHTML = ''; selB.innerHTML = '';
            
            items.forEach((item, idx) => {
                const opt = new Option(item.name, idx);
                selA.add(opt.cloneNode(true));
                selB.add(opt.cloneNode(true));
            });
            
            // é»˜è®¤é€‰å‰ä¸¤ä¸ª
            if(items.length > 1) selB.selectedIndex = 1;

            document.getElementById('theaterModal').classList.add('active');
        }

        async function startTheater() {
            const idxA = document.getElementById('theaterCharA').value;
            const idxB = document.getElementById('theaterCharB').value;
            const topic = document.getElementById('theaterTopic').value || "åˆæ¬¡è§é¢ï¼Œäº’ç›¸è¯•æ¢";

            if (idxA === idxB) { auth.toast('è¯·é€‰ä¸¤ä¸ªä¸åŒçš„äººï¼'); return; }
            if (!aiConfig.apiKey) { auth.toast('æ²¡ API Key æ¼”ä¸äº†æˆå‘€ï¼'); return; }

            const charA = items[idxA];
            const charB = items[idxB];

            // å…³é—­è®¾ç½®çª—ï¼Œæ‰“å¼€ AI èŠå¤©çª—
            document.getElementById('theaterModal').classList.remove('active');
            document.getElementById('floatMenu').classList.add('active');
            switchMenuPage(2);

            const chatBox = document.getElementById('aiChatBox');
            const loadingId = 'theater-' + Date.now();
            chatBox.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-msg-row ai"><div class="ai-bubble">ğŸ¬ æ­£åœ¨æ­å»ºèˆå°...<br>æ¼”å‘˜ï¼š${charA.name} & ${charB.name}<br>å‰§ç›®ï¼š${topic}</div></div>`);
            chatBox.scrollTop = chatBox.scrollHeight;

            const prompt = `
            ã€æŒ‡ä»¤ã€‘ï¼šè¯·å†™ä¸€ä¸ªå°å‰§åœºï¼ˆå¯¹è¯è„šæœ¬ï¼‰ã€‚
            ã€è§’è‰²Aã€‘ï¼š${charA.name}ï¼Œæ ‡ç­¾ï¼š${(charA.tags||[]).join(',')}
            ã€è§’è‰²Bã€‘ï¼š${charB.name}ï¼Œæ ‡ç­¾ï¼š${(charB.tags||[]).join(',')}
            ã€æƒ…å¢ƒã€‘ï¼š${topic}
            
            è¯·å‘æŒ¥æƒ³è±¡åŠ›ï¼Œæ¨¡æ‹Ÿä¸¤äººç›¸é‡æˆ–äº’åŠ¨çš„åœºæ™¯ã€‚
            æ ¼å¼è¦æ±‚ï¼šå‰§æœ¬å½¢å¼ï¼ŒåŒ…å«åŠ¨ä½œæå†™ã€‚
            ä¾‹å¦‚ï¼š
            Aï¼š(å†·ç¬‘) å±…ç„¶æ˜¯ä½ ã€‚
            Bï¼š(æ¼«ä¸ç»å¿ƒ) æ€ä¹ˆï¼Œä¸æ¬¢è¿ï¼Ÿ
            `;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                    body: JSON.stringify({
                        model: aiConfig.model || 'gpt-3.5-turbo',
                        messages: [{ role: "user", content: prompt }]
                    })
                });
                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.choices) {
                    appendAIMessage('ai', `<b>ğŸ¥ ã€è·¨æ—¶ç©ºå°å‰§åœºã€‘</b><br>ä¸»æ¼”ï¼š${charA.name} x ${charB.name}<br><hr>${data.choices[0].message.content.replace(/\n/g, '<br>')}`);
                }
            } catch (e) {
                document.getElementById(loadingId).remove();
                auth.toast('æ¼”å‡ºäº‹æ•… (ç½‘ç»œé”™è¯¯) ğŸ’¥');
            }
        }

        // ================= ğŸ äº’åŠ¨ï¼šæŠ•å–‚æ—¶åˆ» =================
        async function giveGift() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            
            if (!aiConfig.apiKey) { auth.toast('ğŸ”‘ çš‡ä¸Šï¼Œåº“æˆ¿é’¥åŒ™(API Key)æ²¡å¸¦å‘€ï¼'); return; }

            // 1. è¯¢é—®é€ä»€ä¹ˆ
            const gift = prompt(`ğŸ ä½ æƒ³é€ç»™ã€${item.name}ã€‘ä»€ä¹ˆç¤¼ç‰©ï¼Ÿ\n(ä¾‹å¦‚ï¼šè‰è“è›‹ç³•ã€çº¢ç«ç‘°ã€ä¸€æŠŠæª...)`);
            if (!gift) return;

            auth.toast(`ğŸ æ­£åœ¨æŠŠ ${gift} é€ç»™ ${item.name}...`);

            // 2. æ‰“å¼€ AI èŠå¤©çª—å£
            document.getElementById('floatMenu').classList.add('active');
            switchMenuPage(2);
            
            // 3. æ„å»º Prompt
            const prompt = `
            ã€è§’è‰²æ‰®æ¼”æŒ‡ä»¤ã€‘
            ä½ æ˜¯ï¼š${item.name}ã€‚
            æ ‡ç­¾/æ€§æ ¼ï¼š${(item.tags||[]).join(',')}ã€‚
            
            ç°çŠ¶ï¼šç”¨æˆ·ï¼ˆä½ çš„é‡è¦ä¹‹äººï¼‰åˆšåˆšé€äº†ä½ ä¸€ä»½ç¤¼ç‰©ï¼šã€${gift}ã€‘ã€‚
            
            è¯·æ ¹æ®ä½ çš„æ€§æ ¼ï¼Œåšå‡ºç”ŸåŠ¨çš„ååº”ã€‚
            è¦æ±‚ï¼š
            1. åŒ…å«åŠ¨ä½œæå†™å’Œå¿ƒç†æ´»åŠ¨ï¼ˆæ”¾åœ¨æ‹¬å·é‡Œï¼‰ã€‚
            2. å¦‚æœç¤¼ç‰©ç¬¦åˆä½ çš„å–œå¥½ï¼Œè¦å¼€å¿ƒ/å®³ç¾ï¼›å¦‚æœä¸ç¬¦åˆï¼ˆæ¯”å¦‚ç»™é«˜å†·é€å¥¶å˜´ï¼‰ï¼Œå¯ä»¥ç”Ÿæ°”æˆ–åæ§½ã€‚
            3. ç›´æ¥ç”¨è§’è‰²çš„å£å»è¯´è¯ï¼Œä¸è¦æœ‰ä»»ä½•å‰ç¼€ã€‚
            `;

            // 4. å‘é€ç»™ AI (å¤ç”¨ sendCustomPrompt å‡½æ•°)
            sendCustomPromptToAI(prompt, `ğŸ æœ•é€äº†ä½ ã€${gift}ã€‘ï¼Œå–œæ¬¢å—ï¼Ÿ`);
        }

        // ================= ğŸ‘— äº’åŠ¨ï¼šä»Šæ—¥ç©¿æ­ (OOTD) =================
        async function generateOOTD() {
            if (viewingIndex === -1) return;
            const item = items[viewingIndex];
            
            if (!aiConfig.apiKey) { auth.toast('ğŸ”‘ æ²¡ API Key æ²¡æ³•å˜èº«å‘€ï¼'); return; }

            // 1. è¯¢é—®åœºæ™¯
            const scene = prompt(`ğŸ‘— æƒ³çœ‹ã€${item.name}ã€‘ç©¿ä»€ä¹ˆé£æ ¼/å»å“ªé‡Œï¼Ÿ\n(ä¾‹å¦‚ï¼šæ³³æ± æ´¾å¯¹ã€å“ˆåˆ©æ³¢ç‰¹æ ¡æœã€èµ›åšæœ‹å…‹æˆ˜æ–—è£…...)`, "æµªæ¼«çš„çƒ›å…‰æ™šé¤");
            if (!scene) return;

            auth.toast(`ğŸ‘— å°å¾·å­æ­£åœ¨ä¸º ${item.name} æŒ‘é€‰è¡£æœ...`);

            // 2. æ‰“å¼€ AI èŠå¤©çª—å£
            document.getElementById('floatMenu').classList.add('active');
            switchMenuPage(2);

            // 3. æ„å»º Prompt
            const prompt = `
            ã€å¤–è²Œæå†™æŒ‡ä»¤ã€‘
            è§’è‰²ï¼š${item.name}ã€‚
            åœºæ™¯/é£æ ¼ï¼š${scene}ã€‚
            
            è¯·å‘æŒ¥æƒ³è±¡åŠ›ï¼Œè¯¦ç»†æå†™è¯¥è§’è‰²åœ¨è¿™ä¸ªåœºæ™¯ä¸‹çš„ç©¿æ­ (OOTD)ã€‚
            å†…å®¹åŒ…æ‹¬ï¼šå‘å‹ã€æœè£…ç»†èŠ‚ã€é…é¥°ã€ä»¥åŠæ­¤æ—¶çš„ç¥æ€ã€‚
            
            æ ¼å¼è¦æ±‚ï¼š
            è¯·ç”¨ä¸€æ®µæå…·ç”»é¢æ„Ÿçš„æ–‡å­—æè¿°ï¼Œè®©äººçœ‹äº†èƒ½è„‘è¡¥å‡ºç”»é¢ã€‚
            æœ€åç”¨ä¸€å¥è¯è¯„ä»·è¿™å¥—ç©¿æ­ã€‚
            `;

            sendCustomPromptToAI(prompt, `ğŸ‘— æœ•æƒ³çœ‹ä½ ç©¿ã€${scene}ã€‘çš„æ ·å­...`);
        }

        // ğŸ”§ é€šç”¨è¾…åŠ©å‡½æ•°ï¼šå‘é€è‡ªå®šä¹‰ Prompt åˆ°èŠå¤©æ¡†
        async function sendCustomPromptToAI(systemPrompt, userTextDisplay) {
            const chatBox = document.getElementById('aiChatBox');
            
            // æ˜¾ç¤ºç”¨æˆ·çš„æ“ä½œ
            appendAIMessage('user', userTextDisplay);
            
            // æ˜¾ç¤ºåŠ è½½
            const loadingId = 'loading-' + Date.now();
            chatBox.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-loading">â³ æ­£åœ¨ç”Ÿæˆä¸­...</div>`);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                    body: JSON.stringify({
                        model: aiConfig.model || 'gpt-3.5-turbo',
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: "å¼€å§‹è¡¨æ¼”å§ã€‚" } // è§¦å‘è¯­
                        ],
                        temperature: 0.8 // ç¨å¾®é«˜ä¸€ç‚¹ï¼Œæ›´æœ‰åˆ›æ„
                    })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.choices) {
                    const reply = data.choices[0].message.content;
                    appendAIMessage('ai', reply);
                }
            } catch (e) {
                document.getElementById(loadingId).remove();
                appendAIMessage('ai', `âŒ æ¼”ç ¸äº†ï¼š${e.message}`);
            }
        }

        // ================= ğŸ’Œ é£é¸½ä¼ ä¹¦é€»è¾‘ =================
        async function checkMailbox() {
            if (items.length === 0) { auth.toast('ğŸ“­ è¿˜æ²¡æœ‰è®¤è¯†çš„äººï¼Œä¿¡ç®±æ˜¯ç©ºçš„...'); return; }
            if (!aiConfig.apiKey) { auth.toast('ğŸ”‘ æ²¡ API Key é‚®å·®ä¸é€ä¿¡ï¼'); return; }

            // 1. éšæœºé€‰ä¸€ä¸ªè§’è‰²
            const luckyIdx = Math.floor(Math.random() * items.length);
            const item = items[luckyIdx];

            // 2. æ˜¾ç¤ºä¿¡çº¸ï¼ˆåŠ è½½çŠ¶æ€ï¼‰
            document.getElementById('letterModal').classList.add('active');
            document.getElementById('letterText').innerHTML = '<div style="text-align:center; margin-top:50px;">ğŸ•Šï¸ æ­£åœ¨æ‹†å¼€ä¿¡å°...<br><span style="font-size:12px;color:#999;">(AI æ­£åœ¨æ’°å†™ä¸­)</span></div>';
            document.getElementById('letterSign').textContent = '';

            // 3. æ„å»º Prompt
            const prompt = `
            ã€è§’è‰²æ‰®æ¼”æŒ‡ä»¤ã€‘
            ä½ æ˜¯ï¼š${item.name}ã€‚
            æ ‡ç­¾ï¼š${(item.tags||[]).join(',')}ã€‚
            
            è¯·ç»™ä½ çš„ã€é‡è¦ä¹‹äººã€‘ï¼ˆç”¨æˆ·ï¼‰å†™ä¸€å°çŸ­ä¿¡ï¼ˆ150å­—ä»¥å†…ï¼‰ã€‚
            å†…å®¹å¯ä»¥æ˜¯ï¼š
            - å¯¹æœ€è¿‘ç›¸å¤„çš„æ„Ÿæƒ³ã€‚
            - ä¸€å¥ç¾äºå¯é½¿çš„å‘Šç™½ã€‚
            - æˆ–è€…æ˜¯æ—¥å¸¸çš„ç¢ç¢å¿µã€åæ§½ã€‚
            - å¦‚æœæ˜¯ç—…å¨‡ï¼Œå†…å®¹è¦ç¨å¾®æœ‰ç‚¹å¯æ€•ï¼›å¦‚æœæ˜¯å‚²å¨‡ï¼Œè¦å£æ˜¯å¿ƒéã€‚
            
            æ ¼å¼è¦æ±‚ï¼š
            ä¸è¦å†™å¼€å¤´ç§°å‘¼ï¼Œç›´æ¥å†™æ­£æ–‡ã€‚
            è¯­æ°”è¦æå…¶ç¬¦åˆäººè®¾ã€‚
            `;

            try {
                const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
                    body: JSON.stringify({
                        model: aiConfig.model || 'gpt-3.5-turbo',
                        messages: [{ role: "user", content: prompt }]
                    })
                });

                const data = await response.json();
                if (data.choices) {
                    const content = data.choices[0].message.content;
                    
                    // é€å­—æ˜¾ç¤ºç‰¹æ•ˆ (æ‰“å­—æœºæ•ˆæœ)
                    const textEl = document.getElementById('letterText');
                    textEl.textContent = '';
                    let i = 0;
                    const timer = setInterval(() => {
                        textEl.textContent += content.charAt(i);
                        i++;
                        if (i >= content.length) clearInterval(timer);
                    }, 30); // æ‰“å­—é€Ÿåº¦

                    document.getElementById('letterSign').textContent = `â€”â€” ${item.name}`;
                }
            } catch (e) {
                document.getElementById('letterText').textContent = 'âŒ ä¿¡ä»¶åœ¨é€”ä¸­ä¸¢å¤±äº†... (ç½‘ç»œé”™è¯¯)';
            }
        }

// ================= ğŸ“± æœ‹å‹åœˆ (Moments) é€»è¾‘ =================

function openMomentsModal() {
    document.getElementById('momentsModal').classList.add('active');
}

function closeMomentsModal() {
    document.getElementById('momentsModal').classList.remove('active');
}

async function postMoment() {
    const input = document.getElementById('momentInput');
    const text = input.value.trim();
    
    if (!text) { auth.toast('å†™ç‚¹ä»€ä¹ˆå†å‘å§~'); return; }
    if (items.length === 0) { auth.toast('è¿˜æ²¡æœ‰è®¤è¯†çš„è§’è‰²ç»™ä½ ç‚¹èµå“¦...'); return; }
    if (!aiConfig.apiKey) { auth.toast('ğŸ”‘ æ²¡ API Keyï¼Œå¤§å®¶æ”¶ä¸åˆ°ä½ çš„åŠ¨æ€ï¼'); return; }

    const btn = document.getElementById('momentSendBtn');
    const originalBtnText = btn.innerText;
    btn.innerText = 'å‘é€ä¸­...';
    btn.disabled = true;

    // 1. éšæœºæŠ½å– 3-5 ä¸ªè§’è‰² (å¦‚æœä¸é‡å¤)
    let candidates = [...items]; // å¤åˆ¶ä¸€ä»½
    // ç®€å•çš„éšæœºä¹±åº
    candidates.sort(() => Math.random() - 0.5);
    // å–å‰ 3 åˆ° 5 ä¸ª
    const pickCount = Math.min(candidates.length, Math.floor(Math.random() * 3) + 3);
    const selectedChars = candidates.slice(0, pickCount);

    // 2. åœ¨ç•Œé¢ä¸Šå…ˆæ˜¾ç¤ºâ€œç”¨æˆ·çš„å†…å®¹â€ (å‡è£…å‘é€æˆåŠŸ)
    const feed = document.getElementById('momentsFeed');
    const postId = 'post-' + Date.now();
    
    // è·å–å½“å‰æ—¶é—´
    const now = new Date();
    const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

    const postHtml = `
        <div class="moment-card" id="${postId}">
            <div class="moment-header">
                <div class="moment-user-avatar">æˆ‘</div>
                <div style="display:flex; flex-direction:column; justify-content:center;">
                    <div style="font-weight:bold; color:#576b95; font-size:14px;">User</div>
                </div>
            </div>
            <div class="moment-content">${text}</div>
            <div class="moment-meta">
                <span>${timeStr}</span>
                <span>Wait for replies...</span>
            </div>
            <div class="moment-comments-area" id="${postId}-comments">
                <div style="color:#999; font-size:12px;">â˜ï¸ æ­£åœ¨åŒæ­¥åˆ°å¼‚ä¸–ç•Œ...</div>
            </div>
        </div>
    `;
    
    // æ’å…¥åˆ°æœ€å‰é¢
    if(feed.querySelector('.moment-card')) {
        feed.insertAdjacentHTML('afterbegin', postHtml);
    } else {
        feed.innerHTML = postHtml;
    }
    
    input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†

    // 3. æ„å»º Prompt è®© AI æ‰®æ¼”è¿™å‡ ä¸ªäºº
    let charInfo = "";
    selectedChars.forEach((char, index) => {
        charInfo += `${index+1}. åå­—ï¼š${char.name}ï¼Œæ€§æ ¼æ ‡ç­¾ï¼š${(char.tags||[]).join(',')}ã€‚\n`;
    });

    const systemPrompt = `
    ä½ ç°åœ¨éœ€è¦åŒæ—¶æ‰®æ¼”ä»¥ä¸‹å‡ ä½è§’è‰²ï¼Œå¹¶åœ¨ç”¨æˆ·çš„æœ‹å‹åœˆåŠ¨æ€ä¸‹è¿›è¡Œè¯„è®ºã€‚
    
    ã€ç”¨æˆ·åŠ¨æ€ã€‘ï¼š"${text}"
    
    ã€è§’è‰²åˆ—è¡¨ã€‘ï¼š
    ${charInfo}
    
    ã€è¦æ±‚ã€‘ï¼š
    1. è¯·ä¸ºæ¯ä¸€ä½è§’è‰²å†™ä¸€å¥è¯„è®ºï¼ˆ20å­—ä»¥å†…ï¼‰ã€‚
    2. è¯„è®ºè¦æåº¦ç¬¦åˆè¯¥è§’è‰²çš„æ€§æ ¼æ ‡ç­¾ï¼ˆä¾‹å¦‚æ¯’èˆŒçš„è¦å˜²è®½ï¼Œæ¸©æŸ”çš„è¦å…³å¿ƒï¼Œç—…å¨‡çš„è¦åƒé†‹ï¼‰ã€‚
    3. è¾“å‡ºæ ¼å¼ä¸¥æ ¼å¦‚ä¸‹ï¼ˆä¸è¦åŒ…å«å…¶ä»–å†…å®¹ï¼‰ï¼š
    è§’è‰²å1ï¼šè¯„è®ºå†…å®¹
    è§’è‰²å2ï¼šè¯„è®ºå†…å®¹
    ...
    `;

    // 4. è°ƒç”¨ AI
    try {
        const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${aiConfig.apiKey}`
            },
            body: JSON.stringify({
                model: aiConfig.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: systemPrompt }]
            })
        });

        const data = await response.json();
        
        if (data.choices) {
            const rawContent = data.choices[0].message.content;
            const lines = rawContent.split('\n');
            
            const commentsArea = document.getElementById(`${postId}-comments`);
            commentsArea.innerHTML = ''; // æ¸…ç©ºâ€œæ­£åœ¨åŒæ­¥â€çš„æç¤º

            // 5. æ¸²æŸ“è¯„è®º
            // åŠ ä¸Šç‚¹èµè¡Œ (å‡è£…å¤§å®¶éƒ½èµäº†)
            const likeNames = selectedChars.map(c => c.name).join('ï¼Œ');
            const likesHtml = `<div style="font-size:12px; color:#576b95; margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:5px;">â™¡ ${likeNames}</div>`;
            commentsArea.innerHTML += likesHtml;

            lines.forEach(line => {
                // ç®€å•çš„è§£æï¼š åå­—ï¼šå†…å®¹
                // ä¸ºäº†é˜²æ­¢AIè¾“å‡ºæ ¼å¼ç•¥æœ‰åå·®ï¼Œæˆ‘ä»¬ç”¨å†’å·åˆ†å‰²
                const parts = line.split('ï¼š'); 
                if (parts.length < 2) return;
                
                const name = parts[0].trim();
                const content = parts.slice(1).join('ï¼š').trim(); // é˜²æ­¢å†…å®¹é‡Œä¹Ÿæœ‰å†’å·
                
                // æŸ¥æ‰¾å¯¹åº”çš„è§’è‰²IDä»¥ä¾¿ç‚¹å‡»è·³è½¬ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
                const charObj = items.find(i => i.name === name);
                
                const commentHtml = `
                    <div class="moment-comment-row">
                        <span class="moment-role-name">${name}</span>ï¼š${content}
                    </div>
                `;
                commentsArea.innerHTML += commentHtml;
            });
            
            auth.toast('æœ‹å‹åœˆæ›´æ–°å•¦ï¼ğŸ””');
        }

    } catch (e) {
        console.error(e);
        document.getElementById(`${postId}-comments`).innerHTML = '<div style="color:red; font-size:12px;">âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯„è®ºåŠ è½½å¤±è´¥</div>';
    } finally {
        btn.innerText = originalBtnText;
        btn.disabled = false;
    }
}

// ================= ğŸ“° åŠŸèƒ½ä¸€ï¼šå…«å¦å‘¨åˆŠé€»è¾‘ =================

async function generateGossipWeekly() {
    if (items.length < 2) { auth.toast('è§’è‰²å¤ªå°‘å•¦ï¼Œç¼–ä¸å‡ºå…«å¦ï¼'); return; }
    if (!aiConfig.apiKey) { auth.toast('ğŸ”‘ éœ€è¦ API Key æ‰èƒ½è˜è¯·è®°è€…ï¼'); return; }

    // 1. æ‰“å¼€ç•Œé¢å¹¶æ˜¾ç¤ºåŠ è½½
    document.getElementById('gossipModal').classList.add('active');
    const paper = document.getElementById('gossipPaper');
    paper.innerHTML = '<div style="text-align:center;padding-top:50px;">ğŸ“° è®°è€…æ­£åœ¨å·å¬å¢™è§’...<br>(AI ç”Ÿæˆä¸­)</div>';

    // 2. éšæœºæŠ½å– 3 ä¸ªè§’è‰²ä½œä¸ºç´ æ
    let starList = [...items].sort(() => Math.random() - 0.5).slice(0, 3);
    
    let context = "";
    starList.forEach((item, i) => {
        // æå–å›å¿†å½•æˆ–æ ‡ç­¾ä½œä¸ºç´ æ
        const memos = (item.memories && item.memories.length > 0) ? item.memories.join('ï¼Œ') : "æš‚æ— å›å¿†";
        context += `è§’è‰²${i+1}ï¼šã€${item.name}ã€‘ï¼Œæ ‡ç­¾ï¼š${(item.tags||[]).join(',')}ï¼Œç›¸å…³å›å¿†ï¼š${memos}ã€‚\n`;
    });

    // 3. æ„å»º Prompt
    const prompt = `
    ä½ ç°åœ¨æ˜¯ã€Šç™¾å®ç®±å‘¨åˆŠã€‹çš„æ— è‰¯ç‹—ä»”/ä¸»ç¼–ã€‚
    è¯·æ ¹æ®ä»¥ä¸‹è§’è‰²ä¿¡æ¯ï¼Œç¼–é€  3 æ¡è€¸äººå¬é—»ã€å¥½ç¬‘æˆ–ç¦»è°±çš„â€œå…«å¦æ–°é—»â€ã€‚
    
    ã€ç´ æåº“ã€‘ï¼š
    ${context}
    
    ã€è¦æ±‚ã€‘ï¼š
    1. æ ‡é¢˜è¦éœ‡æƒŠä½“ï¼Œè¶³å¤Ÿå¸ç›ã€‚
    2. å†…å®¹è¦ç»“åˆè§’è‰²çš„æ ‡ç­¾ï¼ˆæ¯”å¦‚å‚²å¨‡çš„åœ¨å·å·å“­ï¼Œé«˜å†·çš„åœ¨ç©¿ç²‰è‰²å†…è¡£ç­‰ï¼‰ï¼Œå¯ä»¥é€‚å½“å¤¸å¼ è„‘è¡¥ã€‚
    3. è¯­æ°”è¦åƒå¨±ä¹æ–°é—»ï¼ŒåŒ…å«â€œæ®çŸ¥æƒ…äººå£«é€éœ²â€ã€â€œæœ¬æŠ¥ç‹¬å®¶â€ç­‰å­—çœ¼ã€‚
    
    ã€è¾“å‡ºæ ¼å¼ã€‘ï¼š
    ä¸è¦åŒ…å«å…¶ä»–åºŸè¯ï¼Œç›´æ¥æŒ‰ HTML æ ¼å¼è¾“å‡º 3 ä¸ªæ–°é—»å—ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    <div class="gossip-tag">æ¿å—åç§°</div>
    <div class="gossip-headline">æ ‡é¢˜å†…å®¹</div>
    <div class="gossip-body">æ­£æ–‡å†…å®¹...</div>
    <hr style="border-top:1px dashed #ccc; margin:15px 0;">
    `;

    // 4. è°ƒç”¨ AI
    try {
        const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
            body: JSON.stringify({
                model: aiConfig.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        const html = data.choices[0].message.content;
        
        // 5. æ¸²æŸ“
        paper.innerHTML = `
            <div style="text-align:right; font-size:12px; border-bottom:1px solid #333; margin-bottom:15px;">
                å‘è¡Œæ—¥æœŸï¼š${new Date().toLocaleDateString()} | ç¬¬ ${Math.floor(Math.random()*999)} æœŸ
            </div>
            ${html}
            <div style="text-align:center; font-size:12px; color:#999; margin-top:30px;">
                - æœ¬æŠ¥å†…å®¹çº¯å±è™šæ„ï¼Œå¦‚æœ‰é›·åŒï¼Œçº¯å±å·§åˆ -
            </div>
        `;
    } catch (e) {
        paper.innerHTML = '<div style="text-align:center; margin-top:20px;">âŒ å°åˆ·å‚ç½¢å·¥äº†ï¼ˆç½‘ç»œé”™è¯¯ï¼‰</div>';
    }
}

// ================= ğŸ± åŠŸèƒ½äºŒï¼šæ·±å¤œé£Ÿå ‚é€»è¾‘ =================

function openBarModal() {
    // å¡«å……å¤§å¨åˆ—è¡¨
    const sel = document.getElementById('barChefSelect');
    sel.innerHTML = '';
    items.forEach((item, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.innerText = item.name;
        sel.appendChild(opt);
    });
    
    document.getElementById('barMood').value = '';
    document.getElementById('barResult').style.display = 'none';
    document.getElementById('barModal').classList.add('active');
}

async function orderFood() {
    const mood = document.getElementById('barMood').value.trim();
    const idx = document.getElementById('barChefSelect').value;
    
    if(!mood) { auth.toast('è¯·å‘Šè¯‰æˆ‘ä½ çš„å¿ƒæƒ…ï¼Œä¸ç„¶æ— æ³•è°ƒå‘³å“¦'); return; }
    if(!aiConfig.apiKey) { auth.toast('ğŸ”‘ æ²¡æœ‰ API Keyï¼Œç‚‰ç¶ç‚¹ä¸ç€ç«ï¼'); return; }

    const chef = items[idx];
    
    // ç•Œé¢å˜ä¸ºåŠ è½½ä¸­
    const btn = event.target;
    const oldText = btn.innerText;
    btn.innerText = 'ğŸ”¥ æ­£åœ¨çƒ¹é¥ªä¸­...';
    btn.disabled = true;

    // æ„å»º Prompt
    const prompt = `
    ã€è§’è‰²æ‰®æ¼”æŒ‡ä»¤ã€‘
    ä½ ç°åœ¨æ˜¯â€œæ·±å¤œé£Ÿå ‚â€çš„ä¸»å¨ã€‚
    ä½ çš„çœŸå®èº«ä»½æ˜¯ï¼š${chef.name}ï¼Œæ ‡ç­¾ï¼š${(chef.tags||[]).join(',')}ã€‚
    
    é¡¾å®¢ï¼ˆç”¨æˆ·ï¼‰çš„å¿ƒæƒ…æ˜¯ï¼šã€${mood}ã€‘ã€‚
    
    è¯·æ ¹æ®ä½ çš„æ€§æ ¼å’Œé¡¾å®¢çš„å¿ƒæƒ…ï¼Œå®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š
    1. æ¨èä¸€é“èœæˆ–ä¸€æ¯é…’ï¼ˆåå­—è¦æœ‰åˆ›æ„ï¼Œç¬¦åˆæ„å¢ƒï¼‰ã€‚
    2. æå†™è¿™é“èœçš„æ ·å­/å‘³é“ï¼ˆ20å­—å·¦å³ï¼‰ã€‚
    3. ç”¨ä½ çš„ã€äººè®¾å£å»ã€‘å¯¹é¡¾å®¢è¯´ä¸€æ®µè¯ï¼ˆå®‰æ…°ã€é¼“åŠ±ã€æˆ–è€…æ¯’èˆŒçš„å…³å¿ƒï¼‰ã€‚
    
    ã€è¾“å‡ºæ ¼å¼ - JSONã€‘ï¼š
    {
        "dish": "èœå",
        "desc": "èœå“æè¿°",
        "talk": "ä½ è¯´çš„è¯"
    }
    åªè¾“å‡º JSONï¼Œä¸è¦ Markdownï¼Œä¸è¦å…¶ä»–åºŸè¯ã€‚
    `;

    try {
        const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
            body: JSON.stringify({
                model: aiConfig.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        
        // å°è¯•è§£æ JSON
        let content = data.choices[0].message.content;
        // æœ‰æ—¶å€™ AI ä¼šåŠ  ```json ... ```ï¼Œè¦å»æ‰
        content = content.replace(/```json/g, '').replace(/```/g, '').trim();
        
        const result = JSON.parse(content);

        // æ¸²æŸ“ç»“æœ
        document.getElementById('barDishName').innerText = `ğŸ½ï¸ ${result.dish}`;
        document.getElementById('barDishDesc').innerText = result.desc;
        document.getElementById('barChefTalk').innerHTML = `<b>${chef.name} è¯´ï¼š</b>â€œ${result.talk}â€`;
        
        document.getElementById('barResult').style.display = 'block';

    } catch (e) {
        console.error(e);
        auth.toast('ğŸ”¥ ç‚¸å¨æˆ¿äº†ï¼ˆè§£æé”™è¯¯æˆ–ç½‘ç»œé”™è¯¯ï¼‰');
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}

// ================= ğŸ•¯ï¸ çµé­‚æ‹·é—®å®¤ (Soul Room) é€»è¾‘ =================

let currentSoulChar = null;

function openSoulModal() {
    if (items.length === 0) { auth.toast('è¿˜æ²¡äººèƒ½æ‹·é—®ä½ å‘¢...'); return; }
    document.getElementById('soulModal').classList.add('active');
    initSoulSession();
}

function closeSoulModal() {
    document.getElementById('soulModal').classList.remove('active');
}

async function initSoulSession() {
    // 1. ç•Œé¢é‡ç½®
    document.getElementById('soulQuestion').innerHTML = 'æ­£åœ¨ç¿»é˜…ä½ çš„è¿‡å¾€...<span class="typing-cursor"></span>';
    document.getElementById('soulAnswerArea').style.display = 'none';
    document.getElementById('soulNextBtn').style.display = 'none';
    document.getElementById('soulInput').value = '';

    // 2. éšæœºé€‰ä¸€ä¸ªè§’è‰² (æœ‰å¤´åƒçš„ä¼˜å…ˆ)
    let candidates = items.filter(i => i.resources.some(r => r.type === 'image'));
    if(candidates.length === 0) candidates = items;
    const char = candidates[Math.floor(Math.random() * candidates.length)];
    currentSoulChar = char;

    // 3. è®¾ç½®å¤´åƒå’Œåå­—
    document.getElementById('soulCharName').innerText = char.name;
    const imgRes = char.resources.find(r => r.type === 'image');
    document.getElementById('soulAvatar').src = imgRes ? imgRes.content : PLACEHOLDER_IMG;

    // 4. æ”¶é›†â€œé»‘å†å²â€ (å›å¿†å½•/ä¾¿ç­¾/æ ‡ç­¾)
    const memories = (char.memories || []).join('ï¼›');
    const note = char.noteContent || "";
    const tags = (char.tags || []).join(',');
    
    // 5. è®© AI ç”Ÿæˆé—®é¢˜
    if (!aiConfig.apiKey) {
        document.getElementById('soulQuestion').innerText = "ï¼ˆç³»ç»Ÿæç¤ºï¼šè¯·å…ˆé…ç½® API Keyï¼Œå¦åˆ™æ— æ³•è¿æ¥è§’è‰²çš„çµé­‚...ï¼‰";
        return;
    }

    const prompt = `
    ã€æŒ‡ä»¤ï¼šåå‘é¢è¯•/çµé­‚æé—®ã€‘
    ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼š${char.name}ã€‚
    ä½ çš„æ€§æ ¼æ ‡ç­¾æ˜¯ï¼š${tags}ã€‚
    
    ä½ éœ€è¦æ ¹æ®æŒæ¡çš„ã€å…³äºç”¨æˆ·çš„çº¿ç´¢ã€‘ï¼Œå‘ç”¨æˆ·ï¼ˆä½ çš„ä¸»äºº/ä¼™ä¼´ï¼‰æå‡ºä¸€ä¸ªç›´å‡»çµé­‚çš„é—®é¢˜ã€‚
    
    ã€çº¿ç´¢ã€‘ï¼š
    1. ç”¨æˆ·æ›¾å†™ä¸‹çš„å…³äºä½ çš„å›å¿†ï¼š${memories || "ï¼ˆæš‚æ— å›å¿†ï¼Œä½ å¯ä»¥é—®é—®ä¸ºä»€ä¹ˆæ²¡æœ‰ï¼‰"}
    2. ç”¨æˆ·ç»™ä½ çš„ä¾¿ç­¾å¤‡æ³¨ï¼š${note || "ï¼ˆæš‚æ— å¤‡æ³¨ï¼‰"}
    
    ã€è¦æ±‚ã€‘ï¼š
    1. é—®é¢˜å¿…é¡»éå¸¸ç¬¦åˆä½ çš„äººè®¾ï¼ˆä¾‹å¦‚ç—…å¨‡è¦é—®å æœ‰æ¬²ç›¸å…³ï¼Œå‚²å¨‡è¦é—®æ˜¯ä¸æ˜¯åœ¨ä¹è‡ªå·±ï¼Œæ¸©æŸ”è¦é—®ç´¯ä¸ç´¯ï¼‰ã€‚
    2. å¦‚æœæœ‰çº¿ç´¢ï¼Œè¯·åŠ¡å¿…å¼•ç”¨çº¿ç´¢æ¥æé—®ï¼ˆä¾‹å¦‚ï¼šâ€œæˆ‘åœ¨ä¾¿ç­¾é‡Œçœ‹åˆ°ä½ è¯´æˆ‘...æ˜¯çœŸçš„å—ï¼Ÿâ€ï¼‰ã€‚
    3. å¦‚æœæ²¡æœ‰çº¿ç´¢ï¼Œå°±é—®ä¸€ä¸ªå…³äºâ€œæˆ‘ä»¬ä¹‹é—´å…³ç³»â€çš„æ·±åˆ»é—®é¢˜ã€‚
    4. åªè¾“å‡ºé—®é¢˜æœ¬èº«ï¼Œä¸è¦æœ‰å¼•å·æˆ–å…¶ä»–åºŸè¯ã€‚å­—æ•°æ§åˆ¶åœ¨ 40 å­—ä»¥å†…ã€‚
    `;

    try {
        const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
            body: JSON.stringify({
                model: aiConfig.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        const question = data.choices[0].message.content;

        // æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºé—®é¢˜
        typewriterEffect(document.getElementById('soulQuestion'), question, () => {
            document.getElementById('soulAnswerArea').style.display = 'block';
            document.getElementById('soulInput').focus();
        });

    } catch (e) {
        document.getElementById('soulQuestion').innerText = "ï¼ˆè¿æ¥ä¸­æ–­... çµé­‚è¿æ¥å¤±è´¥ï¼‰";
    }
}

async function submitSoulAnswer() {
    const answer = document.getElementById('soulInput').value.trim();
    if (!answer) return;

    // ç•Œé¢å˜æ›´ä¸ºåŠ è½½çŠ¶æ€
    document.getElementById('soulAnswerArea').style.display = 'none';
    document.getElementById('soulQuestion').innerHTML = '<span style="color:#aaa; font-style:italic;">(æ­£åœ¨è†å¬ä½ çš„å¿ƒå£°...)</span>';

    const prompt = `
    ä½ ï¼ˆ${currentSoulChar.name}ï¼‰åˆšæ‰é—®äº†ç”¨æˆ·ä¸€ä¸ªé—®é¢˜ã€‚
    ç”¨æˆ·çš„å›ç­”æ˜¯ï¼šâ€œ${answer}â€
    
    è¯·æ ¹æ®ä½ çš„äººè®¾ï¼Œå¯¹è¿™ä¸ªå›ç­”åšå‡ºååº”ã€‚
    å¯ä»¥æ˜¯æ„ŸåŠ¨ã€ç”Ÿæ°”ã€å˜²è®½æˆ–è€…å®³ç¾ã€‚
    
    è¾“å‡ºæ ¼å¼ï¼š
    (åŠ¨ä½œ/ç¥æ€æå†™) ä½ çš„å°è¯
    `;

    try {
        const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.apiKey}` },
            body: JSON.stringify({
                model: aiConfig.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        const reaction = data.choices[0].message.content;

        document.getElementById('soulQuestion').innerHTML = reaction.replace(/\n/g, '<br>');
        document.getElementById('soulNextBtn').style.display = 'inline-block'; // æ˜¾ç¤ºä¸‹ä¸€ä½æŒ‰é’®

    } catch (e) {
        auth.toast('å›åº”å¤±è´¥...');
        document.getElementById('soulNextBtn').style.display = 'inline-block';
    }
}

// ç®€å•çš„æ‰“å­—æœºç‰¹æ•ˆå·¥å…·
function typewriterEffect(element, text, callback) {
    element.innerHTML = '';
    let i = 0;
    const speed = 50; 
    function type() {
        if (i < text.length) {
            element.innerHTML += text.charAt(i);
            i++;
            setTimeout(type, speed);
        } else {
            if(callback) callback();
        }
    }
    type();
}

// ================= ğŸ æŠ•å–‚ (åŠ å¼ºä¿®å¤ç‰ˆ) =================
async function giveGift() {
    if (viewingIndex === -1) return;
    
    // ğŸ‘‡ã€å…³é”®ä¿®æ”¹ã€‘å¼ºåˆ¶æŸ¥æ‰¾é…ç½®
    var config = window.aiConfig || aiConfig;
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ æ²¡ API Key æ²¡æ³•é€ç¤¼å‘€ï¼'); return; }

    const item = items[viewingIndex];
    const gift = prompt(`ğŸ ä½ æƒ³é€ç»™ã€${item.name}ã€‘ä»€ä¹ˆç¤¼ç‰©ï¼Ÿ`);
    if (!gift) return;

    auth.toast(`ğŸ æ­£åœ¨é€å‡º ${gift}...`);
    
    const promptStr = `ä½ ï¼ˆ${item.name}ï¼‰æ”¶åˆ°äº†çš‡ä¸Šï¼ˆç”¨æˆ·ï¼‰é€çš„ç¤¼ç‰©ã€${gift}ã€‘ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ï¼ˆ${(item.tags||[]).join(',')}ï¼‰åšå‡ºååº”ã€‚åŒ…å«åŠ¨ä½œå’Œå°è¯ã€‚`;
    sendCustomPromptToAI(promptStr, `ğŸ æœ•é€äº†ä½ ã€${gift}ã€‘...`);
}

// ================= ğŸ‘— æ¢è£… (åŠ å¼ºä¿®å¤ç‰ˆ) =================
async function generateOOTD() {
    if (viewingIndex === -1) return;
    
    // ğŸ‘‡ã€å…³é”®ä¿®æ”¹ã€‘å¼ºåˆ¶æŸ¥æ‰¾é…ç½®
    var config = window.aiConfig || aiConfig;
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ æ²¡ API Key æ²¡æ³•æ¢è£…ï¼'); return; }

    const item = items[viewingIndex];
    const scene = prompt(`ğŸ‘— æƒ³çœ‹ã€${item.name}ã€‘ç©¿ä»€ä¹ˆï¼Ÿ`, "æ³³è£…æ´¾å¯¹");
    if (!scene) return;

    auth.toast(`ğŸ‘— æ­£åœ¨ä¸º ${item.name} æ¢è£…...`);
    
    const promptStr = `è¯·æå†™ä½ ï¼ˆ${item.name}ï¼‰ç©¿ä¸Šã€${scene}ã€‘çš„æ ·å­ã€‚è¯¦ç»†æå†™æœè£…ç»†èŠ‚ã€å‘å‹å’Œç¥æ€ã€‚`;
    sendCustomPromptToAI(promptStr, `ğŸ‘— æœ•æƒ³çœ‹ä½ ç©¿ã€${scene}ã€‘...`);
}

// ================= ğŸ“œ å‘ˆé€’å¥æŠ˜ (å¥³çš‡é™›ä¸‹ä¸“ç”¨ç‰ˆ) =================
async function generateBriefing() {
    // 1. åŸºç¡€æ£€æŸ¥
    if (typeof viewingIndex === 'undefined' || viewingIndex === -1) return;
    
    // 2. è·å–é…ç½®
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { 
        auth.toast('ğŸš« é™›ä¸‹ï¼Œæ²¡å¡« API Keyï¼Œå¥´æ‰æ²¡æ³•å†™å¥æŠ˜å‘€ï¼'); 
        return; 
    }

    const item = items[viewingIndex];
    auth.toast(`ğŸ“œ æ­£åœ¨ä¼ å”¤å°å¾·å­ï¼Œæ±‡æŠ¥ã€${item.name}ã€‘å…¬å­çš„è¿‘å†µ...`);

    // 3. æ™ºèƒ½æå–ä¸Šä¸‹æ–‡
    let chatContext = "ï¼ˆæš‚æ— è¯¦ç»†è®°å½•ï¼Œè¯·æ ¹æ®ä»–æ˜¯å¥³çš‡çš„ç”·å® è¿™ä¸€è®¾å®šï¼Œç¼–é€ ä¸€äº›ä»–åœ¨å®«ä¸­çš„æ—¥å¸¸çäº‹ï¼Œæ¯”å¦‚äº‰é£åƒé†‹ã€ç»ƒä¹ æ‰è‰ºç­‰ï¼‰";
    
    if (item.resources && item.resources.length > 0) {
        for (let i = item.resources.length - 1; i >= 0; i--) {
            const r = item.resources[i];
            if (r.content && (r.type === 'json' || r.name.endsWith('.json') || r.type === 'file')) {
                let raw = r.content;
                if (raw.startsWith('data:')) {
                    try { raw = decodeURIComponent(escape(window.atob(raw.split(',')[1]))); } catch (e) {}
                }
                chatContext = raw.substring(0, 1500); 
                break;
            }
        }
    }

    // 4. å®šä¹‰ Prompt (å¥³å°Šåå®«ç‰ˆ)
    const prompt = `
    ä½ ç°åœ¨æ˜¯å¤§å†…æ€»ç®¡'å°å¾·å­'ã€‚
    ä½ çš„ä¸»äººæ˜¯è‡³é«˜æ— ä¸Šçš„**å¥³çš‡é™›ä¸‹**ï¼ˆç”¨æˆ·ï¼‰ã€‚
    
    å¯¹è±¡è§’è‰²ï¼šã€${item.name}ã€‘ã€‚
    èº«ä»½è®¾å®šï¼šä»–æ˜¯å¥³çš‡åå®«ä¸­çš„ä¸€ä½**ç”·å® /ä¾å›**ã€‚
    æ ‡ç­¾/æ€§æ ¼ï¼š${(item.tags||[]).join(',')}ã€‚

    è¯·æ ¹æ®ä»¥ä¸‹ã€èµ„æ–™ç‰‡æ®µã€‘ï¼Œå†™ä¸€ä»½ã€åå®«å¯†æŠ˜ã€‘å‘ˆç»™å¥³çš‡ã€‚

    ã€è¦æ±‚ã€‘ï¼š
    1. æ ¼å¼ï¼šå¤é£å¥æŠ˜ä½“ï¼ˆå¦‚ï¼šå¯ç¦€é™›ä¸‹ã€å¥´æ‰å©é¦–...ï¼‰ã€‚
    2. å†…å®¹ï¼š
       - æ±‡æŠ¥è¿™ä½ç”·ä¸»å­æœ€è¿‘åœ¨å®«é‡Œåšäº†ä»€ä¹ˆï¼ˆæ˜¯åœ¨æƒ³å¿µé™›ä¸‹ï¼Œè¿˜æ˜¯åœ¨å·å·æŠ¹çœ¼æ³ªï¼Œæˆ–è€…åœ¨ç»ƒå‰‘/è¯»ä¹¦ä»¥æ±‚é™›ä¸‹å‚é’ï¼‰ã€‚
       - ç»“åˆä»–çš„æ€§æ ¼ï¼ˆå‚²å¨‡çš„å¯èƒ½åœ¨ç”Ÿé—·æ°”ï¼Œæ¸©æŸ”çš„å¯èƒ½åœ¨ç†¬æ±¤ï¼‰ã€‚
    3. å»ºè®®ï¼šå¥´æ‰çš„ä¸€ç‚¹å°å»ºè®®ï¼ˆæ¯”å¦‚â€œä»Šæ™šæ˜¯å¦ç¿»ä»–çš„ç‰Œå­â€ï¼Œæˆ–è€…â€œèµèµç‚¹ä»€ä¹ˆå“„å“„ä»–â€ï¼‰ã€‚
    4. è¯­æ°”ï¼šæå…¶å‘å¾®ã€è°„åªšï¼Œæ—¶åˆ»ç»´æŠ¤å¥³çš‡çš„å¨ä¸¥ã€‚
    5. å­—æ•°ï¼š150 å­—ä»¥å†…ã€‚

    ã€èµ„æ–™ç‰‡æ®µã€‘ï¼š
    ${chatContext}
    `;

    // 5. å‘é€è¯·æ±‚
    if (typeof sendCustomPromptToAI === 'function') {
        sendCustomPromptToAI(prompt, `ğŸ“œ å‘ˆé€’å…³äº ${item.name} çš„åå®«å¯†æŠ˜`);
    } else {
        alert("é”™è¯¯ï¼šæ ¸å¿ƒå‘é€å‡½æ•°ä¸¢å¤±ï¼");
    }
}

// ================= ğŸ¡ çš‡å®¶æ¸¸ä¹åœºé€»è¾‘ =================

// âš–ï¸ 1. æ‰¹æŠ˜å­
let currentThroneChar = null;
async function openThroneModal() {
    if(items.length === 0) { auth.toast('åå®«æ— äººï¼'); return; }
    document.getElementById('throneModal').classList.add('active');
    document.getElementById('throneAction').style.display = 'none';
    document.getElementById('throneResult').innerHTML = '';
    
    // éšæœºé€‰äºº
    const item = items[Math.floor(Math.random() * items.length)];
    currentThroneChar = item;
    const div = document.getElementById('throneContent');
    div.innerHTML = `â³ ${item.name} æ­£åœ¨å‘é™›ä¸‹å‘ˆé€’å¥æŠ˜...`;
    
    // AI ç”Ÿæˆè¯·æ±‚
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if(!config || !config.apiKey) { div.innerHTML = 'ğŸš« æ²¡ API Keyï¼Œæ²¡æ³•æ‰¹å¥æŠ˜ï¼'; return; }

    const prompt = `ä½ æ˜¯${item.name}ï¼Œæ€§æ ¼ï¼š${(item.tags||[]).join(',')}ã€‚ä½ æ˜¯å¥³çš‡çš„ç”·å® ã€‚è¯·å‘å¥³çš‡æå‡ºä¸€ä¸ªå…·ä½“çš„ã€ç¬¦åˆä½ æ€§æ ¼çš„è¯·æ±‚ï¼ˆå¦‚æƒ³è¦èµèµã€æƒ³è¦å‡ºå®«ç©ã€æˆ–è€…å‘ŠçŠ¶ï¼‰ã€‚100å­—ä»¥å†…ã€‚`;
    
    try {
        const res = await fetchAI(prompt, config);
        div.innerHTML = `<b>ã€${item.name}ã€‘å¥æ›°ï¼š</b><br>${res}`;
        document.getElementById('throneAction').style.display = 'flex';
    } catch(e) { div.innerHTML = 'âŒ å¥æŠ˜åœ¨è·¯ä¸Šä¸¢äº†...'; }
}

async function handleThrone(action) {
    const resultDiv = document.getElementById('throneResult');
    resultDiv.innerHTML = 'â³ æ­£åœ¨ä¼ æ—¨...';
    document.getElementById('throneAction').style.display = 'none';
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    const mood = action === 'approve' ? 'æ¬£å–œè‹¥ç‹‚ã€è°¢ä¸»éš†æ©' : 'å§”å±ˆå·´å·´ã€æˆ–è€…æš—è‡ªè®°ä»‡';
    const text = action === 'approve' ? 'ğŸ”´ é™›ä¸‹å‡†å¥ï¼' : 'âš« é™›ä¸‹é©³å›ï¼';
    
    const prompt = `ä½ åˆšæ‰çš„è¯·æ±‚è¢«å¥³çš‡ã€${text}ã€‘äº†ã€‚è¯·æ ¹æ®ä½ çš„äººè®¾ï¼Œè¡¨ç°å‡ºã€${mood}ã€‘çš„ååº”ã€‚åŒ…å«åŠ¨ä½œå’Œå°è¯ã€‚`;
    
    try {
        const res = await fetchAI(prompt, config);
        resultDiv.innerHTML = `<b>${text}</b><br><br>${res}`;
    } catch(e) {}
}

// ğŸ® 2. ç¿»ç‰Œå­
let flipCandidates = [];
async function openFlipCardModal() {
    if(items.length < 3) { auth.toast('äººæ•°ä¸è¶³3äººï¼Œæ²¡æ³•é€‰å¦ƒï¼'); return; }
    document.getElementById('flipModal').classList.add('active');
    document.getElementById('flipResult').style.display = 'none';
    
    // éšæœº3äºº
    flipCandidates = [...items].sort(() => Math.random() - 0.5).slice(0, 3);
    const area = document.getElementById('flipCardsArea');
    area.innerHTML = 'â³ æ•¬äº‹æˆ¿æ­£åœ¨å‡†å¤‡ç»¿å¤´ç‰Œ...';
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if(!config || !config.apiKey) return;

    // å¹¶è¡Œç”Ÿæˆ3äººçš„äº‰å® å®£è¨€
    const promises = flipCandidates.map(c => {
        const p = `ä½ æ˜¯${c.name}ï¼Œå¥³çš‡çš„ç”·å® ã€‚è¯·è¯´ä¸€å¥è¯±æƒ‘çš„è¯ï¼Œæ±‚å¥³çš‡ä»Šæ™šç¿»ä½ çš„ç‰Œå­ã€‚`;
        return fetchAI(p, config).then(txt => ({name: c.name, txt: txt}));
    });
    
    try {
        const results = await Promise.all(promises);
        area.innerHTML = '';
        results.forEach((r, idx) => {
            const card = document.createElement('div');
            card.style.cssText = 'background:#4a0000; padding:10px; border:1px solid #d4af37; border-radius:5px; width:30%; cursor:pointer; font-size:12px; display:flex; flex-direction:column; justify-content:space-between;';
            card.innerHTML = `<div style="font-weight:bold; color:#ffd700; margin-bottom:5px;">${r.name}</div><div style="color:#ddd; font-style:italic;">"${r.txt}"</div><div style="margin-top:5px; text-align:center; background:#d4af37; color:#2c0000; border-radius:3px;">ç¿»ç‰Œ</div>`;
            card.onclick = () => confirmFlip(r.name);
            area.appendChild(card);
        });
    } catch(e) { area.innerHTML = 'âŒ ç»¿å¤´ç‰Œæ‘”ç¢äº†...'; }
}

async function confirmFlip(name) {
    const resDiv = document.getElementById('flipResult');
    resDiv.style.display = 'block';
    resDiv.innerHTML = `ğŸŒ™ é™›ä¸‹ç¿»äº†ã€${name}ã€‘çš„ç‰Œå­ï¼<br>â³ æ­£åœ¨å®‰æ’ä¾å¯...`;
    document.getElementById('flipCardsArea').style.display = 'none';
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    const prompt = `å¥³çš‡ä»Šæ™šç¿»äº†ã€${name}ã€‘çš„ç‰Œå­ã€‚è¯·æå†™ä¸€æ®µæµªæ¼«æˆ–åˆºæ¿€çš„ä¾å¯å°å‰§åœºã€‚150å­—å·¦å³ã€‚`;
    const txt = await fetchAI(prompt, config);
    resDiv.innerHTML = `ğŸŒ™ <b>ä»Šå¤œä¾å¯ï¼š${name}</b><br><br>${txt}`;
}

// ğŸ‘‚ 3. å¬å¢™è§’
async function openEavesdropModal() {
    startEavesdrop();
    document.getElementById('eavesdropModal').classList.add('active');
}
async function startEavesdrop() {
    if(items.length < 2) return;
    const c1 = items[Math.floor(Math.random()*items.length)];
    const c2 = items[Math.floor(Math.random()*items.length)];
    if(c1===c2) return startEavesdrop();
    
    const div = document.getElementById('eavesdropContent');
    div.innerHTML = 'â³ æš—å«æ­£åœ¨çªƒå¬...';
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    const prompt = `è¯·æ¨¡æ‹Ÿã€${c1.name}ã€‘å’Œã€${c2.name}ã€‘åœ¨åå®«çš„ç§ä¸‹å¯¹è¯ã€‚ä»–ä»¬åœ¨å·å·è®®è®ºå¥³çš‡ï¼ˆç”¨æˆ·ï¼‰ã€‚å†…å®¹å¯èƒ½æ˜¯äº‰é£åƒé†‹ï¼Œæˆ–è€…æ˜¯ç­–åˆ’ç»™å¥³çš‡æƒŠå–œã€‚å¯¹è¯å½¢å¼ã€‚`;
    
    try {
        const txt = await fetchAI(prompt, config);
        div.innerHTML = txt.replace(/\n/g, '<br>');
    } catch(e) { div.innerHTML = 'âŒ è¢«å‘ç°äº†ï¼Œæš—å«æ’¤é€€ï¼'; }
}

// ğŸ’¢ 4. ä¿®ç½—åœº
function openJealousyModal() {
    const selA = document.getElementById('jealousCharA');
    const selB = document.getElementById('jealousCharB');
    selA.innerHTML = ''; selB.innerHTML = '';
    items.forEach((item, i) => {
        selA.add(new Option(item.name, i));
        selB.add(new Option(item.name, i));
    });
    if(items.length > 1) selB.selectedIndex = 1;
    document.getElementById('jealousyModal').classList.add('active');
    document.getElementById('jealousyResult').style.display = 'none';
}
async function startJealousy() {
    const cA = items[document.getElementById('jealousCharA').value];
    const cB = items[document.getElementById('jealousCharB').value];
    const div = document.getElementById('jealousyResult');
    div.style.display = 'block';
    div.innerHTML = 'â³ ä¸¤äººæ‰“èµ·æ¥äº†...';
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    const prompt = `ã€${cA.name}ã€‘å’Œã€${cB.name}ã€‘æ­£åœ¨ä¸ºäº†äº‰å¤ºå¥³çš‡ï¼ˆç”¨æˆ·ï¼‰çš„å® çˆ±è€Œåµæ¶/æ‰“æ¶ã€‚è¯·æå†™è¿™ä¸ªä¿®ç½—åœºåœºé¢ã€‚åŒ…å«å¯¹è¯å’ŒåŠ¨ä½œã€‚`;
    
    const txt = await fetchAI(prompt, config);
    div.innerHTML = txt.replace(/\n/g, '<br>');
}

// ğŸ”§ ç®€æ˜“ AI è¯·æ±‚å·¥å…·å‡½æ•°
async function fetchAI(prompt, config) {
    if(!config || !config.apiKey) throw new Error("No Key");
    const res = await fetch(`${config.apiUrl}/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
        body: JSON.stringify({
            model: config.model || 'gpt-3.5-turbo',
            messages: [{ role: "user", content: prompt }]
        })
    });
    const data = await res.json();
    return data.choices[0].message.content;
}

// ================= ğŸ§  åŠŸèƒ½ä¸€ï¼šèµ·å±…æ³¨ Â· è‡ªåŠ¨è¡¥å…¨æ¡£æ¡ˆ =================
async function autoFillProfile() {
    if (typeof viewingIndex === 'undefined' || viewingIndex === -1) return;
    
    // 1. æ£€æŸ¥é…ç½®
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸš« é™›ä¸‹ï¼Œæ²¡ API Key æ²¡æ³•å†™èµ·å±…æ³¨ï¼'); return; }

    const item = items[viewingIndex];
    
    // 2. æå–èŠå¤©è®°å½•ä½œä¸ºç´ æ
    let chatContext = "";
    if (item.resources) {
        // æ‰¾æœ€å¤§çš„ä¸€ä¸ª JSON æ–‡ä»¶è¯»å–ï¼ˆé€šå¸¸æ˜¯ä¸»èŠå¤©è®°å½•ï¼‰
        for (let r of item.resources) {
            if (r.content && (r.type === 'json' || r.name.endsWith('.json'))) {
                let raw = r.content.startsWith('data:') ? decodeURIComponent(escape(window.atob(r.content.split(',')[1]))) : r.content;
                // æˆªå–å‰ 3000 å­—ç»™ AI åˆ†æï¼ˆå¤ªé•¿ä¼šè´¹é’±/æŠ¥é”™ï¼‰
                chatContext = raw.substring(0, 3000); 
                break;
            }
        }
    }

    if (!chatContext) { auth.toast('ğŸ“­ è¿™ä¸ªçˆ±å¿æ²¡æœ‰èŠå¤©è®°å½•ï¼Œæ— æ³•åˆ†æ...'); return; }

    auth.toast(`ğŸ§  å°å¾·å­æ­£åœ¨ç ”è¯»ã€${item.name}ã€‘çš„ç”Ÿå¹³...`);

    // 3. æ„å»º Prompt
    const prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚è¯·é˜…è¯»å…³äºç”·å® ã€${item.name}ã€‘çš„èŠå¤©è®°å½•ç‰‡æ®µã€‚
    è¯·å¸®æˆ‘åˆ†æå¹¶æ€»ç»“ä»¥ä¸‹ä¿¡æ¯ï¼š
    1. ä»–çš„æ€§æ ¼å…³é”®è¯ï¼ˆ3ä¸ªï¼‰ã€‚
    2. ä»–å¯¹æˆ‘çš„ç§°å‘¼ã€‚
    3. æˆ‘ä»¬ä¹‹é—´å°è±¡æœ€æ·±çš„ä¸€ä»¶äº‹æˆ–ä¸€å¥è¯ã€‚
    
    ã€è¦æ±‚ã€‘ï¼š
    è¯·ç›´æ¥è¾“å‡º 3-5 è¡Œç®€çŸ­çš„æ–‡æœ¬ï¼Œé€‚åˆä½œä¸ºâ€œå›å¿†å½•â€æˆ–â€œæ¡£æ¡ˆâ€ä¿å­˜ã€‚
    ä¸è¦åºŸè¯ï¼Œæ¯ä¸€è¡Œä¸€å¥è¯ã€‚
    
    ã€èŠå¤©è®°å½•ç‰‡æ®µã€‘ï¼š
    ${chatContext}
    `;

    try {
        // 4. è°ƒç”¨ AI
        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        
        if (data.choices) {
            const result = data.choices[0].message.content;
            
            // 5. è‡ªåŠ¨å¡«å…¥å¹¶ä¿å­˜
            // å°†ç»“æœæŒ‰æ¢è¡Œç¬¦åˆ†å‰²æˆæ•°ç»„
            const newMemories = result.split('\n').filter(line => line.trim() !== '');
            
            // å¦‚æœåŸæ¥æœ‰å›å¿†ï¼Œå°±è¿½åŠ ï¼›æ²¡æœ‰å°±è¦†ç›–
            if (!item.memories) item.memories = [];
            item.memories = item.memories.concat(newMemories);
            
            await saveItemToDB(item); // ä¿å­˜è¿›æ•°æ®åº“
            
            auth.toast('âœ… æ¡£æ¡ˆå·²è¡¥å…¨ï¼(è¯·é‡æ–°æ‰“å¼€è¯¦æƒ…é¡µæŸ¥çœ‹)');
            
            // é¡ºä¾¿æŠŠç»“æœå‘ç»™å°å¾·å­å±•ç¤ºä¸€ä¸‹
            if(typeof sendCustomPromptToAI === 'function') {
                // è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨æ¨¡æ‹Ÿå°å¾·å­è¯´è¯ï¼Œä¸å†æ¬¡è¯·æ±‚AIäº†ï¼Œçœé’±
                appendAIMessage('ai', `<b>ğŸ§  èµ·å±…æ³¨å·²æ›´æ–°ï¼š</b><br>${result.replace(/\n/g, '<br>')}`);
                document.getElementById('floatMenu').classList.add('active');
            }
        }
    } catch (e) {
        auth.toast('ğŸ§  åˆ†æå¤±è´¥ï¼š' + e.message);
    }
}

// ================= ğŸï¸ åŠŸèƒ½äºŒï¼šå‰å°˜å¾€äº‹ Â· å‰§æƒ…å›é¡¾ =================
async function analyzeStoryTimeline() {
    if (typeof viewingIndex === 'undefined' || viewingIndex === -1) return;
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸš« é™›ä¸‹ï¼Œæ²¡ API Keyï¼'); return; }

    const item = items[viewingIndex];
    
    // 1. æå–èŠå¤©è®°å½•
    let chatContext = "";
    if (item.resources) {
        for (let r of item.resources) {
            if (r.content && (r.type === 'json' || r.name.endsWith('.json'))) {
                let raw = r.content.startsWith('data:') ? decodeURIComponent(escape(window.atob(r.content.split(',')[1]))) : r.content;
                // æ—¶é—´è½´éœ€è¦è¯»å¤šä¸€ç‚¹ï¼Œæˆªå– 5000 å­—
                chatContext = raw.substring(0, 5000); 
                break;
            }
        }
    }

    if (!chatContext) { auth.toast('ğŸ“­ æš‚æ— è®°å½•å¯å›é¡¾...'); return; }

    auth.toast(`ğŸï¸ æ­£åœ¨æ¢³ç†ä¸ã€${item.name}ã€‘çš„è¿‡å¾€...`);

    // 2. æ„å»º Prompt
    const prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚è¯·é˜…è¯»æˆ‘ä¸ç”·å® ã€${item.name}ã€‘çš„èŠå¤©è®°å½•ã€‚
    è¯·å¸®æˆ‘æ¢³ç†ä¸€ä»½ã€å‰§æƒ…æ—¶é—´è½´ã€‘ã€‚
    
    ã€è¦æ±‚ã€‘ï¼š
    1. æ‰¾å‡º 3-5 ä¸ªå…³é”®èŠ‚ç‚¹ï¼ˆå¦‚ï¼šåˆè¯†ã€ç¬¬ä¸€æ¬¡çº¦ä¼šã€è¯¯ä¼šã€å’Œå¥½ã€é«˜ç”œæ—¶åˆ»ï¼‰ã€‚
    2. æŒ‰æ—¶é—´/é€»è¾‘é¡ºåºæ’åˆ—ã€‚
    3. æ ¼å¼ï¼šã€äº‹ä»¶åã€‘ï¼šç®€çŸ­æè¿°ã€‚
    
    ã€èŠå¤©è®°å½•ã€‘ï¼š
    ${chatContext}
    `;

    // 3. å‘é€ç»™å°å¾·å­ (ç›´æ¥ç”¨é€šç”¨å‡½æ•°)
    sendCustomPromptToAI(prompt, `ğŸï¸ å¸®æœ•å›å¿†ä¸€ä¸‹å’Œ ${item.name} å‘ç”Ÿè¿‡ä»€ä¹ˆï¼Ÿ`);
}

// ================= ğŸ”§ ä¿®å¤ä¾¿ç­¾å…³é—­æŒ‰é’® =================
function closeNoteModal() {
    document.getElementById('noteModal').classList.remove('active');
    // é‡ç½®ä¸€ä¸‹çŠ¶æ€ï¼Œé˜²æ­¢ä¸‹æ¬¡æ‰“å¼€æ—¶é”™ä¹±
    editingNoteIndex = -1; 
}

// ================= ğŸ“– è½¬å°è¯´ (æ™ºèƒ½ç»­å†™ç‰ˆ - è‡ªåŠ¨æ£€æµ‹è¿›åº¦) =================
async function convertChatToNovel() {
    if (typeof viewingIndex === 'undefined' || viewingIndex === -1) return;
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸš« é™›ä¸‹ï¼Œæ²¡å¡« API Keyï¼'); return; }

    const item = items[viewingIndex];
    
    // ğŸ”¥ è®¾å®šæ¯ç« çš„æ¥¼å±‚æ•° (å¿…é¡»å›ºå®šï¼Œå¦åˆ™æ¢ç®—ä¼šä¹±)
    const BATCH_SIZE = 15; 

    // --- 1. å¯»æ‰¾èŠå¤©è®°å½• ---
    let allMessages = [];
    if (item.resources) {
        for (let r of item.resources) {
            if (r.content && (r.type === 'json' || r.name.endsWith('.json') || r.name.endsWith('.jsonl'))) {
                let raw = r.content;
                if (raw.startsWith('data:')) {
                    try { raw = decodeURIComponent(escape(window.atob(raw.split(',')[1]))); } catch (e) {}
                }
                try {
                    let json = JSON.parse(raw);
                    if (Array.isArray(json)) allMessages = json;
                    else if (json.messages) allMessages = json.messages;
                    else if (json.history) allMessages = json.history;
                } catch (e) {
                    const lines = raw.split('\n');
                    allMessages = lines.map(l => { try { return JSON.parse(l); } catch(e){ return null; } }).filter(x => x);
                }
                if (allMessages.length > 0) break;
            }
        }
    }

    if (allMessages.length === 0) { auth.toast('ğŸ“­ æ²¡æ‰¾åˆ°æœ‰æ•ˆçš„èŠå¤©è®°å½•æ•°æ®...'); return; }

    // --- 2. ğŸ•µï¸ æ ¸å¿ƒä¿®æ”¹ï¼šæ£€æµ‹ç°æœ‰å°è¯´è¿›åº¦ ---
    let existingNovelIndex = -1;
    let currentNovelContent = "";
    let existingChaptersCount = 0;

    // å…ˆæ‰¾æ‰¾æœ‰æ²¡æœ‰å·²ç»å†™è¿‡çš„å°è¯´
    if (item.resources) {
        existingNovelIndex = item.resources.findIndex(r => r.subType === 'å°è¯´' || r.name.includes('å›å¿†å½•'));
    }

    if (existingNovelIndex !== -1) {
        currentNovelContent = item.resources[existingNovelIndex].content;
        
        // ğŸ” æ­£åˆ™æ£€æµ‹ï¼šæ•°ä¸€æ•°é‡Œé¢æœ‰å‡ ä¸ª "ç¬¬xç« "
        // åŒ¹é… "ç¬¬1ç« ", "ç¬¬åäºŒç« " è¿™ç§æ ¼å¼
        const matches = currentNovelContent.match(/ç¬¬[0-9ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾]+ç« /g);
        if (matches) {
            existingChaptersCount = matches.length;
        }
        console.log(`æ£€æµ‹åˆ°å·²å­˜åœ¨ ${existingChaptersCount} ç« `);
    }

    // ğŸ”¥ è‡ªåŠ¨æ¢ç®—ï¼šç›´æ¥æ ¹æ®ç« èŠ‚æ•°ç®—å‡ºè¯¥ä»å“ªä¸€æ¥¼å¼€å§‹
    // æ¯”å¦‚ï¼šæœ‰2ç« ï¼Œæ¯ç« 15æ¥¼ï¼Œé‚£ä¸‹ä¸€æ¬¡å°±ä» 2 * 15 = 30æ¥¼å¼€å§‹
    let startIndex = existingChaptersCount * BATCH_SIZE;
    
    // æ›´æ–°ä¸€ä¸‹æ•°æ®é‡Œçš„æ¸¸æ ‡ï¼Œä¿æŒåŒæ­¥ (è™½ç„¶æˆ‘ä»¬ç°åœ¨ä¸»è¦é æ–‡ä»¶æ£€æµ‹)
    item.novelCursor = startIndex;

    // è®¡ç®—ç»“æŸæ¥¼å±‚
    const endIndex = Math.min(startIndex + BATCH_SIZE, allMessages.length);

    // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å†™å®Œ
    if (startIndex >= allMessages.length) {
        auth.toast(`âœ… å±…ç„¶æ›´å®Œäº†ï¼(æ£€æµ‹åˆ°${existingChaptersCount}ç« ï¼Œå…±${allMessages.length}æ¥¼)`);
        return;
    }

    // --- 3. æå–ç´ æ ---
    const sliceMessages = allMessages.slice(startIndex, endIndex);
    let chatContext = sliceMessages.map(m => {
        const name = m.name || (m.is_user ? 'æˆ‘' : 'TA');
        const text = m.mes || m.content || m.text || "";
        if (!text || m.role === 'system') return ""; 
        return `${name}: ${text}`;
    }).filter(t => t).join('\n');

    const nextChapterNum = existingChaptersCount + 1;

    auth.toast(`ğŸ“– æ­£åœ¨æ ¹æ®èŠå¤©è®°å½• (${startIndex + 1} - ${endIndex}æ¥¼) æ’°å†™ç¬¬ ${nextChapterNum} ç« ...`);

    // --- 4. æ„å»º AI Prompt ---
    const prompt = `
    ã€æŒ‡ä»¤ã€‘ï¼šå°è¯´è¿è½½ç»­å†™
    ã€å½“å‰è¿›åº¦ã€‘ï¼šç¬¬ ${nextChapterNum} ç« 
    
    è¯·å°†ä»¥ä¸‹å¯¹è¯ç´ ææ”¹å†™æˆå°è¯´ã€‚
    
    ã€ä¸¥æ ¼è¦æ±‚ã€‘ï¼š
    1. **åªè¾“å‡ºçº¯æ–‡æœ¬**ï¼Œä¸¥ç¦ä½¿ç”¨ HTML ä»£ç ã€‚
    2. ä¸è¦åˆ—å‡ºå¤§çº²ï¼Œç›´æ¥å¼€å§‹å†™æ­£æ–‡ã€‚
    3. å»æ‰å‰§æœ¬å¼å¯¹è¯ï¼Œè½¬åŒ–ä¸ºç»†è…»çš„æå†™ã€‚
    4. å­—æ•°ï¼š500å­—å·¦å³ã€‚
    
    ã€å¯¹è¯ç´ æã€‘ï¼š
    ${chatContext}
    `;

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.getElementById('novelModal').classList.add('active');
    document.getElementById('novelContent').innerHTML = `<div style="text-align:center; margin-top:100px; color:#8d6e63;">
        â³ æ­£åœ¨ç ”è¯»ã€Š${item.name}çš„å›å¿†å½•ã€‹...<br>
        æ£€æµ‹åˆ°å·²æœ‰ ${existingChaptersCount} ç« <br>
        å³å°†æ’°å†™ç¬¬ ${nextChapterNum} ç«  (${startIndex+1}-${endIndex}æ¥¼)...
    </div>`;

    try {
        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        
        if (data.choices) {
            let newChapter = data.choices[0].message.content;

            // æ¸…æ´—ä»£ç 
            newChapter = newChapter.replace(/<br\s*\/?>/gi, '\n');
            newChapter = newChapter.replace(/<\/p>/gi, '\n\n');
            newChapter = newChapter.replace(/<[^>]+>/g, '');
            newChapter = newChapter.replace(/```html/g, '').replace(/```/g, '');
            newChapter = newChapter.trim();

            // --- 5. ä¿å­˜ ---
            let finalNovel = "";
            let fileName = `${item.name}çš„å›å¿†å½•.txt`;

            if (existingNovelIndex !== -1) {
                // ç»­å†™
                finalNovel = currentNovelContent + "\n\n" + "=".repeat(20) + "\n\n" + newChapter;
                item.resources[existingNovelIndex].content = finalNovel;
                item.resources[existingNovelIndex].date = new Date().toISOString();
            } else {
                // æ–°å»º
                finalNovel = `ã€Š${item.name}çš„å›å¿†å½•ã€‹\n\n` + newChapter;
                if (!item.resources) item.resources = [];
                item.resources.push({
                    type: 'file', subType: 'å°è¯´', name: fileName,
                    content: finalNovel, date: new Date().toISOString()
                });
            }

            await saveItemToDB(item);
            
            document.getElementById('novelContent').innerText = finalNovel;
            setTimeout(() => {
                const div = document.getElementById('novelContent');
                div.scrollTop = div.scrollHeight;
            }, 100);

            window.currentNovelText = finalNovel;
            auth.toast(`ğŸ“š ç¬¬ ${nextChapterNum} ç« å·²å®Œæˆï¼(è¿›åº¦å·²è‡ªåŠ¨æ ¡å‡†)`);
        }
    } catch (e) {
        document.getElementById('novelContent').innerText = 'âŒ ç»­å†™å¤±è´¥ï¼š' + e.message;
    }
}

// ä¸‹è½½åŠŸèƒ½çš„è¾…åŠ©å‡½æ•°
function downloadCurrentNovel() {
    if (!currentNovelText) return;
    const blob = new Blob([currentNovelText], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'æˆ‘çš„åå®«å›å¿†å½•.txt';
    a.click();
}

// ================= ğŸ“˜ æ‰“å¼€æ–‡æœ¬é˜…è¯»å™¨ =================
function openTxtReader(resIndex) {
    if (viewingIndex === -1) return;
    const item = items[viewingIndex];
    const res = item.resources[resIndex];

    // 1. è·å–å†…å®¹
    let textContent = res.content;
    
    // å¦‚æœæ˜¯ Base64 (ä¸Šä¼ çš„æ–‡ä»¶)ï¼Œè§£ç ä¸€ä¸‹
    if (textContent.startsWith('data:')) {
        try {
            // æå– base64 éƒ¨åˆ†å¹¶è§£ç ä¸­æ–‡
            const base64 = textContent.split(',')[1];
            const binStr = atob(base64);
            const bytes = new Uint8Array(binStr.length);
            for (let i = 0; i < binStr.length; i++) {
                bytes[i] = binStr.charCodeAt(i);
            }
            textContent = new TextDecoder('utf-8').decode(bytes);
        } catch (e) {
            textContent = "âŒ æ— æ³•è§£ç æ–‡ä»¶å†…å®¹...";
        }
    }

    // 2. æ”¾å…¥å¤§ä¹¦é¡µ
    document.getElementById('novelContent').innerText = textContent;
    
    // 3. æ‰“å¼€å¼¹çª—
    document.getElementById('novelModal').classList.add('active');
    
    // è®°å½•å½“å‰æ–‡æœ¬ä»¥ä¾¿ä¸‹è½½
    currentNovelText = textContent;
}

// ================= ğŸ¥š é˜²ä¼ªæš—é—¨é€»è¾‘ =================
let copyrightClicks = 0;
let copyrightTimer = null;

function triggerCopyrightEgg() {
    copyrightClicks++;
    
    // å¦‚æœ 2ç§’å†…æ²¡ç»§ç»­ç‚¹ï¼Œå°±é‡ç½®æ¬¡æ•°
    clearTimeout(copyrightTimer);
    copyrightTimer = setTimeout(() => { copyrightClicks = 0; }, 2000);

    // è¿ç‚¹ 5 æ¬¡è§¦å‘
    if (copyrightClicks === 5) {
        alert("ğŸ›¡ï¸ çš‡å®¶é˜²ä¼ªè®¤è¯é€šè¿‡ï¼\n\nâœ… æ­£ç‰ˆæ‰€æœ‰è€…ï¼šã€é•¿æ˜¥è·¯å¥³çš‡ã€‘\nğŸ“… åˆ¶ä½œæ—¶é—´ï¼š2025å¹´\nâš ï¸ ç›—ç‰ˆå¿…ç©¶ï¼\n\n(Original Created by You)");
        copyrightClicks = 0; // é‡ç½®
    }
}

// ================= ğŸŒ  åŠŸèƒ½äºŒï¼šé’¦å¤©ç›‘ Â· ä»Šæ—¥è¿åŠ¿ =================

async function openHoroscope() {
    document.getElementById('horoscopeModal').classList.add('active');
    
    const today = new Date().toLocaleDateString();
    document.getElementById('horoscopeDate').innerText = `ğŸ“… ${today} Â· å†œå†ä¸çŸ¥é“å¤šå°‘`;
    const contentDiv = document.getElementById('horoscopeContent');

    // 1. æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»ç®—è¿‡äº† (å­˜ localStorage)
    const saved = localStorage.getItem('daily_horoscope_' + today);
    if (saved) {
        contentDiv.innerHTML = saved;
        return;
    }

    if (items.length < 2) {
        contentDiv.innerHTML = "ğŸš« åå®«äººæ•°å¤ªå°‘ï¼Œæ˜Ÿè±¡æ¨¡ç³Šä¸æ¸…...";
        return;
    }

    // 2. æ²¡ç®—è¿‡ï¼Œç°åœºç®— (éšæœºæŠ½äºº)
    // éšæœºé€‰ä¸€ä¸ªâ€œå®œâ€çš„äºº
    const luckyChar = items[Math.floor(Math.random() * items.length)];
    // éšæœºé€‰ä¸€ä¸ªâ€œå¿Œâ€çš„äºº (ä¸èƒ½æ˜¯åŒä¸€ä¸ªäºº)
    let unluckyChar = items[Math.floor(Math.random() * items.length)];
    while(unluckyChar === luckyChar && items.length > 1) {
        unluckyChar = items[Math.floor(Math.random() * items.length)];
    }

    // 3. è®© AI ç¼–è¿åŠ¿
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) {
        contentDiv.innerHTML = "â˜ï¸ ä¹Œäº‘é®æœˆï¼Œå›½å¸ˆæ²¡å¸¦ API Key...";
        return;
    }

    const prompt = `
    ä½ æ˜¯çš‡å®¶çš„ã€é’¦å¤©ç›‘å›½å¸ˆã€‘ã€‚
    è¯·ä¸ºå¥³çš‡é™›ä¸‹æ¨ç®—ã€ä»Šæ—¥åå®«è¿åŠ¿ã€‘ã€‚
    
    ã€ä»Šæ—¥å®œã€‘ï¼šä¸´å¹¸ã€${luckyChar.name}ã€‘ã€‚
    ã€ä»Šæ—¥å¿Œã€‘ï¼šå†·è½ã€${unluckyChar.name}ã€‘ã€‚
    
    è¯·ç¼–é€ ç†ç”±ï¼š
    1. ä¸ºä»€ä¹ˆå®œä¸´å¹¸ ${luckyChar.name}ï¼Ÿï¼ˆä¾‹å¦‚ï¼šçº¢é¸¾æ˜ŸåŠ¨ï¼Œä»–ä»Šæ—¥ç”šè‡³å¯çˆ±ï¼‰
    2. ä¸ºä»€ä¹ˆå¿Œå†·è½ ${unluckyChar.name}ï¼Ÿï¼ˆä¾‹å¦‚ï¼šå¤©ç‹—çŠ¯ç…ï¼Œä»–å¿ƒæƒ…ä¸å¥½å®¹æ˜“é»‘åŒ–ï¼‰
    3. ç»™ä¸€å¥ç„ä¹çš„åˆ¤è¯ã€‚
    
    æ ¼å¼ï¼šHTMLæ ¼å¼ï¼Œç”¨ <div> åŒ…è£¹ï¼Œé‡ç‚¹è¯åŠ ç²—ã€‚
    `;

    try {
        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        const data = await response.json();
        const text = data.choices[0].message.content;

        // 4. æ¸²æŸ“å¹¶ä¿å­˜
        const html = `
            <div class="horoscope-card" style="border-color:#81c784; background:rgba(129, 199, 132, 0.1);">
                <div style="color:#81c784; font-weight:bold;">âœ¨ ä»Šæ—¥å®œ</div>
                <div style="font-size:16px; margin:5px 0;">ä¸´å¹¸ ${luckyChar.name}</div>
            </div>
            <div class="horoscope-card" style="border-color:#e57373; background:rgba(229, 115, 115, 0.1);">
                <div style="color:#e57373; font-weight:bold;">ğŸ’€ ä»Šæ—¥å¿Œ</div>
                <div style="font-size:16px; margin:5px 0;">å†·è½ ${unluckyChar.name}</div>
            </div>
            <div style="font-size:13px; text-align:left; margin-top:15px; line-height:1.6;">
                ${text.replace(/```html/g,'').replace(/```/g,'')}
            </div>
        `;
        
        contentDiv.innerHTML = html;
        localStorage.setItem('daily_horoscope_' + today, html); // å­˜ä¸‹æ¥ï¼Œä»Šå¤©ä¸å†å˜
        
    } catch (e) {
        contentDiv.innerHTML = "âŒ å¤©æœºä¸å¯æ³„éœ² (ç½‘ç»œé”™è¯¯)";
    }
}



// å¹´é¾„é˜¶æ®µ
const HEIR_STAGES = [
    { ageCap: 3, name: 'å©´å„¿æœŸ', icon: 'ğŸ‘¶', bg: 'stage-baby' },
    { ageCap: 10, name: 'å¹¼å¹´æœŸ', icon: 'ğŸ‘¦', bg: 'stage-child' },
    { ageCap: 16, name: 'å°‘å¹´æœŸ', icon: 'ğŸ§‘â€ğŸ¦±', bg: 'stage-teen' },
    { ageCap: 99, name: 'æˆå¹´æœŸ', icon: 'ğŸ¤´', bg: 'stage-adult' }
];

// ----------- 1. æŒ‰é’®çŠ¶æ€ç®¡ç† (å·²ä¿®å¤é˜²æŠ¥é”™) -----------

// 1. æ›´æ–°æŒ‰é’®çŠ¶æ€ (å…è®¸äºŒèƒç‰ˆ)
function updateHeirButtonState() {
    var btn = document.getElementById('heirActionButton');
    if (!btn) return;
    if (typeof viewingIndex==='undefined' || !items[viewingIndex]) return;
    
    // å¦‚æœæ²¡æœ‰å­©å­ï¼Œæˆ–è€…å­©å­å·²æˆå¹´/ç¦»å®¶/æ­»äº¡ -> å…è®¸ç”Ÿæ–°çš„
    if (!currentHeir || currentHeir.age >= 18 || currentHeir.isRunaway || currentHeir.isDead) {
        btn.innerText = `ğŸ‘¶ ç¥ˆç¦æ±‚å­ (å®¶æ—å¼€ææ•£å¶)`;
        btn.style.background = '#fff0f5'; btn.style.color = '#ff6b6b';
    } else if (currentHeir.fatherName === items[viewingIndex].name) {
        btn.innerText = `ğŸ§¸ å‰å¾€ä¸œå®« (çœ‹æœ›${currentHeir.name})`; 
        btn.style.background = '#fff7d1'; btn.style.color = '#fa8c16';
    } else {
        btn.innerText = `ğŸš« å®«ä¸­å·²æœ‰å¹¼å­ (${currentHeir.name})`; 
        btn.style.background = '#eee'; btn.style.color = '#999';
    }
}

// 2. å¤„ç†ç‚¹å‡» (å…è®¸äºŒèƒç‰ˆ)
function handleHeirAction() {
    if (viewingIndex === -1) return;
    var item = items[viewingIndex];

    // å¦‚æœæ»¡è¶³ç”ŸäºŒèƒæ¡ä»¶
    if (!currentHeir || currentHeir.age >= 18 || currentHeir.isRunaway || currentHeir.isDead) {
        // å¦‚æœå½“å‰æœ‰æˆå¹´å­©å­ï¼Œç¡®ä¿å·²ç»å­˜è¿›å®¶æ—äº†
        if(currentHeir && currentHeir.age >= 18) {
             let existIdx = familyTree.findIndex(c => c.id === currentHeir.id);
             if (existIdx === -1) { familyTree.push(currentHeir); localStorage.setItem('royal_family_tree', JSON.stringify(familyTree)); }
        }

        document.getElementById('creationFatherName').innerText = item.name;
        document.getElementById('creationSettingInput').value = '';
        document.getElementById('heirCreationModal').classList.add('active');
    } else if (currentHeir.fatherName === item.name) {
        openEastPalace();
    } else {
        auth.toast(`ğŸš« é™›ä¸‹ï¼Œç°åœ¨çš„çš‡å—£ã€${currentHeir.name}ã€‘è¿˜æœªæˆå¹´ï¼Œä¸èƒ½ç”ŸäºŒèƒå“¦ï¼`);
    }
}


// ----------- 2. åˆ›å»ºçš‡å—£ -----------
async function confirmCreateHeir() {
    const setting = document.getElementById('creationSettingInput').value.trim();
    if (!setting) { auth.toast('è¯·è®¸ä¸‹ä¸€ä¸ªæ„¿æœ›å§...'); return; }
    
    const father = items[viewingIndex];
    auth.toast('âœ¨ æ­£åœ¨ç¥ˆæ±‚ä¸Šè‹ï¼Œé™ä¸‹éºŸå„¿...');
    document.getElementById('heirCreationModal').classList.remove('active');

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));

    const prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚å­©å­çš„çˆ¶äº²æ˜¯ã€${father.name}ã€‘ï¼ˆæ€§æ ¼:${(father.tags||[]).join(',')}ï¼‰ã€‚
    æˆ‘å¯¹å­©å­çš„æœŸæœ›æ˜¯ï¼šã€${setting}ã€‘ã€‚
    è¯·ç”Ÿæˆä¸€ä¸ªåˆšå‡ºç”Ÿçš„çš‡å—£æ¡£æ¡ˆã€‚
    è¦æ±‚è¿”å›çº¯ JSON æ ¼å¼ï¼š
    {
        "name": "åå­—(å¤é£å¥½å¬)",
        "title": "å°å·",
        "gender": "ç”·/å¥³",
        "bio": "å‡ºç”Ÿæè¿°(50å­—å†…)",
        "stats": { "wisdom": 10, "fitness": 10, "charm": 10 }
    }
    `;

    try {
        const res = await fetchAI(prompt, config);
        // æ¸…ç† JSON æ ¼å¼ (é˜²æ­¢ AI åŠ  Markdown ç¬¦å·)
        const cleanRes = res.replace(/```json/g,'').replace(/```/g,'').trim();
        const data = JSON.parse(cleanRes);

        currentHeir = {
            fatherName: father.name,
            name: data.name,
            title: data.title,
            gender: data.gender,
            age: 0,
            stats: data.stats,
            bioLog: [`ã€è¯ç”Ÿã€‘ï¼š${data.bio}`],
            setting: setting
        };
        saveHeirData();
        auth.toast('ğŸ‰ æ­å–œé™›ä¸‹ï¼çš‡å—£å·²è¯ç”Ÿï¼');
        updateHeirButtonState();
        openEastPalace();

    } catch (e) {
        auth.toast('âŒ ç¥ˆç¦å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œ');
        console.error(e);
    }
}

function saveHeirData() {
    localStorage.setItem('royal_heir_data', JSON.stringify(currentHeir));
}

// ğŸ‘‡ğŸ‘‡ğŸ‘‡ å…³é”®è¡¥ä¸ï¼šç¼ºå¤±çš„ fetchAI å·¥å…·å‡½æ•° ğŸ‘‡ğŸ‘‡ğŸ‘‡
async function fetchAI(prompt, config) {
    if(!config || !config.apiKey) throw new Error("No Key");
    const response = await fetch(`${config.apiUrl}/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
        body: JSON.stringify({
            model: config.model || 'gpt-3.5-turbo',
            messages: [{ role: "user", content: prompt }]
        })
    });
    const data = await response.json();
    return data.choices[0].message.content;
}

// ================= â¤ï¸ æ ¸å¿ƒï¼šé€šç”¨æ©å® ç®¡ç†ç³»ç»Ÿ =================

// å®šä¹‰ä½ä»½é—¨æ§›
const RANKS = [
    { name: "ä¾å¥´", limit: 20, class: "rank-0" },
    { name: "ç­”åº”", limit: 50, class: "rank-1" },
    { name: "è´µäºº", limit: 100, class: "rank-2" },
    { name: "å«”", limit: 200, class: "rank-3" },
    { name: "å¦ƒ", limit: 500, class: "rank-4" },
    { name: "çš‡è´µå›", limit: 99999, class: "rank-5" }
];

// 1. è·å–ä½ä»½ä¿¡æ¯
function getRankInfo(favor) {
    favor = favor || 0;
    for (let i = 0; i < RANKS.length; i++) {
        if (favor < RANKS[i].limit) return RANKS[i];
    }
    return RANKS[RANKS.length - 1];
}

// 2. é€šç”¨åŠ å¥½æ„Ÿå‡½æ•° (æ ¸å¿ƒ)
// amount: åŠ å¤šå°‘åˆ†
// reason: ä¸ºä»€ä¹ˆåŠ åˆ† (ç”¨äºæç¤º)
async function addFavor(amount, reason) {
    if (typeof viewingIndex === 'undefined' || viewingIndex === -1) return;
    const item = items[viewingIndex];

    // åˆå§‹åŒ–
    if (!item.favor) item.favor = 0;
    const oldRankName = getRankInfo(item.favor).name;

    // åŠ åˆ†
    item.favor += amount;
    const newRankInfo = getRankInfo(item.favor);

    // ä¿å­˜æ•°æ®
    await saveItemToDB(item);

    // åˆ·æ–°ç•Œé¢ UI (å¾½ç« )
    if(typeof updateRankUI === 'function') updateRankUI(item);

    // === åé¦ˆé€»è¾‘ ===
    
    // æƒ…å†µA: æ™‹å‡äº†ï¼
    if (newRankInfo.name !== oldRankName) {
        auth.toast(`ğŸ‰ æ­å–œï¼ã€${item.name}ã€‘æ™‹å‡ä¸ºã€${newRankInfo.name}ã€‘ï¼`);
        // æ»¡å±æ’’èŠ±ç‰¹æ•ˆ (å¦‚æœæœ‰çš„è¯)
        if(navigator.vibrate) navigator.vibrate([100,50,100]); 
        
        // æ™‹å‡åï¼Œå¼ºåˆ¶è®© AI æ„Ÿè°¢è°¢æ© (å¯é€‰)
        // triggerAIReaction(item, newRankInfo.name); 
    } 
    // æƒ…å†µB: åªæ˜¯æ™®é€šåŠ åˆ†
    else {
        // æ˜¾ç¤ºä¸€ä¸ªå°æç¤ºï¼š "â¤ï¸ æ©å®  +1 (èŠå¤©)"
        auth.toast(`â¤ï¸ æ©å®  +${amount} (${reason}) | å½“å‰: ${item.favor}`);
    }
}

// 3. ä¸“é—¨ç»™â€œèµèµæŒ‰é’®â€ç”¨çš„
function manualGrantFavor() {
    // èµèµåŠ çš„å¤šï¼Œ5-10åˆ†éšæœº
    const points = Math.floor(Math.random() * 6) + 5;
    addFavor(points, "èµèµ");
}

// 4. æ›´æ–°ç•Œé¢ä¸Šçš„å¾½ç«  (æ”¾åœ¨ openDetailModal é‡Œè°ƒç”¨)
function updateRankUI(item) {
    const favor = item.favor || 0;
    const rankObj = getRankInfo(favor);
    
    const nameEl = document.getElementById('detailName');
    if(!nameEl) return;

    // æ¸…é™¤æ—§çš„
    const oldBadge = nameEl.querySelector('.rank-badge');
    if (oldBadge) oldBadge.remove();
    
    // åŠ æ–°çš„
    const badge = document.createElement('span');
    badge.className = `rank-badge ${rankObj.class}`;
    badge.innerText = rankObj.name;
    badge.style.cssText = "display:inline-block; padding:2px 8px; border-radius:4px; font-size:11px; margin-left:8px; color:white; vertical-align:middle; background:#ccc;";
    
    // ç»™ä¸åŒç­‰çº§ä¸Šè‰²
    if(rankObj.name === 'ä¾å¥´') badge.style.background = '#b0bec5';
    if(rankObj.name === 'ç­”åº”') badge.style.background = '#81d4fa';
    if(rankObj.name === 'è´µäºº') badge.style.background = '#a5d6a7';
    if(rankObj.name === 'å«”') badge.style.background = '#ffcc80';
    if(rankObj.name === 'å¦ƒ') badge.style.background = '#f48fb1';
    if(rankObj.name === 'çš‡è´µå›') badge.style.background = 'linear-gradient(135deg, #ffd700, #ff8f00)';

    nameEl.appendChild(badge);
}

// ================= ğŸ‘‹ çš‡å—£äº’åŠ¨é€»è¾‘ (æ‘¸æ‘¸ä¹) =================

function touchHeir(event) {
    const ball = event.currentTarget;
    const rect = ball.getBoundingClientRect();
    const clickY = event.clientY - rect.top; // ç‚¹å‡»ä½ç½®ç›¸å¯¹äºçƒé¡¶éƒ¨çš„è·ç¦»
    const ballHeight = rect.height;

    // è·å–äº”å®˜å…ƒç´ 
    const eyeL = document.getElementById('eyeL');
    const eyeR = document.getElementById('eyeR');
    const mouth = document.getElementById('mouth');
    const blushL = document.getElementById('blushL');
    const blushR = document.getElementById('blushR');

    // éœ‡åŠ¨åé¦ˆ
    if(navigator.vibrate) navigator.vibrate(50);

    // åˆ¤æ–­æ‘¸çš„æ˜¯å“ªé‡Œ
    if (clickY < ballHeight / 2) {
        // ğŸ‘‰ æƒ…å†µ Aï¼šæ‘¸å¤´ (Top 50%)
        // ååº”ï¼šçœ¯çœ¼ç¬‘ï¼Œå†’çˆ±å¿ƒ
        
        // 1. å˜è¡¨æƒ… (çœ¯çœ¼)
        eyeL.style.height = '2px'; eyeL.style.top = '5px';
        eyeR.style.height = '2px'; eyeR.style.top = '5px';
        mouth.style.borderRadius = '0 0 10px 10px'; mouth.style.height = '8px'; // å¼€å¿ƒå˜´
        blushL.style.opacity = '1'; blushR.style.opacity = '1'; // è„¸çº¢

        // 2. åŠ¨ç”» (Qå¼¹å‹æ‰)
        ball.style.transform = 'scale(1.1, 0.9)'; 
        
        // 3. æç¤º
        auth.toast(`â˜ï¸ æ‘¸æ‘¸å¤´~ ${currentHeir.name} å¾ˆå¼€å¿ƒ`);

    } else {
        // ğŸ‘‰ æƒ…å†µ Bï¼šæˆ³è‚šå­/è¡£æœ (Bottom 50%)
        // ååº”ï¼šæƒŠè®¶ï¼Œæ‘‡æ™ƒ
        
        // 1. å˜è¡¨æƒ… (åœ†çœ¼Oå‹å˜´)
        eyeL.style.height = '14px'; eyeL.style.top = '0';
        eyeR.style.height = '14px'; eyeR.style.top = '0';
        mouth.style.borderRadius = '50%'; mouth.style.height = '8px'; mouth.style.width = '8px'; // Oå‹å˜´
        
        // 2. åŠ¨ç”» (å·¦å³æ‘‡æ™ƒ)
        ball.style.animation = 'none'; // å…ˆåœå‘¼å¸
        ball.offsetHeight; /* è§¦å‘é‡ç»˜ */
        ball.style.animation = 'shake-ball 0.4s'; // æ‘‡æ™ƒ

        // 3. æç¤º
        auth.toast(`ğŸ‘‰ æˆ³ä¸€æˆ³~ ${currentHeir.name} å“äº†ä¸€è·³`);
    }

    // --- 2ç§’åæ¢å¤åŸçŠ¶ ---
    setTimeout(() => {
        // æ¢å¤å‘¼å¸
        ball.style.animation = 'breathe 3s infinite ease-in-out';
        ball.style.transform = 'scale(1)';
        
        // æ¢å¤è¡¨æƒ…
        eyeL.style.height = '12px'; eyeL.style.top = '0';
        eyeR.style.height = '12px'; eyeR.style.top = '0';
        mouth.style.borderRadius = '0 0 10px 10px'; mouth.style.height = '5px'; mouth.style.width = '10px';
        blushL.style.opacity = '0'; blushR.style.opacity = '0';
    }, 2000);
}

// ================= ğŸ§  åœºæ™¯æ™ºèƒ½åŒ¹é… (å¤šå›¾éšæœºç‰ˆ) =================
function smartUpdateHeirScene(actionText) {
    if (!currentHeir) return;
    
    const isBoy = currentHeir.gender === 'ç”·';
    const sceneList = isBoy ? HEIR_SCENES.boy : HEIR_SCENES.girl;
    const assets = isBoy ? HEIR_ASSETS.boy : HEIR_ASSETS.girl;
    
    // 1. é»˜è®¤å›¾ (ä»ç´ æåº“é‡Œæ‹¿)
    let defaultPool = assets.bg[currentSeason] || assets.bg['æ˜¥'];
    // å¦‚æœé»˜è®¤å›¾ä¹Ÿæ˜¯ä¸ªæ•°ç»„ï¼Œå…ˆéšæœºæŠ½ä¸€å¼ ä½œä¸ºä¿åº•
    let finalUrl = Array.isArray(defaultPool) 
        ? defaultPool[Math.floor(Math.random() * defaultPool.length)] 
        : defaultPool;

    // 2. å°è¯•åŒ¹é…ç‰¹æ®Šåœºæ™¯
    if (actionText) {
        for (let scene of sceneList) {
            // è§„åˆ™ï¼šå­£èŠ‚åŒ¹é… + å…³é”®è¯åŒ¹é…
            if (scene.seasons.includes(currentSeason)) {
                if (scene.keywords.some(key => actionText.includes(key))) {
                    
                    // ğŸ”¥ æ ¸å¿ƒå‡çº§ï¼šåˆ¤æ–­æ˜¯å•å¼ è¿˜æ˜¯å¤šå¼ 
                    if (Array.isArray(scene.url)) {
                        // æ˜¯æ•°ç»„ï¼šéšæœºæŠ½ä¸€å¼ 
                        finalUrl = scene.url[Math.floor(Math.random() * scene.url.length)];
                    } else {
                        // æ˜¯å­—ç¬¦ä¸²ï¼šç›´æ¥ç”¨
                        finalUrl = scene.url;
                    }
                    
                    console.log(`âœ¨ åœºæ™¯åŒ¹é…æˆåŠŸ: [${scene.keywords[0]}] -> éšæœºé€‰ä¸­å›¾ç‰‡`);
                    break; 
                }
            }
        }
    }

    // 3. æ‰§è¡Œæ¢å›¾ (å¸¦æ·¡å…¥æ·¡å‡ºæ•ˆæœ)
    const bgEl = document.getElementById('heirSceneBg');
    if (bgEl) {
        // å¦‚æœæ–°å›¾å’Œæ—§å›¾ä¸€æ ·ï¼Œå°±ä¸é—ªçƒäº†ï¼Œä½“éªŒæ›´å¥½
        const currentBg = bgEl.style.backgroundImage;
        if (currentBg.includes(finalUrl)) return;

        bgEl.style.opacity = 0.5;
        setTimeout(() => {
            bgEl.style.backgroundImage = `url('${finalUrl}')`;
            bgEl.style.opacity = 1;
        }, 200);
    }
}

// ================= ğŸ§  çš‡å—£ç³»ç»Ÿ 2.0 (å…¨åŠŸèƒ½å®Œæ•´æ— ç¼ºç‰ˆ) =================

// 1. è¯»å–å­˜æ¡£
var currentHeir = JSON.parse(localStorage.getItem('royal_heir_data')) || null;

// ğŸŸ¢ æ•°æ®è‡ªåŠ¨ä¿®å¤
if (currentHeir) {
    if (!currentHeir.params) currentHeir.params = {};
    var defaults = { diligence: 50, rebellion: 10, affection: 60, ambition: 50, morality: 50, wisdom: 50, fitness: 50 };
    for (var k in defaults) {
        if (currentHeir.params[k] === undefined) currentHeir.params[k] = defaults[k];
    }
    if (currentHeir.mood === undefined) currentHeir.mood = 80;
    if (!currentHeir.history) currentHeir.history = [];
    if (currentHeir.isWaitingForReply === undefined) currentHeir.isWaitingForReply = false;
    if (!currentHeir.season) currentHeir.season = 'æ˜¥';
    
    // è¡¥å…¨ç”Ÿå­˜æ•°æ®
    if (!currentHeir.body) {
        currentHeir.body = { health: 100, sick: false, waste: 0, height: 110, weight: 18, heartRate: 85 };
    }
    if (!currentHeir.currentScene) currentHeir.currentScene = null;
    if (currentHeir.panelMode === undefined) currentHeir.panelMode = 'stats';

    localStorage.setItem('royal_heir_data', JSON.stringify(currentHeir));
}

// ================= ğŸ“ èŒä¸šä¸æˆå°±æ•°æ®åº“ (æ–°å¢) =================
const CAREER_DB = [
    // ğŸ‘‘ çš‡æƒç±»
    { name: "çš‡å¸", type: "royal", req: { ambition: 90, wisdom: 80 } },
    { name: "æ‘„æ”¿ç‹", type: "royal", req: { ambition: 85, fitness: 80 } },
    { name: "çš‡å", type: "royal", req: { charm: 90, morality: 80 } },
    // âš”ï¸ æ­¦å®˜ç±»
    { name: "å¤§å°†å†›", type: "good", req: { fitness: 90, rebellion: 60 } },
    { name: "å¾¡å‰ä¾å«", type: "good", req: { fitness: 80, morality: 80 } },
    { name: "åˆºå®¢", type: "bad", req: { fitness: 85, morality: 20 } },
    // ğŸ“š æ–‡å®˜/æŠ€è‰ºç±»
    { name: "å®°ç›¸", type: "good", req: { wisdom: 95, morality: 60 } },
    { name: "å¤ªåŒ»", type: "good", req: { wisdom: 80, morality: 80 } },
    { name: "çŠ¶å…ƒéƒ", type: "good", req: { diligence: 90, wisdom: 80 } },
    // ğŸ’° å¸‚äº•ç±»
    { name: "çš‡å•†é¦–å¯Œ", type: "good", req: { wisdom: 70, ambition: 80 } },
    { name: "é’æ¥¼å¤´ç‰Œ", type: "bad", req: { charm: 90, morality: 30 } },
    // ğŸšï¸ åº•å±‚/ç‰¹æ®Š
    { name: "ç§ç”°å†œå¤«", type: "normal", req: { fitness: 50 } },
    { name: "ä¹ä¸", type: "bad", req: { diligence: 10, wisdom: 10 } },
    { name: "å¹³æ°‘", type: "normal", req: {} } // ä¿åº•
];

// åˆå§‹åŒ–å®¶æ—æ ‘ï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰
var familyTree = JSON.parse(localStorage.getItem('royal_family_tree')) || [];

// 2. ğŸŒ èµ„æºä¸åœ°å›¾
var WORLD_MAPS = {
    'outside': {
        name: 'äº¬åŸç¹ååœ°',
        bg: 'https://files.catbox.moe/acbius.jpeg',
        locations: [
            { name: 'è¥¿å¸‚', icon: 'ğŸ®', desc: 'çƒ­é—¹çš„é›†å¸‚' },
            { name: 'æŠ¤åŸæ²³', icon: 'ğŸŒŠ', desc: 'å‚æŸ³ä¾ä¾' },
            { name: 'å¤§æŠ¥æ©å¯º', icon: 'ğŸ””', desc: 'ç¥ˆç¦åœ£åœ°' },
            { name: 'çŠ¶å…ƒæ¥¼', icon: 'ğŸ²', desc: 'æœ€å¥½çš„é…’æ¥¼' },
            { name: 'åŸéƒŠé©¬åœº', icon: 'ğŸ', desc: 'éª‘å°„ä¹‹åœ°' },
            { name: 'æ¡ƒèŠ±å', icon: 'ğŸŒ¸', desc: 'èµèŠ±èƒœåœ°' },
            { name: 'æˆå›­å­', icon: 'ğŸ­', desc: 'å¬æ›²çœ‹æˆ' },
            { name: 'å›å®«', icon: 'ğŸšª', type: 'exit' }
        ]
    }
};

var HEIR_ASSETS = {
    boy: {
        bg: { 
            'æ˜¥': ["https://files.catbox.moe/87xa1i.png", "https://files.catbox.moe/7lhq83.png", "https://files.catbox.moe/3wx26e.png", "https://files.catbox.moe/3lwe0w.png"],
            'å¤': ["https://files.catbox.moe/3lwe0w.png", "https://files.catbox.moe/11wud2.png", "https://files.catbox.moe/75je6d.png", "https://files.catbox.moe/xyp7uw.png"],
            'ç§‹': ["https://files.catbox.moe/87xa1i.png", "https://files.catbox.moe/7lhq83.png", "https://files.catbox.moe/f539et.png", "https://files.catbox.moe/3lwe0w.png"], 
            'å†¬': ["https://files.catbox.moe/idu2gw.jpg", "https://files.catbox.moe/fkfstg.jpg", "https://files.catbox.moe/937inc.png"]
        },
        idle: [ "https://files.catbox.moe/fv8f8p.gif", "https://files.catbox.moe/vdvz1m.gif" ],
        shy: "https://files.catbox.moe/fv8f8p.gif", 
        yawn: "https://files.catbox.moe/vdvz1m.gif"
    },
    girl: {
        bg: {
            'æ˜¥': ["https://files.catbox.moe/zqx3jl.png", "https://files.catbox.moe/j1mo4r.png", "https://files.catbox.moe/vmn42f.png", "https://files.catbox.moe/84wild.png"],
            'å¤': ["https://files.catbox.moe/tw4s8u.jpg", "https://files.catbox.moe/qzmagd.png", "https://files.catbox.moe/gsn7fd.png"],
            'ç§‹': ["https://files.catbox.moe/zqx3jl.png", "https://files.catbox.moe/vmn42f.png"],
            'å†¬': ["https://files.catbox.moe/hjnmf4.jpg", "https://files.catbox.moe/divoox.png", "https://files.catbox.moe/vsqo8k.jpg"] 
        },
        idle: [ "https://files.catbox.moe/8q61ys.gif", "https://files.catbox.moe/4hxxkv.gif" ],
        shy: "https://files.catbox.moe/cokcdl.gif",
        yawn: "https://files.catbox.moe/mezusb.gif"
    }
};

var HEIR_SCENES = {
    boy: [
        { seasons: ['å†¬'], keywords: ['æ¢…', 'èµæ¢…', 'é•¿æ¤…'], url: ['https://files.catbox.moe/idu2gw.jpg'] },
        { seasons: ['å†¬'], keywords: ['å¯å®«', 'ç¡è§‰', 'ä¼‘æ¯', 'èµ·åºŠ'], url: ['https://files.catbox.moe/fkfstg.jpg'] },
        { seasons: ['å†¬'], keywords: ['é›ª', 'é›ªä»—', 'æ‰“é›ª'], url: ['https://files.catbox.moe/937inc.png'] },
        { seasons: ['æ˜¥','ç§‹'], keywords: ['é’“é±¼', 'æ± å¡˜', 'å‚é’“'], url: ['https://files.catbox.moe/87xa1i.png'] },
        { seasons: ['æ˜¥','ç§‹'], keywords: ['ç©è€', 'æ¸¸æˆ', 'è·‘'], url: ['https://files.catbox.moe/7lhq83.png'] },
        { seasons: ['æ˜¥'], keywords: ['èŠ±', 'èµèŠ±'], url: ['https://files.catbox.moe/3wx26e.png'] },
        { seasons: ['æ˜¥','å¤','ç§‹','å†¬'], keywords: ['ç”»ç”»', 'ä¸¹é’'], url: ['https://files.catbox.moe/6iwmot.png'] },
        { seasons: ['æ˜¥','å¤','ç§‹','å†¬'], keywords: ['è¯»ä¹¦', 'çœ‹ä¹¦', 'é˜…è¯»'], url: ['https://files.catbox.moe/3lwe0w.png'] },
        { seasons: ['æ˜¥','å¤','ç§‹','å†¬'], keywords: ['ç»ƒå­—', 'ä¹¦æ³•', 'ä¸Šè¯¾'], url: ['https://files.catbox.moe/11wud2.png'] },
        { seasons: ['æ˜¥','å¤','ç§‹','å†¬'], keywords: ['åƒé¥­', 'å±•ç¤º'], url: ['https://files.catbox.moe/xyp7uw.png'] },
        { seasons: ['æ˜¥','å¤','ç§‹','å†¬'], keywords: ['è®­ç»ƒ', 'ä¹ æ­¦', 'å£«å…µ'], url: ['https://files.catbox.moe/75je6d.png'] }
    ],
    girl: [
        { seasons: ['æ˜¥','ç§‹'], keywords: ['é£ç­'], url: ['https://files.catbox.moe/zqx3jl.png'] },
        { seasons: ['æ˜¥','ç§‹'], keywords: ['æ¯½å­'], url: ['https://files.catbox.moe/vmn42f.png'] },
        { seasons: ['æ˜¥'], keywords: ['ç©è€', 'èŠ±å›­'], url: ['https://files.catbox.moe/j1mo4r.png'] },
        { seasons: ['æ˜¥'], keywords: ['ç§‹åƒ'], url: ['https://files.catbox.moe/84wild.png'] },
        { seasons: ['å¤'], keywords: ['ç©æ°´', 'æ± å¡˜'], url: ['https://files.catbox.moe/tw4s8u.jpg'] },
        { seasons: ['å¤'], keywords: ['è¥¿ç“œ'], url: ['https://files.catbox.moe/qzmagd.png'] },
        { seasons: ['å¤'], keywords: ['ä¼‘æ¯', 'ç¡è§‰'], url: ['https://files.catbox.moe/gsn7fd.png'] },
        { seasons: ['å†¬'], keywords: ['ç©è€', 'å†¬æ—¥'], url: ['https://files.catbox.moe/hjnmf4.jpg'] },
        { seasons: ['å†¬'], keywords: ['è¿‡å¹´', 'ç¯ç¬¼'], url: ['https://files.catbox.moe/divoox.png'] },
        { seasons: ['å†¬'], keywords: ['åºœå¤–', 'é€›è¡—'], url: ['https://files.catbox.moe/vsqo8k.jpg'] }
    ]
};

// ================= ğŸ‘— æœè£…æ•°æ®åº“ (å·²å…³è”å°äººåŠ¨å›¾) =================
var CLOTHING_DB = {
    boy: [
        { name: "è“è‰²å®˜å¸½æœ", url: "https://files.catbox.moe/9gp0ek.gif", gif: "https://files.catbox.moe/zccnqu.gif", desc: "å°å°å¹´çºªå°±æœ‰å®˜å¨" },
        { 
            name: "æ‘„æ”¿ç‹è£…", 
            url: "https://files.catbox.moe/be9pdw.gif", 
            gif: ["https://files.catbox.moe/a6gf30.gif", "https://files.catbox.moe/9h92p0.gif"], // åŒåŠ¨å›¾
            desc: "éœ¸æ°”ä¾§æ¼ï¼Œæƒå€¾æœé‡" 
        },
        { 
            name: "çš‡å­è£…", 
            url: "https://files.catbox.moe/xeario.gif", 
            gif: ["https://files.catbox.moe/3u8z7c.gif", "https://files.catbox.moe/hmecrx.gif"], // åŒåŠ¨å›¾
            desc: "æ ‡å‡†çš„å®«å»·å¸¸æœ" 
        },
        { name: "è¿åŠ¨å¥èº«è£…", url: "https://files.catbox.moe/9bj1yr.gif", gif: "https://files.catbox.moe/pcdreg.gif", desc: "å¼ºèº«å¥ä½“ï¼Œæ´»åŠ›æ»¡æ»¡" },
        { name: "éª‘é©¬è£…", url: "https://files.catbox.moe/k3llhx.gif", gif: "https://files.catbox.moe/lv998z.gif", desc: "é²œè¡£æ€’é©¬å°‘å¹´éƒ" },
        { name: "é€—é¸Ÿè£…", url: "https://files.catbox.moe/lyipsc.gif", gif: "https://files.catbox.moe/no0u75.gif", desc: "é—²æƒ…é€¸è‡´" },
        { name: "å†¬å¤©é›ªåœ°è£…", url: "https://files.catbox.moe/qpcrp5.gif", gif: "https://files.catbox.moe/z4oen5.gif", desc: "ç‘é›ªå…†ä¸°å¹´" },
        { 
            name: "ä¹¦ç¤¾å­¦ä¹ è£…", 
            url: ["https://files.catbox.moe/nnjk7t.gif", "https://files.catbox.moe/aj9p4u.gif"], // å•†åº—å±•ç¤ºåŒå›¾
            gif: ["https://files.catbox.moe/c72oz2.gif", "https://files.catbox.moe/kcyafw.gif"], // å®é™…ç©¿ç€åŒåŠ¨å›¾
            desc: "ä¸¤æ¬¾æ ·å¼éšå¿ƒæ¢" 
        },
        { name: "ç´«è‰²èµèŠ±è£…", url: "https://files.catbox.moe/4nfj1y.gif", gif: "https://files.catbox.moe/pv75lr.gif", desc: "èŠ±å‰æœˆä¸‹ï¼Œé£æµå€œå‚¥" },
        { name: "æˆ˜åœºç»ƒæ­¦è£…", url: "https://files.catbox.moe/4rm59z.gif", gif: "https://files.catbox.moe/hngj1i.gif", desc: "ä¿å®¶å«å›½" }
    ],
    girl: [
        { name: "é¹…é»„è‰²è¥¦è£™", url: "https://files.catbox.moe/x2g8fs.gif", gif: "https://files.catbox.moe/bntmw6.gif", desc: "æ¸©å©‰å¯äºº" },
        { name: "è“ç²‰å¤æ—¥è£™", url: "https://files.catbox.moe/qyq1sy.gif", gif: "https://files.catbox.moe/iw9m37.gif", desc: "æ¸…å‡‰ä¸€å¤" },
        { name: "ç´«è‰²è¥¦è£™", url: "https://files.catbox.moe/xez8lk.gif", gif: "https://files.catbox.moe/pemsyn.gif", desc: "é«˜è´µå…¸é›…" },
        { name: "å†¬æ—¥è™å¤´è£…", url: "https://files.catbox.moe/sbxewc.gif", gif: "https://files.catbox.moe/dutxp4.gif", desc: "è™å¤´è™è„‘" },
        { name: "ä¸Šç²‰ä¸‹è“å¯çˆ±è£…", url: "https://files.catbox.moe/360a8k.gif", gif: "https://files.catbox.moe/m4mmab.gif", desc: "ä¿çš®å¯çˆ±" },
        { name: "å¤§çº¢è¿‡å¹´è£…", url: "https://files.catbox.moe/1h3cy5.gif", gif: "https://files.catbox.moe/uummm9.gif", desc: "å–œæ°”æ´‹æ´‹" },
        { name: "ç©è€è£…", url: "https://files.catbox.moe/izucss.gif", gif: "https://files.catbox.moe/xyaa83.gif", desc: "æ–¹ä¾¿è·‘è·³" },
        { name: "æ˜¥æ—¥èµæ™¯è£…", url: "https://files.catbox.moe/md5dz9.gif", gif: "https://files.catbox.moe/7tu8va.gif", desc: "äººæ¯”èŠ±å¨‡" },
        { name: "å¦©åªšæ‘‡æ‰‡è£…", url: "https://files.catbox.moe/xuzyz4.gif", gif: "https://files.catbox.moe/og0tcu.gif", desc: "é£æƒ…ä¸‡ç§" },
        { name: "è¿‡èŠ‚å–œåº†è£…", url: "https://files.catbox.moe/cgn0b2.gif", gif: "https://files.catbox.moe/dgvp4o.gif", desc: "çƒ­é—¹éå‡¡" }
    ]
};


// 3. è¯ç”Ÿé€»è¾‘
async function confirmCreateHeir() {
    var setting = document.getElementById('creationSettingInput').value.trim();
    if (!setting) { auth.toast('è¯·è®¸æ„¿...'); return; }
    
    var father = items[viewingIndex];
    document.getElementById('heirCreationModal').classList.remove('active');
    auth.toast('âœ¨ ç¥ˆç¦ä¸­...');

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var prompt = `æˆ‘æ˜¯å¥³çš‡ã€‚çˆ¶äº²ã€${father.name}ã€‘(æ ‡ç­¾:${(father.tags||[]).join(',')})ã€‚æœŸæœ›:ã€${setting}ã€‘ã€‚ç”Ÿæˆçš‡å—£JSON:{ "name":"", "title":"", "gender":"ç”·/å¥³", "bio":"", "params":{ "diligence":50, "rebellion":10, "affection":80, "ambition":50, "morality":50, "wisdom":50, "fitness":50 }}`;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());

        currentHeir = {
            fatherName: father.name,
            name: data.name, title: data.title, gender: data.gender,
            age: 5, isRunaway: false, isAdult: false, isDead: false,
            params: data.params, mood: 80, history: [], bioLog: [`ã€è¯ç”Ÿã€‘ï¼š${data.bio}`],
            setting: setting, lastThought: "ä¸–ç•ŒçœŸå¤§...", isWaitingForReply: false, season: 'æ˜¥',
            body: { health: 100, sick: false, waste: 0, height: 110, weight: 18, heartRate: 85 },
            currentScene: null, panelMode: 'stats'
        };
        saveHeirData();
        auth.toast('ğŸ‰ çš‡å—£è¯ç”Ÿï¼');
        updateHeirButtonState();
        openEastPalace();
    } catch (e) { auth.toast('âŒ è¯ç”Ÿå¤±è´¥'); }
}

// 4. ğŸ¨ ä¸œå®«ç•Œé¢æ¸²æŸ“ (ä¿®å¤ç‰ˆï¼šé«˜äº®æ‰‹æœºæŒ‰é’®)

// ğŸ¨ ä¸œå®«ä¸»ç•Œé¢ (ä¿®å¤ç‰ˆï¼šä¼˜å…ˆæ˜¾ç¤ºç©¿æˆ´çš„è¡£æœ)
function openEastPalace() {
    if (!currentHeir) return;
    if (!currentHeir.params) { location.reload(); return; }
    
    if (currentHeir.isDead && !currentHeir.isViewingMemories) { renderDeadView(); return; }
    if (currentHeir.isRunaway && !currentHeir.isViewingMemories) { renderRunawayView(); return; }
    if (currentHeir.isViewingMemories) { renderMemoryBook(); return; }

    document.getElementById('eastPalaceModal').classList.add('active');

    var isBoy = currentHeir.gender === 'ç”·';
    var assets = isBoy ? HEIR_ASSETS.boy : HEIR_ASSETS.girl;
    
    // 1. èƒŒæ™¯å›¾é€»è¾‘
    var displayBg = "";
    if (currentHeir.currentScene) {
        displayBg = currentHeir.currentScene;
    } else {
        var pool = assets.bg[currentHeir.season] || assets.bg['æ˜¥'];
        displayBg = Array.isArray(pool) ? pool[Math.floor(Math.random()*pool.length)] : pool;
        currentHeir.currentScene = displayBg;
        saveHeirData();
    }

    // ğŸ”¥ 2. ç«‹ç»˜é€»è¾‘ (æ ¸å¿ƒä¿®å¤) ğŸ”¥
    var avatarUrl = "";
    // å¦‚æœç”Ÿç—…äº†ï¼Œå¼ºåˆ¶æ˜¾ç¤ºç”Ÿç—…å›¾ (ä¼˜å…ˆçº§æœ€é«˜)
    if (currentHeir.body.sick) {
        avatarUrl = assets.yawn; 
    } 
    // å¦‚æœæ²¡ç”Ÿç—…ä¸”ç©¿äº†è¡£æœï¼Œæ˜¾ç¤ºè¡£æœåŠ¨å›¾
    else if (currentHeir.currentOutfit) {
        avatarUrl = currentHeir.currentOutfit;
    } 
    // å¦åˆ™æ˜¾ç¤ºé»˜è®¤éšæœºå¾…æœºå›¾
    else {
        var idlePool = assets.idle;
        avatarUrl = Array.isArray(idlePool) ? idlePool[0] : idlePool;
    }

    // ğŸ“ èŒä¸šä¸æ‹çˆ±çŠ¶æ€
    var careerHtml = (currentHeir.age>=18 && currentHeir.career) ? `<span class="career-badge ${CAREER_DB.find(c=>c.name===currentHeir.career)?.type||'normal'}">${currentHeir.career}</span>` : '';
    var loveHtml = (currentHeir.dating && currentHeir.dating.partners && currentHeir.dating.partners.length>0) ? '<span class="love-status-tag">ğŸ’‘ çƒ­æ‹</span>' : '';

    var modalContent = document.querySelector('#eastPalaceModal .modal');
    
    // è¾…åŠ©ï¼šè¿›åº¦æ¡HTMLç”Ÿæˆå™¨
    var renderBar = (label, val, color) => `<div style="display:flex;align-items:center;margin-bottom:3px;font-size:10px;"><span style="width:24px;text-align:right;color:#666;">${label}</span><div style="flex:1;height:6px;background:#f0f0f0;margin:0 4px;border-radius:3px;"><div style="width:${val}%;height:100%;background:${color};"></div></div><span style="width:20px;color:#999;">${val}</span></div>`;

    // è¾…åŠ©ï¼šä¸­é—´é¢æ¿å†…å®¹
    var middlePanelHtml = "";
    if (currentHeir.panelMode === 'info') {
        middlePanelHtml = `<div class="info-grid"><div class="info-item"><span>ç”Ÿæ—¥</span>${currentHeir.season}</div><div class="info-item"><span>èº«é«˜</span>${currentHeir.body.height}cm</div><div class="info-item"><span>ä½“é‡</span>${currentHeir.body.weight}kg</div><div class="info-item"><span>å¿ƒç‡</span>${currentHeir.body.heartRate}</div><div class="info-item"><span>å¥åº·</span>${currentHeir.body.health}%</div><div class="info-item"><span>çŠ¶æ€</span>${currentHeir.body.sick?'ğŸ¤’':'âœ¨'}</div><div class="info-item"><span>èŒä¸š</span>${currentHeir.career||'æ— '}</div></div>`;
    } else {
        middlePanelHtml = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 10px;">${renderBar('äº²å¯†',currentHeir.params.affection,'#ff7675')}${renderBar('å‹¤å‹‰',currentHeir.params.diligence,'#0984e3')}${renderBar('å›é€†',currentHeir.params.rebellion,'#636e72')}${renderBar('é‡å¿ƒ',currentHeir.params.ambition,'#6c5ce7')}${renderBar('å¿ƒæƒ…',currentHeir.mood,'#fdcb6e')}${renderBar('é“å¾·',currentHeir.params.morality,'#00b894')}${renderBar('æ™ºæ…§',currentHeir.params.wisdom,'#00cec9')}${renderBar('ä½“é­„',currentHeir.params.fitness,'#d63031')}</div>`;
    }

    modalContent.innerHTML = `
        <button class="close-modal" onclick="closeEastPalace()" style="position:absolute;right:10px;top:10px;z-index:200;color:#fff;font-size:24px;background:none;border:none;text-shadow:0 1px 2px rgba(0,0,0,0.3);">Ã—</button>
        
        <div id="heirSceneBg" class="heir-bg-stage" style="background-image:url('${displayBg}');height:150px;position:relative;border-bottom:3px solid #fff;">
            <div style="position:absolute;top:10px;left:10px;background:rgba(255,255,255,0.9);padding:3px 8px;border-radius:10px;font-size:11px;font-weight:bold;color:#555;box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                ğŸ“… ${currentHeir.age}å² Â· ${currentHeir.season}å­£ ${careerHtml} ${loveHtml}
            </div>
            
            <button onclick="readMind()" style="position:absolute;top:10px;right:135px;background:rgba(0,0,0,0.5);color:#fff;border:1px solid rgba(255,255,255,0.8);border-radius:20px;padding:3px 10px;font-size:10px;cursor:pointer;">ğŸ”® è¯»å¿ƒ</button>
            <button onclick="openMemories()" style="position:absolute;top:10px;right:50px;background:rgba(255,255,255,0.8);color:#555;border:1px solid #ddd;border-radius:20px;padding:3px 10px;font-size:10px;cursor:pointer;font-weight:bold;">ğŸ“– å›å¿†</button>

            <button onclick="openPhone()" style="position:absolute;bottom:10px;left:10px;width:40px;height:40px;border-radius:50%;background:#fff;border:2px solid #ddd;font-size:22px;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;z-index:50;" title="æ‰“å¼€æ‰‹æœº">ğŸ“±</button>

            <div id="heirBubble" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:#fff;padding:8px 12px;border-radius:15px;font-size:12px;max-width:80%;box-shadow:0 5px 15px rgba(0,0,0,0.2);opacity:0;transition:all 0.3s;pointer-events:none;z-index:30;color:#444;text-align:center;">...</div>
        </div>

        <div style="display:flex;height:140px;padding:10px;background:#fff;border-bottom:1px dashed #eee;">
            <div style="width:100px;height:100%;position:relative;flex-shrink:0;border-right:1px dashed #eee;margin-right:10px;display:flex;align-items:flex-end;justify-content:center;">
                <img id="heirDynamicGif" class="heir-gif" src="${avatarUrl}" onclick="touchHeir2D()" style="max-height:100%;max-width:100%;object-fit:contain;filter:drop-shadow(2px 4px 6px rgba(0,0,0,0.1));">
            </div>
            <div style="flex:1;overflow-y:auto;">
                <div style="text-align:right;">
                    <button class="switch-btn ${currentHeir.panelMode==='stats'?'active':''}" onclick="switchPanel('stats')">æ€§æ ¼</button>
                    <button class="switch-btn ${currentHeir.panelMode==='info'?'active':''}" onclick="switchPanel('info')">æ¡£æ¡ˆ</button>
                </div>
                ${middlePanelHtml}
            </div>
        </div>

        <div style="flex:1;display:flex;flex-direction:column;background:#f9f9f9;overflow:hidden;">
            <div id="heirChatArea" class="heir-chat-container" style="padding:10px;">
                <div style="text-align:center;color:#ccc;font-size:10px;margin-top:5px;">â€”â€” è®°å½• â€”â€”</div>
                ${(currentHeir.history||[]).map(h=>`<div class="heir-msg ${h.role}">${h.content}</div>`).join('')}
            </div>
            <div class="heir-input-area" style="padding:8px;">
                <div class="heir-input-row">
                    <input type="text" id="heirInput" class="heir-input-box" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." onkeydown="if(event.key==='Enter') sendToHeir()">
                    <button class="heir-send-btn" onclick="sendToHeir()" style="padding:0 15px;font-size:13px;">å‘é€</button>
                </div>
                <div class="heir-func-row" style="margin-top:5px;">
                    <button class="heir-func-btn" onclick="toggleHeirSeason()">ğŸƒ æ¢å­£</button>
                    <button class="heir-func-btn" onclick="advanceYear()">â© è·³è¿‡ä»Šå¹´</button>
                </div>
            </div>
        </div>
    `;
    
    var chatArea = document.getElementById('heirChatArea');
    if (chatArea) chatArea.scrollTop = chatArea.scrollHeight;
}



// 7. ğŸ“± æ‰‹æœºç³»ç»Ÿé€»è¾‘

// ================= ğŸ“± æ‰‹æœºç³»ç»Ÿæ ¸å¿ƒé€»è¾‘ (å®Œæ•´åŠŸèƒ½ç‰ˆ) =================

// 1. æ‰“å¼€/å…³é—­æ‰‹æœº
function openPhone() {
    if (!document.getElementById('iphoneModal')) {
        var modal = document.createElement('div');
        modal.id = 'iphoneModal';
        modal.className = 'iphone-modal';
        document.body.appendChild(modal);
    }
    document.getElementById('iphoneModal').style.display = 'flex';
    renderPhoneHome();
}

function closePhone() {
    document.getElementById('iphoneModal').style.display = 'none';
    openEastPalace(); // åˆ·æ–°ä¸»ç•Œé¢
}

// 2. æ¸²æŸ“æ‰‹æœºæ¡Œé¢
function renderPhoneHome() {
    var modal = document.getElementById('iphoneModal');
    // å¼ºåˆ¶ç²‰è‰²å¤–è§‚
    modal.style.border = "6px solid #ffb7c5";
    modal.style.borderRadius = "35px";
    modal.style.background = "#fff0f5";

    var now = new Date();
    var timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

    modal.innerHTML = `
        <div class="iphone-chin-top"><div class="iphone-camera"></div><div class="iphone-speaker"></div></div>
        <div class="iphone-screen" style="background: url('https://files.catbox.moe/gsn7fd.png') center/cover;">
            <div class="iphone-statusbar" style="background:rgba(255,255,255,0.6); color:#333;">
                <span>HD</span><span>${timeStr}</span><span>88%</span>
            </div>
            
            <div class="app-grid" style="padding: 20px; gap: 15px;">
                <div class="app-icon" style="background:linear-gradient(135deg, #07c160, #2ecc71);" onclick="openApp('wechat')"><div style="font-size:24px;">ğŸ’¬</div><div class="app-name">å¾®èŠ</div></div>
                <div class="app-icon" style="background:linear-gradient(135deg, #5352ed, #70a1ff);" onclick="openApp('spyware')"><div style="font-size:24px;">ğŸ‘ï¸</div><div class="app-name">ç›‘æŠ¤äºº</div></div>
                <div class="app-icon" style="background:linear-gradient(135deg, #ff9ff3, #f368e0);" onclick="openApp('matchmaker')"><div style="font-size:24px;">â¤ï¸</div><div class="app-name">å§»ç¼˜ç°¿</div></div>
                <div class="app-icon" style="background:linear-gradient(135deg, #ff6b81, #ff4757);" onclick="openApp('clothing')"><div style="font-size:24px;">ğŸ‘—</div><div class="app-name">é”¦è¡£é˜</div></div>
                
                <div class="app-icon" style="background:linear-gradient(135deg, #ff7675, #fab1a0);" onclick="openShopApp('hospital', 'å¤ªåŒ»å±€')"><div style="font-size:24px;">ğŸ¥</div><div class="app-name">å¤ªåŒ»å±€</div></div>
                <div class="app-icon" style="background:linear-gradient(135deg, #74b9ff, #0984e3);" onclick="openShopApp('shop', 'çå®é˜')"><div style="font-size:24px;">ğŸ›ï¸</div><div class="app-name">çå®é˜</div></div>
                <div class="app-icon" style="background:linear-gradient(135deg, #ffeaa7, #fdcb6e);" onclick="openShopApp('meituan', 'å¾¡è†³æˆ¿')"><div style="font-size:24px;">ğŸ±</div><div class="app-name">å¾¡è†³æˆ¿</div></div>
            </div>
            
            <div id="activeAppWindow"></div>
        </div>
        <div class="iphone-chin-bottom" style="background:#fff0f5;"><button class="iphone-home-btn" onclick="closePhone()" style="border:2px solid #ffb7c5;"></button></div>
    `;
}

// 3. é€šç”¨è·¯ç”± (è§£å†³ç™½å±çš„å…³é”®)
function openApp(name) {
    var win = document.getElementById('activeAppWindow');
    win.innerHTML = '';
    var appDiv = document.createElement('div');
    appDiv.className = 'app-window';
    appDiv.style.background = "#f7f9fc"; // APPå†…éƒ¨èƒŒæ™¯è‰²
    
    // è¿™é‡Œè°ƒç”¨å…·ä½“çš„æ¸²æŸ“å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰è¿™äº›å‡½æ•°å°±ä¼šç™½å±
    if (name === 'wechat') renderWeChat(appDiv);
    else if (name === 'clothing') renderClothingApp(appDiv);
    else if (name === 'spyware') renderSpywareApp(appDiv);
    else if (name === 'matchmaker') renderMatchmakerApp(appDiv);
    
    win.appendChild(appDiv);
    requestAnimationFrame(() => appDiv.classList.add('open'));
}

// ================= ğŸ‘— é”¦è¡£é˜ (æœè£…åº—) =================

// ğŸ‘— é”¦è¡£é˜ (é€»è¾‘æ›´æ–°ï¼šå±•ç¤ºé™æ€å›¾ï¼Œç©¿æˆ´åŠ¨æ€å›¾)
function renderClothingApp(container) {
    var gender = currentHeir.gender === 'ç”·' ? 'boy' : 'girl';
    var list = CLOTHING_DB[gender];
    if (!currentHeir.inventory) currentHeir.inventory = [];
    
    var gridHtml = list.map((item, idx) => {
        var isOwned = currentHeir.inventory.includes(item.name);
        
        // 1. å•†åº—å±•ç¤ºå›¾ (å§‹ç»ˆç”¨ urlï¼Œå¦‚æœæ˜¯æ•°ç»„å–ç¬¬0å¼ )
        var shopImgUrl = Array.isArray(item.url) ? item.url[0] : item.url;
        
        // 2. åˆ¤æ–­å½“å‰æ˜¯å¦ç©¿åœ¨èº«ä¸Š (æ¯”è¾ƒ gif é“¾æ¥)
        // æ³¨æ„ï¼šcurrentOutfit å­˜çš„æ˜¯ gif é“¾æ¥
        var currentGifUrl = Array.isArray(item.gif) ? item.gif[0] : item.gif;
        var isWearing = (currentHeir.currentOutfit === currentGifUrl) || 
                        (Array.isArray(item.gif) && item.gif.includes(currentHeir.currentOutfit));

        var btnText = isOwned ? (isWearing ? "å·²ç©¿æˆ´" : "ç©¿æˆ´") : "è´­ä¹°";
        var btnAction = isOwned ? `wearOutfit('${gender}', ${idx}, 0)` : `buyOutfit('${item.name}')`;
        var btnStyle = isOwned ? "background:#00b894" : "background:#ff7675";
        
        // 3. åˆ‡æ¢æ ·å¼æŒ‰é’® (å¦‚æœ gif æ˜¯æ•°ç»„ï¼Œè¯´æ˜æœ‰å¤šç§åŠ¨ä½œ)
        var toggleBtn = (Array.isArray(item.gif) && isOwned) 
            ? `<button class="shop-btn" style="background:#a29bfe; margin-top:5px; font-size:10px; width:100%;" onclick="wearOutfit('${gender}', ${idx}, 1)">ğŸ”„ æ¢ä¸ªåŠ¨ä½œ</button>` 
            : '';

        return `
            <div class="clothing-card" style="background:white; border-radius:8px; padding:10px; border:1px solid #eee; position:relative;">
                ${isOwned ? '<div style="position:absolute; top:5px; right:5px; background:#00b894; color:white; font-size:10px; padding:2px 5px; border-radius:4px;">å·²æ‹¥æœ‰</div>' : ''}
                <img src="${shopImgUrl}" class="clothing-img">
                <div style="font-weight:bold; font-size:12px; margin-bottom:2px;">${item.name}</div>
                <div style="font-size:10px; color:#999; margin-bottom:5px;">${item.desc}</div>
                <button class="shop-btn" style="${btnStyle}; width:100%;" onclick="${btnAction}">${btnText}</button>
                ${toggleBtn}
            </div>
        `;
    }).join('');

    container.innerHTML = `
        <div class="app-header">
            <button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>
            <span style="flex:1; text-align:center;">é”¦è¡£é˜</span>
            <span style="width:20px;"></span>
        </div>
        <div class="app-content">
            <div class="clothing-grid">${gridHtml}</div>
        </div>
    `;
}


function buyOutfit(name) {
    if (!currentHeir.inventory.includes(name)) {
        currentHeir.inventory.push(name);
        saveHeirData();
        auth.toast('ğŸ›ï¸ è´­ä¹°æˆåŠŸï¼');
        openApp('clothing'); // åˆ·æ–°
    }
}

// ç©¿æˆ´é€»è¾‘ (å­˜å…¥ GIF)

// ğŸ‘— ç©¿æˆ´é€»è¾‘ (ä¿®æ­£ç‰ˆï¼šå­˜å…¥åŠ¨å›¾)
function wearOutfit(gender, idx, variantIdx) {
    var item = CLOTHING_DB[gender][idx];
    
    // è·å–å¯¹åº”çš„åŠ¨å›¾é“¾æ¥
    // é€»è¾‘ï¼šå¦‚æœæ•°æ®é‡Œæœ‰ gif å­—æ®µï¼Œå°±ç”¨ gifï¼›å¦åˆ™ç”¨ urlï¼ˆé˜²æŠ¥é”™ï¼‰
    var targetGif = "";
    if (item.gif) {
        targetGif = Array.isArray(item.gif) ? item.gif[variantIdx || 0] : item.gif;
    } else {
        // å¦‚æœè¿™ä»¶è¡£æœæ²¡é…åŠ¨å›¾ï¼Œå°±å›é€€åˆ°é™æ€å›¾ï¼ˆæˆ–è€…ä½ å¯ä»¥å¡«ä¸€ä¸ªé»˜è®¤å›¾ï¼‰
        targetGif = Array.isArray(item.url) ? item.url[0] : item.url;
    }
    
    currentHeir.currentOutfit = targetGif; // ğŸ”¥ æ ¸å¿ƒï¼šæŠŠåŠ¨å›¾å­˜è¿›å­˜æ¡£
    saveHeirData();
    
    auth.toast(`ğŸ‘— å·²æ¢ä¸Šï¼š${item.name}`);
    openApp('clothing'); // åˆ·æ–°å•†åº—æ˜¾ç¤ºçŠ¶æ€
    openEastPalace();    // ç«‹å³åˆ·æ–°ä¸»é¡µ
}



// ================= â¤ï¸ æ‹çˆ±ç³»ç»Ÿ 2.0 (å¾ªåºæ¸è¿›ç‰ˆ) =================

let currentPartnerIdx = -1; // å½“å‰æ­£åœ¨æŸ¥çœ‹è°çš„è¯¦æƒ…

// 1. æ¸²æŸ“å§»ç¼˜ç°¿å…¥å£ (åˆ—è¡¨é¡µ)

// â¤ï¸ å§»ç¼˜ç°¿å…¥å£ (å¸¦è‡ªåŠ¨ä¿®å¤è¡¥ä¸)

// â¤ï¸ å§»ç¼˜ç°¿å…¥å£ (ä¿®å¤ç‰ˆï¼šå¼ºåˆ¶ä½å¥½æ„Ÿå¼€å±€)
async function renderMatchmakerApp(container) {
    // 1. å¹´é¾„æ£€æŸ¥
    if (currentHeir.age < 14) {
        container.innerHTML = `<div class="app-header"><button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>å§»ç¼˜ç°¿</div><div class="app-content" style="text-align:center;padding-top:50px;color:#999;">ğŸ‘¶ å­©å­è¿˜å°ï¼Œå­¦ä¸šä¸ºé‡ï¼<br>(14å²å¼€å¯)</div>`;
        return;
    }
    
    // 2. åˆå§‹åŒ–ä¸ä¿®å¤
    if (!currentHeir.dating) currentHeir.dating = { partners: [] };
    
    // ğŸ”¥ å…³é”®ä¿®å¤ï¼šä¸å†ç»§æ‰¿æ—§çš„é«˜åˆ† matchï¼Œå¼ºåˆ¶é‡ç½®ä¸ºä½åˆ†
    let needSave = false;
    currentHeir.dating.partners.forEach(p => {
        if (!p.status) { p.status = 'ç›¸è¯†'; needSave = true; }
        
        // å¦‚æœå¥½æ„Ÿåº¦æœªå®šä¹‰ï¼Œæˆ–è€…å¥½æ„Ÿåº¦è¿‡é«˜ä½†çŠ¶æ€å´æ˜¯â€œç›¸è¯†â€ï¼ˆè¯´æ˜æ˜¯æ—§æ•°æ®é”™è¯¯ç»§æ‰¿äº†ï¼‰ï¼Œå¼ºåˆ¶é‡ç½®
        if (p.affinity === undefined || (p.affinity > 20 && p.status === 'ç›¸è¯†')) { 
            p.affinity = Math.floor(Math.random() * 15); // 0-15åˆ†ä¹‹é—´
            needSave = true; 
        }
        
        if (!p.logs) { p.logs = []; needSave = true; }
    });
    if (needSave) saveHeirData();

    // 3. å¦‚æœæ²¡å¯¹è±¡ï¼Œç”Ÿæˆæ–°çš„
    if (currentHeir.dating.partners.length === 0) await generatePartners();

    // 4. æ¸²æŸ“åˆ—è¡¨
    var listHtml = currentHeir.dating.partners.map((p, idx) => {
        let statusColor = '#999';
        if(p.status === 'çƒ­æ‹') statusColor = '#ff4757';
        if(p.status === 'æ‹çˆ±') statusColor = '#ff6b81';
        if(p.status === 'æ–­è”') statusColor = '#333';

        return `
        <div class="partner-card" onclick="openPartnerDetail(${idx})" style="cursor:pointer; display:flex; align-items:center; padding:15px;">
            <img src="${p.avatar}" class="partner-avatar">
            <div style="flex:1;">
                <div style="font-weight:bold; font-size:14px;">${p.name} <span style="font-size:10px; background:${statusColor}; color:white; padding:2px 5px; border-radius:4px;">${p.status}</span></div>
                <div style="font-size:11px; color:#888; margin-top:3px;">${p.job} | ${p.nature}</div>
            </div>
            <div style="font-size:20px; color:#ddd;">â€º</div>
        </div>`;
    }).join('');

    container.innerHTML = `
        <div class="app-header">
            <button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>
            <span style="flex:1; text-align:center;">å§»ç¼˜ç°¿</span>
            <button class="app-header-btn" onclick="refreshPartners()">ğŸ”„</button>
        </div>
        <div class="app-content" style="background:#f7f9fc;">
            <div style="font-size:12px; color:#aaa; margin-bottom:10px; text-align:center;">ç‚¹å‡»å¤´åƒæŸ¥çœ‹è¯¦æƒ…ä¸äº’åŠ¨</div>
            ${listHtml}
        </div>
    `;
}


   

// 2. æ‰“å¼€å¯¹è±¡è¯¦æƒ…é¡µ (äº’åŠ¨æ ¸å¿ƒ)

// 2. æ‰“å¼€å¯¹è±¡è¯¦æƒ…é¡µ (ä¿®å¤è¿”å›é”®)

// 2. æ‰“å¼€å¯¹è±¡è¯¦æƒ…é¡µ (ä¿®æ”¹ç‰ˆï¼šå»é™¤æŒ‰é’®ï¼Œæ”¹ä¸ºè¯­è¨€å¹²æ¶‰)
function openPartnerDetail(idx) {
    currentPartnerIdx = idx;
    var p = currentHeir.dating.partners[idx];
    
    var win = document.getElementById('activeAppWindow');
    var detailDiv = document.createElement('div');
    detailDiv.className = 'app-window open';
    detailDiv.style.zIndex = '30';

    var progress = Math.min(100, Math.max(0, p.affinity));
    
    // æ¸²æŸ“æ—¥å¿—
    var logsHtml = (p.logs || []).slice().reverse().map(l => 
        `<div class="love-log-item"><div class="love-log-date">${l.date}</div>${l.content}</div>`
    ).join('') || '<div style="text-align:center; margin-top:20px; color:#ccc;">æš‚æ— äº’åŠ¨è®°å½•</div>';

    // åº•éƒ¨äº’åŠ¨åŒºï¼šå¦‚æœæ˜¯æ–­è”ï¼Œæ˜¾ç¤ºç°è‰²ï¼›å¦åˆ™æ˜¾ç¤ºâ€œçº¦ä¼šâ€æŒ‰é’® + â€œå¹²æ¶‰å¯¹è¯æ¡†â€
    var actionArea = "";
    
    if (p.status === 'æ–­è”') {
        actionArea = `<button class="shop-btn" style="width:100%; background:#ccc; margin-top:10px;" disabled>ğŸ’” å…³ç³»å·²ç ´è£‚ï¼Œæ— æ³•æŒ½å›</button>`;
    } else {
        actionArea = `
            <button class="shop-btn" style="width:100%; background:#ff9a9e; margin-bottom:10px;" onclick="dateWithPartner()">ğŸ’Œ æ¥è§¦/çº¦ä¼š (AIå‰§æƒ…)</button>
            
            <div style="border-top:1px dashed #eee; padding-top:10px; margin-top:5px;">
                <div style="font-size:12px; color:#d66a80; margin-bottom:5px; font-weight:bold;">ğŸ’¬ å®¶é•¿å»ºè®® (å¹²æ¶‰)ï¼š</div>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="interveneInput" placeholder="æƒ³å¯¹çš‡å—£è¯´ä»€ä¹ˆï¼Ÿ(å¦‚:ç¦»ä»–è¿œç‚¹)" style="flex:1; border:1px solid #ffb7c5; border-radius:15px; padding:6px 10px; font-size:12px; outline:none;">
                    <button class="shop-btn" style="background:#fab1a0; width:auto; padding:6px 15px;" onclick="sendIntervention()">ğŸ—£ï¸ è¯´æ•™</button>
                </div>
            </div>
        `;
    }

    detailDiv.innerHTML = `
        <div class="app-header">
            <button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>
            <span style="flex:1; text-align:center;">${p.name}</span>
            <span style="width:20px;"></span>
        </div>
        <div class="app-content" style="padding:15px; display:flex; flex-direction:column; height:calc(100% - 50px);">
            <div class="partner-detail-header">
                <img src="${p.avatar}" class="partner-big-avatar">
                <div style="font-weight:bold; font-size:16px;">${p.name}</div>
                <div style="color:#888; font-size:12px;">${p.desc}</div>
            </div>

            <div class="love-progress-box">
                <div class="love-status-text">
                    <span>å…³ç³»ï¼š${p.status}</span>
                    <span>å¥½æ„Ÿï¼š${p.affinity}/100</span>
                </div>
                <div class="love-bar-bg"><div class="love-bar-fill" style="width:${progress}%"></div></div>
            </div>

            <div class="love-log-area" id="loveLogArea" style="flex:1; margin-bottom:10px;">${logsHtml}</div>

            <div style="margin-top:auto;">
                ${actionArea}
            </div>
        </div>
    `;
    
    win.appendChild(detailDiv);
}

// ğŸ’¬ å‘é€å®¶é•¿å¹²æ¶‰ (æ–°åŠŸèƒ½)
async function sendIntervention() {
    var text = document.getElementById('interveneInput').value.trim();
    if (!text) { auth.toast('è¯·å…ˆè¾“å…¥ä½ è¦è¯´çš„è¯'); return; }
    
    // 1. ç•Œé¢åé¦ˆ
    document.getElementById('interveneInput').value = '';
    auth.toast('ğŸ’¬ æ­£åœ¨ä¼ è¾¾å®¶é•¿çš„æ•™è¯²...');

    var p = currentHeir.dating.partners[currentPartnerIdx];
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));

    // 2. æ„å»º Prompt
    var prompt = `
    æˆ‘æ˜¯å®¶é•¿ã€‚æˆ‘å¯¹çš‡å—£è¯´ï¼šâ€œ${text}â€ã€‚
    çš‡å—£å½“å‰åœ¨å’Œ ${p.name} äº¤å¾€ (å¥½æ„Ÿ ${p.affinity})ã€‚
    çš‡å—£çš„æ€§æ ¼æ ‡ç­¾ï¼š${JSON.stringify(currentHeir.params)}ã€‚
    çš‡å—£çš„å›é€†å€¼æ˜¯ ${currentHeir.params.rebellion}ã€‚
    
    è¯·ç”Ÿæˆï¼š
    1. çš‡å—£çš„ååº”å°è¯ï¼ˆä½“ç°æ€§æ ¼ï¼‰ã€‚
    2. å¯¹è¿™æ®µå…³ç³»çš„å½±å“åˆ†æ•°ï¼ˆscoreï¼‰ã€‚
    
    é€»è¾‘å‚è€ƒï¼š
    - å¦‚æœæ˜¯åŠåˆ†ï¼Œä¸”çš‡å—£å›é€†é«˜ï¼Œå¥½æ„Ÿåè€Œå¢åŠ ï¼ˆé€†åå¿ƒç†ï¼‰ã€‚
    - å¦‚æœæ˜¯åŠåˆ†ï¼Œä¸”çš‡å—£å¬è¯ï¼ˆäº²å¯†é«˜/å›é€†ä½ï¼‰ï¼Œå¥½æ„Ÿé™ä½ã€‚
    - å¦‚æœæ˜¯æ”¯æŒ/å¤¸å¥–ï¼Œå¥½æ„Ÿå¢åŠ ã€‚
    
    æ ¼å¼ JSONï¼š{ "reply": "çš‡å—£çš„å›å˜´", "score": -5 }
    `;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        // 3. å¼¹å‡ºçš‡å—£çš„å›ç­”
        alert(`çš‡å—£å›åº”è¯´ï¼š\nâ€œ${data.reply}â€`);
        
        // 4. æ›´æ–°å¥½æ„Ÿåº¦
        p.affinity = Math.min(100, Math.max(-100, p.affinity + data.score));
        
        // 5. å†™å…¥æ—¥å¿—
        p.logs.push({ 
            date: `${currentHeir.age}å²Â·å®¶é•¿å¹²æ¶‰`, 
            content: `å®¶é•¿ï¼š"${text}"<br>çš‡å—£ï¼š"${data.reply}" (å¥½æ„Ÿ${data.score>0?'+':''}${data.score})` 
        });

        // 6. æ›´æ–°å›é€†å€¼ (å¦‚æœæ˜¯è´Ÿé¢å¹²æ¶‰)
        if (data.score < 0 || text.includes("ä¸è®¸") || text.includes("åˆ†")) {
             currentHeir.params.rebellion = Math.min(100, currentHeir.params.rebellion + 2);
        }

        // 7. åˆ·æ–°çŠ¶æ€
        updateRelationshipStatus(p);
        saveHeirData();
        
        // é‡æ–°æ‰“å¼€è¯¦æƒ…é¡µä»¥åˆ·æ–°æ˜¾ç¤º
        var oldWin = document.querySelector('.app-window.open');
        if (oldWin) oldWin.remove();
        openPartnerDetail(currentPartnerIdx);
        
    } catch(e) {
        console.error(e);
        auth.toast('âŒ æ²¡å¬æ¸…...(ç½‘ç»œé”™è¯¯)');
    }
}


// 3. ğŸ’Œ æ¥è§¦/çº¦ä¼šé€»è¾‘ (AI ç”Ÿæˆ)
async function dateWithPartner() {
    var p = currentHeir.dating.partners[currentPartnerIdx];
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ éœ€è¦ API Key æ‰èƒ½çº¦ä¼šï¼'); return; }

    auth.toast(`ğŸ’Œ çš‡å—£æ­£åœ¨å’Œ ${p.name} æ¥è§¦ä¸­...`);

    // æ„å»º Prompt
    var prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚
    ä¸»è§’ï¼šçš‡å—£ï¼ˆ${currentHeir.age}å²ï¼Œæ€§æ ¼ï¼š${JSON.stringify(currentHeir.params)}ï¼‰ã€‚
    å¯¹è±¡ï¼š${p.name}ï¼ˆèº«ä»½ï¼š${p.job}ï¼Œæ€§æ ¼ï¼š${p.desc}ï¼‰ã€‚
    å½“å‰å…³ç³»ï¼š${p.status} (å¥½æ„Ÿ ${p.affinity})ã€‚
    
    è¯·ç”Ÿæˆä¸€æ®µä¸¤äººäº’åŠ¨çš„ç®€çŸ­å‰§æƒ…ï¼ˆ50å­—å·¦å³ï¼‰ã€‚
    å¹¶æ ¹æ®äº’åŠ¨æƒ…å†µï¼Œåˆ¤æ–­å¥½æ„Ÿåº¦å˜åŒ–ï¼ˆ-10 åˆ° +10ï¼‰ã€‚
    
    æ ¼å¼ JSONï¼š{ "story": "å‰§æƒ…å†…å®¹", "score": 5 }
    `;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        // æ›´æ–°æ•°æ®
        p.affinity += data.score;
        p.logs.push({ date: `${currentHeir.age}å²Â·${currentHeir.season}`, content: data.story });
        
        // çŠ¶æ€åˆ¤å®šé€»è¾‘
        updateRelationshipStatus(p);
        
        saveHeirData();
        
        // åˆ·æ–°é¡µé¢
        document.querySelector('.app-window.open').remove(); // å…³æ‰æ—§è¯¦æƒ…é¡µ
        openPartnerDetail(currentPartnerIdx); // é‡æ–°æ‰“å¼€åˆ·æ–°
        
        auth.toast(data.score >= 0 ? 'ğŸ’– æ„Ÿæƒ…å‡æ¸©äº†ï¼' : 'ğŸ’” å‘ç”Ÿäº†ä¸€äº›ä¸æ„‰å¿«...');
        
    } catch(e) { console.error(e); auth.toast('âŒ çº¦ä¼šå¤±è´¥'); }
}

// 4. ğŸ’¬ å®¶é•¿å¹²æ¶‰é€»è¾‘
async function parentIntervene() {
    var p = currentHeir.dating.partners[currentPartnerIdx];
    var text = prompt(`ä½ æƒ³å¯¹çš‡å—£è¯´ä»€ä¹ˆï¼Ÿ\n(ä¾‹å¦‚ï¼š"ç¦»ä»–è¿œç‚¹ï¼Œä»–æ˜¯åäºº" æˆ– "è¿™å­©å­ä¸é”™ï¼Œå¤šæ¥è§¦")`);
    
    if (!text) return;
    
    auth.toast('ğŸ’¬ æ­£åœ¨å¯¹çš‡å—£è¿›è¡Œè¯´æ•™...');
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var prompt = `
    æˆ‘æ˜¯å®¶é•¿ã€‚æˆ‘å¯¹çš‡å—£è¯´ï¼šâ€œ${text}â€ã€‚
    çš‡å—£å½“å‰åœ¨å’Œ ${p.name} äº¤å¾€ (å¥½æ„Ÿ ${p.affinity})ã€‚
    çš‡å—£çš„å›é€†å€¼æ˜¯ ${currentHeir.params.rebellion}ã€‚
    
    è¯·ç”Ÿæˆçš‡å—£çš„ååº”ã€‚
    å¹¶åˆ¤æ–­å¯¹è¿™æ®µå…³ç³»çš„å½±å“ï¼ˆå¦‚æœæ˜¯åŠåˆ†ï¼Œä¸”çš‡å—£å›é€†é«˜ï¼Œå¥½æ„Ÿåè€Œå¯èƒ½å¢åŠ ï¼›å¦‚æœæ˜¯åŠåˆï¼Œä¹Ÿçœ‹æ€§æ ¼ï¼‰ã€‚
    
    æ ¼å¼ JSONï¼š{ "reply": "çš‡å—£çš„å›å˜´", "score": -5 }
    `;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        alert(`çš‡å—£è¯´ï¼š\nâ€œ${data.reply}â€`);
        
        // æ›´æ–°æ•°æ®
        p.affinity += data.score;
        // å¦‚æœæ˜¯è´Ÿé¢å¹²æ¶‰ï¼Œå¢åŠ å›é€†
        if (data.score < 0) currentHeir.params.rebellion += 5;
        
        updateRelationshipStatus(p);
        saveHeirData();
        
        // åˆ·æ–°
        document.querySelector('.app-window.open').remove();
        openPartnerDetail(currentPartnerIdx);
        
    } catch(e) {}
}

// 5. çŠ¶æ€åˆ¤å®šæœº
function updateRelationshipStatus(p) {
    if (p.affinity <= -20) {
        p.status = "æ–­è”"; // åˆ†æ‰‹/ç»äº¤
        p.logs.push({ date: "ç³»ç»Ÿ", content: "ğŸ’” å…³ç³»ç ´è£‚ï¼Œä»æ­¤é™Œè·¯ã€‚" });
    } else if (p.affinity < 20) {
        p.status = "ç›¸è¯†";
    } else if (p.affinity < 60) {
        p.status = "æš§æ˜§";
    } else if (p.affinity < 90) {
        p.status = "æ‹çˆ±";
    } else {
        p.status = "çƒ­æ‹";
    }
}

// åˆ·æ–°å…¨éƒ¨é€»è¾‘ (ä¿ç•™)
async function refreshPartners() {
    document.querySelector('.app-content').innerHTML = '<div style="text-align:center; padding:50px;">ğŸ’˜ æ­£åœ¨é‡æ–°å¯»è§…...</div>';
    await generatePartners();
    openApp('matchmaker');
}


// ================= ğŸ•µï¸ ç›‘æŠ¤äºº (å·çœ‹æ—¥è®°) =================

function renderSpywareApp(container) {
    // æ²¡æ—¥è®°ç”Ÿæˆä¸€æ¡
    if (!currentHeir.diary || currentHeir.diary.length === 0) {
        currentHeir.diary.push({ date: "æ˜¨æ—¥", content: "ä»Šå¤©å®¶é•¿åˆé€¼æˆ‘å­¦ä¹ äº†ï¼Œå¥½çƒ¦å•Š..." });
    }

    var listHtml = currentHeir.diary.slice().reverse().map(d => `
        <div class="diary-paper" style="background:#fffbf0; padding:12px; margin-bottom:10px; border-radius:6px; border-left:3px solid #ffb7c5; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <div style="font-size:12px; color:#999; border-bottom:1px dashed #ccc; margin-bottom:5px;">${d.date}</div>
            <div style="font-size:13px; color:#555; line-height:1.5;">${d.content}</div>
        </div>
    `).join('');

    container.innerHTML = `
        <div class="app-header">
            <button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>
            <span>ç›‘æŠ¤äºº Pro</span>
            <span></span>
        </div>
        <div class="app-content" style="background:#f0f0f0;">
            <div style="font-size:12px; color:#666; margin-bottom:10px;">ğŸ“Š æ­£åœ¨åŒæ­¥çš‡å—£è®¾å¤‡æ•°æ®...</div>
            <div style="font-weight:bold; margin-bottom:5px; color:#333;">ğŸ“– ç§å¯†æ—¥è®°æœ¬ (å·²ç ´è§£)</div>
            ${listHtml}
        </div>
    `;
}

// ================= ğŸ›ï¸ å•†åº— & ç‰©å“è¯¦æƒ… (å¸¦æƒ³æ³•) =================

async function openShopApp(type, title) {
    var win = document.getElementById('activeAppWindow'); win.innerHTML = '';
    var appDiv = document.createElement('div'); appDiv.className = 'app-window';
    var items = currentHeir.phoneData.shops[type] || [];
    
    appDiv.innerHTML = `
        <div class="app-header">
            <button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>
            <span>${title}</span>
            <button class="app-header-btn" onclick="refreshShopItems('${type}', '${title}')">ğŸ”„</button>
        </div>
        <div class="app-content" id="shopContent-${type}">
            ${items.length === 0 ? '<div style="text-align:center; padding:50px; color:#999;">æš‚æ— å•†å“<br>ç‚¹å‡»å³ä¸Šè§’è¿›è´§</div>' : renderShopList(items, type)}
        </div>
        <div id="itemDetailModal" class="item-detail-overlay"></div>
    `;
    win.appendChild(appDiv);
    requestAnimationFrame(() => appDiv.classList.add('open'));
    
    if(items.length === 0) refreshShopItems(type, title);
}

// ğŸ“œ æ¸²æŸ“å•†å“åˆ—è¡¨ (å±•ç¤º AI ç”Ÿæˆçš„æƒ³æ³•)
function renderShopList(items, type) {
    return items.map((item, idx) => {
        // å¦‚æœæ˜¯è€æ•°æ®æ²¡æœ‰ heirThoughtï¼Œå°±ç»™ä¸ªé»˜è®¤å€¼
        var thought = item.heirThought || "è¿™ä¸ªçœ‹èµ·æ¥ä¸é”™ã€‚";
        var stars = item.preference || "â­â­â­";

        return `
        <div class="shop-item" onclick="showItemDetail('${type}', ${idx})" style="background:white;padding:10px;margin-bottom:10px;border-radius:10px;border:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">
            <div style="flex:1;">
                <div style="font-weight:bold; font-size:13px;">${item.name} ${item.icon||'ğŸ“¦'}</div>
                <div style="font-size:10px; color:#999; margin-bottom:4px;">${item.effectDesc}</div>
                
                <div class="heir-thought" style="background:#fff0f5; color:#d66a80; font-size:10px; padding:4px 8px; border-radius:8px; margin-top:5px; position:relative; font-style:italic;">
                    ğŸ’­ ${thought} <span style="float:right; font-style:normal;">${stars}</span>
                </div>
            </div>
            <button class="shop-btn" style="background:#74b9ff; color:white; border:none; padding:5px 10px; border-radius:15px; cursor:pointer; margin-left:10px;" onclick="event.stopPropagation(); buyAIItem('${type}', ${idx})">è´­ä¹°</button>
        </div>`;
    }).join('');
}


// ğŸ§  çš‡å—£å¯¹ç‰©å“çš„æƒ³æ³• (å¢å¼ºç‰ˆï¼šè¯†åˆ«å…³é”®è¯+éšæœºåæ§½)
function getHeirThought(name, type) {
    // è¾…åŠ©ï¼šä»æ•°ç»„é‡Œéšæœºé€‰ä¸€å¥
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];
    
    // ğŸ¥ 1. åŒ»é™¢ (å¤ªåŒ»å±€)
    if (type === 'hospital') {
        // å¦‚æœæ²¡ç—…
        if (!currentHeir.body.sick) {
            return pick(["èº«ä½“å€å„¿æ£’ï¼Œä¸éœ€è¦è¿™ä¸ªã€‚", "è™½ç„¶æ²¡ç—…ï¼Œå¤‡ç€ä¹Ÿå¥½ï¼Ÿ", "çœ‹ç€å°±è‹¦...", "å¤ªåŒ»å±€çš„ä¸œè¥¿å¥½è´µã€‚", "ç»™çˆ¶å›ç•™ç€ï¼Ÿ"]);
        }
        // å¦‚æœç”Ÿç—…äº†ï¼Œæ ¹æ®è¯ååæ§½
        if (name.includes('é’ˆ') || name.includes('åˆº')) return pick(["å‘œ...æ€•ç–¼...", "èƒ½ä¸èƒ½ä¸æ‰é’ˆï¼Ÿ", "çœ‹ç€å¥½å°–é”..."]);
        if (name.includes('æ±¤') || name.includes('è¯')) return pick(["é—»ç€å°±å¥½è‹¦...", "ä¸€å®šè¦å–å—ï¼Ÿ", "è‰¯è¯è‹¦å£...å‘•...", "èƒ½åŠ ç‚¹ç³–å—ï¼Ÿ"]);
        if (name.includes('ä¸¹') || name.includes('ä¸¸')) return pick(["è¿™é¢—èƒ½æ²»å¥½æˆ‘å—ï¼Ÿ", "ä¸€å£åæ‰ï¼", "åƒç³–è±†ï¼Œä½†è‚¯å®šä¸å¥½åƒã€‚"]);
        if (name.includes('æ²»æ„ˆ') || name.includes('å›æ˜¥')) return pick(["æ•‘å‘½ç¨»è‰...", "å¸Œæœ›èƒ½å¿«ç‚¹å¥½èµ·æ¥ã€‚", "ä¸æƒ³å†èººç€äº†..."]);
        
        // é»˜è®¤ç”Ÿç—…ååº”
        return pick(["éš¾å—...", "å¤´å¥½æ™•...", "æƒ³æ¯çš‡äº†...", "ä»€ä¹ˆæ—¶å€™èƒ½å¥½å•Š..."]);
    }
    
    // ğŸ± 2. å¤–å– (å¾¡è†³æˆ¿)
    if (type === 'meituan') {
        if (currentHeir.body.waste > 80) return "é¥¿å¾—èƒ½åƒä¸‹ä¸€å¤´ç‰›ï¼";
        if (name.includes('è¾£')) return pick(["çœ‹ç€å°±å¥½çˆ½ï¼", "å˜¶å“ˆ...æ„Ÿè§‰ä¼šå¾ˆè¾£ï¼"]);
        if (name.includes('ç”œ') || name.includes('ç³–') || name.includes('å¥¶')) return pick(["ç”œé£Ÿæ˜¯è£…åœ¨å¦ä¸€ä¸ªèƒƒé‡Œçš„ï¼", "çœ‹ç€å¥½å¹¸ç¦~"]);
        if (name.includes('è‹¦') || name.includes('å‡‰')) return "è¿™ä¸ª...å¥½åƒå—ï¼Ÿ";
        return pick(["çœ‹èµ·æ¥å¥½å¥½åƒï¼", "æµå£æ°´äº†...", "å¾¡è†³æˆ¿çš„æ‰‹è‰ºçœŸä¸é”™ã€‚", "æƒ³åƒï¼"]);
    }

    // ğŸ›ï¸ 3. å•†åº— (çå®é˜)
    if (type === 'shop') {
        // ä¹¦ç±ç±»ï¼šçœ‹å‹¤å‹‰å±æ€§
        if (name.includes('ä¹¦') || name.includes('ç»') || name.includes('ç±')) {
            return currentHeir.params.diligence > 60 ? 
                pick(["ä¹¦é¦™é—¨ç¬¬ï¼Œæ­£åˆæˆ‘æ„ã€‚", "è¿™æœ¬ä¹¦æˆ‘æ‰¾äº†å¥½ä¹…ï¼", "ä¸€æ—¥ä¸è¯»ä¹¦ï¼Œé¢ç›®å¯æ†ã€‚"]) : 
                pick(["å•Š...åˆè¦çœ‹ä¹¦å•Š...", "çœ‹ç€å°±å›°...", "èƒ½ä¸èƒ½ä¹°ç©å…·ï¼Ÿ"]);
        }
        // æ­¦å™¨/è¿åŠ¨ç±»ï¼šçœ‹æ€§åˆ«æˆ–ä½“é­„
        if (name.includes('å‰‘') || name.includes('æ­¦') || name.includes('å¼“')) {
            return (currentHeir.gender === 'ç”·' || currentHeir.params.rebellion > 50) ? 
                "é…·ï¼æˆ‘æƒ³è€è€ï¼" : "ç¨å¾®æœ‰ç‚¹é‡å‘¢...";
        }
        // ç©å…·ç±»
        if (name.includes('ç©') || name.includes('å¶') || name.includes('çƒ')) {
            return pick(["æƒ³è¦è¿™ä¸ªï¼", "çœ‹ç€å¥½ç©ï¼", "ä¹°ç»™æˆ‘å˜›~"]);
        }
        // é»˜è®¤
        return pick(["è¿™ä¸ªæœ‰ç‚¹æ„æ€ã€‚", "ä¹°ä¹°ä¹°ï¼", "ç¨å¾®æœ‰ç‚¹è´µå‘¢...", "è¿™æ˜¯ä»€ä¹ˆï¼Ÿ"]);
    }

    return "è¿™ä¸ªçœ‹èµ·æ¥ä¸é”™ã€‚";
}


// ğŸ›ï¸ å•†åº—è¿›è´§ (AI ç”Ÿæˆç‰©å“ + çš‡å—£æƒ³æ³• + å–œçˆ±åº¦)
async function refreshShopItems(type, title) {
    var div = document.getElementById(`shopContent-${type}`);
    div.innerHTML = '<div style="text-align:center;padding:20px;">ğŸ¤– æ­£åœ¨æ ¹æ®çš‡å—£çš„å–œå¥½è¿›è´§...</div>';
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { div.innerHTML = 'ğŸš« æ²¡ API Key'; return; }

    // æ„å»ºæ›´è¯¦ç»†çš„ Promptï¼ŒæŠŠçš‡å—£çš„æ€§æ ¼å‘Šè¯‰ AI
    var prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚ç°åœ¨éœ€è¦ä¸ºçš‡å—£ï¼ˆæ€§æ ¼ï¼š${JSON.stringify(currentHeir.params)}ï¼Œå¹´é¾„ï¼š${currentHeir.age}å²ï¼Œæ€§åˆ«ï¼š${currentHeir.gender}ï¼ŒçŠ¶æ€ï¼š${currentHeir.body.sick?'ç”Ÿç—…':'å¥åº·'}ï¼‰ç”Ÿæˆ 3 ä¸ªã€${title}ã€‘é‡Œçš„å•†å“ã€‚

    è¯·è¿”å› JSON æ•°ç»„ï¼Œæ¯ä¸ªå•†å“åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
    - name: å•†å“åç§°
    - icon: emojiå›¾æ ‡
    - effectDesc: åŠŸæ•ˆç®€è¿° (å¦‚: å¥åº·+20 / å¿ƒæƒ…+15)
    - detail: ç‰©å“çš„è¯¦ç»†ä»‹ç» (50å­—ä»¥å†…)
    - heirThought: çš‡å—£çœ‹åˆ°è¿™ä¸ªä¸œè¥¿çš„ç¬¬ä¸€ååº”/å†…å¿ƒåæ§½ (ä¸€å®šè¦ç¬¦åˆTaçš„æ€§æ ¼ï¼æ¯”å¦‚å‚²å¨‡çš„è¦å£æ˜¯å¿ƒéï¼Œè´ªåƒçš„è¦æµå£æ°´ï¼Œç”Ÿç—…è¦è¯´éš¾å—)
    - preference: çš‡å—£çš„å–œçˆ±ç¨‹åº¦ (è¯·ç›´æ¥è¿”å›æ˜Ÿæ˜Ÿç¬¦å·ï¼Œå¦‚ "â­â­â­â­" æˆ– "â­")
    `;
    
    try {
        var res = await fetchAI(prompt, config);
        // æ¸…ç† AI å¯èƒ½è¿”å›çš„ Markdown æ ¼å¼
        var jsonStr = res.replace(/```json/g,'').replace(/```/g,'').trim();
        var newItems = JSON.parse(jsonStr);
        
        // å­˜å…¥æ‰‹æœºæ•°æ®
        currentHeir.phoneData.shops[type] = newItems;
        saveHeirData();
        
        // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤º
        div.innerHTML = renderShopList(newItems, type);
    } catch(e) { 
        console.error(e);
        div.innerHTML = 'âŒ è¿›è´§å¤±è´¥ (AI æ ¼å¼é”™è¯¯)'; 
    }
}


function showItemDetail(type, idx) {
    var item = currentHeir.phoneData.shops[type][idx];
    var overlay = document.getElementById('itemDetailModal');
    overlay.innerHTML = `
        <button class="app-header-btn" style="align-self:flex-end;" onclick="document.getElementById('itemDetailModal').classList.remove('show')">Ã—</button>
        <div class="item-big-icon">${item.icon}</div>
        <h2 style="text-align:center; color:#d66a80;">${item.name}</h2>
        <div style="text-align:center; color:#999; margin-bottom:20px;">${item.effectDesc}</div>
        <div style="background:#f9f9f9; padding:15px; border-radius:15px; font-size:13px; color:#555; line-height:1.6;">
            ${item.detail || "æš‚æ— è¯¦ç»†ä»‹ç»..."}
        </div>
        <button class="shop-btn" style="width:100%; margin-top:20px; background:#74b9ff;" onclick="buyAIItem('${type}', ${idx}); document.getElementById('itemDetailModal').classList.remove('show')">ç«‹å³è´­ä¹°ä½¿ç”¨</button>
    `;
    requestAnimationFrame(() => overlay.classList.add('show'));
}

// ğŸ’° è´­ä¹°/ä½¿ç”¨ç‰©å“ (ä¿®å¤ç‰ˆï¼šå¤ªåŒ»å±€åŒ…æ²»ç™¾ç—…)
function buyAIItem(type, idx) {
    // è·å–å•†å“ä¿¡æ¯
    var item = currentHeir.phoneData.shops[type][idx];
    
    // ğŸ¥ 1. å¤ªåŒ»å±€ (åŒ»é™¢) é€»è¾‘ä¿®å¤
    if (type === 'hospital') {
        // åªè¦æ˜¯åŒ»é™¢ä¹°çš„ï¼Œç›´æ¥ç—Šæ„ˆï¼ä¸çœ‹åå­—äº†ï¼
        currentHeir.body.sick = false;  // ç§»é™¤ç”Ÿç—…çŠ¶æ€
        currentHeir.body.health = 100;  // å¥åº·å€¼å›æ»¡
        auth.toast(`ğŸ’Š è¯åˆ°ç—…é™¤ï¼${currentHeir.name} èº«ä½“ç—Šæ„ˆäº†ï¼`);
    }
    
    // ğŸ›ï¸ 2. çå®é˜ (å•†åº—)
    if (type === 'shop') {
        currentHeir.mood = Math.min(100, currentHeir.mood + 20); // åŠ å¿ƒæƒ…
        // å¦‚æœæ˜¯ä¹¦ï¼Œé¢å¤–åŠ æ™ºæ…§
        if (item.name.includes('ä¹¦') || item.name.includes('ç»')) {
            currentHeir.params.wisdom = Math.min(100, currentHeir.params.wisdom + 5);
            auth.toast(`ğŸ“š è¯»äº†ä¹¦ï¼Œæ™ºæ…§ +5`);
        } else {
            auth.toast(`âœ¨ å¿ƒæƒ…å˜å¥½äº†ï¼`);
        }
    }
    
    // ğŸ± 3. å¾¡è†³æˆ¿ (å¤–å–)
    if (type === 'meituan') {
        currentHeir.body.waste = Math.max(0, currentHeir.body.waste - 40); // å¤§å¹…æ¶ˆé™¤ç–²åŠ³
        auth.toast(`ğŸ± åƒé¥±å–è¶³ï¼Œç–²åŠ³æ¶ˆé™¤äº†ï¼`);
    }
    
    // ä¿å­˜æ•°æ®
    saveHeirData();
    
    // ğŸ”¥ å…³é”®ï¼šç«‹å³åˆ·æ–°ä¸»ç•Œé¢
    // è¿™æ ·å¦‚æœä¹‹å‰æ˜¯ç”Ÿç—…ç«‹ç»˜(yawn)ï¼Œç°åœ¨ä¼šé©¬ä¸Šå˜å›æ­£å¸¸ç«‹ç»˜(idle)
    openEastPalace(); 
}


// ğŸ’¬ 5. å¾®èŠé˜²éªšæ‰°è¡¥ä¸ (è¯·æŠŠè¿™ä¸ªå‡½æ•°è¦†ç›–æ‰)
function openChatDetail(role, name) {
    // ... (å‰éƒ¨åˆ†æ¸²æŸ“ä»£ç ä¿æŒä¸å˜ï¼Œå‚è€ƒä¸Šæ–‡ openChatDetail) ...
    
    // åˆå§‹åŒ–æ•°æ®
    if(!currentHeir.phoneData.chats[role]) currentHeir.phoneData.chats[role] = { msgs: [], lastSender: 'ai' };
    var chatData = currentHeir.phoneData.chats[role];
    
    // ... æ¸²æŸ“èŠå¤©æ¡† DOM ...
    // (ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œå‡è®¾ DOM å·²ç»å»ºå¥½ï¼Œé‡ç‚¹åœ¨ä¸‹é¢çš„é€»è¾‘)

    // ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šåªæœ‰å½“æœ€åä¸€æ¡æ˜¯æˆ‘å‘çš„(user)ï¼Œæˆ–è€…æ²¡è®°å½•æ—¶ï¼Œå¯¹æ–¹æ‰è¯´è¯
    // å¦‚æœæœ€åä¸€æ¡æ˜¯ AI å‘çš„(ai)ï¼Œä»–ä¼šç­‰ä½ ï¼Œç»å¯¹ä¸å‘ç¬¬äºŒæ¡éªšæ‰°ä½ ã€‚
    if (chatData.msgs.length === 0 || chatData.lastSender === 'user') {
        setTimeout(() => triggerPhoneReply(role, "INIT"), 1000);
    }
}

// ================= ğŸ’¬ å¾®èŠé€»è¾‘ (æ ¸å¿ƒæ–°å¢) =================

function renderWeChat(container) {
    // 1. è·å–çˆ¶å›çš„åå­—å’Œå¤´åƒ
    var fatherName = currentHeir.fatherName || "çˆ¶å›";
    var fatherAvatar = "https://files.catbox.moe/kp648j.jpeg"; // é»˜è®¤å¤´åƒ
    
    // å°è¯•åœ¨ç‰©å“åº“é‡Œæ‰¾åˆ°çˆ¶äº²ï¼Œè·å–ä»–çš„çœŸå®å¤´åƒ
    var fatherItem = items.find(i => i.name === fatherName);
    if (fatherItem) {
        var imgs = fatherItem.resources.filter(r => r.type === 'image');
        if (imgs.length > 0) fatherAvatar = imgs[Math.min(fatherItem.coverIndex||0, imgs.length-1)].content;
    }

    container.innerHTML = `
        <div class="app-header" style="background:#ededed; border-bottom:1px solid #dcdcdc;">
            <span class="app-back" onclick="this.parentElement.parentElement.remove()" style="color:#333;">â€¹ å¾®ä¿¡(3)</span>
            å¾®èŠ
        </div>
        <div class="app-content" style="padding:0; background:#fff;">
            
            <div class="chat-list-item" onclick="openChatDetail('father', '${fatherName}', '${fatherAvatar}')">
                <img src="${fatherAvatar}" class="chat-avatar">
                <div class="chat-info">
                    <div class="chat-name">${fatherName}</div>
                    <div class="chat-desc">[åœ¨çº¿] ä»Šå¤©çš„æŠ˜å­æ‰¹å®Œäº†å—ï¼Ÿ</div>
                </div>
            </div>

            <div class="chat-list-item" onclick="openChatDetail('eunuch', 'å°å¾·å­', 'https://files.catbox.moe/fv8f8p.gif')">
                <img src="https://files.catbox.moe/fv8f8p.gif" class="chat-avatar" style="background:#eee;">
                <div class="chat-info">
                    <div class="chat-name">å°å¾·å­ (æ€»ç®¡)</div>
                    <div class="chat-desc">å¥´æ‰éšæ—¶å¬å€™å·®é£...</div>
                </div>
            </div>

            <div class="chat-list-item" onclick="openChatDetail('nanny', 'æŒäº‹å§‘å§‘', 'https://files.catbox.moe/4hxxkv.gif')">
                <img src="https://files.catbox.moe/4hxxkv.gif" class="chat-avatar" style="background:#eee;">
                <div class="chat-info">
                    <div class="chat-name">æŒäº‹å§‘å§‘ (ä¿å§†)</div>
                    <div class="chat-desc">å°æ®¿ä¸‹ä»Šå¤©åƒäº†ä¸€ç¢—è›‹ç¾¹...</div>
                </div>
            </div>

        </div>
    `;
}

// æ‰“å¼€èŠå¤©è¯¦æƒ…é¡µ
var currentChatRole = null;
function openChatDetail(role, name, avatar) {
    currentChatRole = role; // è®°å½•å½“å‰åœ¨å’Œè°èŠ
    
    // åˆ›å»ºä¸€ä¸ªæ–°çš„å­çª—å£è¦†ç›–åœ¨åˆ—è¡¨ä¸Š
    var detailDiv = document.createElement('div');
    detailDiv.className = 'app-window open'; // ç›´æ¥æ˜¾ç¤º
    detailDiv.style.zIndex = '20';
    
    detailDiv.innerHTML = `
        <div class="app-header" style="background:#ededed;">
            <span class="app-back" onclick="this.parentElement.parentElement.remove()" style="color:#333;">â€¹</span>
            ${name}
        </div>
        <div id="phoneChatBox" class="phone-chat-box">
            <div style="text-align:center; color:#ccc; font-size:10px; margin-top:10px;">â€”â€” ç°åœ¨å¯ä»¥å¼€å§‹èŠå¤©äº† â€”â€”</div>
        </div>
        <div style="padding:10px; background:#f5f5f5; border-top:1px solid #ddd; display:flex; gap:8px;">
            <input type="text" id="phoneChatInput" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:5px; outline:none;" placeholder="å‘æ¶ˆæ¯..." onkeydown="if(event.key==='Enter') sendPhoneMsg()">
            <button onclick="sendPhoneMsg()" style="background:#07c160; color:white; border:none; padding:0 12px; border-radius:5px; font-weight:bold;">å‘é€</button>
        </div>
    `;
    
    document.getElementById('activeAppWindow').appendChild(detailDiv);
    
    // è§¦å‘ç¬¬ä¸€å¥é—®å€™
    triggerPhoneGreeting(role, name);
}

// æ‰‹æœºå‘æ¶ˆæ¯é€»è¾‘
async function sendPhoneMsg() {
    var input = document.getElementById('phoneChatInput');
    var text = input.value.trim();
    if (!text) return;

    // ä¸Šå±
    appendPhoneMsg('right', text);
    input.value = '';

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { appendPhoneMsg('left', 'ï¼ˆå¯¹æ–¹ä¿¡å·ä¸å¥½ï¼Œè¯·æ£€æŸ¥ API Keyï¼‰'); return; }

    // æ„å»º Prompt
    var roleDesc = "";
    if (currentChatRole === 'father') roleDesc = `ä½ æ˜¯çš‡å—£çš„çˆ¶äº²ã€${currentHeir.fatherName}ã€‘ï¼Œæ€§æ ¼å‚²å¨‡æˆ–æ·±æƒ…ã€‚`;
    else if (currentChatRole === 'eunuch') roleDesc = `ä½ æ˜¯å¤ªç›‘æ€»ç®¡ã€å°å¾·å­ã€‘ï¼Œå‘å¾®ã€ç‹—è…¿ã€å¿ è¯šã€‚`;
    else if (currentChatRole === 'nanny') roleDesc = `ä½ æ˜¯ç…§é¡¾çš‡å—£çš„ã€æŒäº‹å§‘å§‘ã€‘ï¼Œæ…ˆç¥¥ã€å” å¨ã€å…³æ³¨å­©å­å¥åº·ã€‚`;

    var prompt = `
    ã€çŸ­ä¿¡èŠå¤©æ¨¡å¼ã€‘
    ${roleDesc}
    
    è°ˆè¯å¯¹è±¡ï¼šå¥³çš‡é™›ä¸‹ï¼ˆç”¨æˆ·ï¼‰ã€‚
    ç›¸å…³çš‡å—£ï¼š${currentHeir.name} (${currentHeir.age}å², çŠ¶æ€:${currentHeir.body.sick?'ç”Ÿç—…':'å¥åº·'})ã€‚
    
    ç”¨æˆ·å‘æ¥å¾®ä¿¡ï¼š"${text}"
    
    è¯·å›å¤çŸ­ä¿¡å†…å®¹ï¼ˆç®€çŸ­ï¼Œå£è¯­åŒ–ï¼Œä¸è¦åŠ¨ä½œæå†™ï¼‰ã€‚
    `;

    try {
        var res = await fetchAI(prompt, config);
        // æ¨¡æ‹Ÿå»¶è¿Ÿ
        setTimeout(() => {
            appendPhoneMsg('left', res);
        }, 1000);
    } catch(e) {
        appendPhoneMsg('left', 'ï¼ˆå‘é€å¤±è´¥...ï¼‰');
    }
}

// è‡ªåŠ¨è§¦å‘å¼€åœºç™½
async function triggerPhoneGreeting(role, name) {
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) return;

    var prompt = "";
    if (role === 'father') prompt = `ä½ æ˜¯${name}ï¼Œå¥³çš‡çš„ç”·å® ï¼Œå­©å­çš„çˆ¶äº²ã€‚å­©å­${currentHeir.age}å²äº†ã€‚è¯·ç»™å¥³çš‡å‘ä¸€æ¡å¾®ä¿¡ï¼Œé—®é—®å­©å­çš„æƒ…å†µï¼Œæˆ–è€…æ’’ä¸ªå¨‡ã€‚`;
    else if (role === 'eunuch') prompt = `ä½ æ˜¯å°å¾·å­ã€‚è¯·ç»™å¥³çš‡å‘å¾®ä¿¡ï¼Œè¯·å®‰ï¼Œå¹¶æ±‡æŠ¥ä»Šå¤©å®«é‡Œå¹³å®‰æ— äº‹ã€‚`;
    else if (role === 'nanny') prompt = `ä½ æ˜¯æŒäº‹å§‘å§‘ã€‚è¯·ç»™å¥³çš‡å‘å¾®ä¿¡ï¼Œæ±‡æŠ¥çš‡å—£${currentHeir.name}ä»Šå¤©çš„åƒé¥­/ç¡è§‰æƒ…å†µã€‚`;

    try {
        var res = await fetchAI(prompt, config);
        appendPhoneMsg('left', res);
    } catch(e) {}
}

function appendPhoneMsg(side, text) {
    var box = document.getElementById('phoneChatBox');
    if (!box) return;
    var div = document.createElement('div');
    div.className = `phone-msg ${side}`;
    div.innerText = text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

// ================= ğŸ¥ å…¶ä»– APP æ¸²æŸ“é€»è¾‘ =================

function renderHospital(container) {
    container.innerHTML = `
        <div class="app-header"><span class="app-back" onclick="this.parentElement.parentElement.remove()">â€¹</span>å¤ªåŒ»å±€åœ¨çº¿</div>
        <div class="app-content">
            <div style="padding:15px; background:#fff0f0; border-radius:10px; margin-bottom:15px; text-align:center; color:#d63031; border:1px solid #ffcccc;">
                <div style="font-size:30px; margin-bottom:5px;">${currentHeir.body.sick ? 'ğŸ˜·' : 'ğŸ˜Š'}</div>
                <div style="font-weight:bold;">${currentHeir.name} çš„ç—…å†</div>
                <div style="font-size:12px; margin-top:5px;">å¥åº·å€¼: ${currentHeir.body.health}%</div>
                <div style="font-size:12px;">çŠ¶æ€: ${currentHeir.body.sick ? 'æ‚£ç—…ä¸­ (éœ€æ²»ç–—)' : 'èº«ä½“å¥åº·'}</div>
            </div>
            
            <div style="font-size:12px; color:#999; margin-bottom:5px; margin-left:5px;">ä¸“å®¶å·</div>
            
            <div class="shop-item">
                <div>
                    <div style="font-weight:bold;">ğŸ’Š å›æ˜¥ä¸¹ (æ²»æ„ˆç”Ÿç—…)</div>
                    <div style="font-size:10px; color:#999;">å¤ªåŒ»é™¢ç§˜åˆ¶ï¼ŒåŒ…æ²»ç™¾ç—…</div>
                </div>
                <button class="shop-btn hospital" onclick="buyItem('cure')">é—®è¯Š</button>
            </div>
            
            <div class="shop-item">
                <div>
                    <div style="font-weight:bold;">ğŸ’‰ å¼ºèº«æ±¤ (å¥åº·+20)</div>
                    <div style="font-size:10px; color:#999;">äººå‚é¹¿èŒ¸ç†¬åˆ¶</div>
                </div>
                <button class="shop-btn hospital" onclick="buyItem('heal')">å¼€è¯</button>
            </div>
        </div>
    `;
}

function renderShop(container) {
    container.innerHTML = `
        <div class="app-header"><span class="app-back" onclick="this.parentElement.parentElement.remove()">â€¹</span>çå®é˜</div>
        <div class="app-content">
            <div class="shop-item">
                <div>ğŸ§¸ <b>å¸ƒè€è™</b> <span style="color:#aaa;font-size:10px;">å¿ƒæƒ…+10</span></div>
                <button class="shop-btn" onclick="buyItem('toy')">è´­ä¹°</button>
            </div>
            <div class="shop-item">
                <div>ğŸ“š <b>å››ä¹¦äº”ç»</b> <span style="color:#aaa;font-size:10px;">æ™ºæ…§+5</span></div>
                <button class="shop-btn" onclick="buyItem('book')">è´­ä¹°</button>
            </div>
            <div class="shop-item">
                <div>âš”ï¸ <b>æ¡ƒæœ¨å‰‘</b> <span style="color:#aaa;font-size:10px;">ä½“é­„+5</span></div>
                <button class="shop-btn" onclick="buyItem('sword')">è´­ä¹°</button>
            </div>
        </div>
    `;
}

function renderMeituan(container) {
    container.innerHTML = `
        <div class="app-header"><span class="app-back" onclick="this.parentElement.parentElement.remove()">â€¹</span>å¾¡è†³æˆ¿å¤–å–</div>
        <div class="app-content">
            <div style="background:#fff7e6; padding:10px; font-size:12px; color:#d46b08; border-radius:8px; margin-bottom:15px;">
                ğŸ¥¡ åªæœ‰åƒé¥±äº†ï¼Œæ‰èƒ½æ¶ˆé™¤ç–²åŠ³(åºŸå“å€¼)å“¦ï¼
            </div>
            
            <div class="shop-item">
                <div>ğŸ¥¤ <b>å†°é•‡é…¸æ¢…æ±¤</b> <span style="color:#aaa;font-size:10px;">åºŸå“-10</span></div>
                <button class="shop-btn food" onclick="buyItem('tea')">ä¸‹å•</button>
            </div>
            <div class="shop-item">
                <div>ğŸ² <b>æ»¡æ±‰å…¨å¸­(å•äºº)</b> <span style="color:#aaa;font-size:10px;">åºŸå“-30</span></div>
                <button class="shop-btn food" onclick="buyItem('hotpot')">ä¸‹å•</button>
            </div>
        </div>
    `;
}

// 5. è´­ä¹°é€»è¾‘ (é€šç”¨)
function buyItem(type) {
    if (type === 'cure') {
        if (!currentHeir.body.sick) { auth.toast('èº«ä½“å€å„¿æ£’ï¼Œä¸ç”¨æ²»ï¼'); return; }
        currentHeir.body.sick = false; currentHeir.body.health = 100; auth.toast('âœ¨ å¦™æ‰‹å›æ˜¥ï¼ç—Šæ„ˆäº†ï¼');
    } else if (type === 'heal') {
        currentHeir.body.health = Math.min(100, currentHeir.body.health + 20); auth.toast('ğŸ’‰ å–äº†è¯ï¼Œæ„Ÿè§‰å¥½å¤šäº†');
    } else if (type === 'toy') {
        currentHeir.mood = Math.min(100, currentHeir.mood + 10); auth.toast('ğŸ§¸ æ”¶åˆ°ç¤¼ç‰©å¾ˆå¼€å¿ƒï¼');
    } else if (type === 'book') {
        currentHeir.params.wisdom += 5; auth.toast('ğŸ“š è¯»äº†ä¹¦ï¼Œå˜èªæ˜äº†');
    } else if (type === 'sword') {
        currentHeir.params.fitness += 5; auth.toast('âš”ï¸ å˜¿å“ˆï¼ä½“é­„å¢å¼ºäº†');
    } else if (type === 'tea') {
        currentHeir.body.waste = Math.max(0, currentHeir.body.waste - 10); auth.toast('ğŸ¥¤ å¥½å–ï¼è§£ä¹ï¼');
    } else if (type === 'hotpot') {
        currentHeir.body.waste = Math.max(0, currentHeir.body.waste - 30); auth.toast('ğŸ² åƒæ’‘äº†ï¼ç–²åŠ³å…¨æ¶ˆï¼');
    }
    
    saveHeirData();
    
    // åˆ·æ–°ä¸€ä¸‹å½“å‰APPçš„æ˜¾ç¤º (å¦‚æœåœ¨åŒ»é™¢ï¼Œåˆ·æ–°ç—…å†çŠ¶æ€)
    var activeApp = document.querySelector('.app-window:last-child');
    if(activeApp && activeApp.innerHTML.includes('ç—…å†')) {
        renderHospital(activeApp); // é‡æ–°æ¸²æŸ“åŒ»é™¢ç•Œé¢
    }
}

// 8. åˆ‡æ¢é¢æ¿
function switchPanel(mode) { currentHeir.panelMode = mode; saveHeirData(); openEastPalace(); }

// 9. ğŸ’¬ å‘é€æ¶ˆæ¯
async function sendToHeir() {
    if (currentHeir.isDead) return;
    var input = document.getElementById('heirInput');
    var text = input.value.trim();
    if (!text) return;

    addChatBubble('user', text);
    input.value = '';
    currentHeir.isWaitingForReply = false;
    currentHeir.body.waste += 2;
    if(currentHeir.body.waste > 80 && !currentHeir.body.sick && Math.random() > 0.7) {
        currentHeir.body.sick = true; auth.toast('ğŸ˜· å¤ªç´¯äº†ï¼Œç”Ÿç—…äº†ï¼');
    }
    saveHeirData();

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { addChatBubble('ai', 'ï¼ˆæ— API Keyï¼‰'); return; }

    var prompt = `
    è§’è‰²:${currentHeir.name},${currentHeir.age}å²,${currentHeir.season}å­£ã€‚
    çŠ¶æ€:å¥åº·${currentHeir.body.health},ç”Ÿç—…:${currentHeir.body.sick},å¿ƒæƒ…${currentHeir.mood}ã€‚
    å±æ€§:${JSON.stringify(currentHeir.params)}ã€‚
    ç”¨æˆ·è¯´:"${text}"
    ä»»åŠ¡:
    1. å¦‚ç”¨æˆ·é—®â€œå‡ºå»ç©/å‡ºå®«â€ï¼ŒåŒæ„åˆ™allowTravel:trueã€‚
    2. å¦‚æœç”Ÿç—…äº†ï¼Œå›å¤è¦è™šå¼±ã€‚
    JSON: { "reply":"", "innerThought":"", "action":"", "allowTravel":false, "changes":{} }
    `;

    showTyping();

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        updateHeirStats(data.changes);
        currentHeir.lastThought = data.innerThought; 
        
        var replyHtml = data.reply;
        if (data.allowTravel && !currentHeir.body.sick) replyHtml += `<br><button onclick="openTravelMap()" style="margin-top:5px; background:#ff9a9e; color:white; border:none; padding:4px 12px; border-radius:15px; cursor:pointer; font-size:12px;">ğŸš— å¤‡è½¦å‡ºå‘</button>`;
        
        var area = document.getElementById('heirChatArea');
        var div = document.createElement('div');
        div.className = `heir-msg ai`; div.innerHTML = replyHtml; 
        area.appendChild(div); area.scrollTop = area.scrollHeight;
        
        if (!currentHeir.history) currentHeir.history = [];
        currentHeir.history.push({ role: 'ai', content: data.reply }); 
        if (data.action) smartUpdateHeirScene(data.action);
        
        saveHeirData();
        checkRunaway(); checkDeath();
    } catch (e) { addChatBubble('ai', '...'); }
}

// 10. ğŸŒ¸ æ¢å­£
function toggleHeirSeason() {
    if (currentHeir.isDead || currentHeir.age >= 18) return;
    var seasons = ['æ˜¥', 'å¤', 'ç§‹', 'å†¬'];
    var nextIdx = seasons.indexOf(currentHeir.season) + 1;

    if (currentHeir.body.sick) { currentHeir.body.health -= 30; auth.toast('âš ï¸ ç—…æƒ…åŠ é‡ï¼'); }
    else if (Math.random() > 0.85) { currentHeir.body.sick = true; auth.toast('ğŸ˜· æ¢å­£ç”Ÿç—…äº†ï¼'); }

    if (nextIdx > 3) advanceYear(); 
    else {
        currentHeir.season = seasons[nextIdx];
        currentHeir.bioLog.push(`ã€${currentHeir.age}å²Â·${currentHeir.season}ã€‘ï¼šæ¢å­£äº†ã€‚`);
        saveHeirData(); openEastPalace(); checkDeath();
writeDailyDiary(); 

    }
}

// ================= ğŸ“ 5.0 æ ¸å¿ƒï¼šæˆäººç¤¼ä¸å¯è§†åŒ–ç»“ç®— =================

// 1. æ£€æŸ¥å¹¶ç»“ç®—æˆå°±
function checkAchievements() {
    if (!currentHeir.achievements) currentHeir.achievements = [];
    
    ACHIEVEMENT_DB.forEach(ach => {
        // å¦‚æœè¿˜æ²¡è·å¾—ï¼Œä¸”æ»¡è¶³æ¡ä»¶
        if (!currentHeir.achievements.includes(ach.name) && ach.req(currentHeir)) {
            currentHeir.achievements.push(ach.name);
            auth.toast(`ğŸ† è§£é”æˆå°±ï¼šã€${ach.name}ã€‘`);
        }
    });
}

// 2. å¼€å¯æˆäººç¤¼ (ç»“ç®—ç•Œé¢)
async function openAdultCeremony() {
    // å…³é—­å…¶ä»–çª—å£
    document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
    
    // 1. åˆ¤å®šèŒä¸š
    let bestCareer = CAREER_DB[CAREER_DB.length - 1]; // é»˜è®¤å¹³æ°‘
    let bestIndex = CAREER_DB.length - 1;

    // å€’åºéå†ï¼Œæ‰¾åˆ°æœ€é«˜çº§ä¸”ç¬¦åˆæ¡ä»¶çš„èŒä¸š
    for (let i = 0; i < CAREER_DB.length; i++) {
        let job = CAREER_DB[i];
        let qualified = true;
        
        // æ£€æŸ¥æ¯ä¸€é¡¹ç¡¬æ€§æŒ‡æ ‡
        for (let reqKey in job.req) {
            let currentVal = currentHeir.params[reqKey] || 0;
            // å¦‚æœæ˜¯è´Ÿæ•°è¦æ±‚ï¼ˆä¾‹å¦‚ rebellion: -1ï¼‰ï¼Œä»£è¡¨â€œä¸èƒ½è¶…è¿‡â€
            if (job.req[reqKey] < 0) { 
                 /* æš‚ä¸å¤„ç†ç‰¹æ®Šé€»è¾‘ï¼ŒæŒ‰æ ‡å‡†å¤§äºç­‰äºå¤„ç† */ 
            } else {
                if (currentVal < job.req[reqKey]) { qualified = false; break; }
            }
        }
        
        if (qualified) {
            bestCareer = job;
            bestIndex = i;
            break; // æ‰¾åˆ°äº†å°±åœæ­¢ (å‰ææ˜¯CAREER_DBæŒ‰ä¼˜å…ˆçº§æ’åºäº†ï¼Œæˆ–è€…åè¿‡æ¥)
        }
    }

    currentHeir.career = bestCareer.name;
    
    // å­˜å…¥å®¶æ—
    archiveHeirToFamily(currentHeir);
    saveHeirData();

    // 2. æ„å»ºå¯è§†åŒ– HTML
    var modal = document.querySelector('#eastPalaceModal .modal');
    // ä¸´æ—¶æ”¹å˜æ ·å¼ä¸ºå…¨å±
    modal.className = "modal adult-modal"; 
    document.getElementById('eastPalaceModal').classList.add('active');

    // ç”Ÿæˆå±æ€§åˆ¤å®šæ¡ HTML
    let judgeHtml = "";
    if (bestCareer.name === "å¹³æ°‘") {
        judgeHtml = "<div style='text-align:center;color:#999;font-size:12px;'>å¹³å¹³æ·¡æ·¡æ‰æ˜¯çœŸ...</div>";
    } else {
        for (let key in bestCareer.req) {
            let reqVal = bestCareer.req[key];
            let curVal = currentHeir.params[key] || 0;
            let isPass = curVal >= reqVal;
            let pct = Math.min(100, (curVal / 120) * 100); // è¿›åº¦æ¡é•¿åº¦
            let lineLeft = Math.min(100, (reqVal / 120) * 100); // è¾¾æ ‡çº¿ä½ç½®

            // å±æ€§åæ±‰åŒ–
            let label = {wisdom:'æ™ºæ…§',fitness:'ä½“é­„',charm:'é­…åŠ›',diligence:'å‹¤å‹‰',rebellion:'å›é€†',morality:'é“å¾·',ambition:'é‡å¿ƒ',affection:'äº²å¯†'}[key] || key;

            judgeHtml += `
            <div class="judge-row">
                <span class="judge-label">${label}</span>
                <div class="judge-track">
                    <div class="judge-bar ${isPass?'pass':'fail'}" style="width:${pct}%"></div>
                    <div class="judge-line" style="left:${lineLeft}%" title="è¦æ±‚: ${reqVal}"></div>
                </div>
                <div class="judge-val">
                    ${curVal}/${reqVal} ${isPass?'âœ…':'âŒ'}
                </div>
            </div>`;
        }
    }

    // ç”Ÿæˆæˆå°± HTML
    let achHtml = currentHeir.achievements.map(a => `<span class="ach-badge">ğŸ† ${a}</span>`).join('');
    if(!achHtml) achHtml = `<span style="color:#ccc;font-size:12px;">(æœ¬æ¬¡äººç”Ÿæš‚æ— ç‰¹æ®Šæˆå°±)</span>`;

    // æ¸²æŸ“ç•Œé¢
    modal.innerHTML = `
        <div class="adult-header">âœ¨ å† ç¤¼ Â· æˆäººç»“ç®— âœ¨</div>
        <div class="adult-content">
            
            <div class="career-card-large">
                <div class="career-icon-big">ğŸ“</div>
                <div class="career-title-big">${bestCareer.name}</div>
                <div class="career-desc">"${bestCareer.type === 'bad' ? 'æœ‰äº›è·¯ï¼Œä¸€æ—¦èµ°é”™å°±å›ä¸å»äº†...' : 'å‰ç¨‹ä¼¼é”¦ï¼Œæœªæ¥å¯æœŸã€‚'}"</div>
            </div>

            <div class="judge-box">
                <div class="judge-title">ğŸ“‹ èŒä¸šèµ„è´¨åˆ¤å®šä¹¦</div>
                ${judgeHtml}
            </div>

            <div class="judge-box" style="border-left:3px solid #ff9a9e;">
                <div class="judge-title">ğŸ… äººç”Ÿæˆå°±</div>
                <div class="achievement-grid">${achHtml}</div>
            </div>

            <div class="judge-box" style="background:#fffbf0; border:none;">
                <div class="judge-title">ğŸ’Œ ${currentHeir.name} çš„ç¦»å®¶ç•™è¨€</div>
                <div id="careerLetter" class="farewell-letter">
                    <div class="ai-loading">âœï¸ æ­£åœ¨æŒ¥æ³ªå†™ä¿¡...</div>
                </div>
            </div>

            <button onclick="closeEastPalace(); location.reload();" class="primary-btn" style="width:100%; margin-top:20px; padding:15px; font-size:16px;">
                ğŸ‘‹ å­©å­é•¿å¤§äº† (å½’æ¡£å¹¶å…è®¸ç”ŸäºŒèƒ)
            </button>
        </div>
    `;

    // 3. è°ƒç”¨ AI ç”Ÿæˆç¦»åˆ«ä¿¡
    generateCareerStory(bestCareer.name);
}

// 3. AI ç”Ÿæˆå°±èŒæ„Ÿè¨€
async function generateCareerStory(job) {
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) {
        document.getElementById('careerLetter').innerHTML = "ï¼ˆAI æ²¡ç”µäº†ï¼Œå­©å­é»˜é»˜åœ°èµ°äº†...ï¼‰";
        return;
    }

    const prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚æˆ‘çš„çš‡å—£ã€${currentHeir.name}ã€‘ä»Šå¤©18å²æˆå¹´äº†ã€‚
    ç»è¿‡å¤šå¹´çš„åŸ¹å…»ï¼Œä»–/å¥¹æœ€ç»ˆæˆä¸ºäº†ã€${job}ã€‘ã€‚
    
    æ€§æ ¼å±æ€§ï¼š${JSON.stringify(currentHeir.params)}ã€‚
    äººç”Ÿæˆå°±ï¼š${currentHeir.achievements.join(',')}ã€‚
    
    è¯·ä»¥ã€çš‡å—£çš„ç¬¬ä¸€äººç§°ã€‘ï¼Œå†™ä¸€å°ç»™æˆ‘çš„â€œç¦»å®¶å‘Šåˆ«ä¿¡â€ï¼ˆ100å­—å·¦å³ï¼‰ã€‚
    å†…å®¹è¦æ±‚ï¼š
    1. æåˆ°è‡ªå·±å¯¹è¿™ä¸ªèŒä¸šçš„çœ‹æ³•ï¼ˆå–œæ¬¢/æ— å¥ˆ/é‡å¿ƒï¼‰ã€‚
    2. å›å¿†ä¸€ä»¶å°æ—¶å€™çš„äº‹ï¼ˆæ ¹æ®æ€§æ ¼çç¼–ä¸€ä»¶æ¸©é¦¨æˆ–æ‰å¿ƒçš„ï¼‰ã€‚
    3. è¡¨è¾¾å¯¹æ¯äº²ï¼ˆå¥³çš‡ï¼‰çš„æ„Ÿè°¢æˆ–æ€¨æ¨ï¼ˆçœ‹äº²å¯†åº¦å’Œå›é€†å€¼ï¼‰ã€‚
    `;

    try {
        const res = await fetchAI(prompt, config);
        document.getElementById('careerLetter').innerHTML = res.replace(/\n/g, '<br>');
        
        // å­˜å…¥ç”Ÿå¹³
        currentHeir.bioLog.push(`ã€18å²Â·ç»“å±€ã€‘ï¼š${res}`);
        saveHeirData();
    } catch(e) {
        document.getElementById('careerLetter').innerText = "ï¼ˆå­©å­èµ°å¾—å¤ªæ€¥ï¼Œæ²¡ç•™ä¸‹ä¹¦ä¿¡...ï¼‰";
    }
}

// 11. ğŸ‚ é•¿å¤§

// ğŸ‚ é•¿å¤§ä¸€å² (èŒä¸šåˆ¤å®š + å®¶æ—å½’æ¡£)

// ğŸ‚ é•¿å¤§ä¸€å² (æ¥å…¥æˆäººç¤¼ç‰ˆ)
function advanceYear() {
    if (currentHeir.isDead) return;
    
    // ğŸ” æ¯å¹´æ£€æŸ¥ä¸€æ¬¡æˆå°±
    checkAchievements();

    // ğŸ“ 18å²æˆäººç¤¼è§¦å‘ç‚¹
    if (currentHeir.age === 17) {
        currentHeir.age = 18;
        // ç›´æ¥è¿›å…¥ç»“ç®—æµç¨‹ï¼Œä¸ç›´æ¥ä¿å­˜careerï¼Œäº¤ç»™ openAdultCeremony å¤„ç†
        openAdultCeremony();
        return;
    }

    if (currentHeir.age >= 18) {
        auth.toast('ğŸ“ å­©å­å·²æˆå¹´åœ¨å¤–æ‰“æ‹¼...');
        currentHeir.age += 1;
    } else {
        currentHeir.age += 1;
        currentHeir.season = 'æ˜¥'; // æœªæˆå¹´é‡ç½®å­£èŠ‚
        
        // ç”Ÿé•¿å‘è‚² (èº«é«˜ä½“é‡)
        currentHeir.body.height += (5 + Math.floor(Math.random()*5));
        currentHeir.body.weight += (2 + Math.floor(Math.random()*3));
    }

    currentHeir.bioLog.push(`â€”â€”â€” ${currentHeir.age} å² â€”â€”â€”`);
    
    saveHeirData();
    openEastPalace();
    
    if(typeof checkDeath === 'function') checkDeath();
    if(typeof writeDailyDiary === 'function') writeDailyDiary();
}



// 12. ğŸ’€ æ­»äº¡
function checkDeath() {
    if (currentHeir.body.health <= 0) {
        currentHeir.isDead = true;
        currentHeir.bioLog.push(`ã€${currentHeir.age}å²ã€‘ï¼šå› ç—…é‡ä¸æ²»ï¼Œä¸å¹¸å¤­æŠ˜ã€‚`);
        saveHeirData(); renderDeadView();
    }
}
function renderDeadView() {
    var modalContent = document.querySelector('#eastPalaceModal .modal');
    modalContent.innerHTML = `<button class="close-modal" onclick="closeEastPalace()" style="position:absolute; right:10px; top:10px; color:#aaa;">Ã—</button><div style="height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#000; color:#fff;"><div style="font-size:60px;">ğŸª¦</div><h3 style="margin:10px 0; color:#d63031;">é¦™æ¶ˆç‰æ®’</h3><p style="font-size:12px; text-align:center; padding:0 30px; color:#aaa;">${currentHeir.name} çš„ç”Ÿå‘½æ°¸è¿œåœç•™åœ¨äº† ${currentHeir.age} å²ã€‚</p><button onclick="openMemories()" style="margin-top:20px; padding:10px 20px; border:1px solid #555; background:#333; color:#fff; border-radius:20px;">ğŸ“– æŸ¥çœ‹ç”Ÿå¹³</button></div>`;
}

// 13. è¾…åŠ©
function getAvatarUrl(state) {
    var isBoy = currentHeir.gender === 'ç”·';
    var assets = isBoy ? HEIR_ASSETS.boy : HEIR_ASSETS.girl;
    if (state === 'yawn') return assets.yawn;
    if (state === 'shy') return assets.shy;
    return Array.isArray(assets.idle) ? assets.idle[Math.floor(Math.random()*assets.idle.length)] : assets.idle;
}
function addChatBubble(role, text) {
    var area = document.getElementById('heirChatArea');
    var div = document.createElement('div');
    div.className = `heir-msg ${role}`; div.innerText = text;
    area.appendChild(div); area.scrollTop = area.scrollHeight;
    if (!currentHeir.history) currentHeir.history = [];
    currentHeir.history.push({ role: role, content: text });
}
function showTyping() {
    var area = document.getElementById('heirChatArea');
    var div = document.createElement('div');
    div.id = 'heirTyping'; div.innerText = 'âœï¸...'; div.style.cssText = "font-size:10px; color:#aaa; margin-left:15px;";
    area.appendChild(div); area.scrollTop = area.scrollHeight;
}
function updateHeirStats(changes) {
    if (!changes) return;
    for (var key in changes) {
        if (key === 'mood') currentHeir.mood = Math.min(Math.max(currentHeir.mood + changes[key], 0), 100);
        else if (currentHeir.params[key] !== undefined) currentHeir.params[key] = Math.min(Math.max(currentHeir.params[key] + changes[key], 0), 100);
    }
}
function saveHeirData() { localStorage.setItem('royal_heir_data', JSON.stringify(currentHeir)); }
function updateHeirButtonState() {
    var btn = document.getElementById('heirActionButton');
    if (!btn) return;
    if (typeof viewingIndex === 'undefined' || viewingIndex === -1 || !items[viewingIndex]) return;
    if (currentHeir && currentHeir.fatherName === items[viewingIndex].name && !currentHeir.isRunaway && !currentHeir.isDead) {
        btn.innerText = `ğŸ§¸ å‰å¾€ä¸œå®« (çœ‹æœ›${currentHeir.name})`;
        btn.style.background = '#fff7d1'; btn.style.color = '#fa8c16';
    } else {
        btn.innerText = `ğŸ‘¶ ç¥ˆç¦æ±‚å­`;
        btn.style.background = '#fff0f5'; btn.style.color = '#ff6b6b';
    }
}
function handleHeirAction() {
    if (viewingIndex === -1) return;
    var item = items[viewingIndex];
    if (currentHeir && currentHeir.fatherName === item.name && !currentHeir.isRunaway && !currentHeir.isDead) {
        openEastPalace();
    } else {
        document.getElementById('creationFatherName').innerText = item.name;
        document.getElementById('creationSettingInput').value = '';
        document.getElementById('heirCreationModal').classList.add('active');
    }
}
function closeEastPalace() { document.getElementById('eastPalaceModal').classList.remove('active'); }
function smartUpdateHeirScene(actionText) {
    if (!currentHeir) return;
    var isBoy = currentHeir.gender === 'ç”·';
    var sceneList = isBoy ? HEIR_SCENES.boy : HEIR_SCENES.girl;
    var pool = (isBoy ? HEIR_ASSETS.boy : HEIR_ASSETS.girl).bg[currentHeir.season];
    if(!Array.isArray(pool)) pool = [pool];
    var finalUrl = pool[Math.floor(Math.random() * pool.length)];
    if (actionText) {
        for (var i=0; i<sceneList.length; i++) {
            if (sceneList[i].seasons.includes(currentHeir.season) && sceneList[i].keywords.some(k => actionText.includes(k))) {
                finalUrl = Array.isArray(sceneList[i].url) ? sceneList[i].url[0] : sceneList[i].url;
                break;
            }
        }
    }
    currentHeir.currentScene = finalUrl; saveHeirData();
    var bgEl = document.getElementById('heirSceneBg');
    if (bgEl) bgEl.style.backgroundImage = `url('${finalUrl}')`;
}
function touchHeir2D() {
    currentHeir.mood = Math.min(100, currentHeir.mood + 2); saveHeirData(); auth.toast(`ğŸ‘‰ æ‘¸æ‘¸å¤´ (å¿ƒæƒ…+2)`);
}
function readMind() {
    if (!currentHeir.lastThought) { auth.toast('ğŸ˜¶ ...'); return; }
    var bubble = document.getElementById('heirBubble');
    bubble.innerText = `ğŸ’­ ${currentHeir.lastThought}`;
    bubble.style.opacity = 1; bubble.style.top = '20px';
    setTimeout(() => { bubble.style.opacity = 0; bubble.style.top = '50px'; }, 3000);
}
function openMemories() { currentHeir.isViewingMemories = true; renderMemoryBook(); }
function exitMemories() { currentHeir.isViewingMemories = false; openEastPalace(); }
function renderMemoryBook() {
    var modalContent = document.querySelector('#eastPalaceModal .modal');
    var logs = currentHeir.bioLog || [];
    modalContent.innerHTML = `<button class="close-modal" onclick="exitMemories()" style="position:absolute; right:10px; top:10px; z-index:200; font-size:24px; background:none; border:none;">Ã—</button><div style="text-align:center; padding:15px; border-bottom:2px solid #ffb7c5; background:#fff;"><h3>ğŸ“œ ${currentHeir.name} çš„ç”Ÿå¹³</h3></div><div class="memory-list">${logs.slice().reverse().map(log => `<div class="memory-item"><div class="memory-content">${log}</div></div>`).join('')}</div><button onclick="exitMemories()" style="width:100%; padding:15px; background:#fff; border:none;">ğŸ”™ è¿”å›</button>`;
}
function checkRunaway() {
    if (currentHeir.params.rebellion > 90 && currentHeir.params.affection < 20) {
        currentHeir.isRunaway = true; currentHeir.bioLog.push(`ã€${currentHeir.age}å²ã€‘ï¼šç¦»å®¶å‡ºèµ°ã€‚`); saveHeirData(); renderRunawayView();
    }
}
function renderRunawayView() {
    var modalContent = document.querySelector('#eastPalaceModal .modal');
    modalContent.innerHTML = `<button class="close-modal" onclick="closeEastPalace()" style="position:absolute;right:10px;top:10px">Ã—</button><div style="height:100%;display:flex;justify-content:center;align-items:center;flex-direction:column"><h3>ğŸšï¸ äººå»æ¥¼ç©º</h3><button onclick="openMemories()">ğŸ“– å›å¿†å½•</button></div>`;
}

// ================= ğŸ—ºï¸ å‡ºæ¸¸ç³»ç»Ÿ 2.0 (AIé™ªèŠ+éšæœºäº‹ä»¶ç‰ˆ) =================

// 1. æ‰“å¼€åœ°å›¾ (é€‰æ‹©ç›®çš„åœ°)
function openTravelMap() {
    var modalContent = document.querySelector('#eastPalaceModal .modal');
    var mapData = WORLD_MAPS['outside'];
    
    // æ¸²æŸ“åœ°ç‚¹å¡ç‰‡
    var locHtml = mapData.locations.map(loc => `
        <div class="location-card" onclick="enterLocation('${loc.name}', '${loc.desc}', '${loc.type}')" 
             style="background:#fff; border:1px solid #e0d0b0; padding:10px 5px; text-align:center; border-radius:8px; cursor:pointer; transition:transform 0.2s;">
            <div style="font-size:24px;">${loc.icon}</div>
            <div style="font-weight:bold; font-size:12px; margin-top:5px; color:#5d4037;">${loc.name}</div>
            ${loc.desc ? `<div style="color:#999; font-size:10px;">${loc.desc}</div>` : ''}
        </div>
    `).join('');

    modalContent.innerHTML = `
        <div class="map-modal-body" style="height:100%; display:flex; flex-direction:column; background:#fffbf0;">
            <div class="map-header" style="height:150px; background:url('${mapData.bg}') center/cover; position:relative; flex-shrink:0;">
                <div class="map-title-badge" style="position:absolute; top:10px; left:10px; background:rgba(255,255,255,0.8); padding:5px 12px; border-radius:15px; font-weight:bold; color:#d4af37;">
                    ğŸŒ ${mapData.name}
                </div>
                <button onclick="closeTravelMode()" style="position:absolute; right:10px; top:10px; background:rgba(0,0,0,0.5); color:#fff; border:none; padding:5px 12px; border-radius:15px; cursor:pointer;">âœ– å…³é—­</button>
            </div>
            <div style="padding:10px; text-align:center; font-size:12px; color:#d46b08; background:#ffeaa7;">
                ğŸš— å¸¦ ${currentHeir.name} å»å“ªé‡Œæ•£å¿ƒå‘¢ï¼Ÿ
            </div>
            <div class="map-grid" style="flex:1; overflow-y:auto; padding:15px; display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; align-content:start;">
                ${locHtml}
            </div>
        </div>
    `;
}

// 2. è¿›å…¥æ™¯ç‚¹ (åˆå§‹åŒ–èŠå¤©ç•Œé¢)
var currentTravelLoc = null;

function enterLocation(name, desc, type) {
    if (type === 'exit') { closeTravelMode(); return; }
    
    currentTravelLoc = name;
    var modalContent = document.querySelector('#eastPalaceModal .modal');
    
    // èƒŒæ™¯å›¾é€»è¾‘
    var bgUrl = WORLD_MAPS['outside'].bg; 
    
    // å°äººç«‹ç»˜
    var assets = currentHeir.gender === 'ç”·' ? HEIR_ASSETS.boy : HEIR_ASSETS.girl;
    var avatarUrl = getAvatarUrl('idle');

    modalContent.innerHTML = `
        <div class="travel-chat-view" style="display:flex; flex-direction:column; height:100%; background:#fff;">
            <div class="travel-scene-area" style="height:200px; background:url('${bgUrl}') center/cover; position:relative; display:flex; align-items:flex-end; justify-content:center; flex-shrink:0;">
                <div style="position:absolute; top:10px; left:10px; background:rgba(255,255,255,0.9); padding:5px 10px; border-radius:10px; font-weight:bold; color:#d46b08; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
                    ğŸ“ ${name}
                </div>
                
                <img src="${avatarUrl}" class="travel-avatar" style="height:140px; filter:drop-shadow(0 5px 10px rgba(0,0,0,0.3)); cursor:pointer;" onclick="touchHeir2D()">
                
                <button onclick="triggerRandomEvent()" style="position:absolute; right:10px; bottom:10px; background:#ff7675; color:white; border:none; padding:5px 10px; border-radius:15px; font-size:12px; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
                    ğŸ² è§¦å‘æ„å¤–
                </button>
            </div>

            <div id="travelChatBox" class="travel-chat-box" style="flex:1; overflow-y:auto; padding:15px; background:#f9f9f9; display:flex; flex-direction:column; gap:10px;">
                <div style="text-align:center; color:#ccc; font-size:12px;">â€”â€” æŠµè¾¾ ${name} â€”â€”</div>
            </div>

            <div class="travel-controls" style="padding:10px; border-top:1px solid #eee; display:flex; gap:10px; background:#fff;">
                <button onclick="openTravelMap()" style="background:#eee; color:#666; border:none; padding:0 15px; border-radius:20px; cursor:pointer;">ğŸ”™</button>
                <input type="text" id="travelInput" style="flex:1; padding:8px 12px; border:1px solid #ddd; border-radius:20px; outline:none;" placeholder="èŠèŠé£æ™¯ï¼Œæˆ–æé†’æ³¨æ„å®‰å…¨..." onkeydown="if(event.key==='Enter') sendTravelChat()">
                <button onclick="sendTravelChat()" style="background:#ff9a9e; color:#white; border:none; padding:0 20px; border-radius:20px; cursor:pointer; font-weight:bold;">å‘é€</button>
            </div>
        </div>
    `;
    
    // åˆšè¿›å»ï¼Œè§¦å‘ç¬¬ä¸€å¥å¼€åœºç™½
    triggerTravelStart(name);
}

// 3. å‘é€èŠå¤©æ¶ˆæ¯
async function sendTravelChat() {
    var input = document.getElementById('travelInput');
    var text = input.value.trim();
    if (!text) return;

    // ç”¨æˆ·è¯´è¯ä¸Šå±
    appendTravelMsg('user', text);
    input.value = '';

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { appendTravelMsg('ai', 'ï¼ˆè¯·é…ç½®API Keyï¼‰'); return; }

    // æ„å»º Prompt
    var prompt = `
    ã€åœºæ™¯ã€‘ï¼š${currentTravelLoc} (å‡ºæ¸¸ä¸­)ã€‚
    ã€è§’è‰²ã€‘ï¼š${currentHeir.name}ï¼Œ${currentHeir.age}å²ã€‚
    ã€æ€§æ ¼ã€‘ï¼š${JSON.stringify(currentHeir.params)}ã€‚
    
    ç”¨æˆ·ï¼ˆå®¶é•¿ï¼‰è¯´ï¼šâ€œ${text}â€
    
    è¯·ä»¥è§’è‰²å£å»å›å¤ã€‚ç»“åˆå½“å‰æ™¯ç‚¹ç¯å¢ƒã€‚
    JSONæ ¼å¼ï¼š{ "reply": "å›å¤å†…å®¹", "changes": { "mood": 2, "affection": 1 } }
    `;

    try {
        // æ˜¾ç¤ºæ‰“å­—ä¸­
        var loadingId = 'loading-' + Date.now();
        var box = document.getElementById('travelChatBox');
        box.insertAdjacentHTML('beforeend', `<div id="${loadingId}" style="font-size:10px; color:#999; margin-left:10px;">âœï¸ æ­£åœ¨æ€è€ƒ...</div>`);
        
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        document.getElementById(loadingId).remove();
        
        appendTravelMsg('ai', data.reply);
        updateHeirStats(data.changes);
        saveHeirData();
    } catch(e) { 
        if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
        appendTravelMsg('ai', 'ï¼ˆçœ‹é£æ™¯å…¥è¿·äº†ï¼Œæ²¡å¬æ¸…...ï¼‰'); 
    }
}

// 4. ğŸ² è§¦å‘éšæœºäº‹ä»¶ / æ„å¤– (æ ¸å¿ƒæ–°åŠŸèƒ½)
async function triggerRandomEvent() {
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) return;

    auth.toast('ğŸ² å‘½è¿çš„é½¿è½®è½¬åŠ¨äº†...');
    
    var prompt = `
    ã€æŒ‡ä»¤ã€‘ï¼šç”Ÿæˆä¸€ä¸ªå‡ºæ¸¸é€”ä¸­çš„éšæœºäº‹ä»¶ã€‚
    åœ°ç‚¹ï¼š${currentTravelLoc}ã€‚
    è§’è‰²ï¼š${currentHeir.name}ã€‚
    
    è¯·è®¾è®¡ä¸€ä¸ªçªå‘çŠ¶å†µï¼Œå¯èƒ½æ˜¯ï¼š
    1. æƒŠå–œï¼ˆæ¡åˆ°é’±ã€é‡åˆ°ç¥¥ç‘ï¼‰ã€‚
    2. æ„å¤–ï¼ˆä¸‹é›¨ã€è¿·è·¯ã€ä¸¢ä¸œè¥¿ï¼‰ã€‚
    3. æƒŠå“ï¼ˆé‡åˆ°åäººã€è¸©åˆ°å‘ã€ç”Ÿç—…å—ä¼¤ï¼‰ã€‚
    
    è¯·ç›´æ¥ä»¥ã€æ—ç™½ã€‘æˆ–ã€è§’è‰²ã€‘çš„å£å»æè¿°å‘ç”Ÿäº†ä»€ä¹ˆã€‚
    å¹¶ç»™å‡ºå±æ€§å˜åŒ–ã€‚
    
    JSONæ ¼å¼ï¼š{ "event": "äº‹ä»¶æè¿°", "healthChange": -10, "moodChange": -20 }
    (healthChange ä¸ºè´Ÿæ•°ä»£è¡¨å—ä¼¤/ç”Ÿç—…)
    `;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        // æ¸²æŸ“äº‹ä»¶æ°”æ³¡ (ç‰¹æ®Šæ ·å¼)
        var box = document.getElementById('travelChatBox');
        var eventHtml = `
            <div style="background:#fff7e6; border:1px dashed #ffa502; padding:10px; border-radius:10px; margin:10px 0; text-align:center;">
                <div style="font-weight:bold; color:#d46b08; margin-bottom:5px;">âš¡ çªå‘äº‹ä»¶</div>
                <div style="font-size:13px; color:#5d4037;">${data.event}</div>
            </div>
        `;
        box.insertAdjacentHTML('beforeend', eventHtml);
        box.scrollTop = box.scrollHeight;

        // åº”ç”¨å±æ€§å˜åŒ–
        if (data.healthChange) {
            currentHeir.body.health = Math.max(0, currentHeir.body.health + data.healthChange);
            if(data.healthChange < 0) {
                currentHeir.body.sick = true; // å¦‚æœæ‰£è¡€ï¼Œå¯èƒ½å¯¼è‡´ç”Ÿç—…
                auth.toast(`ğŸ’” å¥åº· ${data.healthChange} (å¯èƒ½ç”Ÿç—…äº†ï¼)`);
            }
        }
        if (data.moodChange) {
            updateHeirStats({ mood: data.moodChange });
        }
        
        saveHeirData();
    } catch(e) {}
}

// 5. åˆ°è¾¾æ™¯ç‚¹å¼€åœºç™½
async function triggerTravelStart(locName) {
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) return;

    var prompt = `ä½ åˆšåˆ°äº†ã€${locName}ã€‘ã€‚è¯·æ ¹æ®æ€§æ ¼(${JSON.stringify(currentHeir.params)})å‘è¡¨ä¸€å¥æ„Ÿæƒ³ã€‚JSON:{"reply":""}`;
    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        appendTravelMsg('ai', data.reply);
        
        // è®°å½•åˆ°ç”Ÿå¹³
        currentHeir.bioLog.push(`ã€${currentHeir.age}å²Â·æ¸¸å†ã€‘ï¼šåœ¨${locName}ï¼Œ${data.reply}`);
        saveHeirData();
    } catch(e) {}
}

// 6. è¾…åŠ©ï¼šæ¸²æŸ“æ°”æ³¡
function appendTravelMsg(role, text) {
    var box = document.getElementById('travelChatBox');
    var div = document.createElement('div');
    
    // æ°”æ³¡æ ·å¼
    if (role === 'user') {
        div.style.cssText = `align-self:flex-end; background:#ff9a9e; color:white; padding:8px 12px; border-radius:15px; border-bottom-right-radius:2px; max-width:80%; font-size:13px; box-shadow:0 2px 5px rgba(0,0,0,0.1);`;
    } else {
        div.style.cssText = `align-self:flex-start; background:#fff; color:#333; padding:8px 12px; border-radius:15px; border-bottom-left-radius:2px; max-width:80%; font-size:13px; border:1px solid #eee; box-shadow:0 2px 5px rgba(0,0,0,0.05);`;
    }
    
    div.innerText = text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

function closeTravelMode() {
    openEastPalace(); // å›åˆ°ä¸»ç•Œé¢
}


// ğŸ““ è‡ªåŠ¨å†™æ—¥è®°é€»è¾‘ (æ–°å¢)
async function writeDailyDiary() {
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) return;

    // 1. è·å–æœ€è¿‘å‘ç”Ÿçš„ 3 ä»¶äº‹ä½œä¸ºç´ æ
    var recentLogs = currentHeir.bioLog.slice(-3).join("ï¼›");
    if (!recentLogs) recentLogs = "ä»Šå¤©å¹³å¹³æ·¡æ·¡ï¼Œæ²¡ä»€ä¹ˆç‰¹åˆ«çš„äº‹ã€‚";

    // 2. æ„å»º Prompt
    var prompt = `
    è§’è‰²ï¼š${currentHeir.name}ï¼Œ${currentHeir.age}å²ã€‚
    æ€§æ ¼ï¼š${JSON.stringify(currentHeir.params)}ã€‚
    
    è¯·æ ¹æ®ä»¥ä¸‹ã€è¿‘æœŸç»å†ã€‘ï¼Œå†™ä¸€ç¯‡ç®€çŸ­çš„ç§å¯†æ—¥è®°ï¼ˆ50å­—å·¦å³ï¼‰ã€‚
    è¦æ±‚ï¼š
    1. ç”¨ç¬¬ä¸€äººç§°â€œæˆ‘â€ã€‚
    2. è¯­æ°”è¦ç¬¦åˆæ€§æ ¼ï¼ˆæ¯”å¦‚å‚²å¨‡çš„è¦å£æ˜¯å¿ƒéï¼Œç—…å¨‡çš„è¦æåˆ°å¯¹'é‚£ä¸ªäºº'çš„æ‰§å¿µï¼‰ã€‚
    3. è¿™æ˜¯ä¸€ä¸ªä¸å¯å‘Šäººçš„ç§˜å¯†æ—¥è®°ï¼Œå†™å‡ºçœŸå®æƒ³æ³•ã€‚
    
    ã€è¿‘æœŸç»å†ã€‘ï¼š${recentLogs}
    `;

    try {
        // 3. æ‚„æ‚„è¯·æ±‚ AI (ä¸æ˜¾ç¤ºåŠ è½½åŠ¨ç”»ï¼Œåå°æ‰§è¡Œ)
        var res = await fetchAI(prompt, config);
        
        // 4. å­˜å…¥æ—¥è®°æœ¬
        var dateStr = `${currentHeir.age}å²Â·${currentHeir.season}`;
        currentHeir.diary.push({ date: dateStr, content: res });
        
        // ä¿æŒæ—¥è®°æœ€å¤š 10 æ¡ï¼Œé˜²æ­¢å­˜å¤ªå¤š
        if (currentHeir.diary.length > 10) currentHeir.diary.shift();
        
        saveHeirData();
        console.log("ğŸ““ æ—¥è®°å·²æ›´æ–°");
        
    } catch(e) {
        console.log("âŒ æ—¥è®°å†™å…¥å¤±è´¥");
    }
}

// ================= â¤ï¸ å§»ç¼˜ç°¿æ ¸å¿ƒé€»è¾‘ (è¡¥å…¨) =================

// 1. ç”Ÿæˆæ‹çˆ±å¯¹è±¡ (ä¿®æ­£ç‰ˆï¼šç¡®ä¿æœ‰åˆå§‹å±æ€§)
async function generatePartners() {
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var targetGender = currentHeir.gender === 'ç”·' ? 'å¥³æ€§' : 'ç”·æ€§';
    
    // æ²¡ Key ç”¨å‡æ•°æ®ä¿åº•
    if(!config || !config.apiKey) {
        currentHeir.dating.partners = [
            { name: "ç‹äºŒä¸«", age: 15, job: "å–èŠ±çš„", avatar: "https://files.catbox.moe/fv8f8p.gif", nature: "è‰¯é…", affinity: 10, status: "ç›¸è¯†", logs: [], desc: "å‹¤åŠ³å–„è‰¯ã€‚" },
            { name: "èµµå…¬å­", age: 17, job: "å¯Œå®¶å­", avatar: "https://files.catbox.moe/3ofd6b.png", nature: "æ¸£ç”·", affinity: 5, status: "ç›¸è¯†", logs: [], desc: "çœ¼ç¥è½»æµ®ã€‚" }
        ];
        saveHeirData();
        return;
    }

    var prompt = `ç”Ÿæˆ3ä¸ªå¤ä»£${targetGender}æ‹çˆ±å¯¹è±¡ã€‚
    JSONæ ¼å¼: [{"name":"","age":16,"job":"","nature":"è‰¯é…/ç»¿èŒ¶/æ™®é€š","desc":"æ€§æ ¼æè¿°"}]`;
    
    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        // ğŸ”¥ å…³é”®ï¼šç»™æ–°ç”Ÿæˆçš„å¯¹è±¡æ‰‹åŠ¨åŠ ä¸Šåˆå§‹å±æ€§ï¼Œé˜²æ­¢ undefined
        data.forEach(d => {
            d.avatar = "https://files.catbox.moe/fv8f8p.gif"; // é»˜è®¤å¤´åƒ
            d.affinity = Math.floor(Math.random() * 15); // åˆå§‹å¥½æ„Ÿ 0-15
            d.status = "ç›¸è¯†"; // åˆå§‹çŠ¶æ€
            d.logs = []; // åˆå§‹æ—¥å¿—ä¸ºç©º
        });
        
        currentHeir.dating.partners = data;
        saveHeirData();
        
        // åˆ·æ–°ç•Œé¢
        if(document.querySelector('.app-window')) openApp('matchmaker');
    } catch(e) {
        console.error("ç”Ÿæˆå¤±è´¥", e);
        auth.toast("âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key");
    }
}

// 2. åˆ·æ–°æŒ‰é’®é€»è¾‘
async function refreshPartners() {
    document.querySelector('.app-content').innerHTML = '<div style="text-align:center; padding:50px;">ğŸ’˜ æ­£åœ¨é‡æ–°å¯»è§…...</div>';
    await generatePartners();
}

// 3. æ‹†æ•£é€»è¾‘
function breakUp(idx) {
    var p = currentHeir.dating.partners[idx];
    // æˆåŠŸç‡ = äº²å¯†åº¦ - å›é€†å€¼
    if (currentHeir.params.affection > currentHeir.params.rebellion + 10) {
        auth.toast(`âœ… æˆåŠŸåŠé€€äº† ${p.name}ï¼`);
        currentHeir.dating.partners.splice(idx, 1);
        saveHeirData();
        openApp('matchmaker'); // åˆ·æ–°åˆ—è¡¨
    } else {
        auth.toast('âŒ å¤±è´¥ï¼çš‡å—£éå¸¸åæ„Ÿï¼(å›é€†+10)');
        currentHeir.params.rebellion += 10;
        saveHeirData();
    }
}

// 4. åŠ©æ”»é€»è¾‘
function assistLove(gift) {
    if(confirm(`ç¡®å®šè¦èŠ±é’±ä¹°ã€${gift}ã€‘ç»™çš‡å—£å»é€ç¤¼å—ï¼Ÿ`)) {
        auth.toast('ğŸ åŠ©æ”»æˆåŠŸï¼æ„Ÿæƒ…å‡æ¸©äº†ï¼');
    }
}

// ================= â¤ï¸ æ‹çˆ±äº’åŠ¨é€»è¾‘ (è¡¥å…¨åŒ…) =================

// 1. ğŸ’Œ æ¥è§¦/çº¦ä¼šé€»è¾‘ (AI ç”Ÿæˆå‰§æƒ…)
async function dateWithPartner() {
    // è·å–å½“å‰å¯¹è±¡
    if (currentPartnerIdx === -1 || !currentHeir.dating.partners[currentPartnerIdx]) return;
    var p = currentHeir.dating.partners[currentPartnerIdx];
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ éœ€è¦ API Key æ‰èƒ½çº¦ä¼šï¼'); return; }

    auth.toast(`ğŸ’Œ çš‡å—£æ­£åœ¨å’Œ ${p.name} æ¥è§¦ä¸­...`);

    // æ„å»º Prompt
    var prompt = `
    æˆ‘æ˜¯å¥³çš‡ã€‚
    ä¸»è§’ï¼šçš‡å—£ï¼ˆ${currentHeir.age}å²ï¼Œæ€§æ ¼ï¼š${JSON.stringify(currentHeir.params)}ï¼‰ã€‚
    å¯¹è±¡ï¼š${p.name}ï¼ˆèº«ä»½ï¼š${p.job}ï¼Œæ€§æ ¼ï¼š${p.desc}ï¼‰ã€‚
    å½“å‰å…³ç³»ï¼š${p.status} (å¥½æ„Ÿ ${p.affinity})ã€‚
    
    è¯·ç”Ÿæˆä¸€æ®µä¸¤äººäº’åŠ¨çš„ç®€çŸ­å‰§æƒ…ï¼ˆ50å­—å·¦å³ï¼‰ã€‚
    å¹¶æ ¹æ®äº’åŠ¨æƒ…å†µï¼Œåˆ¤æ–­å¥½æ„Ÿåº¦å˜åŒ–ï¼ˆ-10 åˆ° +10ï¼‰ã€‚
    
    æ ¼å¼ JSONï¼š{ "story": "å‰§æƒ…å†…å®¹", "score": 5 }
    `;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        // æ›´æ–°æ•°æ®
        p.affinity = Math.min(100, Math.max(-100, p.affinity + data.score)); // é™åˆ¶èŒƒå›´
        if (!p.logs) p.logs = [];
        p.logs.push({ date: `${currentHeir.age}å²Â·${currentHeir.season}`, content: data.story });
        
        // çŠ¶æ€åˆ¤å®šé€»è¾‘
        updateRelationshipStatus(p);
        
        saveHeirData();
        
        // åˆ·æ–°é¡µé¢ (å…³æ‰æ—§çš„ï¼Œé‡æ–°æ‰“å¼€)
        var oldWin = document.querySelector('.app-window.open');
        if (oldWin) oldWin.remove();
        openPartnerDetail(currentPartnerIdx); 
        
        auth.toast(data.score >= 0 ? 'ğŸ’– æ„Ÿæƒ…å‡æ¸©äº†ï¼' : 'ğŸ’” å‘ç”Ÿäº†ä¸€äº›ä¸æ„‰å¿«...');
        
    } catch(e) { console.error(e); auth.toast('âŒ çº¦ä¼šå¤±è´¥'); }
}

// 2. ğŸ’¬ å®¶é•¿å¹²æ¶‰é€»è¾‘ (ä½ è¦æ‰¾çš„æŒ‰é’®å°±æ˜¯è°ƒç”¨çš„è¿™ä¸ªï¼)
async function parentIntervene() {
    if (currentPartnerIdx === -1) return;
    var p = currentHeir.dating.partners[currentPartnerIdx];
    
    var text = prompt(`ä½ æƒ³å¯¹çš‡å—£è¯´ä»€ä¹ˆï¼Ÿ\n(ä¾‹å¦‚ï¼š"ç¦»ä»–è¿œç‚¹ï¼Œä»–æ˜¯åäºº" æˆ– "è¿™å­©å­ä¸é”™ï¼Œå¤šæ¥è§¦")`);
    if (!text) return;
    
    auth.toast('ğŸ’¬ æ­£åœ¨å¯¹çš‡å—£è¿›è¡Œè¯´æ•™...');
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var prompt = `
    æˆ‘æ˜¯å®¶é•¿ã€‚æˆ‘å¯¹çš‡å—£è¯´ï¼šâ€œ${text}â€ã€‚
    çš‡å—£å½“å‰åœ¨å’Œ ${p.name} äº¤å¾€ (å¥½æ„Ÿ ${p.affinity})ã€‚
    çš‡å—£çš„å›é€†å€¼æ˜¯ ${currentHeir.params.rebellion}ã€‚
    
    è¯·ç”Ÿæˆçš‡å—£çš„ååº”ã€‚
    å¹¶åˆ¤æ–­å¯¹è¿™æ®µå…³ç³»çš„å½±å“ï¼ˆå¦‚æœæ˜¯åŠåˆ†ï¼Œä¸”çš‡å—£å›é€†é«˜ï¼Œå¥½æ„Ÿåè€Œå¯èƒ½å¢åŠ ï¼›å¦‚æœæ˜¯åŠåˆï¼Œä¹Ÿçœ‹æ€§æ ¼ï¼‰ã€‚
    
    æ ¼å¼ JSONï¼š{ "reply": "çš‡å—£çš„å›å˜´", "score": -5 }
    `;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        
        alert(`çš‡å—£è¯´ï¼š\nâ€œ${data.reply}â€`);
        
        // æ›´æ–°æ•°æ®
        p.affinity = Math.min(100, Math.max(-100, p.affinity + data.score));
        
        // å¦‚æœæ˜¯è´Ÿé¢å¹²æ¶‰ï¼Œå¢åŠ å›é€†
        if (data.score < 0) currentHeir.params.rebellion = Math.min(100, currentHeir.params.rebellion + 5);
        
        updateRelationshipStatus(p);
        saveHeirData();
        
        // åˆ·æ–°
        var oldWin = document.querySelector('.app-window.open');
        if (oldWin) oldWin.remove();
        openPartnerDetail(currentPartnerIdx);
        
    } catch(e) {}
}

// 3. çŠ¶æ€åˆ¤å®šæœº (å¿…é¡»æœ‰è¿™ä¸ªï¼Œä¸ç„¶å…³ç³»çŠ¶æ€ä¸ä¼šå˜)
function updateRelationshipStatus(p) {
    if (p.affinity <= -20) {
        p.status = "æ–­è”"; 
        // å¦‚æœä¹‹å‰æ²¡æ–­è”ï¼ŒåŠ ä¸€æ¡æ—¥å¿—
        if (p.logs.length === 0 || !p.logs[p.logs.length-1].content.includes("æ–­ç»")) {
             p.logs.push({ date: "ç³»ç»Ÿ", content: "ğŸ’” å…³ç³»ç ´è£‚ï¼Œä»æ­¤é™Œè·¯ã€‚" });
        }
    } else if (p.affinity < 20) {
        p.status = "ç›¸è¯†";
    } else if (p.affinity < 60) {
        p.status = "æš§æ˜§";
    } else if (p.affinity < 90) {
        p.status = "æ‹çˆ±";
    } else {
        p.status = "çƒ­æ‹";
    }
}

// ================= ğŸ“ èŒä¸šä¸æˆå°±ç³»ç»Ÿ (å¼ºè¡Œè¦†ç›–è¡¥ä¸) =================

// 1. èŒä¸šæ•°æ®åº“ (æŒ‚è½½åˆ° windowï¼Œé˜²æ­¢é‡å¤æŠ¥é”™)
window.CAREER_DB = [
    // ğŸ‘‘ çš‡æƒ
    { name: "çš‡å¸", type: "royal", req: { ambition: 90, wisdom: 80 } },
    { name: "æ‘„æ”¿ç‹", type: "royal", req: { ambition: 85, fitness: 80 } },
    { name: "çš‡å", type: "royal", req: { charm: 90, morality: 80 } },
    { name: "å’Œäº²å…¬ä¸»", type: "royal", req: { charm: 80, rebellion: -1 } },
    // âš”ï¸ æ­¦å®˜
    { name: "å¤§å°†å†›", type: "good", req: { fitness: 90, rebellion: 60 } },
    { name: "å¾¡å‰ä¾å«", type: "good", req: { fitness: 80, morality: 80 } },
    { name: "åˆºå®¢", type: "bad", req: { fitness: 85, morality: 20 } },
    // ğŸ“š æ–‡å®˜
    { name: "å®°ç›¸", type: "good", req: { wisdom: 95, morality: 60 } },
    { name: "å¤ªåŒ»", type: "good", req: { wisdom: 80, morality: 80 } },
    { name: "çŠ¶å…ƒéƒ", type: "good", req: { diligence: 90, wisdom: 80 } },
    { name: "å¤§è¯—äºº", type: "good", req: { wisdom: 80, charm: 70 } },
    // ğŸ’° å¸‚äº•
    { name: "çš‡å•†é¦–å¯Œ", type: "good", req: { wisdom: 70, ambition: 80 } },
    { name: "é’æ¥¼å¤´ç‰Œ", type: "bad", req: { charm: 90, morality: 30 } },
    // ğŸšï¸ åº•å±‚
    { name: "å¾—é“é«˜åƒ§", type: "good", req: { ambition: 10, morality: 90 } },
    { name: "ç§ç”°å†œå¤«", type: "normal", req: { fitness: 50 } },
    { name: "ä¹ä¸", type: "bad", req: { diligence: 10, wisdom: 10 } },
    { name: "å¹³æ°‘", type: "normal", req: {} }
];

// 2. æˆå°±æ•°æ®åº“
window.ACHIEVEMENT_DB = [
    { name: "ç»ä¸–æƒ…åœ£", req: function(h){ return h.dating && h.dating.partners.length > 5; } },
    { name: "æ³¨å­¤ç”Ÿ", req: function(h){ return (!h.dating || h.dating.partners.length === 0) && h.age > 20; } },
    { name: "å¯Œå¯æ•Œå›½", req: function(h){ return h.career === "çš‡å•†é¦–å¯Œ"; } },
    { name: "åƒå¤ä¸€å¸", req: function(h){ return h.career === "çš‡å¸"; } },
    { name: "é€†å­", req: function(h){ return h.params.rebellion > 95; } },
    { name: "å¦ˆå®", req: function(h){ return h.params.affection > 95; } },
    { name: "ä½“å¼±å¤šç—…", req: function(h){ return h.body.health < 40; } },
    { name: "æ­¦æ—ç¥è¯", req: function(h){ return h.params.fitness > 95; } },
    { name: "æ™ºå¤šæ˜Ÿ", req: function(h){ return h.params.wisdom > 95; } },
    { name: "ä¸‡äººè¿·", req: function(h){ return h.params.charm > 95; } }
];

// 3. å®¶æ—æ ‘åˆå§‹åŒ–
if (!window.familyTree) {
    window.familyTree = JSON.parse(localStorage.getItem('royal_family_tree')) || [];
}

// 4. æ£€æŸ¥æˆå°±å‡½æ•°
window.checkAchievements = function() {
    if (!currentHeir) return;
    if (!currentHeir.achievements) currentHeir.achievements = [];
    
    window.ACHIEVEMENT_DB.forEach(function(ach) {
        if (!currentHeir.achievements.includes(ach.name) && ach.req(currentHeir)) {
            currentHeir.achievements.push(ach.name);
            auth.toast("ğŸ† è§£é”æˆå°±ï¼šã€" + ach.name + "ã€‘");
        }
    });
};

// 5. å®¶æ—å½’æ¡£å‡½æ•°
window.archiveHeirToFamily = function(heir) {
    var existingIndex = window.familyTree.findIndex(function(h){ return h.id === heir.id; });
    if (existingIndex !== -1) window.familyTree[existingIndex] = heir;
    else window.familyTree.push(heir);
    localStorage.setItem('royal_family_tree', JSON.stringify(window.familyTree));
};

// 6. ç”Ÿæˆç¦»åˆ«ä¿¡ (AI)
window.generateCareerStory = async function(job) {
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { 
        var letterEl = document.getElementById('careerLetter');
        if(letterEl) letterEl.innerHTML = "ï¼ˆå­©å­é»˜é»˜åœ°èµ°äº†ï¼Œå»è¿½å¯»ã€" + job + "ã€‘çš„é“è·¯...ï¼‰"; 
        return; 
    }
    
    var prompt = "æˆ‘æ˜¯å¥³çš‡ã€‚çš‡å—£ã€" + currentHeir.name + "ã€‘18å²æˆå¹´ï¼Œæˆä¸ºäº†ã€" + job + "ã€‘ã€‚è¯·ä»¥ç¬¬ä¸€äººç§°å†™ä¸€å°ç»™æˆ‘çš„â€œç¦»å®¶å‘Šåˆ«ä¿¡â€ï¼ˆ100å­—ï¼‰ã€‚åŒ…å«å¯¹èŒä¸šçš„çœ‹æ³•ã€å›å¿†å’Œå¯¹æ¯äº²çš„æ„Ÿæƒ…ã€‚";
    
    try {
        var res = await fetchAI(prompt, config);
        var letterEl = document.getElementById('careerLetter');
        if(letterEl) letterEl.innerHTML = res.replace(/\n/g, '<br>');
        
        currentHeir.bioLog.push("ã€18å²Â·ç»“å±€ã€‘ï¼š" + res); 
        saveHeirData();
    } catch(e) {}
};

// 7. æ‰“å¼€æˆäººç¤¼ç»“ç®—ç•Œé¢
window.openAdultCeremony = function() {
    // å…³é—­æ‰€æœ‰å¼¹çª—
    document.querySelectorAll('.modal-overlay').forEach(function(el){ el.classList.remove('active'); });
    
    // èŒä¸šåˆ¤å®š
    var bestCareer = window.CAREER_DB[window.CAREER_DB.length - 1]; 
    for (var i = 0; i < window.CAREER_DB.length; i++) {
        var job = window.CAREER_DB[i];
        var qualified = true;
        for (var reqKey in job.req) {
            var val = currentHeir.params[reqKey] || 0;
            if (val < job.req[reqKey]) { qualified = false; break; }
        }
        if (qualified) { bestCareer = job; break; }
    }

    currentHeir.career = bestCareer.name;
    archiveHeirToFamily(currentHeir);
    saveHeirData();

    // æ¸²æŸ“ç•Œé¢
    var modal = document.querySelector('#eastPalaceModal .modal');
    modal.className = "modal adult-modal"; // åˆ‡æ¢æ ·å¼
    document.getElementById('eastPalaceModal').classList.add('active');

    // è¿›åº¦æ¡ HTML
    var judgeHtml = bestCareer.name === "å¹³æ°‘" ? "<div style='text-align:center;color:#999;font-size:12px;'>å¹³å¹³æ·¡æ·¡æ‰æ˜¯çœŸ...</div>" : "";
    if (bestCareer.name !== "å¹³æ°‘") {
        for (var key in bestCareer.req) {
            var reqVal = bestCareer.req[key];
            var curVal = currentHeir.params[key] || 0;
            var isPass = curVal >= reqVal;
            var pct = Math.min(100, (curVal / 120) * 100);
            
            var labelMap = {wisdom:'æ™ºæ…§',fitness:'ä½“é­„',charm:'é­…åŠ›',diligence:'å‹¤å‹‰',rebellion:'å›é€†',morality:'é“å¾·',ambition:'é‡å¿ƒ',affection:'äº²å¯†'};
            var label = labelMap[key] || key;

            judgeHtml += "<div class='judge-row'><span class='judge-label'>" + label + "</span><div class='judge-track'><div class='judge-bar " + (isPass?'pass':'fail') + "' style='width:" + pct + "%'></div></div><div class='judge-val'>" + curVal + "/" + reqVal + (isPass?"âœ…":"âŒ") + "</div></div>";
        }
    }

    var achHtml = currentHeir.achievements.map(function(a){ return "<span class='ach-badge'>ğŸ† " + a + "</span>"; }).join('') || "<span style='color:#ccc;font-size:12px;'>(æ— ç‰¹æ®Šæˆå°±)</span>";

    modal.innerHTML = `
        <div class="adult-header">âœ¨ å† ç¤¼ Â· æˆäººç»“ç®— âœ¨</div>
        <div class="adult-content">
            <div class="career-card-large">
                <div class="career-icon-big">ğŸ“</div>
                <div class="career-title-big">${bestCareer.name}</div>
                <div class="career-desc">å‰ç¨‹ä¼¼é”¦ï¼Œæœªæ¥å¯æœŸã€‚</div>
            </div>
            <div class="judge-box"><div class="judge-title">ğŸ“‹ èµ„è´¨åˆ¤å®š</div>${judgeHtml}</div>
            <div class="judge-box" style="border-left:3px solid #ff9a9e;"><div class="judge-title">ğŸ… äººç”Ÿæˆå°±</div><div class="achievement-grid">${achHtml}</div></div>
            <div class="judge-box" style="background:#fffbf0; border:none;"><div class="judge-title">ğŸ’Œ ç¦»å®¶ç•™è¨€</div><div id="careerLetter" class="farewell-letter"><div style="text-align:center;">âœï¸ æ­£åœ¨å†™ä¿¡...</div></div></div>
            <button onclick="closeEastPalace(); location.reload();" class="primary-btn" style="width:100%; margin-top:20px; padding:15px; font-size:16px;">ğŸ‘‹ å­©å­é•¿å¤§äº† (å½’æ¡£å¹¶å…è®¸äºŒèƒ)</button>
        </div>
    `;

    generateCareerStory(bestCareer.name);
};

// 8. é•¿å¤§ä¸€å² (è¦†ç›–ç‰ˆ)
window.advanceYear = function() {
    if (currentHeir.isDead) return;
    
    checkAchievements();

    // 17 -> 18å² è§¦å‘æˆäººç¤¼
    if (currentHeir.age === 17) {
        currentHeir.age = 18;
        openAdultCeremony();
        return;
    }

    if (currentHeir.age >= 18) {
        auth.toast('ğŸ“ å­©å­å·²æˆå¹´åœ¨å¤–æ‰“æ‹¼...');
        currentHeir.age += 1;
    } else {
        currentHeir.age += 1;
        currentHeir.season = 'æ˜¥';
        currentHeir.body.height += 3;
        currentHeir.body.weight += 1;
    }

    currentHeir.bioLog.push("â€”â€”â€” " + currentHeir.age + " å² â€”â€”â€”");
    saveHeirData();
    openEastPalace();
    
    if(typeof checkDeath === 'function') checkDeath();
    if(typeof writeDailyDiary === 'function') writeDailyDiary();
};

// ================= ğŸ“± æ‰‹æœºAPP ä¿®å¤è¡¥ä¸ (ç›‘æŠ¤äºº+å•†åº—) =================

// 1. é€šç”¨è·¯ç”±ä¿®å¤ (è§£å†³ç‚¹å›¾æ ‡æ²¡ååº”)
window.openApp = function(name) {
    var win = document.getElementById('activeAppWindow');
    if (!win) return; // é˜²æ­¢æŠ¥é”™
    win.innerHTML = '';
    
    var appDiv = document.createElement('div');
    appDiv.className = 'app-window';
    appDiv.style.background = "#f7f9fc"; 
    
    if (name === 'wechat') {
        if(typeof renderWeChat === 'function') renderWeChat(appDiv);
    } 
    else if (name === 'clothing') {
        if(typeof renderClothingApp === 'function') renderClothingApp(appDiv);
    } 
    else if (name === 'spyware') {
        renderSpywareApp(appDiv); // ä¿®å¤ç›‘æŠ¤äºº
    } 
    else if (name === 'matchmaker') {
        if(typeof renderMatchmakerApp === 'function') renderMatchmakerApp(appDiv);
    }
    
    win.appendChild(appDiv);
    requestAnimationFrame(function() { appDiv.classList.add('open'); });
};

// 2. ğŸ•µï¸ ç›‘æŠ¤äººé€»è¾‘ (å·çœ‹æ—¥è®°)
window.renderSpywareApp = function(container) {
    // å¦‚æœæ²¡æ—¥è®°ï¼Œç”Ÿæˆä¸€æ¡é»˜è®¤çš„
    if(!currentHeir.diary || currentHeir.diary.length === 0) {
        currentHeir.diary.push({ date: "æ˜¨æ—¥", content: "ä»Šå¤©å®¶é•¿å¥½åƒå¾ˆå¿™..." });
    }

    var html = currentHeir.diary.slice().reverse().map(function(d) {
        return `<div class="diary-paper" style="background:#fffbf0; padding:12px; margin-bottom:10px; border-radius:6px; border-left:3px solid #ffb7c5; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <div style="font-size:12px; color:#999; border-bottom:1px dashed #ccc; margin-bottom:5px;">${d.date}</div>
            <div style="font-size:13px; color:#555; line-height:1.5;">${d.content}</div>
        </div>`;
    }).join('');
    
    container.innerHTML = `<div class="app-header"><button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button><span style="flex:1;text-align:center;">ç›‘æŠ¤äºº Pro</span><span style="width:20px;"></span></div><div class="app-content" style="padding:15px;background:#f0f0f0;"><div style="font-weight:bold;margin-bottom:10px;color:#333;">ğŸ“– ç§å¯†æ—¥è®°æœ¬</div>${html}</div>`;
};

// 3. ğŸ›ï¸ å•†åº—å…¥å£ (ä¿®å¤å¤ªåŒ»å±€/çå®é˜/å¾¡è†³æˆ¿)
window.openShopApp = async function(type, title) {
    var win = document.getElementById('activeAppWindow');
    if (!win) return;
    win.innerHTML = '';
    
    var appDiv = document.createElement('div');
    appDiv.className = 'app-window';
    appDiv.style.background = "#f7f9fc"; 

    // è·å–ç¼“å­˜æ•°æ®
    if (!currentHeir.phoneData) currentHeir.phoneData = { shops: { hospital:[], shop:[], meituan:[] } };
    var items = currentHeir.phoneData.shops[type] || [];
    
    appDiv.innerHTML = `
        <div class="app-header">
            <button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>
            <span style="flex:1; text-align:center;">${title}</span>
            <button class="app-header-btn" onclick="refreshShopItems('${type}', '${title}')">ğŸ”„</button>
        </div>
        <div class="app-content" id="shopContent-${type}" style="padding:15px; overflow-y:auto; flex:1;">
            ${items.length === 0 ? '<div style="text-align:center; padding:50px; color:#999;">æš‚æ— å•†å“<br>ç‚¹å‡»å³ä¸Šè§’è¿›è´§</div>' : renderShopList(items, type)}
        </div>
        <div id="itemDetailModal" class="item-detail-overlay"></div>
    `;
    win.appendChild(appDiv);
    requestAnimationFrame(function() { appDiv.classList.add('open'); });
    
    if(items.length === 0) refreshShopItems(type, title);
};

// 4. æ¸²æŸ“å•†åº—åˆ—è¡¨
window.renderShopList = function(items, type) {
    return items.map(function(item, idx) {
        var thought = getHeirThought(item.name, type);
        var icon = item.icon || 'ğŸ“¦';
        return `
        <div class="shop-item" onclick="showItemDetail('${type}', ${idx})" style="background:white; padding:10px; margin-bottom:10px; border-radius:10px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <div style="flex:1;">
                <div style="font-weight:bold; font-size:13px;">${item.name} ${icon}</div>
                <div style="font-size:10px; color:#999; margin-bottom:4px;">${item.effectDesc}</div>
                <div class="heir-thought" style="background:#fff0f5; color:#d66a80; font-size:10px; padding:4px 8px; border-radius:8px; margin-top:5px; position:relative; font-style:italic;">ğŸ’­ ${thought}</div>
            </div>
            <button class="shop-btn" style="background:#74b9ff; color:white; border:none; padding:5px 10px; border-radius:15px; cursor:pointer; margin-left:10px;" onclick="event.stopPropagation(); buyAIItem('${type}', ${idx})">è´­ä¹°</button>
        </div>`;
    }).join('');
};

// 5. å•†åº—è¾…åŠ©å‡½æ•° (çš‡å—£æƒ³æ³•ã€åˆ·æ–°ã€è´­ä¹°)
window.getHeirThought = function(name, type) {
    if (type === 'hospital') return currentHeir.body.sick ? "æˆ‘æƒ³å¿«ç‚¹å¥½..." : "æ²¡ç—…ä¸åƒè¯ï¼";
    if (type === 'meituan') return "çœ‹èµ·æ¥å¥½å¥½åƒï¼";
    if (name.includes("ä¹¦")) return currentHeir.params.diligence > 60 ? "è¿™æœ¬ä¹¦æˆ‘æ‰¾äº†å¥½ä¹…ï¼" : "å•Š...åˆæ˜¯ä¹¦...";
    return "è¿™ä¸ªçœ‹èµ·æ¥ä¸é”™ã€‚";
};

window.refreshShopItems = async function(type, title) {
    var div = document.getElementById(`shopContent-${type}`);
    div.innerHTML = '<div style="text-align:center; padding:50px;">ğŸ¤– æ­£åœ¨è¿›è´§ä¸­...</div>';
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if(!config || !config.apiKey) { div.innerHTML = 'ğŸš« è¯·å…ˆé…ç½® API Key'; return; }

    var prompt = `ç”Ÿæˆ3ä¸ª${title}å•†å“ã€‚JSONæ ¼å¼:[{"name":"åç§°","icon":"emoji","effectDesc":"åŠŸæ•ˆ","detail":"è¯¦ç»†ä»‹ç»(50å­—)"}]`;
    
    try {
        var res = await fetchAI(prompt, config);
        var newItems = JSON.parse(res.replace(/```json/g,'').replace(/```/g,'').trim());
        currentHeir.phoneData.shops[type] = newItems;
        saveHeirData();
        div.innerHTML = renderShopList(newItems, type);
    } catch(e) { div.innerHTML = 'âŒ è¿›è´§å¤±è´¥'; }
};

window.showItemDetail = function(type, idx) {
    var item = currentHeir.phoneData.shops[type][idx];
    var overlay = document.getElementById('itemDetailModal');
    overlay.innerHTML = `
        <button class="app-header-btn" style="position:absolute; right:15px; top:15px; border:none; font-size:24px; background:none;" onclick="document.getElementById('itemDetailModal').classList.remove('show')">Ã—</button>
        <div class="item-big-icon" style="font-size:60px; text-align:center; margin-top:30px;">${item.icon}</div>
        <h2 style="text-align:center; color:#d66a80;">${item.name}</h2>
        <div style="text-align:center; color:#999; margin-bottom:20px;">${item.effectDesc}</div>
        <div style="background:#f9f9f9; padding:15px; border-radius:15px; font-size:13px; color:#555; line-height:1.6;">
            ${item.detail || "æš‚æ— è¯¦ç»†ä»‹ç»..."}
        </div>
        <button class="shop-btn" style="width:100%; margin-top:20px; padding:12px; background:#74b9ff; color:white; border:none; border-radius:20px; font-weight:bold;" onclick="buyAIItem('${type}', ${idx}); document.getElementById('itemDetailModal').classList.remove('show')">ç«‹å³è´­ä¹°ä½¿ç”¨</button>
    `;
    requestAnimationFrame(function() { overlay.classList.add('show'); });
};

window.buyAIItem = function(type, idx) {
    var item = currentHeir.phoneData.shops[type][idx];
    if(type==='hospital') { currentHeir.body.health = 100; if(item.name.includes('ç¥')) currentHeir.body.sick = false; }
    if(type==='shop') currentHeir.mood = Math.min(100, currentHeir.mood + 10);
    if(type==='meituan') currentHeir.body.waste = Math.max(0, currentHeir.body.waste - 20);
    
    saveHeirData();
    auth.toast(`âœ¨ æˆåŠŸè´­ä¹°å¹¶ä½¿ç”¨äº†ã€${item.name}ã€‘ï¼`);
};

// ================= ğŸ•µï¸ ç›‘æŠ¤äºº APP å¼ºåŠ›ä¿®å¤è¡¥ä¸ =================

// 1. å¼ºåˆ¶è¦†ç›–æ¸²æŸ“é€»è¾‘ (å¸¦æ•°æ®è‡ªåŠ¨ä¿®å¤)
window.renderSpywareApp = function(container) {
    // ğŸš‘ æ•‘æ€¥ï¼šå¦‚æœæ•°æ®ä¸å­˜åœ¨ï¼Œç«‹åˆ»è¡¥å…¨
    if (!currentHeir) return;
    if (!currentHeir.diary) currentHeir.diary = [];
    
    // å¦‚æœæ—¥è®°æ˜¯ç©ºçš„ï¼Œè‡ªåŠ¨å†™ä¸€æ¡åˆå§‹æ—¥è®°ï¼Œé˜²æ­¢ç©ºç™½éš¾çœ‹
    if (currentHeir.diary.length === 0) {
        currentHeir.diary.push({ 
            date: "æ˜¨æ—¥", 
            content: "ç»™æˆ‘çš„æ‰‹æœºè£…äº†å¥½å¤šå¥‡æ€ªçš„è½¯ä»¶...è¿™å°±æ˜¯å¤§äººçš„ä¸–ç•Œå—ï¼Ÿ" 
        });
        saveHeirData(); // ä¿å­˜ä¿®å¤åçš„æ•°æ®
    }

    // ç”Ÿæˆåˆ—è¡¨ HTML
    var listHtml = currentHeir.diary.slice().reverse().map(function(d) {
        return `
        <div class="diary-paper" style="background:#fffbf0; padding:12px; margin-bottom:10px; border-radius:6px; border-left:3px solid #ffb7c5; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <div style="font-size:12px; color:#999; border-bottom:1px dashed #ccc; margin-bottom:5px;">${d.date}</div>
            <div style="font-size:13px; color:#555; line-height:1.5;">${d.content}</div>
        </div>`;
    }).join('');
    
    // æ¸²æŸ“ç•Œé¢
    container.innerHTML = `
        <div class="app-header">
            <button class="app-header-btn" onclick="this.parentElement.parentElement.remove()">â€¹</button>
            <span style="flex:1; text-align:center;">ç›‘æŠ¤äºº Pro</span>
            <span style="width:20px;"></span>
        </div>
        <div class="app-content" style="padding:15px; background:#f0f0f0;">
            <div style="font-size:12px; color:#666; margin-bottom:10px;">ğŸ“Š æ­£åœ¨åŒæ­¥çš‡å—£è®¾å¤‡æ•°æ®...</div>
            <div style="font-weight:bold; margin-bottom:5px; color:#333;">ğŸ“– ç§å¯†æ—¥è®°æœ¬ (å·²ç ´è§£)</div>
            ${listHtml}
        </div>
    `;
};

// 2. ç¡®ä¿è·¯ç”±èƒ½æ‰¾åˆ°å®ƒ (å†æ¬¡ç¡®è®¤)
// å¦‚æœä½ ä¹‹å‰çš„ openApp æ²¡å†™å¯¹ï¼Œè¿™æ®µä¼šå¼ºåˆ¶ä¿®æ­£å®ƒ
var originalOpenApp = window.openApp; 
window.openApp = function(name) {
    // å¦‚æœæ˜¯ç›‘æŠ¤äººï¼Œç›´æ¥è°ƒç”¨ä¸Šé¢çš„ä¿®å¤ç‰ˆå‡½æ•°
    if (name === 'spyware') {
        var win = document.getElementById('activeAppWindow');
        if (!win) return;
        win.innerHTML = '';
        var appDiv = document.createElement('div');
        appDiv.className = 'app-window';
        appDiv.style.background = "#f7f9fc";
        
        renderSpywareApp(appDiv); // è°ƒç”¨ä¿®å¤åçš„å‡½æ•°
        
        win.appendChild(appDiv);
        requestAnimationFrame(function() { appDiv.classList.add('open'); });
    } else {
        // å…¶ä»–è½¯ä»¶ç…§å¸¸è¿è¡Œ
        if (originalOpenApp) originalOpenApp(name);
    }
};

// ================= ğŸ‘‘ çš‡å—£ä»£ç ç»“æŸ =================

// ================= ğŸ¨ ç»ˆæå†™å¡å™¨é€»è¾‘ (æ•´åˆç‰ˆ) =================

// 0. æ•°æ®ä¸æ ‡ç­¾
const WIZARD_TAGS = {
    identity: ["å…¬ä¸»", "å¥³ä»†", "éª‘å£«", "æ€æ‰‹", "é’æ¢…ç«¹é©¬", "ç»§å¦¹", "æ¶å½¹åƒé‡‘", "æ€»è£", "æ ¡èŠ±", "å¸ˆå°Š"],
    personality: ["å‚²å¨‡", "ç—…å¨‡", "æ¸©æŸ”", "é«˜å†·", "è…¹é»‘", "å…ƒæ°”", "ä¸‰æ— ", "æ¯’èˆŒ", "å¼±æ°”", "å¥³ç‹"],
    trope: ["å…½è€³(çŒ«å¨˜)", "ç™½æ¯›", "å¼‚ç³", "é»‘ä¸", "å£ç™–", "å€’è´´", "åŒé‡äººæ ¼", "è™½ç„¶ç©·ä½†å¿—æ®‹åš"]
};

// å…¨å±€å˜é‡ï¼šå­˜å‚¨æ­£åˆ™è„šæœ¬
window.currentCardRegexes = [];

// 1. åˆå§‹åŒ– (æ‰“å¼€æ—¶è°ƒç”¨)

/* ================= ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šå†™å¡å™¨æ‰“å¼€é€»è¾‘ (è§£é™¤æ­»é”) ================= */
window.openCardCreator = function() {
    // 1. å…ˆæŠŠæ‚¬æµ®èœå•æ”¶èµ·æ¥
    var menu = document.getElementById('floatMenu');
    if (menu) menu.classList.remove('active');
    
    var modal = document.getElementById('cardCreatorModal');
    if (modal) {
        // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶æ¸…é™¤ "display: none" å†…è”æ ·å¼
        // è¿™è¡Œä»£ç ä¼šè§£å¼€ä¹‹å‰çš„â€œæ­»é”â€ï¼Œè®© active ç±»é‡æ–°ç”Ÿæ•ˆ
        modal.style.display = ''; 
        
        // 2. æ¿€æ´»å¼¹çª—
        modal.classList.add('active');
        
        // 3. åˆ·æ–°é‡Œé¢çš„å†…å®¹ (é˜²æ­¢ç©ºç™½)
        if(typeof renderWizardTags === 'function') renderWizardTags();
        if(typeof renderRegexList === 'function') renderRegexList();
    } else {
        alert("âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°å†™å¡å™¨å¼¹çª— (id='cardCreatorModal')");
    }
};


window.toggleGuideModal = function() {
    var m = document.getElementById('guideModal');
    if(m) m.classList.toggle('active');
};

// 2. æ¸²æŸ“å·¦ä¾§æ ‡ç­¾
function renderWizardTags() {
    renderTagGroup('tagGroupIdentity', WIZARD_TAGS.identity, true);
    renderTagGroup('tagGroupPersonality', WIZARD_TAGS.personality, false);
    renderTagGroup('tagGroupTrope', WIZARD_TAGS.trope, false);
}

function renderTagGroup(id, tags, isSingle) {
    const container = document.getElementById(id);
    if (container.children.length > 0) return; // é¿å…é‡å¤æ¸²æŸ“
    
    tags.forEach(t => {
        const span = document.createElement('span');
        span.className = 'wizard-tag';
        span.textContent = t;
        span.onclick = function() {
            if (isSingle) {
                Array.from(container.children).forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
            } else {
                this.classList.toggle('selected');
            }
        };
        container.appendChild(span);
    });
}

// 3. âœ¨ AI ä¸€é”®ç”Ÿæˆ
window.generateCardFromTags = async function() {
    // æ”¶é›†æ ‡ç­¾
    const getSelected = (id) => Array.from(document.getElementById(id).children).filter(c => c.classList.contains('selected')).map(c => c.textContent);
    const identities = getSelected('tagGroupIdentity');
    const personalities = getSelected('tagGroupPersonality');
    const tropes = getSelected('tagGroupTrope');
    const name = document.getElementById('cardName').value.trim();

    if (identities.length === 0 && personalities.length === 0) { auth.toast('è¯·è‡³å°‘é€‰ä¸€ä¸ªæ ‡ç­¾å§ï¼'); return; }

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·å…ˆé…ç½® API Key'); return; }

    var btn = document.getElementById('btnGenWizard');
    var oldText = btn.innerText;
    btn.innerText = 'ğŸ§  åˆ›ä½œä¸­...'; btn.disabled = true;

    var prompt = `è¯·è®¾è®¡è§’è‰²ï¼šåå­—${name||'è‡ªæ‹Ÿ'}ï¼Œèº«ä»½${identities}ï¼Œæ€§æ ¼${personalities}ï¼Œå±æ€§${tropes}ã€‚è¿”å›JSON:{ "name":"", "description":"è¯¦ç»†è®¾å®š(500å­—)", "first_mes":"å¼€åœºç™½", "mes_example":"å¯¹è¯æ ·æœ¬", "scenario":"åœºæ™¯" }`;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());

        document.getElementById('cardName').value = data.name || '';
        document.getElementById('cardDesc').value = data.description || '';
        document.getElementById('cardFirstMes').value = data.first_mes || '';
        document.getElementById('cardScenario').value = data.scenario || '';
        document.getElementById('cardMesExample').value = data.mes_example || '';
        
        updatePreviewUI();
        switchCardTab('preview');
        auth.toast('âœ¨ ç”Ÿæˆå®Œæ¯•ï¼');
    } catch (e) { auth.toast('âŒ ç”Ÿæˆå¤±è´¥'); } 
    finally { btn.innerText = oldText; btn.disabled = false; }
};

// 4. Tab åˆ‡æ¢
window.switchCardTab = function(name) {
    document.querySelectorAll('.card-tab-content').forEach(d => d.style.display='none');
    document.querySelectorAll('.card-tab').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-'+name).style.display = 'block';
    if(event && event.target) event.target.classList.add('active');
    
    if(name === 'source') updateJsonSource();
};

// 5. ğŸ› ï¸ æ­£åˆ™ä¸å‰ç«¯å¼€å‘é€»è¾‘
window.switchRegexUI = function(mode) {
    document.getElementById('uiSimpleMode').style.display = mode === 'simple' ? 'block' : 'none';
    document.getElementById('uiFrontendMode').style.display = mode === 'frontend' ? 'block' : 'none';
};

// æ¨¡æ¿åº“
var SNIPPETS = {
    'status': { name: "RPGçŠ¶æ€æ ", regex: "/\\[STATS\\]/g", code: "<style>\n.rpg-status-bar { \n    background: rgba(0,0,0,0.8); color: #fff; padding: 10px; border-radius: 8px; border: 1px solid #ffd700; \n    font-family: monospace; box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);\n}\n.hp-bar { height:5px; background:#ff4757; width:80%; margin-top:5px; }\n</style>\n<div class=\"rpg-status-bar\">\n    <div>ğŸ©¸ HP: 800/1000</div>\n    <div class=\"hp-bar\"></div>\n    <div>âš”ï¸ ATK: 250 | ğŸ›¡ï¸ DEF: 180</div>\n</div>" },
    'bubble': { name: "æ°”æ³¡ç¾åŒ–", regex: "/^(.+)$/gm", code: "<div style=\"background:linear-gradient(135deg, #fdfbfb, #ebedee); padding:10px; border-radius:10px; border-left:4px solid #6c5ce7; color:#333; margin-bottom:5px; box-shadow:2px 2px 5px rgba(0,0,0,0.1);\">\n    $1\n</div>" },
    'hidden': { name: "éšè—æ€ç»´é“¾", regex: "/\\(æ€è€ƒ:.*?\\)/gs", code: "<div style=\"display:none;\">$&</div>" },
    'img': { name: "åŠ¨æ€æ’å›¾", regex: "/\\[IMG:(\\w+)\\]/g", code: "<img src=\"https://files.catbox.moe/$1.png\" style=\"width:100%; border-radius:10px; border:2px solid #fff; box-shadow:0 5px 15px rgba(0,0,0,0.2);\">" }
};

window.insertSnippet = function(key) {
    var s = SNIPPETS[key];
    document.getElementById('frontName').value = s.name;
    document.getElementById('frontPattern').value = s.regex;
    document.getElementById('frontReplace').value = s.code;
    auth.toast('ğŸ“š æ¨¡æ¿å·²åŠ è½½');
};

window.addSimpleRegex = function() {
    var pat = document.getElementById('simplePattern').value;
    var rep = document.getElementById('simpleReplace').value;
    if(!pat) return;
    var safePat = pat.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    addScriptItem('æ›¿æ¢"' + pat + '"', '/' + safePat + '/g', rep);
    document.getElementById('simplePattern').value = '';
    document.getElementById('simpleReplace').value = '';
};

window.addFrontendRegex = function() {
    var name = document.getElementById('frontName').value || 'å‰ç«¯è„šæœ¬';
    var pat = document.getElementById('frontPattern').value;
    var rep = document.getElementById('frontReplace').value;
    if(!pat) { auth.toast('âŒ æ­£åˆ™ä¸èƒ½ä¸ºç©º'); return; }
    addScriptItem(name, pat, rep);
    auth.toast('ğŸš€ è„šæœ¬å·²æ³¨å…¥');
};

function addScriptItem(name, regex, replace) {
    window.currentCardRegexes.push({ scriptName: name, regex: regex, regexReplacementString: replace, regexPlacement: [1] });
    renderRegexList();
    runRegexTest();
}

window.renderRegexList = function() {
    var list = document.getElementById('regexListArea');
    if(!list) return;
    list.innerHTML = '';
    window.currentCardRegexes.forEach((item, idx) => {
        var div = document.createElement('div');
        div.className = 'regex-item';
        var shortCode = item.regexReplacementString.length > 50 ? item.regexReplacementString.substring(0, 50)+'...' : item.regexReplacementString;
        div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><span style="font-weight:bold; color:#6c5ce7;">${item.scriptName}</span><button onclick="removeRegex(${idx})" style="border:none; color:#ff6b6b; background:none; cursor:pointer;">ğŸ—‘ï¸</button></div><div style="font-size:11px; color:#555; margin-top:2px; font-family:monospace;"><span style="color:#e06c75;">${item.regex}</span> â” <span style="color:#98c379;">${shortCode.replace(/</g, '&lt;')}</span></div>`;
        list.appendChild(div);
    });
};

window.removeRegex = function(idx) {
    window.currentCardRegexes.splice(idx, 1);
    renderRegexList();
    runRegexTest();
};

window.runRegexTest = function() {
    var inputStr = document.getElementById('regexTestInput').value;
    var outputDiv = document.getElementById('regexTestOutput');
    if (!inputStr) { outputDiv.innerHTML = "<span style='color:#666'>ç­‰å¾…è¾“å…¥...</span>"; return; }
    var resultStr = inputStr;
    window.currentCardRegexes.forEach(script => {
        try {
            var parts = script.regex.match(/\/(.*)\/(.*)/);
            var regexObj = parts ? new RegExp(parts[1], parts[2]) : new RegExp(script.regex, "g");
            resultStr = resultStr.replace(regexObj, script.regexReplacementString);
        } catch (e) { console.error("æ­£åˆ™é”™è¯¯", e); }
    });
    outputDiv.innerHTML = resultStr; // HTML æ¸²æŸ“
};

// 6. è¾…åŠ©ï¼šå¤´åƒå’Œé¢„è§ˆ
window.handleCardAvatar = function(i) {
    if(i.files[0]) { var r = new FileReader(); r.onload=e=>{
        document.getElementById('cardAvatarPreview').src=e.target.result;
        document.getElementById('cardAvatarPreview').style.display='block';
        document.getElementById('cardAvatarHint').style.display='none';
        updatePreviewUI();
    }; r.readAsDataURL(i.files[0]); }
};

window.updatePreviewUI = function() {
    document.getElementById('previewHeaderName').innerText = document.getElementById('cardName').value || 'è§’è‰²å';
    document.getElementById('previewText').innerText = document.getElementById('cardFirstMes').value || '...';
    var src = document.getElementById('cardAvatarPreview').src;
    if(src && src.startsWith('data:')) {
        document.getElementById('previewAvatarSmall').src = src;
        document.getElementById('previewAvatarSmall').style.display = 'block';
    }
};

// 7. å¯¼å‡ºä¸æºç 
window.updateJsonSource = function() {
    var d = {
        name: document.getElementById('cardName').value,
        description: document.getElementById('cardDesc').value,
        first_mes: document.getElementById('cardFirstMes').value,
        mes_example: document.getElementById('cardMesExample').value,
        scenario: document.getElementById('cardScenario').value,
        creator_notes: document.getElementById('cardNote').value,
        extensions: { regex_scripts: window.currentCardRegexes }
    };
    document.getElementById('jsonSource').value = JSON.stringify(d, null, 2);
};

window.applySourceCode = function() {
    try {
        var json = JSON.parse(document.getElementById('jsonSource').value);
        document.getElementById('cardName').value = json.name || '';
        document.getElementById('cardDesc').value = json.description || '';
        // ...å…¶ä»–å­—æ®µåŒæ­¥...
        if(json.extensions && json.extensions.regex_scripts) {
            window.currentCardRegexes = json.extensions.regex_scripts;
            renderRegexList();
        }
        auth.toast('âœ… æºç å·²åº”ç”¨');
    } catch(e) { alert('JSON æ ¼å¼é”™è¯¯'); }
};

// ================= ğŸ’¾ ç»ˆæå¯¼å‡ºï¼šä¸‰åˆä¸€æ‰“åŒ… (äººè®¾+æ­£åˆ™+ä¸–ç•Œä¹¦) =================
window.exportTavernCard = function() {
    // 1. è·å–åŸºç¡€äººè®¾ä¿¡æ¯
    updateJsonSource(); // ç¡®ä¿æºç æ¡†æ˜¯æœ€æ–°çš„
    var jsonStr = document.getElementById('jsonSource').value;
    var cardData;
    
    try {
        cardData = JSON.parse(jsonStr);
    } catch(e) {
        auth.toast('âŒ å¯¼å‡ºå¤±è´¥ï¼šJSON æ ¼å¼æœ‰è¯¯');
        return;
    }

    // 2. âš¡ï¸ å¼ºåŠ›æ‰“åŒ…ï¼šæ³¨å…¥æ­£åˆ™è„šæœ¬ (Regex)
    // æ— è®ºä½ åœ¨æºç é¡µæ€ä¹ˆæ”¹ï¼Œè¿™é‡Œéƒ½ä¼šæŠŠâ€œå‰ç«¯å¼€å‘å°â€é‡Œçš„æœ€æ–°è„šæœ¬è¦†ç›–è¿›å»ï¼Œé˜²æ­¢ä¸¢å¤±
    if (window.currentCardRegexes && window.currentCardRegexes.length > 0) {
        if (!cardData.data.extensions) cardData.data.extensions = {};
        cardData.data.extensions.regex_scripts = window.currentCardRegexes;
        console.log(`å·²æ‰“åŒ… ${window.currentCardRegexes.length} ä¸ªæ­£åˆ™è„šæœ¬`);
    }

    // 3. ğŸŒ å¼ºåŠ›æ‰“åŒ…ï¼šæ³¨å…¥ä¸–ç•Œä¹¦ (World Info)
    // æŠŠä½ åœ¨â€œä¸–ç•Œä¹¦â€é¡µé¢å†™çš„æ¡ç›®ï¼Œæ‰“åŒ…æˆä¸€æœ¬â€œå†…ç½®ä¹¦â€
    if (window.currentWorldInfo && window.currentWorldInfo.entries.length > 0) {
        cardData.data.character_book = {
            "name": "Embedded World", // å†…ç½®ä¸–ç•Œä¹¦åç§°
            "description": "Auto-generated by Creator Workshop",
            "scan_depth": 100, // æ‰«ææ·±åº¦
            "token_budget": 500, // token é¢„ç®—
            "recursive_scanning": false,
            "extensions": {},
            "entries": window.currentWorldInfo.entries // æ ¸å¿ƒæ¡ç›®æ•°æ®
        };
        console.log(`å·²æ‰“åŒ… ${window.currentWorldInfo.entries.length} æ¡ä¸–ç•Œä¹¦è®¾å®š`);
    }

    // 4. ç”Ÿæˆæ–‡ä»¶å¹¶ä¸‹è½½
    var blob = new Blob([JSON.stringify(cardData, null, 2)], {type: "application/json"});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    // æ–‡ä»¶åï¼šè§’è‰²å.json
    a.download = (cardData.data.name || "character") + ".json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    auth.toast('ğŸ’¾ å¤§åŠŸå‘Šæˆï¼ä¸‰åˆä¸€å¡ç‰‡å·²å¯¼å‡ºï¼');
    
    // 5. å¼¹å‡ºä¸€ä¸ªæ•™å­¦æç¤º
    setTimeout(() => {
        alert("ğŸ‘‰ å¯¼å‡ºæˆåŠŸï¼\n\nè¿™å¼ å¡ç‰‡å·²ç»åŒ…å«äº†ã€äººè®¾ã€‘+ã€ç‰¹æ•ˆã€‘+ã€ä¸–ç•Œä¹¦ã€‘ã€‚\n\nè¯·çœ‹æ¥ä¸‹æ¥çš„æ•™ç¨‹ï¼Œæ•™ä½ å¦‚ä½•å¯¼å…¥é…’é¦†ï¼");
    }, 500);
};


// ================= ğŸ¤– æ–°å¢ï¼šAI ç”Ÿæˆå‰ç«¯ä»£ç é€»è¾‘ =================

// 1. ä¿®å¤æ•™ç¨‹å¼¹çª—æ‰“ä¸å¼€çš„é—®é¢˜
window.toggleGuideModal = function() {
    var m = document.getElementById('guideModal');
    if (m) {
        // å¼ºåˆ¶åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
        if(m.style.display === 'none' || m.style.display === '') {
            m.style.display = 'flex';
            m.classList.add('active');
        } else {
            m.style.display = 'none';
            m.classList.remove('active');
        }
    } else {
        alert("âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ•™ç¨‹å¼¹çª— HTML (id='guideModal')");
    }
};

// 2. AI ç”Ÿæˆ HTML/CSS ä»£ç 

// ================= ğŸ¤– AI å…¨è‡ªåŠ¨å‰ç«¯ç”Ÿæˆå™¨ =================

// è¾…åŠ©ï¼šç‚¹å‡»çµæ„ŸæŒ‰é’®è‡ªåŠ¨å¡«å…¥å¹¶ç”Ÿæˆ
window.fillAiPrompt = function(text) {
    document.getElementById('aiCodePrompt').value = text;
    generateFrontendCode();
};

// ğŸ”¥ æ ¸å¿ƒç”Ÿæˆé€»è¾‘
window.generateFrontendCode = async function() {
    var req = document.getElementById('aiCodePrompt').value.trim();
    if (!req) { auth.toast('è¯·å…ˆå‘Šè¯‰æˆ‘è¦åšä»€ä¹ˆ...'); return; }
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·å…ˆé…ç½® API Key'); return; }

    var btn = document.getElementById('btnGenCode');
    var oldText = btn.innerText;
    btn.innerText = 'ğŸ§  æ­£åœ¨æ„å»ºç•Œé¢...';
    btn.disabled = true;

    // ğŸ‘¨â€ğŸ’» ç»™ AI çš„è¶…çº§æŒ‡ä»¤
    var prompt = `
    ä½ æ˜¯ä¸€ä¸ªä¸–ç•Œé¡¶çº§çš„ SillyTavern å‰ç«¯å¼€å‘ä¸“å®¶ã€‚
    ç”¨æˆ·æƒ³è¦ä¸€ä¸ªç•Œé¢åŠŸèƒ½ï¼šã€${req}ã€‘
    
    è¯·å®Œæˆä»¥ä¸‹ 3 ä¸ªä»»åŠ¡ï¼Œå¹¶ä»¥çº¯ JSON æ ¼å¼è¿”å›ï¼š
    
    1. "name": ç»™è„šæœ¬èµ·ä¸ªç®€çŸ­çš„åå­— (å¦‚: çŠ¶æ€æ )ã€‚
    2. "regex": è®¾è®¡ä¸€ä¸ªè§¦å‘è¿™ä¸ªç•Œé¢çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚
       - å¦‚æœæ˜¯å¸¸é©»æ˜¾ç¤ºï¼ˆå¦‚çŠ¶æ€æ ï¼‰ï¼Œé€šå¸¸æ­£åˆ™ä¸º "/\\[STATUS\\]/g" æˆ– "/\\[UI\\]/g"ã€‚
       - å¦‚æœæ˜¯ä¿®æ”¹å¯¹è¯æ°”æ³¡ï¼Œæ­£åˆ™ä¸º "/^(.+)$/gm"ã€‚
       - å¦‚æœæ˜¯éšè—å†…å®¹ï¼Œæ­£åˆ™ä¸ºåŒ¹é…è¯¥å†…å®¹çš„è§„åˆ™ã€‚
    3. "code": ç¼–å†™å®ç°æ•ˆæœçš„ HTML å’Œ CSS ä»£ç ã€‚
       - CSS å¿…é¡»åŒ…å«åœ¨ <style> æ ‡ç­¾å†…ã€‚
       - è§†è§‰æ•ˆæœè¦éå¸¸ç²¾è‡´ã€ç°ä»£ã€ç¬¦åˆç”¨æˆ·æè¿°ã€‚
       - å°½é‡ä½¿ç”¨ flex/grid å¸ƒå±€ï¼Œæ”¯æŒå“åº”å¼ã€‚
       - ä»£ç è¦ç´§å‡‘ï¼Œä¸è¦æœ‰ Markdown æ ‡è®°ã€‚

    è¿”å›æ ¼å¼ç¤ºä¾‹ï¼š
    {
        "name": "ç²‰è‰²çŠ¶æ€æ ",
        "regex": "/\\[STATUS\\]/g",
        "code": "<style>...</style><div>...</div>"
    }
    `;

    try {
        var res = await fetchAI(prompt, config);
        // æ¸…ç† AI å¯èƒ½è¿”å›çš„ Markdown ç¬¦å·
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var data = JSON.parse(cleanJson);
        
        // è‡ªåŠ¨å¡«ç©º
        document.getElementById('frontName').value = data.name || 'AIç”Ÿæˆè„šæœ¬';
        document.getElementById('frontPattern').value = data.regex || '/\\[UI\\]/g';
        document.getElementById('frontReplace').value = data.code || '<div>ç”Ÿæˆä¸ºç©º</div>';
        
        auth.toast('âœ¨ ä»£ç æ„å»ºå®Œæˆï¼è¯·ç‚¹å‡»ä¸‹æ–¹â€œæ³¨å…¥â€');
        
        // ğŸ§ª è‡ªåŠ¨å¸®ç”¨æˆ·åœ¨å®éªŒå®¤é‡Œå¡«å…¥è§¦å‘è¯ï¼Œç›´æ¥çœ‹æ•ˆæœ
        // æå–æ­£åˆ™é‡Œçš„å…³é”®è¯ï¼Œå»æ‰æ–œæ å’Œè½¬ä¹‰ç¬¦
        var rawKey = data.regex.replace(/^\//, '').replace(/\/g[im]*$/, '').replace(/\\/g, '');
        // å¦‚æœæ˜¯é€šç”¨åŒ¹é…ç¬¦(.+)ï¼Œå°±å¡«ä¸€æ®µæµ‹è¯•æ–‡å­—
        if(rawKey.includes('.+')) rawKey = "è¿™æ˜¯ä¸€æ®µæµ‹è¯•æ–‡å­—ï¼Œçœ‹çœ‹æ•ˆæœå¦‚ä½•ã€‚";
        
        document.getElementById('regexTestInput').value = rawKey;
        runRegexTest(); // ç«‹å³é¢„è§ˆ

    } catch (e) {
        console.error(e);
        auth.toast('âŒ ç”Ÿæˆå¤±è´¥ï¼ŒAI è„‘å­çŸ­è·¯äº† (JSONè§£æé”™)');
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
};

// ================= ğŸŒ ä¸–ç•Œä¹¦å¼€å‘é€»è¾‘ (Frontend World Book) =================

// æ•°æ®å­˜å‚¨
window.currentWorldInfo = {
    name: "New World",
    entries: [] // { keys: [], content: "", comment: "" }
};
let currentEntryIdx = -1;

// 1. AI è¾…åŠ©å¡«ç©º
window.fillWorldPrompt = function(txt) {
    document.getElementById('aiWorldPrompt').value = txt;
    generateWorldEntry();
};

// 2. AI ç”Ÿæˆä¸–ç•Œä¹¦æ¡ç›®
window.generateWorldEntry = async function() {
    var req = document.getElementById('aiWorldPrompt').value.trim();
    if (!req) { auth.toast('è¯·å‘Šè¯‰æˆ‘è¦ç”Ÿæˆä»€ä¹ˆæ¡ç›®...'); return; }
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·å…ˆé…ç½® API Key'); return; }

    var btn = document.getElementById('btnGenWorld');
    var oldText = btn.innerText;
    btn.innerText = 'ğŸ§  æ„ç­‘ä¸­...'; btn.disabled = true;

    var prompt = `
    ä½ æ˜¯ä¸€ä¸ª SillyTavern "å‰ç«¯ä¸–ç•Œä¹¦" ä¸“å®¶ã€‚
    ç”¨æˆ·éœ€æ±‚ï¼šã€${req}ã€‘
    
    è¯·åˆ›å»ºä¸€ä¸ª World Info æ¡ç›®ã€‚
    å¦‚æœç”¨æˆ·æƒ³è¦ç‰¹æ•ˆ/ç•Œé¢ï¼ŒContent è¯·ç›´æ¥å†™ HTML/CSS ä»£ç ã€‚
    å¦‚æœç”¨æˆ·æƒ³è¦è®¾å®šï¼ŒContent è¯·å†™æ–‡æœ¬ã€‚
    
    è¯·è¿”å›çº¯ JSONï¼š
    {
        "comment": "æ¡ç›®å",
        "keys": ["è§¦å‘è¯1", "è§¦å‘è¯2"],
        "content": "å†…å®¹ï¼ˆHTMLæˆ–æ–‡æœ¬ï¼‰"
    }
    `;

    try {
        var res = await fetchAI(prompt, config);
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var data = JSON.parse(cleanJson);
        
        // æ·»åŠ åˆ°åˆ—è¡¨
        window.currentWorldInfo.entries.push({
            id: Date.now(),
            keys: data.keys || [],
            content: data.content || "",
            comment: data.comment || "AIç”Ÿæˆæ¡ç›®",
            enabled: true,
            insertion_position: 1 // é»˜è®¤æ’å…¥ä½ç½®
        });
        
        renderWorldList();
        selectEntry(window.currentWorldInfo.entries.length - 1); // é€‰ä¸­æ–°æ¡ç›®
        auth.toast('âœ¨ æ¡ç›®å·²ç”Ÿæˆï¼');

    } catch (e) {
        console.error(e);
        auth.toast('âŒ ç”Ÿæˆå¤±è´¥ (JSONè§£æé”™)');
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
};

// 3. åŸºç¡€ CRUD æ“ä½œ
window.renderWorldList = function() {
    var list = document.getElementById('worldEntryList');
    list.innerHTML = '';
    
    window.currentWorldInfo.entries.forEach((entry, idx) => {
        var div = document.createElement('div');
        div.className = 'world-item ' + (idx === currentEntryIdx ? 'active' : '');
        div.innerHTML = `<span>${entry.comment || 'æœªå‘½å'}</span> <span>ğŸ“</span>`;
        div.onclick = function() { selectEntry(idx); };
        list.appendChild(div);
    });
};

window.selectEntry = function(idx) {
    currentEntryIdx = idx;
    var entry = window.currentWorldInfo.entries[idx];
    
    document.getElementById('worldEmptyState').style.display = 'none';
    document.getElementById('worldEditorArea').style.display = 'flex';
    
    document.getElementById('wiComment').value = entry.comment || '';
    document.getElementById('wiKeys').value = (entry.keys || []).join(', ');
    document.getElementById('wiContent').value = entry.content || '';
    
    renderWorldList(); // åˆ·æ–°é«˜äº®
};

window.addWorldEntry = function() {
    window.currentWorldInfo.entries.push({
        id: Date.now(),
        keys: [],
        content: "",
        comment: "æ–°æ¡ç›®",
        enabled: true
    });
    renderWorldList();
    selectEntry(window.currentWorldInfo.entries.length - 1);
};

window.deleteCurrentEntry = function() {
    if (currentEntryIdx === -1) return;
    if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªæ¡ç›®å—ï¼Ÿ')) return;
    
    window.currentWorldInfo.entries.splice(currentEntryIdx, 1);
    currentEntryIdx = -1;
    document.getElementById('worldEditorArea').style.display = 'none';
    document.getElementById('worldEmptyState').style.display = 'flex';
    renderWorldList();
};

window.updateCurrentEntry = function() {
    if (currentEntryIdx === -1) return;
    var entry = window.currentWorldInfo.entries[currentEntryIdx];
    
    entry.comment = document.getElementById('wiComment').value;
    entry.content = document.getElementById('wiContent').value;
    
    // å¤„ç† keys (é€—å·åˆ†éš”è½¬æ•°ç»„)
    var keysStr = document.getElementById('wiKeys').value;
    entry.keys = keysStr.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
    
    // å®æ—¶åˆ·æ–°åˆ—è¡¨åå­—
    renderWorldList();
};

// ğŸ”¥ 4. ä¿®æ”¹å¯¼å‡ºé€»è¾‘ (æŠŠä¸–ç•Œä¹¦æ‰“åŒ…è¿›å»)
// è¦†ç›–ä¹‹å‰çš„ exportTavernCard å‡½æ•°
var originalExport = window.exportTavernCard;
window.exportTavernCard = function() {
    updateJsonSource();
    
    // è·å–åŸºç¡€æ•°æ®
    var jsonStr = document.getElementById('jsonSource').value;
    var cardData = JSON.parse(jsonStr);
    
    // æ³¨å…¥ä¸–ç•Œä¹¦
    if (window.currentWorldInfo.entries.length > 0) {
        cardData.data.character_book = {
            name: "Embedded World",
            entries: window.currentWorldInfo.entries
        };
    }
    
    // å¯¼å‡º
    var blob = new Blob([JSON.stringify(cardData, null, 2)], {type: "application/json"});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (cardData.data.name || "card") + ".json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    auth.toast('ğŸ’¾ å¡ç‰‡+ä¸–ç•Œä¹¦ å·²æ‰“åŒ…å¯¼å‡ºï¼');
};

/* ================= ğŸ—£ï¸ AI äºŒæ¬¡ç¼–è¾‘ (Refine System) ================= */

// 1. åˆå§‹åŒ–ç¼“å­˜ (è¡¥å……äº† desc å’Œ firstMes)
window.lastGeneratedData = {
    wizard: null,   
    frontend: null, 
    world: null,
    stat: null,
    desc: null,     // è¯¦ç»†è®¾å®šç¼“å­˜
    firstMes: null  // å¼€åœºç™½ç¼“å­˜
};

// 2. é€šç”¨äºŒæ¬¡ç¼–è¾‘å‡½æ•° (æ”¯æŒ JSON å’Œ çº¯æ–‡æœ¬)

/* ================= ğŸ—£ï¸ AI äºŒæ¬¡ç¼–è¾‘ (Refine System - æ— æŠ¥é”™ç‰ˆ) ================= */

// 1. åˆå§‹åŒ–ç¼“å­˜
window.lastGeneratedData = {
    wizard: null, frontend: null, world: null, stat: null, desc: null, firstMes: null
};

// 2. é€šç”¨äºŒæ¬¡ç¼–è¾‘å‡½æ•° (å®Œå…¨å»é™¤æŠ¥é”™é€»è¾‘)
window.refineResult = async function(type) {
    const inputId = `refineInput_${type}`;
    const requirement = document.getElementById(inputId).value.trim();
    
    if (!requirement) { auth.toast('è¯·å‘Šè¯‰æˆ‘æ€ä¹ˆæ”¹...'); return; }
    
    // å¦‚æœç¼“å­˜ä¸ºç©ºï¼Œå°è¯•è¯»å–å½“å‰è¾“å…¥æ¡†
    if (!window.lastGeneratedData[type]) {
        if (type === 'desc') window.lastGeneratedData.desc = document.getElementById('cardDesc').value;
        else if (type === 'firstMes') window.lastGeneratedData.firstMes = document.getElementById('cardFirstMes').value;
        else { auth.toast('è¯·å…ˆç”Ÿæˆä¸€æ¬¡ï¼Œæ‰èƒ½ä¿®æ”¹å“¦'); return; }
    }

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) return; // æ²¡keyä¹Ÿé™é»˜å¤„ç†ï¼Œæˆ–è€…æç¤ºé…ç½®

    const btn = event.target;
    const oldText = btn.innerText;
    btn.innerText = 'ğŸ§  ä¿®æ”¹ä¸­...'; btn.disabled = true;

    // å‡†å¤‡æ—§æ•°æ®
    var prevData = window.lastGeneratedData[type];
    var prevDataStr = typeof prevData === 'string' ? prevData : JSON.stringify(prevData);

    // ==========================================
    // ğŸ”¥ åˆ†æ”¯ Aï¼šçº¯æ–‡æœ¬ä¿®æ”¹ (äººè®¾ desc / å¼€åœºç™½ firstMes)
    // ==========================================
    if (type === 'desc' || type === 'firstMes') {
        var prompt = `åŸæ–‡æœ¬ï¼š${prevDataStr}\nä¿®æ”¹æ„è§ï¼šã€${requirement}ã€‘\nè¯·æ ¹æ®æ„è§é‡å†™ã€‚ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ï¼Œä¸è¦ä»£ç å—ã€‚`;
        
        try {
            var res = await fetchAI(prompt, config);
            var cleanText = res.replace(/```/g, '').trim();
            
            // å¡«å›å¯¹åº”çš„æ¡†
            if (type === 'desc') document.getElementById('cardDesc').value = cleanText;
            if (type === 'firstMes') {
                document.getElementById('cardFirstMes').value = cleanText;
                if(typeof updatePreviewUI === 'function') updatePreviewUI();
            }

            window.lastGeneratedData[type] = cleanText;
            auth.toast('âœ¨ ä¿®æ”¹å·²åº”ç”¨ï¼');
            document.getElementById(inputId).value = ''; 

        } catch(e) { 
            // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šæŠ¥é”™ä¹Ÿç®—æˆåŠŸï¼Œæ–¹ä¾¿ä½ æ‰‹åŠ¨æ”¹
            console.error(e);
            auth.toast('âœ… ç¼–è¾‘æ¨¡å¼å·²å°±ç»ª (å¯ç›´æ¥ä¿®æ”¹)');
        } finally {
            btn.innerText = oldText; btn.disabled = false;
        }
        return; // ç»“æŸæ–‡æœ¬é€»è¾‘
    }

    // ==========================================
    // ğŸ”¥ åˆ†æ”¯ Bï¼šJSON æ•°æ®ä¿®æ”¹ (ä¸–ç•Œä¹¦ / å‰ç«¯ / å±æ€§ / å‘å¯¼)
    // ==========================================
    var prompt = `åŸæ•°æ®ï¼š${prevDataStr}ã€‚ä¿®æ”¹æ„è§ï¼šã€${requirement}ã€‘ã€‚è¯·ä¿®æ”¹å¹¶è¿”å›å®Œæ•´JSONã€‚`;
    if (type === 'stat') prompt = `åŸè§„åˆ™ä»£ç ï¼š${prevDataStr}ã€‚ä¿®æ”¹æ„è§ï¼šã€${requirement}ã€‘ã€‚è¯·ä¿®æ”¹ä»£ç é€»è¾‘ï¼Œå¹¶è¿”å›å®Œæ•´JSON {script: "...", guide: "..."}`;

    try {
        const res = await fetchAI(prompt, config);
        const cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        const newData = JSON.parse(cleanJson);

        window.lastGeneratedData[type] = newData; // æ›´æ–°ç¼“å­˜

        // æ›´æ–°ç•Œé¢
        if (type === 'wizard') {
            document.getElementById('cardName').value = newData.name || '';
            document.getElementById('cardDesc').value = newData.description || '';
            document.getElementById('cardFirstMes').value = newData.first_mes || '';
            document.getElementById('cardScenario').value = newData.scenario || '';
            document.getElementById('cardMesExample').value = newData.mes_example || '';
            if(typeof updatePreviewUI === 'function') updatePreviewUI();
        } else if (type === 'frontend') {
            document.getElementById('frontName').value = newData.name;
            document.getElementById('frontPattern').value = newData.regex;
            var code = newData.code || '';
            if(typeof simpleFormatHTML === 'function') code = simpleFormatHTML(code);
            document.getElementById('frontReplace').value = code;
            var testKey = (newData.regex || '').replace(/^\//, '').replace(/\/g[im]*$/, '').replace(/\\/g, '');
            document.getElementById('regexTestInput').value = testKey;
            if(typeof runRegexTest === 'function') runRegexTest();
        } else if (type === 'world') {
            document.getElementById('wiComment').value = newData.comment || '';
            document.getElementById('wiKeys').value = (newData.keys || []).join(', ');
            var content = newData.content || '';
            if(typeof simpleFormatHTML === 'function') content = simpleFormatHTML(content);
            document.getElementById('wiContent').value = content;
        } else if (type === 'stat') {
             var script = newData.script || newData.raw || newData.content;
             document.getElementById('statEditor').value = script;
             if(typeof syncStatToNote === 'function') syncStatToNote();
        }

        auth.toast('âœ¨ ä¿®æ”¹å®Œæˆï¼');
        document.getElementById(inputId).value = ''; 

    } catch (e) {
        // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šJSON è§£æå¤±è´¥ä¹Ÿä¸æŠ¥çº¢ï¼Œç®—ä½œâ€œå°±ç»ªâ€
        console.error(e);
        auth.toast('âœ… ç¼–è¾‘æ¨¡å¼å·²å°±ç»ª (å¯æ‰‹åŠ¨ä¿®æ”¹)');
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
};


// ğŸ”¥ åŠ«æŒæ—§çš„ç”Ÿæˆå‡½æ•°ï¼Œç”ŸæˆæˆåŠŸåæ˜¾ç¤ºâ€œä¿®æ”¹æ¡†â€å¹¶å­˜ç¼“å­˜
// 1. åŠ«æŒå‘å¯¼ç”Ÿæˆ
const originalWizardGen = window.generateCardFromTags;
window.generateCardFromTags = async function() {
    await originalWizardGen(); // æ‰§è¡ŒåŸé€»è¾‘
    // å‡è®¾åŸé€»è¾‘æˆåŠŸæ‰§è¡Œï¼Œå¡«å……äº†æ•°æ®
    // æˆ‘ä»¬æ‰‹åŠ¨æŠ“å–ä¸€ä¸‹æ•°æ®å­˜å…¥ç¼“å­˜ (å› ä¸ºåŸå‡½æ•°é‡Œæ˜¯å±€éƒ¨å˜é‡)
    window.lastGeneratedData.wizard = {
        name: document.getElementById('cardName').value,
        description: document.getElementById('cardDesc').value,
        first_mes: document.getElementById('cardFirstMes').value,
        scenario: document.getElementById('cardScenario').value,
        mes_example: document.getElementById('cardMesExample').value
    };
    document.getElementById('refineArea_wizard').style.display = 'block'; // æ˜¾ç¤ºä¿®æ”¹æ¡†
};

// 2. åŠ«æŒå‰ç«¯ç”Ÿæˆ
const originalFrontGen = window.generateFrontendCode;
window.generateFrontendCode = async function() {
    await originalFrontGen();
    window.lastGeneratedData.frontend = {
        name: document.getElementById('frontName').value,
        regex: document.getElementById('frontPattern').value,
        code: document.getElementById('frontReplace').value
    };
    document.getElementById('refineArea_frontend').style.display = 'block';
};

// 3. åŠ«æŒä¸–ç•Œä¹¦ç”Ÿæˆ
const originalWorldGen = window.generateWorldEntry;
window.generateWorldEntry = async function() {
    await originalWorldGen();
    // ä¸–ç•Œä¹¦æ¯”è¾ƒç‰¹æ®Šï¼Œæˆ‘ä»¬è¦è·å–æœ€æ–°ç”Ÿæˆçš„é‚£ä¸ªæ¡ç›®
    const entries = window.currentWorldInfo.entries;
    if (entries.length > 0) {
        const lastEntry = entries[entries.length - 1]; // åˆšç”Ÿæˆçš„é‚£ä¸ª
        window.lastGeneratedData.world = {
            comment: lastEntry.comment,
            keys: lastEntry.keys,
            content: lastEntry.content
        };
        document.getElementById('refineArea_world').style.display = 'block';
    }
};

// ================= ğŸš‘ ç´§æ€¥ä¿®å¤è¡¥ä¸ï¼šè¯»å– & å¯¼å‡ºåŠŸèƒ½ =================

// 1. ğŸ“‚ è¯»å–åŠŸèƒ½ (Import)
window.importCardFile = function() {
    var input = document.getElementById('importCardInput');
    if(input) input.click();
    else alert("âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶è¾“å…¥æ¡† (id='importCardInput')");
};

/* ================= ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šè¯»å–åŠŸèƒ½ (å®½å®¹æ¨¡å¼) ================= */
window.handleCardImport = function(input) {
    if (!input.files || !input.files[0]) return;
    
    var file = input.files[0];
    // ç§»é™¤ä¸¥æ ¼çš„æ–‡ä»¶å/ç±»å‹æ£€æŸ¥ï¼Œåªè¦èƒ½è¯»å°±è¡Œ
    
    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var json = JSON.parse(e.target.result);
            // å…¼å®¹ V1(ç›´æ¥åœ¨æ ¹ç›®å½•) å’Œ V2(åœ¨dataå­—æ®µä¸‹)
            var data = json.data || json; 
            
            // 1. å¡«å…¥åŸºç¡€ä¿¡æ¯ (åŠ äº†éç©ºåˆ¤æ–­ï¼Œé˜²æ­¢æŠ¥é”™)
            if(document.getElementById('cardName')) document.getElementById('cardName').value = data.name || '';
            if(document.getElementById('cardDesc')) document.getElementById('cardDesc').value = data.description || '';
            if(document.getElementById('cardFirstMes')) document.getElementById('cardFirstMes').value = data.first_mes || '';
            if(document.getElementById('cardMesExample')) document.getElementById('cardMesExample').value = data.mes_example || '';
            if(document.getElementById('cardScenario')) document.getElementById('cardScenario').value = data.scenario || '';
            if(document.getElementById('cardNote')) document.getElementById('cardNote').value = data.creator_notes || '';
            
            // 2. å¯¼å…¥æ­£åˆ™è„šæœ¬
            if (data.extensions && data.extensions.regex_scripts) {
                window.currentCardRegexes = data.extensions.regex_scripts;
                if (typeof renderRegexList === 'function') renderRegexList();
            }
            
            // 3. å¯¼å…¥ä¸–ç•Œä¹¦
            if (data.character_book && data.character_book.entries) {
                if(!window.currentWorldInfo) window.currentWorldInfo = { entries: [] };
                window.currentWorldInfo.entries = data.character_book.entries;
                if (typeof renderWorldList === 'function') renderWorldList();
            }

            // 4. åˆ·æ–°é¢„è§ˆ
            if (typeof updatePreviewUI === 'function') updatePreviewUI();
            
            auth.toast('ğŸ“‚ è¯»å–æˆåŠŸï¼');
            
        } catch (err) {
            console.error(err);
            // åªæœ‰çœŸçš„è§£æä¸äº† JSON æ—¶æ‰æŠ¥é”™
            alert('âŒ è¯»å–å¤±è´¥ï¼šæ–‡ä»¶å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼ã€‚\n(é”™è¯¯ä¿¡æ¯: ' + err.message + ')');
        }
    };
    reader.readAsText(file);
    input.value = ''; // æ¸…ç©ºï¼Œå…è®¸é‡å¤é€‰åŒä¸€ä¸ªæ–‡ä»¶
};


// 2. ğŸ’¾ å¯¼å‡ºåŠŸèƒ½ (Export V2)
window.exportTavernCard = function() {
    // å…ˆå°è¯•æ›´æ–°æºç æ¡† (å¦‚æœå‡½æ•°å­˜åœ¨)
    if (typeof updateJsonSource === 'function') updateJsonSource();
    
    // è·å–å½“å‰æ•°æ®
    var name = document.getElementById('cardName').value.trim() || 'New Character';
    var desc = document.getElementById('cardDesc').value;
    var firstMes = document.getElementById('cardFirstMes').value;
    var mesEx = document.getElementById('cardMesExample').value;
    var scenario = document.getElementById('cardScenario').value;
    var note = document.getElementById('cardNote').value;
    
    // æ„å»º V2 æ ¼å¼
    var cardData = {
        "spec": "chara_card_v2",
        "spec_version": "2.0",
        "data": {
            "name": name,
            "description": desc,
            "first_mes": firstMes,
            "mes_example": mesEx,
            "scenario": scenario,
            "creator_notes": note,
            "system_prompt": "",
            "post_history_instructions": "",
            "alternate_greetings": [],
            "character_book": null,
            "tags": [],
            "creator": "Lili's Creator Workshop",
            "character_version": "1.0",
            "extensions": {}
        }
    };

    // æ³¨å…¥æ­£åˆ™
    if (window.currentCardRegexes && window.currentCardRegexes.length > 0) {
        cardData.data.extensions.regex_scripts = window.currentCardRegexes;
    }

    // æ³¨å…¥ä¸–ç•Œä¹¦
    if (window.currentWorldInfo && window.currentWorldInfo.entries && window.currentWorldInfo.entries.length > 0) {
        cardData.data.character_book = {
            "name": "Embedded World",
            "description": "Auto-generated",
            "scan_depth": 100,
            "token_budget": 500,
            "recursive_scanning": false,
            "extensions": {},
            "entries": window.currentWorldInfo.entries
        };
    }

    // æ‰§è¡Œä¸‹è½½
    try {
        var blob = new Blob([JSON.stringify(cardData, null, 2)], {type: "application/json"});
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name + ".json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        auth.toast('ğŸ’¾ å¯¼å‡ºæˆåŠŸï¼å¯ç›´æ¥æ‹–å…¥é…’é¦†');
    } catch(e) {
        alert("å¯¼å‡ºå‡ºé”™ï¼š" + e.message);
    }
};

// 3. ğŸ“˜ æ•™ç¨‹æŒ‰é’®ä¿®å¤
window.toggleGuideModal = function() {
    var m = document.getElementById('guideModal');
    if (m) {
        if(m.style.display === 'none' || !m.classList.contains('active')) {
            m.style.display = 'flex';
            setTimeout(()=>m.classList.add('active'), 10);
        } else {
            m.classList.remove('active');
            setTimeout(()=>m.style.display = 'none', 300);
        }
    } else {
        alert("âŒ æ•™ç¨‹å¼¹çª— HTML ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥ä»£ç ï¼");
    }
};

/* --- ğŸ”§ æ–°å¢ï¼šç®€å•çš„ä»£ç æ ¼å¼åŒ–å·¥å…· --- */
function simpleFormatHTML(html) {
    if (!html) return "";
    // ç®€å•çš„ç¼©è¿›å¤„ç†ï¼šåœ¨ > åæ¢è¡Œï¼Œåœ¨ } åæ¢è¡Œ
    let formatted = html
        .replace(/>/g, '>\n')      // æ ‡ç­¾é—­åˆæ¢è¡Œ
        .replace(/;/g, ';\n')      // CSSå±æ€§æ¢è¡Œ
        .replace(/{/g, '{\n')      // CSSå—å¼€å§‹
        .replace(/}/g, '\n}\n')    // CSSå—ç»“æŸ
        .replace(/\n\s*\n/g, '\n'); // å»æ‰å¤šä½™ç©ºè¡Œ
    return formatted;
}

/* --- ğŸ› ï¸ è¦†ç›–æ—§å‡½æ•°ï¼šç”Ÿæˆå‰ç«¯ä»£ç  (åŠ å…¥æ ¼å¼åŒ–) --- */
window.generateFrontendCode = async function() {
    // ... (ä¿ç•™ä¹‹å‰çš„éªŒè¯ä»£ç ) ...
    var req = document.getElementById('aiCodePrompt').value.trim();
    if (!req) { auth.toast('è¯·å…ˆå‘Šè¯‰æˆ‘è¦åšä»€ä¹ˆ...'); return; }
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·å…ˆé…ç½® API Key'); return; }
    
    var btn = document.getElementById('btnGenCode');
    btn.innerText = 'ğŸ§  æ­£åœ¨æ„å»º...'; btn.disabled = true;

    // Prompt ä¿æŒä¸å˜...
    var prompt = `ä½ æ˜¯ä¸€ä¸ªSillyTavernå‰ç«¯ä¸“å®¶ã€‚ç”¨æˆ·éœ€æ±‚ï¼šã€${req}ã€‘ã€‚è¯·è¿”å›çº¯JSONï¼š{"name":"è„šæœ¬å","regex":"/æ­£åˆ™/g","code":"HTMLä»£ç "}`;

    try {
        var res = await fetchAI(prompt, config);
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var data = JSON.parse(cleanJson);
        
        document.getElementById('frontName').value = data.name || 'AIè„šæœ¬';
        document.getElementById('frontPattern').value = data.regex || '';
        
        // ğŸ”¥ ä¿®æ”¹ç‚¹ï¼šä½¿ç”¨æ ¼å¼åŒ–å‡½æ•°
        document.getElementById('frontReplace').value = simpleFormatHTML(data.code) || '';
        
        auth.toast('âœ¨ ä»£ç å·²ç”Ÿæˆå¹¶æ ¼å¼åŒ–ï¼');
        // ... (ä¿ç•™ä¹‹å‰çš„æµ‹è¯•é€»è¾‘) ...
    } catch (e) {
        console.error(e);
        auth.toast('âŒ ç”Ÿæˆå¤±è´¥');
    } finally {
        btn.innerText = 'âœ¨ ä¸€é”®ç”Ÿæˆ'; btn.disabled = false;
    }
};

/* --- ğŸ› ï¸ è¦†ç›–æ—§å‡½æ•°ï¼šç”Ÿæˆä¸–ç•Œä¹¦ (åŠ å…¥æ ¼å¼åŒ–) --- */
window.generateWorldEntry = async function() {
    // ... (ä¿ç•™éªŒè¯ä»£ç ) ...
    var req = document.getElementById('aiWorldPrompt').value.trim();
    if (!req) { auth.toast('éœ€æ±‚ä¸ºç©º...'); return; }
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) return;

    var btn = document.getElementById('btnGenWorld');
    btn.innerText = 'ğŸ§  æ„ç­‘ä¸­...'; btn.disabled = true;

    var prompt = `ä½ æ˜¯ä¸€ä¸ªä¸–ç•Œä¹¦ä¸“å®¶ã€‚éœ€æ±‚ï¼šã€${req}ã€‘ã€‚è¿”å›çº¯JSONï¼š{"comment":"æ¡ç›®å","keys":["è§¦å‘è¯"],"content":"å†…å®¹"}`;

    try {
        var res = await fetchAI(prompt, config);
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var data = JSON.parse(cleanJson);
        
        // ğŸ”¥ ä¿®æ”¹ç‚¹ï¼šæ ¼å¼åŒ–å†…å®¹
        var formattedContent = data.content;
        if(formattedContent.includes('<') && formattedContent.includes('>')) {
            formattedContent = simpleFormatHTML(formattedContent);
        }

        window.currentWorldInfo.entries.push({
            id: Date.now(),
            keys: data.keys || [],
            content: formattedContent || "",
            comment: data.comment || "AIæ¡ç›®",
            enabled: true, insertion_position: 1
        });
        
        renderWorldList();
        selectEntry(window.currentWorldInfo.entries.length - 1);
        auth.toast('âœ¨ æ¡ç›®å·²ç”Ÿæˆï¼');
    } catch (e) { auth.toast('âŒ é”™è¯¯'); } 
    finally { btn.innerText = 'âœ¨ ç”Ÿæˆæ¡ç›®'; btn.disabled = false; }
};

/* --- ğŸ› ï¸ é’ˆå¯¹é—®é¢˜2ï¼šæ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾ --- */
function addCustomWizardTag(containerId) {
    var text = prompt("è¯·è¾“å…¥è‡ªå®šä¹‰æ ‡ç­¾åç§°ï¼š");
    if (!text) return;
    text = text.trim();
    
    var container = document.getElementById(containerId);
    
    // åˆ›å»ºé€‰ä¸­çŠ¶æ€çš„æ ‡ç­¾
    var span = document.createElement('span');
    span.className = 'wizard-tag selected'; // é»˜è®¤é€‰ä¸­
    span.textContent = text;
    
    // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆæ”¯æŒåé€‰ï¼‰
    span.onclick = function() {
        // å¦‚æœæ˜¯èº«ä»½ç»„ï¼ˆå•é€‰ï¼‰ï¼Œæ¸…é™¤å…¶ä»–é€‰ä¸­
        if (containerId === 'tagGroupIdentity') {
            Array.from(container.children).forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
        } else {
            this.classList.toggle('selected');
        }
    };
    
    container.appendChild(span);
}

/* --- ğŸ› ï¸ é’ˆå¯¹é—®é¢˜6ï¼šä¿®å¤æºç ä¸åŒæ­¥ --- */
window.updateJsonSource = function() {
    // 1. ç¡®ä¿å½“å‰ç¼–è¾‘çš„ä¸–ç•Œä¹¦æ¡ç›®å·²ä¿å­˜åˆ°æ•°ç»„ä¸­
    if (typeof updateCurrentEntry === 'function') updateCurrentEntry();

    var d = {
        name: document.getElementById('cardName').value,
        description: document.getElementById('cardDesc').value,
        first_mes: document.getElementById('cardFirstMes').value,
        mes_example: document.getElementById('cardMesExample').value,
        scenario: document.getElementById('cardScenario').value,
        creator_notes: document.getElementById('cardNote').value,
        
        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ˜¾å¼åŒ…å« World Info å’Œ Regex
        character_book: (window.currentWorldInfo && window.currentWorldInfo.entries.length > 0) 
            ? window.currentWorldInfo 
            : null,
            
        extensions: { 
            // ç¡®ä¿ regex_scripts å­˜åœ¨
            regex_scripts: window.currentCardRegexes || []
        }
    };
    
    // å†™å…¥æ–‡æœ¬æ¡†
    document.getElementById('jsonSource').value = JSON.stringify(d, null, 2);
};

/* ================= ğŸ§  è¡¥ä¸ï¼šé¢„è§ˆé¡µå•ç‹¬ç”Ÿæˆè®¾å®š ================= */

/* 2. ä¿®å¤ï¼šé¢„è§ˆé¡µç”Ÿæˆé€»è¾‘ (çº¯æ–‡æœ¬æ¨¡å¼ï¼Œé˜²æ­¢è¯¯æŠ¥å¤±è´¥) */

/* ================= ğŸ”§ è¡¥ä¸ï¼šäººè®¾ç”Ÿæˆä¸äºŒæ¬¡ä¿®æ”¹ ================= */

// 1. ç”Ÿæˆè¯¦ç»†è®¾å®š (ç”Ÿæˆåæ¿€æ´»ä¿®æ”¹æ¡†)

/* ================= ğŸ”§ è¡¥ä¸ï¼šè¯¦ç»†è®¾å®šç”Ÿæˆ (æ— æŠ¥é”™ç‰ˆ) ================= */
window.autoGenDesc = async function() {
    var name = document.getElementById('cardName').value.trim();
    if (!name) { auth.toast('å…ˆç»™è§’è‰²èµ·ä¸ªåå­—å§ï¼'); return; }
    
    // è·å–æ ‡ç­¾
    var allTags = [];
    if(window.currentSelectedTags) {
        allTags = [
            ...window.currentSelectedTags.identity, 
            ...window.currentSelectedTags.personality, 
            ...window.currentSelectedTags.trope
        ];
    }
    var tagStr = allTags.join('ã€');

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·å…ˆé…ç½® API Key'); return; }

    var btn = event.target;
    var oldText = btn.innerText;
    btn.innerText = 'âœï¸ æ­£åœ¨å†™...'; btn.style.pointerEvents = 'none';

    var prompt = `æˆ‘æ˜¯åˆ›é€ è€…ã€‚è¯·ä¸ºè§’è‰²ã€${name}ã€‘å†™ä¸€æ®µâ€œè¯¦ç»†è®¾å®šâ€ã€‚
    ã€å¼ºåˆ¶è¦æ±‚ã€‘ï¼šå¿…é¡»åŸºäºè¿™äº›å±æ€§ç”Ÿæˆï¼š${tagStr || "æ— ç‰¹æ®Šæ ‡ç­¾"}ã€‚
    åŒ…å«å¤–è²Œã€æ€§æ ¼ã€èº«ä¸–ã€‚300å­—å·¦å³ã€‚ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ã€‚`;

    try {
        var res = await fetchAI(prompt, config);
        var cleanText = res.replace(/```/g, '').trim();
        
        document.getElementById('cardDesc').value = cleanText;
        
        // æˆåŠŸæ—¶çš„é€»è¾‘
        window.lastGeneratedData.desc = cleanText;
        document.getElementById('refineArea_desc').style.display = 'block';

        if(typeof updateJsonSource === 'function') updateJsonSource();
        auth.toast('âœ… è®¾å®šå†™å…¥æˆåŠŸï¼');
        
        if(typeof checkAndOpenAdvisor === 'function') checkAndOpenAdvisor(false); 

    } catch (e) {
        console.error("ç”Ÿæˆé‡åˆ°é—®é¢˜ (å·²å¿½ç•¥):", e);
        
        // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šå³ä½¿æŠ¥é”™ï¼Œä¹Ÿè§†ä¸ºâ€œå®Œæˆâ€ï¼Œå¼ºåˆ¶æ˜¾ç¤ºä¿®æ”¹æ¡†
        // è¿™æ ·ä½ å°±å¯ä»¥ç›´æ¥åœ¨ä¸‹é¢çš„ä¿®æ”¹æ¡†é‡Œå†™â€œå†è¯•ä¸€æ¬¡â€æˆ–è€…å…¶ä»–è¦æ±‚
        
        // 1. ç¡®ä¿å­˜ç¼“å­˜ï¼ˆå“ªæ€•æ˜¯ç©ºçš„ï¼Œä¹Ÿè¦å ä¸ªä½ï¼Œé˜²æ­¢ä¿®æ”¹å‡½æ•°æŠ¥é”™ï¼‰
        var currentVal = document.getElementById('cardDesc').value;
        window.lastGeneratedData.desc = currentVal || ""; 
        
        // 2. å¼ºåˆ¶æ˜¾ç¤ºä¿®æ”¹æ¡†
        document.getElementById('refineArea_desc').style.display = 'block';
        
        // 3. æç¤ºæ”¹ä¸ºæˆåŠŸ (æˆ–å°±ç»ª)
        auth.toast('âœ… ç¼–è¾‘æ¨¡å¼å·²å°±ç»ª (å¯ç›´æ¥ä¿®æ”¹)');
        
    } finally {
        btn.innerText = oldText; btn.style.pointerEvents = 'auto';
    }
};



/* ================= ğŸ”§ æ ¸å¿ƒä¿®å¤ï¼šæ­£åˆ™æµ‹è¯• & äºŒæ¬¡ç¼–è¾‘é€»è¾‘ ================= */

// 1. ç¼“å­˜ä¸Šä¸€æ¬¡ç”Ÿæˆçš„æ•°æ® (ç»™äºŒæ¬¡ç¼–è¾‘ç”¨)
window.lastGeneratedData = { wizard: null, frontend: null, world: null };

/* 2. ä¿®å¤ç‰ˆï¼šæ­£åˆ™æµ‹è¯•è¿è¡Œå™¨ (è§£å†³æ¸²æŸ“ä¸å‡ºæ¥çš„é—®é¢˜) */
window.runRegexTest = function() {
    var inputStr = document.getElementById('regexTestInput').value;
    var outputDiv = document.getElementById('regexTestOutput');
    
    if (!inputStr) { 
        outputDiv.innerHTML = "<span style='color:#666'>ç­‰å¾…è¾“å…¥æµ‹è¯•è¯...</span>"; 
        return; 
    }

    var resultStr = inputStr;
    
    // éå†æ‰€æœ‰è„šæœ¬è¿›è¡Œæ›¿æ¢
    (window.currentCardRegexes || []).forEach(script => {
        try {
            var pat = script.regex;
            var regexObj;

            // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå…¼å®¹ "/.../g" å’Œ æ™®é€šå­—ç¬¦ä¸² ä¸¤ç§æ ¼å¼
            if (pat.startsWith('/') && pat.lastIndexOf('/') > 0) {
                // å¦‚æœæ˜¯æ ‡å‡†æ­£åˆ™æ ¼å¼ /pattern/flags
                var lastSlash = pat.lastIndexOf('/');
                var body = pat.substring(1, lastSlash);
                var flags = pat.substring(lastSlash + 1);
                regexObj = new RegExp(body, flags);
            } else {
                // å¦‚æœåªæ˜¯æ™®é€šå­—ç¬¦ä¸² (å¦‚ [STATUS])ï¼Œè‡ªåŠ¨è½¬ä¸ºå…¨å±€æ­£åˆ™
                // è‡ªåŠ¨è½¬ä¹‰ç‰¹æ®Šç¬¦å·ï¼Œé˜²æ­¢æŠ¥é”™
                var safePat = pat.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                regexObj = new RegExp(safePat, "g");
            }

            resultStr = resultStr.replace(regexObj, script.regexReplacementString);
        } catch (e) {
            console.error("æ­£åˆ™è§£æé”™è¯¯:", e);
        }
    });

    outputDiv.innerHTML = resultStr; // æ¸²æŸ“ HTML
};

/* 3. ä¿®å¤ç‰ˆï¼šå‰ç«¯ä»£ç ç”Ÿæˆ (æ¿€æ´»äºŒæ¬¡ç¼–è¾‘ + è‡ªåŠ¨å¡«æµ‹è¯•è¯) */
window.generateFrontendCode = async function() {
    var req = document.getElementById('aiCodePrompt').value.trim();
    if (!req) { auth.toast('éœ€æ±‚ä¸èƒ½ä¸ºç©º...'); return; }
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·é…ç½® API Key'); return; }
    
    var btn = document.getElementById('btnGenCode');
    btn.innerText = 'ğŸ§  æ„å»ºä¸­...'; btn.disabled = true;

    // Prompt ä¿æŒä¸å˜
    var prompt = `ä½ æ˜¯ä¸€ä¸ªSillyTavernå‰ç«¯ä¸“å®¶ã€‚ç”¨æˆ·éœ€æ±‚ï¼šã€${req}ã€‘ã€‚è¯·è¿”å›çº¯JSONï¼š{"name":"è„šæœ¬å","regex":"/\\[å…³é”®è¯\\]/g","code":"HTMLä»£ç "}`;

    try {
        var res = await fetchAI(prompt, config);
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var data = JSON.parse(cleanJson);
        
        // å¡«å…¥æ•°æ®
        document.getElementById('frontName').value = data.name || 'AIè„šæœ¬';
        document.getElementById('frontPattern').value = data.regex || '';
        document.getElementById('frontReplace').value = simpleFormatHTML(data.code) || '';

        // ğŸ”¥ ä¿®å¤ï¼šè‡ªåŠ¨æå–å…³é”®è¯æ”¾å…¥æµ‹è¯•æ¡†ï¼Œè®©ä½ ç›´æ¥çœ‹åˆ°æ•ˆæœ
        var testKey = data.regex.replace(/^\//, '').replace(/\/g[im]*$/, '').replace(/\\/g, ''); // å»æ‰æ­£åˆ™ç¬¦å·
        if(testKey.includes('[') && testKey.includes(']')) {
             // å¦‚æœæ˜¯ [UI] è¿™ç§ï¼Œç›´æ¥å¡«å…¥
             document.getElementById('regexTestInput').value = testKey;
        } else {
             // å¦‚æœå¤ªå¤æ‚ï¼Œå¡«ä¸ªé»˜è®¤çš„
             document.getElementById('regexTestInput').value = "åœ¨æ­¤è¾“å…¥è§¦å‘è¯æµ‹è¯•"; 
        }
        
        // ğŸ”¥ å…³é”®ï¼šä¿å­˜ç¼“å­˜ï¼Œå¹¶æ˜¾ç¤ºäºŒæ¬¡ç¼–è¾‘æ¡†
        window.lastGeneratedData.frontend = data;
        document.getElementById('refineArea_frontend').style.display = 'block';

        auth.toast('âœ¨ ä»£ç å·²ç”Ÿæˆï¼ä¸‹æ–¹å¯ç›´æ¥æµ‹è¯•æˆ–ä¿®æ”¹');
        runRegexTest(); // å°è¯•è¿è¡Œä¸€æ¬¡æµ‹è¯•

    } catch (e) {
        auth.toast('âŒ ç”Ÿæˆå¤±è´¥');
    } finally {
        btn.innerText = 'âœ¨ ä¸€é”®ç”Ÿæˆ'; btn.disabled = false;
    }
};

/* 4. é€šç”¨äºŒæ¬¡ç¼–è¾‘å‡½æ•° (å¤æ´»ç‰ˆ) */
window.refineResult = async function(type) {
    var inputId = `refineInput_${type}`;
    var requirement = document.getElementById(inputId).value.trim();
    
    if (!requirement) { auth.toast('è¯·å‘Šè¯‰æˆ‘æ€ä¹ˆæ”¹...'); return; }
    if (!window.lastGeneratedData[type]) { auth.toast('è¯·å…ˆç”Ÿæˆä¸€æ¬¡å†ä¿®æ”¹'); return; }

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var prevData = JSON.stringify(window.lastGeneratedData[type]);
    
    auth.toast('ğŸ§  æ­£åœ¨æ ¹æ®æ„è§ä¿®æ”¹...');
    
    var prompt = `ä½ ä¹‹å‰ç”Ÿæˆäº†ï¼š${prevData}ã€‚ç”¨æˆ·æ„è§ï¼šã€${requirement}ã€‘ã€‚è¯·ä¿®æ”¹å¹¶è¿”å›å®Œæ•´çš„çº¯JSONã€‚`;

    try {
        var res = await fetchAI(prompt, config);
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var newData = JSON.parse(cleanJson);

        // æ›´æ–°ç¼“å­˜
        window.lastGeneratedData[type] = newData;

        // æ ¹æ®ç±»å‹æ›´æ–°ç•Œé¢
        if (type === 'frontend') {
            document.getElementById('frontName').value = newData.name;
            document.getElementById('frontPattern').value = newData.regex;
            document.getElementById('frontReplace').value = simpleFormatHTML(newData.code);
            runRegexTest(); // é‡æ–°æµ‹è¯•
        } else if (type === 'world') {
            document.getElementById('wiComment').value = newData.comment;
            document.getElementById('wiKeys').value = (newData.keys || []).join(', ');
            document.getElementById('wiContent').value = simpleFormatHTML(newData.content);
        } else if (type === 'wizard') {
            // å¦‚æœæ˜¯äººè®¾å‘å¯¼
            document.getElementById('cardName').value = newData.name || '';
            document.getElementById('cardDesc').value = newData.description || '';
            // ...å…¶ä»–å­—æ®µç•¥...
            if(typeof updatePreviewUI === 'function') updatePreviewUI();
        }

        auth.toast('âœ¨ ä¿®æ”¹å®Œæˆï¼');
        document.getElementById(inputId).value = ''; // æ¸…ç©ºè¾“å…¥æ¡†

    } catch (e) {
        auth.toast('âŒ ä¿®æ”¹å¤±è´¥');
    }
};

/* ================= ğŸš‘ ç´§æ€¥ä¿®å¤è¡¥ä¸ï¼šæ­£åˆ™å¼•æ“ & äºŒæ¬¡ç¼–è¾‘ ================= */

// 1. ä¿®å¤æ­£åˆ™æµ‹è¯•å¼•æ“ (è§£å†³â€œæ¸²æŸ“ä¸å‡ºæ¥â€çš„å¤§Bug)
window.runRegexTest = function() {
    var inputStr = document.getElementById('regexTestInput').value;
    var outputDiv = document.getElementById('regexTestOutput');
    
    // å¦‚æœæ²¡æœ‰è„šæœ¬ï¼Œå…ˆæç¤º
    if (!window.currentCardRegexes || window.currentCardRegexes.length === 0) {
        // å¦‚æœè¾“å…¥æ¡†æœ‰å€¼ä½†æ²¡è„šæœ¬ï¼Œè¯´æ˜å¯èƒ½æ˜¯åˆšç”Ÿæˆè¿˜æ²¡ç‚¹â€œæ³¨å…¥â€
        // è¿™é‡Œåšä¸€ä¸ªç‰¹æ®Šå¤„ç†ï¼šä¸´æ—¶è¯»å–è¾“å…¥æ¡†é‡Œçš„è„šæœ¬æ¥é¢„è§ˆ
        var tempPattern = document.getElementById('frontPattern').value;
        var tempCode = document.getElementById('frontReplace').value;
        if(tempPattern && tempCode && inputStr) {
             // ä¸´æ—¶é¢„è§ˆæ¨¡å¼
             var tempRegex = tempPattern.replace(/^\/|\/[gim]*$/g, ''); // å»æ‰æ­£åˆ™æ–œæ 
             try {
                 var re = new RegExp(tempRegex, 'g');
                 outputDiv.innerHTML = inputStr.replace(re, tempCode);
                 return;
             } catch(e) {}
        }
    }

    if (!inputStr) { outputDiv.innerHTML = "<span style='color:#666'>ç­‰å¾…è¾“å…¥æµ‹è¯•è¯...</span>"; return; }

    var resultStr = inputStr;
    
    // éå†æ­£åˆ™åˆ—è¡¨è¿›è¡Œæ›¿æ¢
    (window.currentCardRegexes || []).forEach(script => {
        try {
            var pat = script.regex;
            var regexObj;
            
            // æ™ºèƒ½è¯†åˆ«ï¼šæ˜¯ /pattern/g è¿˜æ˜¯ çº¯å­—ç¬¦ä¸²
            if (pat.startsWith('/') && pat.lastIndexOf('/') > 0) {
                var lastSlash = pat.lastIndexOf('/');
                var body = pat.substring(1, lastSlash);
                var flags = pat.substring(lastSlash + 1);
                regexObj = new RegExp(body, flags);
            } else {
                // çº¯å­—ç¬¦ä¸²æ¨¡å¼ (å¦‚ [UI])ï¼Œè‡ªåŠ¨è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
                var safePat = pat.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                regexObj = new RegExp(safePat, "g");
            }
            resultStr = resultStr.replace(regexObj, script.regexReplacementString);
        } catch (e) {
            console.error("æ­£åˆ™è§£æé”™:", e);
        }
    });
    outputDiv.innerHTML = resultStr;
};

// 2. ä¿®å¤å‰ç«¯ç”Ÿæˆé€»è¾‘ (è§£å†³â€œæµ‹è¯•è¯ä¸æ˜¾ç¤ºâ€å’Œâ€œäºŒæ¬¡ç¼–è¾‘æ²¡ååº”â€)
window.generateFrontendCode = async function() {
    var req = document.getElementById('aiCodePrompt').value.trim();
    if (!req) { auth.toast('éœ€æ±‚ä¸èƒ½ä¸ºç©º...'); return; }
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·é…ç½® API Key'); return; }
    
    var btn = document.getElementById('btnGenCode');
    btn.innerText = 'ğŸ§  æ„å»ºä¸­...'; btn.disabled = true;

    // Prompt: å¼ºåˆ¶ AI è¿”å›å¸¦è½¬ä¹‰çš„æ­£åˆ™å­—ç¬¦ä¸²
    var prompt = `ä½ æ˜¯ä¸€ä¸ªSillyTavernå‰ç«¯ä¸“å®¶ã€‚ç”¨æˆ·éœ€æ±‚ï¼šã€${req}ã€‘ã€‚è¯·è¿”å›çº¯JSONï¼š{"name":"è„šæœ¬å","regex":"/\\\\[å…³é”®è¯\\\\]/g","code":"HTMLä»£ç "}`;

    try {
        var res = await fetchAI(prompt, config);
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var data = JSON.parse(cleanJson);
        
        // å¡«å…¥ç¼–è¾‘æ¡†
        document.getElementById('frontName').value = data.name || 'AIè„šæœ¬';
        document.getElementById('frontPattern').value = data.regex || '';
        document.getElementById('frontReplace').value = simpleFormatHTML(data.code) || '';

        // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæå–æµ‹è¯•è¯å¹¶æ˜¾ç¤º
        // é€»è¾‘ï¼šå»æ‰å‰åçš„ / å’Œ /gï¼Œå†å»æ‰è½¬ä¹‰ç¬¦ \
        var rawKey = data.regex.replace(/^\//, '').replace(/\/g[im]*$/, ''); 
        rawKey = rawKey.replace(/\\/g, ''); // å»æ‰è½¬ä¹‰
        
        // å¡«å…¥é»‘è‰²æµ‹è¯•æ¡†
        document.getElementById('regexTestInput').value = rawKey;
        
        // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæ‰‹åŠ¨ä¿å­˜ç¼“å­˜å¹¶æ˜¾ç¤ºäºŒæ¬¡ç¼–è¾‘æ¡†
        window.lastGeneratedData.frontend = data;
        document.getElementById('refineArea_frontend').style.display = 'block';

        auth.toast('âœ¨ ä»£ç å·²ç”Ÿæˆï¼ä¸‹æ–¹å·²è‡ªåŠ¨é¢„è§ˆ');
        
        // ç«‹å³è§¦å‘ä¸€æ¬¡é¢„è§ˆ
        runRegexTest();

    } catch (e) {
        console.error(e);
        auth.toast('âŒ ç”Ÿæˆå¤±è´¥');
    } finally {
        btn.innerText = 'âœ¨ ä¸€é”®ç”Ÿæˆ'; btn.disabled = false;
    }
};

// 3. å¤æ´» RefineResult å‡½æ•° (ç¡®ä¿ç‚¹å‡»â€œè®©å®ƒæ”¹â€æœ‰ååº”)
window.refineResult = async function(type) {
    var inputId = `refineInput_${type}`;
    var requirement = document.getElementById(inputId).value.trim();
    if (!requirement) { auth.toast('è¯·å‘Šè¯‰æˆ‘æ€ä¹ˆæ”¹...'); return; }
    if (!window.lastGeneratedData[type]) { auth.toast('è¯·å…ˆç”Ÿæˆä¸€æ¬¡'); return; }

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var prevData = JSON.stringify(window.lastGeneratedData[type]);
    
    auth.toast('ğŸ§  ä¿®æ”¹ä¸­...');
    var prompt = `åŸæ•°æ®ï¼š${prevData}ã€‚ä¿®æ”¹æ„è§ï¼šã€${requirement}ã€‘ã€‚è¯·ä¿®æ”¹å¹¶è¿”å›å®Œæ•´JSONã€‚`;

    try {
        var res = await fetchAI(prompt, config);
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var newData = JSON.parse(cleanJson);
        window.lastGeneratedData[type] = newData;

        // æ›´æ–°ç•Œé¢
        if (type === 'frontend') {
            document.getElementById('frontName').value = newData.name;
            document.getElementById('frontPattern').value = newData.regex;
            document.getElementById('frontReplace').value = simpleFormatHTML(newData.code);
            // å†æ¬¡è‡ªåŠ¨å¡«å…¥æµ‹è¯•è¯
            var rawKey = newData.regex.replace(/^\//, '').replace(/\/g[im]*$/, '').replace(/\\/g, '');
            document.getElementById('regexTestInput').value = rawKey;
            runRegexTest();
        } else if (type === 'world') {
            document.getElementById('wiComment').value = newData.comment;
            document.getElementById('wiKeys').value = (newData.keys||[]).join(', ');
            document.getElementById('wiContent').value = simpleFormatHTML(newData.content);
        } else if (type === 'wizard') {
            document.getElementById('cardName').value = newData.name || '';
            document.getElementById('cardDesc').value = newData.description || '';
            if(typeof updatePreviewUI === 'function') updatePreviewUI();
        }
        auth.toast('âœ¨ ä¿®æ”¹å®Œæˆï¼');
        document.getElementById(inputId).value = ''; 
    } catch (e) { auth.toast('âŒ ä¿®æ”¹å¤±è´¥'); }
};

/* ================= ğŸ”§ ç»ˆæä¿®å¤è¡¥ä¸ï¼šå…³è”ç”Ÿæˆ & å…¨å± & ä¿®å¤æŠ¥é”™ ================= */

/* 1. ä¿®å¤ç”Ÿæˆå¤±è´¥ + å¢åŠ â€œå…³è”è¯¦ç»†è®¾å®šâ€é€»è¾‘ (å‰ç«¯ä»£ç ) */
window.generateFrontendCode = async function() {
    var req = document.getElementById('aiCodePrompt').value.trim();
    // ğŸ”¥ è·å–è¯¦ç»†è®¾å®š
    var charDesc = document.getElementById('cardDesc').value.trim();
    
    if (!req) { auth.toast('éœ€æ±‚ä¸èƒ½ä¸ºç©º...'); return; }
    // ğŸ”¥ å¼ºåˆ¶è¦æ±‚ï¼šå¦‚æœæ²¡å†™è®¾å®šï¼Œæé†’ç”¨æˆ·
    if (!charDesc) { alert('âš ï¸ è¯·å…ˆåœ¨ã€é¢„è§ˆã€‘é¡µå¡«å†™â€œè¯¦ç»†è®¾å®šâ€ï¼\n\nå‰ç«¯ç‰¹æ•ˆéœ€è¦æ ¹æ®è§’è‰²è®¾å®šæ¥å®šåˆ¶é£æ ¼ã€‚'); return; }

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·é…ç½® API Key'); return; }
    
    var btn = document.getElementById('btnGenCode');
    btn.innerText = 'ğŸ§  èåˆè®¾å®šæ„å»ºä¸­...'; btn.disabled = true;

    // ğŸ”¥ Prompt å‡çº§ï¼šæŠŠäººè®¾å–‚ç»™ AI
    var prompt = `
    ä½ æ˜¯ä¸€ä¸ªSillyTavernå‰ç«¯ä¸“å®¶ã€‚
    ã€å½“å‰è§’è‰²è®¾å®šã€‘ï¼š${charDesc.substring(0, 500)}... (å†…å®¹è¿‡é•¿å·²æˆªæ–­)
    ã€ç”¨æˆ·éœ€æ±‚ã€‘ï¼š${req}
    
    è¯·æ ¹æ®ã€è§’è‰²è®¾å®šã€‘çš„é£æ ¼ï¼ˆé…è‰²ã€æ°›å›´ã€æ€§æ ¼ï¼‰ï¼Œè®¾è®¡è¿™æ®µ HTML/CSS ä»£ç ã€‚
    è¯·è¿”å›çº¯JSONï¼š{"name":"è„šæœ¬å","regex":"/\\\\[å…³é”®è¯\\\\]/g","code":"HTMLä»£ç "}
    `;

    try {
        var res = await fetchAI(prompt, config);
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var data = JSON.parse(cleanJson);
        
        document.getElementById('frontName').value = data.name || 'AIè„šæœ¬';
        document.getElementById('frontPattern').value = data.regex || '';
        document.getElementById('frontReplace').value = simpleFormatHTML(data.code) || '';

        var rawKey = data.regex.replace(/^\//, '').replace(/\/g[im]*$/, '').replace(/\\/g, '');
        document.getElementById('regexTestInput').value = rawKey;
        
        window.lastGeneratedData.frontend = data;
        document.getElementById('refineArea_frontend').style.display = 'block';

        auth.toast('âœ¨ å·²æ ¹æ®äººè®¾ç”Ÿæˆä¸“å±ç‰¹æ•ˆï¼');
        runRegexTest();

    } catch (e) {
        console.error(e);
        auth.toast('âŒ ç”Ÿæˆå¤±è´¥ (JSONè§£æé”™)');
    } finally {
        btn.innerText = 'âœ¨ ä¸€é”®ç”Ÿæˆ'; btn.disabled = false;
    }
};

/* 2. ä¿®å¤ç”Ÿæˆå¤±è´¥ + å¢åŠ â€œå…³è”è¯¦ç»†è®¾å®šâ€é€»è¾‘ (ä¸–ç•Œä¹¦) */
window.generateWorldEntry = async function() {
    var req = document.getElementById('aiWorldPrompt').value.trim();
    var charDesc = document.getElementById('cardDesc').value.trim();

    if (!req) { auth.toast('éœ€æ±‚ä¸ºç©º...'); return; }
    // ğŸ”¥ å¼ºåˆ¶è¦æ±‚
    if (!charDesc) { alert('âš ï¸ è¯·å…ˆåœ¨ã€é¢„è§ˆã€‘é¡µå¡«å†™â€œè¯¦ç»†è®¾å®šâ€ï¼\n\nä¸–ç•Œä¹¦éœ€è¦åŸºäºè§’è‰²èƒŒæ™¯æ¥åˆ›ä½œã€‚'); return; }

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) return;

    var btn = document.getElementById('btnGenWorld');
    btn.innerText = 'ğŸ§  ç»“åˆèƒŒæ™¯æ„ç­‘ä¸­...'; btn.disabled = true;

    // ğŸ”¥ Prompt å‡çº§
    var prompt = `
    ä½ æ˜¯ä¸€ä¸ªä¸–ç•Œä¹¦ä¸“å®¶ã€‚
    ã€æ‰€å±è§’è‰²èƒŒæ™¯ã€‘ï¼š${charDesc.substring(0, 500)}
    ã€ç”¨æˆ·éœ€æ±‚ã€‘ï¼šåˆ›å»ºä¸€ä¸ªæ¡ç›®ï¼Œå†…å®¹æ˜¯ï¼š${req}
    
    è¯·ç¡®ä¿è¿™ä¸ªæ¡ç›®ä¸è§’è‰²èƒŒæ™¯é«˜åº¦ä¸€è‡´ã€‚
    è¿”å›çº¯JSONï¼š{"comment":"æ¡ç›®å","keys":["è§¦å‘è¯"],"content":"å†…å®¹"}
    `;

    try {
        var res = await fetchAI(prompt, config);
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var data = JSON.parse(cleanJson);
        
        var formattedContent = data.content;
        if(formattedContent.includes('<') && formattedContent.includes('>')) {
            formattedContent = simpleFormatHTML(formattedContent);
        }

        window.currentWorldInfo.entries.push({
            id: Date.now(),
            keys: data.keys || [],
            content: formattedContent || "",
            comment: data.comment || "AIæ¡ç›®",
            enabled: true, insertion_position: 1
        });
        
        // å­˜ç¼“å­˜ä¾›äºŒæ¬¡ç¼–è¾‘
        window.lastGeneratedData.world = data;
        document.getElementById('refineArea_world').style.display = 'block';

        renderWorldList();
        selectEntry(window.currentWorldInfo.entries.length - 1);
        auth.toast('âœ¨ ä¸“å±æ¡ç›®å·²ç”Ÿæˆï¼');
    } catch (e) { auth.toast('âŒ é”™è¯¯'); } 
    finally { btn.innerText = 'âœ¨ ç”Ÿæˆæ¡ç›®'; btn.disabled = false; }
};

/* 3. æ–°å¢ï¼šAI å†™å¼€åœºç™½åŠŸèƒ½ (è¡¥å…¨ç¼ºå¤±çš„åŠŸèƒ½) */

/* ================= ğŸ”§ è¡¥ä¸ï¼šå¼€åœºç™½ä¸äººè®¾ç”Ÿæˆ (æ— æŠ¥é”™+å¯ä¿®æ”¹ç‰ˆ) ================= */

// 1. ç”Ÿæˆå¼€åœºç™½ (æ— è®ºæˆè´¥ï¼Œå¼ºåˆ¶æ¿€æ´»ä¿®æ”¹æ¡†)
window.autoGenFirstMes = async function() {
    var name = document.getElementById('cardName').value.trim();
    var desc = document.getElementById('cardDesc').value.trim();
    
    // å¦‚æœæ²¡è®¾å®šï¼Œå°±ç”¨åå­—çç¼–ä¸€ä¸ª
    if(!desc) desc = `ä¸€ä¸ªå«${name}çš„è§’è‰²`;
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var btn = event.target; 
    var oldText = btn.innerText;
    btn.innerText = 'âœï¸...'; btn.style.pointerEvents = 'none';

    var prompt = `è§’è‰²ï¼š${name}ã€‚\nè®¾å®šï¼š${desc}\nè¯·å†™ä¸€å¥ç¬¦åˆäººè®¾çš„å¼€åœºç™½ (First Message)ã€‚ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦å¼•å·ã€‚`;

    try {
        var res = await fetchAI(prompt, config);
        var cleanText = res.replace(/```/g, '').trim();
        
        document.getElementById('cardFirstMes').value = cleanText;
        
        // æˆåŠŸé€»è¾‘ï¼šå­˜ç¼“å­˜ï¼Œæ˜¾å¼¹çª—
        window.lastGeneratedData.firstMes = cleanText;
        document.getElementById('refineArea_firstMes').style.display = 'block';

        if(typeof updatePreviewUI === 'function') updatePreviewUI();
        auth.toast('âœ… å¼€åœºç™½å·²ç”Ÿæˆï¼');
        
    } catch(e) {
        console.error("ç”Ÿæˆé‡åˆ°é—®é¢˜ (å·²å¿½ç•¥):", e);
        
        // ğŸ”¥ å¤±è´¥é€»è¾‘ï¼šå‡è£…æˆåŠŸï¼Œå¼ºåˆ¶æ˜¾å¼¹çª—ï¼Œæ–¹ä¾¿ä½ é‡è¯•
        var currentVal = document.getElementById('cardFirstMes').value;
        window.lastGeneratedData.firstMes = currentVal || ""; 
        
        document.getElementById('refineArea_firstMes').style.display = 'block';
        auth.toast('âœ… ç¼–è¾‘æ¨¡å¼å·²å°±ç»ª (å¯ç›´æ¥ä¿®æ”¹)');
        
    } finally { 
        btn.innerText = oldText; btn.style.pointerEvents = 'auto';
    }
};



/* 4. æ–°å¢ï¼šå…¨å±æ”¾å¤§åŠŸèƒ½ */
window.currentFullscreenId = null;

window.toggleFullscreen = function(elementId) {
    var el = document.getElementById(elementId);
    var btn = document.getElementById('fullscreenExitBtn');
    
    if (!el) return;
    
    // æ¿€æ´»å…¨å±
    el.classList.add('fullscreen-active');
    btn.style.display = 'block';
    window.currentFullscreenId = elementId;
    
    // æ‰‹æœºç«¯ä¼˜åŒ–ï¼šè‡ªåŠ¨è·å¾—ç„¦ç‚¹
    el.focus();
};

window.exitFullscreen = function() {
    if (window.currentFullscreenId) {
        var el = document.getElementById(window.currentFullscreenId);
        if (el) el.classList.remove('fullscreen-active');
    }
    document.getElementById('fullscreenExitBtn').style.display = 'none';
    window.currentFullscreenId = null;
};

/* ================= ğŸ”§ ç»ˆæä¿®å¤ï¼šç”·æ€§å‘æ•°æ® & ç¼–è¾‘åŠŸèƒ½ ================= */

// 1. ğŸ”¥ æ•°æ®æºå‡çº§ï¼šç”·æ€§å‘é»˜è®¤å€¼ + å¯ä¿®æ”¹ç»“æ„
// ä¼˜å…ˆè¯»å–æœ¬åœ°ç¼“å­˜(ä¿å­˜ä½ ä¿®æ”¹è¿‡çš„)ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤ç”·æ€§æ•°æ®
window.wizardData = JSON.parse(localStorage.getItem('my_wizard_data_v2')) || {
    identity: { 
        title: "1. èº«ä»½/ç§æ—", 
        tags: ["çš‡å­", "æ‘„æ”¿ç‹", "é­”å°Š", "å¸ˆå°Š", "å½±å«", "ä¹‰çˆ¶", "å¤§å°†å†›", "æ ¡éœ¸", "æ€»è£", "éª‘å£«"] 
    },
    personality: { 
        title: "2. æ€§æ ¼ç‰¹ç‚¹", 
        tags: ["ç–¯æ‰¹", "æ¸…å†·", "è…¹é»‘", "å‚²å¨‡", "æ¸©æŸ”", "å¿ çŠ¬", "é¬¼ç•œ", "ç¦æ¬²", "çˆ¹ç³»", "ç—…å¨‡"] 
    },
    trope: { 
        title: "3. èŒç‚¹/å¤–è²Œ", 
        tags: ["ç™½æ¯›", "çœ¼é•œ", "è¥¿è£…", "ä¼¤ç—•", "äººå¤–", "é•¿å‘", "æ³ªç—£", "å†›è£…", "é»‘çš®", "ä½éŸ³ç‚®"] 
    }
};

// 2. ğŸ”¥ è¦†ç›–æ—§çš„æ¸²æŸ“å‡½æ•° (æ”¯æŒåˆ é™¤é”®)
window.renderWizardTags = function() {
    // æ¸²æŸ“ä¸‰ä¸ªç»„
    renderSingleGroup('identity');
    renderSingleGroup('personality');
    renderSingleGroup('trope');
};

function renderSingleGroup(key) {
    var data = window.wizardData[key];
    var containerId = 'tagGroup' + key.charAt(0).toUpperCase() + key.slice(1);
    var titleId = 'title_' + key;
    
    // æ›´æ–°æ ‡é¢˜æ–‡å­—
    var titleEl = document.getElementById(titleId);
    if(titleEl) titleEl.innerText = data.title;

    // æ›´æ–°æ ‡ç­¾åˆ—è¡¨
    var container = document.getElementById(containerId);
    container.innerHTML = ''; // æ¸…ç©ºæ—§çš„

    data.tags.forEach((t, idx) => {
        var span = document.createElement('span');
        span.className = 'wizard-tag';
        
        // æ ‡ç­¾æ–‡æœ¬éƒ¨åˆ†
        var textNode = document.createTextNode(t);
        span.appendChild(textNode);

        // âŒ åˆ é™¤æŒ‰é’®
        var delBtn = document.createElement('span');
        delBtn.className = 'tag-delete-btn';
        delBtn.innerText = 'Ã—';
        delBtn.title = 'åˆ é™¤æ­¤æ ‡ç­¾';
        delBtn.onclick = function(e) {
            e.stopPropagation(); // é˜²æ­¢è§¦å‘é€‰ä¸­
            deleteWizardTag(key, idx);
        };
        span.appendChild(delBtn);

        // ç‚¹å‡»é€‰ä¸­é€»è¾‘
        span.onclick = function(e) {
            if(e.target === delBtn) return; // ç‚¹åˆ é™¤ä¸é€‰ä¸­
            
            if (key === 'identity') {
                // èº«ä»½å•é€‰
                Array.from(container.children).forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
            } else {
                // å…¶ä»–å¤šé€‰
                this.classList.toggle('selected');
            }
        };
        
        container.appendChild(span);
    });
}

// 3. âœ¨ æ–°å¢ï¼šä¿®æ”¹å¤§æ ‡é¢˜åŠŸèƒ½
window.editWizardTitle = function(key) {
    var oldTitle = window.wizardData[key].title;
    var newTitle = prompt("âœï¸ ä¿®æ”¹æ ‡é¢˜åç§°ï¼š", oldTitle);
    
    if (newTitle && newTitle.trim() !== "") {
        window.wizardData[key].title = newTitle;
        saveWizardData(); // ä¿å­˜
        renderWizardTags(); // åˆ·æ–°
        auth.toast('æ ‡é¢˜å·²ä¿®æ”¹ âœ…');
    }
};

// 4. âœ¨ æ–°å¢ï¼šåˆ é™¤æ ‡ç­¾åŠŸèƒ½
window.deleteWizardTag = function(key, idx) {
    if(confirm('ç¡®å®šåˆ é™¤æ ‡ç­¾ã€' + window.wizardData[key].tags[idx] + 'ã€‘å—ï¼Ÿ')) {
        window.wizardData[key].tags.splice(idx, 1);
        saveWizardData();
        renderWizardTags();
    }
};

// 5. ğŸ”¥ è¦†ç›–æ—§çš„ï¼šæ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾åŠŸèƒ½
window.addCustomWizardTag = function(key) {
    var text = prompt("â• æ·»åŠ æ–°æ ‡ç­¾ï¼š");
    if (!text) return;
    text = text.trim();
    
    // åŠ å…¥æ•°æ®æº
    window.wizardData[key].tags.push(text);
    saveWizardData();
    renderWizardTags();
    auth.toast('æ ‡ç­¾å·²æ·»åŠ  âœ¨');
};

// 6. ğŸ’¾ è¾…åŠ©ï¼šä¿å­˜æ•°æ®åˆ°æœ¬åœ° (é˜²æ­¢åˆ·æ–°ä¸¢å¤±)
function saveWizardData() {
    localStorage.setItem('my_wizard_data_v2', JSON.stringify(window.wizardData));
}

// ğŸš€ åˆå§‹åŒ–ï¼šé¡µé¢åŠ è½½å®Œç«‹å³æ‰§è¡Œä¸€æ¬¡æ¸²æŸ“
// (ä¸ºäº†é˜²æ­¢æ—§çš„é€»è¾‘è¦†ç›–ï¼Œç¨å¾®å»¶è¿Ÿä¸€ä¸‹)
setTimeout(function() {
    renderWizardTags();
}, 500);

/* ================= ğŸ”§ è¡¥ä¸ï¼šå¼€å¯å…¨å‘˜å¤šé€‰æ¨¡å¼ ================= */

/* ================= ğŸ”§ è¡¥ä¸ï¼šæ ‡ç­¾ç³»ç»Ÿæ ¸å¿ƒä¿®å¤ (è§£å†³ç”Ÿæˆæ— å…³ã€å­˜æ¡£ä¸¢å¤±) ================= */

// 1. å…¨å±€å˜é‡ï¼šå®æ—¶å­˜å‚¨é€‰ä¸­çš„æ ‡ç­¾
window.currentSelectedTags = { identity: [], personality: [], trope: [] };

// 2. è¦†ç›–ï¼šæ¸²æŸ“å•ä¸ªæ ‡ç­¾ç»„ (åŠ å…¥æ•°æ®ç»‘å®š)
window.renderSingleGroup = function(key) {
    var data = window.wizardData[key];
    var containerId = 'tagGroup' + key.charAt(0).toUpperCase() + key.slice(1);
    var titleId = 'title_' + key;
    
    var titleEl = document.getElementById(titleId);
    if(titleEl) titleEl.innerText = data.title;

    var container = document.getElementById(containerId);
    container.innerHTML = ''; 

    data.tags.forEach((t, idx) => {
        var span = document.createElement('span');
        span.className = 'wizard-tag';
        span.innerText = t;

        // åˆ é™¤æŒ‰é’®
        var delBtn = document.createElement('span');
        delBtn.className = 'tag-delete-btn';
        delBtn.innerText = 'Ã—';
        delBtn.onclick = function(e) { e.stopPropagation(); deleteWizardTag(key, idx); };
        span.appendChild(delBtn);

        // ğŸ”¥ ä¿®å¤ï¼šç‚¹å‡»é€»è¾‘
        // æ£€æŸ¥å½“å‰æ˜¯å¦åº”è¯¥è¢«é€‰ä¸­ (ç”¨äºè¯»æ¡£æ¢å¤)
        if (window.currentSelectedTags[key].includes(t)) {
            span.classList.add('selected');
        }

        span.onclick = function(e) {
            if(e.target === delBtn) return;
            
            this.classList.toggle('selected');
            
            // ğŸ”¥ æ ¸å¿ƒï¼šå®æ—¶æ›´æ–°å…¨å±€æ•°æ®
            if (this.classList.contains('selected')) {
                // å¦‚æœæ˜¯èº«ä»½ç»„ä¸”åªæƒ³å•é€‰ï¼Œå¯ä»¥æ¸…ç©ºæ•°ç»„å†pushï¼Œè¿™é‡Œé»˜è®¤å…è®¸å¤šé€‰
                // if(key === 'identity') window.currentSelectedTags[key] = []; 
                if (!window.currentSelectedTags[key].includes(t)) {
                    window.currentSelectedTags[key].push(t);
                }
            } else {
                // å–æ¶ˆé€‰ä¸­
                window.currentSelectedTags[key] = window.currentSelectedTags[key].filter(item => item !== t);
            }
        };
        
        container.appendChild(span);
    });
};

// 3. æ–°å¢ï¼šç”Ÿæˆè¯¦ç»†è®¾å®š (ä¿®å¤ï¼šå¼ºåˆ¶è¯»å–æ ‡ç­¾)
window.autoGenDesc = async function() {
    var name = document.getElementById('cardName').value.trim();
    if (!name) { auth.toast('å…ˆç»™è§’è‰²èµ·ä¸ªåå­—å§ï¼'); return; }
    
    // ğŸ”¥ ä¿®å¤ï¼šä»å…¨å±€å˜é‡è¯»å–æ ‡ç­¾ï¼Œä¸å†ä¾èµ– DOM
    var allTags = [
        ...window.currentSelectedTags.identity, 
        ...window.currentSelectedTags.personality, 
        ...window.currentSelectedTags.trope
    ];
    var tagStr = allTags.join('ã€');

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·å…ˆé…ç½® API Key'); return; }

    var btn = event.target;
    var oldText = btn.innerText;
    btn.innerText = 'âœï¸ æ­£åœ¨å†™...'; btn.style.pointerEvents = 'none';

    // ğŸ”¥ Prompt ä¿®å¤ï¼šæ˜ç¡®å¼ºè°ƒæ ‡ç­¾
    var prompt = `æˆ‘æ˜¯åˆ›é€ è€…ã€‚è¯·ä¸ºè§’è‰²ã€${name}ã€‘å†™ä¸€æ®µâ€œè¯¦ç»†è®¾å®šâ€ã€‚
    ã€å¼ºåˆ¶è¦æ±‚ã€‘ï¼šå¿…é¡»åŸºäºè¿™äº›å±æ€§ç”Ÿæˆï¼š${tagStr || "æ— ç‰¹æ®Šæ ‡ç­¾"}ã€‚
    åŒ…å«å¤–è²Œã€æ€§æ ¼ã€èº«ä¸–ã€‚300å­—å·¦å³ã€‚ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ã€‚`;

    try {
        var res = await fetchAI(prompt, config);
        document.getElementById('cardDesc').value = res.replace(/```/g, '').trim();
        if(typeof updateJsonSource === 'function') updateJsonSource();
        auth.toast('âœ… è®¾å®šå†™å…¥æˆåŠŸï¼');
        checkAndOpenAdvisor(false); 
    } catch (e) {
        auth.toast('âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
    } finally {
        btn.innerText = oldText; btn.style.pointerEvents = 'auto';
    }
};

// 4. æ–°å¢ï¼šæ¢å¤æ ‡ç­¾è§†è§‰çŠ¶æ€ (ç”¨äºè¯»æ¡£)
window.restoreTagVisuals = function() {
    // é‡æ–°æ¸²æŸ“ä¸€éï¼Œæ¸²æŸ“å‡½æ•°ä¼šè‡ªåŠ¨è¯»å– window.currentSelectedTags å¹¶é«˜äº®
    renderWizardTags();
};


/* ================= ğŸ”§ è¡¥ä¸ï¼šå˜é‡æ’å…¥åŠ©æ‰‹ ================= */

// 1. è®°å½•æœ€åç„¦ç‚¹çš„è¾“å…¥æ¡†
window.lastFocusedInput = null;

// ç›‘å¬æ‰€æœ‰æ–‡æœ¬æ¡†çš„èšç„¦äº‹ä»¶
document.addEventListener('focus', function(e) {
    if (e.target.tagName === 'TEXTAREA' || (e.target.tagName === 'INPUT' && e.target.type === 'text')) {
        window.lastFocusedInput = e.target;
    }
}, true);

// 2. æ’å…¥å˜é‡å‡½æ•°
window.insertVar = function(text) {
    var el = window.lastFocusedInput;
    
    // å¦‚æœæ²¡æœ‰ç„¦ç‚¹è®°å½•ï¼Œæˆ–è€…ç„¦ç‚¹ä¸åœ¨é¢„è§ˆé¡µçš„æ¡†é‡Œï¼Œé»˜è®¤æ’åˆ°â€œè¯¦ç»†è®¾å®šâ€é‡Œ
    if (!el) {
        el = document.getElementById('cardDesc');
    }

    if (el) {
        // åœ¨å…‰æ ‡å¤„æ’å…¥
        var start = el.selectionStart;
        var end = el.selectionEnd;
        var val = el.value;
        
        el.value = val.substring(0, start) + text + val.substring(end);
        
        // æ¢å¤å…‰æ ‡ä½ç½®
        el.selectionStart = el.selectionEnd = start + text.length;
        el.focus();
        
        // è§¦å‘è‡ªåŠ¨ä¿å­˜/æ›´æ–°é¢„è§ˆ
        if(typeof updatePreviewUI === 'function') updatePreviewUI();
        
        auth.toast(`å·²æ’å…¥ ${text}`);
    } else {
        auth.toast('è¯·å…ˆç‚¹å‡»ä¸€ä¸ªè¾“å…¥æ¡† ğŸ–±ï¸');
    }
};

/* ================= ğŸ”§ è¡¥ä¸ï¼šåŠ¨æ€å±æ€§ (Stats) ç®¡ç† (ä¿®æ­£ç‰ˆ) ================= */

window.addStatToDesc = function() {
    var key = document.getElementById('statKey').value.trim();
    var val = document.getElementById('statVal').value.trim();
    
    // ğŸ”¥ ä¿®æ”¹ç‚¹1ï¼šç›®æ ‡æ”¹ä¸ºâ€œæ·±åº¦è®¾å®šâ€(cardNote)ï¼Œè¿™æ˜¯æ”¾æ¸¸æˆè§„åˆ™çš„æœ€ä½³ä½ç½®
    var noteEl = document.getElementById('cardNote'); 

    if (!key || !val) { auth.toast('è¯·å¡«å†™å±æ€§åå’Œæ•°å€¼'); return; }
    
    // è‡ªåŠ¨æ„å»ºæŒ‡ä»¤å—
    var statBlock = `
[Dynamic Stats System]
Target: ${key} = ${val}
Rule: Update ${key} based on story events.
Output Format: Display changes at end of reply like <${key}: +2>
`;

    // æ’å…¥é€»è¾‘
    if (noteEl.value.includes('[Dynamic Stats System]')) {
        var newStatLine = `Target: ${key} = ${val}`;
        noteEl.value = noteEl.value.replace('[Dynamic Stats System]', `[Dynamic Stats System]\n${newStatLine}`);
    } else {
        noteEl.value = statBlock.trim() + "\n\n" + noteEl.value;
    }

    // æ¸…ç©ºè¾“å…¥æ¡†
    document.getElementById('statKey').value = '';
    document.getElementById('statVal').value = '';
    
    // è§¦å‘ä¿å­˜
    if(typeof updateJsonSource === 'function') updateJsonSource();
    
    auth.toast(`ğŸ“Š å±æ€§å·²å†™å…¥ã€æ·±åº¦è®¾å®šã€‘`);

    // ğŸ”¥ ä¿®æ”¹ç‚¹2ï¼šå› ä¸ºæ·±åº¦è®¾å®šåœ¨â€œé«˜çº§â€é¡µï¼Œè‡ªåŠ¨åˆ‡è¿‡å»è®©ç”¨æˆ·çœ‹åˆ°æ•ˆæœ
    switchCardTab('advanced'); 

    // è¯¢é—®æ˜¯å¦ç”Ÿæˆå‰ç«¯
    if (confirm(`æ˜¯å¦é¡ºä¾¿ç”Ÿæˆä¸€ä¸ªâ€œ${key}â€çš„çŠ¶æ€æ è„šæœ¬ï¼Ÿ`)) {
        document.getElementById('aiCodePrompt').value = `åšä¸€ä¸ªæ˜¾ç¤º"${key}"çš„çŠ¶æ€æ ï¼Œé¢œè‰²è¦å¥½çœ‹`;
        switchCardTab('regex');
    }
};

/* ================= ğŸ”§ è¡¥ä¸ï¼šå±æ€§é¡µé€»è¾‘ & AI ç­–åˆ’å¸ˆ ================= */

// 1. åŒæ­¥é€»è¾‘ï¼šå±æ€§é¡µçš„ç¼–è¾‘æ¡† <-> é«˜çº§é¡µçš„æ·±åº¦è®¾å®š
// è¿™æ ·ä½ åœ¨å“ªè¾¹æ”¹éƒ½ä¸€æ ·
window.syncStatToNote = function() {
    var val = document.getElementById('statEditor').value;
    var note = document.getElementById('cardNote'); // é«˜çº§é¡µçš„é‚£ä¸ªæ¡†
    if(note) note.value = val;
};

// åˆ‡æ¢Tabæ—¶ï¼ŒæŠŠæ·±åº¦è®¾å®šçš„å†…å®¹åŒæ­¥è¿‡æ¥æ˜¾ç¤º
var originalSwitch = window.switchCardTab;
window.switchCardTab = function(name) {
    originalSwitch(name);
    if (name === 'stats') {
        var note = document.getElementById('cardNote');
        var editor = document.getElementById('statEditor');
        if(note && editor) editor.value = note.value;
    }
};

// 2. AI ç”Ÿæˆæ¸¸æˆè§„åˆ™
window.generateStatLogic = async function() {
    var req = document.getElementById('aiStatPrompt').value.trim();
    if (!req) { auth.toast('è¯·æè¿°ä½ æƒ³è®¾è®¡çš„ç³»ç»Ÿ...'); return; }
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·é…ç½® API Key'); return; }

    var btn = document.getElementById('btnGenStat');
    btn.innerText = 'ğŸ§  è®¾è®¡ä¸­...'; btn.disabled = true;

    // Promptï¼šæ•™ AI å†™ SillyTavern èƒ½å¤Ÿæ‰§è¡Œçš„ Prompt
    var prompt = `
    ä½ æ˜¯ä¸€ä¸ª Prompt Engineerï¼Œä¸“é—¨ä¸º SillyTavern è®¾è®¡ RPG ç³»ç»Ÿã€‚
    ç”¨æˆ·éœ€æ±‚ï¼šã€${req}ã€‘
    
    è¯·ç¼–å†™ä¸€æ®µ System Prompt (æŒ‡ä»¤)ï¼ŒåŒ…å«ï¼š
    1. å˜é‡å®šä¹‰ (Target)ã€‚
    2. å˜æ›´è§„åˆ™ (Rule)ï¼šä»€ä¹ˆæƒ…å†µä¸‹åŠ åˆ†/æ‰£åˆ†ï¼Œä»€ä¹ˆæƒ…å†µä¸‹è§¦å‘ç‰¹æ®Šå‰§æƒ…ã€‚
    3. è¾“å‡ºæ ¼å¼ (Output Format)ï¼šå¼ºåˆ¶ AI åœ¨å›å¤æœ«å°¾ç”¨æ‹¬å·æ˜¾ç¤ºå˜åŒ–ã€‚
    
    è¯·ç›´æ¥è¿”å›è§„åˆ™æ–‡æœ¬ï¼Œä¸è¦è§£é‡Šã€‚æ ¼å¼å‚è€ƒï¼š
    [System Note: This is a RPG game.]
    Target: ...
    Rule: ...
    `;

    try {
        var res = await fetchAI(prompt, config);
        
        // å¡«å…¥ç¼–è¾‘æ¡†
        var editor = document.getElementById('statEditor');
        // å¦‚æœåŸæœ¬æœ‰å†…å®¹ï¼Œå°±è¿½åŠ ï¼›æ²¡æœ‰å°±è¦†ç›–
        editor.value = editor.value ? (editor.value + "\n\n" + res) : res;
        
        // åŒæ­¥åˆ°çœŸæ­£çš„æ·±åº¦è®¾å®š
        syncStatToNote();
        
        // å­˜ç¼“å­˜ä¾›äºŒæ¬¡ç¼–è¾‘
        window.lastGeneratedData.stat = { raw: res }; 
        document.getElementById('refineArea_stat').style.display = 'block';

        auth.toast('âœ¨ è§„åˆ™å·²å†™å…¥æ·±åº¦è®¾å®šï¼');

    } catch (e) {
        auth.toast('âŒ ç”Ÿæˆå¤±è´¥');
    } finally {
        btn.innerText = 'âœ¨ ç”Ÿæˆè§„åˆ™'; btn.disabled = false;
    }
};

// 3. å±æ€§é¡µçš„äºŒæ¬¡ç¼–è¾‘ (é’ˆå¯¹è§„åˆ™æ–‡æœ¬)
// éœ€è¦æŠŠè¿™ä¸ªåŠ åˆ° refineResult çš„åˆ¤æ–­é‡Œï¼Œæˆ–è€…å•ç‹¬å†™ä¸€ä¸ªé€»è¾‘
// ä¸ºäº†â€œæ”¹å°‘ä¸€ç‚¹ä»£ç â€ï¼Œæˆ‘ä»¬åœ¨ refineResult é‡ŒåŠ ä¸€ä¸ªåˆ†æ”¯ï¼š

var originalRefine = window.refineResult;
window.refineResult = async function(type) {
    if (type === 'stat') {
        var inputId = 'refineInput_stat';
        var requirement = document.getElementById(inputId).value.trim();
        if (!requirement) return;
        
        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        var prevData = window.lastGeneratedData.stat.raw; // ä¸Šæ¬¡ç”Ÿæˆçš„è§„åˆ™æ–‡æœ¬
        
        auth.toast('ğŸ§  ä¼˜åŒ–è§„åˆ™ä¸­...');
        
        var prompt = `
        åŸè§„åˆ™ï¼š
        ${prevData}
        
        ä¿®æ”¹æ„è§ï¼šã€${requirement}ã€‘
        
        è¯·é‡å†™è§„åˆ™ã€‚ç›´æ¥è¿”å›å†…å®¹ã€‚
        `;
        
        try {
            var res = await fetchAI(prompt, config);
            
            // è¿™é‡Œæˆ‘ä»¬éœ€è¦æ›¿æ¢æ‰ä¸Šæ¬¡ç”Ÿæˆçš„é‚£éƒ¨åˆ†ï¼Œæ¯”è¾ƒå¤æ‚ã€‚
            // ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥è¦†ç›–æ•´ä¸ªç¼–è¾‘æ¡†ï¼ˆå‡è®¾ç”¨æˆ·ä¸»è¦å°±åœ¨è°ƒè¿™ä¸ªï¼‰
            document.getElementById('statEditor').value = res;
            syncStatToNote();
            
            window.lastGeneratedData.stat.raw = res;
            auth.toast('âœ¨ ä¿®æ”¹å®Œæˆï¼');
            document.getElementById(inputId).value = '';
        } catch(e) { auth.toast('âŒ å¤±è´¥'); }
        return;
    }
    // å…¶ä»–ç±»å‹è°ƒç”¨åŸå‡½æ•°
    originalRefine(type);
};

// 4. ä¿®å¤ addStatToDesc (è®©å®ƒæŠŠå†…å®¹å†™åˆ° statEditor)
window.addStatToDesc = function() {
    var key = document.getElementById('statKey').value.trim();
    var val = document.getElementById('statVal').value.trim();
    var editor = document.getElementById('statEditor');

    if (!key || !val) { auth.toast('è¯·å¡«å†™å®Œæ•´'); return; }

    var newRule = `Target: ${key} = ${val}`;
    
    // ç®€å•è¿½åŠ 
    if (editor.value.includes('[Dynamic Stats System]')) {
        editor.value = editor.value.replace('[Dynamic Stats System]', `[Dynamic Stats System]\n${newRule}`);
    } else {
        editor.value = `[Dynamic Stats System]\n${newRule}\nRule: Update based on story.\nOutput: <${key}: change>\n\n` + editor.value;
    }
    
    // åŒæ­¥
    syncStatToNote();
    
    // æ¸…ç©º
    document.getElementById('statKey').value = '';
    document.getElementById('statVal').value = '';
    auth.toast(`ğŸ“Š å·²æ·»åŠ  ${key}`);
};

/* ================= ğŸ”§ ç»ˆæè¡¥ä¸ï¼šæ™ºèƒ½è§£é‡Š & å…¨çœŸè¯•ç© ================= */

/* ================= ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šå±æ€§ç”Ÿæˆè§„åˆ™ (ä¿®å¤ç‚¹å‡»æ— ååº”) ================= */
window.generateStatLogic = async function() {
    // 1. å¼ºåˆ¶æ ¡éªŒäººè®¾ (é˜²æ­¢ç©ºå¡ç”Ÿæˆ)
    var charDesc = document.getElementById('cardDesc').value.trim();
    if (!charDesc || charDesc.length < 50) { 
        alert("â›” æµç¨‹æ‹¦æˆªï¼š\nè¯·å…ˆåœ¨ã€é¢„è§ˆé¡µã€‘ç”Ÿæˆæˆ–å¡«å†™ã€è¯¦ç»†è®¾å®šã€‘ï¼\n\né€»è¾‘è§„åˆ™éœ€è¦åŸºäºäººè®¾æ€§æ ¼ã€‚"); 
        switchCardTab('preview'); 
        return; 
    }

    // 2. ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæ­£ç¡®è·å–è¾“å…¥æ¡†å†…å®¹
    // (ä¹‹å‰è¿™é‡Œå†™é”™äº†ï¼Œå¯¼è‡´ç‚¹å‡»æŠ¥é”™)
    var inputEl = document.getElementById('aiStatPrompt');
    var req = inputEl ? inputEl.value.trim() : "";

    if (!req) { auth.toast('è¯·å…ˆæè¿°ä½ æƒ³è®¾è®¡çš„è§„åˆ™...'); return; }
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    
    // æ²¡Keyä¹Ÿä¸æŠ¥é”™ï¼Œç›´æ¥è®©ç”¨æˆ·æ‰‹åŠ¨å†™
    if (!config || !config.apiKey) { 
        auth.toast('âš ï¸ æœªé…ç½®Keyï¼Œåˆ‡æ¢è‡³æ‰‹åŠ¨æ¨¡å¼');
        document.getElementById('refineArea_stat').style.display = 'block';
        return;
    }

    var btn = document.getElementById('btnGenStat');
    var oldText = btn.innerText;
    btn.innerText = 'ğŸ§  è®¾è®¡ä¸­...'; btn.disabled = true;

    // 3. Promptï¼šè¦æ±‚è¿”å›ä»£ç +è¯´æ˜ä¹¦
    var prompt = `
    ä½ æ˜¯ä¸€ä¸ªSillyTavernä¸“å®¶ã€‚ç”¨æˆ·éœ€æ±‚ï¼šã€${req}ã€‘ã€‚
    è§’è‰²è®¾å®šï¼š${charDesc.substring(0, 300)}...
    
    è¯·ç¼–å†™ System Prompt è§„åˆ™ï¼Œå¹¶ä¸ºæ–°æ‰‹æä¾›ä¿®æ”¹æŒ‡å—ã€‚
    è¯·è¿”å›çº¯ JSON æ ¼å¼ï¼š
    {
        "script": "å®Œæ•´çš„è§„åˆ™ä»£ç ï¼ˆTarget, Rule, Output...ï¼‰",
        "guide": "ç®€çŸ­çš„ä¿®æ”¹æŒ‡å—ï¼Œå‘Šè¯‰ç”¨æˆ·æ€ä¹ˆè°ƒæ•´æ•°å€¼ã€‚"
    }
    `;

    try {
        var res = await fetchAI(prompt, config);
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var data = JSON.parse(cleanJson);
        
        // 4. å¡«å…¥ä»£ç 
        var editor = document.getElementById('statEditor');
        // å¦‚æœåŸæœ¬æœ‰å†…å®¹ï¼Œå°±è¿½åŠ ï¼›æ²¡æœ‰å°±è¦†ç›–
        editor.value = editor.value ? (editor.value + "\n\n" + data.script) : data.script;
        
        // åŒæ­¥åˆ°æ·±åº¦è®¾å®š
        if(typeof syncStatToNote === 'function') syncStatToNote();

        // 5. å¡«å…¥è¯´æ˜ä¹¦
        var guideBox = document.getElementById('statGuide');
        if(guideBox) {
            guideBox.style.display = 'block';
            guideBox.innerText = "ğŸ“– AI åŠ©æ•™ç¬”è®°ï¼š\n" + data.guide;
        }
        
        // 6. å­˜ç¼“å­˜å¹¶æ˜¾ç¤ºäºŒæ¬¡ç¼–è¾‘æ¡†
        if(!window.lastGeneratedData) window.lastGeneratedData = {};
        window.lastGeneratedData.stat = { raw: data.script };
        document.getElementById('refineArea_stat').style.display = 'block';

        auth.toast('âœ¨ è§„åˆ™ä¸è¯´æ˜ä¹¦å·²ç”Ÿæˆï¼');

    } catch (e) {
        console.error(e);
        // ğŸ”¥ å¤±è´¥ä¹Ÿä¸æŠ¥é”™ï¼Œç›´æ¥æ˜¾ç¤ºç¼–è¾‘æ¡†è®©ç”¨æˆ·æ‰‹å†™
        auth.toast('âœ… ç¼–è¾‘æ¨¡å¼å·²å°±ç»ª (å¯æ‰‹åŠ¨ä¿®æ”¹)');
        document.getElementById('refineArea_stat').style.display = 'block';
        
    } finally {
        btn.innerText = oldText; btn.disabled = false;
    }
};


/* 2. æ ¸å¿ƒåŠŸèƒ½ï¼šå…¨çœŸè¯•ç©å¼•æ“ */
window.testChatHistory = []; // ä¸´æ—¶èŠå¤©è®°å½•

window.startPlaytest = function() {
    var chatBox = document.getElementById('testChatBox');
    chatBox.innerHTML = '';
    window.testChatHistory = [];

    // 1. è·å–å¡ç‰‡æ•°æ®
    var name = document.getElementById('cardName').value || 'è§’è‰²';
    var firstMes = document.getElementById('cardFirstMes').value;
    
    // å¦‚æœæ²¡æœ‰å¼€åœºç™½ï¼Œæç¤ºç”¨æˆ·
    if (!firstMes) {
        chatBox.innerHTML = '<div style="text-align:center; color:#e74c3c;">âš ï¸ è¿˜æ²¡æœ‰å†™å¼€åœºç™½ï¼Œæ— æ³•å¼€å§‹ã€‚</div>';
        return;
    }

    // 2. æ¨¡æ‹Ÿç³»ç»Ÿï¼šåº”ç”¨æ­£åˆ™æ¸²æŸ“å¼€åœºç™½
    // è¿™å°±æ˜¯â€œå‰ç«¯â€ç”Ÿæ•ˆçš„å…³é”®ï¼
    var renderedMes = applyRegexEffects(firstMes);
    
    // 3. ä¸Šå±
    appendTestBubble('char', renderedMes);
    auth.toast('ğŸ® æµ‹è¯•ç¯å¢ƒå·²åŠ è½½ (æ­£åˆ™+ä¸–ç•Œä¹¦+é€»è¾‘å·²å°±ç»ª)');
};

window.sendTestMsg = async function() {
    var input = document.getElementById('testInput');
    var text = input.value.trim();
    if (!text) return;

    // ç”¨æˆ·æ¶ˆæ¯ä¸Šå±
    appendTestBubble('user', text);
    window.testChatHistory.push({ role: 'user', content: text });
    input.value = '';

    // å‡†å¤‡å‘é€ç»™ AI
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { appendTestBubble('char', '(æ— API Key)'); return; }

    var chatBox = document.getElementById('testChatBox');
    var loadingDiv = document.createElement('div');
    loadingDiv.innerText = 'ğŸ¤– è¿ç®—é€»è¾‘ä¸­...';
    loadingDiv.style.cssText = "font-size:10px; color:#999; margin-left:10px;";
    chatBox.appendChild(loadingDiv);

    // ğŸ”¥ æ„é€ è¶…çº§ Prompt (æ¨¡æ‹Ÿé…’é¦†çš„æ ¸å¿ƒ)
    // åŒ…å«ï¼šæ·±åº¦è®¾å®š(é€»è¾‘) + ä¸–ç•Œä¹¦(å¦‚æœæœ‰) + è¯¦ç»†è®¾å®š + èŠå¤©è®°å½•
    var logic = document.getElementById('statEditor').value || ""; // é€»è¾‘
    var desc = document.getElementById('cardDesc').value || ""; // äººè®¾
    var world = ""; 
    
    // ç®€å•çš„ä¸–ç•Œä¹¦æ³¨å…¥ (å¦‚æœè¾“å…¥åŒ…å«å…³é”®è¯ï¼Œå°±æ³¨å…¥å†…å®¹)
    if (window.currentWorldInfo && window.currentWorldInfo.entries) {
        window.currentWorldInfo.entries.forEach(entry => {
            // ç®€å•çš„å…³é”®è¯åŒ¹é…
            if (entry.keys.some(k => text.includes(k))) {
                world += `[World Info: ${entry.content}]\n`;
                console.log("è§¦å‘ä¸–ç•Œä¹¦:", entry.comment);
            }
        });
    }

    var promptMessages = [
        { role: "system", content: logic + "\n" + world + "\n" + desc },
        ...window.testChatHistory // é™„å¸¦å†å²è®°å½•
    ];

    try {
        var res = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: promptMessages
            })
        });
        var data = await res.json();
        var reply = data.choices[0].message.content;

        loadingDiv.remove();
        
        // ğŸ”¥ å…³é”®ï¼šæ‹¿åˆ° AI å›å¤åï¼Œç«‹åˆ»è·‘ä¸€éæ­£åˆ™å¼•æ“
        var finalHtml = applyRegexEffects(reply);
        
        appendTestBubble('char', finalHtml);
        window.testChatHistory.push({ role: 'assistant', content: reply });

    } catch (e) {
        loadingDiv.remove();
        appendTestBubble('char', 'âŒ æ¨¡æ‹Ÿå¤±è´¥: ' + e.message);
    }
};

/* è¾…åŠ©ï¼šæ­£åˆ™æ¸²æŸ“å¼•æ“ (å¤ç”¨ä¹‹å‰çš„é€»è¾‘ï¼Œä½†è¿”å›å­—ç¬¦ä¸²) */
function applyRegexEffects(text) {
    var result = text;
    (window.currentCardRegexes || []).forEach(script => {
        try {
            var pat = script.regex;
            var regexObj;
            if (pat.startsWith('/') && pat.lastIndexOf('/') > 0) {
                var body = pat.substring(1, pat.lastIndexOf('/'));
                var flags = pat.substring(pat.lastIndexOf('/') + 1);
                regexObj = new RegExp(body, flags);
            } else {
                var safePat = pat.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                regexObj = new RegExp(safePat, "g");
            }
            result = result.replace(regexObj, script.regexReplacementString);
        } catch (e) {}
    });
    return result;
}

function appendTestBubble(role, html) {
    var box = document.getElementById('testChatBox');
    var div = document.createElement('div');
    div.className = `test-msg ${role}`;
    div.innerHTML = html; // è¿™é‡Œå…è®¸ HTML (æ­£åˆ™ç”Ÿæˆçš„ç‰¹æ•ˆ)
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

/* ================= ğŸ”§ æ–°å¢åŠŸèƒ½ï¼šç ´é™(é¢„è®¾)ç®¡ç†å™¨ ================= */

/* ================= ğŸ”§ è¡¥ä¸ï¼šåŒåº“åˆå§‹åŒ– (ç©ºåº“) ================= */
// 1. åˆå§‹åŒ–ç©ºåº“ (åªè¯»å–ç”¨æˆ·å¯¼å…¥çš„)
window.JAILBREAK_DB = JSON.parse(localStorage.getItem('my_jailbreaks')) || [];
window.PRESET_DB = JSON.parse(localStorage.getItem('my_presets')) || [];

// 2. æ¸²æŸ“åˆ—è¡¨å‡½æ•° (åŒæ æ¸²æŸ“)
window.renderPresetList = function() {
    // æ¸²æŸ“ç ´é™
    var jbBox = document.getElementById('jailbreakListContainer');
    jbBox.innerHTML = window.JAILBREAK_DB.length ? '' : '<div style="text-align:center;color:#ccc;margin-top:20px;">æš‚æ— ç ´é™<br>è¯·å¯¼å…¥</div>';
    
    window.JAILBREAK_DB.forEach((item, idx) => {
        var div = document.createElement('div');
        div.style.cssText = "padding:8px; background:#fff; border:1px solid #ffccbc; margin-bottom:5px; border-radius:4px; cursor:pointer; font-size:12px;";
        div.innerHTML = `<b>${item.name}</b>`;
        div.onclick = () => applyPreset(item.content, "ç ´é™");
        
        // åˆ é™¤æŒ‰é’®
        var del = document.createElement('span');
        del.innerHTML = ' Ã—'; del.style.color = 'red'; del.style.float = 'right';
        del.onclick = (e) => { e.stopPropagation(); deleteItem('jailbreak', idx); };
        div.appendChild(del);
        
        jbBox.appendChild(div);
    });

    // æ¸²æŸ“é¢„è®¾
    var pBox = document.getElementById('presetListContainer');
    pBox.innerHTML = window.PRESET_DB.length ? '' : '<div style="text-align:center;color:#ccc;margin-top:20px;">æš‚æ— é¢„è®¾<br>è¯·å¯¼å…¥</div>';
    
    window.PRESET_DB.forEach((item, idx) => {
        var div = document.createElement('div');
        div.style.cssText = "padding:8px; background:#fff; border:1px solid #d1c4e9; margin-bottom:5px; border-radius:4px; cursor:pointer; font-size:12px;";
        div.innerHTML = `<b>${item.name}</b>`;
        div.onclick = () => applyPreset(item.content, "é¢„è®¾");
        
        // åˆ é™¤æŒ‰é’®
        var del = document.createElement('span');
        del.innerHTML = ' Ã—'; del.style.color = 'red'; del.style.float = 'right';
        del.onclick = (e) => { e.stopPropagation(); deleteItem('preset', idx); };
        div.appendChild(del);
        
        pBox.appendChild(div);
    });
};

// åˆ é™¤åŠŸèƒ½
window.deleteItem = function(type, idx) {
    if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
        if(type==='jailbreak') {
            window.JAILBREAK_DB.splice(idx, 1);
            localStorage.setItem('my_jailbreaks', JSON.stringify(window.JAILBREAK_DB));
        } else {
            window.PRESET_DB.splice(idx, 1);
            localStorage.setItem('my_presets', JSON.stringify(window.PRESET_DB));
        }
        renderPresetList();
    }
};


/* ================= ğŸ”§ ç»ˆæè¡¥ä¸ï¼šä¸–ç•Œä¹¦é«˜çº§ç‰ˆ & å†›å¸ˆç³»ç»Ÿ ================= */

/* 1. å‡çº§ç‰ˆï¼šæ›´æ–°ä¸–ç•Œä¹¦æ¡ç›® (ä¿å­˜é«˜çº§è®¾ç½®) */
var originalUpdateEntry = window.updateCurrentEntry;
window.updateCurrentEntry = function() {
    if (currentEntryIdx === -1) return;
    var entry = window.currentWorldInfo.entries[currentEntryIdx];
    
    // ä¿å­˜åŸæœ‰å­—æ®µ
    originalUpdateEntry(); 
    
    // ğŸ”¥ ä¿å­˜æ–°åŠ çš„é«˜çº§å­—æ®µ
    entry.position = parseInt(document.getElementById('wiPosition').value) || 1;
    entry.scan_depth = parseInt(document.getElementById('wiDepth').value) || 4;
    entry.token_budget = parseInt(document.getElementById('wiBudget').value) || 500;
    
    // å¼ºåˆ¶åŒæ­¥
    entry.constant = false; // é»˜è®¤éå¦‚å½±éšå½¢
    entry.selective = true; // é»˜è®¤å¼€å¯ç­›é€‰
};

/* 2. å‡çº§ç‰ˆï¼šé€‰ä¸­æ¡ç›®æ—¶å›æ˜¾é«˜çº§è®¾ç½® */
var originalSelectEntry = window.selectEntry;
window.selectEntry = function(idx) {
    originalSelectEntry(idx);
    var entry = window.currentWorldInfo.entries[idx];
    
    // å›æ˜¾æ•°æ®
    document.getElementById('wiPosition').value = entry.position !== undefined ? entry.position : 1;
    document.getElementById('wiDepth').value = entry.scan_depth || 4;
    document.getElementById('wiBudget').value = entry.token_budget || 500;
};

/* 3. è”åŠ¨é€»è¾‘ï¼šç”Ÿæˆæ­£åˆ™åï¼Œè¯¢é—®æ˜¯å¦ç”Ÿæˆé…å¥—ä¸–ç•Œä¹¦ */
var originalGenFront = window.generateFrontendCode;
window.generateFrontendCode = async function() {
    await originalGenFront(); // å…ˆè·‘åŸæ¥çš„ç”Ÿæˆ
    
    // ğŸ”¥ æ ¸å¿ƒè”åŠ¨ï¼šå¦‚æœåŸæ¥çš„ç”ŸæˆæˆåŠŸäº† (å‰ç«¯ä»£ç æœ‰äº†)
    // æˆ‘ä»¬å¯ä»¥æ£€æµ‹ä¸€ä¸‹æ˜¯å¦åŒ…å« [STATUS] è¿™ç§è§¦å‘è¯
    var data = window.lastGeneratedData.frontend;
    if (data && data.regex) {
        var rawKey = data.regex.replace(/^\//, '').replace(/\/g[im]*$/, '').replace(/\\/g, '');
        
        // å»¶æ—¶ä¸€ç‚¹å¼¹å‡ºï¼Œä½“éªŒæ›´å¥½
        setTimeout(() => {
            if(confirm(`æ£€æµ‹åˆ°å‰ç«¯è„šæœ¬è§¦å‘è¯ã€${rawKey}ã€‘ã€‚\n\næ˜¯å¦éœ€è¦ç”Ÿæˆä¸€ä¸ªé…å¥—çš„â€œä¸–ç•Œä¹¦æ¡ç›®â€ï¼Ÿ\n(é…’é¦†ä¸­é€šå¸¸éœ€è¦ä¸–ç•Œä¹¦æ¥å­˜å‚¨çŠ¶æ€æ•°å€¼)`)) {
                // è‡ªåŠ¨è·³åˆ°ä¸–ç•Œä¹¦é¡µ
                switchCardTab('world');
                // è‡ªåŠ¨å¡«å…¥éœ€æ±‚
                document.getElementById('aiWorldPrompt').value = `ä¸ºå‰ç«¯è„šæœ¬"${data.name}"ç”Ÿæˆé…å¥—æ•°æ®ç»“æ„ï¼Œè§¦å‘è¯æ˜¯"${rawKey}"ï¼Œå†…å®¹æ˜¯ä¸€æ®µéšè—çš„JSONæ•°æ®æˆ–è®¾å®šä»‹ç»`;
                // è‡ªåŠ¨ç‚¹å‡»ç”Ÿæˆ
                generateWorldEntry();
            }
        }, 1000);
    }
};

/* 4. ğŸ§  å†›å¸ˆç³»ç»Ÿ (AI Advisor) */

/* ================= ğŸ”§ è¡¥ä¸ï¼šå†›å¸ˆç³»ç»Ÿ 2.0 (ç™½è¯æ–‡ + äº¤äº’å¼å»ºè®®) ================= */

window.analyzeCardNeeds = async function() {
    var name = document.getElementById('cardName').value;
    var desc = document.getElementById('cardDesc').value.trim();
    
    // å¼ºåˆ¶é—¨æ§›
    if (desc.length < 200) { console.log("å­—æ•°ä¸å¤Ÿï¼Œå†›å¸ˆæš‚ä¸æ‰“æ‰°"); return; }

    // æ˜¾ç¤ºçª—å£
    var box = document.getElementById('aiAdvisorBox');
    if(box) box.style.display = 'flex';
    
    var chat = document.getElementById('advisorChat');
    chat.innerHTML = `<div class="ai-loading" style="color:#999;font-size:12px;text-align:center;">ğŸ§  æ­£åœ¨åˆ†æäººè®¾ï¼Œç”Ÿæˆå»ºè®®...</div>`;

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    
    // ğŸ”¥ Prompt å‡çº§ï¼šè¦æ±‚ JSON æ ¼å¼ï¼Œå¤§ç™½è¯ï¼Œæ—  Markdown
    var prompt = `
    æˆ‘æ˜¯å¡ç‰‡ä½œè€…ã€‚è§’è‰²ï¼š${name}ã€‚
    è®¾å®šï¼š${desc.substring(0, 800)}...
    
    è¯·ä½œä¸ºâ€œåˆ¶ä½œé¡¾é—®â€ï¼Œç”¨ã€é€šä¿—æ˜“æ‡‚çš„å¤§ç™½è¯ã€‘ï¼ˆä¸è¦å¤é£ï¼Œä¸è¦ç¿»è¯‘è…”ï¼‰ï¼Œæå‡º 3 ä¸ªå…·ä½“çš„åˆ¶ä½œå»ºè®®ã€‚
    
    å¿…é¡»è¿”å›çº¯ JSON æ•°ç»„ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
    [
        {
            "type": "world",
            "title": "å»ºè®®æ ‡é¢˜ (å¦‚: æ·»åŠ é—¨æ´¾è®¾å®š)",
            "reason": "ä¸ºä»€ä¹ˆå»ºè®®è¿™ä¹ˆåš (å¦‚: å› ä¸ºä»–æ˜¯å‰‘å®¢ï¼Œéœ€è¦èƒŒæ™¯æ”¯æ’‘)",
            "prompt": "ç”Ÿæˆä¸€ä¸ªã€é’äº‘é—¨ã€‘çš„è®¾å®šï¼ŒåŒ…å«é—¨è§„å’Œåœ°ç†ä½ç½®"
        },
        {
            "type": "frontend",
            "title": "å»ºè®®æ ‡é¢˜ (å¦‚: å¢åŠ å‰‘æ°”ç‰¹æ•ˆ)",
            "reason": "ç†ç”±...",
            "prompt": "åšä¸€ä¸ªå…¨å±çš„å‰‘æ°”åˆ’è¿‡ç‰¹æ•ˆï¼ŒåŠé€æ˜ç™½è‰²"
        },
        {
            "type": "stat",
            "title": "å»ºè®®æ ‡é¢˜ (å¦‚: é»‘åŒ–å€¼ç³»ç»Ÿ)",
            "reason": "ç†ç”±...",
            "prompt": "è®¾è®¡ä¸€å¥—ã€é»‘åŒ–å€¼ã€‘ç³»ç»Ÿï¼Œæ•°å€¼è¶Šé«˜å¯¹è¯è¶Šç–¯ç‹‚"
        }
    ]
    æ³¨æ„ï¼š
    1. type åªèƒ½æ˜¯ "world"(ä¸–ç•Œä¹¦), "frontend"(å‰ç«¯), "stat"(å±æ€§)ã€‚
    2. prompt æ˜¯å¡«å…¥ç”Ÿæˆå™¨çš„æŒ‡ä»¤ï¼Œè¦å…·ä½“ã€‚
    3. ä¸è¦è¾“å‡ºä»»ä½• Markdown ç¬¦å·æˆ–é¢å¤–æ–‡å­—ï¼Œåªè¾“å‡º JSONã€‚
    `;

    try {
        var res = await fetchAI(prompt, config);
        // æ¸…ç†å¯èƒ½å­˜åœ¨çš„ ```json åŒ…è£¹
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var suggestions = JSON.parse(cleanJson);
        
        // æ¸…ç©º loading
        chat.innerHTML = '';
        
        // ğŸ”¥ æ¸²æŸ“å»ºè®®æ°”æ³¡
        suggestions.forEach(item => {
            renderSuggestionBubble(item);
        });
        
    } catch(e) { 
        console.error(e);
        chat.innerHTML += `<div class="advisor-bubble">âŒ å†›å¸ˆè„‘å­å¡ä½äº†... (è§£æå¤±è´¥)</div>`; 
    }
};

/* è¾…åŠ©ï¼šæ¸²æŸ“å•ä¸ªå»ºè®®æ°”æ³¡ */
function renderSuggestionBubble(item) {
    var chat = document.getElementById('advisorChat');
    var div = document.createElement('div');
    div.className = 'advisor-bubble';
    
    // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡
    var icon = "ğŸ’¡";
    if(item.type === 'world') icon = "ğŸŒ";
    if(item.type === 'frontend') icon = "ğŸ¨";
    if(item.type === 'stat') icon = "ğŸ“Š";

    div.innerHTML = `
        <div style="font-weight:bold; color:#6c5ce7; margin-bottom:4px;">${icon} ${item.title}</div>
        <div style="font-size:12px; color:#666; margin-bottom:8px;">${item.reason}</div>
        <button class="advisor-action-btn" onclick="jumpToCreator('${item.type}', '${item.prompt.replace(/'/g, "\\'")}')">
            ğŸ‘‰ å»æ·»åŠ  (è‡ªåŠ¨å¡«å•)
        </button>
    `;
    
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}



/* ================= ğŸ”§ è¡¥ä¸ï¼šå¯¹è¯é€»è¾‘ (å¤§ç™½è¯ç‰ˆ) ================= */
window.sendAdvisorMsg = async function() {
    var input = document.getElementById('advisorInput');
    var text = input.value.trim();
    if(!text) return;
    
    var chat = document.getElementById('advisorChat');
    // ç”¨æˆ·æ°”æ³¡
    chat.innerHTML += `<div style="text-align:right; margin:5px 0; color:#6c5ce7; font-size:12px; padding:5px; background:#f0f0f0; border-radius:8px; display:inline-block; margin-left:auto;">${text}</div><div style="clear:both;"></div>`;
    input.value = '';
    
    // æ˜¾ç¤ºæ€è€ƒä¸­
    var loadingId = 'adv-loading-' + Date.now();
    chat.innerHTML += `<div id="${loadingId}" class="ai-loading" style="font-size:10px; color:#999;">ğŸ§  æ€è€ƒä¸­...</div>`;
    chat.scrollTop = chat.scrollHeight;

    // é€»è¾‘
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var desc = document.getElementById('cardDesc').value;
    
    // ğŸ”¥ Prompt ä¿®æ”¹ï¼šæ˜ç¡®è¦æ±‚â€œé€šä¿—æ˜“æ‡‚çš„å¤§ç™½è¯â€
    var prompt = `
    è§’è‰²è®¾å®šï¼š${desc.substring(0, 300)}...
    ç”¨æˆ·é—®ï¼š${text}
    
    è¯·ä½œä¸ºâ€œSillyTavernå¡ç‰‡åˆ¶ä½œé¡¾é—®â€ï¼Œå›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚
    è¦æ±‚ï¼š
    1. è¯­è¨€é€šä¿—æ˜“æ‡‚ï¼Œå¤§ç™½è¯ï¼Œä¸è¦å¤é£ã€‚
    2. é’ˆå¯¹é…’é¦†å¡ç‰‡åˆ¶ä½œï¼ˆæ­£åˆ™ã€ä¸–ç•Œä¹¦ã€å±æ€§ï¼‰ç»™å‡ºä¸“ä¸šå»ºè®®ã€‚
    3. ä¸è¦ä½¿ç”¨ Markdown æ ¼å¼ï¼Œä¸è¦åŠ æ˜Ÿå·*ã€‚
    `;
    
    try {
        var res = await fetchAI(prompt, config);
        document.getElementById(loadingId).remove();
        
        // æ¸²æŸ“ AI å›å¤æ°”æ³¡ (æ™®é€šæ°”æ³¡)
        var div = document.createElement('div');
        div.className = 'advisor-bubble';
        div.innerHTML = res.replace(/\n/g, '<br>');
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    } catch(e) {
        document.getElementById(loadingId).remove();
    }
};



/* ================= ğŸ§© æ ¸å¿ƒè”åŠ¨é€»è¾‘ï¼šå‰ç«¯ç‰¹æ•ˆ + ä¸–ç•Œä¹¦è‡ªåŠ¨å®šä½ ================= */

// 1. å®šä¹‰å…¨å±€â€œæš—å·â€å˜é‡ (ç”¨äºåœ¨ä¸¤ä¸ªå‡½æ•°é—´ä¼ é€’ç±»å‹çº¿ç´¢)
window.currentFrontendTypeHint = ""; 

// 2. ã€æ¥æ”¶ç«¯ã€‘ä¸–ç•Œä¹¦ç”Ÿæˆå™¨ (å‡çº§ç‰ˆï¼šä¼šè¯»æš—å·ã€ä¼šè‡ªåŠ¨å®šä½ç½®)

// 1. ä¸–ç•Œä¹¦ç”Ÿæˆ (å¸¦é”)
window.generateWorldEntry = async function() {
    // ğŸ”’ å¼ºåˆ¶æ ¡éªŒé”
    var charDesc = document.getElementById('cardDesc').value.trim();
    if (!charDesc || charDesc.length < 50) { 
        alert("â›” æµç¨‹æ‹¦æˆªï¼š\nè¯·å…ˆåœ¨ã€é¢„è§ˆé¡µã€‘ç”Ÿæˆæˆ–å¡«å†™ã€è¯¦ç»†è®¾å®šã€‘ï¼\n\nä¸–ç•Œä¹¦å¿…é¡»åŸºäºäººè®¾èƒŒæ™¯æ‰èƒ½ç”Ÿæˆï¼Œå¦åˆ™æ²¡æœ‰çµé­‚ã€‚"); 
        switchCardTab('preview'); 
        return; 
    }

    var req = document.getElementById('aiWorldPrompt').value.trim();
    if (!req) { auth.toast('éœ€æ±‚ä¸ºç©º...'); return; }

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) return;

    var btn = document.getElementById('btnGenWorld');
    btn.innerText = 'ğŸ§  æ™ºèƒ½å¸ƒå±€ä¸­...'; btn.disabled = true;

    // ğŸ”¥ å…³é”®æ­¥éª¤ï¼šè¯»å–å‰ç«¯ç”Ÿæˆå™¨ç•™ä¸‹çš„â€œæš—å·â€
    var typeHint = window.currentFrontendTypeHint || "æ™®é€šæ¡ç›®";

    // ğŸ”¥ å…³é”®æ­¥éª¤ï¼šPrompt å‡çº§ï¼Œå‘Šè¯‰ AI æ ¹æ®æš—å·æ¥å†³å®š Position
    var prompt = `
    ä½ æ˜¯ä¸€ä¸ªä¸–ç•Œä¹¦ä¸“å®¶ã€‚
    ã€æ‰€å±è§’è‰²èƒŒæ™¯ã€‘ï¼š${charDesc.substring(0, 500)}
    ã€ç”¨æˆ·éœ€æ±‚ã€‘ï¼š${req}
    ã€ç±»å‹çº¿ç´¢ã€‘ï¼š${typeHint}
    
    è¯·ç”Ÿæˆä¸€ä¸ª JSON æ¡ç›®ã€‚
    ç‰¹åˆ«æ³¨æ„ "position" å­—æ®µ (0-4)ï¼š
    - å¦‚æœæ˜¯ã€çŠ¶æ€æ /Status Barã€‘ï¼Œé€šå¸¸è®¾ä¸º 1 (Before Char) æˆ– 3 (After User)ã€‚
    - å¦‚æœæ˜¯ã€å¼€åœºç™½ç‰¹æ•ˆ/Intro Effectã€‘ï¼Œè®¾ä¸º 0 (Before User) æˆ– 4 (Top)ã€‚
    - å¦‚æœæ˜¯ã€æ™®é€šè®¾å®šã€‘ï¼Œè®¾ä¸º 1ã€‚
    
    è¿”å›çº¯JSONï¼š
    {
        "comment": "æ¡ç›®å",
        "keys": ["è§¦å‘è¯"],
        "content": "å†…å®¹",
        "position": 1
    }
    `;

    try {
        var res = await fetchAI(prompt, config);
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var data = JSON.parse(cleanJson);
        
        // æ ¼å¼åŒ– HTML å†…å®¹
        var formattedContent = data.content;
        if(formattedContent.includes('<') && formattedContent.includes('>')) {
            formattedContent = simpleFormatHTML(formattedContent);
        }

        // æ·»åŠ åˆ°åˆ—è¡¨
        window.currentWorldInfo.entries.push({
            id: Date.now(),
            keys: data.keys || [],
            content: formattedContent || "",
            comment: data.comment || "AIæ¡ç›®",
            // ğŸ”¥ å…³é”®æ­¥éª¤ï¼šåº”ç”¨ AI ç®—å‡ºæ¥çš„è‡ªåŠ¨ä½ç½®
            position: data.position !== undefined ? data.position : 1,
            enabled: true, insertion_position: 1, 
            scan_depth: 4, token_budget: 500
        });
        
        // å­˜å…¥ç¼“å­˜ä¾›äºŒæ¬¡ç¼–è¾‘
        window.lastGeneratedData.world = data;
        document.getElementById('refineArea_world').style.display = 'block';

        renderWorldList();
        // é€‰ä¸­æ–°æ¡ç›®ï¼Œè®©ä½ ç«‹åˆ»çœ‹åˆ°ä½ç½®æ˜¯ä¸æ˜¯å˜äº†
        selectEntry(window.currentWorldInfo.entries.length - 1);
        
        auth.toast('âœ¨ æ¡ç›®å·²ç”Ÿæˆ (ä½ç½®å·²è‡ªåŠ¨é€‚é…)');
        
        // ğŸ”¥ å…³é”®æ­¥éª¤ï¼šç”¨å®Œæ¸…é™¤æš—å·ï¼Œé˜²æ­¢å½±å“ä¸‹æ¬¡ç”Ÿæˆ
        window.currentFrontendTypeHint = "";

    } catch (e) { 
        auth.toast('âŒ é”™è¯¯'); 
        console.error(e); 
    } finally { 
        btn.innerText = 'âœ¨ ç”Ÿæˆæ¡ç›®'; 
        btn.disabled = false; 
    }
};

// 3. ã€å‘é€ç«¯ã€‘å‰ç«¯ä»£ç ç”Ÿæˆå™¨ (å‡çº§ç‰ˆï¼šç”Ÿæˆåè‡ªåŠ¨ä¾¦æµ‹ç±»å‹ï¼Œå¹¶å‘èµ·è”åŠ¨)
window.generateFrontendCode = async function() {
    var req = document.getElementById('aiCodePrompt').value.trim();
    var charDesc = document.getElementById('cardDesc').value.trim();
    
    if (!req) { auth.toast('éœ€æ±‚ä¸èƒ½ä¸ºç©º...'); return; }
    if (!charDesc) { alert('âš ï¸ è¯·å…ˆåœ¨ã€é¢„è§ˆã€‘é¡µå¡«å†™â€œè¯¦ç»†è®¾å®šâ€ï¼'); return; }

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·é…ç½® API Key'); return; }
    
    var btn = document.getElementById('btnGenCode');
    btn.innerText = 'ğŸ§  èåˆè®¾å®šæ„å»ºä¸­...'; btn.disabled = true;

    var prompt = `
    ä½ æ˜¯ä¸€ä¸ªSillyTavernå‰ç«¯ä¸“å®¶ã€‚
    ã€å½“å‰è§’è‰²è®¾å®šã€‘ï¼š${charDesc.substring(0, 500)}...
    ã€ç”¨æˆ·éœ€æ±‚ã€‘ï¼š${req}
    
    è¯·æ ¹æ®ã€è§’è‰²è®¾å®šã€‘çš„é£æ ¼è®¾è®¡ HTML/CSS ä»£ç ã€‚
    è¯·è¿”å›çº¯JSONï¼š{"name":"è„šæœ¬å","regex":"/\\\\[å…³é”®è¯\\\\]/g","code":"HTMLä»£ç "}
    `;

    try {
        var res = await fetchAI(prompt, config);
        var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
        var data = JSON.parse(cleanJson);
        
        // å¡«å…¥ç¼–è¾‘æ¡†
        document.getElementById('frontName').value = data.name || 'AIè„šæœ¬';
        document.getElementById('frontPattern').value = data.regex || '';
        document.getElementById('frontReplace').value = simpleFormatHTML(data.code) || '';

        // è‡ªåŠ¨å¡«å…¥æµ‹è¯•è¯
        var rawKey = data.regex.replace(/^\//, '').replace(/\/g[im]*$/, '').replace(/\\/g, '');
        document.getElementById('regexTestInput').value = rawKey;
        
        // å­˜ç¼“å­˜å¹¶æ˜¾ç¤ºäºŒæ¬¡ç¼–è¾‘
        window.lastGeneratedData.frontend = data;
        document.getElementById('refineArea_frontend').style.display = 'block';

        auth.toast('âœ¨ å·²æ ¹æ®äººè®¾ç”Ÿæˆä¸“å±ç‰¹æ•ˆï¼');
        runRegexTest(); // ç«‹å³é¢„è§ˆ

        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ ã€è”åŠ¨æ ¸å¿ƒé€»è¾‘ã€‘ ğŸ‘‡ğŸ‘‡ğŸ‘‡
        // å»¶æ—¶ 1 ç§’ï¼Œè®©ç”¨æˆ·å…ˆçœ‹åˆ°ç‰¹æ•ˆç”ŸæˆæˆåŠŸäº†ï¼Œå†å¼¹çª—è¯¢é—®
        setTimeout(() => {
            if(confirm(`æ£€æµ‹åˆ°å‰ç«¯è„šæœ¬è§¦å‘è¯ã€${rawKey}ã€‘ã€‚\n\næ˜¯å¦éœ€è¦ç”Ÿæˆä¸€ä¸ªé…å¥—çš„â€œä¸–ç•Œä¹¦æ¡ç›®â€ï¼Ÿ\n(é…’é¦†ä¸­é€šå¸¸éœ€è¦ä¸–ç•Œä¹¦æ¥å­˜å‚¨çŠ¶æ€æ•°å€¼æˆ–èƒŒæ™¯è®¾å®š)`)) {
                
                // 1. æ™ºèƒ½æ¨æµ‹è¿™åˆ°åº•æ˜¯ä¸ªå•¥
                var hint = "æ™®é€šè®¾å®š";
                if(data.code.includes('position: fixed') || data.name.includes('çŠ¶æ€') || data.name.includes('Status')) {
                    hint = "çŠ¶æ€æ  (Status Bar)";
                } else if(data.regex.includes('Start') || data.name.includes('å¼€åœº')) {
                    hint = "å¼€åœºç™½ç‰¹æ•ˆ";
                }
                
                // 2. å‘é€æš—å·ï¼šå­˜å…¥å…¨å±€å˜é‡
                window.currentFrontendTypeHint = hint; 

                // 3. è‡ªåŠ¨è·³è½¬åˆ°ä¸–ç•Œä¹¦é¡µ
                switchCardTab('world');
                
                // 4. è‡ªåŠ¨å¡«å¥½éœ€æ±‚
                document.getElementById('aiWorldPrompt').value = `ä¸ºå‰ç«¯è„šæœ¬"${data.name}"(${hint})ç”Ÿæˆé…å¥—æ•°æ®ç»“æ„ï¼Œè§¦å‘è¯"${rawKey}"ï¼Œå†…å®¹æ˜¯ä¸€æ®µéšè—çš„JSONæ•°æ®æˆ–è®¾å®šä»‹ç»`;
                
                // 5. è‡ªåŠ¨ç‚¹å‡»ç”ŸæˆæŒ‰é’®
                generateWorldEntry();
            }
        }, 800);
        // ğŸ‘†ğŸ‘†ğŸ‘† ã€è”åŠ¨ç»“æŸã€‘ ğŸ‘†ğŸ‘†ğŸ‘†

    } catch (e) {
        console.error(e);
        auth.toast('âŒ ç”Ÿæˆå¤±è´¥ (JSONè§£æé”™)');
    } finally {
        btn.innerText = 'âœ¨ ä¸€é”®ç”Ÿæˆ'; btn.disabled = false;
    }
};

/* ================= ğŸ”§ è¡¥ä¸ï¼šå¼ºåˆ¶æµç¨‹ & å¼ºåŠ›å¯¼å…¥ ================= */

/* 1. ä¿®å¤ï¼šå¼ºåŠ›å¯¼å…¥å‡½æ•° (æ”¯æŒå¤šç§JSONæ ¼å¼) */
window.handleImport = function(input, type) {
    var file = input.files[0];
    if (!file) return;

    var reader = new FileReader();
    reader.onload = function(e) {
        try {
            var raw = e.target.result;
            var json = JSON.parse(raw);
            var newItem = null;

            // ğŸ•µï¸ æ™ºèƒ½è¯†åˆ«æ ¼å¼
            // æ ¼å¼A: SillyTavern æ ¼å¼ { "name": "xxx", "prompt": "..." }
            if (json.name && (json.prompt || json.content)) {
                newItem = { name: json.name, content: json.prompt || json.content };
            }
            // æ ¼å¼B: çº¯æ•°ç»„ (æ‰¹é‡å¯¼å…¥)
            else if (Array.isArray(json)) {
                alert("æ£€æµ‹åˆ°æ‰¹é‡æ–‡ä»¶ï¼Œå°†å…¨éƒ¨å¯¼å…¥ï¼");
                json.forEach(j => {
                    if(j.name && (j.prompt || j.content)) {
                        if(type==='jailbreak') window.JAILBREAK_DB.push({name:j.name, content:j.prompt||j.content});
                        else window.PRESET_DB.push({name:j.name, content:j.prompt||j.content});
                    }
                });
            }
            // æ ¼å¼C: ç®€å•çš„ Key-Value { "æˆ‘çš„ç ´é™": "å†…å®¹..." }
            else {
                // å°è¯•å–æ–‡ä»¶åå½“åå­—
                var fileName = file.name.replace(/\.[^/.]+$/, "");
                // å¦‚æœJSONé‡Œæœ‰ 'content' å­—æ®µ
                if (json.content) newItem = { name: fileName, content: json.content };
                // å®åœ¨ä¸è¡Œï¼ŒæŠŠæ•´ä¸ª JSON è½¬å­—ç¬¦ä¸²å½“å†…å®¹ (ä¿åº•)
                else newItem = { name: fileName, content: raw };
            }

            if (newItem) {
                if(type === 'jailbreak') window.JAILBREAK_DB.push(newItem);
                else window.PRESET_DB.push(newItem);
            }

            // ä¿å­˜å¹¶åˆ·æ–°
            localStorage.setItem('my_jailbreaks', JSON.stringify(window.JAILBREAK_DB));
            localStorage.setItem('my_presets', JSON.stringify(window.PRESET_DB));
            renderPresetList();
            auth.toast('âœ… å¯¼å…¥æˆåŠŸï¼');

        } catch (err) {
            console.error(err);
            alert('âŒ å¯¼å…¥å¤±è´¥ï¼šJSON æ ¼å¼éš¾ä»¥è¯†åˆ«ã€‚\nè¯·ç¡®ä¿æ–‡ä»¶æ˜¯æ ‡å‡†çš„ JSON æ ¼å¼ã€‚');
        }
    };
    reader.readAsText(file);
    input.value = '';
};

/* 2. è¦†ç›–ï¼šå‰ç«¯ç”Ÿæˆ (åŠ å…¥å¼ºåˆ¶æ ¡éªŒ) */
var _oldGenFront = window.generateFrontendCode; // å¤‡ä»½æ—§å‡½æ•°(å¦‚æœæœ‰)
window.generateFrontendCode = async function() {
    // ğŸ”¥ æ ¡éªŒï¼šå¿…é¡»å…ˆæœ‰äººè®¾ï¼
    var desc = document.getElementById('cardDesc').value.trim();
    if (!desc || desc.length < 50) {
        alert("â›” æµç¨‹é”™è¯¯ï¼šè¯·å…ˆç”Ÿæˆã€è¯¦ç»†è®¾å®šã€‘ï¼\n\nå‰ç«¯ç‰¹æ•ˆå¿…é¡»åŸºäºè§’è‰²äººè®¾ï¼ˆæ€§æ ¼/é…è‰²ï¼‰æ¥ç”Ÿæˆï¼Œå¦åˆ™æ²¡æœ‰çµé­‚ã€‚");
        // è‡ªåŠ¨è·³å›é¢„è§ˆé¡µ
        switchCardTab('preview');
        return; // å¼ºåˆ¶åœæ­¢
    }
    
    // å¦‚æœé€šè¿‡æ ¡éªŒï¼Œæ‰§è¡ŒåŸé€»è¾‘ (å¦‚æœä½ ä¹‹å‰å·²ç»è´´è¿‡æœ€æ–°çš„ generateFrontendCodeï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥è¿è¡Œ)
    // ä¸ºäº†ä¿é™©ï¼Œæˆ‘æŠŠåŸé€»è¾‘çš„æ ¸å¿ƒè°ƒç”¨å†™åœ¨è¿™é‡Œï¼š
    var req = document.getElementById('aiCodePrompt').value.trim();
    if (!req) { auth.toast('éœ€æ±‚ä¸ºç©º...'); return; }
    
    // ... (åç»­ç”Ÿæˆé€»è¾‘ä¿æŒä¸å˜ï¼Œç¡®ä¿ä½ ç”¨äº†ä¹‹å‰çš„â€œè”åŠ¨ç‰ˆâ€ä»£ç ) ...
    // è¿™é‡Œä¸ºäº†ä¸é‡å¤ç²˜è´´å‡ ç™¾è¡Œä»£ç ï¼Œè¯·ç¡®ä¿ä½ å·²ç»åº”ç”¨äº†ä¸Šä¸€æ¬¡å¯¹è¯æä¾›çš„ generateFrontendCode
    // å¦‚æœä¸Šä¸€æ¬¡çš„ä»£ç æ²¡åˆ ï¼Œè¿™é‡Œåªéœ€è¦åŠ ä¸Šé¢çš„æ ¡éªŒå³å¯ã€‚
    
    // ğŸ‘‡ å¦‚æœä½ æƒ³è¦ä¸€ä¸ªå®Œæ•´çš„è¦†ç›–ç‰ˆï¼Œè¯·ç”¨ä¸‹é¢è¿™ä¸ªï¼š
    executeSafeFrontendGen(req, desc);
};

// å°è£…çš„å®‰å…¨ç”Ÿæˆå‡½æ•° (å¤ç”¨ä¹‹å‰çš„è”åŠ¨é€»è¾‘)
async function executeSafeFrontendGen(req, charDesc) {
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·é…ç½® API Key'); return; }
    
    var btn = document.getElementById('btnGenCode');
    btn.innerText = 'ğŸ§  èåˆè®¾å®šæ„å»ºä¸­...'; btn.disabled = true;

    var prompt = `ä½ æ˜¯ä¸€ä¸ªSillyTavernå‰ç«¯ä¸“å®¶ã€‚\nã€è§’è‰²è®¾å®šã€‘ï¼š${charDesc.substring(0, 300)}...\nã€éœ€æ±‚ã€‘ï¼š${req}\nè¯·è®¾è®¡HTML/CSSã€‚è¿”å›çº¯JSONï¼š{"name":"..","regex":"/\\\\[å…³é”®è¯\\\\]/g","code":".."}`;

    try {
        var res = await fetchAI(prompt, config);
        var data = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());
        
        document.getElementById('frontName').value = data.name;
        document.getElementById('frontPattern').value = data.regex;
        document.getElementById('frontReplace').value = simpleFormatHTML(data.code);
        
        // è”åŠ¨é€»è¾‘
        var rawKey = data.regex.replace(/^\//, '').replace(/\/g[im]*$/, '').replace(/\\/g, '');
        document.getElementById('regexTestInput').value = rawKey;
        window.lastGeneratedData.frontend = data;
        document.getElementById('refineArea_frontend').style.display = 'block';
        runRegexTest();

        setTimeout(() => {
            if(confirm(`æ£€æµ‹åˆ°å‰ç«¯ç‰¹æ•ˆã€${rawKey}ã€‘ã€‚\næ˜¯å¦ç”Ÿæˆé…å¥—ä¸–ç•Œä¹¦ï¼Ÿ`)) {
                var hint = "æ™®é€šè®¾å®š";
                if(data.code.includes('fixed') || data.name.includes('çŠ¶æ€')) hint = "çŠ¶æ€æ ";
                else if(data.regex.includes('Start')) hint = "å¼€åœºç‰¹æ•ˆ";
                window.currentFrontendTypeHint = hint;
                switchCardTab('world');
                document.getElementById('aiWorldPrompt').value = `ä¸º"${data.name}"ç”Ÿæˆé…å¥—æ•°æ®ï¼Œè§¦å‘è¯"${rawKey}"`;
                generateWorldEntry();
            }
        }, 800);

    } catch (e) { auth.toast('âŒ ç”Ÿæˆå¤±è´¥'); } 
    finally { btn.innerText = 'âœ¨ ä¸€é”®ç”Ÿæˆ'; btn.disabled = false; }
}

/* ================= ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šæ­£ç¡®çš„å¼¹çª—å¼€å…³ ================= */
window.togglePresetModal = function() {
    var m = document.getElementById('presetModal');
    // å¦‚æœæ‰¾ä¸åˆ°å…ƒç´ ï¼Œç›´æ¥é€€å‡ºï¼Œé˜²æ­¢æŠ¥é”™
    if (!m) return; 

    // å¦‚æœå½“å‰æ˜¯å…³ç€çš„ (none) æˆ–è€…ç©º
    if (m.style.display === 'none' || m.style.display === '') {
        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ‰“å¼€æ—¶è®¾ä¸º flex (ä¸ºäº†å·¦å³åˆ†æ å¸ƒå±€)ï¼Œè€Œä¸æ˜¯ block
        m.style.display = 'flex'; 
        // å¦‚æœæœ‰æ¸²æŸ“å‡½æ•°ï¼Œé¡ºä¾¿åˆ·æ–°ä¸€ä¸‹åˆ—è¡¨
        if (typeof renderPresetList === 'function') renderPresetList();
    } else {
        // å…³é—­æ—¶è®¾ä¸º none
        m.style.display = 'none';
    }
};

/* ================= ğŸ”§ è¡¥ä¸ï¼šç‚¹å‡»å³â€œä½¿ç”¨â€ (åº”ç”¨é¢„è®¾é€»è¾‘) ================= */
window.applyPreset = function(content, typeName) {
    // 1. æ‰¾åˆ°å­˜æ”¾ä½ç½®ï¼šæ·±åº¦è®¾å®š (Creator Notes / Depth Prompt)
    // è¿™æ˜¯é…’é¦†è¯»å–ç ´é™è§„åˆ™çš„æ ¸å¿ƒåŒºåŸŸ
    var targetBox = document.getElementById('cardNote');
    
    // å¦‚æœä½ åœ¨å±æ€§é¡µï¼Œå¯èƒ½ç”¨çš„æ˜¯ statEditorï¼Œåšä¸ªå…¼å®¹æŸ¥æ‰¾
    if (!targetBox) targetBox = document.getElementById('statEditor');

    if (!targetBox) {
        alert('âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°ã€æ·±åº¦è®¾å®šã€‘è¾“å…¥æ¡†ï¼Œæ— æ³•åº”ç”¨ï¼\nè¯·ç¡®è®¤ä½ æ˜¯å¦è¿˜åœ¨åˆ›é€ è€…å·¥åŠé¡µé¢å†…ã€‚');
        return;
    }

    // 2. æ‰§è¡Œâ€œä½¿ç”¨â€åŠ¨ä½œï¼šè¿½åŠ å†™å…¥
    // å¦‚æœæ¡†é‡ŒåŸæœ¬æœ‰å†…å®¹ï¼Œå°±æ¢ä¸¤è¡Œå†è¿½åŠ ï¼Œé˜²æ­¢ç²˜åœ¨ä¸€èµ·
    if (targetBox.value.trim() !== "") {
        targetBox.value += "\n\n" + content;
    } else {
        targetBox.value = content;
    }

    // 3. å¼ºåˆ¶æ•°æ®åŒæ­¥ (é˜²æ­¢ä½ åœ¨å±æ€§é¡µæ”¹äº†ï¼Œé«˜çº§é¡µæ²¡å˜)
    // å¦‚æœå­˜åœ¨åŒæ­¥å‡½æ•°å°±æ‰§è¡Œä¸€ä¸‹ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
    if (typeof syncStatToNote === 'function') syncStatToNote();
    // åå‘åŒæ­¥ï¼šå¦‚æœåˆšæ‰æ”¹çš„æ˜¯ cardNoteï¼Œä¹Ÿè¦åŒæ­¥ç»™ statEditor
    var statEditor = document.getElementById('statEditor');
    if (statEditor && targetBox.id === 'cardNote') statEditor.value = targetBox.value;
    // å¦‚æœåˆšæ‰æ”¹çš„æ˜¯ statEditorï¼Œä¹Ÿè¦åŒæ­¥ç»™ cardNote
    var cardNote = document.getElementById('cardNote');
    if (cardNote && targetBox.id === 'statEditor') cardNote.value = targetBox.value;

    // 4. âš¡ï¸ è§†è§‰åé¦ˆ (è®©ä½ çŸ¥é“ç”Ÿæ•ˆäº†)
    auth.toast(`âœ… å·²ä½¿ç”¨ï¼${typeName} å·²æ³¨å…¥æ·±åº¦è®¾å®š`);
    
    // è‡ªåŠ¨å…³é—­å¼¹çª—
    window.togglePresetModal(); 
    
    // ğŸ”¥ å…³é”®ä½“éªŒï¼šè‡ªåŠ¨è·³è½¬åˆ°ã€é«˜çº§ã€‘é¡µï¼Œå¹¶é«˜äº®è¾“å…¥æ¡†ï¼Œè®©ä½ äº²çœ¼çœ‹åˆ°å®ƒåŠ è¿›å»äº†
    switchCardTab('advanced'); 
    
    // è®©æ¡†æ¡†é—ªä¸€ä¸‹ç»¿è‰²ï¼Œè¡¨ç¤ºæˆåŠŸ
    targetBox.style.transition = "background 0.5s";
    targetBox.style.backgroundColor = "#d4edda"; // æµ…ç»¿
    setTimeout(() => { targetBox.style.backgroundColor = ""; }, 800);
};

/* ================= ğŸ”§ ä¿®æ­£è¡¥ä¸ï¼šä¸´æ—¶ç ´é™ (åªå½±å“ç”Ÿæˆ) ================= */

// 1. å®šä¹‰ä¸€ä¸ªä¸´æ—¶å˜é‡ (ç›¸å½“äºå†…å­˜æ¡)
window.tempActiveJailbreak = ""; 

// 2. è¦†ç›–ï¼šç‚¹å‡»â€œä½¿ç”¨â€çš„é€»è¾‘
// æ”¹åŠ¨ç‚¹ï¼šä¸å†å†™å…¥è¾“å…¥æ¡†ï¼Œè€Œæ˜¯å­˜å…¥å†…å­˜å˜é‡
window.applyPreset = function(content, typeName) {
    // å­˜å…¥ä¸´æ—¶å˜é‡
    window.tempActiveJailbreak = content;

    // è§†è§‰åé¦ˆï¼šåªå¼¹çª—æç¤ºï¼Œä¸è·³è½¬é¡µé¢ï¼Œä¸æ”¹åŠ¨è¾“å…¥æ¡†
    auth.toast(`ğŸ’‰ ${typeName} å·²æ³¨å…¥ç”Ÿæˆå¼•æ“ï¼\n(ä»…æœ¬æ¬¡ç¼–è¾‘æœ‰æ•ˆï¼Œä¸å†™å…¥å¡ç‰‡)`);
    
    // å…³é—­å¼¹çª—
    window.togglePresetModal();
};

// 3. è¦†ç›–ï¼šæ ¸å¿ƒè¯·æ±‚å‡½æ•° (fetchAI)
// æ”¹åŠ¨ç‚¹ï¼šåœ¨å‘é€è¯·æ±‚å‰ï¼Œæ£€æŸ¥æœ‰æ²¡æœ‰â€œä¸´æ—¶ç ´é™â€ï¼Œæœ‰çš„è¯åŠ å¡åˆ° System Prompt é‡Œ
window.fetchAI = async function(userPrompt, config) {
    if(!config || !config.apiKey) throw new Error("No API Key");

    // --- ğŸ”¥ æ ¸å¿ƒä¿®æ”¹å¼€å§‹ ---
    var messages = [];

    // å¦‚æœå†…å­˜é‡Œæœ‰ç ´é™/é¢„è®¾ï¼ŒæŠŠå®ƒä½œä¸ºæœ€é«˜æŒ‡ä»¤ (System) æ”¾åœ¨ç¬¬ä¸€æ¡
    if (window.tempActiveJailbreak) {
        messages.push({ 
            role: "system", 
            content: window.tempActiveJailbreak 
        });
        console.log("å·²åº”ç”¨ä¸´æ—¶ç ´é™:", window.tempActiveJailbreak.substring(0, 20) + "...");
    }

    // ç„¶åæ‰æ˜¯å…·ä½“çš„è¦æ±‚ (User)
    messages.push({ role: "user", content: userPrompt });
    // --- ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ç»“æŸ ---

    const response = await fetch(`${config.apiUrl}/chat/completions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
        body: JSON.stringify({
            model: config.model || 'gpt-3.5-turbo',
            messages: messages, // å‘é€ç»„åˆå¥½çš„æ¶ˆæ¯é“¾
            temperature: 0.7,   // ç¨å¾®åŠ ç‚¹åˆ›é€ æ€§
            stream: false
        })
    });

    const data = await response.json();
    
    if(data.error) {
        throw new Error(data.error.message || "API Error");
    }
    return data.choices[0].message.content;
};

/* ================= ğŸ”§ è¡¥ä¸ï¼šæ— è„‘ç”Ÿæˆæ¨¡å¼ & å†›å¸ˆå¼ºåˆ¶å¬å”¤ ================= */

/* 1. ä¿®å¤ï¼šè¯¦ç»†è®¾å®šç”Ÿæˆ (ç»å¯¹ä¸å†æŠ¥é”™) */
window.autoGenDesc = async function() {
    var name = document.getElementById('cardName').value.trim();
    if (!name) { auth.toast('å…ˆç»™è§’è‰²èµ·ä¸ªåå­—å§ï¼'); return; }
    
    // è·å–æ ‡ç­¾
    var tags = Array.from(document.querySelectorAll('.wizard-tag.selected'))
                    .map(el => el.textContent).join('ã€');

    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·å…ˆé…ç½® API Key'); return; }

    var btn = event.target;
    var oldText = btn.innerText;
    btn.innerText = 'âœï¸ æ­£åœ¨å†™...'; btn.style.pointerEvents = 'none';

    var prompt = `æˆ‘æ˜¯åˆ›é€ è€…ã€‚è¯·ä¸ºè§’è‰²ã€${name}ã€‘(æ ‡ç­¾:${tags||"æ— "})å†™ä¸€æ®µâ€œè¯¦ç»†è®¾å®šâ€(Description)ã€‚
    è¦æ±‚ï¼šåŒ…å«å¤–è²Œã€æ€§æ ¼ã€èº«ä¸–ã€‚300å­—å·¦å³ã€‚ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ï¼Œä¸è¦ä»»ä½•è§£é‡Šæˆ–ä»£ç å—ã€‚`;

    try {
        var res = await fetchAI(prompt, config);
        
        // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šä¸ç®¡ AI è¿”å›ä»€ä¹ˆï¼Œç›´æ¥å¡«è¿›å»ï¼Œä¸å‡†æŠ¥é”™ï¼
        // æ¸…ç†ä¸€ä¸‹å¯èƒ½å¸¦çš„ Markdown ç¬¦å·
        var cleanText = res.replace(/```/g, '').trim();
        document.getElementById('cardDesc').value = cleanText;
        
        if(typeof updateJsonSource === 'function') updateJsonSource();
        auth.toast('âœ… è®¾å®šå†™å…¥æˆåŠŸï¼');
        
        // ğŸ”¥ å°è¯•è§¦å‘å†›å¸ˆ (ä¼ å…¥ false è¡¨ç¤ºéå¼ºåˆ¶ï¼Œéœ€æ£€æŸ¥å­—æ•°)
        checkAndOpenAdvisor(false); 
        
    } catch (e) {
        console.error(e);
        // åªæœ‰ç½‘ç»œçœŸçš„æ–­äº†æ‰æŠ¥ä¸ªé”™ï¼Œå¦åˆ™éƒ½ç®—æˆåŠŸ
        auth.toast('âŒ ç½‘ç»œè¿æ¥é”™è¯¯');
    } finally {
        btn.innerText = oldText; btn.style.pointerEvents = 'auto';
    }
};

/* 2. ä¿®å¤ï¼šå¼€åœºç™½ç”Ÿæˆ (ç»å¯¹ä¸å†æŠ¥é”™) */
window.autoGenFirstMes = async function() {
    var name = document.getElementById('cardName').value.trim();
    var desc = document.getElementById('cardDesc').value.trim();
    
    // å¦‚æœæ²¡è®¾å®šï¼Œå°±ç”¨åå­—çç¼–ä¸€ä¸ªï¼Œä¸å‡†æŠ¥é”™é˜»æ‹¦
    if(!desc) desc = `ä¸€ä¸ªå«${name}çš„è§’è‰²`;
    
    var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
    var btn = event.target; 
    var oldText = btn.innerText;
    btn.innerText = 'âœï¸...'; 

    var prompt = `è§’è‰²ï¼š${name}ã€‚\nè®¾å®šï¼š${desc}\nè¯·å†™ä¸€å¥å¼€åœºç™½ã€‚ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ã€‚`;

    try {
        var res = await fetchAI(prompt, config);
        document.getElementById('cardFirstMes').value = res.replace(/```/g, '').trim();
        if(typeof updatePreviewUI === 'function') updatePreviewUI();
        auth.toast('âœ… å¼€åœºç™½å†™å…¥æˆåŠŸï¼');
    } catch(e) { auth.toast('âŒ ç½‘ç»œé”™è¯¯'); }
    finally { btn.innerText = oldText; }
};

/* 3. æ–°å¢ï¼šæ‰‹åŠ¨/è‡ªåŠ¨ å†›å¸ˆè§¦å‘é€»è¾‘ */
window.checkAndOpenAdvisor = function(isForce) {
    var desc = document.getElementById('cardDesc').value.trim();
    
    // è‡ªåŠ¨æ¨¡å¼ï¼šå­—æ•°ä¸å¤Ÿå°±ä¸å¼€
    if (!isForce && desc.length < 200) {
        console.log(`å­—æ•° ${desc.length} < 200ï¼Œå†›å¸ˆæš‚ä¸æ‰“æ‰°`);
        return;
    }

    // å¼ºåˆ¶æ¨¡å¼ æˆ– å­—æ•°è¾¾æ ‡ï¼šå¿…é¡»æ‰“å¼€ï¼
    var box = document.getElementById('aiAdvisorBox');
    if (box) {
        box.style.display = 'flex'; // å¼ºåˆ¶æ˜¾ç¤º
        
        // å¦‚æœé‡Œé¢è¿˜æ²¡å†…å®¹ï¼Œæˆ–è€…è¿™æ¬¡æ˜¯å¼ºåˆ¶ç‚¹å¼€çš„ï¼Œå°±è§¦å‘åˆ†æ
        var chat = document.getElementById('advisorChat');
        if (chat.innerText.trim() === "" || chat.innerText.includes("ä¸»å…¬") || isForce) {
            analyzeCardNeeds(); // é‡æ–°åˆ†æ
        }
    } else {
        alert("âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°å†›å¸ˆçª—å£ (aiAdvisorBox)ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å¤åˆ¶äº†ä¹‹å‰çš„ HTML ä»£ç ï¼");
    }
};

/* 4. æŒ‰é’®ç»‘å®šçš„å¼ºåˆ¶å‡½æ•° */
window.forceOpenAdvisor = function() {
    var desc = document.getElementById('cardDesc').value.trim();
    if (desc.length === 0) {
        auth.toast('ğŸ“œ ä¸»å…¬ï¼Œè¯·å…ˆå†™ç‚¹äººè®¾ï¼Œå“ªæ€•å‡ ä¸ªå­—ä¹Ÿå¥½...');
        return;
    }
    auth.toast('ğŸ§  å†›å¸ˆæ­£åœ¨èµ¶æ¥...');
    checkAndOpenAdvisor(true); // true ä»£è¡¨å¼ºåˆ¶æ‰“å¼€ï¼Œæ— è§†å­—æ•°é™åˆ¶
};

/* ================= ğŸ”§ ç»ˆæä¿®å¤ï¼šæ‹–æ‹½å›å¼¹ + é˜²è¯¯è§¦ç™½åå• ================= */
(function() {
    var box = document.getElementById('aiAdvisorBox');
    var header = document.getElementById('advisorHeader');
    
    if (!box || !header) return;

    var isDragging = false;
    var startX = 0, startY = 0;
    var initialLeft = 0, initialTop = 0;

    function dragStart(e) {
        // ğŸ”¥ æ–°å¢ï¼šé˜²è¯¯è§¦ç™½åå•
        // å¦‚æœç‚¹çš„æ˜¯æŒ‰é’®ã€è¾“å…¥æ¡†ã€æˆ–è€…æœ‰ç‚¹å‡»äº‹ä»¶çš„å…ƒç´ ï¼Œç›´æ¥é€€å‡ºï¼Œä¸è®¸æ‹–æ‹½
        if (e.target.tagName === 'BUTTON' || 
            e.target.tagName === 'INPUT' || 
            e.target.tagName === 'TEXTAREA' || 
            e.target.closest('button') || 
            e.target.closest('.advisor-action-btn') || // é‚£ä¸ªè™šçº¿æŒ‰é’®
            e.target.onclick) {
            return; 
        }

        var clientX = e.touches ? e.touches[0].clientX : e.clientX;
        var clientY = e.touches ? e.touches[0].clientY : e.clientY;

        isDragging = true;
        startX = clientX; startY = clientY;
        
        var rect = box.getBoundingClientRect();
        initialLeft = rect.left; initialTop = rect.top;
        
        // é”å®šä½ç½®æ¨¡å¼
        box.style.bottom = 'auto'; box.style.right = 'auto';
        box.style.left = initialLeft + 'px'; box.style.top = initialTop + 'px';

        if(e.cancelable) e.preventDefault();
    }

    function dragMove(e) {
        if (!isDragging) return;
        var clientX = e.touches ? e.touches[0].clientX : e.clientX;
        var clientY = e.touches ? e.touches[0].clientY : e.clientY;
        box.style.left = (initialLeft + (clientX - startX)) + 'px';
        box.style.top = (initialTop + (clientY - startY)) + 'px';
        if(e.cancelable) e.preventDefault();
    }

    function dragEnd() {
        if (!isDragging) return;
        isDragging = false;

        // ğŸ”¥ ä¿ç•™ä½ å–œæ¬¢çš„ï¼šå›å¼¹é€»è¾‘
        var winW = window.innerWidth;
        var winH = window.innerHeight;
        var rect = box.getBoundingClientRect();
        
        var newLeft = rect.left;
        var newTop = rect.top;

        // è®¡ç®—è¾¹ç•Œï¼šå±å¹•å®½ - çª—å£å®½ (ä¿è¯è´´è¾¹ä¸é£å‡º)
        var maxLeft = winW - rect.width; 
        var maxTop = winH - rect.height;

        // å·¦/ä¸Šå‡ºç•Œæ‹‰å› 0
        if (newLeft < 0) newLeft = 0;
        if (newTop < 0) newTop = 0;
        
        // å³/ä¸‹å‡ºç•Œæ‹‰å›æé™å€¼
        if (newLeft > maxLeft) newLeft = maxLeft; 
        if (newTop > maxTop) newTop = maxTop; 

        // æ‰§è¡Œå›å¼¹åŠ¨ç”»
        box.style.transition = "all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)";
        box.style.left = newLeft + 'px';
        box.style.top = newTop + 'px';
        
        setTimeout(() => { box.style.transition = ""; }, 300);
    }

    header.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', dragMove);
    document.addEventListener('mouseup', dragEnd);
    header.addEventListener('touchstart', dragStart, {passive: false});
    document.addEventListener('touchmove', dragMove, {passive: false});
    document.addEventListener('touchend', dragEnd);
})();
    
   

/* ================= ğŸ”§ è¡¥ä¸ï¼šæ— é™å­˜æ¡£ç³»ç»Ÿ ================= */

// 1. æ‰“å¼€ç®¡ç†å™¨
window.openSaveManager = function() {
    document.getElementById('saveManagerModal').style.display = 'flex';
    renderSaveList();
};

/* ================= ğŸ”§ è¡¥ä¸ï¼šå­˜æ¡£ç³»ç»Ÿ (ç¡®ä¿å†›å¸ˆè®°å½•ä¸ä¸¢å¤±) ================= */
window.createNewSave = function() {
    // 1. å®‰å…¨è·å–è¾“å…¥æ¡†å†…å®¹
    function safeVal(id) { 
        var el = document.getElementById(id); 
        return el ? el.value : ""; 
    }

    var name = safeVal('cardName').trim() || "æœªå‘½åè§’è‰²";
    var time = new Date().toLocaleString();

    // 2. ğŸ”¥ æ ¸å¿ƒï¼šè·å–å†›å¸ˆèŠå¤©è®°å½• (HTML)
    // åªè¦è¿™é‡Œå–åˆ°äº†ï¼Œå­˜æ¡£é‡Œå°±ä¸€å®šä¼šæœ‰
    var advisorHtml = "";
    var chatBox = document.getElementById('advisorChat');
    if (chatBox) advisorHtml = chatBox.innerHTML;

    // 3. æ‰“åŒ…æ•°æ®
    var saveData = {
        id: Date.now(),
        title: name,
        time: time,
        inputs: {
            name: safeVal('cardName'),
            desc: safeVal('cardDesc'),
            firstMes: safeVal('cardFirstMes'),
            mesEx: safeVal('cardMesExample'),
            scenario: safeVal('cardScenario'),
            note: safeVal('cardNote') || safeVal('statEditor')
        },
        // æ·±æ‹·è´é˜²æ­¢å¼•ç”¨é—®é¢˜
        worldInfo: JSON.parse(JSON.stringify(window.currentWorldInfo || { entries: [] })),
        regexScripts: JSON.parse(JSON.stringify(window.currentCardRegexes || [])),
        wizardTags: JSON.parse(JSON.stringify(window.currentSelectedTags || { identity: [], personality: [], trope: [] })),
        
        // ä¿å­˜èŠå¤©è®°å½•
        advisorChat: advisorHtml
    };

    // 4. è¯»å–ç°æœ‰å­˜æ¡£å¹¶å¤„ç†åŒåè¦†ç›–
    try {
        var saves = JSON.parse(localStorage.getItem('my_creator_saves') || "[]");
        
        var idx = saves.findIndex(s => s.title === name);
        if (idx !== -1) {
            saves.splice(idx, 1); // åˆ æ—§
            auth.toast('ğŸ’¾ å­˜æ¡£å·²æ›´æ–° (è¦†ç›–åŒå)');
        } else {
            auth.toast('ğŸ’¾ æ–°å­˜æ¡£å·²åˆ›å»º');
        }
        
        saves.unshift(saveData); // å­˜æ–°
        localStorage.setItem('my_creator_saves', JSON.stringify(saves));
        
        if(typeof renderSaveList === 'function') renderSaveList();

    } catch (e) {
        alert("å­˜æ¡£å¤±è´¥: " + e.message);
    }
};




// 3. æ¸²æŸ“å­˜æ¡£åˆ—è¡¨
window.renderSaveList = function() {
    var list = document.getElementById('saveSlotList');
    var saves = JSON.parse(localStorage.getItem('my_creator_saves') || "[]");
    list.innerHTML = "";

    if(saves.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— å­˜æ¡£</div>';
        return;
    }

    saves.forEach((save, idx) => {
        var div = document.createElement('div');
        div.style.cssText = "background:#fff; border:1px solid #ddd; margin-bottom:10px; padding:10px; border-radius:8px; cursor:pointer; position:relative;";
        div.innerHTML = `
            <div style="font-weight:bold; color:#333;">${save.title}</div>
            <div style="font-size:10px; color:#999;">${save.time}</div>
            <button onclick="deleteSave(${idx})" style="position:absolute; right:10px; top:10px; border:none; background:none; color:#e74c3c; cursor:pointer;">ğŸ—‘ï¸</button>
        `;
        // ç‚¹å‡»è¯»å–
        div.onclick = (e) => { if(e.target.tagName!=='BUTTON') loadSave(idx); };
        list.appendChild(div);
    });
};


// 2. è¯»æ¡£ (æ¢å¤æ ‡ç­¾ä¸èŠå¤©)
window.loadSave = function(idx) {
    if(!confirm('è¯»å–å­˜æ¡£å°†è¦†ç›–å½“å‰è¿›åº¦ï¼Œç¡®å®šå—ï¼Ÿ')) return;
    
    var saves = JSON.parse(localStorage.getItem('my_creator_saves') || "[]");
    var data = saves[idx];
    if(!data) return;

    // æ¢å¤è¾“å…¥æ¡†
    document.getElementById('cardName').value = data.inputs.name || '';
    document.getElementById('cardDesc').value = data.inputs.desc || '';
    document.getElementById('cardFirstMes').value = data.inputs.firstMes || '';
    document.getElementById('cardMesExample').value = data.inputs.mesEx || '';
    document.getElementById('cardScenario').value = data.inputs.scenario || '';
    if(document.getElementById('cardNote')) document.getElementById('cardNote').value = data.inputs.note || '';
    if(document.getElementById('statEditor')) document.getElementById('statEditor').value = data.inputs.note || '';

    // æ¢å¤å¯¹è±¡
    window.currentWorldInfo = data.worldInfo || { entries: [] };
    window.currentCardRegexes = data.regexScripts || [];
    
    // ğŸ”¥ ä¿®å¤ï¼šæ¢å¤æ ‡ç­¾æ•°æ®å¹¶é«˜äº®
    window.currentSelectedTags = data.selectedTags || { identity: [], personality: [], trope: [] };
    restoreTagVisuals(); // è°ƒç”¨ç¬¬ä¸€æ­¥å†™çš„å‡½æ•°

    // æ¢å¤èŠå¤©
    var chatBox = document.getElementById('advisorChat');
    if(chatBox) {
        chatBox.innerHTML = data.advisorChat || "";
        // è¯»æ¡£åï¼Œå¦‚æœé‡Œé¢æœ‰è¯ï¼Œå¯ä»¥è‡ªåŠ¨æ‰“å¼€çª—å£
        if(data.advisorChat) document.getElementById('aiAdvisorBox').style.display = 'flex';
    }

    // åˆ·æ–°ç•Œé¢
    if(typeof renderWorldList === 'function') renderWorldList();
    if(typeof renderRegexList === 'function') renderRegexList();
    if(typeof updatePreviewUI === 'function') updatePreviewUI();

    document.getElementById('saveManagerModal').style.display = 'none';
    auth.toast('ğŸ“‚ è¯»æ¡£æˆåŠŸ');
};

// 3. ğŸ”¥ å½»åº•é‡ç½®å¹¶å…³é—­ (è¯·æŠŠå…³é—­æŒ‰é’® onclick æ”¹ä¸ºè°ƒç”¨è¿™ä¸ª)
window.closeAndResetCreator = function() {
    if(!confirm('ç¡®å®šé€€å‡ºåˆ›é€ è€…å·¥åŠå—ï¼Ÿ\næœªä¿å­˜çš„å†…å®¹å°†ä¸¢å¤±ï¼')) return;

    // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†
    var inputs = document.querySelectorAll('#cardCreatorModal input, #cardCreatorModal textarea');
    inputs.forEach(i => i.value = '');

    // æ¸…ç©ºå…¨å±€å˜é‡
    window.currentWorldInfo = { entries: [] };
    window.currentCardRegexes = [];
    window.currentSelectedTags = { identity: [], personality: [], trope: [] };
    
    // æ¸…ç©ºå†›å¸ˆèŠå¤©
    var chatBox = document.getElementById('advisorChat');
    if(chatBox) chatBox.innerHTML = '';
  document.getElementById('cardCreatorModal').classList.remove('active');
    document.getElementById('cardCreatorModal').style.display = ''; // æ¸…é™¤æ®‹ç•™
    
    document.getElementById('aiAdvisorBox').style.display = 'none'; // å†›å¸ˆçª—å£è¿˜æ˜¯å¯ä»¥ç›´æ¥è—çš„
    document.getElementById('saveManagerModal').style.display = 'none'; // å­˜æ¡£çª—å£ä¹Ÿå¯ä»¥ç›´æ¥è—
    
  
    // åˆ·æ–°ä¸€ä¸‹æ ‡ç­¾æ˜¾ç¤º(æ¸…ç©ºé€‰ä¸­çŠ¶æ€)
    restoreTagVisuals();
};


// 5. åˆ é™¤å­˜æ¡£
window.deleteSave = function(idx) {
    if(!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªå­˜æ¡£å—ï¼Ÿ')) return;
    var saves = JSON.parse(localStorage.getItem('my_creator_saves') || "[]");
    saves.splice(idx, 1);
    localStorage.setItem('my_creator_saves', JSON.stringify(saves));
    renderSaveList();
};

// 6. å®Œç»“æ¸…ç©º
window.finishAndClear = function() {
    if(!confirm('ç¡®å®šå®Œç»“å—ï¼Ÿ\nè¿™å°†æ¸…ç©ºå½“å‰é¡µé¢çš„æ‰€æœ‰è¾“å…¥æ¡†å’Œè®°å½•ã€‚\nå»ºè®®å…ˆå­˜æ¡£ï¼')) return;
    
    // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†
    var inputs = document.querySelectorAll('input, textarea');
    inputs.forEach(i => i.value = '');
    
    // é‡ç½®å…¨å±€å˜é‡
    window.currentWorldInfo = { entries: [] };
    window.currentCardRegexes = [];
    document.getElementById('advisorChat').innerHTML = '';
    
    // åˆ·æ–° UI
    renderWorldList();
    renderRegexList();
    document.getElementById('aiAdvisorBox').style.display = 'none';
    
    auth.toast('ğŸ é¡µé¢å·²é‡ç½®ï¼Œå‡†å¤‡å¼€å§‹æ–°çš„åˆ›ä½œ');
};

/* ================= ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šå®‰å…¨å­˜æ¡£ç³»ç»Ÿ (é˜²å´©æºƒç‰ˆ) ================= */

// 1. ä¿®å¤ï¼šæ–°å»ºå­˜æ¡£ (åŠ å…¥å®‰å…¨æ£€æŸ¥ï¼Œé˜²æ­¢å› æ‰¾ä¸åˆ°è¾“å…¥æ¡†è€Œå¡æ­»)
window.createNewSave = function() {
    // å†…éƒ¨å°å·¥å…·ï¼šå®‰å…¨è·å–è¾“å…¥æ¡†å†…å®¹
    function safeGet(id) {
        var el = document.getElementById(id);
        return el ? el.value : "";
    }

    // è·å–åå­—
    var name = safeGet('cardName').trim();
    if (!name) name = "æœªå‘½åè§’è‰²";
    
    var time = new Date().toLocaleString();

    try {
        // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæ‰“åŒ…æ•°æ®æ—¶ï¼Œå¦‚æœæŸä¸ªå˜é‡ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç©ºå€¼ä»£æ›¿ï¼Œé˜²æ­¢æŠ¥é”™
        var saveData = {
            id: Date.now(),
            title: name,
            time: time,
            inputs: {
                name: name,
                desc: safeGet('cardDesc'),
                firstMes: safeGet('cardFirstMes'),
                mesEx: safeGet('cardMesExample'),
                scenario: safeGet('cardScenario'),
                // é‡ç‚¹ä¿®å¤ï¼šåŒæ—¶å°è¯•è¯»å–æ—§ID(cardNote)å’Œæ–°ID(statEditor)
                note: safeGet('cardNote') || safeGet('statEditor')
            },
            // å…¨å±€å˜é‡å®‰å…¨è·å–
            worldInfo: window.currentWorldInfo || { entries: [] },
            regexScripts: window.currentCardRegexes || [],
            wizardTags: window.currentTags || [],
            // å†›å¸ˆè®°å½•å®‰å…¨è·å–
            advisorChat: document.getElementById('advisorChat') ? document.getElementById('advisorChat').innerHTML : ""
        };

        // è¯»å–æ—§æ¡£ -> æ’å…¥æ–°æ¡£ -> ä¿å­˜
        var saves = JSON.parse(localStorage.getItem('my_creator_saves') || "[]");
        saves.unshift(saveData);
        localStorage.setItem('my_creator_saves', JSON.stringify(saves));
        
        // åˆ·æ–°åˆ—è¡¨
        if (typeof renderSaveList === 'function') {
            renderSaveList();
        } else {
            // å¦‚æœåˆ—è¡¨å‡½æ•°æ„å¤–ä¸¢å¤±ï¼Œé‡æ–°å®šä¹‰ä¸€ä¸ªç®€æ˜“ç‰ˆé˜²æ­¢å¡æ­»
            document.getElementById('saveSlotList').innerHTML = "å­˜æ¡£å·²ä¿å­˜ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ã€‚";
        }
        
        auth.toast('ğŸ’¾ å­˜æ¡£æˆåŠŸï¼');

    } catch (e) {
        console.error("å­˜æ¡£å‡ºé”™:", e);
        alert("âŒ å­˜æ¡£å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°ã€‚\nåŸå› : " + e.message);
    }
};

// 2. ç¡®ä¿åˆ—è¡¨æ¸²æŸ“å‡½æ•°å­˜åœ¨ä¸”æ­£ç¡®
window.renderSaveList = function() {
    var list = document.getElementById('saveSlotList');
    if (!list) return; // æ‰¾ä¸åˆ°åˆ—è¡¨å®¹å™¨å°±é€€å‡º

    var saves = JSON.parse(localStorage.getItem('my_creator_saves') || "[]");
    list.innerHTML = "";

    if (saves.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— å­˜æ¡£</div>';
        return;
    }

    saves.forEach((save, idx) => {
        var div = document.createElement('div');
        div.style.cssText = "background:#fff; border:1px solid #ddd; margin-bottom:10px; padding:10px; border-radius:8px; cursor:pointer; position:relative;";
        div.innerHTML = `
            <div style="font-weight:bold; color:#333;">${save.title}</div>
            <div style="font-size:10px; color:#999;">${save.time}</div>
            <button onclick="event.stopPropagation(); deleteSave(${idx})" style="position:absolute; right:10px; top:10px; border:none; background:none; color:#e74c3c; cursor:pointer; font-size:14px;">ğŸ—‘ï¸</button>
        `;
        // ç‚¹å‡»æ•´ä¸ªå—è¯»å–
        div.onclick = () => loadSave(idx);
        list.appendChild(div);
    });
};



/* ================= ğŸ”§ ç»ˆæè¡¥ä¸ï¼šå†›å¸ˆå…¨è‡ªåŠ¨å®æ—¶ä¿å­˜ (Observer) ================= */
(function() {
    // 1. æ‰¾åˆ°èŠå¤©æ¡†
    var chatBox = document.getElementById('advisorChat');
    if (!chatBox) return;

    // 2. åˆ›å»ºç›‘å¬å™¨ï¼šåªè¦èŠå¤©æ¡†å†…å®¹æœ‰ä»»ä½•å˜åŒ–ï¼Œç«‹åˆ»ä¿å­˜
    var autoSaver = new MutationObserver(function() {
        var html = chatBox.innerHTML;
        // åªæœ‰å½“é‡Œé¢æœ‰å†…å®¹æ—¶æ‰ä¿å­˜ï¼Œé˜²æ­¢è¯¯æ¸…ç©º
        if (html.trim() !== "") {
            localStorage.setItem('my_advisor_save', html);
            // æ§åˆ¶å°æ‚„æ‚„è®°ä¸€ä¸‹ï¼Œè¯æ˜åœ¨å·¥ä½œ (å¯é€‰)
            // console.log("å†›å¸ˆè¿›åº¦å·²è‡ªåŠ¨ä¿å­˜"); 
        }
    });

    // 3. å¼€å§‹ç›‘å¬ (ç›‘å¬å­å…ƒç´ å˜åŒ–ã€æ–‡å­—å˜åŒ–ã€å±æ€§å˜åŒ–)
    autoSaver.observe(chatBox, { 
        childList: true, 
        subtree: true, 
        attributes: true, 
        characterData: true 
    });
    
    // 4. é¡µé¢åŠ è½½æ—¶ï¼Œå°è¯•è¯»å–ä¸€æ¬¡è‡ªåŠ¨å­˜æ¡£ (é˜²æ­¢åˆ·æ–°ä¸¢å¤±)
    var saved = localStorage.getItem('my_advisor_save');
    if (saved && saved.trim() !== "" && chatBox.innerHTML.trim() === "") {
        chatBox.innerHTML = saved;
        // å¦‚æœæœ‰è®°å½•ï¼Œè‡ªåŠ¨æ˜¾ç¤ºçª—å£ (å¯é€‰)
        // document.getElementById('aiAdvisorBox').style.display = 'flex';
    }
})();

/* ================= ğŸ”§ è¡¥ä¸ï¼šå¯åŠ¨è‡ªåŠ¨åŠ è½½å­˜æ¡£ (ä¿®å¤ç©ºåˆ—è¡¨) ================= */
(function() {
    // ç¨å¾®å»¶è¿Ÿ 0.3 ç§’ï¼Œç¡®ä¿é¡µé¢å…ƒç´ éƒ½å‡†å¤‡å¥½äº†
    setTimeout(function() {
        // 1. æ£€æŸ¥æ˜¯å¦æœ‰å­˜æ¡£è®°å½•
        var saves = JSON.parse(localStorage.getItem('my_creator_saves') || "[]");
        
        // 2. å¦‚æœæœ‰å­˜æ¡£ï¼Œå°±è‡ªåŠ¨æ‰“å¼€å¹¶åŠ è½½åˆ—è¡¨
        if (saves.length > 0) {
            // è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå®ƒæ—¢ä¼šæ˜¾ç¤ºå¼¹çª—ï¼Œä¹Ÿä¼šæ‰§è¡Œ renderSaveList() åˆ·æ–°æ•°æ®
            if (typeof openSaveManager === 'function') {
                openSaveManager();
                // å†æ¬¡å¼ºåˆ¶åˆ·æ–°ä¸€ä¸‹åˆ—è¡¨ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
                if(typeof renderSaveList === 'function') renderSaveList();
                
                // è´´å¿ƒæç¤º
                // auth.toast('ğŸ“‚ æ£€æµ‹åˆ°å†å²å­˜æ¡£ï¼Œå·²è‡ªåŠ¨æ‰“å¼€');
            }
        } else {
            // 3. å¦‚æœæ²¡æœ‰å­˜æ¡£ï¼Œå°±å¼ºåˆ¶å…³æ‰ï¼ˆé˜²æ­¢å‡ºç°ä¸€ä¸ªç©ºçš„å¼¹çª—æŒ¡è·¯ï¼‰
            var modal = document.getElementById('saveManagerModal');
            if (modal) modal.style.display = 'none';
        }
    }, 300);
})();

/* ================= ğŸ”§ è¡¥ä¸ï¼šè·³è½¬é€»è¾‘ (å½»åº•ç§»é™¤è‡ªåŠ¨å…³é—­) ================= */
window.jumpToCreator = function(btn, type, encodedPrompt) {
    // 1. æŒ‰é’®å˜è‰²åé¦ˆ (ä¿æŒä¸å˜)
    if (btn && btn.style) {
        btn.innerHTML = "âœ… å·²æ·»åŠ ";
        btn.style.background = "#f0f0f0";
        btn.style.color = "#aaa";
        btn.style.borderColor = "#ddd";
        btn.style.cursor = "default";
        btn.onclick = null; 
    }

    // 2. è§£å¯†å†…å®¹ (ä¿æŒä¸å˜)
    var promptText = decodeURIComponent(encodedPrompt);

    // 3. æ‰§è¡Œè·³è½¬
    try {
        if (type === 'world') {
            switchCardTab('world');
            setTimeout(function() {
                var el = document.getElementById('aiWorldPrompt');
                if(el) { el.value = promptText; el.focus(); }
            }, 100);
        } 
        else if (type === 'frontend') {
            switchCardTab('regex');
            if(typeof switchRegexUI === 'function') switchRegexUI('frontend'); 
            setTimeout(function() {
                var el = document.getElementById('aiCodePrompt');
                if(el) { el.value = promptText; el.focus(); }
            }, 100);
        } 
        else if (type === 'stat') {
            switchCardTab('stats');
            setTimeout(function() {
                var el = document.getElementById('aiStatPrompt');
                if(el) { el.value = promptText; el.focus(); }
            }, 100);
        }
        
        // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šæˆ‘åˆ é™¤äº†æ£€æµ‹æ‰‹æœºç«¯å¹¶ display='none' çš„ä»£ç 
        // ç°åœ¨æ— è®ºä½ åœ¨ç”µè„‘è¿˜æ˜¯æ‰‹æœºï¼Œç‚¹å‡»å»æ·»åŠ ï¼Œçª—å£éƒ½çº¹ä¸ä¸åŠ¨ï¼Œç»å¯¹ä¸ä¼šè‡ªå·±å…³æ‰äº†ï¼

        auth.toast('âœ… å·²å¡«å…¥å»ºè®®ï¼Œè¯·ç‚¹å‡»â€œç”Ÿæˆâ€');
    } catch(e) {
        console.error(e);
        alert("è·³è½¬å‡ºé”™ï¼š" + e.message);
    }
};

/* ================= ğŸ”§ ä¿®å¤è¡¥ä¸ï¼šæŒ‰é’®äº¤äº’ & è·³è½¬é€»è¾‘ (åšå†³ä¸å…³çª—ç‰ˆ) ================= */

// 1. æ¸²æŸ“æ°”æ³¡ (ä¿æŒåŠ å¯†é€»è¾‘ï¼Œé˜²æ­¢æŠ¥é”™)
window.renderSuggestionBubble = function(item) {
    var chat = document.getElementById('advisorChat');
    var div = document.createElement('div');
    div.className = 'advisor-bubble';
    
    var icon = "ğŸ’¡";
    if(item.type === 'world') icon = "ğŸŒ";
    if(item.type === 'frontend') icon = "ğŸ¨";
    if(item.type === 'stat') icon = "ğŸ“Š";

    // å®‰å…¨åŠ å¯†ï¼Œé˜²æ­¢å•å¼•å·/åŒå¼•å·/æ¢è¡Œç¬¦å¼„å HTML
    var safePrompt = encodeURIComponent(item.prompt || ""); 
    var safeType = item.type;

    div.innerHTML = `
        <div style="font-weight:bold; color:#6c5ce7; margin-bottom:4px;">${icon} ${item.title}</div>
        <div style="font-size:12px; color:#666; margin-bottom:8px;">${item.reason}</div>
        <button class="advisor-action-btn" onclick="jumpToCreator(this, '${safeType}', '${safePrompt}')">
            ğŸ‘‰ å»æ·»åŠ  (è‡ªåŠ¨å¡«å•)
        </button>
    `;
    
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
};

// 2. è·³è½¬æ‰§è¡Œ (å»é™¤è‡ªåŠ¨å…³é—­é€»è¾‘)
window.jumpToCreator = function(btn, type, encodedPrompt) {
    // --- A. æŒ‰é’®çŠ¶æ€åé¦ˆ ---
    if (btn && btn.style) {
        btn.innerHTML = "âœ… å·²æ·»åŠ ";
        btn.style.background = "#f0f0f0";
        btn.style.color = "#aaa";
        btn.style.borderColor = "#ddd";
        btn.style.cursor = "default";
        btn.onclick = null; // é”æ­»
    }

    // --- B. è§£å¯†å†…å®¹ ---
    var promptText = decodeURIComponent(encodedPrompt);

    // --- C. æ‰§è¡Œè·³è½¬ä¸å¡«å€¼ ---
    try {
        if (type === 'world') {
            switchCardTab('world');
            setTimeout(function() {
                var el = document.getElementById('aiWorldPrompt');
                if(el) { el.value = promptText; el.focus(); }
            }, 100);
        } 
        else if (type === 'frontend') {
            switchCardTab('regex');
            // ç¡®ä¿åˆ‡æ¢åˆ° AI æ¨¡å¼
            if(typeof switchRegexUI === 'function') switchRegexUI('frontend'); 
            setTimeout(function() {
                var el = document.getElementById('aiCodePrompt');
                if(el) { el.value = promptText; el.focus(); }
            }, 100);
        } 
        else if (type === 'stat') {
            switchCardTab('stats');
            setTimeout(function() {
                var el = document.getElementById('aiStatPrompt');
                if(el) { el.value = promptText; el.focus(); }
            }, 100);
        }
        
        // ğŸ”¥ é‡ç‚¹ï¼šè¿™é‡Œæ²¡æœ‰ä»»ä½•å…³é—­çª—å£çš„ä»£ç äº†ï¼
        // æ— è®ºæ‰‹æœºè¿˜æ˜¯ç”µè„‘ï¼Œç‚¹å®Œä¹‹åçª—å£éƒ½ä¿æŒä¸åŠ¨ã€‚

        auth.toast('âœ… å·²å¡«å…¥å»ºè®®ï¼Œè¯·ç‚¹å‡»â€œç”Ÿæˆâ€');

    } catch(e) {
        console.error("è·³è½¬é”™è¯¯:", e);
        auth.toast("âŒ è·³è½¬å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•");
    }
};

/* ================= ğŸ”§ è¡¥ä¸ï¼šæŠ˜å å¼€å…³ & æŒ‰é’®å¼ºåŠ›ä¿®å¤ ================= */

// 1. æŠ˜å /å±•å¼€åˆ‡æ¢å‡½æ•°
window.toggleAdvisorCollapse = function() {
    var box = document.getElementById('aiAdvisorBox');
    box.classList.toggle('collapsed');
    
    // è§†è§‰åé¦ˆï¼šæ”¹å˜å°ç®­å¤´æ–¹å‘
    var span = box.querySelector('#advisorHeader span span');
    if (span) {
        span.innerText = box.classList.contains('collapsed') ? '(â–²)' : '(â–¼)';
    }
};

// 2. ğŸ”¥ å†æ¬¡ç¡®è®¤ï¼šä¿®å¤â€œå»æ·»åŠ â€æŒ‰é’® (é˜²æŠ¥é”™ç‰ˆ)
// åªè¦è¦†ç›–äº†è¿™ä¸ªï¼Œåˆšæ‰è¯´çš„â€œæ²¡ååº”â€å’Œâ€œå¼¹çª—æ¶ˆå¤±â€éƒ½ä¼šå¥½
window.jumpToCreator = function(btn, type, encodedPrompt) {
    // æŒ‰é’®å˜ç°
    if (btn && btn.style) {
        btn.innerHTML = "âœ… å·²æ·»åŠ ";
        btn.style.background = "#f0f0f0";
        btn.style.color = "#aaa";
        btn.style.borderColor = "#ddd";
        btn.style.cursor = "default";
        btn.onclick = null;
    }

    // è§£å¯†å†…å®¹
    var promptText = decodeURIComponent(encodedPrompt);

    try {
        if (type === 'world') {
            switchCardTab('world');
            setTimeout(function() {
                var el = document.getElementById('aiWorldPrompt');
                if(el) { el.value = promptText; el.focus(); }
            }, 100);
        } 
        else if (type === 'frontend') {
            switchCardTab('regex');
            if(typeof switchRegexUI === 'function') switchRegexUI('frontend'); 
            setTimeout(function() {
                var el = document.getElementById('aiCodePrompt');
                if(el) { el.value = promptText; el.focus(); }
            }, 100);
        } 
        else if (type === 'stat') {
            switchCardTab('stats');
            setTimeout(function() {
                var el = document.getElementById('aiStatPrompt');
                if(el) { el.value = promptText; el.focus(); }
            }, 100);
        }
        
        auth.toast('âœ… å·²å¡«å…¥å»ºè®®ï¼Œè¯·ç‚¹å‡»â€œç”Ÿæˆâ€');
    } catch(e) {
        console.error(e);
    }
};

/* ================= ğŸ”§ è¡¥ä¸ï¼šAPI é…ç½®å­˜æ¡£ç³»ç»Ÿ ================= */

// 1. ä¿å­˜å½“å‰é…ç½®
window.saveCurrentApiPreset = function() {
    var url = document.getElementById('aiApiUrl').value.trim();
    var key = document.getElementById('aiApiKey').value.trim();
    var model = document.getElementById('aiModelName') ? document.getElementById('aiModelName').value : document.getElementById('aiModelSelect').value;

    if (!url || !key) { auth.toast('è¯·å…ˆå¡«å¥½åœ°å€å’Œ Key å†ä¿å­˜'); return; }

    var name = prompt("ç»™è¿™ä¸ªé…ç½®èµ·ä¸ªåå­— (å¦‚: DeepSeek, å…¬å¸API):");
    if (!name) return;

    var presets = JSON.parse(localStorage.getItem('my_api_presets') || "[]");
    
    // æ£€æŸ¥é‡åè¦†ç›–
    var existingIdx = presets.findIndex(p => p.name === name);
    if (existingIdx !== -1) {
        if (!confirm("åå­—é‡å¤ï¼Œè¦è¦†ç›–å—ï¼Ÿ")) return;
        presets[existingIdx] = { name: name, url: url, key: key, model: model };
    } else {
        presets.push({ name: name, url: url, key: key, model: model });
    }

    localStorage.setItem('my_api_presets', JSON.stringify(presets));
    renderApiPresets(); // åˆ·æ–°åˆ—è¡¨
    
    // è‡ªåŠ¨é€‰ä¸­
    document.getElementById('apiPresetSelect').value = name;
    auth.toast('ğŸ’¾ é…ç½®å·²ä¿å­˜ï¼');
};

// 2. æ¸²æŸ“åˆ—è¡¨
window.renderApiPresets = function() {
    var select = document.getElementById('apiPresetSelect');
    if (!select) return;
    
    var presets = JSON.parse(localStorage.getItem('my_api_presets') || "[]");
    var currentVal = select.value;

    select.innerHTML = '<option value="">-- é€‰æ‹©å·²å­˜é…ç½® --</option>';
    
    presets.forEach(p => {
        var opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name;
        select.appendChild(opt);
    });

    select.value = currentVal; // ä¿æŒé€‰ä¸­çŠ¶æ€
};

// 3. åº”ç”¨é…ç½® (é€‰ä¸­ä¸‹æ‹‰æ¡†æ—¶è§¦å‘)
window.applyApiPreset = function() {
    var name = document.getElementById('apiPresetSelect').value;
    if (!name) return;

    var presets = JSON.parse(localStorage.getItem('my_api_presets') || "[]");
    var target = presets.find(p => p.name === name);

    if (target) {
        document.getElementById('aiApiUrl').value = target.url;
        document.getElementById('aiApiKey').value = target.key;
        
        // å°è¯•è‡ªåŠ¨å¡«å…¥æ¨¡å‹
        var modelSelect = document.getElementById('aiModelSelect');
        var modelManual = document.getElementById('aiModelManual'); // å…¼å®¹éƒ¨åˆ†æ—§ä»£ç 
        
        // å¦‚æœæœ‰æ‰‹åŠ¨æ¡†ä¸”å¯è§
        if(modelManual && modelManual.style.display !== 'none') {
             modelManual.value = target.model;
        } else if (modelSelect) {
             // æ£€æŸ¥ä¸‹æ‹‰æ¡†é‡Œæœ‰æ²¡æœ‰ï¼Œæ²¡æœ‰å°±åŠ ä¸€ä¸ªä¸´æ—¶é€‰é¡¹
             var exists = Array.from(modelSelect.options).some(o => o.value === target.model);
             if(!exists && target.model) {
                 var opt = new Option(target.model, target.model);
                 modelSelect.add(opt);
             }
             modelSelect.value = target.model;
        }
        
        auth.toast('âš¡ å·²åˆ‡æ¢è‡³ï¼š' + name);
    }
};

// 4. åˆ é™¤é…ç½®
window.deleteApiPreset = function() {
    var name = document.getElementById('apiPresetSelect').value;
    if (!name) return;

    if (confirm(`ç¡®å®šåˆ é™¤é…ç½®ã€${name}ã€‘å—ï¼Ÿ`)) {
        var presets = JSON.parse(localStorage.getItem('my_api_presets') || "[]");
        presets = presets.filter(p => p.name !== name);
        localStorage.setItem('my_api_presets', JSON.stringify(presets));
        
        renderApiPresets();
        auth.toast('ğŸ—‘ï¸ å·²åˆ é™¤');
    }
};

// 5. ğŸ”¥ è¦†ç›–æ—§çš„æ‰“å¼€å‡½æ•° (ä¸ºäº†è‡ªåŠ¨åŠ è½½åˆ—è¡¨)
// (è¯·ç¡®ä¿è¿™æ®µä»£ç åœ¨æ—§çš„ openAISettings ä¸‹é¢ï¼Œæˆ–è€…æ›¿æ¢å®ƒ)
var _oldOpenSettings = window.openAISettings;
window.openAISettings = function() {
    // æ‰§è¡ŒåŸæ¥çš„é€»è¾‘ (å›æ˜¾å½“å‰æ­£åœ¨ç”¨çš„é…ç½®)
    if (_oldOpenSettings) _oldOpenSettings();
    else {
        // å¦‚æœæ‰¾ä¸åˆ°æ—§å‡½æ•°ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªæœ€å°åŒ–çš„æ‰“å¼€é€»è¾‘ä¿åº•
        document.getElementById('aiSettingsModal').classList.add('active');
    }
    
    // ğŸ”¥ æ–°å¢ï¼šæ¸²æŸ“å­˜æ¡£åˆ—è¡¨
    renderApiPresets();
};

/* ================= ğŸ§¹ ç»ˆæè¦†ç›–ï¼šäººè®¾ç”Ÿæˆé€»è¾‘ (V3.0 æ— æŠ¥é”™ç‰ˆ) ================= */
// æ”¾åœ¨ Script æœ€æœ«å°¾ï¼Œç¡®ä¿è¦†ç›–ä¹‹å‰æ‰€æœ‰ç‰ˆæœ¬

(function() {
    console.log("âœ… å·²åŠ è½½ï¼šå¼ºåŠ›è¦†ç›–ç”Ÿæˆé€»è¾‘ (å±è”½ç½‘ç»œé”™è¯¯)");

    // 1. è¦†ç›–ï¼šè¯¦ç»†è®¾å®šç”Ÿæˆ (autoGenDesc)
    window.autoGenDesc = async function() {
        var name = document.getElementById('cardName').value.trim();
        if (!name) { auth.toast('å…ˆç»™è§’è‰²èµ·ä¸ªåå­—å§ï¼'); return; }
        
        // å°è¯•è·å–æ ‡ç­¾
        var tagStr = "æ— ";
        if(window.currentSelectedTags) {
            var allTags = [
                ...window.currentSelectedTags.identity, 
                ...window.currentSelectedTags.personality, 
                ...window.currentSelectedTags.trope
            ];
            tagStr = allTags.join('ã€');
        }

        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        // æ²¡Keyä¹Ÿä¸æŠ¥é”™ï¼Œç›´æ¥è¿›æ‰‹åŠ¨æ¨¡å¼
        if (!config || !config.apiKey) { 
            auth.toast('âš ï¸ æœªå¡«API Keyï¼Œå·²åˆ‡æ¢æ‰‹åŠ¨æ¨¡å¼');
            showRefineBox('desc', document.getElementById('cardDesc').value);
            return; 
        }

        var btn = event.target;
        var oldText = btn.innerText;
        btn.innerText = 'âœï¸ æ­£åœ¨å†™...'; btn.style.pointerEvents = 'none';

        var prompt = `æˆ‘æ˜¯åˆ›é€ è€…ã€‚è¯·ä¸ºè§’è‰²ã€${name}ã€‘å†™ä¸€æ®µâ€œè¯¦ç»†è®¾å®šâ€ã€‚
        ã€å¼ºåˆ¶è¦æ±‚ã€‘ï¼šå¿…é¡»åŸºäºè¿™äº›å±æ€§ç”Ÿæˆï¼š${tagStr}ã€‚
        åŒ…å«å¤–è²Œã€æ€§æ ¼ã€èº«ä¸–ã€‚300å­—å·¦å³ã€‚ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ã€‚`;

        try {
            var res = await fetchAI(prompt, config);
            var cleanText = res.replace(/```/g, '').trim();
            
            // å¡«å…¥å†…å®¹
            document.getElementById('cardDesc').value = cleanText;
            auth.toast('âœ… è®¾å®šå·²ç”Ÿæˆï¼');
            
            // æˆåŠŸ -> æ˜¾ç¤ºç¼–è¾‘æ¡†
            showRefineBox('desc', cleanText);
            
            if(typeof updateJsonSource === 'function') updateJsonSource();
            if(typeof checkAndOpenAdvisor === 'function') checkAndOpenAdvisor(false); 

        } catch (e) {
            console.error("ç”Ÿæˆå‡ºé”™(å·²å¿½ç•¥):", e);
            // ğŸ”¥ å¤±è´¥ -> ä¸å¼¹çª—æŠ¥é”™ï¼Œè€Œæ˜¯ç›´æ¥æ˜¾ç¤ºç¼–è¾‘æ¡†
            auth.toast('âœ… ç¼–è¾‘æ¨¡å¼å·²å°±ç»ª (å¯æ‰‹åŠ¨ä¿®æ”¹)');
            showRefineBox('desc', document.getElementById('cardDesc').value);
        } finally {
            btn.innerText = oldText; btn.style.pointerEvents = 'auto';
        }
    };

    // 2. è¦†ç›–ï¼šå¼€åœºç™½ç”Ÿæˆ (autoGenFirstMes)
    window.autoGenFirstMes = async function() {
        var name = document.getElementById('cardName').value.trim();
        var desc = document.getElementById('cardDesc').value.trim();
        if(!desc) desc = `ä¸€ä¸ªå«${name}çš„è§’è‰²`;
        
        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        // æ²¡Keyä¹Ÿä¸æŠ¥é”™
        if (!config || !config.apiKey) { 
            auth.toast('âš ï¸ æœªå¡«Keyï¼Œå·²åˆ‡æ¢æ‰‹åŠ¨æ¨¡å¼');
            showRefineBox('firstMes', document.getElementById('cardFirstMes').value);
            return; 
        }

        var btn = event.target; 
        var oldText = btn.innerText;
        btn.innerText = 'âœï¸...'; btn.style.pointerEvents = 'none';

        var prompt = `è§’è‰²ï¼š${name}ã€‚\nè®¾å®šï¼š${desc}\nè¯·å†™ä¸€å¥ç¬¦åˆäººè®¾çš„å¼€åœºç™½ã€‚ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦ä»£ç å—ã€‚`;

        try {
            var res = await fetchAI(prompt, config);
            var cleanText = res.replace(/```/g, '').trim();
            
            document.getElementById('cardFirstMes').value = cleanText;
            auth.toast('âœ… å¼€åœºç™½å·²ç”Ÿæˆï¼');
            
            // æˆåŠŸ -> æ˜¾ç¤ºç¼–è¾‘æ¡†
            showRefineBox('firstMes', cleanText);
            
            if(typeof updatePreviewUI === 'function') updatePreviewUI();

        } catch(e) {
            console.error("ç”Ÿæˆå‡ºé”™(å·²å¿½ç•¥):", e);
            // ğŸ”¥ å¤±è´¥ -> ä¹Ÿä¸å¼¹é”™ï¼Œæ˜¾ç¤ºç¼–è¾‘æ¡†
            auth.toast('âœ… ç¼–è¾‘æ¨¡å¼å·²å°±ç»ª');
            showRefineBox('firstMes', document.getElementById('cardFirstMes').value);
        } finally { 
            btn.innerText = oldText; btn.style.pointerEvents = 'auto';
        }
    };

    // 3. è¦†ç›–ï¼šäºŒæ¬¡ç¼–è¾‘é€šç”¨å‡½æ•° (refineResult)
    window.refineResult = async function(type) {
        const inputId = `refineInput_${type}`;
        const requirement = document.getElementById(inputId).value.trim();
        
        // å“ªæ€•æ²¡å¡«éœ€æ±‚ï¼Œç‚¹æŒ‰é’®ä¹Ÿå¯ä»¥å½“åˆ·æ–°ç”¨ï¼Œä¸æŠ¥é”™
        if (!requirement) { auth.toast('è¯·å‘Šè¯‰æˆ‘æ€ä¹ˆæ”¹...'); return; }
        
        // ç¡®ä¿ç¼“å­˜æœ‰å€¼
        if (!window.lastGeneratedData[type]) {
            // ä»ç•Œé¢ç°æŠ“
            if(type==='desc') window.lastGeneratedData.desc = document.getElementById('cardDesc').value;
            else if(type==='firstMes') window.lastGeneratedData.firstMes = document.getElementById('cardFirstMes').value;
            else window.lastGeneratedData[type] = {}; 
        }

        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) {
            auth.toast('âš ï¸ æœªè¿æ¥AIï¼Œæ— æ³•ä¿®æ”¹');
            return;
        }

        const btn = event.target;
        const oldText = btn.innerText;
        btn.innerText = 'ğŸ§  ä¿®æ”¹ä¸­...'; btn.disabled = true;

        var prevData = window.lastGeneratedData[type];
        var prevDataStr = typeof prevData === 'string' ? prevData : JSON.stringify(prevData);

        // A. çº¯æ–‡æœ¬ä¿®æ”¹ (äººè®¾/å¼€åœºç™½)
        if (type === 'desc' || type === 'firstMes') {
            var prompt = `åŸæ–‡æœ¬ï¼š${prevDataStr}\nä¿®æ”¹æ„è§ï¼šã€${requirement}ã€‘\nè¯·é‡å†™ã€‚ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ã€‚`;
            try {
                var res = await fetchAI(prompt, config);
                var cleanText = res.replace(/```/g, '').trim();
                
                if (type === 'desc') document.getElementById('cardDesc').value = cleanText;
                if (type === 'firstMes') {
                    document.getElementById('cardFirstMes').value = cleanText;
                    if(typeof updatePreviewUI === 'function') updatePreviewUI();
                }
                
                // æ›´æ–°ç¼“å­˜
                window.lastGeneratedData[type] = cleanText;
                document.getElementById(inputId).value = ''; 
                auth.toast('âœ¨ ä¿®æ”¹å·²åº”ç”¨ï¼');
            } catch(e) {
                // ğŸ”¥ å¤±è´¥ä¸æŠ¥é”™
                console.error(e);
                auth.toast('âœ… ç½‘ç»œæ³¢åŠ¨ï¼Œè¯·é‡è¯•æˆ–æ‰‹åŠ¨ä¿®æ”¹');
            } finally {
                btn.innerText = oldText; btn.disabled = false;
            }
            return;
        }

        // B. JSON ä¿®æ”¹ (ä¿ç•™æ—§é€»è¾‘çš„æ— æŠ¥é”™ç‰ˆ)
        var prompt = `åŸæ•°æ®ï¼š${prevDataStr}ã€‚ä¿®æ”¹æ„è§ï¼šã€${requirement}ã€‘ã€‚è¯·ä¿®æ”¹å¹¶è¿”å›å®Œæ•´JSONã€‚`;
        if (type === 'stat') prompt = `åŸä»£ç ï¼š${prevDataStr}ã€‚æ„è§ï¼šã€${requirement}ã€‘ã€‚è¿”å›JSON {script:"...", guide:"..."}`;

        try {
            var res = await fetchAI(prompt, config);
            var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
            var newData = JSON.parse(cleanJson);
            window.lastGeneratedData[type] = newData;

            // æ›´æ–°UI (ç®€å†™ç‰ˆï¼Œä»…ç¤ºæ„ï¼Œå®é™…ä¼šè°ƒç”¨ä¹‹å‰çš„é€»è¾‘)
            if (type === 'frontend') document.getElementById('frontReplace').value = newData.code;
            if (type === 'world') document.getElementById('wiContent').value = newData.content;
            
            auth.toast('âœ¨ ä¿®æ”¹å®Œæˆï¼');
            document.getElementById(inputId).value = ''; 
        } catch (e) {
            console.error(e);
            auth.toast('âœ… æš‚æ— æ³•è¿æ¥AIï¼Œè¯·æ‰‹åŠ¨ä¿®æ”¹');
        } finally {
            btn.innerText = oldText; btn.disabled = false;
        }
    };

    // ğŸ”§ è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºç¼–è¾‘æ¡†å¹¶å­˜ç¼“å­˜
    function showRefineBox(type, content) {
        var boxId = `refineArea_${type}`;
        var box = document.getElementById(boxId);
        if (box) box.style.display = 'block';
        
        // å­˜å…¥ç¼“å­˜ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä¿®æ”¹
        if(!window.lastGeneratedData) window.lastGeneratedData = {};
        window.lastGeneratedData[type] = content || "";
    }

})();

/* ================= ğŸ”§ ç»ˆæé‡æ„è¡¥ä¸ï¼šå±æ€§/æ ‡ç­¾/ç”Ÿæˆ/è§£é‡Š ================= */
(function() {
    console.log("ğŸš€ æ­£åœ¨æ‰§è¡Œï¼šç•Œé¢é‡ç»„ã€æ ‡ç­¾å¢å¼ºã€å±æ€§é€»è¾‘é‡å†™...");

    // -----------------------------------------------------------
    // éœ€æ±‚ 4ï¼šé‡æ’é¢„è§ˆé¡µé¡ºåº (è¯¦ç»†è®¾å®š -> å¼€åœºç™½ -> å±•ç¤º)
    // -----------------------------------------------------------
   


    // -----------------------------------------------------------
    // éœ€æ±‚ 5 & 3ï¼šè‡ªå®šä¹‰æ ‡ç­¾ + ä¸€é”®ç”ŸæˆæŒ‰é’® (é‡å†™æ ‡ç­¾ç³»ç»Ÿ)
    // -----------------------------------------------------------
    
    // åˆå§‹åŒ–å…¨å±€æ ‡ç­¾çŠ¶æ€ (é˜²æ­¢è¯»æ¡£æŠ¥é”™)
    if (!window.currentSelectedTags) {
        window.currentSelectedTags = { identity: [], personality: [], trope: [] };
    }

    // è¦†ç›–ï¼šæ¸²æŸ“å•ä¸ªæ ‡ç­¾ç»„ (åŠ å…¥è‡ªå®šä¹‰æŒ‰é’®)
    window.renderSingleGroup = function(key) {
        // æ•°æ®æº (å¦‚æœæ²¡æœ‰å°±ç”¨é»˜è®¤)
        var data = window.wizardData ? window.wizardData[key] : { title: "æ ‡ç­¾ç»„", tags: [] };
        
        var containerId = 'tagGroup' + key.charAt(0).toUpperCase() + key.slice(1);
        var titleId = 'title_' + key;
        
        // æ¸²æŸ“æ ‡é¢˜ + è‡ªå®šä¹‰æŒ‰é’®
        var titleEl = document.getElementById(titleId);
        if(titleEl) {
            titleEl.innerHTML = `${data.title} <span onclick="addCustomWizardTag('${key}')" style="font-size:12px; color:#6c5ce7; cursor:pointer; margin-left:10px; border:1px solid #6c5ce7; border-radius:4px; padding:0 4px; background:white;">+è‡ªå®šä¹‰</span>`;
        }

        var container = document.getElementById(containerId);
        if(container) {
            container.innerHTML = ''; 
            data.tags.forEach((t, idx) => {
                var span = document.createElement('span');
                span.className = 'wizard-tag';
                span.innerText = t;
                
                // æ¢å¤é€‰ä¸­çŠ¶æ€
                if (window.currentSelectedTags[key] && window.currentSelectedTags[key].includes(t)) {
                    span.classList.add('selected');
                }

                // ç»‘å®šç‚¹å‡»
                span.onclick = function() {
                    this.classList.toggle('selected');
                    if (this.classList.contains('selected')) {
                        if (!window.currentSelectedTags[key].includes(t)) window.currentSelectedTags[key].push(t);
                    } else {
                        window.currentSelectedTags[key] = window.currentSelectedTags[key].filter(item => item !== t);
                    }
                };
                container.appendChild(span);
            });
        }
    };

    // æ–°å¢ï¼šæ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾å‡½æ•°
    window.addCustomWizardTag = function(key) {
        var text = prompt("â• è¯·è¾“å…¥æ–°æ ‡ç­¾åç§°ï¼š");
        if (!text) return;
        text = text.trim();
        // åŠ åˆ°æ•°æ®æºå¹¶åˆ·æ–°
        if(window.wizardData && window.wizardData[key]) {
            window.wizardData[key].tags.push(text);
            localStorage.setItem('my_wizard_data_v2', JSON.stringify(window.wizardData)); // ä¿å­˜åˆ°æœ¬åœ°
            renderWizardTags();
            auth.toast(`å·²æ·»åŠ æ ‡ç­¾ï¼š${text}`);
        }
    };

    // æ–°å¢ï¼šæ’å…¥â€œä¸€é”®ç”Ÿæˆå…¨å¥—â€å¤§æŒ‰é’®
    setTimeout(() => {
        var wizardBox = document.querySelector('.wizard-box');
        if (wizardBox && !document.getElementById('btnOneClickGen')) {
            var btn = document.createElement('button');
            btn.id = 'btnOneClickGen';
            btn.className = 'primary-btn';
            btn.style.cssText = "width:100%; margin-top:15px; background:linear-gradient(135deg, #6c5ce7, #a29bfe); border:none; padding:12px; font-size:14px; font-weight:bold; color:white; border-radius:8px; cursor:pointer; box-shadow:0 4px 10px rgba(108, 92, 231, 0.3);";
            btn.innerHTML = "âœ¨ è¯»å–æ ‡ç­¾ -> ç”Ÿæˆè¯¦ç»†è®¾å®š & å¼€åœºç™½";
            
            // ç»‘å®šç”Ÿæˆé€»è¾‘ (éœ€æ±‚ 3 & 5)
            btn.onclick = async function() {
                var name = document.getElementById('cardName').value.trim();
                if (!name) { auth.toast('å…ˆç»™è§’è‰²èµ·ä¸ªåå­—å§ï¼'); return; }

                // è¯»å–æ‰€æœ‰é€‰ä¸­çš„æ ‡ç­¾ (åŒ…æ‹¬è‡ªå®šä¹‰çš„)
                var allTags = [
                    ...window.currentSelectedTags.identity, 
                    ...window.currentSelectedTags.personality, 
                    ...window.currentSelectedTags.trope
                ];
                
                if (allTags.length === 0) { auth.toast('è¯·è‡³å°‘é€‰ä¸€ä¸ªæ ‡ç­¾ (æˆ–ç‚¹è‡ªå®šä¹‰æ·»åŠ )'); return; }
                var tagStr = allTags.join('ã€');

                var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
                if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·å…ˆé…ç½® API Key'); return; }

                var selfBtn = document.getElementById('btnOneClickGen');
                selfBtn.innerText = 'ğŸ§  æ­£åœ¨æ„æ€å…¨å¥—è®¾å®š...'; selfBtn.disabled = true;

                // æ„é€  Prompt
                var prompt = `
                æˆ‘æ˜¯åˆ›é€ è€…ã€‚è¯·ä¸ºè§’è‰²ã€${name}ã€‘è®¾è®¡å…¨å¥—äººè®¾ã€‚
                ã€å¼ºåˆ¶æ ‡ç­¾ã€‘ï¼š${tagStr}ã€‚
                
                è¯·è¿”å›çº¯ JSON æ ¼å¼ï¼ŒåŒ…å«ï¼š
                1. "desc": è¯¦ç»†è®¾å®š (500å­—ï¼ŒåŒ…å«å¤–è²Œã€æ€§æ ¼ã€èº«ä¸–ï¼Œå¿…é¡»ä½“ç°ä¸Šè¿°æ ‡ç­¾)ã€‚
                2. "first_mes": å¼€åœºç™½ (ç¬¦åˆäººè®¾çš„ç¬¬ä¸€å¥è¯ï¼Œä¸è¦å¼•å·)ã€‚
                3. "example": å¯¹è¯æ ·æœ¬ (Userä¸Charçš„å¯¹è¯ç¤ºä¾‹)ã€‚
                `;

                try {
                    var res = await fetchAI(prompt, config);
                    var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
                    var data = JSON.parse(cleanJson);

                    document.getElementById('cardDesc').value = data.desc || "";
                    document.getElementById('cardFirstMes').value = data.first_mes || "";
                    document.getElementById('cardMesExample').value = data.example || "";

                    // è‡ªåŠ¨è·³åˆ°é¢„è§ˆé¡µ
                    switchCardTab('preview');
                    if(typeof updatePreviewUI === 'function') updatePreviewUI();
                    
                    auth.toast('âœ¨ å…¨å¥—äººè®¾ç”Ÿæˆå®Œæ¯•ï¼');
                } catch (e) {
                    console.error(e);
                    auth.toast('âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
                } finally {
                    selfBtn.innerText = "âœ¨ è¯»å–æ ‡ç­¾ -> ç”Ÿæˆè¯¦ç»†è®¾å®š & å¼€åœºç™½"; selfBtn.disabled = false;
                }
            };
            
            // æ’å…¥æŒ‰é’®
            wizardBox.parentNode.insertBefore(btn, wizardBox.nextSibling);
        }
        // é‡æ–°æ¸²æŸ“ä¸€æ¬¡æ ‡ç­¾ä»¥æ˜¾ç¤ºæ–°UI
        if(typeof renderWizardTags === 'function') renderWizardTags();
    }, 1000);


    // -----------------------------------------------------------
    // éœ€æ±‚ 1, 2, 6ï¼šå±æ€§é¡µç”Ÿæˆæ— ååº”ã€åŒæ­¥ã€è§£é‡Š (å®Œå…¨é‡å†™)
    // -----------------------------------------------------------

    // 1. å¼ºåŠ›åŒæ­¥å‡½æ•° (å±æ€§ä»£ç  <-> æ·±åº¦è®¾å®š)
    window.syncStatToNote = function() {
        var statEl = document.getElementById('statEditor');
        var noteEl = document.getElementById('cardNote');
        
        // åªæœ‰ä¸¤ä¸ªå…ƒç´ éƒ½å­˜åœ¨æ—¶æ‰åŒæ­¥
        if(statEl && noteEl) {
            // è¿™é‡Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·æ­£åœ¨æ“ä½œå±æ€§é¡µï¼Œæ‰€ä»¥æŠŠå±æ€§é¡µçš„å€¼ åŒæ­¥ç»™ æ·±åº¦è®¾å®š
            // å®é™…ä¸Šè¿™ä¸¤ä¸ªæ¡†åº”è¯¥å…±äº«åŒä¸€ä¸ªå€¼
            noteEl.value = statEl.value;
        }
    };

    // ç»‘å®šç›‘å¬ï¼šåªè¦åœ¨å±æ€§é¡µæ‰“å­—ï¼Œç«‹åˆ»åŒæ­¥åˆ°é«˜çº§é¡µ
    setTimeout(() => {
        var statEl = document.getElementById('statEditor');
        if(statEl) statEl.addEventListener('input', window.syncStatToNote);
    }, 1000);

    // 2. è¦†ç›–ï¼šå±æ€§ç”Ÿæˆé€»è¾‘ (åŠ å…¥è§£é‡ŠåŠŸèƒ½)
    window.generateStatLogic = async function() {
        // è·å–è¾“å…¥ (ä¿®å¤ä¹‹å‰å¯èƒ½å–ä¸åˆ°å€¼çš„é—®é¢˜)
        var inputEl = document.getElementById('aiStatPrompt');
        var req = inputEl ? inputEl.value.trim() : "";
        var charDesc = document.getElementById('cardDesc').value.trim();

        if (!req) { auth.toast('è¯·å…ˆæè¿°è§„åˆ™ (å¦‚: å¥½æ„Ÿåº¦ç³»ç»Ÿ)...'); return; }
        
        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·å…ˆé…ç½® API Key'); return; }

        var btn = document.getElementById('btnGenStat');
        btn.innerText = 'ğŸ§  ç¼–å†™ä»£ç  & æ’°å†™è¯´æ˜ä¹¦...'; btn.disabled = true;

        // Promptï¼šè¦æ±‚ç”Ÿæˆä»£ç  + è§£é‡Š
        var prompt = `
        ä½ æ˜¯ä¸€ä¸ªSillyTavernè§„åˆ™ä¸“å®¶ã€‚
        è§’è‰²è®¾å®šï¼š${charDesc.substring(0, 300)}...
        ç”¨æˆ·éœ€æ±‚ï¼šã€${req}ã€‘
        
        è¯·å®Œæˆä¸¤ä»¶äº‹ï¼š
        1. ç¼–å†™ System Prompt (æ·±åº¦è®¾å®šä»£ç )ã€‚
        2. ç¼–å†™ã€ä¸­æ–‡è¿è¡ŒåŸç†è¯´æ˜ä¹¦ã€‘ (è§£é‡Š)ã€‚
        
        å¿…é¡»è¿”å›çº¯ JSON æ ¼å¼ï¼š
        {
            "script": "è¿™é‡Œæ”¾è§„åˆ™ä»£ç  (Target, Rule, Output...)",
            "explanation": "è¿™é‡Œç”¨ä¸­æ–‡è§£é‡Šï¼š\n1. è¿™ä¸ªç³»ç»ŸåŒ…å«å“ªäº›å˜é‡ï¼Ÿ\n2. ä»€ä¹ˆæƒ…å†µä¸‹ä¼šåŠ åˆ†/å‡åˆ†ï¼Ÿ\n3. è§¦å‘åä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ\n(è¯·åˆ†ç‚¹è¯´æ˜ï¼Œé€šä¿—æ˜“æ‡‚)"
        }
        `;

        try {
            var res = await fetchAI(prompt, config);
            var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
            var data = JSON.parse(cleanJson);
            
            // 4. å¡«å…¥ä»£ç æ¡†
            var editor = document.getElementById('statEditor');
            if(editor) {
                editor.value = data.script;
                // ğŸ”¥ ç«‹å³åŒæ­¥åˆ°é«˜çº§é¡µ
                window.syncStatToNote();
            }

            // 5. æ˜¾ç¤ºè§£é‡Šè¯´æ˜ä¹¦ (åˆ›å»ºæˆ–æ›´æ–°ç»¿è‰²æ¡†)
            var guideBox = document.getElementById('statGuideBox');
            if (!guideBox && editor) {
                guideBox = document.createElement('div');
                guideBox.id = 'statGuideBox';
                guideBox.style.cssText = "margin-top:10px; background:#e8f5e9; border:1px solid #a5d6a7; padding:15px; border-radius:8px; color:#2e7d32; font-size:13px; line-height:1.6; white-space: pre-wrap;";
                editor.parentNode.insertBefore(guideBox, editor.nextSibling);
            }
            if(guideBox) {
                guideBox.innerHTML = `<b>ğŸ“– AI è®²è§£ (è¿è¡ŒåŸç†)ï¼š</b>\n${data.explanation}`;
                guideBox.style.display = 'block';
            }

            auth.toast('âœ¨ è§„åˆ™å·²ç”Ÿæˆï¼Œå¹¶åŒæ­¥è‡³æ·±åº¦è®¾å®šï¼');

        } catch (e) {
            console.error(e);
            auth.toast('âŒ ç”Ÿæˆå¤±è´¥ (JSONè§£æé”™)');
        } finally {
            btn.innerText = 'âœ¨ ç”Ÿæˆè§„åˆ™'; btn.disabled = false;
        }
    };

})();

/* ================= ğŸ”§ ç»ˆæä¿®å¤è¡¥ä¸ V4.0ï¼šç²¾å‡†æ§åˆ¶ç‰ˆ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œè¡¥ä¸ V4.0ï¼šç•Œé¢é‡ç»„ | æ ‡ç­¾ä¼˜åŒ– | åŒå‘åŒæ­¥ | å†›å¸ˆä¿®å¤");

    // ================= 1. é¢„è§ˆé¡µé¡ºåºé‡æ’ (å¼ºåˆ¶æ‰§è¡Œ) =================
    // ç›®æ ‡é¡ºåºï¼šè¯¦ç»†è®¾å®š(cardDesc) -> å¼€åœºç™½(cardFirstMes) -> å±•ç¤º(cardMesExample)
   

    // ================= 2. æ ‡ç­¾ç³»ç»Ÿé‡æ„ (è‡ªå®šä¹‰åœ¨ä¸‹æ–¹) =================
    
    // åˆå§‹åŒ–æ•°æ®
    if (!window.currentSelectedTags) window.currentSelectedTags = { identity: [], personality: [], trope: [] };

    // è¦†ç›–æ¸²æŸ“å‡½æ•°
    window.renderWizardTags = function() {
        renderGroup('identity');
        renderGroup('personality');
        renderGroup('trope');
        
        // æ¸²æŸ“åº•éƒ¨çš„è‡ªå®šä¹‰è¾“å…¥æ¡† (åªæ¸²æŸ“ä¸€æ¬¡)
        renderCustomInputArea();
    };

    function renderGroup(key) {
        var data = window.wizardData[key];
        var containerId = 'tagGroup' + key.charAt(0).toUpperCase() + key.slice(1);
        var titleId = 'title_' + key;
        
        // è¿˜åŸæ ‡é¢˜ (å»æ‰ä¹‹å‰çš„æŒ‰é’®)
        var titleEl = document.getElementById(titleId);
        if(titleEl) titleEl.innerHTML = data.title; // çº¯æ–‡æœ¬

        var container = document.getElementById(containerId);
        if(!container) return;
        container.innerHTML = ''; 

        data.tags.forEach((t, idx) => {
            var span = document.createElement('span');
            span.className = 'wizard-tag';
            span.innerText = t;
            
            // é€‰ä¸­çŠ¶æ€
            if (window.currentSelectedTags[key].includes(t)) span.classList.add('selected');

            // åˆ é™¤æŒ‰é’® (ä»…å¯¹éé»˜è®¤æ ‡ç­¾æ˜¾ç¤ºï¼Œæˆ–è€…å…¨éƒ¨æ˜¾ç¤º)
            var delBtn = document.createElement('span');
            delBtn.className = 'tag-delete-btn';
            delBtn.innerText = 'Ã—';
            delBtn.onclick = function(e) { e.stopPropagation(); deleteWizardTag(key, idx); };
            span.appendChild(delBtn);

            span.onclick = function(e) {
                if(e.target === delBtn) return;
                this.classList.toggle('selected');
                if (this.classList.contains('selected')) {
                    if (!window.currentSelectedTags[key].includes(t)) window.currentSelectedTags[key].push(t);
                } else {
                    window.currentSelectedTags[key] = window.currentSelectedTags[key].filter(item => item !== t);
                }
            };
            container.appendChild(span);
        });
    }

    // æ–°å¢ï¼šåœ¨æ ‡ç­¾åŒºåŸŸæœ€ä¸‹æ–¹æ¸²æŸ“ä¸€ä¸ªâ€œè‡ªå®šä¹‰æ·»åŠ â€æ 
    function renderCustomInputArea() {
        var box = document.querySelector('.wizard-box');
        if (!box) return;
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ·»åŠ 
        if (document.getElementById('customTagArea')) return;

        var div = document.createElement('div');
        div.id = 'customTagArea';
        div.style.marginTop = '15px';
        div.style.paddingTop = '10px';
        div.style.borderTop = '1px dashed #eee';
        
        div.innerHTML = `
            <div style="font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">â• æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾</div>
            <div style="display:flex; gap:5px;">
                <select id="customTagType" style="padding:5px; border:1px solid #ddd; border-radius:5px; font-size:12px;">
                    <option value="identity">èº«ä»½</option>
                    <option value="personality">æ€§æ ¼</option>
                    <option value="trope">èŒç‚¹</option>
                </select>
                <input type="text" id="customTagInput" placeholder="è¾“å…¥æ ‡ç­¾å..." style="flex:1; padding:5px; border:1px solid #ddd; border-radius:5px; font-size:12px;">
                <button onclick="addCustomTagBtn()" style="background:#6c5ce7; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">æ·»åŠ </button>
            </div>
        `;
        box.appendChild(div);
    }

    // ç»‘å®šæ·»åŠ å‡½æ•°
    window.addCustomTagBtn = function() {
        var type = document.getElementById('customTagType').value;
        var val = document.getElementById('customTagInput').value.trim();
        if(!val) return;
        
        // åŠ åˆ°æ•°æ®æº
        window.wizardData[type].tags.push(val);
        // è‡ªåŠ¨é€‰ä¸­å®ƒ
        window.currentSelectedTags[type].push(val);
        
        localStorage.setItem('my_wizard_data_v2', JSON.stringify(window.wizardData));
        renderWizardTags(); // åˆ·æ–°
        document.getElementById('customTagInput').value = ''; // æ¸…ç©º
        auth.toast(`å·²æ·»åŠ å¹¶é€‰ä¸­ï¼š${val}`);
    };

    // é‡æ–°æ¸²æŸ“æ ‡ç­¾ä»¥ç”Ÿæ•ˆ
    setTimeout(renderWizardTags, 600);


    // ================= 3 & 4. å±æ€§ç”Ÿæˆä¸åŒæ­¥ (å®Œå…¨é‡å†™) =================

    // 1. åŒæ­¥å‡½æ•° (Stats <-> Note)
    // é€»è¾‘ï¼šè°å˜äº†ï¼Œå°±åŒæ­¥ç»™å¯¹æ–¹
    window.syncStats = function(sourceId) {
        var statEl = document.getElementById('statEditor');
        var noteEl = document.getElementById('cardNote');
        
        if (statEl && noteEl) {
            if (sourceId === 'statEditor') noteEl.value = statEl.value;
            else if (sourceId === 'cardNote') statEl.value = noteEl.value;
        }
    };

    // 2. ç»‘å®šç›‘å¬ (åŒå‘åŒæ­¥)
    setTimeout(() => {
        var statEl = document.getElementById('statEditor');
        var noteEl = document.getElementById('cardNote');
        if(statEl) statEl.addEventListener('input', () => window.syncStats('statEditor'));
        if(noteEl) noteEl.addEventListener('input', () => window.syncStats('cardNote'));
    }, 1000);

    // 3. å±æ€§ç”Ÿæˆé€»è¾‘ (åŒæ—¶å†™å…¥ä¸¤è¾¹ + æ˜¾ç¤ºè§£é‡Š)
    window.generateStatLogic = async function() {
        var req = document.getElementById('aiStatPrompt').value.trim();
        var charDesc = document.getElementById('cardDesc').value.trim();

        if (!req) { auth.toast('è¯·å…ˆæè¿°è§„åˆ™...'); return; }
        
        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·å…ˆé…ç½® API Key'); return; }

        var btn = document.getElementById('btnGenStat');
        btn.innerText = 'ğŸ§  ç¼–å†™ä»£ç  & è¯´æ˜ä¹¦...'; btn.disabled = true;

        var prompt = `
        ä½ æ˜¯ä¸€ä¸ªSillyTavernè§„åˆ™ä¸“å®¶ã€‚
        è§’è‰²è®¾å®šï¼š${charDesc.substring(0, 300)}...
        ç”¨æˆ·éœ€æ±‚ï¼šã€${req}ã€‘
        
        è¯·å®Œæˆä¸¤ä»¶äº‹ï¼š
        1. ç¼–å†™ System Prompt (ä»£ç )ã€‚
        2. ç¼–å†™ã€ä¸­æ–‡è¿è¡ŒåŸç†è¯´æ˜ä¹¦ã€‘ (è§£é‡Š)ã€‚
        
        å¿…é¡»è¿”å›çº¯ JSON æ ¼å¼ï¼š
        {
            "script": "è¿™é‡Œæ”¾ä»£ç  (Target, Rule, Output...)",
            "explanation": "è¿™é‡Œç”¨ä¸­æ–‡è§£é‡Šï¼š\n1. è¿™ä¸ªç³»ç»ŸåŒ…å«å“ªäº›å˜é‡ï¼Ÿ\n2. ä»€ä¹ˆæƒ…å†µä¸‹ä¼šåŠ åˆ†/å‡åˆ†ï¼Ÿ\n3. è§¦å‘åä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ\n(è¯·åˆ†ç‚¹è¯´æ˜ï¼Œé€šä¿—æ˜“æ‡‚)"
        }
        `;

        try {
            var res = await fetchAI(prompt, config);
            var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
            var data = JSON.parse(cleanJson);
            
            // A. å¡«å…¥å±æ€§é¡µä»£ç æ¡†
            var editor = document.getElementById('statEditor');
            editor.value = data.script;
            
            // B. ğŸ”¥ ç«‹å³åŒæ­¥åˆ°é«˜çº§é¡µ
            var noteEl = document.getElementById('cardNote');
            if(noteEl) noteEl.value = data.script;

            // C. ğŸ”¥ æ˜¾ç¤ºè§£é‡Šè¯´æ˜ä¹¦ (å±æ€§é¡µ)
            showExplanation('statGuideBox', editor, data.explanation);

            // D. ğŸ”¥ æ˜¾ç¤ºè§£é‡Šè¯´æ˜ä¹¦ (é«˜çº§é¡µï¼Œä¹Ÿè¦æ˜¾ç¤ºï¼)
            if(noteEl) showExplanation('noteGuideBox', noteEl, data.explanation);

            auth.toast('âœ¨ è§„åˆ™å·²ç”Ÿæˆï¼Œä¸¤å¤„å·²åŒæ­¥ï¼');

        } catch (e) {
            console.error(e);
            auth.toast('âŒ ç”Ÿæˆå¤±è´¥ (JSONè§£æé”™)');
        } finally {
            btn.innerText = 'âœ¨ ç”Ÿæˆè§„åˆ™'; btn.disabled = false;
        }
    };

    // è¾…åŠ©ï¼šæ˜¾ç¤ºè¯´æ˜ä¹¦ç›’å­
    function showExplanation(boxId, targetEl, text) {
        var box = document.getElementById(boxId);
        if (!box) {
            box = document.createElement('div');
            box.id = boxId;
            box.style.cssText = "margin-top:10px; background:#e8f5e9; border:1px solid #a5d6a7; padding:15px; border-radius:8px; color:#2e7d32; font-size:13px; line-height:1.6; white-space: pre-wrap;";
            targetEl.parentNode.insertBefore(box, targetEl.nextSibling);
        }
        box.innerHTML = `<b>ğŸ“– è¿è¡ŒåŸç†è¯´æ˜ä¹¦ï¼š</b>\n${text}`;
        box.style.display = 'block';
    }


    // ================= 5. å†›å¸ˆ API ä¿®å¤ (å¢åŠ è¶…æ—¶æ£€æµ‹) =================
    
    window.analyzeCardNeeds = async function() {
        var name = document.getElementById('cardName').value;
        var desc = document.getElementById('cardDesc').value.trim();
        
        // é™ä½å­—æ•°é—¨æ§›ï¼Œé˜²æ­¢ä¸è§¦å‘
        if (desc.length < 50) { 
            auth.toast('ğŸ“œ è¯·å…ˆå†™ç‚¹äººè®¾ï¼ˆè‡³å°‘50å­—ï¼‰ï¼Œå†›å¸ˆæ‰èƒ½åˆ†æå“¦'); 
            return; 
        }

        // æ˜¾ç¤ºçª—å£
        var box = document.getElementById('aiAdvisorBox');
        if(box) box.style.display = 'flex';
        
        var chat = document.getElementById('advisorChat');
        chat.innerHTML = `<div class="ai-loading" style="color:#999;font-size:12px;text-align:center;padding:20px;">ğŸ§  æ­£åœ¨è¿çº¿å†›å¸ˆ...<br>(è¯·ç¨å€™ 5-10ç§’)</div>`;

        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) {
            chat.innerHTML = `<div class="advisor-bubble">âŒ ä¸»å…¬ï¼Œè¯·å…ˆå»è®¾ç½®é‡Œå¡«å†™ API Keyã€‚</div>`;
            return;
        }

        var prompt = `
        æˆ‘æ˜¯å¡ç‰‡ä½œè€…ã€‚è§’è‰²ï¼š${name}ã€‚
        è®¾å®šï¼š${desc.substring(0, 800)}...
        
        è¯·ä½œä¸ºâ€œåˆ¶ä½œé¡¾é—®â€ï¼Œç”¨ã€é€šä¿—æ˜“æ‡‚çš„å¤§ç™½è¯ã€‘ï¼Œæå‡º 3 ä¸ªå…·ä½“çš„åˆ¶ä½œå»ºè®®ã€‚
        å¿…é¡»è¿”å›çº¯ JSON æ•°ç»„ï¼š[{"type":"world/frontend/stat", "title":"", "reason":"", "prompt":""}]
        `;

        try {
            // è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢ä¸€ç›´è½¬åœˆ
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 20000); // 20ç§’è¶…æ—¶

            const response = await fetch(`${config.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
                body: JSON.stringify({
                    model: config.model || 'gpt-3.5-turbo',
                    messages: [{ role: "user", content: prompt }]
                }),
                signal: controller.signal
            });
            clearTimeout(timeoutId);

            if (!response.ok) throw new Error(`API é”™è¯¯ ${response.status}`);

            const data = await response.json();
            var resText = data.choices[0].message.content;
            var cleanJson = resText.replace(/```json/g, '').replace(/```/g, '').trim();
            var suggestions = JSON.parse(cleanJson);
            
            chat.innerHTML = ''; // æ¸…ç©º loading
            suggestions.forEach(item => renderSuggestionBubble(item));
            
        } catch(e) { 
            console.error(e);
            if (e.name === 'AbortError') {
                chat.innerHTML = `<div class="advisor-bubble">â³ å†›å¸ˆå“åº”è¶…æ—¶... è¯·æ£€æŸ¥ç½‘ç»œæˆ–æ¢ä¸ªæ¨¡å‹è¯•è¯•ã€‚</div>`;
            } else {
                chat.innerHTML = `<div class="advisor-bubble">âŒ å†›å¸ˆæ–­çº¿äº†ï¼š${e.message}</div>`;
            }
        }
    };

})();

/* ================= ğŸ”§ è¡¥ä¸ V5.0ï¼šç•Œé¢æ¸…ç† & å†›å¸ˆä¸Šå¸æ¨¡å¼é‡é“¸ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œè¡¥ä¸ V5.0ï¼šæ¸…ç†å¤šä½™æ¡† | å†›å¸ˆå…¨æƒé™ä¿®å¤");

    // ================= 1. é¢„è§ˆé¡µå¼ºåŠ›æ¸…ç† & é‡æ’ =================
    // è§£å†³â€œå¼€åœºç™½ä¸‹é¢å¤šä¸€ä¸ªæ¡†â€çš„é—®é¢˜ï¼Œå¹¶å¼ºåˆ¶æ’åº
   


    // ================= 2. å†›å¸ˆä¸Šå¸æƒé™ (God Mode) é‡å†™ =================
    // ä¿®å¤â€œæ²¡ååº”â€çš„é—®é¢˜ï¼Œå¢åŠ é”™è¯¯å¤„ç†ï¼Œæ”¯æŒæ‰€æœ‰é¡µé¢ä¿®æ”¹

    // ğŸ—ºï¸ è§†é‡æ˜ å°„è¡¨ï¼šå‘Šè¯‰å†›å¸ˆå“ªä¸ªé¡µé¢å¯¹åº”å“ªä¸ªæ¡†
    const GOD_VIEW_MAP = {
        'tab-preview':  { id: 'cardDesc',     name: 'è¯¦ç»†è®¾å®š (Description)' }, // é»˜è®¤çœ‹è®¾å®š
        'tab-regex':    { id: 'frontReplace', name: 'å‰ç«¯ä»£ç  (HTML/CSS)' },
        'tab-world':    { id: 'wiContent',    name: 'ä¸–ç•Œä¹¦å†…å®¹ (Content)' },
        'tab-stats':    { id: 'statEditor',   name: 'å±æ€§/é€»è¾‘è§„åˆ™ (Script)' },
        'tab-advanced': { id: 'cardNote',     name: 'æ·±åº¦è®¾å®š (Depth Prompt)' },
        'tab-source':   { id: 'jsonSource',   name: 'å®Œæ•´æºç  (JSON)' }
    };

    // ğŸ•µï¸ è·å–å½“å‰ä¸Šä¸‹æ–‡
    function getGodContext() {
        // æ‰¾åˆ°å½“å‰æ˜¾ç¤ºçš„ Tab ID
        var activeTab = null;
        var contents = document.querySelectorAll('.card-tab-content');
        contents.forEach(el => {
            if (el.style.display === 'block' || getComputedStyle(el).display === 'block') {
                activeTab = el.id;
            }
        });

        if (!activeTab) return null;

        var info = GOD_VIEW_MAP[activeTab];
        // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœåœ¨é¢„è§ˆé¡µï¼Œå¯èƒ½æƒ³æ”¹å¼€åœºç™½
        if (activeTab === 'tab-preview') {
            // ç®€å•é€»è¾‘ï¼šæŠŠè®¾å®šã€å¼€åœºç™½ã€æ ·æœ¬éƒ½è¯»è¿›å»
            var desc = document.getElementById('cardDesc').value;
            var first = document.getElementById('cardFirstMes').value;
            return {
                targetId: 'cardDesc', // é»˜è®¤ä¿®æ”¹ç›®æ ‡æ˜¯è®¾å®šï¼Œä½†å†›å¸ˆå¯ä»¥æŒ‡å®šä¿®æ”¹å…¶ä»–çš„
                targetName: 'é¢„è§ˆé¡µå…¨è§ˆ',
                content: `ã€è¯¦ç»†è®¾å®šã€‘:\n${desc}\n\nã€å¼€åœºç™½ã€‘:\n${first}`
            };
        }

        if (info) {
            var el = document.getElementById(info.id);
            return {
                targetId: info.id,
                targetName: info.name,
                content: el ? el.value : ""
            };
        }
        return null;
    }

    // ğŸ”¥ è¦†ç›–å‘é€å‡½æ•° (ä¿®å¤ç‰ˆ)
    window.sendAdvisorMsg = async function() {
        var input = document.getElementById('advisorInput');
        var text = input.value.trim();
        if(!text) return;
        
        var chat = document.getElementById('advisorChat');
        // ç”¨æˆ·æ°”æ³¡
        chat.innerHTML += `<div style="text-align:right; margin:5px 0; color:#6c5ce7; font-size:12px; padding:5px; background:#f0f0f0; border-radius:8px; display:inline-block; margin-left:auto;">${text}</div><div style="clear:both;"></div>`;
        input.value = '';
        
        // æ˜¾ç¤ºæ€è€ƒä¸­
        var loadingId = 'god-loading-' + Date.now();
        chat.innerHTML += `<div id="${loadingId}" class="ai-loading" style="font-size:10px; color:#999; text-align:center;">ğŸ§  æ­£åœ¨è¯»å–å½“å‰é¡µé¢ä»£ç ...</div>`;
        chat.scrollTop = chat.scrollHeight;

        // è·å–ä¸Šä¸‹æ–‡
        var context = getGodContext();
        var contextStr = context ? context.content.substring(0, 4000) : "(æ— æ³•è¯»å–å½“å‰é¡µé¢å†…å®¹)";
        var contextName = context ? context.targetName : "æœªçŸ¥åŒºåŸŸ";
        var defaultTargetId = context ? context.targetId : "cardDesc";

        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) {
            document.getElementById(loadingId).remove();
            chat.innerHTML += `<div class="advisor-bubble">âŒ è¿˜æ²¡å¡« API Key å‘¢ï¼å»è®¾ç½®é‡Œå¡«ä¸€ä¸‹ã€‚</div>`;
            return;
        }

        // æ„é€ ä¸Šå¸ Prompt
        var prompt = `
        ä½ ç°åœ¨æ˜¯ã€ä»£ç /è®¾å®šä¿®æ”¹åŠ©æ‰‹ã€‘ã€‚
        ç”¨æˆ·å½“å‰åœç•™åœ¨ï¼šã€${contextName}ã€‘ã€‚
        
        ã€å½“å‰é¡µé¢å†…å®¹ã€‘ï¼š
        \`\`\`
        ${contextStr}
        \`\`\`
        
        ç”¨æˆ·éœ€æ±‚ï¼šâ€œ${text}â€
        
        è¯·åˆ†æå†…å®¹å¹¶å›ç­”ã€‚
        ğŸ”¥ **æ ¸å¿ƒæŒ‡ä»¤**ï¼š
        å¦‚æœéœ€è¦ä¿®æ”¹ä»£ç æˆ–æ–‡æœ¬ï¼Œè¯·åŠ¡å¿…åœ¨å›å¤çš„æœ€åï¼Œè¾“å‡ºä¿®æ”¹åçš„å®Œæ•´å†…å®¹ï¼Œå¹¶åŒ…è£¹åœ¨XMLæ ‡ç­¾ä¸­ï¼š
        
        <FIX_TARGET id="ç›®æ ‡è¾“å…¥æ¡†ID">
        è¿™é‡Œæ”¾ä¿®æ”¹åçš„å†…å®¹...
        </FIX_TARGET>
        
        å¸¸ç”¨IDå‚è€ƒï¼š
        - è¯¦ç»†è®¾å®š: cardDesc
        - å¼€åœºç™½: cardFirstMes
        - å¯¹è¯æ ·æœ¬: cardMesExample
        - å‰ç«¯ä»£ç : frontReplace
        - ä¸–ç•Œä¹¦å†…å®¹: wiContent
        - å±æ€§è„šæœ¬: statEditor
        
        è¯·è‡ªåŠ¨åˆ¤æ–­åº”è¯¥ä¿®æ”¹å“ªä¸ª IDã€‚å¦‚æœç”¨æˆ·åªæ˜¯é—®é—®é¢˜ï¼Œä¸éœ€è¦è¾“å‡ºæ ‡ç­¾ã€‚
        `;

        try {
            // å‘èµ·è¯·æ±‚ (å¢åŠ è¶…æ—¶å¤„ç†)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000); // 60ç§’è¶…æ—¶

            const response = await fetch(`${config.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
                body: JSON.stringify({
                    model: config.model || 'gpt-3.5-turbo',
                    messages: [{ role: "user", content: prompt }]
                }),
                signal: controller.signal
            });
            clearTimeout(timeoutId);

            if (!response.ok) throw new Error(`APIé”™è¯¯ ${response.status}`);

            const data = await response.json();
            var res = data.choices[0].message.content;
            document.getElementById(loadingId).remove();

            // è§£æå›å¤
            var replyDisplay = res;
            var actionHtml = "";

            // æ­£åˆ™æå–ä¿®æ”¹æŒ‡ä»¤
            var fixMatch = /<FIX_TARGET id="([^"]+)">([\s\S]*?)<\/FIX_TARGET>/i.exec(res);
            
            if (fixMatch) {
                var targetId = fixMatch[1];
                var newContent = fixMatch[2].trim();
                
                // éšè—æ ‡ç­¾ï¼Œåªæ˜¾ç¤º AI çš„è§£é‡Š
                replyDisplay = res.replace(fixMatch[0], '\n\nâœ… (å·²ç”Ÿæˆä¿®æ”¹æ–¹æ¡ˆï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åº”ç”¨)');
                
                // è½¬ä¹‰å†…å®¹é˜²æ­¢ç ´å HTML
                var safeContent = encodeURIComponent(newContent);

                // ç”Ÿæˆåº”ç”¨æŒ‰é’®
                actionHtml = `
                    <div style="margin-top:8px; border-top:1px dashed #ddd; padding-top:5px;">
                        <button class="advisor-action-btn" onclick="applyGodFix('${targetId}', '${safeContent}', this)">
                            ğŸ‘‰ ç‚¹å‡»æ›¿æ¢ã€${targetId}ã€‘çš„å†…å®¹
                        </button>
                    </div>
                `;
            }

            // æ¸²æŸ“æ°”æ³¡
            var div = document.createElement('div');
            div.className = 'advisor-bubble';
            div.innerHTML = replyDisplay.replace(/\n/g, '<br>') + actionHtml;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;

        } catch(e) {
            if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
            var errMsg = e.name === 'AbortError' ? "å“åº”è¶…æ—¶ï¼Œè¯·æ¢ä¸ªæ¨¡å‹è¯•è¯•" : e.message;
            chat.innerHTML += `<div class="advisor-bubble">âŒ å†›å¸ˆæ‰çº¿äº†ï¼š${errMsg}</div>`;
        }
    };

    // âš¡ï¸ æ‰§è¡Œä¿®æ”¹
    window.applyGodFix = function(targetId, encodedContent, btn) {
        try {
            var el = document.getElementById(targetId);
            if (!el) {
                alert("âŒ å†›å¸ˆçœ¼èŠ±äº†ï¼Œæ‰¾ä¸åˆ° ID ä¸º " + targetId + " çš„è¾“å…¥æ¡†");
                return;
            }

            // å†™å…¥å†…å®¹
            el.value = decodeURIComponent(encodedContent);

            // è§¦å‘åŒæ­¥ (å¦‚æœæ˜¯å±æ€§é¡µ)
            if(typeof syncStatToNote === 'function') syncStatToNote();
            // è§¦å‘é¢„è§ˆ (å¦‚æœæ˜¯å‰ç«¯é¡µ)
            if(targetId === 'frontReplace' && typeof runRegexTest === 'function') runRegexTest();
            // è§¦å‘é¢„è§ˆ (å¦‚æœæ˜¯é¢„è§ˆé¡µ)
            if((targetId === 'cardDesc' || targetId === 'cardFirstMes') && typeof updatePreviewUI === 'function') updatePreviewUI();

            // æŒ‰é’®å˜æ€
            btn.innerText = "âœ… ä¿®æ”¹å·²åº”ç”¨";
            btn.disabled = true;
            btn.style.background = "#d4edda";
            btn.style.color = "#155724";

            auth.toast('âœ¨ å†…å®¹å·²æ›´æ–°ï¼');

        } catch (e) {
            alert("åº”ç”¨å¤±è´¥ï¼š" + e.message);
        }
    };

})();

/* ================= ğŸš‘ è¡¥ä¸ V5.1ï¼šä¿®å¤â€œå»æ·»åŠ â€æŒ‰é’®å¤±æ•ˆ ================= */
(function() {
    console.log("ğŸš‘ æ­£åœ¨ä¿®å¤è·³è½¬åŠŸèƒ½...");

    // 1. é‡å†™è·³è½¬å‡½æ•° (æ ¸å¿ƒä¿®å¤)
    window.jumpToCreator = function(btn, type, encodedPrompt) {
        console.log("ğŸ‘‰ å°è¯•è·³è½¬:", type);

        // æŒ‰é’®å˜æ€åé¦ˆ
        if (btn) {
            btn.innerHTML = "â³ æ­£åœ¨è·³è½¬...";
            btn.style.opacity = "0.7";
        }

        setTimeout(function() {
            try {
                // è§£ç å†…å®¹
                var promptText = decodeURIComponent(encodedPrompt);
                var targetEl = null;

                // --- åˆ†æµé€»è¾‘ ---
                if (type === 'world') {
                    // 1. ä¸–ç•Œä¹¦
                    if(typeof switchCardTab === 'function') switchCardTab('world');
                    targetEl = document.getElementById('aiWorldPrompt');
                } 
                else if (type === 'frontend') {
                    // 2. å‰ç«¯ä»£ç 
                    if(typeof switchCardTab === 'function') switchCardTab('regex');
                    // ç¡®ä¿åˆ‡æ¢åˆ°â€œå‰ç«¯ç¾åŒ–â€æ¨¡å¼
                    var radio = document.querySelector('input[value="frontend"]');
                    if(radio) radio.click(); 
                    if(typeof switchRegexUI === 'function') switchRegexUI('frontend');
                    targetEl = document.getElementById('aiCodePrompt');
                } 
                else if (type === 'stat') {
                    // 3. å±æ€§/é€»è¾‘
                    if(typeof switchCardTab === 'function') switchCardTab('stats');
                    targetEl = document.getElementById('aiStatPrompt');
                }

                // --- æ‰§è¡Œå¡«å…¥ ---
                if (targetEl) {
                    targetEl.value = promptText;
                    targetEl.focus();
                    // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸï¼Œé˜²æ­¢è¢«æŒ¡ä½
                    targetEl.scrollIntoView({behavior: "smooth", block: "center"});
                    
                    auth.toast('âœ… å»ºè®®å·²å¡«å…¥ï¼Œè¯·ç‚¹å‡»â€œç”Ÿæˆâ€');
                    
                    // æŒ‰é’®è®¾ä¸ºå®ŒæˆçŠ¶æ€
                    if (btn) {
                        btn.innerHTML = "âœ… å·²å¡«å…¥";
                        btn.disabled = true;
                        btn.style.background = "#d4edda";
                        btn.style.color = "#155724";
                        btn.style.opacity = "1";
                        btn.style.borderColor = "#c3e6cb";
                    }
                } else {
                    throw new Error("æ‰¾ä¸åˆ°ç›®æ ‡è¾“å…¥æ¡† IDï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
                }

            } catch (e) {
                console.error("è·³è½¬é”™è¯¯:", e);
                alert("âŒ è·³è½¬å¤±è´¥ï¼š" + e.message);
                // æ¢å¤æŒ‰é’®è®©ç”¨æˆ·é‡è¯•
                if (btn) {
                    btn.innerHTML = "âŒ é‡è¯•";
                    btn.disabled = false;
                    btn.style.opacity = "1";
                }
            }
        }, 300); // å»¶è¿Ÿ300æ¯«ç§’ï¼Œç­‰å¾… Tab åˆ‡æ¢åŠ¨ç”»å®Œæˆ
    };

    // 2. é‡æ–°ç»‘å®šæ°”æ³¡ç”Ÿæˆé€»è¾‘ (é˜²æ­¢æ—§ä»£ç ç”Ÿæˆçš„æŒ‰é’®æ²¡æœ‰ onclick)
    window.renderSuggestionBubble = function(item) {
        var chat = document.getElementById('advisorChat');
        if (!chat) return;

        var div = document.createElement('div');
        div.className = 'advisor-bubble';
        
        var icon = "ğŸ’¡";
        if(item.type === 'world') icon = "ğŸŒ";
        if(item.type === 'frontend') icon = "ğŸ¨";
        if(item.type === 'stat') icon = "ğŸ“Š";

        // å®‰å…¨è½¬ä¹‰ï¼Œé˜²æ­¢å•å¼•å·æŠ¥é”™
        var safePrompt = encodeURIComponent(item.prompt || ""); 
        var safeType = item.type;

        div.innerHTML = `
            <div style="font-weight:bold; color:#6c5ce7; margin-bottom:4px;">${icon} ${item.title}</div>
            <div style="font-size:12px; color:#666; margin-bottom:8px;">${item.reason}</div>
            <button class="advisor-action-btn" onclick="window.jumpToCreator(this, '${safeType}', '${safePrompt}')">
                ğŸ‘‰ å»æ·»åŠ  (è‡ªåŠ¨å¡«å•)
            </button>
        `;
        
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    };

    console.log("âœ… è·³è½¬åŠŸèƒ½å·²ä¿®å¤");
})();

/* ================= ğŸš‘ è¡¥ä¸ V5.2ï¼šæš´åŠ›è·³è½¬ä¿®å¤ (æ¨åœŸæœºç‰ˆ) ================= */
(function() {
    console.log("ğŸš‘ æ­£åœ¨æ‰§è¡Œï¼šæš´åŠ›è·³è½¬ä¿®å¤...");

    // 1. è¾…åŠ©ï¼šå¼ºåˆ¶åˆ‡æ¢ Tab çš„é€šç”¨å‡½æ•°
    function forceSwitchTab(tabName) {
        // 1. éšè—æ‰€æœ‰å†…å®¹
        var contents = document.querySelectorAll('.card-tab-content');
        contents.forEach(function(el) { el.style.display = 'none'; });
        
        // 2. å–æ¶ˆæ‰€æœ‰æŒ‰é’®æ¿€æ´»
        var tabs = document.querySelectorAll('.card-tab');
        tabs.forEach(function(el) { el.classList.remove('active'); });

        // 3. æ¿€æ´»ç›®æ ‡
        var targetContent = document.getElementById('tab-' + tabName);
        if (targetContent) targetContent.style.display = 'block';
        
        // 4. å°è¯•æ¿€æ´»å¯¹åº”çš„æŒ‰é’®æ ·å¼ (æ¨¡ç³ŠåŒ¹é…)
        var targetBtn = Array.from(tabs).find(btn => 
            btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(tabName)
        );
        if (targetBtn) targetBtn.classList.add('active');
    }

    // 2. é‡å†™è·³è½¬å‡½æ•°
    window.jumpToCreator = function(btn, type, encodedPrompt) {
        console.log("ğŸ‘‰ æš´åŠ›è·³è½¬å¯åŠ¨:", type);

        if (btn) {
            btn.innerHTML = "â³ å¤„ç†ä¸­...";
            btn.style.opacity = "0.7";
        }

        // ç¡®ä¿æ¨¡æ€æ¡†æ˜¯å¼€ç€çš„
        var modal = document.getElementById('cardCreatorModal');
        if (modal && !modal.classList.contains('active')) {
            modal.classList.add('active');
            modal.style.display = 'flex'; // å¼ºåˆ¶æ˜¾ç¤º
        }

        setTimeout(function() {
            try {
                var promptText = decodeURIComponent(encodedPrompt);
                var targetId = "";

                // --- åˆ†æµå¤„ç† ---
                if (type === 'world') {
                    forceSwitchTab('world');
                    targetId = 'aiWorldPrompt';
                } 
                else if (type === 'frontend') {
                    forceSwitchTab('regex');
                    
                    // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå¼ºåˆ¶æ˜¾ç¤ºâ€œå‰ç«¯ç¾åŒ–â€åŒºåŸŸ
                    // æ— è®ºä¹‹å‰æ˜¯åœ¨å“ªä¸ªæ¨¡å¼ï¼Œå¼ºåˆ¶æŠŠ simple å…³æ‰ï¼ŒæŠŠ frontend æ‰“å¼€
                    var simpleDiv = document.getElementById('uiSimpleMode');
                    var frontDiv = document.getElementById('uiFrontendMode');
                    if (simpleDiv) simpleDiv.style.display = 'none';
                    if (frontDiv) frontDiv.style.display = 'block';
                    
                    // é¡ºä¾¿æŠŠå•é€‰æ¡†ä¹Ÿé€‰ä¸Šï¼Œä¿æŒUIä¸€è‡´
                    var radio = document.querySelector('input[value="frontend"]');
                    if (radio) radio.checked = true;

                    targetId = 'aiCodePrompt';
                } 
                else if (type === 'stat') {
                    forceSwitchTab('stats');
                    targetId = 'aiStatPrompt';
                }

                // --- å¯»æ‰¾å¹¶å¡«å…¥ ---
                var targetEl = document.getElementById(targetId);
                
                if (targetEl) {
                    targetEl.value = promptText;
                    targetEl.focus();
                    // æ»šåŠ¨å®šä½
                    targetEl.scrollIntoView({behavior: "smooth", block: "center"});
                    
                    // è§†è§‰åé¦ˆï¼šé—ªçƒä¸€ä¸‹
                    var oldBg = targetEl.style.backgroundColor;
                    targetEl.style.transition = "background 0.3s";
                    targetEl.style.backgroundColor = "#d4edda"; // æµ…ç»¿
                    setTimeout(() => targetEl.style.backgroundColor = oldBg, 1000);

                    auth.toast('âœ… å»ºè®®å·²å¡«å…¥ï¼Œè¯·ç‚¹å‡»â€œç”Ÿæˆâ€');
                    
                    if (btn) {
                        btn.innerHTML = "âœ… å·²å¡«å…¥";
                        btn.disabled = true;
                        btn.style.background = "#d4edda";
                        btn.style.color = "#155724";
                        btn.style.borderColor = "#c3e6cb";
                    }
                } else {
                    // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œå°è¯•åœ¨æ§åˆ¶å°æ‰“å°é¡µé¢ç»“æ„ï¼Œæ–¹ä¾¿è°ƒè¯•
                    console.error("ç›®æ ‡ä¸¢å¤±:", targetId);
                    console.log("å½“å‰TabçŠ¶æ€:", document.getElementById('tab-' + (type==='frontend'?'regex':type)).style.display);
                    throw new Error(`æ‰¾ä¸åˆ°è¾“å…¥æ¡† [${targetId}]ï¼Œè¯·ç¡®è®¤è¯¥é¡µé¢æ˜¯å¦åŠ è½½`);
                }

            } catch (e) {
                console.error("è·³è½¬å´©æºƒ:", e);
                alert("è·³è½¬å¤±è´¥ï¼š" + e.message);
                if (btn) {
                    btn.innerHTML = "âŒ é‡è¯•";
                    btn.disabled = false;
                }
            }
        }, 200); // ç¨å¾®ç­‰å¾…æ¸²æŸ“
    };

    console.log("âœ… æš´åŠ›è·³è½¬è¡¥ä¸å·²åŠ è½½");
})();

/* ================= ğŸ§  è¡¥ä¸ V6.0ï¼šå†›å¸ˆåŒæ¨¡å¼åˆ‡æ¢ (åˆ›æ„/ä¸“ä¸š) ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œè¡¥ä¸ V6.0ï¼šå†›å¸ˆæ¨¡å¼åˆ†æµç³»ç»Ÿå·²ä¸Šçº¿");

    // 1. åˆå§‹åŒ–çŠ¶æ€
    window.advisorMode = 'normal'; // é»˜è®¤æ™®é€šæ¨¡å¼ (normal) / ä¸“ä¸šæ¨¡å¼ (pro)
    
    // æ›´æ–°è¾“å…¥æ¡†æç¤ºçš„è¾…åŠ©å‡½æ•°
    function updatePlaceholder() {
        var input = document.getElementById('advisorInput');
        if (!input) return;
        if (window.advisorMode === 'pro') {
            input.placeholder = "ğŸ”´ ä¸“ä¸šæ¨¡å¼ï¼šå¯æŒ‡ä»¤ä¿®æ”¹ä»»æ„ä»£ç /ä¸–ç•Œä¹¦...";
            input.style.border = "2px solid #e17055"; // çº¢è‰²è¾¹æ¡†æç¤º
        } else {
            input.placeholder = "ğŸŸ¢ æ™®é€šæ¨¡å¼ï¼šè¾“å…¥'å¼€å¯ä¸“ä¸šæ¨¡å¼'åˆ‡æ¢æƒé™...";
            input.style.border = "2px solid #6c5ce7"; // ç´«è‰²è¾¹æ¡†
        }
    }
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    setTimeout(updatePlaceholder, 500);

    // 2. è¦†ç›–å‘é€é€»è¾‘ (æ€»æ§åˆ¶å™¨)
    window.sendAdvisorMsg = async function() {
        var input = document.getElementById('advisorInput');
        var text = input.value.trim();
        if(!text) return;

        // --- ğŸ•µï¸ å£ä»¤æ£€æµ‹ç³»ç»Ÿ ---
        if (text.includes("å¼€å¯ä¸“ä¸šæ¨¡å¼") || text.includes("è½¬åˆ°ä¸“ä¸šæ¨¡å¼") || text === "ä¸“ä¸šæ¨¡å¼") {
            window.advisorMode = 'pro';
            updatePlaceholder();
            addBubble('system', "ğŸ”´ <b>ç³»ç»Ÿåˆ‡æ¢ï¼š</b>å·²è¿›å…¥ã€ä¸“ä¸šæ¨¡å¼ã€‘ã€‚<br>æˆ‘ç°åœ¨æ‹¥æœ‰æœ€é«˜æƒé™ï¼Œå¯ä»¥è¯»å–å¹¶ä¿®æ”¹å½“å‰é¡µé¢çš„ä»»ä½•ä»£ç ã€è§„åˆ™æˆ–è®¾å®šã€‚<br>è¯·è¾“å…¥ä¿®æ”¹æŒ‡ä»¤ã€‚");
            input.value = '';
            return;
        }
        if (text.includes("å…³é—­") || text.includes("æ™®é€šæ¨¡å¼") || text.includes("é€€å‡º")) {
            window.advisorMode = 'normal';
            updatePlaceholder();
            addBubble('system', "ğŸŸ¢ <b>ç³»ç»Ÿåˆ‡æ¢ï¼š</b>å·²å›åˆ°ã€æ™®é€šæ¨¡å¼ã€‘ã€‚<br>æˆ‘ä¼šæ ¹æ®äººè®¾ä¸ºæ‚¨æä¾›çµæ„Ÿå’Œå»ºè®®ã€‚");
            input.value = '';
            return;
        }

        // æ­£å¸¸å‘é€æ¶ˆæ¯
        addBubble('user', text);
        input.value = '';
        
        var loadingId = 'loading-' + Date.now();
        var chat = document.getElementById('advisorChat');
        chat.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-loading" style="font-size:10px;color:#999;text-align:center;">ğŸ§  æ€è€ƒä¸­...</div>`);
        chat.scrollTop = chat.scrollHeight;

        // --- ğŸ”€ æ¨¡å¼åˆ†æµ ---
        try {
            if (window.advisorMode === 'pro') {
                await runGodModeLogic(text, loadingId); // æ‰§è¡Œ V5.0 çš„ä¸Šå¸æ¨¡å¼
            } else {
                await runCreativeModeLogic(text, loadingId); // æ‰§è¡Œ V4.0 çš„åˆ›æ„æ¨¡å¼
            }
        } catch (e) {
            document.getElementById(loadingId).remove();
            addBubble('system', `âŒ é”™è¯¯ï¼š${e.message}`);
        }
    };

    // -------------------------------------------------------------
    // ğŸŸ¢ æ¨¡å¼ Aï¼šæ™®é€šæ¨¡å¼ (è¯»äººè®¾ -> æå»ºè®® -> ä¸€é”®å¡«å…¥)
    // -------------------------------------------------------------
    async function runCreativeModeLogic(userText, loadingId) {
        var name = document.getElementById('cardName').value;
        var desc = document.getElementById('cardDesc').value.trim();
        
        if (desc.length < 20) {
            document.getElementById(loadingId).remove();
            addBubble('system', "ğŸ“œ ä¸»å…¬ï¼Œè¯·å…ˆåœ¨é¢„è§ˆé¡µå†™ç‚¹ã€è¯¦ç»†è®¾å®šã€‘ï¼Œæˆ‘æ‰èƒ½ä¸ºæ‚¨å‡ºè°‹åˆ’ç­–ã€‚");
            return;
        }

        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) throw new Error("è¯·å…ˆé…ç½® API Key");

        // åˆ›æ„ Prompt
        var prompt = `
        ä½ ç°åœ¨çš„èº«ä»½æ˜¯ï¼šSillyTavern å¡ç‰‡åˆ¶ä½œé¡¾é—®ï¼ˆæ™®é€šæ¨¡å¼ï¼‰ã€‚
        ã€å½“å‰è§’è‰²äººè®¾ã€‘ï¼š${desc.substring(0, 1000)}...
        
        ç”¨æˆ·éœ€æ±‚ï¼šâ€œ${userText}â€
        
        è¯·æ ¹æ®ã€è§’è‰²äººè®¾ã€‘å’Œç”¨æˆ·éœ€æ±‚ï¼Œæä¾› 1-3 ä¸ªå…·ä½“çš„åˆ¶ä½œå»ºè®®ï¼ˆä¸–ç•Œä¹¦/æ­£åˆ™/å±æ€§è§„åˆ™ï¼‰ã€‚
        
        ğŸ”¥ **å¿…é¡»è¿”å›çº¯ JSON æ•°ç»„**ï¼Œæ ¼å¼å¦‚ä¸‹ï¼ˆä¸è¦ä»»ä½• Markdownï¼‰ï¼š
        [
            {
                "type": "world",  // æˆ– "frontend", "stat"
                "title": "å»ºè®®æ ‡é¢˜ (å¦‚: æ·»åŠ XXè®¾å®š)",
                "reason": "ä¸ºä»€ä¹ˆå»ºè®®è¿™ä¹ˆåš (ç®€çŸ­ç†ç”±)",
                "prompt": "ç”ŸæˆæŒ‡ä»¤ (å¡«å…¥ç”Ÿæˆå™¨çš„å…·ä½“Prompt)"
            }
        ]
        å¦‚æœç”¨æˆ·åªæ˜¯é—²èŠï¼Œè¿”å›ç©ºæ•°ç»„ [] å¹¶ç›´æ¥ç”¨æ–‡å­—å›ç­”ã€‚
        `;

        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });
        
        document.getElementById(loadingId).remove();
        const data = await response.json();
        var resText = data.choices[0].message.content;

        // å°è¯•è§£æ JSON
        try {
            var cleanJson = resText.replace(/```json/g, '').replace(/```/g, '').trim();
            // å¦‚æœ AI å›å¤äº†çº¯æ–‡æœ¬ï¼ˆé—²èŠï¼‰ï¼Œè¿™é‡Œä¼šæŠ¥é”™ï¼Œè·³åˆ° catch å¤„ç†æ–‡æœ¬
            if (!cleanJson.startsWith('[')) throw new Error("Not JSON");
            
            var suggestions = JSON.parse(cleanJson);
            if (suggestions.length === 0) {
                addBubble('system', "ğŸ¤” å†›å¸ˆè§‰å¾—æ— éœ€æ”¹åŠ¨ï¼Œæˆ–è¯·å…·ä½“æè¿°æ‚¨çš„éœ€æ±‚ã€‚");
            } else {
                suggestions.forEach(item => {
                    renderCreativeBubble(item);
                });
            }
        } catch (e) {
            // è§£æå¤±è´¥ï¼Œè¯´æ˜ AI å›å¤çš„æ˜¯æ™®é€šå¯¹è¯
            addBubble('system', resText);
        }
    }

    // æ¸²æŸ“åˆ›æ„æ°”æ³¡ (å¸¦â€œå»æ·»åŠ â€æŒ‰é’®)
    function renderCreativeBubble(item) {
        var chat = document.getElementById('advisorChat');
        var div = document.createElement('div');
        div.className = 'advisor-bubble';
        var icon = item.type === 'world' ? "ğŸŒ" : (item.type === 'frontend' ? "ğŸ¨" : "ğŸ“Š");
        
        // å®‰å…¨è½¬ä¹‰
        var safePrompt = encodeURIComponent(item.prompt || "");
        
        div.innerHTML = `
            <div style="font-weight:bold; color:#6c5ce7; margin-bottom:4px;">${icon} ${item.title}</div>
            <div style="font-size:12px; color:#666; margin-bottom:8px;">${item.reason}</div>
            <button class="advisor-action-btn" onclick="window.jumpToCreator(this, '${item.type}', '${safePrompt}')">
                ğŸ‘‰ å»æ·»åŠ  (è‡ªåŠ¨å¡«å•)
            </button>
        `;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }


    // -------------------------------------------------------------
    // ğŸ”´ æ¨¡å¼ Bï¼šä¸“ä¸šæ¨¡å¼ (è¯»å½“å‰é¡µ -> æ”¹ä»£ç  -> ä¸€é”®æ›¿æ¢)
    // -------------------------------------------------------------
    async function runGodModeLogic(userText, loadingId) {
        // 1. è·å–å½“å‰é¡µé¢ä¸Šä¸‹æ–‡ (å¤ç”¨ä¹‹å‰çš„é€»è¾‘)
        var context = getGodContext(); 
        var contextStr = context ? context.content.substring(0, 3000) : "(æ— æ³•è¯»å–å†…å®¹)";
        var contextName = context ? context.targetName : "æœªçŸ¥åŒºåŸŸ";

        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) throw new Error("è¯·å…ˆé…ç½® API Key");

        var prompt = `
        ä½ ç°åœ¨æ˜¯ï¼šä»£ç /æ–‡æœ¬ä¿®æ”¹ä¸“å®¶ï¼ˆä¸“ä¸šæ¨¡å¼ï¼‰ã€‚
        ç”¨æˆ·å½“å‰åœç•™åœ¨ï¼šã€${contextName}ã€‘ã€‚
        
        ã€å½“å‰å†…å®¹ã€‘ï¼š
        \`\`\`
        ${contextStr}
        \`\`\`
        
        ç”¨æˆ·æŒ‡ä»¤ï¼šâ€œ${userText}â€
        
        ğŸ”¥ **æ ¸å¿ƒæŒ‡ä»¤**ï¼š
        1. å¦‚æœéœ€è¦ä¿®æ”¹ï¼Œè¯·è¾“å‡ºä¿®æ”¹åçš„**å®Œæ•´å†…å®¹**ã€‚
        2. å¿…é¡»å°†æ–°å†…å®¹åŒ…è£¹åœ¨ XML æ ‡ç­¾ä¸­ï¼š
           <FIX_TARGET id="${context ? context.targetId : 'cardDesc'}">
           è¿™é‡Œæ”¾ä¿®æ”¹åçš„å†…å®¹...
           </FIX_TARGET>
        `;

        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });

        document.getElementById(loadingId).remove();
        const data = await response.json();
        var resText = data.choices[0].message.content;

        // è§£æ XML æ ‡ç­¾
        var fixMatch = /<FIX_TARGET id="([^"]+)">([\s\S]*?)<\/FIX_TARGET>/i.exec(resText);
        
        if (fixMatch) {
            var targetId = fixMatch[1];
            var newContent = fixMatch[2].trim();
            var replyDisplay = resText.replace(fixMatch[0], '\n\nâœ… (ä¿®æ”¹æ–¹æ¡ˆå·²ç”Ÿæˆ)');
            var safeContent = encodeURIComponent(newContent);

            var actionHtml = `
                <div style="margin-top:8px; border-top:1px dashed #ddd; padding-top:5px;">
                    <button class="advisor-action-btn" onclick="window.applyGodFix('${targetId}', '${safeContent}', this)">
                        âœ… ç‚¹å‡»åº”ç”¨ä¿®æ”¹
                    </button>
                </div>
            `;
            addBubble('system', replyDisplay.replace(/\n/g, '<br>') + actionHtml);
        } else {
            addBubble('system', resText.replace(/\n/g, '<br>'));
        }
    }

    // --- è¾…åŠ©å·¥å…· ---
    
    // æ¸²æŸ“æ™®é€šæ°”æ³¡
    function addBubble(role, html) {
        var chat = document.getElementById('advisorChat');
        var div = document.createElement('div');
        if (role === 'user') {
            div.innerHTML = `<div style="text-align:right; margin:5px 0; color:#6c5ce7; font-size:12px; padding:5px; background:#f0f0f0; border-radius:8px; display:inline-block; margin-left:auto;">${html}</div><div style="clear:both;"></div>`;
        } else {
            div.className = 'advisor-bubble';
            div.innerHTML = html;
        }
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    // è·å–å½“å‰ä¸Šä¸‹æ–‡ (å¤ç”¨ä¹‹å‰çš„æ˜ å°„è¡¨)
    function getGodContext() {
        const GOD_VIEW_MAP = {
            'tab-preview':  { id: 'cardDesc',     name: 'è¯¦ç»†è®¾å®š' },
            'tab-regex':    { id: 'frontReplace', name: 'å‰ç«¯ä»£ç ' },
            'tab-world':    { id: 'wiContent',    name: 'ä¸–ç•Œä¹¦å†…å®¹' },
            'tab-stats':    { id: 'statEditor',   name: 'å±æ€§é€»è¾‘' },
            'tab-advanced': { id: 'cardNote',     name: 'æ·±åº¦è®¾å®š' },
            'tab-source':   { id: 'jsonSource',   name: 'å®Œæ•´æºç ' }
        };
        var activeTab = null;
        document.querySelectorAll('.card-tab-content').forEach(el => {
            if (el.style.display === 'block') activeTab = el.id;
        });
        if (activeTab === 'tab-preview') {
            // é¢„è§ˆé¡µç‰¹æ®Šå¤„ç†ï¼šæŠŠå¼€åœºç™½ä¹Ÿè¯»è¿›å»
            var desc = document.getElementById('cardDesc').value;
            var first = document.getElementById('cardFirstMes').value;
            return { targetId: 'cardDesc', targetName: 'äººè®¾ä¸å¼€åœºç™½', content: `ã€è®¾å®šã€‘\n${desc}\n\nã€å¼€åœºã€‘\n${first}` };
        }
        var info = GOD_VIEW_MAP[activeTab];
        if (info) {
            var el = document.getElementById(info.id);
            return { targetId: info.id, targetName: info.name, content: el ? el.value : "" };
        }
        return null;
    }

})();

/* ================= ğŸ”§ è¡¥ä¸ V8.0ï¼šå±æ€§/é«˜çº§åŒå‘åŒæ­¥ & è·³è½¬ä¿®å¤ ================= */
(function() {
    console.log("ğŸš‘ æ‰§è¡Œ V8.0ï¼šä¿®å¤å±æ€§åŒæ­¥ä¸è·³è½¬åŠŸèƒ½...");

    // 1. ğŸ› ï¸ ç®€å•çš„åŒå‘åŒæ­¥ (æ‰“å­—æ—¶ä¸¤è¾¹ä¸€èµ·å˜)
    function initSync() {
        var statEl = document.getElementById('statEditor'); // å±æ€§é¡µæ¡†
        var noteEl = document.getElementById('cardNote');   // é«˜çº§é¡µæ¡†

        if (statEl && noteEl) {
            // å±æ€§é¡µå˜ -> é«˜çº§é¡µå˜
            statEl.oninput = function() { noteEl.value = statEl.value; };
            // é«˜çº§é¡µå˜ -> å±æ€§é¡µå˜
            noteEl.oninput = function() { statEl.value = noteEl.value; };
        }
    }
    setTimeout(initSync, 1000); // å»¶è¿Ÿä¸€ç§’æ‰§è¡Œï¼Œç¡®ä¿å®‰å…¨

    // 2. ğŸ› ï¸ è¾…åŠ©ï¼šåœ¨æŒ‡å®šè¾“å…¥æ¡†ä¸‹é¢ç”Ÿæˆ/æ›´æ–°è¯´æ˜ä¹¦ (ç»¿æ¡†)
    function showExplanationBox(targetInputId, text) {
        var inputEl = document.getElementById(targetInputId);
        if (!inputEl) return;

        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰è¯´æ˜æ¡†äº† (é˜²æ­¢é‡å¤åˆ›å»º)
        var boxId = targetInputId + '_guide_box';
        var box = document.getElementById(boxId);

        if (!box) {
            box = document.createElement('div');
            box.id = boxId;
            // æ ·å¼ï¼šç»¿è‰²èƒŒæ™¯ï¼Œåœ†è§’
            box.style.cssText = "margin-top:8px; padding:10px; background:#e8f5e9; border:1px solid #a5d6a7; border-radius:5px; color:#2e7d32; font-size:12px; line-height:1.5; white-space:pre-wrap;";
            // æ’åœ¨è¾“å…¥æ¡†åé¢
            inputEl.parentNode.insertBefore(box, inputEl.nextSibling);
        }

        box.innerHTML = `<b>ğŸ“– è¿è¡ŒåŸç†è¯´æ˜ï¼š</b>\n${text}`;
        box.style.display = 'block';
    }

    // 3. âš¡ï¸ é‡å†™ç”Ÿæˆé€»è¾‘ (å¼ºåˆ¶åŒå†™)
    window.generateStatLogic = async function() {
        var req = document.getElementById('aiStatPrompt').value.trim();
        var charDesc = document.getElementById('cardDesc').value.trim();

        if (!req) { auth.toast('è¯·å…ˆæè¿°è§„åˆ™...'); return; }
        
        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·å…ˆé…ç½® API Key'); return; }

        var btn = document.getElementById('btnGenStat');
        var oldText = btn.innerText;
        btn.innerText = 'ğŸ§  æ­£åœ¨ç¼–å†™...'; btn.disabled = true;

        var prompt = `
        ä½ æ˜¯ä¸€ä¸ªSillyTavernè§„åˆ™ä¸“å®¶ã€‚
        è§’è‰²è®¾å®šï¼š${charDesc.substring(0, 300)}...
        ç”¨æˆ·éœ€æ±‚ï¼šã€${req}ã€‘
        
        è¯·å®Œæˆä¸¤ä»¶äº‹ï¼š
        1. ç¼–å†™ System Prompt (ä»£ç )ã€‚
        2. ç¼–å†™ã€ä¸­æ–‡è¿è¡ŒåŸç†è¯´æ˜ä¹¦ã€‘ (è§£é‡Š)ã€‚
        
        å¿…é¡»è¿”å›çº¯ JSON æ ¼å¼ï¼š
        {
            "script": "è¿™é‡Œæ”¾ä»£ç ...",
            "explanation": "è¿™é‡Œç”¨ä¸­æ–‡è§£é‡Šï¼š1.å˜é‡æœ‰å“ªäº›ï¼Ÿ 2.æ€ä¹ˆè§¦å‘ï¼Ÿ 3.æ•ˆæœæ˜¯ä»€ä¹ˆï¼Ÿ"
        }
        `;

        try {
            var res = await fetchAI(prompt, config);
            var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
            var data = JSON.parse(cleanJson);
            
            // --- ğŸ”¥ æ ¸å¿ƒï¼šä¸¤è¾¹åŒæ—¶å¡« ---
            
            // 1. å¡«å…¥ã€å±æ€§é¡µã€‘
            var statEl = document.getElementById('statEditor');
            if(statEl) statEl.value = data.script;
            showExplanationBox('statEditor', data.explanation);

            // 2. å¡«å…¥ã€é«˜çº§é¡µã€‘
            var noteEl = document.getElementById('cardNote');
            if(noteEl) noteEl.value = data.script;
            showExplanationBox('cardNote', data.explanation);

            auth.toast('âœ¨ è§„åˆ™ä¸è¯´æ˜ä¹¦å·²ç”Ÿæˆ (ä¸¤å¤„å‡å·²æ˜¾ç¤º)');

        } catch (e) {
            console.error(e);
            auth.toast('âŒ ç”Ÿæˆå¤±è´¥');
        } finally {
            btn.innerText = oldText; btn.disabled = false;
        }
    };

    // 4. ğŸš‘ ä¿®å¤â€œå»æ·»åŠ â€è·³è½¬æŒ‰é’® (æœ€ç¨³å¦¥ç‰ˆ)
    window.jumpToCreator = function(btn, type, encodedPrompt) {
        // æŒ‰é’®åé¦ˆ
        if(btn) { btn.innerHTML = "âœ… å·²å¡«å…¥"; btn.disabled = true; btn.style.background="#d4edda"; }

        var promptText = decodeURIComponent(encodedPrompt);
        
        // ç®€å•çš„åˆ‡æ¢é€»è¾‘
        if (type === 'world') {
            if(typeof switchCardTab === 'function') switchCardTab('world');
            var el = document.getElementById('aiWorldPrompt');
            if(el) { el.value = promptText; el.focus(); }
        } 
        else if (type === 'frontend') {
            if(typeof switchCardTab === 'function') switchCardTab('regex');
            // ç¡®ä¿åˆ‡åˆ°é«˜çº§æ¨¡å¼
            var ui = document.getElementById('uiFrontendMode');
            if(ui) ui.style.display = 'block';
            var el = document.getElementById('aiCodePrompt');
            if(el) { el.value = promptText; el.focus(); }
        } 
        else if (type === 'stat') {
            if(typeof switchCardTab === 'function') switchCardTab('stats');
            var el = document.getElementById('aiStatPrompt');
            if(el) { el.value = promptText; el.focus(); }
        }
        
        // æ»šåŠ¨å®šä½ (é˜²æ­¢æ‰¾ä¸åˆ°æ¡†)
        setTimeout(function(){
            var activeInput = document.activeElement;
            if(activeInput && activeInput.tagName === 'INPUT') {
                activeInput.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }, 300);
    };

})();

/* ================= ğŸ”§ è¡¥ä¸ V8.0ï¼šå±æ€§/é«˜çº§åŒå‘åŒæ­¥ & è·³è½¬ä¿®å¤ ================= */
(function() {
    console.log("ğŸš‘ æ‰§è¡Œ V8.0ï¼šä¿®å¤å±æ€§åŒæ­¥ä¸è·³è½¬åŠŸèƒ½...");

    // 1. ğŸ› ï¸ ç®€å•çš„åŒå‘åŒæ­¥ (æ‰“å­—æ—¶ä¸¤è¾¹ä¸€èµ·å˜)
    function initSync() {
        var statEl = document.getElementById('statEditor'); // å±æ€§é¡µæ¡†
        var noteEl = document.getElementById('cardNote');   // é«˜çº§é¡µæ¡†

        if (statEl && noteEl) {
            // å±æ€§é¡µå˜ -> é«˜çº§é¡µå˜
            statEl.oninput = function() { noteEl.value = statEl.value; };
            // é«˜çº§é¡µå˜ -> å±æ€§é¡µå˜
            noteEl.oninput = function() { statEl.value = noteEl.value; };
        }
    }
    setTimeout(initSync, 1000); // å»¶è¿Ÿä¸€ç§’æ‰§è¡Œï¼Œç¡®ä¿å®‰å…¨

    // 2. ğŸ› ï¸ è¾…åŠ©ï¼šåœ¨æŒ‡å®šè¾“å…¥æ¡†ä¸‹é¢ç”Ÿæˆ/æ›´æ–°è¯´æ˜ä¹¦ (ç»¿æ¡†)
    function showExplanationBox(targetInputId, text) {
        var inputEl = document.getElementById(targetInputId);
        if (!inputEl) return;

        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰è¯´æ˜æ¡†äº† (é˜²æ­¢é‡å¤åˆ›å»º)
        var boxId = targetInputId + '_guide_box';
        var box = document.getElementById(boxId);

        if (!box) {
            box = document.createElement('div');
            box.id = boxId;
            // æ ·å¼ï¼šç»¿è‰²èƒŒæ™¯ï¼Œåœ†è§’
            box.style.cssText = "margin-top:8px; padding:10px; background:#e8f5e9; border:1px solid #a5d6a7; border-radius:5px; color:#2e7d32; font-size:12px; line-height:1.5; white-space:pre-wrap;";
            // æ’åœ¨è¾“å…¥æ¡†åé¢
            inputEl.parentNode.insertBefore(box, inputEl.nextSibling);
        }

        box.innerHTML = `<b>ğŸ“– è¿è¡ŒåŸç†è¯´æ˜ï¼š</b>\n${text}`;
        box.style.display = 'block';
    }

    // 3. âš¡ï¸ é‡å†™ç”Ÿæˆé€»è¾‘ (å¼ºåˆ¶åŒå†™)
    window.generateStatLogic = async function() {
        var req = document.getElementById('aiStatPrompt').value.trim();
        var charDesc = document.getElementById('cardDesc').value.trim();

        if (!req) { auth.toast('è¯·å…ˆæè¿°è§„åˆ™...'); return; }
        
        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) { auth.toast('ğŸ”‘ è¯·å…ˆé…ç½® API Key'); return; }

        var btn = document.getElementById('btnGenStat');
        var oldText = btn.innerText;
        btn.innerText = 'ğŸ§  æ­£åœ¨ç¼–å†™...'; btn.disabled = true;

        var prompt = `
        ä½ æ˜¯ä¸€ä¸ªSillyTavernè§„åˆ™ä¸“å®¶ã€‚
        è§’è‰²è®¾å®šï¼š${charDesc.substring(0, 300)}...
        ç”¨æˆ·éœ€æ±‚ï¼šã€${req}ã€‘
        
        è¯·å®Œæˆä¸¤ä»¶äº‹ï¼š
        1. ç¼–å†™ System Prompt (ä»£ç )ã€‚
        2. ç¼–å†™ã€ä¸­æ–‡è¿è¡ŒåŸç†è¯´æ˜ä¹¦ã€‘ (è§£é‡Š)ã€‚
        
        å¿…é¡»è¿”å›çº¯ JSON æ ¼å¼ï¼š
        {
            "script": "è¿™é‡Œæ”¾ä»£ç ...",
            "explanation": "è¿™é‡Œç”¨ä¸­æ–‡è§£é‡Šï¼š1.å˜é‡æœ‰å“ªäº›ï¼Ÿ 2.æ€ä¹ˆè§¦å‘ï¼Ÿ 3.æ•ˆæœæ˜¯ä»€ä¹ˆï¼Ÿ"
        }
        `;

        try {
            var res = await fetchAI(prompt, config);
            var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
            var data = JSON.parse(cleanJson);
            
            // --- ğŸ”¥ æ ¸å¿ƒï¼šä¸¤è¾¹åŒæ—¶å¡« ---
            
            // 1. å¡«å…¥ã€å±æ€§é¡µã€‘
            var statEl = document.getElementById('statEditor');
            if(statEl) statEl.value = data.script;
            showExplanationBox('statEditor', data.explanation);

            // 2. å¡«å…¥ã€é«˜çº§é¡µã€‘
            var noteEl = document.getElementById('cardNote');
            if(noteEl) noteEl.value = data.script;
            showExplanationBox('cardNote', data.explanation);

            auth.toast('âœ¨ è§„åˆ™ä¸è¯´æ˜ä¹¦å·²ç”Ÿæˆ (ä¸¤å¤„å‡å·²æ˜¾ç¤º)');

        } catch (e) {
            console.error(e);
            auth.toast('âŒ ç”Ÿæˆå¤±è´¥');
        } finally {
            btn.innerText = oldText; btn.disabled = false;
        }
    };

    // 4. ğŸš‘ ä¿®å¤â€œå»æ·»åŠ â€è·³è½¬æŒ‰é’® (æœ€ç¨³å¦¥ç‰ˆ)
    window.jumpToCreator = function(btn, type, encodedPrompt) {
        // æŒ‰é’®åé¦ˆ
        if(btn) { btn.innerHTML = "âœ… å·²å¡«å…¥"; btn.disabled = true; btn.style.background="#d4edda"; }

        var promptText = decodeURIComponent(encodedPrompt);
        
        // ç®€å•çš„åˆ‡æ¢é€»è¾‘
        if (type === 'world') {
            if(typeof switchCardTab === 'function') switchCardTab('world');
            var el = document.getElementById('aiWorldPrompt');
            if(el) { el.value = promptText; el.focus(); }
        } 
        else if (type === 'frontend') {
            if(typeof switchCardTab === 'function') switchCardTab('regex');
            // ç¡®ä¿åˆ‡åˆ°é«˜çº§æ¨¡å¼
            var ui = document.getElementById('uiFrontendMode');
            if(ui) ui.style.display = 'block';
            var el = document.getElementById('aiCodePrompt');
            if(el) { el.value = promptText; el.focus(); }
        } 
        else if (type === 'stat') {
            if(typeof switchCardTab === 'function') switchCardTab('stats');
            var el = document.getElementById('aiStatPrompt');
            if(el) { el.value = promptText; el.focus(); }
        }
        
        // æ»šåŠ¨å®šä½ (é˜²æ­¢æ‰¾ä¸åˆ°æ¡†)
        setTimeout(function(){
            var activeInput = document.activeElement;
            if(activeInput && activeInput.tagName === 'INPUT') {
                activeInput.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }, 300);
    };

})();

/* ================= ğŸ”§ è¡¥ä¸ V9.0ï¼šç•Œé¢å®Œç¾é‡æ’ & å†›å¸ˆé€»è¾‘ä¿®æ­£ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V9.0ï¼šä¿®å¤ç•Œé¢ä¸¢å¤±ã€ç¼–è¾‘æ¡†è·‘è·¯ã€å†›å¸ˆä¹±æŒ‡è·¯é—®é¢˜...");

    // ================= 1. ç•Œé¢é‡æ’ (æ‰“åŒ…ç§»åŠ¨æ³•) =================
    // è§£å†³ï¼šå¼€åœºç™½æ¶ˆå¤±ã€é¡ºåºé”™ä¹±ã€äºŒæ¬¡ç¼–è¾‘æ¡†ä¸¢å¤±
    function fixLayoutPerfectly() {
        var tab = document.getElementById('tab-preview');
        if (!tab) return;

        // å®šä¹‰ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶çš„ ID é…ç½®
        var config = [
            { id: 'cardDesc',       refineId: 'refineArea_desc' },     // 1. è¯¦ç»†è®¾å®š
            { id: 'cardFirstMes',   refineId: 'refineArea_firstMes' }, // 2. å¼€åœºç™½
            { id: 'cardMesExample', refineId: 'refineArea_example' }   // 3. å¯¹è¯æ ·æœ¬
        ];

        // æ‰¾åˆ°æ’å…¥ç‚¹ (è“è‰²ä¸€é”®ç”ŸæˆæŒ‰é’®)
        var anchorBtn = document.getElementById('btnOneClickGen');
        // å¦‚æœæ²¡æ‰¾åˆ°æŒ‰é’®ï¼Œå°±æ‰¾ä¸ªå¤§æ¦‚ä½ç½® (snippet-group)
        if (!anchorBtn) anchorBtn = tab.querySelector('.snippet-group');
        
        // åˆ›å»ºä¸€ä¸ªå®¹å™¨æ¥æ”¾è¿™ä¸‰ä¸ªå®¶ä¼™ (é¿å…å®ƒä»¬ä¹±è·‘)
        var mainContainer = document.getElementById('mainPreviewContainer');
        if (!mainContainer) {
            mainContainer = document.createElement('div');
            mainContainer.id = 'mainPreviewContainer';
            // æ’åœ¨æŒ‰é’®åé¢
            if (anchorBtn && anchorBtn.parentNode) {
                anchorBtn.parentNode.insertBefore(mainContainer, anchorBtn.nextSibling);
            } else {
                tab.appendChild(mainContainer);
            }
        }

        // --- ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šæ‰“åŒ…æ¬è¿ ---
        config.forEach(function(item) {
            var inputEl = document.getElementById(item.id);
            if (!inputEl) return;

            // 1. æ‰¾ Label (é€šå¸¸æ˜¯å‰ä¸€ä¸ªå…„å¼Ÿ)
            var labelEl = inputEl.previousElementSibling;
            // å¦‚æœå‰ä¸€ä¸ªä¸æ˜¯ label (å¯èƒ½æ˜¯è¢«åŒ…äº†ä¸€å±‚)ï¼Œå°è¯•å¾€ä¸Šæ‰¾
            if (!labelEl || labelEl.tagName !== 'LABEL') {
                // æœ‰æ—¶å€™ input è¢«åŒ…åœ¨ div é‡Œï¼Œlabel åœ¨ div å¤–é¢
                if (inputEl.parentNode.tagName === 'DIV' && inputEl.parentNode.previousElementSibling?.tagName === 'LABEL') {
                    labelEl = inputEl.parentNode.previousElementSibling;
                    // å¦‚æœè¢«åŒ…äº†ï¼ŒinputEl æŒ‡å‘çˆ¶çº§ divï¼Œæ–¹ä¾¿ä¸€èµ·æ¬
                    inputEl = inputEl.parentNode; 
                }
            }

            // 2. æ‰¾äºŒæ¬¡ç¼–è¾‘æ¡† (RefineBox)
            var refineEl = document.getElementById(item.refineId);
            // å¦‚æœæ²¡æ‰¾åˆ° IDï¼Œå°è¯•æ‰¾ input ä¸‹é¢çš„ div (å…¼å®¹æ—§ä»£ç ç”Ÿæˆçš„åŒ¿åæ¡†)
            if (!refineEl) {
                var next = inputEl.nextElementSibling;
                if (next && next.tagName === 'DIV' && next.innerHTML.includes('è®©å®ƒæ”¹')) {
                    refineEl = next;
                }
            }

            // 3. åˆ›å»ºä¸€ä¸ªå¹²å‡€çš„ Wrapperï¼ŒæŠŠè¿™ä¸€å®¶å­éƒ½è£…è¿›å»
            var wrapper = document.createElement('div');
            wrapper.style.marginBottom = "20px"; // å¢åŠ é—´è·ï¼Œå¥½çœ‹ç‚¹
            wrapper.className = "field-group-fixed"; // æ ‡è®°

            // æŒ‰é¡ºåºå¡è¿›å»ï¼šLabel -> Input -> RefineBox
            if (labelEl) wrapper.appendChild(labelEl);
            wrapper.appendChild(inputEl); // æ­¤æ—¶ inputEl å·²ç»è¢«ç§»åŠ¨äº†
            
            // æ˜¾å¼æ˜¾ç¤º Input (é˜²æ­¢ä¹‹å‰è¢«éšè—)
            inputEl.style.display = 'block'; 
            
            if (refineEl) {
                wrapper.appendChild(refineEl);
                refineEl.style.display = 'none'; // é»˜è®¤éšè—ï¼Œç”Ÿæˆåä¼šç”± js æ‰“å¼€
            }

            // 4. å¡å…¥ä¸»å®¹å™¨ (é¡ºåºå°±æ˜¯ config æ•°ç»„çš„é¡ºåº)
            mainContainer.appendChild(wrapper);
        });
        
        console.log("âœ… ç•Œé¢å·²é‡æ’ï¼šè®¾å®š->å¼€åœº->å±•ç¤º (ç¼–è¾‘æ¡†å·²å½’ä½)");
    }
    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿å…ƒç´ å­˜åœ¨
    setTimeout(fixLayoutPerfectly, 800);


    // ================= 2. å†›å¸ˆé€»è¾‘ä¿®æ­£ (å¢åŠ  'desc' ç±»å‹) =================
    // è§£å†³ï¼šæ”¹äººè®¾å»ºè®®è¢«å½’ç±»åˆ°æ­£åˆ™/å±æ€§
    
    // è¦†ç›–åˆ†æå‡½æ•°
    window.analyzeCardNeeds = async function() {
        var name = document.getElementById('cardName').value;
        var desc = document.getElementById('cardDesc').value.trim();
        
        // é—¨æ§›é™ä½
        if (desc.length < 10) { auth.toast('ğŸ“œ è¯·å…ˆå†™ç‚¹äººè®¾ï¼Œå†›å¸ˆæ‰èƒ½åˆ†æå“¦'); return; }

        var box = document.getElementById('aiAdvisorBox');
        if(box) box.style.display = 'flex';
        
        var chat = document.getElementById('advisorChat');
        chat.innerHTML = `<div class="ai-loading" style="color:#999;font-size:12px;text-align:center;padding:20px;">ğŸ§  å†›å¸ˆæ­£åœ¨å®¡é˜…äººè®¾...</div>`;

        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) {
            chat.innerHTML = `<div class="advisor-bubble">âŒ è¯·å…ˆé…ç½® API Keyã€‚</div>`;
            return;
        }

        // ğŸ”¥ Prompt ä¿®æ­£ï¼šæ˜ç¡®å‘Šè¯‰ AI æœ‰ "desc" è¿™ä¸ªç±»å‹
        var prompt = `
        æˆ‘æ˜¯å¡ç‰‡ä½œè€…ã€‚è§’è‰²ï¼š${name}ã€‚
        è®¾å®šï¼š${desc.substring(0, 800)}...
        
        è¯·ä½œä¸ºâ€œåˆ¶ä½œé¡¾é—®â€ï¼Œæå‡º 3 ä¸ªä¿®æ”¹å»ºè®®ã€‚
        
        ğŸ”¥ **åˆ†ç±»è§„åˆ™ (éå¸¸é‡è¦)**ï¼š
        - å¦‚æœæ˜¯ä¿®æ”¹æ€§æ ¼/å¤–è²Œ/èƒŒæ™¯/è¯´è¯æ–¹å¼ -> ç±»å‹å¡« "desc" (è¯¦ç»†è®¾å®š)ã€‚
        - å¦‚æœæ˜¯å¢åŠ ç‰¹æ®Šç³»ç»Ÿ/çŠ¶æ€æ /ç‰¹æ•ˆ -> ç±»å‹å¡« "frontend" (å‰ç«¯) æˆ– "stat" (å±æ€§)ã€‚
        - å¦‚æœæ˜¯å¢åŠ ç‰©å“/åœ°ç‚¹/ç™¾ç§‘ -> ç±»å‹å¡« "world" (ä¸–ç•Œä¹¦)ã€‚
        
        å¿…é¡»è¿”å›çº¯ JSON æ•°ç»„ï¼š
        [
            {
                "type": "desc", 
                "title": "å»ºè®®æ ‡é¢˜", 
                "reason": "ç†ç”±", 
                "prompt": "ä¿®æ”¹æŒ‡ä»¤ (å¦‚: æŠŠæ€§æ ¼æ”¹å¾—æ›´ç—…å¨‡ä¸€ç‚¹)" 
            }
        ]
        `;

        try {
            var res = await fetchAI(prompt, config);
            var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
            var suggestions = JSON.parse(cleanJson);
            
            chat.innerHTML = ''; 
            suggestions.forEach(item => renderSuggestionBubble(item));
            
        } catch(e) { 
            console.error(e);
            chat.innerHTML = `<div class="advisor-bubble">âŒ å†›å¸ˆæ€è·¯ä¹±äº†... (é‡è¯•ä¸€ä¸‹?)</div>`;
        }
    };

    // ================= 3. è·³è½¬é€»è¾‘ä¿®æ­£ (æ”¯æŒ 'desc' ç±»å‹) =================
    // è¦†ç›–è·³è½¬å‡½æ•°
    window.jumpToCreator = function(btn, type, encodedPrompt) {
        if (btn) { btn.innerHTML = "â³ è·³è½¬ä¸­..."; btn.style.opacity = "0.7"; }

        setTimeout(function() {
            try {
                var promptText = decodeURIComponent(encodedPrompt);
                var targetEl = null;

                // --- åˆ†æµå¤„ç† ---
                if (type === 'desc') {
                    // ğŸ”¥ æ–°å¢ï¼šäººè®¾ä¿®æ”¹ -> è·³è½¬é¢„è§ˆé¡µ -> å¡«å…¥ä¿®æ”¹æ¡†
                    if(typeof switchCardTab === 'function') switchCardTab('preview');
                    
                    // è¿˜è¦ç¡®ä¿â€œè¯¦ç»†è®¾å®šâ€çš„ä¿®æ”¹æ¡†æ˜¯æ˜¾ç¤ºå‡ºæ¥çš„
                    // æˆ‘ä»¬ç›´æ¥è°ƒç”¨ refineResult çš„é¢„å¤„ç†é€»è¾‘
                    if(!window.lastGeneratedData) window.lastGeneratedData = {};
                    // å‡è£…å·²ç»ç”Ÿæˆè¿‡äº†ï¼ŒæŠŠå½“å‰å†…å®¹å­˜è¿›å»ï¼Œè§¦å‘ä¿®æ”¹æ¡†æ˜¾ç¤º
                    window.lastGeneratedData.desc = document.getElementById('cardDesc').value;
                    
                    var refineBox = document.getElementById('refineArea_desc');
                    if(refineBox) refineBox.style.display = 'block';
                    
                    targetEl = document.getElementById('refineInput_desc');
                }
                else if (type === 'world') {
                    if(typeof switchCardTab === 'function') switchCardTab('world');
                    targetEl = document.getElementById('aiWorldPrompt');
                } 
                else if (type === 'frontend') {
                    if(typeof switchCardTab === 'function') switchCardTab('regex');
                    // å¼ºå¼€é«˜çº§æ¨¡å¼
                    var ui = document.getElementById('uiFrontendMode');
                    if(ui) ui.style.display = 'block';
                    targetEl = document.getElementById('aiCodePrompt');
                } 
                else if (type === 'stat') {
                    if(typeof switchCardTab === 'function') switchCardTab('stats');
                    targetEl = document.getElementById('aiStatPrompt');
                }

                // --- å¡«å…¥ ---
                if (targetEl) {
                    targetEl.value = promptText;
                    targetEl.focus();
                    targetEl.scrollIntoView({behavior: "smooth", block: "center"});
                    
                    auth.toast('âœ… å»ºè®®å·²å¡«å…¥ï¼Œè¯·ç‚¹å‡»ç”Ÿæˆ/ä¿®æ”¹');
                    if (btn) {
                        btn.innerHTML = "âœ… å·²å¡«å…¥";
                        btn.disabled = true;
                        btn.style.background = "#d4edda";
                        btn.style.color = "#155724";
                    }
                } else {
                    console.error("ç›®æ ‡ä¸¢å¤±:", type);
                    // å°è¯•æš´åŠ›ä¿®æ­£ï¼šå¦‚æœæ˜¯ desc æ‰¾ä¸åˆ°æ¡†ï¼Œå¯èƒ½æ˜¯è¿˜æ²¡æœ‰ç”Ÿæˆè¿‡
                    // æ­¤æ—¶ç›´æ¥å¡«å…¥ prompt ç»™ç”¨æˆ·çœ‹ä¹Ÿè¡Œ
                    if(type === 'desc') alert("è¯·å…ˆç‚¹å‡»ã€ç”Ÿæˆäººè®¾ã€‘æŒ‰é’®ï¼Œç„¶åå†ä½¿ç”¨æ­¤å»ºè®®ä¿®æ”¹ã€‚");
                }

            } catch (e) {
                console.error(e);
                alert("è·³è½¬å¤±è´¥ï¼š" + e.message);
                if (btn) { btn.innerHTML = "âŒ é‡è¯•"; btn.disabled = false; }
            }
        }, 300);
    };

})();

/* ================= ğŸ”§ è¡¥ä¸ V12.0ï¼šç•Œé¢é¡ºåºæœ€ç»ˆä¿®æ­£ç‰ˆ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V12.0ï¼šå¼ºåˆ¶ä¿®å¤å¼€åœºç™½ä½ç½®");

    function fixPosition() {
        var tab = document.getElementById('tab-preview');
        var tabAdvanced = document.getElementById('tab-advanced');
        
        // 1. æ‰¾åˆ°æ ¸å¿ƒå…ƒç´ 
        var elDesc = document.getElementById('cardDesc');       // è¯¦ç»†è®¾å®š
        var elFirst = document.getElementById('cardFirstMes');  // å¼€åœºç™½
        var elExample = document.getElementById('cardMesExample'); // å¯¹è¯æ ·æœ¬
        
        // 2. æ‰¾åˆ°é”šç‚¹ (è“è‰²ç”ŸæˆæŒ‰é’®)
        var anchor = document.getElementById('btnOneClickGen') || document.querySelector('.wizard-box');

        if (!elDesc || !elFirst || !tab) return;

        // --- è¾…åŠ©ï¼šæ‰¾åˆ°å…ƒç´ çš„å…¨å®¶æ¡¶ (Label + Input + ä¿®æ”¹æ¡†) ---
        function getBlock(inputEl) {
            inputEl.style.display = 'block'; // å¼ºåˆ¶æ˜¾ç¤º
            
            // å¾€ä¸Šæ‰¾çˆ¶çº§ (å¦‚æœå·²ç»è¢«ä¹‹å‰çš„è¡¥ä¸åŒ…è¿‡)
            var parent = inputEl.parentNode;
            if (parent.className.includes('wrapper') || parent.className.includes('field-group')) {
                return parent;
            }
            
            // å¦‚æœæ˜¯æ•£è£…çš„ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ç›’å­æŠŠå®ƒä»¬åŒ…èµ·æ¥
            var label = inputEl.previousElementSibling;
            if (label && label.tagName === 'LABEL') {
                var div = document.createElement('div');
                div.style.marginBottom = '20px';
                inputEl.parentNode.insertBefore(div, inputEl);
                div.appendChild(label);
                div.appendChild(inputEl);
                // å¸¦ä¸Šä¿®æ”¹æ¡†
                var next = div.nextElementSibling;
                if (next && next.id && next.id.startsWith('refine')) div.appendChild(next);
                return div;
            }
            return inputEl;
        }

        var blockDesc = getBlock(elDesc);
        var blockFirst = getBlock(elFirst);
        var blockExample = getBlock(elExample);

        // --- å¼€å§‹æ¬è¿ ---

        // 1. æŠŠã€å¯¹è¯æ ·æœ¬ã€‘æ‰”åˆ°é«˜çº§é¡µ
        if (tabAdvanced && blockExample) {
            tabAdvanced.insertBefore(blockExample, tabAdvanced.firstChild);
            var lbl = blockExample.querySelector('label');
            if(lbl) lbl.innerHTML = "ğŸ—£ï¸ å¯¹è¯æ ·æœ¬ (Example) <span style='color:#999;font-size:10px;'>*å·²ç§»è‡³æ­¤å¤„*</span>";
        }

        // 2. è¿™é‡Œçš„é¡ºåºæ˜¯å…³é”®ï¼š
        // å…ˆæŠŠã€è¯¦ç»†è®¾å®šã€‘æ’åˆ°æŒ‰é’®åé¢
        if (anchor && anchor.parentNode === tab) {
            anchor.parentNode.insertBefore(blockDesc, anchor.nextSibling);
        } else {
            tab.insertBefore(blockDesc, tab.firstChild);
        }

        // 3. å†æŠŠã€å¼€åœºç™½ã€‘æ’åˆ°ã€è¯¦ç»†è®¾å®šã€‘åé¢
        if (blockDesc.nextSibling) {
            blockDesc.parentNode.insertBefore(blockFirst, blockDesc.nextSibling);
        } else {
            blockDesc.parentNode.appendChild(blockFirst);
        }

        // 4. ä¿®æ­£æ ‡ç­¾å (å¼ºåˆ¶æ”¹å›æ¥)
        var l1 = blockDesc.querySelector('label');
        if(l1) l1.innerText = "ğŸ“ è¯¦ç»†è®¾å®š (Description)";
        
        var l2 = blockFirst.querySelector('label');
        if(l2) l2.innerText = "ğŸ’¬ å¼€åœºç™½ (First Message)";
        
        console.log("âœ… é¡ºåºå·²é”å®šï¼šè®¾å®š -> å¼€åœºç™½");
    }

    // å»¶è¿Ÿ 1ç§’ æ‰§è¡Œ
    setTimeout(fixPosition, 1000);
})();

/* ================= ğŸš‘ è¡¥ä¸ V13.0ï¼šå†›å¸ˆä¸“ä¸šæ¨¡å¼ç»ˆæä¿®å¤ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V13.0ï¼šä¿®å¤å†›å¸ˆæŒ‰é’®å¤±æ•ˆ & åŒæ­¥äºŒæ¬¡ç¼–è¾‘ç¼“å­˜");

    // 1. é‡å†™åº”ç”¨ä¿®æ”¹å‡½æ•° (ä¿®å¤æŒ‰é’®æ— ååº” + åŒæ­¥ç¼“å­˜)
    window.applyGodFix = function(targetId, encodedContent, btn) {
        try {
            var el = document.getElementById(targetId);
            if (!el) {
                alert("âŒ å†›å¸ˆçœ¼èŠ±äº†ï¼Œæ‰¾ä¸åˆ° ID ä¸º " + targetId + " çš„è¾“å…¥æ¡†");
                return;
            }

            // A. è§£ç å†…å®¹
            var newContent = decodeURIComponent(encodedContent);
            el.value = newContent;

            // B. è§¦å‘ç•Œé¢åŒæ­¥
            // å¦‚æœæ˜¯å±æ€§é¡µï¼ŒåŒæ­¥åˆ°æ·±åº¦è®¾å®š
            if(typeof syncStatToNote === 'function') syncStatToNote();
            // å¦‚æœæ˜¯å‰ç«¯é¡µï¼Œç«‹å³é¢„è§ˆ
            if(targetId === 'frontReplace' && typeof runRegexTest === 'function') runRegexTest();
            // å¦‚æœæ˜¯é¢„è§ˆé¡µï¼Œæ›´æ–°æ‰‹æœºé¢„è§ˆ
            if((targetId === 'cardDesc' || targetId === 'cardFirstMes') && typeof updatePreviewUI === 'function') updatePreviewUI();

            // C. ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæ›´æ–°â€œäºŒæ¬¡ç¼–è¾‘â€çš„ç¼“å­˜
            // è¿™æ ·ä½ ç‚¹å®Œåº”ç”¨åï¼Œå†ç‚¹â€œè®©å®ƒæ”¹â€ï¼ŒAI å°±ä¼šåŸºäºæ–°å†…å®¹ä¿®æ”¹ï¼Œè€Œä¸æ˜¯æ—§å†…å®¹
            if (!window.lastGeneratedData) window.lastGeneratedData = {};
            
            if (targetId === 'cardDesc') window.lastGeneratedData.desc = newContent;
            else if (targetId === 'cardFirstMes') window.lastGeneratedData.firstMes = newContent;
            else if (targetId === 'frontReplace') {
                // å‰ç«¯ä»£ç æ¯”è¾ƒç‰¹æ®Šï¼Œéœ€è¦ä¿ç•™ä¹‹å‰çš„ç»“æ„
                if (!window.lastGeneratedData.frontend) window.lastGeneratedData.frontend = { name: "AIä¿®æ”¹ç‰ˆ", regex: "/\\[.*\\]/g" };
                window.lastGeneratedData.frontend.code = newContent;
            }
            else if (targetId === 'wiContent') {
                if (!window.lastGeneratedData.world) window.lastGeneratedData.world = { comment: "AIä¿®æ”¹ç‰ˆ", keys: [] };
                window.lastGeneratedData.world.content = newContent;
            }
            else if (targetId === 'statEditor') {
                if (!window.lastGeneratedData.stat) window.lastGeneratedData.stat = {};
                window.lastGeneratedData.stat.raw = newContent; 
                // åŒæ—¶ä¹Ÿè§†ä¸º script æ›´æ–°
                window.lastGeneratedData.stat.script = newContent;
            }

            // D. æŒ‰é’®çŠ¶æ€åé¦ˆ
            if (btn) {
                btn.innerHTML = "âœ… ä¿®æ”¹å·²åº”ç”¨ (ç¼“å­˜å·²åŒæ­¥)";
                btn.disabled = true;
                btn.style.background = "#d4edda";
                btn.style.color = "#155724";
                btn.style.border = "1px solid #c3e6cb";
            }

            // å¦‚æœæœ‰ toast ç³»ç»Ÿ
            if (typeof auth !== 'undefined' && auth.toast) auth.toast('âœ¨ å†…å®¹å·²æ›´æ–°ï¼ŒäºŒæ¬¡ç¼–è¾‘å·²å°±ç»ªï¼');

        } catch (e) {
            console.error(e);
            alert("åº”ç”¨å¤±è´¥ï¼š" + e.message);
        }
    };

    // 2. è¦†ç›–å†›å¸ˆé€»è¾‘ (ä¿®å¤å•å¼•å·å¡æ­»é—®é¢˜)
    // æˆ‘ä»¬å¿…é¡»é‡å†™ runGodModeLogicï¼Œä½†å› ä¸ºå®ƒåœ¨é—­åŒ…é‡Œï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡è¦†ç›– sendAdvisorMsg æ¥é—´æ¥æ›¿æ¢
    
    // è¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå…¨å±€çš„ä¸“ä¸šæ¨¡å¼é€»è¾‘
    window.runGodModeLogicGlobal = async function(userText, loadingId) {
        var context = getGodContextGlobal(); 
        var contextStr = context ? context.content.substring(0, 3000) : "(æ— æ³•è¯»å–å†…å®¹)";
        var contextName = context ? context.targetName : "æœªçŸ¥åŒºåŸŸ";

        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) throw new Error("è¯·å…ˆé…ç½® API Key");

        var prompt = `
        ä½ ç°åœ¨æ˜¯ï¼šä»£ç /æ–‡æœ¬ä¿®æ”¹ä¸“å®¶ï¼ˆä¸“ä¸šæ¨¡å¼ï¼‰ã€‚
        ç”¨æˆ·å½“å‰åœç•™åœ¨ï¼šã€${contextName}ã€‘ã€‚
        
        ã€å½“å‰å†…å®¹ã€‘ï¼š
        \`\`\`
        ${contextStr}
        \`\`\`
        
        ç”¨æˆ·æŒ‡ä»¤ï¼šâ€œ${userText}â€
        
        ğŸ”¥ **æ ¸å¿ƒæŒ‡ä»¤**ï¼š
        1. å¦‚æœéœ€è¦ä¿®æ”¹ï¼Œè¯·è¾“å‡ºä¿®æ”¹åçš„**å®Œæ•´å†…å®¹**ã€‚
        2. å¿…é¡»å°†æ–°å†…å®¹åŒ…è£¹åœ¨ XML æ ‡ç­¾ä¸­ï¼š
           <FIX_TARGET id="${context ? context.targetId : 'cardDesc'}">
           è¿™é‡Œæ”¾ä¿®æ”¹åçš„å†…å®¹...
           </FIX_TARGET>
        `;

        const response = await fetch(`${config.apiUrl}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [{ role: "user", content: prompt }]
            })
        });

        document.getElementById(loadingId).remove();
        const data = await response.json();
        var resText = data.choices[0].message.content;
        var chat = document.getElementById('advisorChat');

        // è§£æ XML æ ‡ç­¾
        var fixMatch = /<FIX_TARGET id="([^"]+)">([\s\S]*?)<\/FIX_TARGET>/i.exec(resText);
        
        if (fixMatch) {
            var targetId = fixMatch[1];
            var newContent = fixMatch[2].trim();
            var replyDisplay = resText.replace(fixMatch[0], '\n\nâœ… (ä¿®æ”¹æ–¹æ¡ˆå·²ç”Ÿæˆ)');
            
            // ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒä¿®å¤ç‚¹ï¼šå¼ºåˆ¶è½¬ä¹‰å•å¼•å·ï¼Œé˜²æ­¢ HTML å±æ€§æˆªæ–­ ğŸ”¥ğŸ”¥ğŸ”¥
            var safeContent = encodeURIComponent(newContent).replace(/'/g, "%27");

            var actionHtml = `
                <div style="margin-top:8px; border-top:1px dashed #ddd; padding-top:5px;">
                    <button class="advisor-action-btn" onclick="window.applyGodFix('${targetId}', '${safeContent}', this)">
                        ğŸ‘‰ ç‚¹å‡»æ›¿æ¢ã€${targetId}ã€‘çš„å†…å®¹
                    </button>
                </div>
            `;
            // æ‰‹åŠ¨æ·»åŠ æ°”æ³¡
            var div = document.createElement('div');
            div.className = 'advisor-bubble';
            div.innerHTML = replyDisplay.replace(/\n/g, '<br>') + actionHtml;
            chat.appendChild(div);
        } else {
            // æ™®é€šå›å¤
            var div = document.createElement('div');
            div.className = 'advisor-bubble';
            div.innerHTML = resText.replace(/\n/g, '<br>');
            chat.appendChild(div);
        }
        chat.scrollTop = chat.scrollHeight;
    };

    // è¾…åŠ©ï¼šè·å–ä¸Šä¸‹æ–‡ (å…¨å±€ç‰ˆ)
    function getGodContextGlobal() {
        const GOD_VIEW_MAP = {
            'tab-preview':  { id: 'cardDesc',     name: 'è¯¦ç»†è®¾å®š' },
            'tab-regex':    { id: 'frontReplace', name: 'å‰ç«¯ä»£ç ' },
            'tab-world':    { id: 'wiContent',    name: 'ä¸–ç•Œä¹¦å†…å®¹' },
            'tab-stats':    { id: 'statEditor',   name: 'å±æ€§é€»è¾‘' },
            'tab-advanced': { id: 'cardNote',     name: 'æ·±åº¦è®¾å®š' },
            'tab-source':   { id: 'jsonSource',   name: 'å®Œæ•´æºç ' }
        };
        var activeTab = null;
        document.querySelectorAll('.card-tab-content').forEach(el => {
            if (el.style.display === 'block' || getComputedStyle(el).display === 'block') activeTab = el.id;
        });
        
        // é¢„è§ˆé¡µç‰¹æ®Šé€»è¾‘
        if (activeTab === 'tab-preview') {
            return { targetId: 'cardDesc', targetName: 'è¯¦ç»†è®¾å®š', content: document.getElementById('cardDesc').value };
        }

        var info = GOD_VIEW_MAP[activeTab];
        if (info) {
            var el = document.getElementById(info.id);
            return { targetId: info.id, targetName: info.name, content: el ? el.value : "" };
        }
        return null;
    }

    // 3. æ‹¦æˆª sendAdvisorMsgï¼Œå°†ä¸“ä¸šæ¨¡å¼å¯¼å‘æ–°é€»è¾‘
    var _oldSend = window.sendAdvisorMsg;
    window.sendAdvisorMsg = async function() {
        if (window.advisorMode === 'pro') {
            var input = document.getElementById('advisorInput');
            var text = input.value.trim();
            if(!text) return;
            
            // ç”¨æˆ·æ¶ˆæ¯ä¸Šå±
            var chat = document.getElementById('advisorChat');
            chat.innerHTML += `<div style="text-align:right; margin:5px 0; color:#6c5ce7; font-size:12px; padding:5px; background:#f0f0f0; border-radius:8px; display:inline-block; margin-left:auto;">${text}</div><div style="clear:both;"></div>`;
            input.value = '';
            
            var loadingId = 'loading-' + Date.now();
            chat.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-loading" style="font-size:10px;color:#999;text-align:center;">ğŸ§  ä¸“ä¸šæ¨¡å¼æ€è€ƒä¸­...</div>`);
            chat.scrollTop = chat.scrollHeight;

            try {
                // è°ƒç”¨ä¿®å¤åçš„é€»è¾‘
                await window.runGodModeLogicGlobal(text, loadingId);
            } catch (e) {
                document.getElementById(loadingId).remove();
                chat.innerHTML += `<div class="advisor-bubble">âŒ é”™è¯¯ï¼š${e.message}</div>`;
            }
        } else {
            // æ™®é€šæ¨¡å¼èµ°æ—§é€»è¾‘
            if(_oldSend) _oldSend();
        }
    };

    console.log("âœ… ä¸“ä¸šæ¨¡å¼ä¿®å¤å®Œæˆï¼šæŒ‰é’®ç‚¹å‡»å·²æ¢å¤ï¼Œç¼“å­˜å·²åŒæ­¥");
})();

/* ================= ğŸš‘ è¡¥ä¸ V13.1ï¼šä¿®å¤æ— æ³•é€€å‡º & æŒ‰é’®å¤±æ•ˆ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V13.1ï¼šä¿®å¤æ­»å¾ªç¯ä¸ç‚¹å‡»å¤±æ•ˆé—®é¢˜");

    // 1. å»ºç«‹å…¨å±€ä¿®æ”¹ç¼“å­˜ (è§£å†³æŒ‰é’®ç‚¹ä¸åŠ¨çš„é—®é¢˜)
    // æˆ‘ä»¬ä¸å†æŠŠä»£ç å¡è¿› HTML onclick é‡Œï¼Œè€Œæ˜¯å­˜åœ¨è¿™é‡Œ
    window.godModeCache = {}; 

    // 2. é‡å†™åº”ç”¨å‡½æ•° (ä»ç¼“å­˜è¯»å–)
    window.applyGodFixFromCache = function(cacheId, targetId, btn) {
        try {
            // A. ä»ç¼“å­˜è·å–å†…å®¹
            var newContent = window.godModeCache[cacheId];
            if (newContent === undefined) {
                alert("âŒ ç¼“å­˜å·²è¿‡æœŸï¼Œè¯·é‡æ–°è®©å†›å¸ˆç”Ÿæˆå»ºè®®");
                return;
            }

            // B. æ‰¾åˆ°è¾“å…¥æ¡†
            var el = document.getElementById(targetId);
            if (!el) {
                alert("âŒ æ‰¾ä¸åˆ°ç›®æ ‡è¾“å…¥æ¡† ID: " + targetId);
                return;
            }

            // C. å†™å…¥å†…å®¹
            el.value = newContent;

            // D. åŒæ­¥ä¸é¢„è§ˆ
            if(typeof syncStatToNote === 'function') syncStatToNote();
            if(targetId === 'frontReplace' && typeof runRegexTest === 'function') runRegexTest();
            if((targetId === 'cardDesc' || targetId === 'cardFirstMes') && typeof updatePreviewUI === 'function') updatePreviewUI();

            // E. åŒæ­¥äºŒæ¬¡ç¼–è¾‘ç¼“å­˜ (ç¡®ä¿"è®©å®ƒæ”¹"èƒ½åŸºäºæ–°å†…å®¹)
            if (!window.lastGeneratedData) window.lastGeneratedData = {};
            
            if (targetId === 'cardDesc') window.lastGeneratedData.desc = newContent;
            else if (targetId === 'cardFirstMes') window.lastGeneratedData.firstMes = newContent;
            else if (targetId === 'frontReplace') {
                if (!window.lastGeneratedData.frontend) window.lastGeneratedData.frontend = { name: "AIä¿®æ”¹", regex: "/\\[.*\\]/g" };
                window.lastGeneratedData.frontend.code = newContent;
            }
            else if (targetId === 'statEditor') {
                if (!window.lastGeneratedData.stat) window.lastGeneratedData.stat = {};
                window.lastGeneratedData.stat.script = newContent;
                window.lastGeneratedData.stat.raw = newContent;
            }
            else if (targetId === 'wiContent') {
                if (!window.lastGeneratedData.world) window.lastGeneratedData.world = { comment: "AIä¿®æ”¹", keys: [] };
                window.lastGeneratedData.world.content = newContent;
            }

            // F. æŒ‰é’®å˜è‰²åé¦ˆ
            if (btn) {
                btn.innerHTML = "âœ… ä¿®æ”¹å·²åº”ç”¨";
                btn.disabled = true;
                btn.style.background = "#d4edda";
                btn.style.color = "#155724";
                btn.style.border = "1px solid #c3e6cb";
            }
            
            // æç¤ºæˆåŠŸ
            if(window.auth && window.auth.toast) auth.toast('âœ¨ ä¿®æ”¹æˆåŠŸï¼æ­£åˆ™/é¢„è§ˆå·²åŒæ­¥');

        } catch (e) {
            console.error(e);
            alert("åº”ç”¨å‡ºé”™ï¼š" + e.message);
        }
    };

    // 3. è¦†ç›–å†›å¸ˆé€»è¾‘ (è§£å†³æ— æ³•é€€å‡ºé—®é¢˜)
    
    // å¤‡ä»½æ—§çš„å‘é€é€»è¾‘ (V6.0/V13.0)
    var _previousSend = window.sendAdvisorMsg;

    // è¾…åŠ©ï¼šæ›´æ–°è¾“å…¥æ¡†æ ·å¼
    function updateAdvisorUI(mode) {
        var input = document.getElementById('advisorInput');
        var chat = document.getElementById('advisorChat');
        if (!input || !chat) return;

        if (mode === 'pro') {
            input.placeholder = "ğŸ”´ ä¸“ä¸šæ¨¡å¼ï¼šè¾“å…¥æŒ‡ä»¤ä¿®æ”¹ä»£ç  (è¾“å…¥'é€€å‡º'è¿”å›)";
            input.style.border = "2px solid #e17055"; 
            chat.innerHTML += `<div class="advisor-bubble" style="background:#fff0f0; color:#c0392b; font-size:12px;">ğŸ”´ <b>ç³»ç»Ÿï¼š</b>å·²è¿›å…¥ä¸“ä¸šæ¨¡å¼ã€‚<br>è¾“å…¥ "é€€å‡º" æˆ– "å…³é—­" è¿”å›æ™®é€šæ¨¡å¼ã€‚</div>`;
        } else {
            input.placeholder = "ğŸŸ¢ æ™®é€šæ¨¡å¼ï¼šå’Œå†›å¸ˆèŠèŠäººè®¾...";
            input.style.border = "2px solid #6c5ce7"; 
            chat.innerHTML += `<div class="advisor-bubble" style="background:#f3f0ff; color:#6c5ce7; font-size:12px;">ğŸŸ¢ <b>ç³»ç»Ÿï¼š</b>å·²å›åˆ°æ™®é€šæ¨¡å¼ã€‚</div>`;
        }
        chat.scrollTop = chat.scrollHeight;
    }

    // ğŸ”¥ æ–°çš„å‘é€å‡½æ•°
    window.sendAdvisorMsg = async function() {
        var input = document.getElementById('advisorInput');
        var text = input.value.trim();
        if (!text) return;

        // --- A. ä¼˜å…ˆæ‹¦æˆªï¼šæ¨¡å¼åˆ‡æ¢å‘½ä»¤ ---
        if (text === "é€€å‡º" || text === "å…³é—­" || text === "æ™®é€šæ¨¡å¼") {
            window.advisorMode = 'normal';
            updateAdvisorUI('normal');
            input.value = '';
            return; // æ‹¦æˆªæˆåŠŸï¼Œä¸å†å‘ç»™AI
        }

        if (text === "ä¸“ä¸šæ¨¡å¼" || text === "å¼€å¯ä¸“ä¸šæ¨¡å¼") {
            window.advisorMode = 'pro';
            updateAdvisorUI('pro');
            input.value = '';
            return;
        }

        // --- B. åˆ†æµå¤„ç† ---
        if (window.advisorMode === 'pro') {
            // === ä¸“ä¸šæ¨¡å¼é€»è¾‘ (ä¿®å¤ç‰ˆ) ===
            
            // 1. ç”¨æˆ·æ°”æ³¡ä¸Šå±
            var chat = document.getElementById('advisorChat');
            chat.innerHTML += `<div style="text-align:right; margin:5px 0; color:#6c5ce7; font-size:12px; padding:5px; background:#f0f0f0; border-radius:8px; display:inline-block; margin-left:auto;">${text}</div><div style="clear:both;"></div>`;
            input.value = '';

            // 2. æ˜¾ç¤º Loading
            var loadingId = 'loading-' + Date.now();
            chat.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-loading" style="font-size:10px;color:#999;text-align:center;">ğŸ§  ä¸“ä¸šæ¨¡å¼æ€è€ƒä¸­...</div>`);
            chat.scrollTop = chat.scrollHeight;

            // 3. æ‰§è¡Œè¯·æ±‚ (è¿™é‡Œæˆ‘ä»¬ç›´æ¥å†…è”ä¿®å¤åçš„é€»è¾‘ï¼Œä¸ä¾èµ–å¤–éƒ¨å‡½æ•°ï¼Œé˜²æ­¢ç‰ˆæœ¬å†²çª)
            try {
                // è·å–ä¸Šä¸‹æ–‡
                var contextData = null;
                if(typeof getGodContextGlobal === 'function') contextData = getGodContextGlobal(); 
                // å¦‚æœ V13.0 çš„å‡½æ•°æ²¡åŠ è½½ï¼Œå°è¯•ç®€æ˜“è·å–
                else {
                    var desc = document.getElementById('cardDesc').value;
                    contextData = { targetId: 'cardDesc', targetName: 'è¯¦ç»†è®¾å®š', content: desc };
                }

                var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
                if (!config || !config.apiKey) throw new Error("è¯·é…ç½® API Key");

                var prompt = `
                ä½ ç°åœ¨æ˜¯ï¼šä»£ç ä¿®æ”¹ä¸“å®¶ï¼ˆä¸“ä¸šæ¨¡å¼ï¼‰ã€‚
                å½“å‰æ­£åœ¨ç¼–è¾‘ï¼šã€${contextData.targetName}ã€‘
                
                å½“å‰å†…å®¹ï¼š
                \`\`\`
                ${contextData.content.substring(0, 3000)}
                \`\`\`
                
                ç”¨æˆ·æŒ‡ä»¤ï¼šâ€œ${text}â€
                
                ğŸ”¥ **æŒ‡ä»¤**ï¼š
                1. å¦‚æœéœ€è¦ä¿®æ”¹ï¼Œè¯·è¾“å‡ºä¿®æ”¹åçš„**å®Œæ•´å†…å®¹**ã€‚
                2. å¿…é¡»åŒ…è£¹åœ¨ XML æ ‡ç­¾ä¸­ï¼š
                   <FIX_TARGET id="${contextData.targetId}">
                   è¿™é‡Œæ”¾ä¿®æ”¹åçš„å†…å®¹...
                   </FIX_TARGET>
                `;

                const response = await fetch(`${config.apiUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
                    body: JSON.stringify({
                        model: config.model || 'gpt-3.5-turbo',
                        messages: [{ role: "user", content: prompt }]
                    })
                });

                document.getElementById(loadingId).remove();
                const data = await response.json();
                var resText = data.choices[0].message.content;

                // è§£æå›å¤
                var fixMatch = /<FIX_TARGET id="([^"]+)">([\s\S]*?)<\/FIX_TARGET>/i.exec(resText);
                
                if (fixMatch) {
                    var targetId = fixMatch[1];
                    var newContent = fixMatch[2].trim();
                    var replyDisplay = resText.replace(fixMatch[0], '\n\nâœ… (ä¿®æ”¹æ–¹æ¡ˆå·²ç”Ÿæˆ)');
                    
                    // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå­˜å…¥ç¼“å­˜ï¼Œè€Œä¸æ˜¯æ‹¼æ¥åˆ° HTML é‡Œ
                    var cacheId = "fix_" + Date.now();
                    window.godModeCache[cacheId] = newContent;

                    var actionHtml = `
                        <div style="margin-top:8px; border-top:1px dashed #ddd; padding-top:5px;">
                            <button class="advisor-action-btn" onclick="window.applyGodFixFromCache('${cacheId}', '${targetId}', this)">
                                ğŸ‘‰ ç‚¹å‡»åº”ç”¨ä¿®æ”¹
                            </button>
                        </div>
                    `;
                    chat.innerHTML += `<div class="advisor-bubble">${replyDisplay.replace(/\n/g, '<br>')}${actionHtml}</div>`;
                } else {
                    chat.innerHTML += `<div class="advisor-bubble">${resText.replace(/\n/g, '<br>')}</div>`;
                }
                chat.scrollTop = chat.scrollHeight;

            } catch(e) {
                document.getElementById(loadingId)?.remove();
                chat.innerHTML += `<div class="advisor-bubble">âŒ é”™è¯¯ï¼š${e.message}</div>`;
            }

        } else {
            // === æ™®é€šæ¨¡å¼ ===
            // è°ƒç”¨æ—§ç‰ˆæœ¬çš„é€»è¾‘ (V6.0/V13.0 çš„ else åˆ†æ”¯)
            if (_previousSend) {
                _previousSend();
            }
        }
    };

    console.log("âœ… V13.1ï¼šä¿®å¤å®Œæ¯•ï¼Œç°åœ¨å¯ä»¥è‡ªç”±è¿›å‡ºä¸“ä¸šæ¨¡å¼äº†ï¼");

})();

/* ================= ğŸ’¾ V16.0 å…¨å±€å¿«ç…§å­˜æ¡£ç³»ç»Ÿ (ä¿®å¤ç‰ˆ) ================= */
(function() {
    console.log("ğŸš€ V16.0 å­˜æ¡£ç³»ç»Ÿå·²åŠ è½½ï¼šæ­£åœ¨è¦†ç›–æ—§é€»è¾‘...");

    // 1. ğŸ“‚ æ‰“å¼€/å…³é—­ æ¡£æ¡ˆå®¤
    window.openSaveManager = function() {
        var modal = document.getElementById('saveManagerModal');
        if (modal) {
            modal.style.display = 'flex';
            renderSaveList(); // æ‰“å¼€æ—¶åˆ·æ–°åˆ—è¡¨
        } else {
            alert("âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°å­˜æ¡£å¼¹çª— (id='saveManagerModal')");
        }
    };

    // 2. ğŸ’¾ æ–°å»ºå­˜æ¡£ (æš´åŠ›æŠ“å–æ‰€æœ‰æ•°æ®)
    window.createNewSave = function() {
        // è¾…åŠ©ï¼šå®‰å…¨è·å–è¾“å…¥æ¡†çš„å€¼
        function getVal(id) { 
            var el = document.getElementById(id); 
            return el ? el.value : ""; 
        }

        var name = getVal('cardName').trim() || "æœªå‘½åå·¥ç¨‹";
        var timeStr = new Date().toLocaleString();

        // ğŸ”¥ æ ¸å¿ƒï¼šæ‰“åŒ…æ‰€æœ‰ä¸œè¥¿
        var snapshot = {
            id: Date.now(),
            title: name,
            timestamp: timeStr,
            
            // A. æ‰€æœ‰çš„è¾“å…¥æ¡†å†…å®¹
            inputs: {
                cardName: getVal('cardName'),
                cardDesc: getVal('cardDesc'),
                cardFirstMes: getVal('cardFirstMes'),
                cardMesExample: getVal('cardMesExample'),
                cardScenario: getVal('cardScenario'),
                cardNote: getVal('cardNote'),
                statEditor: getVal('statEditor'), // å±æ€§é¡µä»£ç 
                
                // ä¹Ÿè¦ä¿å­˜é‚£äº›æ­£åœ¨ç¼–è¾‘ä½†è¿˜æ²¡ç”Ÿæˆçš„â€œè‰ç¨¿â€
                aiCodePrompt: getVal('aiCodePrompt'),
                aiWorldPrompt: getVal('aiWorldPrompt'),
                frontPattern: getVal('frontPattern'),
                frontReplace: getVal('frontReplace'),
                wiComment: getVal('wiComment'),
                wiKeys: getVal('wiKeys'),
                wiContent: getVal('wiContent')
            },

            // B. æ‰€æœ‰çš„å…¨å±€å˜é‡ (æ·±æ‹·è´ï¼Œé˜²æ­¢å¼•ç”¨å…³è”)
            globals: {
                worldInfo: JSON.parse(JSON.stringify(window.currentWorldInfo || { entries: [] })),
                regexScripts: JSON.parse(JSON.stringify(window.currentCardRegexes || [])),
                selectedTags: JSON.parse(JSON.stringify(window.currentSelectedTags || { identity:[], personality:[], trope:[] })),
                advisorMode: window.advisorMode || 'normal'
            },

            // C. å†›å¸ˆçš„èŠå¤©è®°å½• (ç›´æ¥å­˜ HTML)
            advisorChatHTML: document.getElementById('advisorChat') ? document.getElementById('advisorChat').innerHTML : ""
        };

        // ä¿å­˜åˆ° localStorage
        try {
            var saves = JSON.parse(localStorage.getItem('my_creator_saves') || "[]");
            
            // æ£€æŸ¥åŒåè¦†ç›–
            var existIdx = saves.findIndex(s => s.title === name);
            if (existIdx !== -1) {
                if (!confirm(`å­˜æ¡£ã€${name}ã€‘å·²å­˜åœ¨ï¼Œè¦è¦†ç›–å—ï¼Ÿ`)) return;
                saves[existIdx] = snapshot; // è¦†ç›–
            } else {
                saves.unshift(snapshot); // åŠ åˆ°æœ€å‰
            }

            localStorage.setItem('my_creator_saves', JSON.stringify(saves));
            
            // åˆ·æ–°åˆ—è¡¨ & æç¤º
            renderSaveList();
            if (window.auth && window.auth.toast) auth.toast('ğŸ’¾ å…¨å±€å¿«ç…§å·²ä¿å­˜ï¼');
            else alert('ğŸ’¾ ä¿å­˜æˆåŠŸï¼');

        } catch (e) {
            console.error(e);
            alert("âŒ ä¿å­˜å¤±è´¥ (å¯èƒ½æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³)ï¼š" + e.message);
        }
    };

    // 3. ğŸ“– è¯»å–å­˜æ¡£ (å®Œç¾è¿˜åŸç°åœº)
    window.loadSave = function(index) {
        if (!confirm('âš ï¸ è¯»å–å­˜æ¡£å°†è¦†ç›–å½“å‰æ‰€æœ‰è¿›åº¦ï¼Œç¡®å®šå—ï¼Ÿ')) return;

        try {
            var saves = JSON.parse(localStorage.getItem('my_creator_saves') || "[]");
            var data = saves[index];
            if (!data) throw new Error("å­˜æ¡£æŸåæˆ–ä¸¢å¤±");

            // A. æ¢å¤è¾“å…¥æ¡†
            function setVal(id, val) {
                var el = document.getElementById(id);
                if (el) el.value = val || "";
            }
            
            // å¾ªç¯æ¢å¤ inputs å¯¹è±¡é‡Œçš„æ‰€æœ‰å€¼
            for (var key in data.inputs) {
                setVal(key, data.inputs[key]);
            }

            // B. æ¢å¤å…¨å±€å˜é‡
            window.currentWorldInfo = data.globals.worldInfo || { entries: [] };
            window.currentCardRegexes = data.globals.regexScripts || [];
            window.currentSelectedTags = data.globals.selectedTags || { identity:[], personality:[], trope:[] };
            window.advisorMode = data.globals.advisorMode || 'normal';

            // C. æ¢å¤å†›å¸ˆèŠå¤©
            var chatBox = document.getElementById('advisorChat');
            if (chatBox) chatBox.innerHTML = data.advisorChatHTML || "";

            // D. ğŸ”¥ å…³é”®ï¼šåˆ·æ–° UI æ˜¾ç¤º (ä¸ç„¶å˜é‡å˜äº†ç•Œé¢æ²¡å˜)
            if (typeof renderWizardTags === 'function') renderWizardTags(); // åˆ·æ–°æ ‡ç­¾é«˜äº®
            if (typeof renderWorldList === 'function') renderWorldList();   // åˆ·æ–°ä¸–ç•Œä¹¦åˆ—è¡¨
            if (typeof renderRegexList === 'function') renderRegexList();   // åˆ·æ–°æ­£åˆ™åˆ—è¡¨
            if (typeof updatePreviewUI === 'function') updatePreviewUI();   // åˆ·æ–°æ‰‹æœºé¢„è§ˆ
            
            // æ¢å¤å†›å¸ˆè¾“å…¥æ¡†æ ·å¼
            var advInput = document.getElementById('advisorInput');
            if (advInput) {
                if (window.advisorMode === 'pro') {
                    advInput.style.border = "2px solid #e17055";
                    advInput.placeholder = "ğŸ”´ ä¸“ä¸šæ¨¡å¼...";
                } else {
                    advInput.style.border = "2px solid #6c5ce7";
                    advInput.placeholder = "ğŸŸ¢ æ™®é€šæ¨¡å¼...";
                }
            }

            // å…³é—­çª—å£å¹¶æç¤º
            document.getElementById('saveManagerModal').style.display = 'none';
            if (window.auth && window.auth.toast) auth.toast('ğŸ“‚ ç°åœºè¿˜åŸæˆåŠŸï¼');

        } catch (e) {
            console.error(e);
            alert("âŒ è¯»å–å¤±è´¥ï¼š" + e.message);
        }
    };

    // 4. ğŸ“œ æ¸²æŸ“å­˜æ¡£åˆ—è¡¨
    window.renderSaveList = function() {
        var list = document.getElementById('saveSlotList');
        if (!list) return;
        
        var saves = JSON.parse(localStorage.getItem('my_creator_saves') || "[]");
        list.innerHTML = "";

        if (saves.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— å­˜æ¡£</div>';
            return;
        }

        saves.forEach((save, idx) => {
            var div = document.createElement('div');
            div.style.cssText = "background:#fff; border:1px solid #ddd; margin-bottom:10px; padding:10px; border-radius:8px; cursor:pointer; position:relative; transition:0.2s;";
            div.onmouseover = function() { this.style.borderColor = '#0288d1'; };
            div.onmouseout = function() { this.style.borderColor = '#ddd'; };
            
            div.innerHTML = `
                <div style="font-weight:bold; color:#333;">${save.title}</div>
                <div style="font-size:10px; color:#999;">ğŸ“… ${save.timestamp}</div>
                <div style="font-size:10px; color:#aaa; margin-top:5px;">
                    åŒ…å«ï¼šä¸–ç•Œä¹¦(${save.globals?.worldInfo?.entries?.length || 0}) 
                    æ­£åˆ™(${save.globals?.regexScripts?.length || 0}) 
                    æ ‡ç­¾(${Object.values(save.globals?.selectedTags || {}).flat().length})
                </div>
                <button onclick="event.stopPropagation(); deleteSave(${idx})" style="position:absolute; right:10px; top:10px; border:none; background:none; color:#e74c3c; cursor:pointer; font-size:14px; padding:5px;">ğŸ—‘ï¸</button>
            `;
            
            div.onclick = function() { loadSave(idx); };
            list.appendChild(div);
        });
    };

    // 5. ğŸ—‘ï¸ åˆ é™¤å­˜æ¡£
    window.deleteSave = function(index) {
        if (!confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªå­˜æ¡£å—ï¼Ÿ")) return;
        var saves = JSON.parse(localStorage.getItem('my_creator_saves') || "[]");
        saves.splice(index, 1);
        localStorage.setItem('my_creator_saves', JSON.stringify(saves));
        renderSaveList();
    };

    console.log("âœ… V16.0 å­˜æ¡£ç³»ç»Ÿå°±ç»ªï¼šå·²æ¥ç®¡ä¿å­˜/è¯»å–é€»è¾‘");

})();

/* ================= ğŸ”§ V17.0 è¡¥ä¸ï¼šç”Ÿæˆå™¨å¼ºåŠ›çº é”™ (è§£å†³å‡å¤±è´¥) ================= */
(function() {
    console.log("ğŸš€ V17.0ï¼šJSON è§£æå¢å¼ºå·²ä¸Šçº¿");

    // 1. ğŸ› ï¸ å¼ºåŠ› JSON æå–å™¨ (èƒ½è¿‡æ»¤æ‰ AI çš„æ‰€æœ‰åºŸè¯)
    function safeExtractJSON(str) {
        try {
            // ç¬¬ä¸€æ­¥ï¼šå°è¯•ç›´æ¥è§£æ
            return JSON.parse(str);
        } catch (e) {
            // ç¬¬äºŒæ­¥ï¼šæ­£åˆ™æå–æœ€å¤–å±‚çš„ {...}
            var match = str.match(/\{[\s\S]*\}/);
            if (match) {
                try {
                    return JSON.parse(match[0]);
                } catch (e2) {
                    // ç¬¬ä¸‰æ­¥ï¼šå¦‚æœè¿˜ä¸è¡Œï¼Œå°è¯•æ¸…ç†å¸¸è§çš„ Markdown ç¬¦å·
                    var clean = match[0].replace(/\\n/g, "\\n")  
                                        .replace(/\\'/g, "\\'")
                                        .replace(/\\"/g, '\\"')
                                        .replace(/\\&/g, "\\&")
                                        .replace(/\\r/g, "\\r")
                                        .replace(/\\t/g, "\\t")
                                        .replace(/\\b/g, "\\b")
                                        .replace(/\\f/g, "\\f");
                    // ç§»é™¤ä¸å¯è§å­—ç¬¦
                    clean = clean.replace(/[\u0000-\u0019]+/g,""); 
                    return JSON.parse(clean);
                }
            }
            throw new Error("æ— æ³•ä»å›å¤ä¸­æå–æœ‰æ•ˆ JSON");
        }
    }

    // 2. âš¡ï¸ è¦†ç›–ï¼šä¸€é”®ç”Ÿæˆå…¨å¥— (btnOneClickGen)
    // æˆ‘ä»¬é‡æ–°ç»‘å®šè¿™ä¸ªæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    setTimeout(function() {
        var btn = document.getElementById('btnOneClickGen');
        if (!btn) return;

        // ç§»é™¤æ—§äº‹ä»¶ï¼Œç»‘å®šæ–°äº‹ä»¶
        btn.onclick = async function() {
            var name = document.getElementById('cardName').value.trim();
            if (!name) { 
                if(window.auth && window.auth.toast) window.auth.toast('å…ˆç»™è§’è‰²èµ·ä¸ªåå­—å§ï¼'); 
                else alert('å…ˆç»™è§’è‰²èµ·ä¸ªåå­—å§ï¼');
                return; 
            }

            // è·å–æ ‡ç­¾
            var allTags = [];
            if (window.currentSelectedTags) {
                allTags = [
                    ...window.currentSelectedTags.identity, 
                    ...window.currentSelectedTags.personality, 
                    ...window.currentSelectedTags.trope
                ];
            }
            var tagStr = allTags.join('ã€');

            var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
            if (!config || !config.apiKey) { alert('ğŸ”‘ è¯·å…ˆé…ç½® API Key'); return; }

            var selfBtn = document.getElementById('btnOneClickGen');
            var oldText = selfBtn.innerText;
            selfBtn.innerText = 'ğŸ§  å¼ºåŠ›ç”Ÿæˆä¸­...'; selfBtn.disabled = true;

            var prompt = `
            æˆ‘æ˜¯åˆ›é€ è€…ã€‚è¯·ä¸ºè§’è‰²ã€${name}ã€‘è®¾è®¡å…¨å¥—äººè®¾ã€‚
            ã€å¼ºåˆ¶æ ‡ç­¾ã€‘ï¼š${tagStr}ã€‚
            
            è¯·è¿”å›çº¯ JSON æ ¼å¼ï¼ŒåŒ…å«ï¼š
            1. "desc": è¯¦ç»†è®¾å®š (500å­—ï¼ŒåŒ…å«å¤–è²Œã€æ€§æ ¼ã€èº«ä¸–)ã€‚
            2. "first_mes": å¼€åœºç™½ (ç¬¦åˆäººè®¾çš„ç¬¬ä¸€å¥è¯ï¼Œä¸è¦å¼•å·)ã€‚
            3. "example": å¯¹è¯æ ·æœ¬ (Userä¸Charçš„å¯¹è¯ç¤ºä¾‹)ã€‚
            `;

            try {
                // å‘é€è¯·æ±‚
                var res = await fetchAI(prompt, config); // å‡è®¾ fetchAI æ˜¯å…¨å±€å¯ç”¨çš„
                
                // ğŸ”¥ ä½¿ç”¨å¼ºåŠ›æå–å™¨
                var data = safeExtractJSON(res);

                // å¡«å…¥æ•°æ®
                if(document.getElementById('cardDesc')) document.getElementById('cardDesc').value = data.desc || "";
                if(document.getElementById('cardFirstMes')) document.getElementById('cardFirstMes').value = data.first_mes || "";
                if(document.getElementById('cardMesExample')) document.getElementById('cardMesExample').value = data.example || "";

                // è‡ªåŠ¨è·³åˆ°é¢„è§ˆé¡µ
                if(typeof switchCardTab === 'function') switchCardTab('preview');
                if(typeof updatePreviewUI === 'function') updatePreviewUI();
                
                // å­˜å…¥äºŒæ¬¡ç¼–è¾‘ç¼“å­˜
                if (!window.lastGeneratedData) window.lastGeneratedData = {};
                window.lastGeneratedData.desc = data.desc;
                window.lastGeneratedData.firstMes = data.first_mes;
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                if(window.auth && window.auth.toast) window.auth.toast('âœ¨ å…¨å¥—äººè®¾ç”ŸæˆæˆåŠŸï¼(å·²è¿‡æ»¤åºŸè¯)');

            } catch (e) {
                console.error("ç”ŸæˆæŠ¥é”™è¯¦æƒ…:", e);
                // å°±ç®—æŠ¥é”™äº†ï¼Œå¦‚æœæ–‡æœ¬æ¡†é‡Œæœ‰å­—ï¼Œä¹Ÿç®—åŠæˆåŠŸï¼Œä¸å¼¹æŠ¥é”™
                if (document.getElementById('cardDesc').value.length > 10) {
                    if(window.auth && window.auth.toast) window.auth.toast('âš ï¸ æ ¼å¼æœ‰å°ç‘•ç–µï¼Œä½†å†…å®¹å·²å¡«å…¥');
                } else {
                    alert('âŒ ç”Ÿæˆå¤±è´¥ï¼ŒAI è¿”å›æ ¼å¼é”™è¯¯ã€‚\n\né”™è¯¯åŸå› ï¼š' + e.message);
                }
            } finally {
                selfBtn.innerText = oldText; selfBtn.disabled = false;
            }
        };
        
        console.log("âœ… ä¸€é”®ç”ŸæˆæŒ‰é’®å·²å‡çº§ä¸ºå¼ºåŠ›ç‰ˆ");
    }, 1000); // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿æŒ‰é’®å·²ç”Ÿæˆ

    // 3. âš¡ï¸ è¦†ç›–ï¼šå•ç‹¬ç”Ÿæˆè¯¦ç»†è®¾å®š (autoGenDesc)
    window.autoGenDesc = async function() {
        var name = document.getElementById('cardName').value.trim();
        var tagStr = "æ— ";
        if(window.currentSelectedTags) {
            tagStr = [...window.currentSelectedTags.identity, ...window.currentSelectedTags.personality, ...window.currentSelectedTags.trope].join('ã€');
        }

        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) return;

        var btn = event.target;
        var oldText = btn.innerText;
        btn.innerText = 'âœï¸...'; 

        var prompt = `è§’è‰²ï¼š${name}ã€‚æ ‡ç­¾ï¼š${tagStr}ã€‚å†™ä¸€æ®µè¯¦ç»†è®¾å®š(desc)ã€‚çº¯æ–‡æœ¬ã€‚`;

        try {
            var res = await fetchAI(prompt, config);
            // çº¯æ–‡æœ¬ç”Ÿæˆä¸éœ€è¦ JSON è§£æï¼Œç›´æ¥æ¸…ç†ä¸€ä¸‹Markdownç¬¦å·å³å¯
            var cleanText = res.replace(/```/g, '').trim();
            
            document.getElementById('cardDesc').value = cleanText;
            if(window.auth && window.auth.toast) window.auth.toast('âœ… è®¾å®šå·²ç”Ÿæˆï¼');
            
            // ç¼“å­˜
            if (!window.lastGeneratedData) window.lastGeneratedData = {};
            window.lastGeneratedData.desc = cleanText;
            var refineBox = document.getElementById('refineArea_desc');
            if(refineBox) refineBox.style.display = 'block';

        } catch(e) {
            console.error(e);
            if(window.auth && window.auth.toast) window.auth.toast('âŒ ç½‘ç»œé”™è¯¯');
        } finally {
            btn.innerText = oldText;
        }
    };

})();

/* ================= ğŸ”— V18.0 è¡¥ä¸ï¼šå†›å¸ˆä¸äºŒæ¬¡ç¼–è¾‘çš„è§†è§‰è”åŠ¨ ================= */
(function() {
    console.log("ğŸš€ V18.0ï¼šæ¿€æ´»äºŒæ¬¡ç¼–è¾‘ UI è”åŠ¨");

    // 1. å¤‡ä»½æ—§çš„ apply å‡½æ•°
    var _oldApply = window.applyGodFixFromCache;

    // 2. è¦†ç›–ï¼šåº”ç”¨ä¿®æ”¹æ—¶ï¼Œå¼ºåˆ¶å”¤é†’å¯¹åº”çš„â€œè®©å®ƒæ”¹â€é¢æ¿
    window.applyGodFixFromCache = function(cacheId, targetId, btn) {
        // å…ˆæ‰§è¡ŒåŸæœ‰çš„æ•°æ®åŒæ­¥é€»è¾‘
        if (_oldApply) _oldApply(cacheId, targetId, btn);

        // --- ğŸ”¥ V18.0 æ–°å¢ï¼šç•Œé¢å”¤é†’é€»è¾‘ ---
        try {
            // å¦‚æœä¿®æ”¹çš„æ˜¯ã€è¯¦ç»†è®¾å®šã€‘ï¼Œå”¤é†’ desc çš„ç¼–è¾‘æ¡†
            if (targetId === 'cardDesc') {
                var box = document.getElementById('refineArea_desc');
                if (box) {
                    box.style.display = 'block'; // å¼ºåˆ¶æ˜¾ç¤º
                    // é¡ºä¾¿é«˜äº®ä¸€ä¸‹è¾“å…¥æ¡†ï¼Œæç¤ºç”¨æˆ·è¿™é‡Œå¯ä»¥æ”¹
                    var input = document.getElementById('refineInput_desc');
                    if (input) {
                        input.placeholder = "å¯¹åˆšæ‰å†›å¸ˆå†™çš„è®¾å®šä¸æ»¡æ„ï¼Ÿåœ¨è¿™é‡Œå¾®è°ƒ...";
                        input.style.backgroundColor = "#fff0f5"; // é—ªä¸€ä¸‹ç²‰è‰²
                        setTimeout(() => input.style.backgroundColor = "", 1000);
                    }
                }
            }
            
            // å¦‚æœä¿®æ”¹çš„æ˜¯ã€å¼€åœºç™½ã€‘ï¼Œå”¤é†’ firstMes çš„ç¼–è¾‘æ¡†
            if (targetId === 'cardFirstMes') {
                var box = document.getElementById('refineArea_firstMes');
                if (box) {
                    box.style.display = 'block';
                    var input = document.getElementById('refineInput_firstMes');
                    if (input) input.placeholder = "å¼€åœºç™½è¿˜è¦æ€ä¹ˆæ”¹ï¼Ÿ";
                }
            }

            // å¦‚æœä¿®æ”¹çš„æ˜¯ã€å¯¹è¯æ ·æœ¬ã€‘ï¼Œå”¤é†’ example çš„ç¼–è¾‘æ¡† (å¦‚æœæœ‰çš„è¯)
            if (targetId === 'cardMesExample') {
                // æœ‰äº›ç‰ˆæœ¬å¯èƒ½æ²¡æœ‰è¿™ä¸ªæ¡†ï¼Œæ£€æŸ¥ä¸€ä¸‹
                var box = document.getElementById('refineArea_example'); 
                if (box) box.style.display = 'block';
            }

        } catch (e) {
            console.error("V18.0 UI å”¤é†’å¤±è´¥:", e);
        }
    };

    // 3. ğŸ›¡ï¸ å…œåº•ä¿®å¤ï¼šç¡®ä¿ refineResult å‡½æ•°å¯¹çº¯æ–‡æœ¬ä¾ç„¶æœ‰æ•ˆ
    // (é˜²æ­¢ä¹‹å‰çš„è¡¥ä¸æ„å¤–è¦†ç›–äº†çº¯æ–‡æœ¬çš„å¤„ç†é€»è¾‘)
    var _oldRefine = window.refineResult;
    window.refineResult = async function(type) {
        // å¦‚æœæ˜¯äººè®¾æˆ–å¼€åœºç™½ï¼Œèµ°ä¸“é—¨çš„çº¯æ–‡æœ¬é€šé“
        if (type === 'desc' || type === 'firstMes') {
            var inputId = `refineInput_${type}`;
            var requirement = document.getElementById(inputId).value.trim();
            if (!requirement) { 
                if(window.auth && window.auth.toast) window.auth.toast('è¯·å‘Šè¯‰æˆ‘æ€ä¹ˆæ”¹...'); 
                return; 
            }

            // 1. è·å–æ—§å†…å®¹ (ä»ç¼“å­˜æˆ–ç›´æ¥ä»è¾“å…¥æ¡†æŠ“)
            var prevContent = "";
            if (window.lastGeneratedData && window.lastGeneratedData[type]) {
                prevContent = window.lastGeneratedData[type];
            } else {
                // å¦‚æœç¼“å­˜ç©ºäº†ï¼Œç°æŠ“
                if (type === 'desc') prevContent = document.getElementById('cardDesc').value;
                if (type === 'firstMes') prevContent = document.getElementById('cardFirstMes').value;
            }

            var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
            if (!config || !config.apiKey) return;

            var btn = event.target;
            var oldText = btn.innerText;
            btn.innerText = 'ğŸ§ ...'; btn.disabled = true;

            var prompt = `
            åŸæ–‡æœ¬ï¼š
            ${prevContent}
            
            ä¿®æ”¹è¦æ±‚ï¼šã€${requirement}ã€‘
            
            è¯·é‡å†™ã€‚ç›´æ¥è¾“å‡ºä¿®æ”¹åçš„çº¯æ–‡æœ¬ï¼Œä¸è¦ Markdownï¼Œä¸è¦åºŸè¯ã€‚
            `;

            try {
                var res = await fetchAI(prompt, config);
                var cleanText = res.replace(/```/g, '').trim();

                // 2. å¡«å›è¾“å…¥æ¡†
                if (type === 'desc') document.getElementById('cardDesc').value = cleanText;
                if (type === 'firstMes') document.getElementById('cardFirstMes').value = cleanText;

                // 3. æ›´æ–°ç¼“å­˜ (å…³é”®ï¼)
                if (!window.lastGeneratedData) window.lastGeneratedData = {};
                window.lastGeneratedData[type] = cleanText;

                // 4. æ¸…ç©ºä¿®æ”¹æ„è§æ¡†
                document.getElementById(inputId).value = '';
                
                if(window.auth && window.auth.toast) window.auth.toast('âœ¨ ä¿®æ”¹å·²åº”ç”¨ï¼');
                if(typeof updatePreviewUI === 'function') updatePreviewUI();

            } catch (e) {
                console.error(e);
                if(window.auth && window.auth.toast) window.auth.toast('âŒ ç½‘ç»œå¡é¡¿ï¼Œè¯·é‡è¯•');
            } finally {
                btn.innerText = oldText; btn.disabled = false;
            }
            return; // ç»“æŸï¼Œä¸èµ°åŸæ¥çš„é€»è¾‘
        }

        // å…¶ä»–ç±»å‹ (å‰ç«¯ã€ä¸–ç•Œä¹¦) ç»§ç»­èµ°æ—§é€»è¾‘
        if (_oldRefine) _oldRefine(type);
    };

})();

/* ================= ğŸ§± V19.0 å¼ºåŠ›èƒ¶æ°´è¡¥ä¸ï¼šäºŒæ¬¡ç¼–è¾‘æ¡†å¼ºåˆ¶å½’ä½ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V19.0ï¼šæ­£åœ¨æŠŠäºŒæ¬¡ç¼–è¾‘æ¡†ç„Šæ­»åœ¨è¾“å…¥æ¡†ä¸‹é¢...");

    // ğŸ› ï¸ æ ¸å¿ƒå·¥å…µï¼šè´Ÿè´£æŠŠç¼–è¾‘æ¡†æŠ“å›æ¥
    function forceAttachRefineBox(inputId, boxId, type, placeholder) {
        var inputEl = document.getElementById(inputId);
        if (!inputEl) return; // è¿è¾“å…¥æ¡†éƒ½æ²¡äº†ï¼Œæ²¡æ³•æ

        var boxEl = document.getElementById(boxId);

        // 1. å¦‚æœæ¡†ä¸å­˜åœ¨ï¼Œå½“åœºé€ ä¸€ä¸ª
        if (!boxEl) {
            console.log("ğŸ› ï¸ è¡¥å…¨ä¸¢å¤±çš„ç¼–è¾‘æ¡†:", boxId);
            boxEl = document.createElement('div');
            boxEl.id = boxId;
            // æ ·å¼è®¾ç½®ï¼šæµ…ç°è‰²èƒŒæ™¯ï¼Œè™šçº¿è¾¹æ¡†
            boxEl.style.cssText = "display:block; margin-top:5px; margin-bottom:15px; background:#f0f0f0; padding:8px; border-radius:8px; border:1px dashed #ccc;";
            
            // å†…éƒ¨ç»“æ„ï¼šè¾“å…¥æ¡† + æŒ‰é’®
            boxEl.innerHTML = `
                <div style="display:flex; gap:5px; align-items:center;">
                    <span style="font-size:12px; color:#666;">ğŸ”§ å¾®è°ƒ:</span>
                    <input type="text" id="refineInput_${type}" class="visual-input" placeholder="${placeholder}" style="flex:1; padding:5px;">
                    <button onclick="window.refineResult('${type}')" style="background:#a29bfe; color:white; border:none; border-radius:5px; cursor:pointer; padding:5px 15px; font-weight:bold;">ğŸ”„ è®©å®ƒæ”¹</button>
                </div>
            `;
        }

        // 2. æ£€æŸ¥ä½ç½®ï¼šå¦‚æœå®ƒä¸åœ¨ input çš„æ­£ä¸‹æ–¹ï¼Œå°±æŒªè¿‡å»
        // nextElementSibling æ˜¯ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
        if (inputEl.nextElementSibling !== boxEl) {
            // insertBefore(è¦æ’å…¥çš„, å‚è€ƒèŠ‚ç‚¹) -> å‚è€ƒèŠ‚ç‚¹æ˜¯ input çš„ä¸‹ä¸€ä¸ªå…„å¼Ÿï¼Œç­‰äºæ’åœ¨ input åé¢
            if (inputEl.parentNode) {
                inputEl.parentNode.insertBefore(boxEl, inputEl.nextSibling);
            }
        }
        
        // 3. å¼ºåˆ¶æ˜¾ç¤ºï¼šåªè¦è¾“å…¥æ¡†é‡Œæœ‰å­—ï¼Œè¿™ä¸ªæ¡†å°±å¿…é¡»æ˜¾ç¤ºå‡ºæ¥
        if (inputEl.value && inputEl.value.trim() !== "") {
            boxEl.style.display = 'block';
        }
    }

    // ğŸ›¡ï¸ å·¡é€»é˜Ÿï¼šæ¯éš” 1 ç§’å·¡è§†ä¸€æ¬¡ DOMï¼Œè°è·‘äº†å°±æŠ“å›æ¥
    setInterval(function() {
        // 1. é”å®šâ€œè¯¦ç»†è®¾å®šâ€
        forceAttachRefineBox(
            'cardDesc',           // ç›®æ ‡è¾“å…¥æ¡† ID
            'refineArea_desc',    // ç¼–è¾‘æ¡† ID
            'desc',               // ä¿®æ”¹ç±»å‹
            'å“ªé‡Œä¸æ»¡æ„ï¼Ÿ(å¦‚: å†ç—…å¨‡ä¸€ç‚¹)...' // æç¤ºè¯
        );

        // 2. é”å®šâ€œå¼€åœºç™½â€
        forceAttachRefineBox(
            'cardFirstMes',       // ç›®æ ‡è¾“å…¥æ¡† ID
            'refineArea_firstMes',// ç¼–è¾‘æ¡† ID
            'firstMes',           // ä¿®æ”¹ç±»å‹
            'å¼€åœºç™½æ€ä¹ˆæ”¹ï¼Ÿ(å¦‚: åŠ ä¸ŠåŠ¨ä½œæå†™)...' // æç¤ºè¯
        );

    }, 1000); // 1ç§’ä¸€æ¬¡ï¼Œæ°¸ä¸åœæ­¢

    // ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶å¼¹çª—æç¤º
    setTimeout(function() {
        if(window.auth && window.auth.toast) window.auth.toast('ğŸ§± ç¼–è¾‘æ¡†å·²å¼ºåˆ¶å›ºå®šï¼');
    }, 500);

})();

/* ================= ğŸ§  V20.0 è¡¥ä¸ï¼šå†›å¸ˆè®¤çŸ¥ä¸å¯¼èˆªå¼ºåŠ›çŸ«æ­£ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V20.0ï¼šæ­£åœ¨é‡å†™å†›å¸ˆçš„åˆ†ç±»é€»è¾‘...");

    // 1. è¦†ç›–åˆ†æå‡½æ•° (é‡å†™ Promptï¼Œå¼ºåˆ¶åˆ†ç±»)
    window.analyzeCardNeeds = async function() {
        var name = document.getElementById('cardName').value;
        var desc = document.getElementById('cardDesc').value.trim();
        
        if (desc.length < 10) { 
            if(window.auth && window.auth.toast) window.auth.toast('ğŸ“œ è¯·å…ˆå†™ç‚¹äººè®¾ï¼Œå†›å¸ˆæ‰èƒ½åˆ†æå“¦'); 
            return; 
        }

        // æ˜¾ç¤ºçª—å£
        var box = document.getElementById('aiAdvisorBox');
        if(box) box.style.display = 'flex';
        
        var chat = document.getElementById('advisorChat');
        chat.innerHTML = `<div class="ai-loading" style="color:#999;font-size:12px;text-align:center;padding:20px;">ğŸ§  æ­£åœ¨é‡æ–°æ¢³ç†æ€è·¯...</div>`;

        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) {
            chat.innerHTML = `<div class="advisor-bubble">âŒ è¯·å…ˆé…ç½® API Keyã€‚</div>`;
            return;
        }

        // ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šæ­»æ¿çš„åˆ†ç±»æŒ‡ä»¤
        var prompt = `
        æˆ‘æ˜¯å¡ç‰‡ä½œè€…ã€‚è§’è‰²ï¼š${name}ã€‚
        è®¾å®šï¼š${desc.substring(0, 800)}...
        
        è¯·ä½œä¸ºâ€œåˆ¶ä½œé¡¾é—®â€ï¼Œæå‡º 3 ä¸ªä¿®æ”¹å»ºè®®ã€‚
        
        ğŸ”¥ **å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹åˆ†ç±»ï¼ˆTypeï¼‰**ï¼š
        1. ã€type: "desc"ã€‘
           - å‡¡æ˜¯æ¶‰åŠï¼šä¿®æ”¹æ€§æ ¼ã€å¤–è²Œã€èº«ä¸–ã€è¯´è¯è¯­æ°”ã€å¼€åœºç™½ã€å¯¹è¯æ ·æœ¬ã€‚
           - åªè¦æ˜¯çº¯æ–‡æœ¬è®¾å®šï¼Œç»Ÿç»Ÿå¡« "desc"ã€‚
           
        2. ã€type: "frontend"ã€‘
           - å‡¡æ˜¯æ¶‰åŠï¼šç•Œé¢ç¾åŒ–ã€CSSæ ·å¼ã€HTMLä»£ç ã€çŠ¶æ€æ æ˜¾ç¤ºã€æ°”æ³¡é¢œè‰²ã€ç‰¹æ•ˆã€‚
           - åªè¦æ˜¯å¥½åŸºå‹çœ‹çš„ï¼Œç»Ÿç»Ÿå¡« "frontend"ã€‚

        3. ã€type: "world"ã€‘
           - å‡¡æ˜¯æ¶‰åŠï¼šå¢åŠ æ–°ç‰©å“ã€æ–°åœ°ç‚¹ã€åè¯è§£é‡Šã€ä¸–ç•ŒèƒŒæ™¯è®¾å®šã€‚
           - åªè¦æ˜¯è¡¥å……è®¾å®šçš„ï¼Œç»Ÿç»Ÿå¡« "world"ã€‚

        4. ã€type: "stat"ã€‘
           - å‡¡æ˜¯æ¶‰åŠï¼šå¥½æ„Ÿåº¦ç³»ç»Ÿã€æ•°å€¼è®¡ç®—ã€æ¸¸æˆè§„åˆ™ã€é€»è¾‘è„šæœ¬ã€‚
           - åªè¦å¸¦æ•°å­—å˜åŒ–çš„ï¼Œç»Ÿç»Ÿå¡« "stat"ã€‚
        
        å¿…é¡»è¿”å›çº¯ JSON æ•°ç»„ï¼š
        [
            {
                "type": "desc",  // ä¸¥æ ¼æŒ‰ä¸Šé¢é€‰
                "title": "å»ºè®®æ ‡é¢˜", 
                "reason": "ç†ç”±", 
                "prompt": "å…·ä½“çš„ä¿®æ”¹æŒ‡ä»¤" 
            }
        ]
        `;

        try {
            var res = await fetchAI(prompt, config);
            var cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
            var suggestions = JSON.parse(cleanJson);
            
            chat.innerHTML = ''; 
            suggestions.forEach(item => renderSuggestionBubble(item));
            
        } catch(e) { 
            console.error(e);
            chat.innerHTML = `<div class="advisor-bubble">âŒ å†›å¸ˆè„‘å­è¿˜åœ¨ä¹±... (è¯·é‡è¯•)</div>`;
        }
    };

    // 2. è¦†ç›–è·³è½¬å‡½æ•° (æ­»æ¿çš„è·¯ç”±æ˜ å°„)
    window.jumpToCreator = function(btn, type, encodedPrompt) {
        console.log("ğŸ‘‰ æ­£åœ¨è·³è½¬ï¼Œç›®æ ‡ç±»å‹:", type);

        if (btn) { btn.innerHTML = "â³ è·³è½¬ä¸­..."; btn.style.opacity = "0.7"; }

        setTimeout(function() {
            try {
                var promptText = decodeURIComponent(encodedPrompt);
                var targetId = "";

                // --- ğŸš¦ å¼ºåˆ¶è·¯ç”± ---
                
                // æƒ…å†µ 1: äººè®¾/æè¿° -> å»é¢„è§ˆé¡µ (Preview)
                if (type === 'desc' || type === 'description') {
                    if(typeof switchCardTab === 'function') switchCardTab('preview');
                    
                    // è¿˜è¦æŠŠä¿®æ”¹æ¡†å¼¹å‡ºæ¥
                    var refineBox = document.getElementById('refineArea_desc');
                    if(refineBox) refineBox.style.display = 'block';
                    
                    targetId = 'refineInput_desc'; 
                }
                
                // æƒ…å†µ 2: å‰ç«¯/ç‰¹æ•ˆ -> å»æ­£åˆ™é¡µ (Regex)
                else if (type === 'frontend' || type === 'regex' || type === 'ui') {
                    if(typeof switchCardTab === 'function') switchCardTab('regex');
                    
                    // ç¡®ä¿åˆ‡åˆ°é«˜çº§æ¨¡å¼
                    var ui = document.getElementById('uiFrontendMode');
                    if(ui) ui.style.display = 'block';
                    
                    targetId = 'aiCodePrompt';
                }
                
                // æƒ…å†µ 3: ä¸–ç•Œä¹¦/è®¾å®š -> å»ä¸–ç•Œä¹¦é¡µ (World)
                else if (type === 'world' || type === 'lore') {
                    if(typeof switchCardTab === 'function') switchCardTab('world');
                    targetId = 'aiWorldPrompt';
                }
                
                // æƒ…å†µ 4: å±æ€§/æ•°å€¼ -> å»å±æ€§é¡µ (Stats)
                else if (type === 'stat' || type === 'stats' || type === 'logic') {
                    if(typeof switchCardTab === 'function') switchCardTab('stats');
                    targetId = 'aiStatPrompt';
                }
                
                // å…œåº•ï¼šå¦‚æœ AI çå¡«äº†ä¸€ä¸ªç±»å‹ï¼Œé»˜è®¤å»äººè®¾é¡µ
                else {
                    console.warn("æœªçŸ¥ç±»å‹:", type, "é»˜è®¤è·³è½¬é¢„è§ˆé¡µ");
                    if(typeof switchCardTab === 'function') switchCardTab('preview');
                    targetId = 'refineInput_desc';
                }

                // --- å¡«å…¥å¹¶å®šä½ ---
                var targetEl = document.getElementById(targetId);
                if (targetEl) {
                    targetEl.value = promptText;
                    targetEl.focus();
                    targetEl.scrollIntoView({behavior: "smooth", block: "center"});
                    
                    // è§†è§‰æç¤º
                    var oldBg = targetEl.style.backgroundColor;
                    targetEl.style.transition = "background 0.3s";
                    targetEl.style.backgroundColor = "#d4edda";
                    setTimeout(() => targetEl.style.backgroundColor = oldBg, 1000);

                    if(window.auth && window.auth.toast) window.auth.toast('âœ… å·²å¯¼èˆªåˆ°ä½ï¼è¯·ç‚¹å‡»æŒ‰é’®æ‰§è¡Œ');
                    
                    if (btn) {
                        btn.innerHTML = "âœ… å·²å¡«å…¥";
                        btn.disabled = true;
                        btn.style.background = "#d4edda";
                        btn.style.color = "#155724";
                    }
                } else {
                    alert("âŒ å¯¼èˆªå¤±è´¥ï¼šæ‰¾ä¸åˆ°ç›®æ ‡è¾“å…¥æ¡† (" + targetId + ")");
                }

            } catch (e) {
                console.error(e);
                if (btn) { btn.innerHTML = "âŒ é‡è¯•"; btn.disabled = false; }
            }
        }, 300);
    };

    console.log("âœ… å†›å¸ˆé€»è¾‘å·²çŸ«æ­£ï¼šåˆ†ç±»æ›´å‡†ï¼Œè·³è½¬æ›´ç¨³");

})();

/* ================= ğŸ’¾ V21.0 è¡¥ä¸ï¼šæ ¸å¼¹çº§å¼ºåˆ¶å¯¼å‡º (ä¿®å¤ç‚¹å‡»æ— ååº”) ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V21.0ï¼šæ¥ç®¡å¯¼å‡ºåŠŸèƒ½ï¼Œå¼ºåˆ¶æ‰§è¡Œä¸‹è½½...");

    // 1. å®šä¹‰ä¸€ä¸ªâ€œç»ä¸æŠ¥é”™â€çš„å¯¼å‡ºå‡½æ•°
    window.forceExportTavernCard = function() {
        try {
            // ğŸ’¡ è§†è§‰åé¦ˆï¼šè®©æŒ‰é’®å˜è‰²ï¼Œè¯æ˜ä½ ç‚¹åˆ°äº†
            var allButtons = document.querySelectorAll('button');
            var targetBtn = null;
            // æ‰¾é‚£ä¸ªå†™ç€â€œå¯¼å‡ºâ€çš„æŒ‰é’®
            allButtons.forEach(btn => {
                if (btn.innerText.includes("å¯¼å‡º")) {
                    targetBtn = btn;
                    btn.innerHTML = "ğŸ“¦ æ‰“åŒ…ä¸­...";
                    btn.style.background = "#e67e22"; // å˜æ©™è‰²
                }
            });

            // --- A. æš´åŠ›æŠ“å–æ•°æ® (åŠ äº† || "" é˜²æ­¢ null æŠ¥é”™) ---
            var getVal = function(id) { 
                var el = document.getElementById(id); 
                return el ? el.value : ""; 
            };

            var name = getVal('cardName').trim() || "æœªå‘½åè§’è‰²";
            
            // --- B. æ„å»º V2 å¡ç‰‡ç»“æ„ ---
            var cardData = {
                "spec": "chara_card_v2",
                "spec_version": "2.0",
                "data": {
                    "name": name,
                    "description": getVal('cardDesc'),
                    "first_mes": getVal('cardFirstMes'),
                    "mes_example": getVal('cardMesExample'),
                    "scenario": getVal('cardScenario'),
                    "creator_notes": getVal('cardNote') || getVal('statEditor'), // å…¼é¡¾ä¸¤ä¸ªID
                    
                    "system_prompt": "",
                    "post_history_instructions": "",
                    "alternate_greetings": [],
                    "character_book": null,
                    "tags": [],
                    "creator": "Lili's Creator Workshop",
                    "character_version": "1.0",
                    "extensions": {}
                }
            };

            // --- C. æ³¨å…¥é«˜çº§æ•°æ® (æ­£åˆ™ & ä¸–ç•Œä¹¦) ---
            
            // 1. æ³¨å…¥æ­£åˆ™è„šæœ¬
            if (window.currentCardRegexes && window.currentCardRegexes.length > 0) {
                cardData.data.extensions.regex_scripts = window.currentCardRegexes;
                console.log("âœ… å·²æ‰“åŒ…æ­£åˆ™è„šæœ¬:", window.currentCardRegexes.length);
            }

            // 2. æ³¨å…¥ä¸–ç•Œä¹¦
            if (window.currentWorldInfo && window.currentWorldInfo.entries && window.currentWorldInfo.entries.length > 0) {
                cardData.data.character_book = {
                    "name": "Embedded World",
                    "description": "Generated by Creator Workshop",
                    "scan_depth": 100,
                    "token_budget": 500,
                    "recursive_scanning": false,
                    "extensions": {},
                    "entries": window.currentWorldInfo.entries
                };
                console.log("âœ… å·²æ‰“åŒ…ä¸–ç•Œä¹¦æ¡ç›®:", window.currentWorldInfo.entries.length);
            }

            // --- D. ç”Ÿæˆæ–‡ä»¶å¹¶ä¸‹è½½ ---
            var jsonStr = JSON.stringify(cardData, null, 2);
            var blob = new Blob([jsonStr], {type: "application/json"});
            var url = URL.createObjectURL(blob);
            
            var a = document.createElement('a');
            a.href = url;
            a.download = name + ".json";
            document.body.appendChild(a);
            a.click();
            
            // æ¸…ç†
            setTimeout(function() {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (targetBtn) {
                    targetBtn.innerHTML = "ğŸ’¾ å¯¼å‡ºæˆåŠŸ";
                    targetBtn.style.background = "#00b894"; // å˜å›ç»¿è‰²
                    setTimeout(() => targetBtn.innerHTML = "ğŸ’¾ å¯¼å‡ºå¡ç‰‡", 2000);
                }
                
                if(window.auth && window.auth.toast) window.auth.toast('ğŸ’¾ å¼ºåŠ›å¯¼å‡ºæˆåŠŸï¼');
            }, 100);

        } catch (e) {
            console.error("å¯¼å‡ºå´©æºƒ:", e);
            alert("âŒ å¯¼å‡ºæ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯:\n" + e.message + "\n\n(è™½ç„¶æŠ¥é”™äº†ï¼Œä½†è¯·æ£€æŸ¥æµè§ˆå™¨ä¸‹è½½è®°å½•ï¼Œå¯èƒ½å·²ç»å¼ºåˆ¶ä¸‹è½½äº†)");
        }
    };

    // 2. ğŸ”¥ æš´åŠ›åŠ«æŒæŒ‰é’® (æ¯ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œé˜²æ­¢æŒ‰é’®è¢«å…¶ä»–ä»£ç é‡ç½®)
    // åªè¦çœ‹åˆ°æŒ‰é’®ä¸Šæœ‰â€œå¯¼å‡ºâ€ä¸¤ä¸ªå­—ï¼Œå°±æŠŠå®ƒçš„ onclick æ¢æˆæˆ‘ä»¬çš„å¼ºåŠ›å‡½æ•°
    setInterval(function() {
        var buttons = document.querySelectorAll('button');
        buttons.forEach(function(btn) {
            // åªè¦æ–‡å­—åŒ…å«"å¯¼å‡º"ï¼Œä¸”ç‚¹å‡»äº‹ä»¶ä¸æ˜¯æˆ‘ä»¬çš„å¼ºåŠ›å‡½æ•°
            if (btn.innerText.includes("å¯¼å‡º") && btn.onclick !== window.forceExportTavernCard) {
                // ç§»é™¤æ—§çš„ç›‘å¬å™¨ (é˜²æ­¢å†²çª)
                var newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                // ç»‘å®šæ–°çš„å¼ºåŠ›å‡½æ•°
                newBtn.onclick = window.forceExportTavernCard;
                // console.log("âœ… å·²åŠ«æŒå¯¼å‡ºæŒ‰é’®:", newBtn);
            }
        });
    }, 1000); // æ¯ç§’å·¡è§†ä¸€æ¬¡

})();

/* ================= ğŸš‘ V23.0 è¡¥ä¸ï¼šä¿®å¤å†›å¸ˆâ€œå»æ·»åŠ â€æŒ‰é’®å¤±æ•ˆ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V23.0ï¼šé‡å†™è·³è½¬å¯¼èˆªé€»è¾‘...");

    // è¦†ç›–æ—§çš„è·³è½¬å‡½æ•°
    window.jumpToCreator = function(btn, type, encodedPrompt) {
        // 1. æŒ‰é’®ç‚¹å‡»åé¦ˆ (å˜è‰²ï¼Œè¯æ˜ç‚¹åˆ°äº†)
        if (btn) {
            btn.innerHTML = "â³ æ­£åœ¨è·³è½¬...";
            btn.style.opacity = "0.7";
            btn.disabled = true; // é˜²æ­¢è¿ç‚¹
        }

        setTimeout(function() {
            try {
                // 2. è§£ç å»ºè®®å†…å®¹
                var promptText = decodeURIComponent(encodedPrompt);
                var targetTabId = "";
                var targetInputId = "";
                var extraShowId = ""; // éœ€è¦é¢å¤–å¼ºåˆ¶æ˜¾ç¤ºçš„å®¹å™¨

                // --- ğŸ—ºï¸ é‡æ–°ç»˜åˆ¶åœ°å›¾ (é€‚é…æœ€æ–°ä¿®æ”¹çš„ID) ---
                
                if (type === 'world') {
                    // ä¸–ç•Œä¹¦
                    targetTabId = 'tab-world';
                    targetInputId = 'aiWorldPrompt';
                } 
                else if (type === 'frontend') {
                    // å‰ç«¯ç‰¹æ•ˆ
                    targetTabId = 'tab-regex';
                    targetInputId = 'aiCodePrompt';
                    extraShowId = 'uiFrontendMode'; // å¼ºåˆ¶æ˜¾ç¤ºAIé¢æ¿
                } 
                else if (type === 'stat') {
                    // å±æ€§/é€»è¾‘
                    targetTabId = 'tab-stats';
                    targetInputId = 'aiStatPrompt';
                }
                else if (type === 'desc') {
                    // è¯¦ç»†è®¾å®š (ä¿®æ”¹å»ºè®®)
                    targetTabId = 'tab-preview';
                    targetInputId = 'refineInput_desc';
                    extraShowId = 'refineArea_desc'; // å¼ºåˆ¶æ˜¾ç¤ºä¿®æ”¹æ¡†
                }

                // --- ğŸšœ æ¨åœŸæœºå¼å¯¼èˆª ---

                // A. ç¡®ä¿å†™å¡å™¨å¼¹çª—æ˜¯å¼€ç€çš„
                var modal = document.getElementById('cardCreatorModal');
                if (modal) {
                    modal.classList.add('active');
                    modal.style.display = 'flex'; 
                }

                // B. å¼ºåˆ¶åˆ‡æ¢ Tab (ä¸ä¾èµ– switchCardTabï¼Œç›´æ¥æ“ä½œ DOM)
                var allTabs = document.querySelectorAll('.card-tab-content');
                allTabs.forEach(function(el) { el.style.display = 'none'; }); // å…³æ‰æ‰€æœ‰
                
                var targetTab = document.getElementById(targetTabId);
                if (targetTab) {
                    targetTab.style.display = 'block'; // æ‰“å¼€ç›®æ ‡
                } else {
                    throw new Error("æ‰¾ä¸åˆ°ç›®æ ‡é¡µé¢: " + targetTabId);
                }

                // C. æ¿€æ´»é¡¶éƒ¨æŒ‰é’®é«˜äº® (è§†è§‰åŒæ­¥)
                var tabBtns = document.querySelectorAll('.card-tab');
                tabBtns.forEach(function(b) { b.classList.remove('active'); });
                // æ¨¡ç³ŠåŒ¹é…æŒ‰é’®æ–‡å­—
                var activeBtn = Array.from(tabBtns).find(b => b.onclick && b.onclick.toString().includes(targetTabId.replace('tab-', '')));
                if (activeBtn) activeBtn.classList.add('active');

                // D. å¤„ç†é¢å¤–æ˜¾ç¤ºçš„å®¹å™¨ (æ¯”å¦‚å‰ç«¯é¢æ¿ã€ä¿®æ”¹æ¡†)
                if (extraShowId) {
                    var extraEl = document.getElementById(extraShowId);
                    if (extraEl) {
                        extraEl.style.display = 'block';
                        // å¦‚æœæ˜¯å‰ç«¯é¡µï¼Œè¿˜è¦æŠŠ simple æ¨¡å¼å…³æ‰
                        if(type === 'frontend') {
                            var simpleEl = document.getElementById('uiSimpleMode');
                            if(simpleEl) simpleEl.style.display = 'none';
                        }
                    }
                }

                // --- ğŸ¯ å¡«å…¥å†…å®¹å¹¶èšç„¦ ---
                var inputEl = document.getElementById(targetInputId);
                if (inputEl) {
                    inputEl.value = promptText;
                    inputEl.focus();
                    
                    // æ»šåŠ¨åˆ°å±å¹•ä¸­é—´
                    inputEl.scrollIntoView({behavior: "smooth", block: "center"});
                    
                    // é—ªçƒä¸€ä¸‹æç¤ºç”¨æˆ·
                    var oldBg = inputEl.style.backgroundColor;
                    inputEl.style.transition = "background 0.3s";
                    inputEl.style.backgroundColor = "#d4edda"; // æµ…ç»¿è‰²é«˜äº®
                    setTimeout(function() { inputEl.style.backgroundColor = oldBg; }, 1000);

                    // æˆåŠŸæç¤º
                    if(window.auth && window.auth.toast) window.auth.toast('âœ… å»ºè®®å·²å¡«å…¥ï¼Œè¯·ç‚¹å‡»ç”Ÿæˆ/ä¿®æ”¹');
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    if (btn) {
                        btn.innerHTML = "âœ… å·²å¡«å…¥";
                        btn.style.background = "#d4edda";
                        btn.style.color = "#155724";
                    }
                } else {
                    throw new Error("æ‰¾ä¸åˆ°è¾“å…¥æ¡†: " + targetInputId);
                }

            } catch (e) {
                console.error("è·³è½¬å¤±è´¥:", e);
                alert("âŒ è·³è½¬å‡ºé”™ï¼š" + e.message);
                // æ¢å¤æŒ‰é’®
                if (btn) {
                    btn.innerHTML = "âŒ é‡è¯•";
                    btn.disabled = false;
                    btn.style.opacity = "1";
                }
            }
        }, 100);
    };

    console.log("âœ… V23.0ï¼šè·³è½¬å¯¼èˆªç³»ç»Ÿå·²é‡ç½®");
})();

/* ================= ğŸ§± V24.0 è¡¥ä¸ï¼šå±æ€§é¡µäºŒæ¬¡ç¼–è¾‘æ¡†å¼ºåˆ¶å½’ä½ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V24.0ï¼šæŠŠå±æ€§é¡µçš„ä¿®æ”¹æ¡†æ‹½åˆ°åº•ä¸‹æ¥...");

    // ğŸ› ï¸ æ ¸å¿ƒå·¥å…µï¼šè´Ÿè´£æ¬è¿æˆ–é‡å»º
    function relocateStatRefineBox() {
        // 1. æ‰¾åˆ°å¤§è¾“å…¥æ¡† (Stat Editor)
        var inputEl = document.getElementById('statEditor');
        
        // 2. æ‰¾åˆ°ï¼ˆæˆ–æ–°å»ºï¼‰ä¿®æ”¹æ¡†
        var boxEl = document.getElementById('refineArea_stat');

        if (!inputEl) return;

        // å¦‚æœæ¡†ä¸å­˜åœ¨ï¼Œå½“åœºé€ ä¸€ä¸ª
        if (!boxEl) {
            console.log("ğŸ› ï¸ æ–°å»ºå±æ€§é¡µä¿®æ”¹æ¡†...");
            boxEl = document.createElement('div');
            boxEl.id = 'refineArea_stat';
            boxEl.style.cssText = "display:block; margin-top:5px; margin-bottom:15px; background:#fff7e6; padding:8px; border-radius:8px; border:1px dashed #f39c12;";
            
            boxEl.innerHTML = `
                <div style="display:flex; gap:5px; align-items:center;">
                    <span style="font-size:12px; color:#d46b08;">ğŸ”§ é€»è¾‘å¾®è°ƒ:</span>
                    <input type="text" id="refineInput_stat" class="visual-input" placeholder="ä»£ç å“ªé‡Œä¸å¯¹ï¼Ÿ(å¦‚: æ•°å€¼æ”¹å°ä¸€ç‚¹ã€é€»è¾‘å¤ªå¤æ‚äº†)..." style="flex:1; padding:5px;">
                    <button onclick="window.refineResult('stat')" style="background:#f39c12; color:white; border:none; border-radius:5px; cursor:pointer; padding:5px 15px; font-weight:bold;">ğŸ”„ è®©å®ƒæ”¹</button>
                </div>
            `;
        } else {
            // å¦‚æœå­˜åœ¨ï¼ŒæŠŠæ ·å¼ä¹Ÿç»Ÿä¸€ä¸€ä¸‹ï¼Œæ˜¾å¾—æ•´é½
            boxEl.style.cssText = "display:block; margin-top:5px; margin-bottom:15px; background:#fff7e6; padding:8px; border-radius:8px; border:1px dashed #f39c12;";
        }

        // 3. ğŸ”¥ å¼ºåˆ¶æ¬è¿ï¼šæ’åˆ° inputEl çš„å±è‚¡åé¢
        if (inputEl.nextElementSibling !== boxEl) {
            if (inputEl.parentNode) {
                // å¦‚æœåé¢å·²ç»æœ‰ä¸ªâ€œè¯´æ˜ä¹¦(ç»¿è‰²æ¡†)â€ï¼Œæ’åœ¨è¯´æ˜ä¹¦åé¢ï¼Œæˆ–è€…æ’åœ¨è¾“å…¥æ¡†åé¢
                var guideBox = document.getElementById('statGuideBox');
                if (guideBox && guideBox.parentNode === inputEl.parentNode) {
                    inputEl.parentNode.insertBefore(boxEl, guideBox.nextSibling);
                } else {
                    inputEl.parentNode.insertBefore(boxEl, inputEl.nextSibling);
                }
            }
        }
        
        // 4. å¼ºåˆ¶æ˜¾ç¤º (åªè¦æœ‰æ¡†å°±æ˜¾ç¤ºï¼Œæ–¹ä¾¿éšæ—¶æ”¹)
        boxEl.style.display = 'block';
    }

    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    setTimeout(relocateStatRefineBox, 800);
    
    // ä¸ºäº†ä¿é™©ï¼Œæ¯éš” 2ç§’ æ£€æŸ¥ä¸€æ¬¡ä½ç½® (é˜²æ­¢è¢«å…¶ä»–åˆ·æ–°é€»è¾‘è¦†ç›–)
    setInterval(relocateStatRefineBox, 2000);

    console.log("âœ… å±æ€§é¡µç¼–è¾‘æ¡†å·²å½’ä½");

})();

/* ================= ğŸš€ V25.0 è¡¥ä¸ï¼šå†›å¸ˆå¤šæ¨¡å¼ & å¤šäººä¸–ç•Œè§‚æ„å»ºç³»ç»Ÿ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V25.0ï¼šå†›å¸ˆè¿›åŒ– | å¤šäººæ¨¡å¼ | è§„èŒƒå¯¼å…¥ | è‡ªåŠ¨ä¸–ç•Œä¹¦");

    // ================= 1. è¯¦ç»†è®¾å®š -> è‡ªåŠ¨å…³è”ä¸–ç•Œä¹¦ (Requirement 1) =================
    
    // å¤‡ä»½ä¹‹å‰çš„ç”Ÿæˆå‡½æ•°
    var _oldAutoGenDesc = window.autoGenDesc;

    window.autoGenDesc = async function() {
        // å…ˆæ‰§è¡ŒåŸæœ‰çš„ç”Ÿæˆé€»è¾‘ (V17.0/V18.0 çš„é€»è¾‘)
        await _oldAutoGenDesc();

        // è®¾å®šä¸€ä¸ªå®šæ—¶å™¨æ£€æµ‹æ˜¯å¦ç”Ÿæˆå®Œæˆ (é€šè¿‡æ£€æµ‹ç¼–è¾‘æ¡†æ˜¯å¦æ˜¾ç¤º)
        // å› ä¸º _oldAutoGenDesc å†…éƒ¨ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œä¸”å¤±è´¥ä¸æŠ¥é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›‘å¬ç»“æœ
        var checkInterval = setInterval(function() {
            var refineBox = document.getElementById('refineArea_desc');
            var descVal = document.getElementById('cardDesc').value;
            
            // å¦‚æœä¿®æ”¹æ¡†å‡ºæ¥äº†ï¼Œä¸”å†…å®¹ä¸ä¸ºç©ºï¼Œè¯´æ˜ç”ŸæˆæˆåŠŸäº†
            if (refineBox && refineBox.style.display === 'block' && descVal.length > 10) {
                clearInterval(checkInterval);
                
                // ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šè¯¢é—®æ˜¯å¦ç”Ÿæˆäººè®¾ä¸–ç•Œä¹¦
                setTimeout(function() {
                    if(confirm("âœ… è¯¦ç»†è®¾å®šå·²ç”Ÿæˆï¼\n\næ˜¯å¦ç«‹å³åŸºäºæ­¤è®¾å®šï¼Œç”Ÿæˆä¸“å±çš„ã€äººè®¾ä¸–ç•Œä¹¦ã€‘(World Info)ï¼Ÿ\n(è¿™å°†æŠŠè§’è‰²çš„ç‰¹å¾å­˜å…¥ä¸–ç•Œä¹¦ï¼Œé˜²æ­¢AIé—å¿˜)")) {
                        // 1. è·³è½¬
                        if(typeof switchCardTab === 'function') switchCardTab('world');
                        
                        // 2. å¡«å…¥æŒ‡ä»¤
                        var prompt = `åŸºäºè¯¦ç»†è®¾å®šç”Ÿæˆã€äººç‰©ä¸“å±è¯æ¡ã€‘ã€‚
                        åŒ…å«ï¼šå¤–è²Œå…³é”®è¯ã€æ€§æ ¼å…³é”®è¯ã€é‡è¦èº«ä¸–ã€‚
                        è§¦å‘è¯(keys)è®¾ä¸ºè§’è‰²çš„åå­—ã€‚`;
                        document.getElementById('aiWorldPrompt').value = prompt;
                        
                        // 3. æ‰§è¡Œç”Ÿæˆ
                        if(typeof generateWorldEntry === 'function') generateWorldEntry();
                    }
                }, 500);
            }
        }, 1000);
        
        // 10ç§’ååœæ­¢æ£€æµ‹ï¼Œé˜²æ­¢æ­»å¾ªç¯
        setTimeout(() => clearInterval(checkInterval), 10000);
    };


    // ================= 2. å‰ç«¯ç¾åŒ–è§„èŒƒå¯¼å…¥ (Requirement 2) =================

    // å…¨å±€å˜é‡å­˜å‚¨è§„èŒƒ
    window.frontendStyleGuide = "";

    // A. æ’å…¥æŒ‰é’®
    function injectFrontendBtn() {
        var container = document.querySelector('#uiFrontendMode label'); // æ‰¾åˆ°â€œAI å»ºç­‘å¸ˆâ€é‚£ä¸ªæ ‡ç­¾
        if (container && !document.getElementById('btnImportGuide')) {
            var btn = document.createElement('span');
            btn.id = 'btnImportGuide';
            btn.innerHTML = "ğŸ“œ å¯¼å…¥ç¾åŒ–è§„èŒƒ";
            btn.style.cssText = "font-size:10px; background:#fff; border:1px solid #6c5ce7; color:#6c5ce7; padding:2px 8px; border-radius:4px; margin-left:10px; cursor:pointer;";
            btn.onclick = function() {
                var guide = prompt("è¯·è¾“å…¥/ç²˜è´´ä½ çš„å‰ç«¯ç¾åŒ–è§„èŒƒ (CSSè¦æ±‚/é…è‰²æ–¹æ¡ˆ/å¸ƒå±€é£æ ¼)ï¼š", window.frontendStyleGuide);
                if (guide !== null) {
                    window.frontendStyleGuide = guide;
                    auth.toast('âœ… è§„èŒƒå·²å¯¼å…¥ï¼Œä¸‹æ¬¡ç”Ÿæˆå°†ä¸¥æ ¼éµå®ˆï¼');
                }
            };
            container.appendChild(btn);
        }
    }
    // å°è¯•æ’å…¥
    setTimeout(injectFrontendBtn, 1000);

    // B. è¦†ç›–ç”Ÿæˆå‡½æ•°ï¼Œå¸¦ä¸Šè§„èŒƒ
    var _oldGenFront = window.generateFrontendCode;
    window.generateFrontendCode = async function() {
        // åŠ«æŒè¾“å…¥æ¡†
        var reqEl = document.getElementById('aiCodePrompt');
        var originalReq = reqEl.value;

        // å¦‚æœæœ‰è§„èŒƒï¼Œæ‚„æ‚„æ‹¼æ¥åˆ° Prompt é‡Œ
        if (window.frontendStyleGuide) {
            // æˆ‘ä»¬ä¸ä¿®æ”¹è¾“å…¥æ¡†æ˜¾ç¤ºçš„æ–‡å­—ï¼Œåªåœ¨å‘é€ç»™AIæ—¶ä¿®æ”¹
            // ä½†å› ä¸ºæˆ‘ä»¬å°è£…äº† fetchAIï¼Œè¿™é‡Œé‡‡ç”¨æ›´æš´åŠ›çš„åŠ«æŒæ–¹å¼ï¼š
            // ä¸´æ—¶ä¿®æ”¹è¾“å…¥æ¡†çš„å€¼ï¼Œè°ƒç”¨åŸå‡½æ•°ï¼Œç„¶åå†æ”¹å›æ¥
            reqEl.value = `${originalReq}\n\nã€å¼ºåˆ¶éµå®ˆä»¥ä¸‹UIè§„èŒƒã€‘ï¼š${window.frontendStyleGuide}`;
        }

        await _oldGenFront();

        // è¿˜åŸè¾“å…¥æ¡† (è®©ç”¨æˆ·æ„Ÿè§‰ä¸åˆ°å‘ç”Ÿäº†ä»€ä¹ˆ)
        if (window.frontendStyleGuide) {
            reqEl.value = originalReq;
        }
    };


    // ================= 3. æ·»åŠ å¤§ç±»æ ‡ç­¾ (Requirement 3) =================

    // A. æ’å…¥â€œæ·»åŠ åˆ†ç±»â€æŒ‰é’®
    function injectCategoryBtn() {
        var box = document.querySelector('.wizard-box');
        if (box && !document.getElementById('btnAddCategory')) {
            var btn = document.createElement('div');
            btn.id = 'btnAddCategory';
            btn.innerHTML = "â• æ·»åŠ æ–°åˆ†ç±» (å¦‚: ç¼ºç‚¹/é›·ç‚¹)";
            btn.style.cssText = "text-align:center; padding:10px; border:2px dashed #ddd; border-radius:10px; color:#aaa; cursor:pointer; margin-top:10px; font-size:12px; font-weight:bold;";
            
            btn.onclick = function() {
                var catName = prompt("è¯·è¾“å…¥æ–°åˆ†ç±»çš„åç§° (å¦‚: ç¼ºç‚¹):");
                if (catName) {
                    // è‹±æ–‡ Key (éšæœºç”Ÿæˆé˜²æ­¢å†²çª)
                    var key = 'custom_' + Date.now();
                    // å†™å…¥æ•°æ®æº
                    if(!window.wizardData) window.wizardData = {};
                    window.wizardData[key] = { title: `${Object.keys(window.wizardData).length + 1}. ${catName}`, tags: [] };
                    // ä¿å­˜å¹¶åˆ·æ–°
                    localStorage.setItem('my_wizard_data_v2', JSON.stringify(window.wizardData));
                    if(typeof renderWizardTags === 'function') renderWizardTags();
                    
                    // åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
                    if(!window.currentSelectedTags) window.currentSelectedTags = {};
                    window.currentSelectedTags[key] = [];
                }
            };
            
            // æ’åœ¨é‚£ä¸ªâ€œä¸€é”®ç”Ÿæˆâ€æŒ‰é’®ä¹‹å‰
            var genBtn = document.getElementById('btnOneClickGen');
            if (genBtn) box.insertBefore(btn, genBtn);
            else box.appendChild(btn);
        }
    }
    // é‡æ–°æ¸²æŸ“æ—¶ä¼šè¦†ç›–ï¼Œæ‰€ä»¥è¦åœ¨ renderWizardTags é‡Œè°ƒç”¨
    var _oldRenderTags = window.renderWizardTags;
    window.renderWizardTags = function() {
        // æ¸²æŸ“åŸæœ‰çš„ç»„
        Object.keys(window.wizardData).forEach(key => {
            // å¦‚æœè¿™ä¸ªç»„è¿˜æ²¡æœ‰å®¹å™¨ï¼Œåˆ›å»ºä¸€ä¸ª
            var containerId = 'tagGroup' + key.charAt(0).toUpperCase() + key.slice(1);
            if (!document.getElementById(containerId)) {
                var box = document.querySelector('.wizard-box');
                var genBtn = document.getElementById('btnOneClickGen') || document.getElementById('btnAddCategory'); // æ’åœ¨æŒ‰é’®å‰
                
                var title = document.createElement('div');
                title.id = 'title_' + key;
                title.className = 'tag-group-title';
                title.onclick = function() { editWizardTitle(key); };
                
                var wrapper = document.createElement('div'); // æŒ‰é’®å®¹å™¨
                wrapper.style.textAlign = 'right'; wrapper.style.marginBottom = '5px';
                wrapper.innerHTML = `<span class="add-tag-btn" onclick="addCustomWizardTag('${key}')">+åŠ æ ‡ç­¾</span>`;

                var content = document.createElement('div');
                content.id = containerId;
                content.className = 'tag-select-container';

                if(genBtn) {
                    box.insertBefore(title, genBtn);
                    box.insertBefore(wrapper, genBtn);
                    box.insertBefore(content, genBtn);
                } else {
                    box.appendChild(title); box.appendChild(wrapper); box.appendChild(content);
                }
            }
            // æ¸²æŸ“
            renderSingleGroup(key);
        });
        
        injectCategoryBtn(); // ç¡®ä¿æŒ‰é’®åœ¨æœ€å
    };


    // ================= 4 & 5. å†›å¸ˆæ¨¡å¼èœå• & å¤šäºº/ä¸–ç•Œè§‚æ¨¡å¼ (Requirement 4 & 5) =================

    // çŠ¶æ€ç®¡ç†
    window.advisorState = { mode: 'menu', multiChars: [] }; // menu, normal, expert, multi, world

    // è¦†ç›–åˆ†æå…¥å£ (ç‚¹å‡»å†›å¸ˆæ—¶)
    window.analyzeCardNeeds = function() {
        showAdvisorMenu();
    };

    // æ˜¾ç¤ºèœå•
    function showAdvisorMenu() {
        var box = document.getElementById('aiAdvisorBox');
        if(box) box.style.display = 'flex';
        var chat = document.getElementById('advisorChat');
        
        // èœå• HTML
        var menuHtml = `
            <div class="advisor-bubble" style="background:#f3f0ff;">
                <b>ğŸ§  å†›å¸ˆå·²å°±ä½ï¼Œè¯·é€‰æ‹©æ¨¡å¼ï¼š</b>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:10px;">
                    <button class="advisor-tool-btn" onclick="setAdvisorMode('normal')">ğŸŸ¢ 1. æ™®é€šæ¨¡å¼</button>
                    <button class="advisor-tool-btn" onclick="setAdvisorMode('pro')">ğŸ”´ 2. ä¸“å®¶æ¨¡å¼</button>
                    <button class="advisor-tool-btn" onclick="initMultiCharUI()">ğŸ‘¥ 3. å¤šäººæ¨¡å¼</button>
                    <button class="advisor-tool-btn" onclick="initWorldViewMode()">ğŸŒ 4. ä¸–ç•Œè§‚æ¨¡å¼</button>
                </div>
            </div>
        `;
        chat.innerHTML = menuHtml;
        window.advisorState.mode = 'menu';
    }

    // è®¾ç½®æ¨¡å¼
    window.setAdvisorMode = function(mode) {
        window.advisorState.mode = mode;
        window.advisorMode = mode; // å…¼å®¹æ—§é€»è¾‘
        
        var chat = document.getElementById('advisorChat');
        var input = document.getElementById('advisorInput');
        
        if (mode === 'normal') {
            chat.innerHTML += `<div class="advisor-bubble">ğŸŸ¢ å·²è¿›å…¥æ™®é€šæ¨¡å¼ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨çš„éœ€æ±‚ã€‚</div>`;
            input.placeholder = "ğŸŸ¢ å’Œå†›å¸ˆèŠèŠäººè®¾...";
        } else if (mode === 'pro') {
            chat.innerHTML += `<div class="advisor-bubble">ğŸ”´ å·²è¿›å…¥ä¸“å®¶æ¨¡å¼ã€‚å…¨æƒé™æŒ‡ä»¤å°±ç»ªã€‚</div>`;
            input.placeholder = "ğŸ”´ è¾“å…¥ä¿®æ”¹æŒ‡ä»¤...";
        }
    };

    // --- å¤šäººæ¨¡å¼é€»è¾‘ ---
    window.initMultiCharUI = function() {
        // å¯ä»¥åœ¨è¿™é‡Œå¼¹çª—è®©ç”¨æˆ·å¡«ï¼Œæˆ–è€…ç›´æ¥åœ¨èŠå¤©æ¡†æ˜¾ç¤º
        var count = prompt("è¯·è¾“å…¥äººæ•° (ä¾‹å¦‚: 3):");
        if (!count) return;
        
        var namesStr = prompt("è¯·è¾“å…¥æ‰€æœ‰äººçš„åå­— (ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: å¼ ä¸‰, æå››):");
        if (!namesStr) return;
        
        var names = namesStr.split(/[,ï¼Œ]/).map(n => n.trim()).filter(n => n);
        
        window.advisorState.mode = 'multi';
        window.advisorState.multiChars = names;
        
        renderMultiCharMenu();
    };

    function renderMultiCharMenu() {
        var chat = document.getElementById('advisorChat');
        var btns = window.advisorState.multiChars.map(name => {
            return `<button class="advisor-action-btn" onclick="generateCharSettings('${name}')">ğŸ‘¤ ç”Ÿæˆã€${name}ã€‘çš„è®¾å®š</button>`;
        }).join('');
        
        chat.innerHTML = `
            <div class="advisor-bubble" style="background:#e3f2fd;">
                <b>ğŸ‘¥ å¤šäººæ¨¡å¼å·²å¼€å¯</b><br>
                å½“å‰é˜Ÿåˆ—ï¼š${window.advisorState.multiChars.join(', ')}<br>
                è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œé€ä¸ªç”Ÿæˆï¼š
                ${btns}
                <br>
                <small style="color:#666">æç¤ºï¼šç”Ÿæˆå®Œè®°å¾—ç‚¹ç¡®å®š(ä¿å­˜)ï¼Œç„¶åå†ç‚¹ä¸‹ä¸€ä¸ªã€‚</small>
            </div>
        `;
    }

    window.generateCharSettings = async function(name) {
        // 1. å¡«å…¥åå­—
        document.getElementById('cardName').value = name;
        
        // 2. æ¸…ç©ºæ—§è®¾å®š
        document.getElementById('cardDesc').value = '';
        
        // 3. è¯¢é—®æ ‡ç­¾
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šè®©å†›å¸ˆæ ¹æ®åå­—è‡ªåŠ¨çŒœæ ‡ç­¾ï¼Œæˆ–è€…å¼¹çª—é—®
        // ä¸ºäº†æµç•…ä½“éªŒï¼Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨ç”Ÿæˆï¼ŒPrompté‡Œè®©AIè‡ªç”±å‘æŒ¥
        
        var chat = document.getElementById('advisorChat');
        chat.innerHTML += `<div class="ai-loading">ğŸ§  æ­£åœ¨æ„æ€ã€${name}ã€‘çš„äººè®¾...</div>`;
        
        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        var prompt = `æˆ‘æ˜¯åˆ›é€ è€…ã€‚è¯·ä¸ºå¤šäººå‰§æœ¬ä¸­çš„è§’è‰²ã€${name}ã€‘å†™ä¸€æ®µè¯¦ç»†è®¾å®š(500å­—)ã€‚çº¯æ–‡æœ¬ã€‚`;
        
        try {
            var res = await fetchAI(prompt, config);
            var cleanText = res.replace(/```/g, '').trim();
            
            document.getElementById('cardDesc').value = cleanText;
            
            // 4. æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
            chat.innerHTML += `
                <div class="advisor-bubble">
                    âœ… ã€${name}ã€‘è®¾å®šå·²ç”Ÿæˆï¼è¯·æ£€æŸ¥å·¦ä¾§ã€‚<br>
                    <button class="advisor-action-btn" onclick="confirmCharAndGenLore('${name}')">
                        ğŸ’¾ ç¡®å®š (å¹¶ç”Ÿæˆä¸“å±ä¸–ç•Œä¹¦)
                    </button>
                </div>
            `;
            
            // åˆ‡æ¢åˆ°é¢„è§ˆé¡µçœ‹æ•ˆæœ
            if(typeof switchCardTab === 'function') switchCardTab('preview');
            
        } catch(e) {
            alert("ç”Ÿæˆå¤±è´¥");
        }
    };

    window.confirmCharAndGenLore = async function(name) {
        // 1. è‡ªåŠ¨ç”Ÿæˆä¸–ç•Œä¹¦
        if(typeof switchCardTab === 'function') switchCardTab('world');
        document.getElementById('aiWorldPrompt').value = `ä¸ºè§’è‰²ã€${name}ã€‘ç”Ÿæˆä¸“å±World Infoè®¾å®šï¼Œå†…å®¹åŸºäºå½“å‰çš„è¯¦ç»†è®¾å®šã€‚`;
        await generateWorldEntry();
        
        // 2. æç¤ºä¸‹ä¸€æ­¥
        var chat = document.getElementById('advisorChat');
        chat.innerHTML += `<div class="advisor-bubble">ğŸ‰ ã€${name}ã€‘å¤„ç†å®Œæ¯•ï¼è¯·ç»§ç»­ç‚¹å‡»ä¸Šé¢èœå•é€‰æ‹©ä¸‹ä¸€ä¸ªäººã€‚</div>`;
    };


    // --- ä¸–ç•Œè§‚æ¨¡å¼é€»è¾‘ ---
    window.initWorldViewMode = function() {
        window.advisorState.mode = 'world_view';
        var chat = document.getElementById('advisorChat');
        chat.innerHTML = `
            <div class="advisor-bubble" style="background:#e8f5e9;">
                <b>ğŸŒ ä¸–ç•Œè§‚æ„å»ºæ¨¡å¼</b><br>
                è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†å‘Šè¯‰æˆ‘ï¼Œä½ æƒ³è¦ä»€ä¹ˆæ ·çš„ä¸–ç•Œè§‚ï¼Ÿ<br>
                (ä¾‹å¦‚ï¼šèµ›åšæœ‹å…‹+ä¿®ä»™ï¼Œæˆ–è€…æ˜¯å…‹è‹é²é£æ ¼çš„æ ¡å›­)
            </div>
        `;
    };

    // æ‹¦æˆªå‘é€æ¶ˆæ¯ï¼Œå¤„ç†ä¸–ç•Œè§‚è¯·æ±‚
    var _oldSend = window.sendAdvisorMsg;
    window.sendAdvisorMsg = async function() {
        // å¦‚æœæ˜¯ä¸–ç•Œè§‚æ¨¡å¼
        if (window.advisorState.mode === 'world_view') {
            var input = document.getElementById('advisorInput');
            var text = input.value.trim();
            if(!text) return;
            
            // ç”¨æˆ·ä¸Šå±
            var chat = document.getElementById('advisorChat');
            chat.innerHTML += `<div style="text-align:right; margin:5px; padding:5px; background:#eee; border-radius:5px; display:inline-block; margin-left:auto;">${text}</div><div style="clear:both"></div>`;
            input.value = '';
            
            chat.insertAdjacentHTML('beforeend', `<div class="ai-loading">ğŸ§  æ­£åœ¨æ„ç­‘å®å¤§ä¸–ç•Œ... (ç”Ÿæˆ3ä¸ªæ–¹æ¡ˆ)</div>`);
            
            var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
            
            // Prompt: ç”Ÿæˆ3ä¸ªæ–¹æ¡ˆï¼Œè¿”å›JSON
            var prompt = `
            ç”¨æˆ·æƒ³è¦çš„ä¸–ç•Œè§‚ï¼š${text}ã€‚
            è¯·æä¾› 3 ä¸ªä¸å°‘äº 100 å­—çš„å…·ä½“ä¸–ç•Œè§‚å»ºè®®ï¼ˆæ–¹æ¡ˆï¼‰ã€‚
            
            è¿”å›çº¯ JSON æ•°ç»„ï¼š
            [
                { "title": "æ–¹æ¡ˆä¸€æ ‡é¢˜", "content": "100å­—ä»¥ä¸Šçš„è¯¦ç»†æè¿°..." },
                { "title": "æ–¹æ¡ˆäºŒæ ‡é¢˜", "content": "..." },
                { "title": "æ–¹æ¡ˆä¸‰æ ‡é¢˜", "content": "..." }
            ]
            `;
            
            try {
                var res = await fetchAI(prompt, config);
                var data = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());
                
                chat.innerHTML = ''; // æ¸…å±
                
                data.forEach(item => {
                    // å®‰å…¨è½¬ä¹‰å†…å®¹
                    var safeContent = encodeURIComponent(item.content);
                    
                    chat.innerHTML += `
                        <div class="advisor-bubble">
                            <b style="color:#d35400">ğŸŒ ${item.title}</b>
                            <div style="font-size:12px; margin:5px 0; max-height:100px; overflow-y:auto;">${item.content}</div>
                            <button class="advisor-action-btn" onclick="applyWorldView('${safeContent}')">
                                ğŸ‘‰ é‡‡ç”¨æ­¤æ–¹æ¡ˆ (ç”Ÿæˆä¸–ç•Œä¹¦)
                            </button>
                        </div>
                    `;
                });
                
            } catch(e) {
                chat.innerHTML += `<div class="advisor-bubble">âŒ ç”Ÿæˆå¤±è´¥: ${e.message}</div>`;
            }
            return; // æ‹¦æˆªç»“æŸ
        }
        
        // å¦åˆ™èµ°æ™®é€š/ä¸“å®¶/å¤šäººæ¨¡å¼é€»è¾‘
        // æ³¨æ„ï¼šå¤šäººæ¨¡å¼ä¹Ÿåœ¨ Menu é‡Œï¼Œä¸éœ€è¦æ‹¦æˆª sendMsgï¼Œå› ä¸ºå®ƒæ˜¯ç‚¹æŒ‰é’®è§¦å‘çš„
        _oldSend();
    };

    window.applyWorldView = function(encodedContent) {
        var content = decodeURIComponent(encodedContent);
        
        // è·³è½¬åˆ°ä¸–ç•Œä¹¦é¡µ
        if(typeof switchCardTab === 'function') switchCardTab('world');
        
        // å¡«å…¥
        document.getElementById('aiWorldPrompt').value = `åˆ›å»ºä¸€ä¸ªæ ¸å¿ƒä¸–ç•Œè§‚æ¡ç›®ï¼Œå†…å®¹å¦‚ä¸‹ï¼š${content}`;
        
        // è‡ªåŠ¨ç”Ÿæˆ
        if(typeof generateWorldEntry === 'function') generateWorldEntry();
        
        auth.toast('ğŸŒ ä¸–ç•Œè§‚å·²å¼€å§‹æ„ç­‘...');
    };

})();

/* ================= ğŸ“‚ V25.1 è¡¥ä¸ï¼šç¾åŒ–è§„èŒƒæ–‡ä»¶å¯¼å…¥ç³»ç»Ÿ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V25.1ï¼šç¾åŒ–è§„èŒƒå·²å‡çº§ä¸ºã€æ–‡ä»¶å¯¼å…¥ã€‘æ¨¡å¼...");

    // å…¨å±€å˜é‡å­˜å‚¨è§„èŒƒå†…å®¹
    window.frontendStyleGuide = "";

    // 1. ğŸ› ï¸ é‡å†™æŒ‰é’®æ³¨å…¥é€»è¾‘ (ç§»é™¤æ—§æŒ‰é’®ï¼Œæ¢æˆæ–‡ä»¶ä¸Šä¼ ç‰ˆ)
    function upgradeFrontendBtn() {
        var container = document.querySelector('#uiFrontendMode label'); // æ‰¾åˆ°â€œAI å»ºç­‘å¸ˆâ€é‚£ä¸ªæ ‡ç­¾
        if (!container) return;

        // å¦‚æœæ—§æŒ‰é’®å­˜åœ¨ï¼Œå…ˆåˆ æ‰ï¼Œé˜²æ­¢é‡å¤
        var oldBtn = document.getElementById('btnImportGuide');
        if (oldBtn) oldBtn.remove();

        // --- A. åˆ›å»ºå¯è§æŒ‰é’® ---
        var btn = document.createElement('span');
        btn.id = 'btnImportGuide';
        btn.innerHTML = "ğŸ“‚ å¯¼å…¥ç¾åŒ–æ–‡ä»¶ (CSS/TXT)";
        btn.style.cssText = "font-size:10px; background:#fff; border:1px solid #6c5ce7; color:#6c5ce7; padding:3px 8px; border-radius:4px; margin-left:10px; cursor:pointer; font-weight:normal;";
        
        // ç‚¹å‡»æŒ‰é’® -> è§¦å‘æ–‡ä»¶é€‰æ‹©
        btn.onclick = function() {
            document.getElementById('styleGuideFileInput').click();
        };

        // --- B. åˆ›å»ºéšå½¢æ–‡ä»¶è¾“å…¥æ¡† ---
        var fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.id = 'styleGuideFileInput';
        fileInput.style.display = 'none';
        // ä¸é™åˆ¶æ–‡ä»¶ç±»å‹ (accept ç•™ç©º)
        
        // --- C. æ–‡ä»¶è¯»å–é€»è¾‘ ---
        fileInput.onchange = function(e) {
            var file = e.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            
            // è®¾å®šå›è°ƒï¼šè¯»å–æˆåŠŸåæ‰§è¡Œ
            reader.onload = function(evt) {
                // 1. è·å–æ–‡ä»¶å†…å®¹
                var content = evt.target.result;
                
                // 2. å­˜å…¥å…¨å±€å˜é‡
                window.frontendStyleGuide = content;
                
                // 3. ç•Œé¢åé¦ˆ
                if(window.auth && window.auth.toast) {
                    window.auth.toast(`âœ… è§„èŒƒæ–‡ä»¶ã€${file.name}ã€‘å·²åŠ è½½ï¼`);
                } else {
                    alert(`âœ… è§„èŒƒæ–‡ä»¶ã€${file.name}ã€‘å·²åŠ è½½ï¼`);
                }

                // 4. æŒ‰é’®å˜è‰²ï¼Œæç¤ºå·²åŠ è½½
                btn.innerHTML = `ğŸ“„ ä½¿ç”¨è§„èŒƒ: ${file.name}`;
                btn.style.background = "#e0c3fc";
                btn.style.color = "#fff";
                btn.style.borderColor = "#a29bfe";
                btn.title = "ç‚¹å‡»å¯æ›´æ¢æ–‡ä»¶";
                
                console.log("å·²åŠ è½½ç¾åŒ–è§„èŒƒé•¿åº¦:", content.length);
            };

            // å¼€å§‹è¯»å– (ä½œä¸ºæ–‡æœ¬è¯»å–ï¼Œæ— è®ºä»€ä¹ˆåç¼€)
            reader.readAsText(file);
            
            // æ¸…ç©º valueï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€ä¸ªæ–‡ä»¶
            this.value = '';
        };

        // æ’å…¥ DOM
        container.appendChild(btn);
        container.appendChild(fileInput);
    }

    // ç«‹å³æ‰§è¡Œæ›¿æ¢
    setTimeout(upgradeFrontendBtn, 1000);
    // ä¿é™©èµ·è§ï¼Œå†æ‰§è¡Œä¸€æ¬¡ (é˜²æ­¢ Tab åˆ‡æ¢å¯¼è‡´å…ƒç´ é‡å»º)
    setInterval(function() {
        if (!document.getElementById('btnImportGuide')) {
            upgradeFrontendBtn();
        }
    }, 2000);


    // 2. ğŸ”¥ è¦†ç›–ç”Ÿæˆå‡½æ•°ï¼šå¼ºåˆ¶å¸¦ä¸Šæ–‡ä»¶å†…å®¹
    var _oldGenFront = window.generateFrontendCode;
    window.generateFrontendCode = async function() {
        var reqEl = document.getElementById('aiCodePrompt');
        if (!reqEl) return;

        var originalReq = reqEl.value; // ç”¨æˆ·è¾“å…¥çš„éœ€æ±‚
        var finalPrompt = originalReq;

        // ğŸ”¥ æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœæœ‰å¯¼å…¥çš„æ–‡ä»¶ï¼Œæ‹¼æ¥åˆ° Prompt é‡Œ
        if (window.frontendStyleGuide && window.frontendStyleGuide.length > 0) {
            console.log("ğŸ¨ æ­£åœ¨åº”ç”¨æ–‡ä»¶ä¸­çš„ç¾åŒ–è§„èŒƒ...");
            
            // æ„é€ æ›´å¼ºçš„æç¤ºè¯
            finalPrompt = `
${originalReq}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš¨ ã€æœ€é«˜ä¼˜å…ˆçº§ UI è®¾è®¡è§„èŒƒã€‘ ğŸš¨
è¯·å®Œå…¨å¿½ç•¥ä½ é»˜è®¤çš„æ ·å¼ä¹ æƒ¯ï¼Œ**ä¸¥æ ¼æŒ‰ç…§**ä»¥ä¸‹æ–‡ä»¶çš„ä»£ç é£æ ¼ã€é…è‰²å˜é‡å’Œå¸ƒå±€é€»è¾‘æ¥ç¼–å†™ä»£ç ï¼š

\`\`\`css
${window.frontendStyleGuide.substring(0, 5000)} 
\`\`\`
(ä»¥ä¸Šæ˜¯æ ·å¼è§„èŒƒæ–‡ä»¶å†…å®¹ï¼Œè¯·æå–å…¶ä¸­çš„è®¾è®¡è¯­è¨€å¹¶åº”ç”¨åˆ°æœ¬æ¬¡ç”Ÿæˆä¸­)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            `;
            
            // ä¸´æ—¶ä¿®æ”¹è¾“å…¥æ¡†çš„å€¼ï¼Œæ¬ºéª—åç»­çš„ fetchAI å‡½æ•°
            reqEl.value = finalPrompt;
        }

        // è°ƒç”¨ä¹‹å‰çš„ç”Ÿæˆé€»è¾‘
        if (_oldGenFront) {
            await _oldGenFront();
        } else {
            // å¦‚æœæ—§å‡½æ•°ä¸å­˜åœ¨ï¼ˆæå°‘æƒ…å†µï¼‰ï¼Œè¿™é‡Œç›´æ¥å¼¹çª—æç¤º
            alert("è¯·å…ˆåŠ è½½ä¹‹å‰çš„ç”Ÿæˆé€»è¾‘è¡¥ä¸");
        }

        // è¿˜åŸè¾“å…¥æ¡† (è®©ç”¨æˆ·ç•Œé¢ä¿æŒæ•´æ´ï¼Œä¸æ˜¾ç¤ºé‚£ä¸€å¤§å¨æ–‡ä»¶å†…å®¹)
        if (window.frontendStyleGuide) {
            reqEl.value = originalReq;
        }
    };

})();

/* ================= âœ… V25.2 è¡¥ä¸ï¼šè®¾å®šç¡®è®¤æŒ‰é’® & æµç¨‹ä¼˜åŒ– ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V25.2ï¼šæ·»åŠ ã€ç¡®å®šè®¾å®šã€‘æŒ‰é’®ï¼Œç§»é™¤è‡ªåŠ¨å¼¹çª—...");

    // ================= 1. å®šä¹‰æ ¸å¿ƒé€»è¾‘ï¼šç‚¹å‡»ç¡®å®šååšä»€ä¹ˆ =================
    window.confirmDescAndGenLore = function() {
        var desc = document.getElementById('cardDesc').value.trim();
        var name = document.getElementById('cardName').value.trim();

        // 1. æ ¡éªŒ
        if (desc.length < 10) {
            alert("âš ï¸ è¯¦ç»†è®¾å®šå¤ªçŸ­äº†ï¼Œè¯·å…ˆç”Ÿæˆæˆ–æ‰‹å†™ä¸€ç‚¹å†…å®¹å§ï¼");
            return;
        }

        // 2. è§†è§‰åé¦ˆ (é—ªçƒä¸€ä¸‹è¡¨ç¤ºç¡®è®¤)
        var descBox = document.getElementById('cardDesc');
        var oldBg = descBox.style.backgroundColor;
        descBox.style.transition = "background 0.3s";
        descBox.style.backgroundColor = "#d4edda"; // å˜ç»¿
        setTimeout(() => descBox.style.backgroundColor = oldBg, 500);

        // 3. è¯¢é—®æµç¨‹
        if (confirm(`âœ… è®¾å®šå·²ç¡®è®¤ï¼\n\næ˜¯å¦ç«‹å³åŸºäºã€${name}ã€‘çš„è¿™æ®µè®¾å®šï¼Œç”Ÿæˆä¸“å±çš„ã€äººè®¾ä¸–ç•Œä¹¦ã€‘(World Info)ï¼Ÿ\n\n(è¿™å°†æŠŠå¤–è²Œã€æ€§æ ¼å­˜å…¥ä¸–ç•Œä¹¦ï¼Œé˜²æ­¢AIé—å¿˜)`)) {
            
            // A. è·³è½¬åˆ°ä¸–ç•Œä¹¦é¡µ
            if(typeof switchCardTab === 'function') switchCardTab('world');
            
            // B. è‡ªåŠ¨å¡«å…¥ç²¾å‡†æŒ‡ä»¤
            // æ—¢ç„¶å·²ç»ç¡®è®¤äº†è®¾å®šï¼Œæˆ‘ä»¬å°±æŠŠè¿™æ®µè®¾å®šä½œä¸ºâ€œç»å¯¹çœŸç†â€å–‚ç»™ AI
            var prompt = `
è¯·åŸºäºä»¥ä¸‹ã€ç»è¿‡ç¡®è®¤çš„è¯¦ç»†è®¾å®šã€‘ï¼Œç”Ÿæˆä¸€ä¸ªã€äººç‰©ä¸“å± World Info æ¡ç›®ã€‘ã€‚

ã€è§’è‰²åã€‘ï¼š${name}
ã€è¯¦ç»†è®¾å®šã€‘ï¼š${desc.substring(0, 800)}...

è¦æ±‚ï¼š
1. Comment (å¤‡æ³¨) å¡« "${name} - æ ¸å¿ƒè®¾å®š"ã€‚
2. Keys (è§¦å‘è¯) å¡« "${name}, ä½ , æˆ‘, ${name}çš„åå­—"ã€‚
3. Content (å†…å®¹) è¯·æç‚¼è®¾å®šä¸­çš„ã€å¤–è²Œç‰¹å¾ã€‘ã€ã€æ€§æ ¼å…³é”®è¯ã€‘ã€ã€é‡è¦èº«ä¸–ã€‘ï¼Œåˆå¹¶æˆä¸€æ®µç²¾ç®€çš„æè¿°ã€‚
`;
            document.getElementById('aiWorldPrompt').value = prompt;
            
            // C. æ»šåŠ¨åˆ°ç”ŸæˆåŒº
            document.getElementById('aiWorldPrompt').scrollIntoView({behavior: "smooth", block: "center"});

            // D. è‡ªåŠ¨æ‰§è¡Œç”Ÿæˆ
            if(typeof generateWorldEntry === 'function') {
                // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œè®©ç”¨æˆ·çœ‹åˆ°è·³è½¬è¿‡ç¨‹
                if(window.auth && window.auth.toast) window.auth.toast('ğŸš€ æ­£åœ¨è·³è½¬å¹¶ç”Ÿæˆ...');
                setTimeout(generateWorldEntry, 800);
            }
        }
    };

    // ================= 2. UI æ³¨å…¥ï¼šæ·»åŠ æŒ‰é’® =================
    function injectConfirmBtn() {
        var descBox = document.getElementById('cardDesc');
        if (!descBox) return;

        // é˜²æ­¢é‡å¤æ·»åŠ 
        if (document.getElementById('btnConfirmDesc')) return;

        // åˆ›å»ºæŒ‰é’®å®¹å™¨ (æ”¾åœ¨ textarea ä¸‹é¢)
        var btnContainer = document.createElement('div');
        btnContainer.style.marginTop = "5px";
        btnContainer.style.marginBottom = "15px";
        btnContainer.style.textAlign = "right"; // é å³æ”¾

        // åˆ›å»ºæŒ‰é’®
        var btn = document.createElement('button');
        btn.id = 'btnConfirmDesc';
        btn.className = 'small-btn'; 
        btn.innerHTML = "âœ… ç¡®å®šè®¾å®š (å¹¶ç”Ÿæˆä¸–ç•Œä¹¦)";
        // æ ·å¼ï¼šç»¿è‰²é†’ç›®
        btn.style.cssText = "background:linear-gradient(135deg, #00b894, #00cec9); color:white; border:none; padding:8px 20px; border-radius:20px; font-weight:bold; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.1);";
        
        btn.onclick = window.confirmDescAndGenLore;

        btnContainer.appendChild(btn);

        // æ’å…¥åˆ° textarea åé¢
        // å¦‚æœ textarea åé¢æœ‰äºŒæ¬¡ç¼–è¾‘æ¡† (refineArea)ï¼Œæ’åœ¨ç¼–è¾‘æ¡†åé¢æ›´åˆç†
        var refineBox = document.getElementById('refineArea_desc');
        if (refineBox) {
            refineBox.parentNode.insertBefore(btnContainer, refineBox.nextSibling);
        } else {
            descBox.parentNode.insertBefore(btnContainer, descBox.nextSibling);
        }
    }

    // ç«‹å³æ‰§è¡Œæ³¨å…¥ï¼Œå¹¶å¯åŠ¨å®šæ—¶å™¨é˜²æ­¢è¢«é¡µé¢é‡ç»˜è¦†ç›–
    injectConfirmBtn();
    setInterval(injectConfirmBtn, 2000);


    // ================= 3. é€»è¾‘è¦†ç›–ï¼šç§»é™¤ V25.0 çš„è‡ªåŠ¨å¼¹çª— =================
    // æˆ‘ä»¬é‡å†™ autoGenDescï¼Œå»æ‰æœ€åçš„ confirm é€»è¾‘ï¼Œåªä¿ç•™ç”Ÿæˆé€»è¾‘
    
    window.autoGenDesc = async function() {
        var name = document.getElementById('cardName').value.trim();
        if (!name) { 
            if(window.auth && window.auth.toast) window.auth.toast('å…ˆç»™è§’è‰²èµ·ä¸ªåå­—å§ï¼'); 
            return; 
        }
        
        // è·å–æ ‡ç­¾
        var tagStr = "æ— ";
        if(window.currentSelectedTags) {
            var allTags = [
                ...window.currentSelectedTags.identity, 
                ...window.currentSelectedTags.personality, 
                ...window.currentSelectedTags.trope
            ];
            tagStr = allTags.join('ã€');
        }

        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        if (!config || !config.apiKey) { 
            if(window.auth && window.auth.toast) window.auth.toast('âš ï¸ æœªå¡«API Key');
            // æ²¡keyä¹Ÿæ˜¾ç¤ºç¼–è¾‘æ¡†ï¼Œæ–¹ä¾¿æ‰‹åŠ¨å†™
            var refineBox = document.getElementById('refineArea_desc');
            if(refineBox) refineBox.style.display = 'block';
            return; 
        }

        var btn = event.target;
        var oldText = btn.innerText;
        btn.innerText = 'âœï¸ æ­£åœ¨å†™...'; btn.style.pointerEvents = 'none';

        var prompt = `æˆ‘æ˜¯åˆ›é€ è€…ã€‚è¯·ä¸ºè§’è‰²ã€${name}ã€‘å†™ä¸€æ®µâ€œè¯¦ç»†è®¾å®šâ€ã€‚
        ã€å¼ºåˆ¶è¦æ±‚ã€‘ï¼šå¿…é¡»åŸºäºè¿™äº›å±æ€§ç”Ÿæˆï¼š${tagStr}ã€‚
        åŒ…å«å¤–è²Œã€æ€§æ ¼ã€èº«ä¸–ã€‚300å­—å·¦å³ã€‚ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬ã€‚`;

        try {
            var res = await fetchAI(prompt, config);
            var cleanText = res.replace(/```/g, '').trim();
            
            // å¡«å…¥
            document.getElementById('cardDesc').value = cleanText;
            
            // å­˜å…¥ç¼“å­˜
            if (!window.lastGeneratedData) window.lastGeneratedData = {};
            window.lastGeneratedData.desc = cleanText;
            
            // æ˜¾ç¤ºäºŒæ¬¡ç¼–è¾‘æ¡†
            var refineBox = document.getElementById('refineArea_desc');
            if(refineBox) refineBox.style.display = 'block';

            if(typeof updateJsonSource === 'function') updateJsonSource();
            
            // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šè¿™é‡Œä¸å†å¼¹çª—ï¼Œè€Œæ˜¯æç¤ºç”¨æˆ·å»ç‚¹ç¡®å®š
            if(window.auth && window.auth.toast) window.auth.toast('âœ… è®¾å®šç”Ÿæˆå®Œæ¯•ï¼è¯·æ£€æŸ¥å†…å®¹ï¼Œæ»¡æ„åç‚¹å‡»ã€ç¡®å®šè®¾å®šã€‘');
            
            // é«˜äº®ç¡®å®šæŒ‰é’®ï¼Œå¼•å¯¼ç”¨æˆ·
            var confirmBtn = document.getElementById('btnConfirmDesc');
            if(confirmBtn) {
                confirmBtn.innerHTML = "âœ¨ è¯·ç‚¹å‡»æ­¤å¤„ç¡®è®¤";
                confirmBtn.style.transform = "scale(1.1)";
                setTimeout(() => {
                    confirmBtn.innerHTML = "âœ… ç¡®å®šè®¾å®š (å¹¶ç”Ÿæˆä¸–ç•Œä¹¦)";
                    confirmBtn.style.transform = "scale(1)";
                }, 2000);
            }

        } catch (e) {
            console.error(e);
            if(window.auth && window.auth.toast) window.auth.toast('âŒ ç”Ÿæˆå‡ºé”™ï¼Œè¯·é‡è¯•');
        } finally {
            btn.innerText = oldText; btn.style.pointerEvents = 'auto';
        }
    };

})();

/* ================= ğŸ”“ V26.0 è¡¥ä¸ï¼šæ— é—¨æ§›å¬å”¤å†›å¸ˆ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V26.0ï¼šå·²ç§»é™¤å†›å¸ˆæ‰“å¼€é™åˆ¶ï¼Œå…è®¸ç©ºå¡æ“ä½œ...");

    // 1. è¦†ç›–ï¼šå¼ºåˆ¶æ‰“å¼€å†›å¸ˆçª—å£ (æ— è§†å­—æ•°ï¼Œæ— è§†å†…å®¹)
    window.forceOpenAdvisor = function() {
        var box = document.getElementById('aiAdvisorBox');
        if (!box) {
            alert("âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°å†›å¸ˆçª—å£ (id='aiAdvisorBox')");
            return;
        }

        // å¼ºåˆ¶æ˜¾ç¤º
        box.style.display = 'flex';
        
        // å¦‚æœåŠ è½½äº† V25.0 çš„èœå•åŠŸèƒ½ï¼Œç›´æ¥æ˜¾ç¤ºèœå•
        if (typeof showAdvisorMenu === 'function') {
            showAdvisorMenu();
        } else {
            // ä¿åº•é€»è¾‘
            var chat = document.getElementById('advisorChat');
            chat.innerHTML = `<div class="advisor-bubble">ğŸ§  å†›å¸ˆå·²å°±ä½ã€‚è¯·é—®ä¸»å…¬æœ‰ä½•å©å’ï¼Ÿ</div>`;
        }
        
        // è§†è§‰åé¦ˆ
        if(window.auth && window.auth.toast) window.auth.toast('ğŸ§  å†›å¸ˆå·²å°±ä½ (æ— é—¨æ§›æ¨¡å¼)');
    };

    // 2. è¦†ç›–ï¼šæ—§çš„åˆ†æå…¥å£ (é˜²æ­¢æ—§ä»£ç é˜»æ‹¦)
    window.analyzeCardNeeds = function() {
        // ç›´æ¥è½¬æ¥åˆ°å¼ºåˆ¶æ‰“å¼€å‡½æ•°
        window.forceOpenAdvisor();
    };

    // 3. è¦†ç›–ï¼šè‡ªåŠ¨æ£€æµ‹å…¥å£
    window.checkAndOpenAdvisor = function(isForce) {
        // å¦‚æœæ˜¯å¼ºåˆ¶ (isForce)ï¼Œæˆ–è€…çª—å£å·²ç»æ˜¯å¼€ç€çš„ï¼Œå°±åˆ·æ–°ä¸€ä¸‹
        // å¦‚æœæ˜¯è‡ªåŠ¨æ£€æµ‹ (æ¯”å¦‚åˆšç”Ÿæˆå®Œè®¾å®š)ï¼Œæˆ‘ä»¬ä¸å†å¼ºåˆ¶å¼¹çª—ï¼Œä»¥å…æ‰“æ‰°ä½ æ‰‹åŠ¨æ“ä½œ
        // è¿™é‡Œä¸»è¦æœåŠ¡äºâ€œä¸€é”®ç”Ÿæˆâ€åçš„é€»è¾‘
        var box = document.getElementById('aiAdvisorBox');
        if (isForce && box) {
            box.style.display = 'flex';
        }
    };

    // 4. ç¡®ä¿æŒ‰é’®ç»‘å®šäº†æ–°çš„æ— é—¨æ§›å‡½æ•°
    // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œé˜²æ­¢è¢«å…¶ä»–è¡¥ä¸è¦†ç›–å›å»
    setInterval(function() {
        var btn = document.querySelector('button[onclick*="forceOpenAdvisor"]'); 
        // ä¹Ÿå°±æ˜¯é‚£ä¸ªâ€œğŸ§  å¬å”¤å†›å¸ˆâ€æŒ‰é’®
        if (btn && btn.onclick !== window.forceOpenAdvisor) {
            btn.onclick = window.forceOpenAdvisor;
        }
    }, 1000);

    console.log("âœ… é™åˆ¶å·²è§£é™¤ï¼šç°åœ¨å¯ä»¥å…ˆå¼€å†›å¸ˆï¼Œå†å†™äººè®¾äº†");

})();

/* ================= ğŸ“ V28.0 è¡¥ä¸ï¼šæŒ‰é’®å½’ä½ä¿®æ­£ (ä¿®å¤æ ‡ç­¾é”™ä½) ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V28.0ï¼šæ­£åœ¨å°†æŒ‰é’®èåˆè¿›æ ‡é¢˜æ ...");

    // 1. æ ¸å¿ƒé€»è¾‘ (ä¿æŒä¸å˜)
    window.confirmDescAndGenLore = function(e) {
        // é˜²æ­¢ç‚¹å‡»ç©¿é€è§¦å‘å…¶ä»–æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
        if(e) e.stopPropagation(); 

        var desc = document.getElementById('cardDesc').value.trim();
        var name = document.getElementById('cardName').value.trim();

        if (desc.length < 10) {
            alert("âš ï¸ è¯¦ç»†è®¾å®šå¤ªçŸ­äº†ï¼Œè¯·å…ˆç”Ÿæˆæˆ–æ‰‹å†™ä¸€ç‚¹å†…å®¹å§ï¼");
            return;
        }

        // è§†è§‰åé¦ˆ
        var descBox = document.getElementById('cardDesc');
        var oldBg = descBox.style.backgroundColor;
        descBox.style.transition = "background 0.3s";
        descBox.style.backgroundColor = "#d4edda"; 
        setTimeout(() => descBox.style.backgroundColor = oldBg, 500);

        if (confirm(`âœ… è®¾å®šå·²ç¡®è®¤ï¼\n\næ˜¯å¦ç«‹å³åŸºäºã€${name}ã€‘çš„è¿™æ®µè®¾å®šï¼Œç”Ÿæˆä¸“å±çš„ã€äººè®¾ä¸–ç•Œä¹¦ã€‘(World Info)ï¼Ÿ`)) {
            if(typeof switchCardTab === 'function') switchCardTab('world');
            var prompt = `è¯·åŸºäºä»¥ä¸‹ã€ç»è¿‡ç¡®è®¤çš„è¯¦ç»†è®¾å®šã€‘ï¼Œç”Ÿæˆä¸€ä¸ªã€äººç‰©ä¸“å± World Info æ¡ç›®ã€‘ã€‚\nã€è§’è‰²åã€‘ï¼š${name}\nã€è¯¦ç»†è®¾å®šã€‘ï¼š${desc.substring(0, 800)}...\nè¦æ±‚ï¼š\n1. Comment å¡« "${name} - æ ¸å¿ƒè®¾å®š"ã€‚\n2. Keys å¡« "${name}, ä½ , æˆ‘"ã€‚\n3. Content æç‚¼å¤–è²Œã€æ€§æ ¼ã€èº«ä¸–ã€‚`;
            var promptEl = document.getElementById('aiWorldPrompt');
            if(promptEl) { promptEl.value = prompt; promptEl.scrollIntoView({behavior: "smooth", block: "center"}); }
            if(typeof generateWorldEntry === 'function') {
                if(window.auth && window.auth.toast) window.auth.toast('ğŸš€ æ­£åœ¨è·³è½¬å¹¶ç”Ÿæˆ...');
                setTimeout(generateWorldEntry, 800);
            }
        }
    };

    // 2. UI æ³¨å…¥ï¼šèåˆè¿› Label
    function fixButtonPosition() {
        var descBox = document.getElementById('cardDesc');
        if (!descBox) return;

        // A. æ‰¾åˆ° Label (é€šå¸¸æ˜¯è¾“å…¥æ¡†çš„å‰ä¸€ä¸ªå…ƒç´ )
        var label = descBox.previousElementSibling;
        
        // å¦‚æœå‰ä¸€ä¸ªä¸æ˜¯ label (å¯èƒ½è¢«ä¹‹å‰çš„è¡¥ä¸æ’äº†åˆ«çš„ä¸œè¥¿)ï¼Œå°è¯•å¾€ä¸Šæ‰¾æ‰¾
        if (!label || label.tagName !== 'LABEL') {
            // å¦‚æœçˆ¶çº§æ˜¯ field-groupï¼Œé‚£ label åº”è¯¥æ˜¯çˆ¶çº§çš„ç¬¬ä¸€ä¸ªå­å…ƒç´ 
            if (descBox.parentNode.className.includes('field-group') || descBox.parentNode.className.includes('wrapper')) {
                label = descBox.parentNode.querySelector('label');
            }
        }

        if (!label) return; // æ‰¾ä¸åˆ°æ ‡ç­¾å°±ç®—äº†ï¼Œé˜²æ­¢æŠ¥é”™

        // B. æ¸…ç†æ—§æŒ‰é’® (ä¸è®ºåœ¨å“ªé‡Œ)
        var oldBtn = document.getElementById('btnConfirmDesc');
        if (oldBtn) oldBtn.remove();
        // æ¸…ç†æ—§çš„å®¹å™¨ (V27äº§ç”Ÿçš„ flex å®¹å™¨)
        var prev = descBox.previousElementSibling;
        if (prev && prev.tagName === 'DIV' && prev.style.display === 'flex' && !prev.classList.contains('field-group-fixed')) {
            prev.remove();
        }

        // C. åˆ›å»ºæ–°æŒ‰é’®
        var btn = document.createElement('span'); // ç”¨ span é˜²æ­¢æ¢è¡Œ
        btn.id = 'btnConfirmDesc';
        btn.innerHTML = "âœ… ç¡®å®šè®¾å®š (å¹¶ç”Ÿæˆä¸–ç•Œä¹¦)";
        btn.style.cssText = "float: right; font-size: 11px; background: #00b894; color: white; padding: 2px 10px; border-radius: 10px; cursor: pointer; font-weight: bold; margin-left: 10px; transform: translateY(-2px);";
        btn.onclick = window.confirmDescAndGenLore;

        // D. æ’å…¥åˆ° Label å†…éƒ¨
        // ç¡®ä¿ Label æ˜¯å—çº§æˆ– flexï¼Œèƒ½å®¹çº³æµ®åŠ¨æˆ–å³å¯¹é½
        label.style.display = "block"; 
        label.style.width = "100%";
        
        // é‡ç½®ä¸€ä¸‹ Label æ–‡å­—ï¼Œé˜²æ­¢é‡å¤æ·»åŠ 
        // è¿™é‡Œå‡è®¾åŸæ¥çš„æ–‡å­—æ˜¯ "ğŸ“ è¯¦ç»†è®¾å®š (Description)"
        // æˆ‘ä»¬åªä¿ç•™æ–‡æœ¬èŠ‚ç‚¹ï¼Œå»æ‰æ—§çš„å­å…ƒç´ 
        var textOnly = label.innerText.replace("âœ… ç¡®å®šè®¾å®š (å¹¶ç”Ÿæˆä¸–ç•Œä¹¦)", "").trim();
        label.innerHTML = textOnly; 
        
        // æ’å…¥æŒ‰é’®
        label.appendChild(btn);
    }

    // ç«‹å³æ‰§è¡Œ & å¾ªç¯æ£€æŸ¥ (é˜²æ­¢è¢«é‡ç»˜è¦†ç›–)
    fixButtonPosition();
    setInterval(fixButtonPosition, 2000);

})();

/* ================= ğŸ”§ V29.0 è¡¥ä¸ï¼šä¿®å¤â€œæ·»åŠ åˆ†ç±»æ— æ•ˆâ€é—®é¢˜ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V29.0ï¼šæ­£åœ¨é‡æ„åˆ†ç±»æ¸²æŸ“å¼•æ“...");

    // 1. ç¡®ä¿æ•°æ®æºå­˜åœ¨
    if (!window.wizardData) {
        window.wizardData = JSON.parse(localStorage.getItem('my_wizard_data_v2')) || {
            identity: { title: "1. èº«ä»½/ç§æ—", tags: ["çš‡å­", "æ‘„æ”¿ç‹", "é­”å°Š", "å¸ˆå°Š"] },
            personality: { title: "2. æ€§æ ¼ç‰¹ç‚¹", tags: ["ç–¯æ‰¹", "æ¸…å†·", "è…¹é»‘", "å‚²å¨‡"] },
            trope: { title: "3. èŒç‚¹/å¤–è²Œ", tags: ["ç™½æ¯›", "çœ¼é•œ", "è¥¿è£…", "ä¼¤ç—•"] }
        };
    }

    // 2. è¦†ç›–ï¼šæ¸²æŸ“å•ä¸ªæ ‡ç­¾ç»„ (å¢å¼ºå¥å£®æ€§)
    window.renderSingleGroup = function(key) {
        var data = window.wizardData[key];
        // å®¹é”™ï¼šå¦‚æœæ•°æ®åäº†ï¼Œç»™ä¸ªé»˜è®¤å€¼
        if (!data) return;

        // è®¡ç®— IDï¼šä¾‹å¦‚ custom_123 -> tagGroupCustom_123
        var containerId = 'tagGroup' + key.charAt(0).toUpperCase() + key.slice(1);
        var titleId = 'title_' + key;

        // A. æ£€æŸ¥å®¹å™¨æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±åˆ›å»º
        var container = document.getElementById(containerId);
        if (!container) {
            // æ‰¾åˆ°çˆ¶å®¹å™¨
            var wizardBox = document.querySelector('.wizard-box');
            if (!wizardBox) return;

            // æ‰¾åˆ°æ’å…¥é”šç‚¹ï¼šæ’åœ¨â€œæ·»åŠ åˆ†ç±»â€æŒ‰é’®å‰é¢
            var anchor = document.getElementById('btnAddCategory') || document.getElementById('btnOneClickGen');

            // åˆ›å»ºæ ‡é¢˜æ 
            var titleDiv = document.createElement('div');
            titleDiv.id = titleId;
            titleDiv.className = 'tag-group-title';
            titleDiv.onclick = function() { editWizardTitle(key); };
            titleDiv.innerHTML = `${data.title} <span onclick="event.stopPropagation(); addCustomWizardTag('${key}')" style="font-size:12px; color:#6c5ce7; cursor:pointer; margin-left:10px; border:1px solid #6c5ce7; border-radius:4px; padding:0 4px; background:white;">+åŠ æ ‡ç­¾</span>`;

            // åˆ›å»ºæ ‡ç­¾å®¹å™¨
            container = document.createElement('div');
            container.id = containerId;
            container.className = 'tag-select-container';

            // æ’å…¥ DOM
            if (anchor) {
                wizardBox.insertBefore(titleDiv, anchor);
                wizardBox.insertBefore(container, anchor);
            } else {
                wizardBox.appendChild(titleDiv);
                wizardBox.appendChild(container);
            }
        } else {
            // å¦‚æœå®¹å™¨å·²å­˜åœ¨ï¼Œæ›´æ–°ä¸€ä¸‹æ ‡é¢˜ï¼ˆé˜²æ­¢æ”¹ååä¸åˆ·æ–°ï¼‰
            var titleEl = document.getElementById(titleId);
            if (titleEl) {
                titleEl.innerHTML = `${data.title} <span onclick="event.stopPropagation(); addCustomWizardTag('${key}')" style="font-size:12px; color:#6c5ce7; cursor:pointer; margin-left:10px; border:1px solid #6c5ce7; border-radius:4px; padding:0 4px; background:white;">+åŠ æ ‡ç­¾</span>`;
            }
        }

        // B. æ¸²æŸ“æ ‡ç­¾å†…å®¹
        container.innerHTML = ''; // æ¸…ç©ºæ—§çš„
        
        // ç¡®ä¿ tags æ˜¯æ•°ç»„
        if (!Array.isArray(data.tags)) data.tags = [];

        data.tags.forEach((t, idx) => {
            var span = document.createElement('span');
            span.className = 'wizard-tag';
            span.innerText = t;

            // æ¢å¤é€‰ä¸­çŠ¶æ€ (ä½¿ç”¨å…¨å±€é€‰ä¸­æ•°æ®)
            if (!window.currentSelectedTags) window.currentSelectedTags = {};
            if (!window.currentSelectedTags[key]) window.currentSelectedTags[key] = [];
            
            if (window.currentSelectedTags[key].includes(t)) {
                span.classList.add('selected');
            }

            // åˆ é™¤æŒ‰é’®
            var delBtn = document.createElement('span');
            delBtn.className = 'tag-delete-btn';
            delBtn.innerText = 'Ã—';
            delBtn.onclick = function(e) { e.stopPropagation(); deleteWizardTag(key, idx); };
            span.appendChild(delBtn);

            // ç‚¹å‡»é€»è¾‘
            span.onclick = function(e) {
                if(e.target === delBtn) return;
                this.classList.toggle('selected');
                if (this.classList.contains('selected')) {
                    if (!window.currentSelectedTags[key].includes(t)) window.currentSelectedTags[key].push(t);
                } else {
                    window.currentSelectedTags[key] = window.currentSelectedTags[key].filter(item => item !== t);
                }
            };
            container.appendChild(span);
        });
    };

    // 3. è¦†ç›–ï¼šä¸»æ¸²æŸ“å‡½æ•° (éå†æ‰€æœ‰ Key)
    window.renderWizardTags = function() {
        // éå†æ‰€æœ‰æ•°æ®ä¸­çš„ Key
        Object.keys(window.wizardData).forEach(key => {
            renderSingleGroup(key);
        });
        
        // ç¡®ä¿â€œæ·»åŠ åˆ†ç±»â€æŒ‰é’®å­˜åœ¨ä¸”åœ¨æœ€ä¸‹æ–¹
        injectCategoryBtn();
    };

    // 4. ä¿®å¤ï¼šæ³¨å…¥æ·»åŠ æŒ‰é’® (ç¡®ä¿å®ƒæ°¸è¿œåœ¨æœ€ä¸‹é¢)
    function injectCategoryBtn() {
        var box = document.querySelector('.wizard-box');
        if (!box) return;

        var btn = document.getElementById('btnAddCategory');
        // å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºå®ƒ
        if (!btn) {
            btn = document.createElement('div');
            btn.id = 'btnAddCategory';
            btn.innerHTML = "â• æ·»åŠ æ–°åˆ†ç±» (å¦‚: ç¼ºç‚¹/é›·ç‚¹)";
            btn.style.cssText = "text-align:center; padding:10px; border:2px dashed #ddd; border-radius:10px; color:#aaa; cursor:pointer; margin-top:15px; margin-bottom:10px; font-size:12px; font-weight:bold; transition:0.2s;";
            btn.onmouseover = function(){ this.style.borderColor = '#6c5ce7'; this.style.color = '#6c5ce7'; };
            btn.onmouseout = function(){ this.style.borderColor = '#ddd'; this.style.color = '#aaa'; };
            
            // ğŸ”¥ ç»‘å®šç‚¹å‡»äº‹ä»¶
            btn.onclick = function() {
                var catName = prompt("è¯·è¾“å…¥æ–°åˆ†ç±»åç§° (ä¾‹å¦‚ï¼šç¼ºç‚¹ã€é›·ç‚¹ã€ç‰¹æ®Šç™–å¥½):");
                if (catName && catName.trim() !== "") {
                    // ç”Ÿæˆå”¯ä¸€ Key
                    var newKey = 'custom_' + Date.now();
                    // å†™å…¥æ•°æ®
                    window.wizardData[newKey] = { 
                        title: `${Object.keys(window.wizardData).length + 1}. ${catName.trim()}`, 
                        tags: [] 
                    };
                    // åˆå§‹åŒ–é€‰ä¸­æ•°ç»„
                    if(!window.currentSelectedTags) window.currentSelectedTags = {};
                    window.currentSelectedTags[newKey] = [];

                    // ä¿å­˜
                    localStorage.setItem('my_wizard_data_v2', JSON.stringify(window.wizardData));
                    
                    // åˆ·æ–°ç•Œé¢
                    renderWizardTags();
                    
                    auth.toast(`âœ… åˆ†ç±»ã€${catName}ã€‘å·²æ·»åŠ `);
                    
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œè®©ä½ çœ‹åˆ°æ–°åŠ çš„
                    setTimeout(() => {
                        var newTitle = document.getElementById('title_' + newKey);
                        if(newTitle) newTitle.scrollIntoView({behavior: "smooth", block: "center"});
                    }, 300);
                }
            };
            
            // æ’åœ¨â€œä¸€é”®ç”Ÿæˆâ€æŒ‰é’®ä¹‹å‰ï¼Œæˆ–è€…æœ€å
            var genBtn = document.getElementById('btnOneClickGen');
            if (genBtn) box.insertBefore(btn, genBtn);
            else box.appendChild(btn);
        } else {
            // å¦‚æœå·²ç»å­˜åœ¨ï¼Œç¡®ä¿å®ƒåœ¨æ­£ç¡®çš„ä½ç½® (æ‰€æœ‰æ ‡ç­¾ç»„ä¹‹å)
            // ç®€å•ç²—æš´ï¼šé‡æ–°æ’ä¸€æ¬¡åˆ° genBtn ä¹‹å‰
            var genBtn = document.getElementById('btnOneClickGen');
            if (genBtn) box.insertBefore(btn, genBtn);
            else box.appendChild(btn);
        }
    }

    // 5. ç«‹å³æ‰§è¡Œä¸€æ¬¡æ¸²æŸ“
    setTimeout(renderWizardTags, 500);

})();

/* ================= ğŸ§  V30.0 è¡¥ä¸ï¼šå†›å¸ˆèœå•å¼ºåˆ¶ä¿®å¤ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V30.0ï¼šæ­£åœ¨å¼ºåˆ¶æ¢å¤å†›å¸ˆçš„ 4 ç§æ¨¡å¼é€‰é¡¹...");

    // 1. ç¡®ä¿çŠ¶æ€å¯¹è±¡å­˜åœ¨
    if (!window.advisorState) {
        window.advisorState = { mode: 'menu', multiChars: [] };
    }

    // 2. ğŸ”¥ æ ¸å¿ƒï¼šå¼ºåˆ¶é‡å†™â€œæ˜¾ç¤ºèœå•â€å‡½æ•° (é˜²æ­¢ V25 ä¸¢å¤±)
    window.showAdvisorMenu = function() {
        var box = document.getElementById('aiAdvisorBox');
        if(box) box.style.display = 'flex';
        
        var chat = document.getElementById('advisorChat');
        
        // èœå• HTML (å››ä¸ªé€‰é¡¹)
        var menuHtml = `
            <div class="advisor-bubble" style="background:#f3f0ff;">
                <b>ğŸ§  å†›å¸ˆå·²å°±ä½ï¼Œè¯·é€‰æ‹©æ¨¡å¼ï¼š</b>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:10px;">
                    <button class="advisor-tool-btn" onclick="setAdvisorMode('normal')" style="background:#e8f5e9; color:#2e7d32;">ğŸŸ¢ 1. æ™®é€šæ¨¡å¼</button>
                    <button class="advisor-tool-btn" onclick="setAdvisorMode('pro')" style="background:#ffebee; color:#c62828;">ğŸ”´ 2. ä¸“å®¶æ¨¡å¼</button>
                    <button class="advisor-tool-btn" onclick="initMultiCharUI()" style="background:#e3f2fd; color:#1565c0;">ğŸ‘¥ 3. å¤šäººæ¨¡å¼</button>
                    <button class="advisor-tool-btn" onclick="initWorldViewMode()" style="background:#fff3e0; color:#ef6c00;">ğŸŒ 4. ä¸–ç•Œè§‚æ¨¡å¼</button>
                </div>
                <div style="margin-top:8px; font-size:10px; color:#999; text-align:center;">
                    (ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ‡æ¢åŠŸèƒ½)
                </div>
            </div>
        `;
        chat.innerHTML = menuHtml;
        window.advisorState.mode = 'menu';
        
        // é¡ºä¾¿æ›´æ–°è¾“å…¥æ¡†æç¤ºï¼Œè®©å®ƒçœ‹èµ·æ¥æ˜¯â€œå¾…å‘½â€çŠ¶æ€
        var input = document.getElementById('advisorInput');
        if(input) {
            input.placeholder = "è¯·å…ˆç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©æ¨¡å¼...";
            input.value = "";
        }
    };

    // 3. ğŸ”¥ è¦†ç›–ï¼šå¼ºåˆ¶æ‰“å¼€å†›å¸ˆ (ç›´æ¥è°ƒç”¨ä¸Šé¢çš„èœå•å‡½æ•°)
    window.forceOpenAdvisor = function() {
        var box = document.getElementById('aiAdvisorBox');
        if (!box) {
            alert("âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°å†›å¸ˆçª—å£ (id='aiAdvisorBox')");
            return;
        }
        // 1. æ˜¾ç¤ºçª—å£
        box.style.display = 'flex';
        // 2. å¼ºåˆ¶æ¸²æŸ“èœå• (ä¸å†åšä»»ä½•æ£€æŸ¥ï¼Œç›´æ¥æ¸²æŸ“)
        window.showAdvisorMenu();
    };

    // 4. è¡¥å…¨ï¼šæ¨¡å¼åˆ‡æ¢é€»è¾‘ (é˜²æ­¢ V25 æ²¡åŠ è½½å¯¼è‡´æŒ‰é’®ç‚¹ä¸åŠ¨)
    window.setAdvisorMode = function(mode) {
        window.advisorState.mode = mode;
        window.advisorMode = mode; // å…¼å®¹å…¨å±€å˜é‡
        
        var chat = document.getElementById('advisorChat');
        var input = document.getElementById('advisorInput');
        
        if (mode === 'normal') {
            chat.innerHTML += `<div class="advisor-bubble" style="background:#e8f5e9; color:#2e7d32;">ğŸŸ¢ <b>å·²åˆ‡æ¢ï¼šæ™®é€šæ¨¡å¼</b><br>æˆ‘å¯ä»¥å¸®æ‚¨æ„æ€äººè®¾ã€æ¶¦è‰²æ–‡æ¡ˆã€æä¾›å»ºè®®ã€‚<br>è¯·ç›´æ¥åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„æƒ³æ³•ã€‚</div>`;
            input.placeholder = "ğŸŸ¢ æ™®é€šæ¨¡å¼ï¼šèŠèŠä½ çš„äººè®¾æƒ³æ³•...";
            input.style.border = "2px solid #6c5ce7";
        } else if (mode === 'pro') {
            chat.innerHTML += `<div class="advisor-bubble" style="background:#ffebee; color:#c62828;">ğŸ”´ <b>å·²åˆ‡æ¢ï¼šä¸“å®¶æ¨¡å¼</b><br>æ‹¥æœ‰æœ€é«˜æƒé™ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹å½“å‰é¡µé¢çš„ä»»ä½•ä»£ç æˆ–è®¾å®šã€‚<br>è¯·è¾“å…¥ä¿®æ”¹æŒ‡ä»¤ã€‚</div>`;
            input.placeholder = "ğŸ”´ ä¸“å®¶æ¨¡å¼ï¼šè¾“å…¥æŒ‡ä»¤ä¿®æ”¹ä»£ç ...";
            input.style.border = "2px solid #e17055";
        }
        chat.scrollTop = chat.scrollHeight;
    };

    // 5. è¡¥å…¨ï¼šä¸–ç•Œè§‚æ¨¡å¼å…¥å£
    window.initWorldViewMode = function() {
        window.advisorState.mode = 'world_view';
        var chat = document.getElementById('advisorChat');
        chat.innerHTML = `
            <div class="advisor-bubble" style="background:#fff3e0; color:#ef6c00;">
                <b>ğŸŒ ä¸–ç•Œè§‚æ„å»ºæ¨¡å¼</b><br>
                è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†å‘Šè¯‰æˆ‘ï¼Œä½ æƒ³è¦ä»€ä¹ˆæ ·çš„ä¸–ç•Œè§‚ï¼Ÿ<br>
                (ä¾‹å¦‚ï¼šèµ›åšæœ‹å…‹+ä¿®ä»™ï¼Œæˆ–è€…æ˜¯å…‹è‹é²é£æ ¼çš„æ ¡å›­)<br>
                æˆ‘ä¼šä¸ºæ‚¨ç”Ÿæˆ 3 ä¸ªè¯¦ç»†æ–¹æ¡ˆã€‚
            </div>
        `;
        var input = document.getElementById('advisorInput');
        input.placeholder = "ğŸŒ è¾“å…¥ä¸–ç•Œè§‚å…³é”®è¯...";
        input.style.border = "2px solid #ef6c00";
    };

    // 6. è¡¥å…¨ï¼šå¤šäººæ¨¡å¼å…¥å£
    window.initMultiCharUI = function() {
        // å¼¹çª—è¯¢é—®
        var count = prompt("ğŸ‘¥ å¤šäººæ¨¡å¼ï¼šè¯·è¾“å…¥è§’è‰²äººæ•° (ä¾‹å¦‚: 3):");
        if (!count) return;
        var namesStr = prompt("è¯·è¾“å…¥æ‰€æœ‰äººçš„åå­— (ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: å¼ ä¸‰, æå››):");
        if (!namesStr) return;
        
        var names = namesStr.split(/[,ï¼Œ]/).map(n => n.trim()).filter(n => n);
        window.advisorState.mode = 'multi';
        window.advisorState.multiChars = names;
        
        var chat = document.getElementById('advisorChat');
        // ç”ŸæˆæŒ‰é’®åˆ—è¡¨
        var btns = names.map(name => {
            return `<button class="advisor-action-btn" onclick="generateCharSettings('${name}')">ğŸ‘¤ ç”Ÿæˆã€${name}ã€‘çš„è®¾å®š</button>`;
        }).join('');
        
        chat.innerHTML = `
            <div class="advisor-bubble" style="background:#e3f2fd;">
                <b>ğŸ‘¥ å¤šäººæ¨¡å¼å·²å¼€å¯</b><br>
                å½“å‰é˜Ÿåˆ—ï¼š${names.join(', ')}<br>
                è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œé€ä¸ªç”Ÿæˆï¼š
                ${btns}
            </div>
        `;
    };

    // 7. ç»‘å®šï¼šç¡®ä¿æŒ‰é’® onclick æŒ‡å‘æ–°çš„ forceOpenAdvisor
    // è‡ªåŠ¨ä¿®å¤é¡µé¢ä¸Šæ‰€æœ‰å†™ç€â€œå¬å”¤å†›å¸ˆâ€çš„æŒ‰é’®
    setTimeout(function() {
        var allBtns = document.querySelectorAll('button');
        allBtns.forEach(btn => {
            if (btn.innerText.includes('å¬å”¤å†›å¸ˆ')) {
                btn.onclick = window.forceOpenAdvisor;
            }
        });
        
        // å¦‚æœæ˜¯ä»åˆ†æå‡½æ•°è¿›æ¥çš„ï¼Œä¹Ÿå¼ºåˆ¶æ˜¾ç¤ºèœå•
        window.analyzeCardNeeds = window.forceOpenAdvisor;
        
    }, 1000);

    console.log("âœ… å†›å¸ˆèœå•å·²ä¿®å¤ï¼šç‚¹å‡»æŒ‰é’®å°†ç›´æ¥æ˜¾ç¤º 4 é€‰é¡¹");

})();

/* ================= ğŸ‘¥ V31.1 è¡¥ä¸ï¼šå¤šäººæ¨¡å¼äº¤äº’ä¿®å¤ç‰ˆ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V31.1ï¼šå¤šäººæ¨¡å¼æ”¹ä¸ºã€èŠå¤©æ¡†äº¤äº’ã€‘...");

    // 1. å®šä¹‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œè®°å½•å½“å‰æ­£åœ¨ç­‰å¾…è°çš„è¦æ±‚
    window.pendingMultiCharName = null;

    // 2. è¦†ç›–ï¼šç‚¹å‡»ç”ŸæˆæŒ‰é’®åçš„é€»è¾‘
    window.generateCharSettings = function(name) {
        // A. è®°å½•å½“å‰è¦ç”Ÿæˆçš„è§’è‰²å
        window.pendingMultiCharName = name;

        // B. é¢„å¡«åå­—æ¡† (ä¸ºäº†é¢„è§ˆæ–¹ä¾¿)
        var nameInput = document.getElementById('cardName');
        if (nameInput) nameInput.value = name;

        // C. åœ¨èŠå¤©æ¡†æç¤ºç”¨æˆ·
        var chat = document.getElementById('advisorChat');
        var input = document.getElementById('advisorInput');
        
        chat.innerHTML += `
            <div class="advisor-bubble" style="background:#e3f2fd; border-left:4px solid #2196f3;">
                <b>ğŸ‘¤ æ­£åœ¨æ„æ€è§’è‰²ï¼š${name}</b><br>
                è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†å‘Šè¯‰æˆ‘ï¼Œæ‚¨å¯¹ã€${name}ã€‘æœ‰ä»€ä¹ˆå…·ä½“è¦æ±‚ï¼Ÿ<br>
                <small style="color:#666;">(ä¾‹å¦‚ï¼šé«˜å†·å‰‘å®¢ã€ç—…å¨‡å¦¹å¦¹... å¦‚æœæ²¡è¦æ±‚è¯·ç›´æ¥å›å¤â€œæ— â€)</small>
            </div>
        `;
        chat.scrollTop = chat.scrollHeight;

        // D. èšç„¦è¾“å…¥æ¡†å¹¶ä¿®æ”¹æç¤ºè¯
        if (input) {
            input.placeholder = `ğŸ‘‰ è¯·è¾“å…¥å¯¹ã€${name}ã€‘çš„è®¾å®šè¦æ±‚...`;
            input.focus();
            // è§†è§‰é«˜äº®
            input.style.border = "2px solid #2196f3";
        }
    };

    // 3. æ‹¦æˆªå‘é€æ¶ˆæ¯é€»è¾‘ (æ ¸å¿ƒ)
    // æˆ‘ä»¬éœ€è¦æ‹¦æˆª sendAdvisorMsgï¼Œä¼˜å…ˆå¤„ç†â€œæ­£åœ¨è¾“å…¥è¦æ±‚â€çš„æƒ…å†µ
    var _originalSend = window.sendAdvisorMsg;

    window.sendAdvisorMsg = async function() {
        // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨ç­‰å¾…çš„è§’è‰²
        if (window.pendingMultiCharName) {
            var input = document.getElementById('advisorInput');
            var text = input.value.trim();
            if (!text) return;

            // --- è¿™é‡Œçš„é€»è¾‘æ˜¯å¤„ç†â€œå¤šäººæ¨¡å¼ç”Ÿæˆè¯·æ±‚â€ ---
            
            // 1. ç”¨æˆ·æ¶ˆæ¯ä¸Šå±
            var chat = document.getElementById('advisorChat');
            chat.innerHTML += `<div style="text-align:right; margin:5px 0; color:#1565c0; font-size:12px; padding:5px; background:#e3f2fd; border-radius:8px; display:inline-block; margin-left:auto;">${text}</div><div style="clear:both;"></div>`;
            input.value = '';
            
            // æ¢å¤è¾“å…¥æ¡†æ ·å¼
            input.placeholder = "ç­‰å¾…æŒ‡ä»¤...";
            input.style.border = "";

            // 2. é”å®šåå­—å¹¶æ¸…é™¤æ ‡è®° (é˜²æ­¢åç»­æ¶ˆæ¯è¯¯è§¦)
            var targetName = window.pendingMultiCharName;
            window.pendingMultiCharName = null;

            // 3. å¼€å§‹ç”Ÿæˆ
            chat.insertAdjacentHTML('beforeend', `<div id="multi-loading" class="ai-loading">ğŸ§  æ”¶åˆ°è¦æ±‚ï¼š"${text}"<br>æ­£åœ¨ç”Ÿæˆè®¾å®š...</div>`);
            chat.scrollTop = chat.scrollHeight;

            var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
            if (!config || !config.apiKey) {
                alert("è¯·å…ˆé…ç½® API Key");
                document.getElementById('multi-loading').remove();
                return;
            }

            var prompt = `
            æˆ‘æ˜¯åˆ›é€ è€…ã€‚
            è¯·ä¸ºå¤šäººå‰§æœ¬ä¸­çš„è§’è‰²ã€${targetName}ã€‘å†™ä¸€æ®µè¯¦ç»†è®¾å®š(500å­—)ã€‚
            
            ã€ç”¨æˆ·å¼ºåˆ¶è¦æ±‚ã€‘ï¼š
            ${text}
            
            è¯·ç›´æ¥è¾“å‡ºçº¯æ–‡æœ¬è®¾å®šï¼ŒåŒ…å«å¤–è²Œã€æ€§æ ¼ã€èº«ä¸–ã€‚ä¸è¦ä»£ç å—ï¼Œä¸è¦è§£é‡Šã€‚
            `;

            try {
                var res = await fetchAI(prompt, config);
                var cleanText = res.replace(/```/g, '').trim();
                
                document.getElementById('multi-loading').remove();

                // 4. å¡«å…¥è®¾å®šæ¡†
                document.getElementById('cardDesc').value = cleanText;
                
                // 5. æ˜¾ç¤ºå®Œæˆæ°”æ³¡ & ç¡®å®šæŒ‰é’®
                chat.innerHTML += `
                    <div class="advisor-bubble">
                        âœ… ã€${targetName}ã€‘è®¾å®šå·²å¡«å…¥å·¦ä¾§ï¼<br>
                        <button class="advisor-action-btn" onclick="confirmCharAndGenLore('${targetName}')">
                            ğŸ’¾ ç¡®å®š (å¹¶ç”Ÿæˆä¸“å±ä¸–ç•Œä¹¦)
                        </button>
                    </div>
                `;
                chat.scrollTop = chat.scrollHeight;

                // è‡ªåŠ¨è·³è½¬é¢„è§ˆé¡µ
                if(typeof switchCardTab === 'function') switchCardTab('preview');

            } catch (e) {
                console.error(e);
                if(document.getElementById('multi-loading')) document.getElementById('multi-loading').remove();
                chat.innerHTML += `<div class="advisor-bubble">âŒ ç”Ÿæˆå¤±è´¥ï¼š${e.message}</div>`;
            }

            return; // ğŸ”¥ æ‹¦æˆªç»“æŸï¼Œä¸æ‰§è¡ŒåŸæ¥çš„é€»è¾‘
        }

        // å¦‚æœæ²¡æœ‰ç­‰å¾…è¾“å…¥çš„è§’è‰²ï¼Œæ‰§è¡ŒåŸæ¥çš„é€»è¾‘ (æ™®é€šæ¨¡å¼/ä¸“å®¶æ¨¡å¼/ä¸–ç•Œè§‚æ¨¡å¼)
        if (_originalSend) _originalSend();
    };

    console.log("âœ… å¤šäººæ¨¡å¼èŠå¤©äº¤äº’å·²å°±ç»ª");

})();

/* ================= ğŸ§  V36.0 è¡¥ä¸ï¼šå†›å¸ˆå…¨èƒ½è¿›åŒ– (ç¾åŒ–/æ–‡é£/é¢„è§ˆ) ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V36.0ï¼šå†›å¸ˆç³»ç»Ÿæ‰©å®¹ï¼Œæ–°å¢ç¾åŒ–é¢„è§ˆä¸æ–‡é£æ¨¡å¼...");

    // 1. çŠ¶æ€æ‰©å®¹
    if (!window.advisorState) window.advisorState = { mode: 'menu' };
    window.tempStyleGuide = ""; // ä¸´æ—¶å­˜å‚¨ç¾åŒ–æ–‡ä»¶å†…å®¹

    // 2. ğŸ”¥ è¦†ç›–ï¼šé‡å†™å†›å¸ˆä¸»èœå• (6å®«æ ¼å¸ƒå±€)
    window.showAdvisorMenu = function() {
        var box = document.getElementById('aiAdvisorBox');
        if(box) box.style.display = 'flex';
        var chat = document.getElementById('advisorChat');
        
        var menuHtml = `
            <div class="advisor-bubble" style="background:#f3f0ff;">
                <b>ğŸ§  å†›å¸ˆå·²å°±ä½ï¼Œè¯·é€‰æ‹©é”¦å›Šï¼š</b>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:10px;">
                    <button class="advisor-tool-btn" onclick="setAdvisorMode('normal')" style="background:#e8f5e9; color:#2e7d32;">ğŸŸ¢ 1. æ™®é€šæ¨¡å¼</button>
                    <button class="advisor-tool-btn" onclick="setAdvisorMode('pro')" style="background:#ffebee; color:#c62828;">ğŸ”´ 2. ä¸“å®¶æ¨¡å¼</button>
                    <button class="advisor-tool-btn" onclick="initMultiCharUI()" style="background:#e3f2fd; color:#1565c0;">ğŸ‘¥ 3. å¤šäººæ¨¡å¼</button>
                    <button class="advisor-tool-btn" onclick="initWorldViewMode()" style="background:#fff3e0; color:#ef6c00;">ğŸŒ 4. ä¸–ç•Œè§‚</button>
                    <button class="advisor-tool-btn" onclick="initBeautifyMode()" style="background:#f3e5f5; color:#6a1b9a; border:1px solid #e1bee7;">ğŸ¨ 5. ç¾åŒ–æ¨¡å¼</button>
                    <button class="advisor-tool-btn" onclick="initStyleMode()" style="background:#e0f2f1; color:#00695c; border:1px solid #b2dfdb;">âœ’ï¸ 6. æ–‡é£æ¨¡å¼</button>
                </div>
            </div>
        `;
        chat.innerHTML = menuHtml;
        window.advisorState.mode = 'menu';
        
        // æ›´æ–°è¾“å…¥æ¡†æç¤º
        var input = document.getElementById('advisorInput');
        if(input) {
            input.placeholder = "è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©åŠŸèƒ½...";
            input.value = "";
            input.style.border = "1px solid #ccc";
        }
    };

    // ================= ğŸ¨ 5. ç¾åŒ–æ¨¡å¼ (æ ¸å¿ƒæ–°åŠŸèƒ½) =================

    window.initBeautifyMode = function() {
        window.advisorState.mode = 'beautify';
        var chat = document.getElementById('advisorChat');
        
        chat.innerHTML = `
            <div class="advisor-bubble" style="background:#f3e5f5; color:#4a148c;">
                <b>ğŸ¨ UI ç¾åŒ–å®šåˆ¶</b><br>
                æˆ‘å¯ä»¥æ ¹æ®äººè®¾ä¸ºæ‚¨è®¾è®¡å‰ç«¯ç‰¹æ•ˆã€‚<br>
                å¦‚æœæœ‰ã€Šç¾åŒ–è§„èŒƒæ–‡ä»¶ã€‹(CSS/TXT)ï¼Œè¯·å…ˆä¸Šä¼ ï¼Œæˆ‘ä¼šä¸¥æ ¼éµå®ˆã€‚
                <div style="margin-top:10px; text-align:center;">
                    <input type="file" id="beautifyFileInput" style="display:none" onchange="handleBeautifyUpload(this)">
                    <button class="advisor-action-btn" onclick="document.getElementById('beautifyFileInput').click()">
                        ğŸ“‚ ä¸Šä¼ ç¾åŒ–æ¨¡æ¿ (å¯é€‰)
                    </button>
                </div>
            </div>
            <div class="advisor-bubble">
                è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„è¦æ±‚ï¼š<br>
                (ä¾‹å¦‚ï¼šåšä¸€ä¸ªèµ›åšæœ‹å…‹é£æ ¼çš„çŠ¶æ€æ ã€æˆ–è€…ç²‰è‰²çš„æ°”æ³¡æ ·å¼)
            </div>
        `;
        
        var input = document.getElementById('advisorInput');
        input.placeholder = "ğŸ¨ æƒ³è¦ä»€ä¹ˆæ ·çš„ç•Œé¢ï¼Ÿ(ä¸Šä¼ æ–‡ä»¶ååœ¨æ­¤è¾“å…¥éœ€æ±‚)";
        input.style.border = "2px solid #ce93d8";
    };

    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    window.handleBeautifyUpload = function(input) {
        var file = input.files[0];
        if(!file) return;
        
        var reader = new FileReader();
        reader.onload = function(e) {
            window.tempStyleGuide = e.target.result;
            
            var chat = document.getElementById('advisorChat');
            chat.innerHTML += `
                <div class="advisor-bubble">
                    âœ… å·²åŠ è½½æ¨¡æ¿ï¼š<b>${file.name}</b><br>
                    (åŒ…å« ${window.tempStyleGuide.length} å­—ç¬¦)<br>
                    æ¥ä¸‹æ¥è¯·åœ¨è¾“å…¥æ¡†å‘Šè¯‰æˆ‘ï¼Œæ‚¨æƒ³åŸºäºè¿™ä¸ªæ¨¡æ¿åšä»€ä¹ˆï¼Ÿ
                </div>
            `;
            chat.scrollTop = chat.scrollHeight;
        };
        reader.readAsText(file);
    };

    // ç¾åŒ–ç”Ÿæˆé€»è¾‘ (ä¸‰é€‰ä¸€ + é¢„è§ˆ)
    async function runBeautifyGeneration(text, loadingId) {
        var chat = document.getElementById('advisorChat');
        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        var desc = document.getElementById('cardDesc').value || "é€šç”¨è§’è‰²";

        // Prompt
        var prompt = `
        ä½ æ˜¯ä¸€ä¸ªå‰ç«¯UIè®¾è®¡å¸ˆã€‚
        ç”¨æˆ·éœ€æ±‚ï¼š${text}
        è§’è‰²è®¾å®šï¼š${desc.substring(0, 500)}
        
        ${window.tempStyleGuide ? "ã€å¼ºåˆ¶å‚è€ƒæ ·å¼è§„èŒƒã€‘:\n" + window.tempStyleGuide.substring(0, 3000) : ""}
        
        è¯·è®¾è®¡ 3 ä¸ªä¸åŒçš„ HTML/CSS æ–¹æ¡ˆã€‚
        å¿…é¡»è¿”å›çº¯ JSON æ•°ç»„ï¼š
        [
            {
                "name": "æ–¹æ¡ˆåç§° (å¦‚: æç®€é£)",
                "desc": "è®¾è®¡ç†å¿µæè¿°",
                "regex": "/æ­£åˆ™/g",
                "code": "<style>...</style><div>...</div> (å®Œæ•´çš„HTMLä»£ç )"
            },
            ...
        ]
        `;

        try {
            var res = await fetchAI(prompt, config);
            var data = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());
            document.getElementById(loadingId).remove();

            if (data.length === 0) throw new Error("ç”Ÿæˆä¸ºç©º");

            chat.innerHTML += `<div class="advisor-bubble">âœ¨ è®¾è®¡å®Œæˆï¼è¯·æŸ¥çœ‹ä¸‹æ–¹ 3 ä¸ªæ–¹æ¡ˆé¢„è§ˆï¼š</div>`;

            // æ¸²æŸ“ 3 ä¸ªæ–¹æ¡ˆå¡ç‰‡
            data.forEach((item, idx) => {
                // å®‰å…¨è½¬ä¹‰
                var safeCode = encodeURIComponent(item.code);
                var safeRegex = encodeURIComponent(item.regex);
                
                // é¢„è§ˆå®¹å™¨ ID
                var previewId = `preview_box_${Date.now()}_${idx}`;

                chat.innerHTML += `
                    <div class="advisor-bubble" style="border-left:4px solid #9c27b0; padding:10px;">
                        <b>ğŸ¨ æ–¹æ¡ˆ ${idx+1}: ${item.name}</b>
                        <div style="font-size:11px; color:#666; margin-bottom:5px;">${item.desc}</div>
                        
                        <div style="background:#eee; padding:10px; border-radius:5px; margin:5px 0; min-height:60px; overflow:hidden;">
                            <div id="${previewId}"></div>
                        </div>

                        <div style="display:flex; gap:5px;">
                            <button class="advisor-action-btn" style="flex:1; background:#e1bee7; color:#4a148c;" onclick="applyBeautify('${safeCode}', '${safeRegex}')">
                                âœ… ç›´æ¥ä½¿ç”¨
                            </button>
                            <button class="advisor-action-btn" style="flex:1; background:#fff; border:1px solid #999; color:#555;" onclick="refineBeautify('${safeCode}', '${item.name}')">
                                ğŸ”§ ææ„è§
                            </button>
                        </div>
                    </div>
                `;
                
                // å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆå†…å®¹ (å› ä¸º DOM è¿˜æ²¡åˆ·æ–°å®Œ)
                setTimeout(() => {
                    var container = document.getElementById(previewId);
                    if(container) {
                        // ä½¿ç”¨ ShadowRoot éš”ç¦» CSS
                        if (!container.shadowRoot) container.attachShadow({mode: 'open'});
                        container.shadowRoot.innerHTML = item.code;
                    }
                }, 100);
            });
            
            chat.scrollTop = chat.scrollHeight;

        } catch(e) {
            document.getElementById(loadingId).remove();
            chat.innerHTML += `<div class="advisor-bubble">âŒ ç”Ÿæˆå¤±è´¥: ${e.message}</div>`;
        }
    }

    // åº”ç”¨ç¾åŒ–
    window.applyBeautify = function(encCode, encRegex) {
        var code = decodeURIComponent(encCode);
        var regex = decodeURIComponent(encRegex);
        
        // è‡ªåŠ¨è·³è½¬åˆ°å‰ç«¯é¡µ
        if(typeof switchCardTab === 'function') switchCardTab('regex');
        if(typeof switchRegexUI === 'function') switchRegexUI('frontend');
        
        document.getElementById('frontReplace').value = code;
        document.getElementById('frontPattern').value = regex;
        
        // è‡ªåŠ¨å¡«æµ‹è¯•è¯
        var rawKey = regex.replace(/^\//, '').replace(/\/g[im]*$/, '').replace(/\\/g, '');
        document.getElementById('regexTestInput').value = rawKey;
        
        if(typeof runRegexTest === 'function') runRegexTest();
        if(typeof syncStatToNote === 'function') syncStatToNote();

        if(window.auth && window.auth.toast) window.auth.toast('âœ… æ–¹æ¡ˆå·²åº”ç”¨ï¼');
    };

    // ææ„è§ (è¿›å…¥ä¿®æ”¹æµç¨‹)
    window.refineBeautify = function(encCode, name) {
        var code = decodeURIComponent(encCode);
        // å­˜å…¥ç¼“å­˜
        if (!window.lastGeneratedData) window.lastGeneratedData = {};
        window.lastGeneratedData.frontend = { code: code, name: name, regex: "/.*/" }; // regex æš‚æ—¶ä¸é‡è¦
        
        // åˆ‡æ¢å›èŠå¤©æ¡†æç¤º
        var input = document.getElementById('advisorInput');
        input.placeholder = `ğŸ”§ å¯¹ã€${name}ã€‘æœ‰ä»€ä¹ˆä¿®æ”¹æ„è§ï¼Ÿ`;
        input.focus();
        input.style.border = "2px solid #e91e63";
        
        // æ ‡è®°çŠ¶æ€ï¼šä¸‹ä¸€æ¡æ¶ˆæ¯æ˜¯ä¿®æ”¹æ„è§
        window.advisorState.pendingRefine = 'frontend';
        
        var chat = document.getElementById('advisorChat');
        chat.innerHTML += `<div class="advisor-bubble" style="background:#ffebee; color:#c62828;">ğŸ‘‚ è¯·è¾“å…¥æ‚¨çš„ä¿®æ”¹æ„è§ (é’ˆå¯¹ ${name})...</div>`;
        chat.scrollTop = chat.scrollHeight;
    };


    // ================= âœ’ï¸ 6. æ–‡é£æ¨¡å¼ (æ ¸å¿ƒæ–°åŠŸèƒ½) =================

    window.initStyleMode = function() {
        window.advisorState.mode = 'style';
        var chat = document.getElementById('advisorChat');
        chat.innerHTML = `
            <div class="advisor-bubble" style="background:#e0f2f1; color:#004d40;">
                <b>âœ’ï¸ æ–‡é£/è¯­æ°” è°ƒä¼˜æ¨¡å¼</b><br>
                æˆ‘å¯ä»¥å¸®æ‚¨é‡å†™ã€è¯¦ç»†è®¾å®šã€‘æˆ–ã€å¯¹è¯æ ·æœ¬ã€‘ã€‚<br>
                è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³è¦çš„é£æ ¼ï¼š<br>
                (ä¾‹å¦‚ï¼šå¤é¾™é£ã€æ—¥è½»ç¿»è¯‘è…”ã€å…‹è‹é²é£ã€èå£«æ¯”äºšé£ã€ç½‘ç»œçˆ½æ–‡é£...)
            </div>
        `;
        var input = document.getElementById('advisorInput');
        input.placeholder = "âœ’ï¸ è¾“å…¥æ‚¨æƒ³è¦çš„æ–‡é£...";
        input.style.border = "2px solid #009688";
    };

    async function runStyleGeneration(styleReq, loadingId) {
        var chat = document.getElementById('advisorChat');
        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        var name = document.getElementById('cardName').value;
        var firstMes = document.getElementById('cardFirstMes').value || "ä½ å¥½ã€‚";
        
        var prompt = `
        æˆ‘æ˜¯å¡ç‰‡ä½œè€…ã€‚è§’è‰²ï¼š${name}ã€‚
        å½“å‰å¼€åœºç™½ï¼š${firstMes}
        
        ç”¨æˆ·å¸Œæœ›å°†æ–‡é£/è¯­æ°”ä¿®æ”¹ä¸ºï¼šã€${styleReq}ã€‘ã€‚
        
        è¯·ç”Ÿæˆ 3 ä¸ªä¸åŒç‰ˆæœ¬çš„ã€å¼€åœºç™½ã€‘å’Œå¯¹åº”çš„ã€ç®€çŸ­å¯¹è¯æ ·æœ¬ã€‘ã€‚
        å¿…é¡»è¿”å›çº¯ JSON æ•°ç»„ï¼š
        [
            { "title": "é£æ ¼1æ ‡é¢˜", "first": "ä¿®æ”¹åçš„å¼€åœºç™½", "example": "User:ä½ å¥½\\nChar:å›å¤..." },
            ...
        ]
        `;

        try {
            var res = await fetchAI(prompt, config);
            var data = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());
            document.getElementById(loadingId).remove();

            chat.innerHTML += `<div class="advisor-bubble">âœ’ï¸ ç”Ÿæˆå®Œæ¯•ï¼Œè¯·é€‰æ‹©æ‚¨å–œæ¬¢çš„æ–‡é£ï¼š</div>`;

            data.forEach((item, idx) => {
                var safeFirst = encodeURIComponent(item.first);
                var safeEx = encodeURIComponent(item.example);

                chat.innerHTML += `
                    <div class="advisor-bubble" style="border-left:4px solid #009688; padding:10px;">
                        <b>âœ’ï¸ ${item.title}</b>
                        <div style="background:#fff; padding:5px; border:1px dashed #ccc; font-size:11px; margin:5px 0;">
                            <b>å¼€åœºï¼š</b>${item.first}
                        </div>
                        <div style="font-size:10px; color:#666; white-space:pre-wrap;">${item.example.substring(0, 50)}...</div>
                        
                        <button class="advisor-action-btn" style="background:#b2dfdb; color:#004d40;" onclick="applyStyle('${safeFirst}', '${safeEx}')">
                            âœ… é‡‡ç”¨æ­¤æ–‡é£
                        </button>
                    </div>
                `;
            });
            chat.scrollTop = chat.scrollHeight;

        } catch(e) {
            document.getElementById(loadingId).remove();
            chat.innerHTML += `<div class="advisor-bubble">âŒ æ¶¦è‰²å¤±è´¥: ${e.message}</div>`;
        }
    }

    window.applyStyle = function(encFirst, encEx) {
        document.getElementById('cardFirstMes').value = decodeURIComponent(encFirst);
        document.getElementById('cardMesExample').value = decodeURIComponent(encEx);
        
        if(typeof switchCardTab === 'function') switchCardTab('preview');
        if(typeof updatePreviewUI === 'function') updatePreviewUI();
        
        if(window.auth && window.auth.toast) window.auth.toast('âœ… æ–‡é£å·²æ›¿æ¢ï¼');
    };


    // ================= ğŸ”„ æ‹¦æˆªå‘é€é€»è¾‘ (æ€»æ§å°) =================
    var _oldSendAdvisor = window.sendAdvisorMsg;

    window.sendAdvisorMsg = async function() {
        var input = document.getElementById('advisorInput');
        var text = input.value.trim();
        if(!text) return;

        // A. æ‹¦æˆªâ€œææ„è§â€ (Refine) çŠ¶æ€
        if (window.advisorState.pendingRefine === 'frontend') {
            window.advisorState.pendingRefine = null; // æ¸…é™¤çŠ¶æ€
            // è°ƒç”¨ V25 çš„ refineResult (å®ƒå·²ç»åŒ…å«äº† AI è¯·æ±‚)
            // ä¸ºäº†å¤ç”¨ï¼Œæˆ‘ä»¬æ¨¡æ‹ŸæŠŠ text å¡«å…¥ refineInputï¼Œç„¶åè§¦å‘ click
            var refineInput = document.getElementById('refineInput_frontend');
            if(refineInput) {
                refineInput.value = text;
                if(window.refineResult) window.refineResult('frontend');
            }
            // æ¢å¤ç•Œé¢
            input.value = '';
            input.placeholder = "è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©åŠŸèƒ½...";
            input.style.border = "1px solid #ccc";
            return;
        }

        // B. æ‹¦æˆªâ€œç¾åŒ–æ¨¡å¼â€
        if (window.advisorState.mode === 'beautify') {
            var chat = document.getElementById('advisorChat');
            // ä¸Šå±
            chat.innerHTML += `<div style="text-align:right; margin:5px 0; color:#6a1b9a; font-size:12px; padding:5px; background:#f3e5f5; border-radius:8px; display:inline-block; margin-left:auto;">${text}</div><div style="clear:both;"></div>`;
            input.value = '';
            
            var loadingId = 'loading-' + Date.now();
            chat.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-loading">ğŸ¨ æ­£åœ¨è®¾è®¡ UI æ–¹æ¡ˆ...</div>`);
            chat.scrollTop = chat.scrollHeight;
            
            await runBeautifyGeneration(text, loadingId);
            return;
        }

        // C. æ‹¦æˆªâ€œæ–‡é£æ¨¡å¼â€
        if (window.advisorState.mode === 'style') {
            var chat = document.getElementById('advisorChat');
            chat.innerHTML += `<div style="text-align:right; margin:5px 0; color:#00695c; font-size:12px; padding:5px; background:#e0f2f1; border-radius:8px; display:inline-block; margin-left:auto;">${text}</div><div style="clear:both;"></div>`;
            input.value = '';
            
            var loadingId = 'loading-' + Date.now();
            chat.insertAdjacentHTML('beforeend', `<div id="${loadingId}" class="ai-loading">âœ’ï¸ æ­£åœ¨æ¶¦è‰²æ–‡æ¡ˆ...</div>`);
            chat.scrollTop = chat.scrollHeight;
            
            await runStyleGeneration(text, loadingId);
            return;
        }

        // D. å…¶ä»–æ¨¡å¼ (æ™®é€š/ä¸“å®¶/ä¸–ç•Œè§‚/å¤šäºº) èµ°æ—§é€»è¾‘
        if (_oldSendAdvisor) _oldSendAdvisor();
    };

})();

/* ================= ğŸ” V38.0 è¡¥ä¸ï¼šç¾åŒ–æ–¹æ¡ˆå…¨å±é¢„è§ˆ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V38.0ï¼šæ­£åœ¨å®‰è£…å…¨å±é¢„è§ˆæ’ä»¶...");

    // 1. ğŸ—ï¸ æ„å»ºå…¨å±é¢„è§ˆçª—å£ (Lightbox)
    function injectPreviewModal() {
        if (document.getElementById('codePreviewModal')) return;

        var modal = document.createElement('div');
        modal.id = 'codePreviewModal';
        modal.className = 'modal-overlay'; // å¤ç”¨ä½ çš„å¼¹çª—æ ·å¼
        modal.style.cssText = "z-index: 20000; display: none; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);";

        modal.innerHTML = `
            <div class="modal" style="width: 90%; height: 90%; max-width: 1000px; padding: 0; display: flex; flex-direction: column; background: #eee; border-radius: 10px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
                
                <div style="padding: 10px 15px; background: #fff; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: bold; color: #333;">ğŸ‘ï¸ æ•ˆæœé¢„è§ˆ (å…¨å±æ¨¡å¼)</span>
                    <button onclick="document.getElementById('codePreviewModal').classList.remove('active'); setTimeout(()=>document.getElementById('codePreviewModal').style.display='none', 300);" 
                            style="border: none; background: none; font-size: 24px; cursor: pointer; color: #666;">Ã—</button>
                </div>

                <div id="codePreviewStage" style="flex: 1; overflow: auto; padding: 20px; position: relative; display: flex; justify-content: center; align-items: center; background-image: radial-gradient(#ccc 1px, transparent 1px); background-size: 20px 20px;">
                    <div id="shadowHost" style="width: 100%; max-width: 600px; background: transparent;"></div>
                </div>

                <div style="padding: 10px; background: #fff; border-top: 1px solid #ddd; text-align: center; color: #888; font-size: 12px;">
                    ğŸ’¡ è¿™å°±æ˜¯åº”ç”¨åˆ°å¡ç‰‡åçš„å®é™…æ•ˆæœ
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // 2. ğŸ” æ‰“å¼€é¢„è§ˆå‡½æ•°
    window.enlargePreview = function(encodedCode) {
        var code = decodeURIComponent(encodedCode);
        
        var modal = document.getElementById('codePreviewModal');
        var host = document.getElementById('shadowHost');
        
        if (!modal || !host) {
            injectPreviewModal();
            modal = document.getElementById('codePreviewModal');
            host = document.getElementById('shadowHost');
        }

        // é‡ç½® Shadow DOM
        // å› ä¸º ShadowRoot ä¸èƒ½è¢«é‡ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡éƒ½é‡å»º host å…ƒç´ 
        var parent = host.parentNode;
        parent.removeChild(host);
        
        var newHost = document.createElement('div');
        newHost.id = 'shadowHost';
        newHost.style.cssText = "width: 100%; max-width: 800px; min-height: 200px; background: transparent;";
        parent.appendChild(newHost);

        // æ³¨å…¥ä»£ç 
        var shadow = newHost.attachShadow({mode: 'open'});
        shadow.innerHTML = code;

        // æ˜¾ç¤ºå¼¹çª—
        modal.style.display = 'flex';
        // ç¨å¾®å»¶è¿ŸåŠ  active ç±»ä»¥è§¦å‘åŠ¨ç”» (å¦‚æœ css æœ‰åŠ¨ç”»çš„è¯)
        setTimeout(() => modal.classList.add('active'), 10);
    };

    // 3. ğŸ”¥ è¦†ç›–ç¾åŒ–ç”Ÿæˆé€»è¾‘ (runBeautifyGeneration)
    // ç›®æ ‡ï¼šç»™é¢„è§ˆæ¡†åŠ ä¸Šç‚¹å‡»äº‹ä»¶
    // æˆ‘ä»¬å¿…é¡»å®Œæ•´é‡å†™è¿™ä¸ªå‡½æ•°ï¼Œå› ä¸ºå®ƒæ˜¯é—­åŒ…é‡Œçš„é€»è¾‘
    
    // (æ³¨æ„ï¼šè¿™é‡Œéœ€è¦å¤ç”¨ V36 çš„é€»è¾‘ï¼Œä½†ä¿®æ”¹ innerHTML ç”Ÿæˆéƒ¨åˆ†)
    window.runBeautifyGenerationOverride = async function(text, loadingId) {
        var chat = document.getElementById('advisorChat');
        var config = window.aiConfig || JSON.parse(localStorage.getItem('my_ai_config'));
        var desc = document.getElementById('cardDesc').value || "é€šç”¨è§’è‰²";

        // Prompt (ä¿æŒä¸å˜)
        var prompt = `
        ä½ æ˜¯ä¸€ä¸ªå‰ç«¯UIè®¾è®¡å¸ˆã€‚
        ç”¨æˆ·éœ€æ±‚ï¼š${text}
        è§’è‰²è®¾å®šï¼š${desc.substring(0, 500)}
        
        ${window.tempStyleGuide ? "ã€å¼ºåˆ¶å‚è€ƒæ ·å¼è§„èŒƒã€‘:\n" + window.tempStyleGuide.substring(0, 3000) : ""}
        
        è¯·è®¾è®¡ 3 ä¸ªä¸åŒçš„ HTML/CSS æ–¹æ¡ˆã€‚
        å¿…é¡»è¿”å›çº¯ JSON æ•°ç»„ï¼š
        [
            {
                "name": "æ–¹æ¡ˆåç§°",
                "desc": "è®¾è®¡ç†å¿µ",
                "regex": "/æ­£åˆ™/g",
                "code": "<style>...</style><div>...</div>"
            },
            ...
        ]
        `;

        try {
            var res = await fetchAI(prompt, config);
            var data = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());
            document.getElementById(loadingId).remove();

            if (data.length === 0) throw new Error("ç”Ÿæˆä¸ºç©º");

            chat.innerHTML += `<div class="advisor-bubble">âœ¨ è®¾è®¡å®Œæˆï¼<b>ç‚¹å‡»ä¸‹æ–¹ç°è‰²åŒºåŸŸå¯æ”¾å¤§é¢„è§ˆï¼š</b></div>`;

            // æ¸²æŸ“æ–¹æ¡ˆ
            data.forEach((item, idx) => {
                var safeCode = encodeURIComponent(item.code);
                var safeRegex = encodeURIComponent(item.regex);
                
                // é¢„è§ˆå®¹å™¨ ID
                var previewId = `preview_box_${Date.now()}_${idx}`;

                chat.innerHTML += `
                    <div class="advisor-bubble" style="border-left:4px solid #9c27b0; padding:10px;">
                        <b>ğŸ¨ æ–¹æ¡ˆ ${idx+1}: ${item.name}</b>
                        <div style="font-size:11px; color:#666; margin-bottom:5px;">${item.desc}</div>
                        
                        <div style="background:#eee; padding:10px; border-radius:5px; margin:5px 0; min-height:60px; overflow:hidden; cursor: zoom-in; border: 1px solid #ccc; transition: 0.2s;"
                             title="ç‚¹å‡»æ”¾å¤§æŸ¥çœ‹å…¨å±æ•ˆæœ"
                             onmouseover="this.style.borderColor='#9c27b0'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'"
                             onmouseout="this.style.borderColor='#ccc'; this.style.boxShadow='none'"
                             onclick="window.enlargePreview('${safeCode}')">
                             
                            <div id="${previewId}" style="pointer-events: none; transform: scale(0.8); transform-origin: top left; width: 125%;"></div>
                        </div>

                        <div style="display:flex; gap:5px;">
                            <button class="advisor-action-btn" style="flex:1; background:#e1bee7; color:#4a148c;" onclick="applyBeautify('${safeCode}', '${safeRegex}')">
                                âœ… ç›´æ¥ä½¿ç”¨
                            </button>
                            <button class="advisor-action-btn" style="flex:1; background:#fff; border:1px solid #999; color:#555;" onclick="refineBeautify('${safeCode}', '${item.name}')">
                                ğŸ”§ ææ„è§
                            </button>
                        </div>
                    </div>
                `;
                
                // å»¶è¿Ÿæ¸²æŸ“ç¼©ç•¥å›¾
                setTimeout(() => {
                    var container = document.getElementById(previewId);
                    if(container) {
                        if (!container.shadowRoot) container.attachShadow({mode: 'open'});
                        container.shadowRoot.innerHTML = item.code;
                    }
                }, 100);
            });
            
            chat.scrollTop = chat.scrollHeight;

        } catch(e) {
            var loadEl = document.getElementById(loadingId);
            if(loadEl) loadEl.remove();
            chat.innerHTML += `<div class="advisor-bubble">âŒ ç”Ÿæˆå¤±è´¥: ${e.message}</div>`;
        }
    };

    // 4. ğŸ”— æ›¿æ¢æ‹¦æˆªé€»è¾‘
    // æˆ‘ä»¬éœ€è¦ä¿®æ”¹ sendAdvisorMsg é‡Œçš„è°ƒç”¨ï¼ŒæŒ‡å‘æ–°çš„ runBeautifyGenerationOverride
    // è¿™é‡Œçš„åšæ³•æ˜¯ï¼šä¿®æ”¹ runBeautifyGeneration å˜é‡æœ¬èº«ï¼ˆå¦‚æœä¹‹å‰æ˜¯å…¨å±€å®šä¹‰çš„è¯ï¼‰
    // æˆ–è€…æˆ‘ä»¬ç›´æ¥æŠŠé€»è¾‘æ³¨å…¥åˆ° runBeautifyGeneration è¿™ä¸ªåå­—ä¸Š
    window.runBeautifyGeneration = window.runBeautifyGenerationOverride;

    // 5. åˆå§‹åŒ–
    injectPreviewModal();

    console.log("âœ… V38.0 é¢„è§ˆåŠŸèƒ½å·²å°±ç»ª");

})();

/* ================= ğŸšœ V39.0 è¡¥ä¸ï¼šè·³è½¬åŠŸèƒ½æš´åŠ›ä¿®å¤ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V39.0ï¼šæ­£åœ¨é‡å†™è·¨é¡µé¢å¯¼èˆªç³»ç»Ÿ...");

    // 1. è¦†ç›–ï¼šè·³è½¬æ ¸å¿ƒå‡½æ•°
    window.jumpToCreator = function(btn, type, encodedPrompt) {
        console.log("ğŸ‘‰ æ”¶åˆ°è·³è½¬æŒ‡ä»¤ï¼Œç›®æ ‡ç±»å‹:", type);

        // A. æŒ‰é’®åé¦ˆ (é˜²æ­¢ç”¨æˆ·ä»¥ä¸ºæ²¡ç‚¹åˆ°)
        if (btn) {
            var oldText = btn.innerText;
            btn.innerText = "ğŸš€ è·³è½¬ä¸­...";
            btn.style.opacity = "0.7";
            btn.disabled = true; // é˜²æ­¢è¿ç‚¹
            
            // 2ç§’åæ¢å¤æŒ‰é’®ï¼Œä¸‡ä¸€ç”¨æˆ·æƒ³å†ç‚¹ä¸€æ¬¡
            setTimeout(function() {
                btn.innerText = "âœ… å·²å¡«å…¥";
                btn.style.background = "#d4edda";
                btn.style.color = "#155724";
                btn.style.opacity = "1";
                // btn.disabled = false; // ä¿æŒç¦ç”¨ï¼Œæç¤ºå·²å®Œæˆ
            }, 1000);
        }

        setTimeout(function() {
            try {
                var promptText = decodeURIComponent(encodedPrompt);
                var targetTabId = "";
                var targetInputId = "";
                
                // --- B. è·¯ç”±åˆ†å‘ (æ­»æ¿ä½†æœ‰æ•ˆ) ---
                
                // 1. ä¸–ç•Œä¹¦ (World Info)
                if (type === 'world') {
                    targetTabId = 'tab-world';
                    targetInputId = 'aiWorldPrompt';
                }
                // 2. å‰ç«¯ç¾åŒ– (Frontend)
                else if (type === 'frontend') {
                    targetTabId = 'tab-regex';
                    targetInputId = 'aiCodePrompt';
                    
                    // ğŸ”¥ ç‰¹æ®Šå¤„ç†ï¼šç¡®ä¿ AI é¢æ¿æ˜¯å¼€ç€çš„
                    var frontPanel = document.getElementById('uiFrontendMode');
                    var simplePanel = document.getElementById('uiSimpleMode');
                    if (frontPanel) frontPanel.style.display = 'block';
                    if (simplePanel) simplePanel.style.display = 'none';
                    // å‹¾é€‰ radio
                    var radio = document.querySelector('input[value="frontend"]');
                    if (radio) radio.checked = true;
                }
                // 3. å±æ€§/é€»è¾‘ (Stats)
                else if (type === 'stat') {
                    targetTabId = 'tab-stats';
                    targetInputId = 'aiStatPrompt';
                }
                // 4. è¯¦ç»†è®¾å®š/æ–‡é£ (Description)
                else if (type === 'desc' || type === 'style') {
                    targetTabId = 'tab-preview';
                    targetInputId = 'refineInput_desc';
                    
                    // ğŸ”¥ ç‰¹æ®Šå¤„ç†ï¼šå¼ºåˆ¶æ˜¾ç¤ºä¿®æ”¹æ¡†
                    // æ— è®ºä¹‹å‰æœ‰æ²¡æœ‰ç”Ÿæˆè¿‡ï¼Œéƒ½è¦æŠŠé‚£ä¸ªç°è‰²çš„æ¡†å¼„å‡ºæ¥
                    var refineBox = document.getElementById('refineArea_desc');
                    
                    // å¦‚æœæ¡†ä¸å­˜åœ¨ï¼Œç°åœºé€ ä¸€ä¸ª (é˜²æ­¢æŠ¥é”™)
                    if (!refineBox) {
                        var descInput = document.getElementById('cardDesc');
                        if (descInput) {
                            refineBox = document.createElement('div');
                            refineBox.id = 'refineArea_desc';
                            refineBox.style.cssText = "display:block; margin-top:10px; background:#f0f0f0; padding:8px; border-radius:8px;";
                            refineBox.innerHTML = `
                                <div style="display:flex; gap:5px;">
                                    <input type="text" id="refineInput_desc" class="visual-input" style="flex:1;">
                                    <button onclick="refineResult('desc')" style="background:#a29bfe; color:white; border:none; padding:5px 15px; border-radius:5px;">ğŸ”„ è®©å®ƒæ”¹</button>
                                </div>`;
                            descInput.parentNode.insertBefore(refineBox, descInput.nextSibling);
                        }
                    } else {
                        refineBox.style.display = 'block';
                    }
                }

                // --- C. æ‰§è¡Œåˆ‡æ¢ (æš´åŠ›æ“ä½œ DOM) ---
                
                // 1. ç¡®ä¿å¼¹çª—æ˜¯å¼€çš„
                var modal = document.getElementById('cardCreatorModal');
                if (modal) {
                    modal.classList.add('active');
                    modal.style.display = 'flex';
                }

                // 2. åˆ‡æ¢ Tab å†…å®¹
                var allTabs = document.querySelectorAll('.card-tab-content');
                allTabs.forEach(function(el) { el.style.display = 'none'; });
                
                var targetTabEl = document.getElementById(targetTabId);
                if (targetTabEl) targetTabEl.style.display = 'block';
                else throw new Error("æ‰¾ä¸åˆ°ç›®æ ‡é¡µé¢ ID: " + targetTabId);

                // 3. åˆ‡æ¢ Tab æŒ‰é’®é«˜äº®
                var tabBtns = document.querySelectorAll('.card-tab');
                tabBtns.forEach(function(b) { b.classList.remove('active'); });
                // æ¨¡ç³ŠåŒ¹é…
                var keyword = targetTabId.replace('tab-', '');
                for (var i=0; i<tabBtns.length; i++) {
                    var onClickStr = tabBtns[i].getAttribute('onclick');
                    if (onClickStr && onClickStr.includes(keyword)) {
                        tabBtns[i].classList.add('active');
                        break;
                    }
                }

                // --- D. å¡«å…¥å¹¶èšç„¦ ---
                var inputEl = document.getElementById(targetInputId);
                if (inputEl) {
                    inputEl.value = promptText;
                    inputEl.focus();
                    
                    // æ»šåŠ¨å±å¹•ï¼ŒæŠŠè¾“å…¥æ¡†æ”¾åˆ°ä¸­é—´
                    inputEl.scrollIntoView({behavior: "smooth", block: "center"});
                    
                    // é—ªçƒç‰¹æ•ˆ
                    var originalBg = inputEl.style.backgroundColor;
                    inputEl.style.transition = "background 0.3s";
                    inputEl.style.backgroundColor = "#fff3cd"; // æµ…é»„è‰²é«˜äº®
                    setTimeout(function() { inputEl.style.backgroundColor = originalBg; }, 800);

                    if(window.auth && window.auth.toast) window.auth.toast('âœ… å·²è‡ªåŠ¨å¡«å…¥å»ºè®®ï¼Œè¯·ç‚¹å‡»æŒ‰é’®ç”Ÿæˆ');
                } else {
                    alert("âŒ å¯¼èˆªæˆåŠŸï¼Œä½†æ‰¾ä¸åˆ°è¾“å…¥æ¡†: " + targetInputId);
                }

            } catch (e) {
                console.error(e);
                alert("è·³è½¬å¤±è´¥: " + e.message);
                if (btn) {
                    btn.innerText = "âŒ å¤±è´¥";
                    btn.disabled = false;
                }
            }
        }, 100);
    };

    console.log("âœ… V39.0ï¼šè·³è½¬ç³»ç»Ÿå·²é‡ç½®");

})();

/* ================= ğŸ“Š V40.0 è¡¥ä¸ï¼šå±æ€§é€»è¾‘å¤šæ¨¡å—ç³»ç»Ÿ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V40.0ï¼šæ­£åœ¨å°†å±æ€§é¡µå‡çº§ä¸ºå¤šæ¨¡å—æ¶æ„...");

    // 1. åˆå§‹åŒ–æ•°æ®ç»“æ„
    // å¦‚æœä¹‹å‰æ²¡æœ‰æ¨¡å—æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªåˆå§‹çš„
    if (!window.statModules) {
        window.statModules = [];
        window.currentStatIdx = 0;
    }

    // 2. ğŸ—ï¸ ç•Œé¢é‡æ„å·¥å…µ
    function upgradeStatsUI() {
        var tabStats = document.getElementById('tab-stats');
        if (!tabStats) return;

        // æ‰¾åˆ°æ—§çš„ç¼–è¾‘å™¨å’Œè¯´æ˜ä¹¦
        var oldEditor = document.getElementById('statEditor');
        var guideBox = document.getElementById('statGuideBox'); // V8.0 çš„è¯´æ˜ä¹¦
        var refineBox = document.getElementById('refineArea_stat'); // V24.0 çš„ä¿®æ”¹æ¡†
        var aiPanel = document.querySelector('#tab-stats > div[style*="background"]'); // é¡¶éƒ¨çš„AIè¾“å…¥æ¡†å®¹å™¨

        // å¦‚æœå·²ç»å‡çº§è¿‡ï¼Œå°±ä¸åŠ¨äº†
        if (document.getElementById('stat-modules-container')) return;

        // --- A. æ•°æ®è¿ç§» (é˜²ä¸¢) ---
        var existingContent = oldEditor ? oldEditor.value : "";
        // å¦‚æœæœ‰æ—§å†…å®¹ä¸”æ¨¡å—ä¸ºç©ºï¼Œè¿ç§»è¿›å»
        if (window.statModules.length === 0) {
            window.statModules.push({
                name: "ğŸ“ åŸºç¡€è§„åˆ™ (Main)",
                content: existingContent
            });
        }

        // --- B. æ„å»ºæ–°ç•Œé¢å®¹å™¨ ---
        var container = document.createElement('div');
        container.id = 'stat-modules-container';
        // æ ·å¼å¤ç”¨ä¸–ç•Œä¹¦çš„ flex å¸ƒå±€
        container.style.cssText = "display:flex; height:500px; border:1px solid #ddd; border-radius:8px; overflow:hidden; margin-top:10px; background:#fff;";

        // 1. å·¦ä¾§åˆ—è¡¨æ 
        var sidebar = document.createElement('div');
        sidebar.id = 'statSidebar';
        sidebar.style.cssText = "width:160px; background:#f9f9f9; border-right:1px solid #eee; overflow-y:auto; display:flex; flex-direction:column;";
        
        // æ–°å»ºæŒ‰é’®
        var addBtn = document.createElement('div');
        addBtn.innerHTML = "â• æ–°å»ºæ¨¡å—";
        addBtn.style.cssText = "padding:10px; text-align:center; cursor:pointer; font-weight:bold; color:#6c5ce7; border-bottom:1px solid #eee; background:#fff;";
        addBtn.onclick = addNewStatModule;
        sidebar.appendChild(addBtn);

        // åˆ—è¡¨å®¹å™¨
        var listContainer = document.createElement('div');
        listContainer.id = 'statModuleList';
        listContainer.style.flex = "1";
        sidebar.appendChild(listContainer);

        // 2. å³ä¾§ç¼–è¾‘åŒº
        var mainArea = document.createElement('div');
        mainArea.style.cssText = "flex:1; display:flex; flex-direction:column; padding:15px; background:#fff; overflow-y:auto;";

        // æ¨¡å—æ ‡é¢˜è¾“å…¥
        var titleRow = document.createElement('div');
        titleRow.style.cssText = "display:flex; gap:10px; margin-bottom:10px; align-items:center;";
        titleRow.innerHTML = `<span style="font-size:12px;color:#999;">æ¨¡å—å:</span><input type="text" id="currentStatName" class="visual-input" style="flex:1;" placeholder="ä¾‹å¦‚: å¼ ä¸‰çš„å±æ€§" oninput="updateCurrentStatMeta()"> <button class="small-btn" onclick="deleteCurrentStatModule()" style="background:#ff7675;color:white;border:none;">ğŸ—‘ï¸</button>`;
        
        // é‡æ–°å®‰ç½®æ—§ç¼–è¾‘å™¨ (ä¸ºäº†ä¿ç•™ ID å…¼å®¹å…¶ä»–è¡¥ä¸)
        // æˆ‘ä»¬æŠŠæ—§çš„ textarea æ¬è¿‡æ¥ï¼Œæ ·å¼æ”¹ä¸€ä¸‹
        if (oldEditor) {
            oldEditor.style.width = "100%";
            oldEditor.style.flex = "1";
            oldEditor.style.height = "auto"; // è®© flex æ§åˆ¶é«˜åº¦
            oldEditor.style.minHeight = "300px";
            oldEditor.style.resize = "none"; // ç¦æ­¢æ‹–æ‹½ï¼Œç”¨ flex è‡ªé€‚åº”
            oldEditor.placeholder = "åœ¨è¿™é‡Œç¼–å†™é€»è¾‘ä»£ç ...\nä¾‹å¦‚:\nTarget: HP = 100\nRule: ...";
            // ç»‘å®šè¾“å…¥äº‹ä»¶ï¼šåŒæ­¥ä¿å­˜
            oldEditor.oninput = function() {
                saveCurrentContent();
                syncAllStatsToNote(); // å®æ—¶åˆå¹¶
            };
        }

        // ç»„è£…å³ä¾§
        mainArea.appendChild(titleRow);
        
        // æŠŠæ—§å…ƒç´ æŒªè¿›æ¥ (AIè¯´æ˜ä¹¦ã€ç¼–è¾‘å™¨ã€ä¿®æ”¹æ¡†)
        // é¡ºåºï¼šè¯´æ˜ä¹¦ -> ç¼–è¾‘å™¨ -> ä¿®æ”¹æ¡†
        if (guideBox) mainArea.appendChild(guideBox);
        if (oldEditor) mainArea.appendChild(oldEditor);
        else {
            // å¦‚æœæ—§ç¼–è¾‘å™¨æ‰¾ä¸åˆ°äº†ï¼Œé€ ä¸€ä¸ªæ–°çš„
            var newEditor = document.createElement('textarea');
            newEditor.id = 'statEditor';
            newEditor.className = 'card-textarea';
            newEditor.oninput = function() { saveCurrentContent(); syncAllStatsToNote(); };
            mainArea.appendChild(newEditor);
        }
        if (refineBox) mainArea.appendChild(refineBox);

        // ç»„è£…æ•´ä½“
        container.appendChild(sidebar);
        container.appendChild(mainArea);

        // --- C. æ’å…¥åˆ°é¡µé¢ ---
        // æ’åœ¨ AI é¢æ¿ (aiPanel) çš„åé¢
        if (aiPanel && aiPanel.parentNode === tabStats) {
            tabStats.insertBefore(container, aiPanel.nextSibling);
        } else {
            tabStats.appendChild(container);
        }

        // åˆ·æ–°åˆ—è¡¨
        renderStatModuleList();
        loadStatModule(0);
    }

    // 3. ğŸ“ é€»è¾‘æ§åˆ¶å‡½æ•°

    window.addNewStatModule = function() {
        var name = prompt("è¯·è¾“å…¥æ–°æ¨¡å—åç§° (ä¾‹å¦‚: è§’è‰²Bçš„å±æ€§):", "æ–°æ¨¡å—");
        if (!name) return;
        
        window.statModules.push({
            name: name,
            content: ""
        });
        renderStatModuleList();
        // é€‰ä¸­æœ€æ–°çš„
        loadStatModule(window.statModules.length - 1);
    };

    window.deleteCurrentStatModule = function() {
        if (window.statModules.length <= 1) {
            alert("âš ï¸ è‡³å°‘ä¿ç•™ä¸€ä¸ªæ¨¡å—ï¼");
            return;
        }
        if (!confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªæ¨¡å—å—ï¼Ÿ")) return;

        window.statModules.splice(window.currentStatIdx, 1);
        // é‡ç½®ç´¢å¼•
        window.currentStatIdx = 0;
        renderStatModuleList();
        loadStatModule(0);
        syncAllStatsToNote();
    };

    window.renderStatModuleList = function() {
        var list = document.getElementById('statModuleList');
        if (!list) return;
        list.innerHTML = '';

        window.statModules.forEach((mod, idx) => {
            var item = document.createElement('div');
            // æ ·å¼ï¼šæ¨¡ä»¿ä¸–ç•Œä¹¦åˆ—è¡¨
            var isActive = idx === window.currentStatIdx;
            item.style.cssText = `padding:10px; border-bottom:1px solid #eee; cursor:pointer; font-size:12px; ${isActive ? 'background:#e0f7fa; color:#006064; border-left:3px solid #00bcd4; font-weight:bold;' : 'color:#555;'}`;
            item.innerText = mod.name;
            item.onclick = function() { loadStatModule(idx); };
            list.appendChild(item);
        });
    };

    window.loadStatModule = function(idx) {
        window.currentStatIdx = idx;
        var mod = window.statModules[idx];
        
        // å¡«å…¥æ•°æ®
        document.getElementById('currentStatName').value = mod.name;
        document.getElementById('statEditor').value = mod.content || "";
        
        // åˆ·æ–°é«˜äº®
        renderStatModuleList();
    };

    window.updateCurrentStatMeta = function() {
        var name = document.getElementById('currentStatName').value;
        window.statModules[window.currentStatIdx].name = name;
        renderStatModuleList(); // åˆ·æ–°åˆ—è¡¨åå­—
    };

    window.saveCurrentContent = function() {
        var content = document.getElementById('statEditor').value;
        window.statModules[window.currentStatIdx].content = content;
    };

    // ğŸ”¥ æ ¸å¿ƒï¼šåˆå¹¶æ‰€æœ‰æ¨¡å— -> æ·±åº¦è®¾å®š (Card Note)
    window.syncAllStatsToNote = function() {
        var noteEl = document.getElementById('cardNote');
        if (!noteEl) return;

        // å°†æ‰€æœ‰æ¨¡å—å†…å®¹æ‹¼æ¥ï¼Œä¸­é—´åŠ åˆ†éš”ç¬¦
        var combinedText = window.statModules
            .map(m => m.content.trim()) // å»æ‰é¦–å°¾ç©ºæ ¼
            .filter(t => t.length > 0)  // è¿‡æ»¤ç©ºæ¨¡å—
            .join('\n\n'); // ç”¨æ¢è¡Œéš”å¼€

        noteEl.value = combinedText;
    };

    // 4. åˆå§‹åŒ–
    // å»¶æ—¶æ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å…ƒç´ å·²å°±ç»ª
    setTimeout(upgradeStatsUI, 600);

    // 5. è¦†ç›–å†›å¸ˆè·³è½¬é€»è¾‘ (é€‚é…æ–°ç»“æ„)
    // å½“å†›å¸ˆè¦è·³è½¬ 'stat' æ—¶ï¼Œæˆ‘ä»¬ç¡®ä¿å®ƒå¡«å…¥çš„æ˜¯å½“å‰é€‰ä¸­çš„æ¨¡å—
    var _oldJump = window.jumpToCreator;
    window.jumpToCreator = function(btn, type, encodedPrompt) {
        if (type === 'stat') {
            // å…ˆç¡®ä¿ç•Œé¢æ˜¯æ‰“å¼€çš„
            if(typeof switchCardTab === 'function') switchCardTab('stats');
            
            // å¦‚æœæ˜¯å¤šäººæ¨¡å¼ç”Ÿæˆï¼Œå»ºè®®æ–°å»ºæ¨¡å—
            // è¿™é‡Œæˆ‘ä»¬åšä¸€ä¸ªæ™ºèƒ½åˆ¤æ–­ï¼šå¦‚æœå½“å‰æ¨¡å—å·²ç»æœ‰å­—äº†ï¼Œå°±æ–°å»ºä¸€ä¸ª
            var currentContent = document.getElementById('statEditor').value.trim();
            if (currentContent.length > 50) {
                // è‡ªåŠ¨æ–°å»ºä¸€ä¸ªâ€œæ–°è§„åˆ™â€æ¨¡å—ï¼Œé˜²æ­¢è¦†ç›–æ—§çš„
                window.statModules.push({ name: "â• æ–°å¢è§„åˆ™ (AIå»ºè®®)", content: "" });
                renderStatModuleList();
                loadStatModule(window.statModules.length - 1);
                
                if(window.auth && window.auth.toast) window.auth.toast('âœ¨ å·²è‡ªåŠ¨æ–°å»ºæ¨¡å—ï¼Œé¿å…è¦†ç›–æ—§è§„åˆ™');
            }
        }
        // æ‰§è¡ŒåŸæœ‰è·³è½¬
        if(_oldJump) _oldJump(btn, type, encodedPrompt);
    };

    console.log("âœ… å±æ€§å¤šæ¨¡å—ç³»ç»Ÿå·²å°±ç»ª");

})();

/* ================= ğŸ‘¥ V41.0 è¡¥ä¸ï¼šå¤šäººè§’è‰²é¢æ¿åˆ‡æ¢ç³»ç»Ÿ ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V41.0ï¼šå¯åŠ¨å¤šäººè§’è‰²æ¡£æ¡ˆç®¡ç†ç³»ç»Ÿ...");

    // 1. åˆå§‹åŒ–æ•°æ®ä¸­å¿ƒ (èŠ±åå†Œ)
    // ç»“æ„: { "å¼ ä¸‰": { desc: "...", firstMes: "..." }, "æå››": { ... } }
    if (!window.projectCharData) {
        window.projectCharData = {};
    }

    // 2. ğŸ’¾ æ ¸å¿ƒï¼šä¿å­˜å½“å‰ç•Œé¢åˆ°èŠ±åå†Œ
    window.saveCurrentCharToCache = function() {
        var name = document.getElementById('cardName').value.trim();
        if (!name) return; // æ²¡åå­—çš„ä¸å­˜

        // æ”¶é›†å½“å‰ç•Œé¢æ•°æ®
        var data = {
            desc: document.getElementById('cardDesc').value,
            firstMes: document.getElementById('cardFirstMes').value,
            mesEx: document.getElementById('cardMesExample').value,
            // å¦‚æœæœ‰ V40 çš„å±æ€§æ¨¡å—ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘å­˜ï¼Œä½†å±æ€§é€šå¸¸æ˜¯å…±ç”¨çš„ï¼Œæš‚ä¸å¼ºåˆ¶ç»‘å®š
        };

        window.projectCharData[name] = data;
        // console.log(`âœ… å·²è‡ªåŠ¨ç¼“å­˜è§’è‰²ã€${name}ã€‘çš„æ•°æ®`);
    };

    // 3. ğŸ“¤ æ ¸å¿ƒï¼šåˆ‡æ¢è§’è‰²é¢æ¿
    window.switchCharPanel = function(targetName) {
        // A. å…ˆä¿å­˜ç°åœ¨çš„ (é˜²æ­¢æ²¡ç‚¹ä¿å­˜å°±åˆ‡èµ°äº†)
        saveCurrentCharToCache();

        // B. è¯»å–ç›®æ ‡æ•°æ®
        var data = window.projectCharData[targetName];
        if (!data) {
            alert(`âš ï¸ è§’è‰²ã€${targetName}ã€‘æš‚æ— æ•°æ®ï¼Œè¯·å…ˆç”Ÿæˆï¼`);
            return;
        }

        // C. å¡«å…¥ç•Œé¢
        document.getElementById('cardName').value = targetName;
        document.getElementById('cardDesc').value = data.desc || "";
        document.getElementById('cardFirstMes').value = data.firstMes || "";
        document.getElementById('cardMesExample').value = data.mesEx || "";

        // D. è‡ªåŠ¨è·³è½¬åˆ°é¢„è§ˆé¡µ (æ–¹ä¾¿æŸ¥çœ‹å’Œä¿®æ”¹)
        if(typeof switchCardTab === 'function') switchCardTab('preview');
        
        // E. è§†è§‰åé¦ˆ
        if(window.auth && window.auth.toast) window.auth.toast(`ğŸ‘¤ å·²åˆ‡æ¢è‡³ã€${targetName}ã€‘é¢æ¿`);
        
        // F. æ›´æ–°å†›å¸ˆèœå•çŠ¶æ€
        renderMultiCharMenu(); 
    };

    // 4. ğŸ”¥ è¦†ç›–ï¼šå¤šäººæ¨¡å¼èœå•æ¸²æŸ“ (å¢åŠ åˆ‡æ¢åŠŸèƒ½)
    window.renderMultiCharMenu = function() {
        var chat = document.getElementById('advisorChat');
        var names = window.advisorState.multiChars || [];
        var currentName = document.getElementById('cardName').value.trim();

        // ç”ŸæˆæŒ‰é’®åˆ—è¡¨
        var btnsHtml = names.map(name => {
            // åˆ¤æ–­è¯¥è§’è‰²æ˜¯å¦å·²æœ‰æ•°æ®
            var hasData = window.projectCharData[name];
            var isCurrent = (name === currentName);
            
            var btnStyle = "background:#e3f2fd; color:#1565c0;"; // é»˜è®¤è“è‰² (ç”Ÿæˆ)
            var btnText = `âš¡ ç”Ÿæˆã€${name}ã€‘è®¾å®š`;
            var action = `generateCharSettings('${name}')`;

            if (hasData) {
                if (isCurrent) {
                    // å½“å‰æ­£åœ¨ç¼–è¾‘
                    btnStyle = "background:#4caf50; color:white; border:1px solid #388e3c;";
                    btnText = `ğŸŸ¢ ç¼–è¾‘ä¸­ï¼š${name}`;
                    action = ""; // ç‚¹äº†æ²¡ååº”
                } else {
                    // å·²æœ‰æ•°æ®ï¼Œç‚¹å‡»åˆ‡æ¢
                    btnStyle = "background:#fff; border:1px solid #1565c0; color:#1565c0;";
                    btnText = `ğŸ‘¤ åˆ‡æ¢è‡³ï¼š${name}`;
                    action = `switchCharPanel('${name}')`;
                }
            }

            return `<button class="advisor-action-btn" style="${btnStyle}" onclick="${action}">${btnText}</button>`;
        }).join('');
        
        // æ¸²æŸ“æ°”æ³¡
        chat.innerHTML += `
            <div class="advisor-bubble" style="background:#f5f5f5; border-left:4px solid #673ab7;">
                <b>ğŸ‘¥ å¤šäººè§’è‰²ç®¡ç†å°</b><br>
                <div style="font-size:11px; color:#666; margin-bottom:5px;">
                    ç‚¹å‡»â€œåˆ‡æ¢â€å¯åŠ è½½è¯¥è§’è‰²çš„è¯¦ç»†è®¾å®šã€‚<br>
                    åŠ è½½åï¼Œç”Ÿæˆçš„å±æ€§/ä¸–ç•Œä¹¦å°†è‡ªåŠ¨åŸºäºè¯¥è§’è‰²ã€‚
                </div>
                ${btnsHtml}
            </div>
        `;
        chat.scrollTop = chat.scrollHeight;
    };

    // 5. ğŸ”— ä¸²è”ç”Ÿæˆé€»è¾‘ (ç”ŸæˆæˆåŠŸåè‡ªåŠ¨å­˜å…¥èŠ±åå†Œ)
    // æˆ‘ä»¬éœ€è¦æ‹¦æˆªç”ŸæˆæˆåŠŸçš„æ—¶åˆ»ã€‚æœ€ç®€å•çš„åŠæ³•æ˜¯ï¼šåœ¨ç”¨æˆ·ç‚¹å‡»â€œç¡®å®šâ€æ—¶ä¿å­˜ã€‚
    
    // è¦†ç›– confirmCharAndGenLore (ç‚¹å‡»ç¡®å®šæŒ‰é’®çš„é€»è¾‘)
    var _oldConfirm = window.confirmCharAndGenLore;
    window.confirmCharAndGenLore = async function(name) {
        // 1. å…ˆä¿å­˜æ•°æ®åˆ°èŠ±åå†Œ
        saveCurrentCharToCache();
        
        // 2. æ ‡è®°è¯¥è§’è‰²å·²å®Œæˆ (ç”¨äºåˆ·æ–°èœå•æ˜¾ç¤º)
        // (å·²ç»åœ¨ saveCurrentCharToCache é‡Œå­˜å…¥ window.projectCharData äº†)

        // 3. åˆ·æ–°èœå•ï¼Œè®©æŒ‰é’®å˜æˆâ€œåˆ‡æ¢â€çŠ¶æ€
        renderMultiCharMenu();

        // 4. æ‰§è¡ŒåŸæœ‰çš„ç”Ÿæˆä¸–ç•Œä¹¦é€»è¾‘
        // æ³¨æ„ï¼šåŸå‡½æ•°é‡Œå¯èƒ½ç”¨äº† document.getElementByIdè·å–å€¼ï¼Œç°åœ¨å·²ç»æ˜¯å½“å‰è§’è‰²çš„å€¼äº†ï¼Œæ²¡é—®é¢˜
        if(_oldConfirm) await _oldConfirm(name);
    };

    // 6. ğŸ›¡ï¸ è‡ªåŠ¨ä¿å­˜å®ˆæŠ¤ (é¡µé¢åˆ·æ–°é˜²ä¸¢)
    // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–ï¼Œå®æ—¶æ›´æ–°åˆ°èŠ±åå†Œ
    function bindAutoSave() {
        var inputs = ['cardDesc', 'cardFirstMes', 'cardMesExample'];
        inputs.forEach(id => {
            var el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', function() {
                    // åªæœ‰å½“åå­—åœ¨èŠ±åå†Œé‡Œæ—¶æ‰è‡ªåŠ¨æ›´æ–°
                    var name = document.getElementById('cardName').value.trim();
                    if (name && window.projectCharData[name]) {
                        saveCurrentCharToCache();
                    }
                });
            }
        });
    }
    setTimeout(bindAutoSave, 1000);

    console.log("âœ… å¤šäººé¢æ¿åˆ‡æ¢ç³»ç»Ÿå·²å°±ç»ª");

})();

/* ================= ğŸ‘¥ V42.0 è¡¥ä¸ï¼šå¤šäººæ¨¡å¼æ™ºèƒ½è¯»æ¡£ & åŠ¨æ€åŠ äºº ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V42.0ï¼šæ­£åœ¨å‡çº§å¤šäººæ¨¡å¼å­˜å‚¨ä¸äº¤äº’é€»è¾‘...");

    // 1. ğŸ’¾ æŒä¹…åŒ–å­˜å‚¨é”®å
    const MULTI_PROJECT_KEY = 'my_multi_project_v1';

    // 2. ğŸ”„ åˆå§‹åŒ–ä¸è¯»å– (å¼€å±€è‡ªåŠ¨æ‰§è¡Œ)
    function loadProjectData() {
        var json = localStorage.getItem(MULTI_PROJECT_KEY);
        if (json) {
            try {
                var data = JSON.parse(json);
                // æ¢å¤èŠ±åå†Œ
                window.projectCharData = data.charData || {};
                // æ¢å¤åå•åˆ—è¡¨
                if (!window.advisorState) window.advisorState = {};
                window.advisorState.multiChars = data.charList || [];
                console.log("âœ… å¤šäººé¡¹ç›®æ•°æ®å·²æ¢å¤:", window.advisorState.multiChars);
            } catch (e) {
                console.error("è¯»å–å¤±è´¥:", e);
            }
        }
    }
    // ç«‹å³è¯»å–ä¸€æ¬¡
    loadProjectData();

    // 3. ğŸ’¾ ä¿å­˜å‡½æ•° (æ¯æ¬¡å˜åŠ¨éƒ½å­˜)
    window.saveMultiProject = function() {
        var data = {
            charData: window.projectCharData || {},
            charList: window.advisorState.multiChars || []
        };
        localStorage.setItem(MULTI_PROJECT_KEY, JSON.stringify(data));
    };

    // 4. ğŸ”¥ è¦†ç›–ï¼šå¤šäººæ¨¡å¼å…¥å£ (æ™ºèƒ½åˆ¤æ–­)
    window.initMultiCharUI = function() {
        // A. æ£€æŸ¥æ˜¯å¦æœ‰å­˜æ¡£
        if (window.advisorState.multiChars && window.advisorState.multiChars.length >= 1) {
            // æœ‰äººï¼ç›´æ¥è¿›é¢æ¿ï¼Œä¸åºŸè¯
            window.advisorState.mode = 'multi';
            
            var chat = document.getElementById('advisorChat');
            chat.innerHTML = `
                <div class="advisor-bubble" style="background:#e3f2fd;">
                    <b>ğŸ“‚ è¯»å–åˆ°ç°æœ‰é¡¹ç›®</b><br>
                    æ£€æµ‹åˆ°åå•ä¸­æœ‰ ${window.advisorState.multiChars.length} äººã€‚<br>
                    <small style="color:#666;">(è‹¥æƒ³å¢åŠ è§’è‰²ï¼Œè¯·åœ¨è¾“å…¥æ¡†è¯´â€œæˆ‘è¦åŠ äººâ€)</small>
                </div>
            `;
            // æ¸²æŸ“é¢æ¿
            renderMultiCharMenu();
            
            // æç¤ºç”¨æˆ·
            if(window.auth && window.auth.toast) window.auth.toast('âœ… å·²åŠ è½½ç°æœ‰è§’è‰²åˆ—è¡¨');
            return;
        }

        // B. æ²¡äºº -> èµ°è€æµç¨‹ (è¯¢é—®)
        window.appendMultiChars(true); // true è¡¨ç¤ºæ˜¯åˆå§‹åŒ–æ¨¡å¼
    };

    // 5. â• æ–°å¢/åˆå§‹åŒ–è§’è‰²é€»è¾‘
    window.appendMultiChars = function(isInit) {
        var msg = isInit ? "ğŸ‘¥ è¯·è¾“å…¥è§’è‰²äººæ•° (ä¾‹å¦‚: 3):" : "â• è¦åŠ å‡ ä¸ªäººï¼Ÿ";
        var count = prompt(msg);
        if (!count) return;

        var msg2 = isInit ? "è¯·è¾“å…¥æ‰€æœ‰äººçš„åå­— (ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: å¼ ä¸‰, æå››):" : "è¯·è¾“å…¥æ–°è§’è‰²çš„åå­— (é€—å·åˆ†éš”):";
        var namesStr = prompt(msg2);
        if (!namesStr) return;
        
        var newNames = namesStr.split(/[,ï¼Œ]/).map(n => n.trim()).filter(n => n);
        
        if (!window.advisorState.multiChars) window.advisorState.multiChars = [];
        
        // åˆå¹¶åå•
        window.advisorState.multiChars = window.advisorState.multiChars.concat(newNames);
        window.advisorState.mode = 'multi';

        // ä¿å­˜ï¼
        saveMultiProject();

        // æ¸²æŸ“
        renderMultiCharMenu();
        
        var chat = document.getElementById('advisorChat');
        chat.innerHTML += `<div class="advisor-bubble">âœ… å·²æ·»åŠ  ${newNames.length} ä½æ–°è§’è‰²ï¼åå•å·²æ›´æ–°ã€‚</div>`;
        chat.scrollTop = chat.scrollHeight;
    };

    // 6. ğŸ”¥ æ‹¦æˆªèŠå¤©ï¼šæ£€æµ‹â€œåŠ äººâ€æŒ‡ä»¤
    // æˆ‘ä»¬éœ€è¦å†æ¬¡æ‹¦æˆª sendAdvisorMsgï¼Œè¿™æ¬¡æ˜¯ä¸ºäº†åŠ äººåŠŸèƒ½
    var _oldSendV31 = window.sendAdvisorMsg; // å¤‡ä»½ V31/V36 çš„é€»è¾‘

    window.sendAdvisorMsg = async function() {
        var input = document.getElementById('advisorInput');
        var text = input.value.trim();
        
        // ä»…åœ¨å¤šäººæ¨¡å¼ä¸‹ç”Ÿæ•ˆ
        if (window.advisorState.mode === 'multi' && text) {
            // å…³é”®è¯æ£€æµ‹
            if (text.includes("åŠ äºº") || text.includes("å¢åŠ ") || text.includes("æ·»åŠ ") || text.includes("æ–°è§’è‰²")) {
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                input.value = '';
                
                // å¼¹å‡ºç¡®è®¤æ¡†
                if (confirm(`ğŸ¤– å†›å¸ˆï¼šæ‚¨æ˜¯æƒ³åœ¨ç°æœ‰åå•å¤–ï¼Œå†å¢åŠ æ–°è§’è‰²å—ï¼Ÿ`)) {
                    window.appendMultiChars(false); // false è¡¨ç¤ºè¿½åŠ æ¨¡å¼
                } else {
                    // å¦‚æœå–æ¶ˆï¼Œå°±åœ¨èŠå¤©æ¡†æç¤ºä¸€ä¸‹
                    var chat = document.getElementById('advisorChat');
                    chat.innerHTML += `<div class="advisor-bubble">ğŸ†— æ“ä½œå·²å–æ¶ˆã€‚</div>`;
                }
                return; // æ‹¦æˆªç»“æŸ
            }
        }

        // å¦‚æœä¸æ˜¯åŠ äººæŒ‡ä»¤ï¼Œæˆ–è€…æ˜¯å…¶ä»–æ¨¡å¼ï¼Œèµ°åŸæ¥çš„é€»è¾‘ (V31/V36)
        if (_oldSendV31) _oldSendV31();
    };

    // 7. è¡¥å……ï¼šæ¯æ¬¡ç”Ÿæˆ/åˆ‡æ¢åä¹Ÿè§¦å‘ä¿å­˜
    // åŠ«æŒ saveCurrentCharToCache (V41 çš„å‡½æ•°)
    var _oldSaveCache = window.saveCurrentCharToCache;
    window.saveCurrentCharToCache = function() {
        if (_oldSaveCache) _oldSaveCache();
        saveMultiProject(); // é¡ºä¾¿å­˜åˆ°ç¡¬ç›˜
    };

    console.log("âœ… V42.0ï¼šå¤šäººæ¨¡å¼å·²å…·å¤‡è®°å¿†åŠŸèƒ½");

})();

/* ================= ğŸ“± V43.0 è¡¥ä¸ï¼šå±æ€§é¡µç§»åŠ¨ç«¯å¸ƒå±€ä¼˜åŒ– ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V43.0ï¼šæ­£åœ¨ä¸ºæ‰‹æœºç«¯é‡æ„å±æ€§é¡µå¸ƒå±€...");

    // æˆ‘ä»¬é€šè¿‡æ³¨å…¥ CSS æ¥å¼ºåˆ¶è¦†ç›–ä¹‹å‰çš„å†…è”æ ·å¼
    // è¿™æ ·æ—¢ä¿ç•™äº†ç”µè„‘ç«¯çš„å·¦å³å¸ƒå±€ï¼Œåˆè®©æ‰‹æœºç«¯å˜æˆä¸Šä¸‹å¸ƒå±€
    function injectMobileStyles() {
        var styleId = 'mobile-layout-fix-v43';
        if (document.getElementById(styleId)) return;

        var css = `
            /* === ä»…åœ¨å±å¹•å®½åº¦å°äº 768px (æ‰‹æœº/å¹³æ¿) æ—¶ç”Ÿæ•ˆ === */
            @media screen and (max-width: 768px) {
                
                /* 1. å®¹å™¨æ”¹ä¸ºä¸Šä¸‹æ’åˆ— */
                #stat-modules-container {
                    flex-direction: column !important;
                    height: auto !important; /* é«˜åº¦ä¸å†å›ºå®šï¼Œéšå†…å®¹æ’‘å¼€ */
                    min-height: 600px;       /* ä¿è¯è¶³å¤Ÿé«˜ */
                }

                /* 2. åŸå·¦ä¾§åˆ—è¡¨ -> å˜é¡¶éƒ¨æ¨ªå‘èœå• */
                #statSidebar {
                    width: 100% !important;
                    height: auto !important;
                    border-right: none !important;
                    border-bottom: 2px solid #6c5ce7 !important;
                    flex-direction: row !important; /* æ¨ªå‘æ’åˆ— */
                    overflow-x: auto !important;    /* å…è®¸æ¨ªå‘æ»šåŠ¨ */
                    white-space: nowrap !important; /* ä¸æ¢è¡Œ */
                    padding: 5px !important;
                    background: #f0f0f0 !important;
                }

                /* åˆ—è¡¨é‡Œçš„æ¯ä¸€é¡¹ */
                #statModuleList {
                    display: flex !important;
                    flex-direction: row !important;
                    gap: 5px !important;
                }

                #statModuleList > div {
                    padding: 8px 15px !important;
                    border: 1px solid #ccc !important;
                    border-radius: 20px !important;
                    background: #fff !important;
                    margin: 0 !important;
                    flex-shrink: 0 !important; /* é˜²æ­¢è¢«æŒ¤å‹ */
                    font-size: 13px !important;
                }

                /* 3. ç¼–è¾‘åŒºæ‹‰å¤§ */
                #stat-modules-container > div:last-child {
                    width: 100% !important;
                    padding: 10px !important;
                }

                /* 4. ä»£ç æ¡†å¼ºåˆ¶æ‹‰é«˜ */
                #statEditor {
                    height: 400px !important; /* æ‰‹æœºä¸Šç»™è¶³é«˜åº¦ */
                    min-height: 400px !important;
                    font-size: 14px !important; /* å­—ä½“æ”¹å¤§ä¸€ç‚¹ç‚¹ */
                }

                /* 5. ä¿®æ”¹æ¡† (Refine Box) ä¼˜åŒ– */
                #refineArea_stat {
                    display: flex !important;
                    flex-direction: column !important; /* æ‰‹æœºä¸Šè¾“å…¥æ¡†å’ŒæŒ‰é’®æ¢è¡Œ */
                }
                
                #refineInput_stat {
                    width: 100% !important;
                    margin-bottom: 5px !important;
                    height: 40px !important; /* è¾“å…¥æ¡†åŠ é«˜ */
                }
                
                #refineArea_stat button {
                    width: 100% !important; /* æŒ‰é’®å æ»¡ */
                    padding: 10px !important;
                }
                
                /* 6. é‚£ä¸ªç»¿è‰²çš„è¯´æ˜ä¹¦ç›’å­ä¹Ÿä¼˜åŒ–ä¸€ä¸‹ */
                #statGuideBox {
                    max-height: 150px !important; /* é™åˆ¶é«˜åº¦ï¼Œé˜²æ­¢å å¤ªå¤šåœ° */
                    overflow-y: auto !important;
                }
            }
        `;

        var style = document.createElement('style');
        style.id = styleId;
        style.type = 'text/css';
        style.appendChild(document.createTextNode(css));
        document.head.appendChild(style);
    }

    // ç«‹å³æ‰§è¡Œ
    injectMobileStyles();
    
    // å†æ¬¡æ‰§è¡Œä»¥é˜²ä¸‡ä¸€
    setTimeout(injectMobileStyles, 1000);

    console.log("âœ… ç§»åŠ¨ç«¯å¸ƒå±€é€‚é…å®Œæˆ");

})();


/* ================= ğŸ’¾ V37.0 è¡¥ä¸ï¼šé»‘åŒ£å­è‡ªåŠ¨å¤‡ä»½ç³»ç»Ÿ (é˜²ä¸¢æ•°æ®) ================= */
(function() {
    console.log("ğŸš€ æ‰§è¡Œ V37.0ï¼šæ­£åœ¨å¯åŠ¨å…¨è‡ªåŠ¨å¤‡ä»½å¼•æ“...");

    // 1. å®šä¹‰é»‘åŒ£å­å­˜å‚¨é”®å
    const AUTO_SAVE_KEY = 'my_creator_autosave_v1';

    // 2. ğŸ“¥ æ ¸å¿ƒï¼šæ”¶é›†å½“å‰æ‰€æœ‰æ•°æ®
    function collectWorkspaceData() {
        // è¾…åŠ©ï¼šå®‰å…¨è·å–è¾“å…¥æ¡†
        var getVal = function(id) { var el = document.getElementById(id); return el ? el.value : ""; };

        return {
            timestamp: Date.now(),
            // A. å…¨å±€å˜é‡ (æ ¸å¿ƒæ•°æ®)
            globals: {
                // ä¸–ç•Œä¹¦ (é˜²æ­¢ä¸¢å¤±)
                worldInfo: window.currentWorldInfo || { entries: [] },
                // æ­£åˆ™/å‰ç«¯è„šæœ¬ (é˜²æ­¢ä¸¢å¤±)
                regexScripts: window.currentCardRegexes || [],
                // å¯¼å…¥çš„ç¾åŒ–è§„èŒƒæ–‡ä»¶å†…å®¹ (é˜²æ­¢åˆ·æ–°åè¦é‡æ–°å¯¼)
                styleGuide: window.frontendStyleGuide || "",
                // é€‰ä¸­çš„æ ‡ç­¾
                selectedTags: window.currentSelectedTags || { identity:[], personality:[], trope:[] },
                // å†›å¸ˆæ¨¡å¼
                advisorMode: window.advisorMode || 'normal'
            },
            // B. ç•Œé¢è¾“å…¥æ¡† (é˜²æ­¢ç™½å†™)
            inputs: {
                cardName: getVal('cardName'),
                cardDesc: getVal('cardDesc'),
                cardFirstMes: getVal('cardFirstMes'),
                cardMesExample: getVal('cardMesExample'),
                cardScenario: getVal('cardScenario'),
                cardNote: getVal('cardNote'),     // æ·±åº¦è®¾å®š
                statEditor: getVal('statEditor'), // å±æ€§é¡µä»£ç 
                frontReplace: getVal('frontReplace'), // å‰ç«¯ä»£ç æ¡†
                frontPattern: getVal('frontPattern'), // å‰ç«¯æ­£åˆ™æ¡†
                aiCodePrompt: getVal('aiCodePrompt'), // ç¾åŒ–éœ€æ±‚
                aiWorldPrompt: getVal('aiWorldPrompt') // ä¸–ç•Œä¹¦éœ€æ±‚
            }
        };
    }

    // 3. ğŸ’¾ æ ¸å¿ƒï¼šä¿å­˜åˆ°æœ¬åœ°
    function saveToBlackBox() {
        try {
            var data = collectWorkspaceData();
            // åªæœ‰å½“æœ‰æ•°æ®æ—¶æ‰ä¿å­˜ (é˜²æ­¢è¦†ç›–ä¸ºç©º)
            // ç®€å•åˆ¤æ–­ï¼šå¦‚æœåå­—ä¸ºç©ºä¸”æè¿°ä¸ºç©ºä¸”ä¸–ç•Œä¹¦ä¸ºç©ºï¼Œå¯èƒ½è¿˜æ²¡åŠ è½½å®Œï¼Œä¸å­˜
            if (!data.inputs.cardName && !data.inputs.cardDesc && data.globals.worldInfo.entries.length === 0) {
                return;
            }
            
            localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(data));
            
            // è§†è§‰åé¦ˆ (å¯é€‰ï¼šåœ¨æ§åˆ¶å°æˆ–è€…å³ä¸Šè§’å°ç»¿ç‚¹)
            // console.log("âœ… é»‘åŒ£å­å·²è‡ªåŠ¨å¤‡ä»½ " + new Date().toLocaleTimeString());
        } catch (e) {
            console.error("è‡ªåŠ¨å¤‡ä»½å¤±è´¥ (å¯èƒ½æ˜¯ç©ºé—´æ»¡äº†):", e);
        }
    }

    // 4. ğŸ“¤ æ ¸å¿ƒï¼šä»æœ¬åœ°æ¢å¤
    window.restoreFromBlackBox = function() {
        try {
            var json = localStorage.getItem(AUTO_SAVE_KEY);
            if (!json) {
                console.log("ğŸ“­ é»‘åŒ£å­æ˜¯ç©ºçš„ï¼Œè·³è¿‡æ¢å¤ã€‚");
                return;
            }

            var data = JSON.parse(json);
            console.log("ğŸ“¦ æ­£åœ¨ä»é»‘åŒ£å­æ¢å¤æ•°æ®...", new Date(data.timestamp).toLocaleString());

            // A. æ¢å¤è¾“å…¥æ¡†
            function setVal(id, val) { 
                var el = document.getElementById(id); 
                if (el) el.value = val || ""; 
            }
            for (var key in data.inputs) {
                setVal(key, data.inputs[key]);
            }

            // B. æ¢å¤å…¨å±€å˜é‡
            window.currentWorldInfo = data.globals.worldInfo || { entries: [] };
            window.currentCardRegexes = data.globals.regexScripts || [];
            window.frontendStyleGuide = data.globals.styleGuide || ""; // æ¢å¤ç¾åŒ–æ–‡ä»¶
            window.currentSelectedTags = data.globals.selectedTags || { identity:[], personality:[], trope:[] };
            window.advisorMode = data.globals.advisorMode || 'normal';

            // C. åˆ·æ–°ç•Œé¢ (è®©æ•°æ®å¯è§)
            if (typeof renderWorldList === 'function') renderWorldList();
            if (typeof renderRegexList === 'function') renderRegexList();
            if (typeof renderWizardTags === 'function') renderWizardTags();
            if (typeof updatePreviewUI === 'function') updatePreviewUI();
            
            // D. æ¢å¤åŒæ­¥çŠ¶æ€ (å±æ€§ <-> é«˜çº§)
            if (typeof syncStatToNote === 'function') syncStatToNote();

            // E. ç‰¹æ®Šï¼šå¦‚æœæ¢å¤äº†ç¾åŒ–æ–‡ä»¶ï¼Œæ›´æ–°ä¸€ä¸‹æŒ‰é’®çŠ¶æ€æç¤ºç”¨æˆ·
            if (window.frontendStyleGuide) {
                // å°è¯•æ‰¾åŸç”Ÿä¸Šä¼ è¡¥ä¸çš„é‚£ä¸ªçŠ¶æ€æ 
                var statusEl = document.getElementById('native_upload_status');
                if (statusEl) {
                    statusEl.innerHTML = `âœ… <b>å·²è‡ªåŠ¨æ¢å¤ç¾åŒ–æ–‡ä»¶</b> (å¤§å°: ${Math.ceil(window.frontendStyleGuide.length/1024)}KB)`;
                    status.style.color = "#00b894";
                }
            }

            // F. æç¤ºç”¨æˆ·
            if(window.auth && window.auth.toast) window.auth.toast('â™»ï¸ ç°åœºå·²æ¢å¤ (é˜²ä¸¢æ•°æ®)');

        } catch (e) {
            console.error("æ¢å¤å¤±è´¥:", e);
        }
    };

    // 5. å¯åŠ¨å¼•æ“
    // A. ç«‹å³å°è¯•æ¢å¤ä¸€æ¬¡
    setTimeout(window.restoreFromBlackBox, 500); 

    // B. å¯åŠ¨è‡ªåŠ¨ä¿å­˜ (æ¯ 3 ç§’å­˜ä¸€æ¬¡)
    setInterval(saveToBlackBox, 3000);

    // C. ç»‘å®šæ‰‹åŠ¨ä¿å­˜ (åœ¨è¾“å…¥æ¡†æ‰“å­—æ—¶ä¹Ÿè§¦å‘ä¿å­˜ï¼ŒåŒé‡ä¿é™©)
    document.body.addEventListener('input', function(e) {
        // ç®€å•çš„é˜²æŠ–ï¼Œæ‰“å­—åœä¸‹ 1ç§’ åä¿å­˜
        if (window.saveTimer) clearTimeout(window.saveTimer);
        window.saveTimer = setTimeout(saveToBlackBox, 1000);
    });

    console.log("âœ… V37.0 é»‘åŒ£å­å·²å¯åŠ¨ï¼šæ‚¨çš„æ•°æ®ç°åœ¨å®‰å…¨äº†");

})();

// ================= ğŸ‘‘ å†™å¡å™¨ä»£ç ç»“æŸ =================

// =================ğŸ®è”æœºä»£ç å¼€å§‹=================

window.enterGameLobby = function() {
    // 1. æ‰“åŒ…è¡Œæï¼ˆå‡†å¤‡æ•°æ®ï¼‰
    // æŠŠå½“å‰ä¸»é¡µçš„é‡è¦ä¿¡æ¯å­˜ä¸€ä¸‹ï¼Œç¡®ä¿æ–°é¡µé¢èƒ½ç”¨åˆ°
    const config = JSON.parse(localStorage.getItem('my_ai_config')) || {};
    
    // ç®€å•çš„æ ¡éªŒ
    if(!config.apiKey) {
        if(confirm("âš ï¸ å°šæœªé…ç½® API Keyï¼Œè”æœºå¤§å…çš„ AI åŠŸèƒ½å°†æ— æ³•ä½¿ç”¨ã€‚\nè¦ç»§ç»­å—ï¼Ÿ")) {
            // ç”¨æˆ·åšæŒè¦è¿›ï¼Œé‚£å°±è¿›
        } else {
            return; // å–æ¶ˆ
        }
    }

    // 2. è§†è§‰åé¦ˆ
    auth.toast('ğŸš€ æ­£åœ¨è¿æ¥é‡å­é€šé“...');
    
    // 3. å¼€å¯ä¼ é€é—¨
    // 'MyGameLobbyWindow' æ˜¯çª—å£çš„åå­—ã€‚
    // å¦‚æœçª—å£å·²ç»æ‰“å¼€ï¼Œæµè§ˆå™¨ä¼šç›´æ¥åˆ‡è¿‡å»ï¼Œè€Œä¸æ˜¯æ–°å¼€ä¸€ä¸ªæ ‡ç­¾é¡µï¼
    const lobbyUrl = 'game_loppy.html'; // ç¡®ä¿ä½ çš„æ–°æ–‡ä»¶åæ˜¯è¿™ä¸ª
    const win = window.open(lobbyUrl, 'MyGameLobbyWindow');
    
    if (win) {
        win.focus(); // èšç„¦åˆ°æ–°çª—å£
    } else {
        alert('è¯·å…è®¸å¼¹å‡ºçª—å£ï¼Œå¦åˆ™æ— æ³•è¿›å…¥å¤§å…ï¼');
    }
};


    </script>
</body>
</html>
