<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ“š æ¢¨æ¢¨è—ä¹¦é˜ (Proç‰ˆ)</title>
    <style>
        /* --- 1. åŸºç¡€è®¾ç½® --- */
        @font-face {
            font-family: 'MyCustomFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --primary: #ffb7c5;
            --bg: #ffe6eb;
            --card-bg: #fff;
            --text: #5d4037;
            --accent: #ff8fa3;
        }

        body {
            font-family: 'MyCustomFont', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
            transition: background 0.3s;
        }

        /* --- 2. é¡¶éƒ¨æ  (å«æœç´¢) --- */
        .header {
            background: rgba(255,255,255,0.9); padding: 10px 15px;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 18px; font-weight: bold; color: var(--accent); }
        
        /* æœç´¢æ¡† */
        .search-box {
            background: #f0f0f0; border-radius: 20px; padding: 5px 15px;
            display: flex; align-items: center; gap: 5px;
        }
        .search-input {
            border: none; background: transparent; outline: none;
            width: 100%; font-size: 14px; color: #555;
        }

        .btn {
            border: none; padding: 6px 12px; border-radius: 15px;
            font-size: 13px; cursor: pointer; transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
        .btn-icon { background: transparent; font-size: 20px; padding: 5px; }

        /* --- 3. ä¹¦æ¶åˆ—è¡¨ --- */
        .grid {
            flex: 1; overflow-y: auto; padding: 15px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px; align-content: start;
        }
        
        .book {
            display: flex; flex-direction: column; gap: 5px; cursor: pointer;
            animation: fadeIn 0.3s;
        }
        .cover {
            aspect-ratio: 2/3; background: var(--card-bg); border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border: 2px solid transparent; transition: 0.2s; position: relative;
        }
        .book:hover .cover { transform: translateY(-3px); border-color: var(--accent); }
        .book-title { font-size: 13px; font-weight: bold; line-height: 1.3; max-height: 2.6em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .book-info { font-size: 10px; color: #888; }

        /* çŠ¶æ€æ ‡è®° */
        .status-dot {
            position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; border-radius: 50%;
        }
        .dot-green { background: #4caf50; } /* å®Œç»“ */
        .dot-orange { background: #ff9800; } /* è¿è½½ */

        /* --- 4. è¯¦æƒ…é¡µå¼¹çª— --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; animation: popIn 0.2s; }

        .detail-card {
            background: white; width: 85%; max-width: 400px;
            border-radius: 15px; overflow: hidden; display: flex; flex-direction: column;
        }
        .detail-header {
            background: var(--bg); padding: 20px; text-align: center;
        }
        .detail-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-label { font-size: 12px; color: #888; font-weight: bold; }
        .form-input {
            border: 1px solid #ddd; padding: 8px; border-radius: 8px;
            font-size: 14px; outline: none;
        }
        .form-input:focus { border-color: var(--primary); }
        
        .tag-container { display: flex; gap: 5px; flex-wrap: wrap; }
        .tag-chip { background: #f0f0f0; padding: 2px 8px; border-radius: 10px; font-size: 12px; color: #666; }

        /* --- 5. é˜…è¯»å™¨ --- */
        .reader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fdf6e3; z-index: 2000; display: none; flex-direction: column;
        }
        .reader.active { display: flex; }
        .reader-nav {
            padding: 10px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.8); border-bottom: 1px solid #eee;
        }
        .reader-text {
            flex: 1; overflow-y: auto; padding: 20px; font-size: 18px; line-height: 1.8;
            white-space: pre-wrap; text-align: justify; max-width: 800px; margin: 0 auto;
        }

        /* åº•éƒ¨è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; padding: 20px; border-radius: 20px 20px 0 0;
            transform: translateY(100%); transition: 0.3s;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1); box-sizing: border-box;
        }
        .settings-panel.show { transform: translateY(0); }

        .back-home {
            position: fixed; bottom: 20px; right: 20px; width: 45px; height: 45px;
            background: white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center; font-size: 20px;
            border: 2px solid var(--primary); z-index: 90;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="title">ğŸ“š è—ä¹¦é˜ Pro</div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-icon" onclick="toggleTheme()" title="æ¢è‚¤">ğŸ¨</button>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥</button>
                <input type="file" id="fileInput" accept=".txt" multiple style="display:none" onchange="handleImport(this)">
            </div>
        </div>
        <div class="search-box">
            <span>ğŸ”</span>
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ä¹¦åã€æ ‡ç­¾ã€å¹³å°..." onkeyup="handleSearch()">
        </div>
    </div>

    <div class="grid" id="bookGrid">
        </div>

    <div class="modal-overlay" id="detailModal">
        <div class="detail-card">
            <div class="detail-header">
                <div style="font-size:40px; margin-bottom:10px;">ğŸ“–</div>
                <div id="detailTitle" style="font-weight:bold; font-size:16px;"></div>
                <div id="detailSize" style="font-size:12px; color:#888; margin-top:5px;"></div>
            </div>
            <div class="detail-body">
                <div class="form-group">
                    <label class="form-label">å½“å‰çŠ¶æ€</label>
                    <select id="detailStatus" class="form-input">
                        <option value="reading">â³ è¿è½½ä¸­</option>
                        <option value="finished">âœ… å·²å®Œç»“</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æ¥æºå¹³å°</label>
                    <input type="text" id="detailPlatform" class="form-input" placeholder="ä¾‹å¦‚ï¼šæ™‹æ±Ÿã€èµ·ç‚¹...">
                </div>
                <div class="form-group">
                    <label class="form-label">æ ‡ç­¾ (ç”¨ç©ºæ ¼æˆ–é€—å·åˆ†éš”)</label>
                    <input type="text" id="detailTags" class="form-input" placeholder="ä¾‹å¦‚ï¼šç”œå®  å¤ä»£ ç ´é•œé‡åœ†">
                </div>
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-primary" style="flex:1; padding:10px;" onclick="startReading()">ğŸ“– å¼€å§‹é˜…è¯»</button>
                    <button class="btn" style="background:#ffebee; color:#d32f2f;" onclick="saveAndCloseDetail()">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
                    <button class="btn" onclick="deleteCurrentBook()">ğŸ—‘ï¸</button>
                </div>
                <button class="btn" style="width:100%; border:1px solid #ddd; background:white;" onclick="closeDetail()">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="reader" id="readerPage">
        <div class="reader-nav">
            <button class="btn btn-icon" onclick="closeReader()">â¬…ï¸</button>
            <span id="readerTitle" style="font-weight:bold; font-size:14px; overflow:hidden; white-space:nowrap; max-width:60%;">æ ‡é¢˜</span>
            <button class="btn btn-icon" onclick="toggleSettings()">âš™ï¸</button>
        </div>
        <div class="reader-text" id="readerContent" onclick="toggleSettings(false)"></div>
        
        <div class="settings-panel" id="settingsPanel">
            <div style="margin-bottom:15px; display:flex; gap:10px;">
                <span style="font-size:12px;">èƒŒæ™¯</span>
                <div onclick="setTheme('#fdf6e3','#333')" style="width:25px;height:25px;background:#fdf6e3;border:1px solid #ccc;border-radius:50%;"></div>
                <div onclick="setTheme('#fff','#000')" style="width:25px;height:25px;background:#fff;border:1px solid #ccc;border-radius:50%;"></div>
                <div onclick="setTheme('#1a1a1a','#ccc')" style="width:25px;height:25px;background:#1a1a1a;border-radius:50%;"></div>
                <div onclick="setTheme('#c8e6c9','#1b5e20')" style="width:25px;height:25px;background:#c8e6c9;border-radius:50%;"></div>
            </div>
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <span style="font-size:12px;">å­—å·</span>
                <input type="range" min="14" max="32" value="18" style="flex:1" oninput="setStyle('fontSize', this.value+'px')">
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:12px;">è¡Œè·</span>
                <input type="range" min="1.4" max="2.5" step="0.1" value="1.8" style="flex:1" oninput="setStyle('lineHeight', this.value)">
            </div>
        </div>
    </div>

    <div class="back-home" onclick="goBackMain()">ğŸ </div>

    <script>
        /* ================= IndexedDB æ•°æ®åº“å°è£… (è¿™æ˜¯å¤§å­˜å‚¨çš„æ ¸å¿ƒ) ================= */
        const DB_NAME = 'LiliNovelDB';
        const DB_VERSION = 1;
        let db;

        // æ‰“å¼€/åˆ›å»ºæ•°æ®åº“
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains('novels')) {
                        // åˆ›å»ºä¹¦æ¶è¡¨ï¼šidä¸ºä¸»é”®
                        const store = db.createObjectStore('novels', { keyPath: 'id' });
                        store.createIndex('title', 'title', { unique: false });
                    }
                };

                request.onsuccess = (e) => {
                    db = e.target.result;
                    renderBooks(); // åˆå§‹åŒ–å®Œæˆåæ¸²æŸ“åˆ—è¡¨
                    resolve(db);
                };
                
                request.onerror = (e) => reject(e);
            });
        }

        // æ·»åŠ ä¹¦ç±
        function addBookToDB(book) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(['novels'], 'readwrite');
                const store = tx.objectStore('novels');
                store.add(book);
                tx.oncomplete = () => resolve();
                tx.onerror = (e) => reject(e);
            });
        }

        // è·å–æ‰€æœ‰ä¹¦ç± (ä¸ºäº†åˆ—è¡¨)
        function getAllBooks() {
            return new Promise((resolve) => {
                const tx = db.transaction(['novels'], 'readonly');
                const store = tx.objectStore('novels');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
            });
        }

        // æ›´æ–°ä¹¦ç±ä¿¡æ¯
        function updateBookInDB(book) {
            const tx = db.transaction(['novels'], 'readwrite');
            const store = tx.objectStore('novels');
            store.put(book);
            return new Promise(resolve => tx.oncomplete = resolve);
        }

        // åˆ é™¤ä¹¦ç±
        function deleteBookFromDB(id) {
            const tx = db.transaction(['novels'], 'readwrite');
            const store = tx.objectStore('novels');
            store.delete(id);
            return new Promise(resolve => tx.oncomplete = resolve);
        }

        /* ================= ä¸šåŠ¡é€»è¾‘ ================= */
        
        let currentBook = null; // å½“å‰æ­£åœ¨æŸ¥çœ‹/é˜…è¯»çš„ä¹¦
        let allBooksCache = []; // ç”¨äºæœç´¢çš„ç¼“å­˜

        // 1. å¯¼å…¥å¤„ç†
        async function handleImport(input) {
            const files = Array.from(input.files);
            if (!files.length) return;

            let count = 0;
            for (const file of files) {
                const text = await readFile(file);
                const book = {
                    id: Date.now() + Math.random().toString(), // å”¯ä¸€ID
                    title: file.name.replace('.txt', ''),
                    content: text,
                    size: (file.size / 1024).toFixed(1) + ' KB',
                    status: 'reading', // reading(è¿è½½) / finished(å®Œç»“)
                    platform: '',
                    tags: '',
                    addDate: new Date().toLocaleDateString()
                };
                await addBookToDB(book);
                count++;
            }
            alert(`âœ… æˆåŠŸå­˜å…¥ ${count} æœ¬ä¹¦ï¼(ä½¿ç”¨ä¸“ä¸šæ•°æ®åº“ï¼Œç¨³ï¼)`);
            input.value = '';
            renderBooks();
        }

        function readFile(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsText(file);
            });
        }

        // 2. æ¸²æŸ“ä¹¦æ¶åˆ—è¡¨
        async function renderBooks(filterText = '') {
            const grid = document.getElementById('bookGrid');
            grid.innerHTML = '';
            
            // è·å–æœ€æ–°æ•°æ®
            allBooksCache = await getAllBooks();
            // å€’åºæ’åˆ—ï¼Œæ–°å¯¼å…¥çš„åœ¨å‰é¢
            allBooksCache.reverse();

            // æœç´¢è¿‡æ»¤
            let list = allBooksCache;
            if (filterText) {
                const lowerText = filterText.toLowerCase();
                list = list.filter(b => 
                    b.title.toLowerCase().includes(lowerText) || 
                    (b.tags && b.tags.includes(lowerText)) || 
                    (b.platform && b.platform.includes(lowerText))
                );
            }

            if (list.length === 0) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999; margin-top:50px;">ä¹¦æ¶ç©ºç©ºçš„...</div>';
                return;
            }

            list.forEach(book => {
                const el = document.createElement('div');
                el.className = 'book';
                // çŠ¶æ€åœ†ç‚¹
                const dotClass = book.status === 'finished' ? 'dot-green' : 'dot-orange';
                
                el.innerHTML = `
                    <div class="cover">
                        ğŸ“–
                        <div class="status-dot ${dotClass}" title="${book.status==='finished'?'å·²å®Œç»“':'è¿è½½ä¸­'}"></div>
                    </div>
                    <div>
                        <div class="book-title">${book.title}</div>
                        <div class="book-info">${book.platform || 'æœ¬åœ°'} Â· ${book.status==='finished'?'å®Œ':'è¿'}</div>
                    </div>
                `;
                el.onclick = () => openDetail(book);
                grid.appendChild(el);
            });
        }

        // 3. è¯¦æƒ…é¡µé€»è¾‘
        function openDetail(book) {
            currentBook = book;
            document.getElementById('detailTitle').innerText = book.title;
            document.getElementById('detailSize').innerText = 'å¤§å°: ' + book.size;
            document.getElementById('detailStatus').value = book.status;
            document.getElementById('detailPlatform').value = book.platform || '';
            document.getElementById('detailTags').value = book.tags || '';
            
            document.getElementById('detailModal').classList.add('active');
        }

        function closeDetail() {
            document.getElementById('detailModal').classList.remove('active');
        }

        async function saveAndCloseDetail() {
            if (!currentBook) return;
            // æ›´æ–°æ•°æ®
            currentBook.status = document.getElementById('detailStatus').value;
            currentBook.platform = document.getElementById('detailPlatform').value;
            currentBook.tags = document.getElementById('detailTags').value;

            await updateBookInDB(currentBook);
            closeDetail();
            renderBooks(document.getElementById('searchInput').value); // åˆ·æ–°åˆ—è¡¨
        }

        async function deleteCurrentBook() {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ã€Š${currentBook.title}ã€‹å—ï¼Ÿ`)) {
                await deleteBookFromDB(currentBook.id);
                closeDetail();
                renderBooks();
            }
        }

        // 4. é˜…è¯»å™¨é€»è¾‘
        function startReading() {
            if (!currentBook) return;
            document.getElementById('readerTitle').innerText = currentBook.title;
            // åªæœ‰ç‚¹å‡»é˜…è¯»æ—¶æ‰åŠ è½½å†…å®¹ï¼Œç•Œé¢æ›´æµç•…
            document.getElementById('readerContent').innerText = currentBook.content;
            
            document.getElementById('readerPage').classList.add('active');
            closeDetail(); // å…³é—­è¯¦æƒ…é¡µ
            
            // æ¢å¤æ ·å¼
            const pref = JSON.parse(localStorage.getItem('lili_reader_pref_v2') || '{}');
            if(pref.fontSize) setStyle('fontSize', pref.fontSize);
            if(pref.lineHeight) setStyle('lineHeight', pref.lineHeight);
            if(pref.bg) setTheme(pref.bg, pref.color);
        }

        function closeReader() {
            document.getElementById('readerPage').classList.remove('active');
            // æ¸…ç©ºå†…å®¹é˜²æ­¢å ç”¨å†…å­˜
            setTimeout(() => { document.getElementById('readerContent').innerText = ''; }, 300);
        }

        // 5. æœç´¢åŠŸèƒ½
        function handleSearch() {
            const text = document.getElementById('searchInput').value;
            renderBooks(text);
        }

        // 6. æ¢è‚¤ä¸æ ·å¼
        function toggleTheme() {
            const root = document.documentElement;
            // ç®€å•åˆ‡æ¢ä¸¤ä¸ªä¸»é¢˜æ¼”ç¤º
            const current = root.style.getPropertyValue('--bg');
            if (current.includes('#ffe6eb')) { // ç²‰ -> ç»¿
                root.style.setProperty('--primary', '#66bb6a');
                root.style.setProperty('--bg', '#e8f5e9');
                root.style.setProperty('--accent', '#43a047');
            } else if (current.includes('#e8f5e9')) { // ç»¿ -> è“
                 root.style.setProperty('--primary', '#42a5f5');
                 root.style.setProperty('--bg', '#e3f2fd');
                 root.style.setProperty('--accent', '#1e88e5');
            } else { // è“ -> ç²‰
                root.style.setProperty('--primary', '#ffb7c5');
                root.style.setProperty('--bg', '#ffe6eb');
                root.style.setProperty('--accent', '#ff8fa3');
            }
        }

        function toggleSettings(force) {
            const p = document.getElementById('settingsPanel');
            if (force === false) p.classList.remove('show');
            else p.classList.toggle('show');
        }

        function setStyle(prop, val) {
            document.getElementById('readerContent').style[prop] = val;
            savePref(prop, val);
        }

        function setTheme(bg, color) {
            const page = document.getElementById('readerPage');
            page.style.background = bg;
            page.style.color = color;
            document.querySelector('.reader-nav').style.background = bg === '#1a1a1a' ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.9)';
            document.querySelector('.reader-nav').style.color = bg === '#1a1a1a' ? '#ccc' : '#333';
            savePref('bg', bg);
            savePref('color', color);
        }

        function savePref(k, v) {
            const p = JSON.parse(localStorage.getItem('lili_reader_pref_v2') || '{}');
            p[k] = v;
            localStorage.setItem('lili_reader_pref_v2', JSON.stringify(p));
        }

        function goBackMain() {
            if (document.referrer) history.back();
            else window.location.href = 'ä¸»ç³»ç»Ÿ.txt';
        }

        // åˆå§‹åŒ–
        initDB();

    </script>
</body>
</html>
