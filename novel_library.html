<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ“š æ¢¨æ¢¨è—ä¹¦é˜</title>
    <style>
        /* --- 1. æ ¸å¿ƒå­—ä½“ä¸åŸºç¡€æ ·å¼ (å¤ç”¨ä¸»ç³»ç»Ÿ) --- */
        @font-face {
            font-family: 'MyCustomFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            /* é»˜è®¤ç²‰è‰²ä¸»é¢˜ï¼ŒJSä¼šè‡ªåŠ¨è¯»å–ä¸»ç³»ç»Ÿçš„ä¸»é¢˜ */
            --primary-color: #ffb7c5;
            --secondary-color: #ffe6eb;
            --accent-color: #ff8fa3;
            --text-color: #6d5c5c;
            --bg-color: #fff0f5;
        }

        body {
            font-family: 'MyCustomFont', 'Microsoft YaHei', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- 2. é¡¶éƒ¨å¯¼èˆªæ  --- */
        .nav-header {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }
        .app-title {
            font-size: 20px; font-weight: bold; color: var(--accent-color);
            display: flex; align-items: center; gap: 10px;
        }
        
        /* æŒ‰é’®æ ·å¼å¤ç”¨ */
        button { cursor: pointer; font-family: inherit; transition: 0.2s; border: none; outline: none; }
        button:active { transform: scale(0.95); }
        
        .btn-primary {
            background: var(--accent-color); color: white;
            padding: 8px 15px; border-radius: 20px; font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 143, 163, 0.3);
        }
        .btn-ghost {
            background: white; border: 1px solid #ddd; color: #666;
            padding: 6px 12px; border-radius: 15px; font-size: 12px;
        }
        .btn-ghost.active {
            background: var(--primary-color); color: white; border-color: var(--primary-color);
        }

        /* --- 3. ç­›é€‰å·¥å…·æ  --- */
        .filter-bar {
            padding: 10px 20px; background: rgba(255,255,255,0.6);
            display: flex; gap: 10px; overflow-x: auto;
            border-bottom: 1px solid rgba(255,255,255,0.5);
        }

        /* --- 4. ä¹¦æ¶ç½‘æ ¼ --- */
        .library-grid {
            flex: 1; overflow-y: auto; padding: 20px;
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* æ‰‹æœºç«¯ä¸€è¡Œä¸¤ä¸ª */
            gap: 15px; align-content: start;
        }
        
        /* ğŸ“– ä¹¦ç±å¡ç‰‡ */
        .book-card {
            background: #fff; border-radius: 12px; padding: 15px;
            position: relative; display: flex; flex-direction: column;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border: 2px solid transparent;
            transition: all 0.2s; height: 180px;
        }
        .book-card:hover { transform: translateY(-3px); border-color: var(--accent-color); }
        
        .book-icon { font-size: 40px; text-align: center; margin-bottom: 10px; }
        .book-title { 
            font-weight: bold; font-size: 14px; margin-bottom: 5px;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            flex: 1;
        }
        .book-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 8px; }
        .tag { font-size: 10px; padding: 2px 5px; border-radius: 4px; background: #eee; color: #666; }
        .tag.finish { background: #e8f5e9; color: #2e7d32; } /* å®Œç»“ç»¿ */
        .tag.reading { background: #fff3e0; color: #ef6c00; } /* è¿è½½æ©™ */
        
        .book-actions { display: flex; justify-content: space-between; border-top: 1px dashed #eee; padding-top: 8px; }

        /* --- 5. é˜…è¯»å™¨ (å…¨å±è¦†ç›–) --- */
        .reader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fdf6e3; /* é»˜è®¤ç¾Šçš®çº¸è‰² */
            z-index: 2000; display: none; flex-direction: column;
            transition: background 0.3s, color 0.3s;
        }
        .reader-overlay.active { display: flex; }

        .reader-top {
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.05); font-size: 12px; color: inherit;
        }
        
        .reader-content {
            flex: 1; overflow-y: auto; padding: 20px;
            font-size: 18px; line-height: 1.8; text-align: justify;
            white-space: pre-wrap; /* ä¿ç•™æ’ç‰ˆ */
            scroll-behavior: smooth;
        }

        /* é˜…è¯»å™¨è®¾ç½®é¢æ¿ */
        .reader-settings {
            background: #fff; padding: 20px; border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            position: absolute; bottom: 0; width: 100%; box-sizing: border-box;
            transform: translateY(100%); transition: transform 0.3s;
        }
        .reader-settings.open { transform: translateY(0); }
        
        .setting-row { display: flex; align-items: center; margin-bottom: 15px; gap: 10px; font-size: 13px; }
        .setting-label { width: 50px; color: #888; }
        input[type=range] { flex: 1; accent-color: var(--accent-color); }

        /* è¿”å›ä¸»é¡µæ‚¬æµ®çƒ */
        .back-home-btn {
            position: fixed; bottom: 20px; right: 20px;
            width: 50px; height: 50px; border-radius: 50%;
            background: white; border: 3px solid var(--primary-color);
            box-shadow: 0 5px 15px rgba(255, 117, 143, 0.3);
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; cursor: pointer; z-index: 500;
        }
        .back-home-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <div class="nav-header">
        <div class="app-title">ğŸ“š æ¢¨æ¢¨è—ä¹¦é˜</div>
        <div>
            <button class="btn-primary" onclick="document.getElementById('importInput').click()">ğŸ“¥ å¯¼å…¥å°è¯´</button>
            <input type="file" id="importInput" accept=".txt" multiple style="display:none" onchange="importNovels(this)">
        </div>
    </div>

    <div class="filter-bar">
        <button class="btn-ghost active" onclick="filterList('all', this)">å…¨éƒ¨</button>
        <button class="btn-ghost" onclick="filterList('reading', this)">â³ è¿è½½ä¸­</button>
        <button class="btn-ghost" onclick="filterList('finished', this)">âœ… å·²å®Œç»“</button>
        <div style="width:1px; background:#ddd; margin:0 5px;"></div>
        <button class="btn-ghost" onclick="filterList('unread', this)">ğŸ”´ æœªçœ‹å®Œ</button>
        <button class="btn-ghost" onclick="filterList('read', this)">ğŸŸ¢ å·²çœ‹å®Œ</button>
    </div>

    <div class="library-grid" id="bookList">
        </div>

    <div class="back-home-btn" onclick="goBackMain()" title="è¿”å›ä¸»ç³»ç»Ÿ">ğŸ </div>

    <div class="reader-overlay" id="readerModal">
        <div class="reader-top">
            <button onclick="closeReader()" style="background:none; font-size:18px;">â¬…ï¸ è¿”å›ä¹¦æ¶</button>
            <span id="readTitle">æ ‡é¢˜</span>
            <button onclick="toggleSettings()" style="background:none; font-size:18px;">âš™ï¸ è®¾ç½®</button>
        </div>
        
        <div class="reader-content" id="readContent" onclick="toggleSettings(false)">
            å†…å®¹åŠ è½½ä¸­...
        </div>

        <div class="reader-settings" id="settingPanel">
            <div class="setting-row">
                <span class="setting-label">ä¸»é¢˜</span>
                <div style="display:flex; gap:10px; flex:1;">
                    <div onclick="setTheme('#fdf6e3', '#333')" style="width:30px;height:30px;background:#fdf6e3;border-radius:50%;border:1px solid #ccc;"></div>
                    <div onclick="setTheme('#fff', '#000')" style="width:30px;height:30px;background:#fff;border-radius:50%;border:1px solid #ccc;"></div>
                    <div onclick="setTheme('#1a1a1a', '#ccc')" style="width:30px;height:30px;background:#1a1a1a;border-radius:50%;border:1px solid #555;"></div>
                    <div onclick="setTheme('#e0f2f1', '#004d40')" style="width:30px;height:30px;background:#e0f2f1;border-radius:50%;border:1px solid #b2dfdb;"></div>
                    <div onclick="setTheme('#fff0f5', '#555')" style="width:30px;height:30px;background:#fff0f5;border-radius:50%;border:1px solid #ffb7c5;"></div>
                </div>
            </div>
            <div class="setting-row">
                <span class="setting-label">å­—å·</span>
                <span style="font-size:12px">å°</span>
                <input type="range" min="12" max="36" value="18" oninput="setStyle('fontSize', this.value + 'px')">
                <span style="font-size:18px">å¤§</span>
            </div>
            <div class="setting-row">
                <span class="setting-label">è¡Œè·</span>
                <input type="range" min="1" max="3" step="0.1" value="1.8" oninput="setStyle('lineHeight', this.value)">
            </div>
            <div class="setting-row">
                <span class="setting-label">è¾¹è·</span>
                <input type="range" min="0" max="50" value="20" oninput="setStyle('padding', '20px ' + this.value + 'px')">
            </div>
        </div>
    </div>

    <script>
        // --- æ•°æ®ä¸åˆå§‹åŒ– ---
        let novels = JSON.parse(localStorage.getItem('lili_novels') || '[]');
        
        // 1. åŒæ­¥ä¸»ç³»ç»Ÿçš„ä¸»é¢˜è‰² (å¦‚æœæœ‰çš„è¯)
        const globalTheme = JSON.parse(localStorage.getItem('lili_global_theme'));
        if(globalTheme) {
            document.documentElement.style.setProperty('--primary-color', globalTheme.primary);
            document.documentElement.style.setProperty('--accent-color', globalTheme.accent);
            document.documentElement.style.setProperty('--secondary-color', globalTheme.bg);
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ ---

        // å¯¼å…¥å°è¯´
        function importNovels(input) {
            const files = Array.from(input.files);
            if(files.length === 0) return;
            
            let loadedCount = 0;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    novels.push({
                        id: Date.now() + Math.random().toString(),
                        title: file.name.replace('.txt', ''),
                        content: e.target.result,
                        status: 'reading', // reading(è¿è½½) / finished(å®Œç»“)
                        isRead: false,     // false(æœªçœ‹) / true(å·²çœ‹)
                        addTime: new Date().toLocaleDateString()
                    });
                    loadedCount++;
                    if(loadedCount === files.length) {
                        saveAndRender();
                        alert(`æˆåŠŸå¯¼å…¥ ${loadedCount} æœ¬ä¹¦ï¼`);
                    }
                };
                reader.readAsText(file);
            });
        }

        // ä¿å­˜å¹¶åˆ·æ–°
        function saveAndRender(filter = 'all') {
            localStorage.setItem('lili_novels', JSON.stringify(novels));
            const grid = document.getElementById('bookList');
            grid.innerHTML = '';
            
            let list = novels;
            if(filter === 'reading') list = list.filter(n => n.status === 'reading');
            if(filter === 'finished') list = list.filter(n => n.status === 'finished');
            if(filter === 'unread') list = list.filter(n => !n.isRead);
            if(filter === 'read') list = list.filter(n => n.isRead);

            if(list.length === 0) {
                grid.innerHTML = '<div style="text-align:center;width:100%;color:#aaa;margin-top:50px;">ç©ºç©ºå¦‚ä¹Ÿ...</div>';
                return;
            }

            list.forEach(book => {
                const div = document.createElement('div');
                div.className = 'book-card';
                div.innerHTML = `
                    <div onclick="openReader('${book.id}')" style="cursor:pointer; flex:1; display:flex; flex-direction:column;">
                        <div class="book-icon">ğŸ“–</div>
                        <div class="book-title">${book.title}</div>
                        <div class="book-tags">
                            <span class="tag ${book.status === 'finished' ? 'finish' : 'reading'}">
                                ${book.status === 'finished' ? 'å·²å®Œç»“' : 'è¿è½½ä¸­'}
                            </span>
                            <span class="tag" style="${book.isRead ? 'background:#d1c4e9;color:#512da8' : 'background:#ffcdd2;color:#c62828'}">
                                ${book.isRead ? 'å·²çœ‹å®Œ' : 'æœªè¯»å®Œ'}
                            </span>
                        </div>
                    </div>
                    <div class="book-actions">
                        <button class="btn-ghost" onclick="toggleStatus('${book.id}', 'status')">åˆ‡æ¢è¿è½½</button>
                        <button class="btn-ghost" onclick="toggleStatus('${book.id}', 'isRead')">æ ‡ä¸ºå·²è¯»</button>
                        <button class="btn-ghost" style="color:#ff6b6b; border-color:#ffcccc;" onclick="deleteBook('${book.id}')">ğŸ—‘ï¸</button>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        // åˆ‡æ¢çŠ¶æ€
        function toggleStatus(id, field) {
            const book = novels.find(n => n.id === id);
            if(!book) return;
            
            if(field === 'status') {
                book.status = book.status === 'reading' ? 'finished' : 'reading';
            } else if(field === 'isRead') {
                book.isRead = !book.isRead;
            }
            saveAndRender();
        }

        // åˆ é™¤
        function deleteBook(id) {
            if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿ')) {
                novels = novels.filter(n => n.id !== id);
                saveAndRender();
            }
        }

        // ç­›é€‰æŒ‰é’®é«˜äº®
        function filterList(type, btn) {
            document.querySelectorAll('.filter-bar button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            saveAndRender(type);
        }

        // --- é˜…è¯»å™¨åŠŸèƒ½ ---
        let currentBookId = null;

        function openReader(id) {
            const book = novels.find(n => n.id === id);
            if(!book) return;
            currentBookId = id;
            
            document.getElementById('readTitle').innerText = book.title;
            document.getElementById('readContent').innerText = book.content;
            document.getElementById('readerModal').classList.add('active');
            
            // è¯»å–ä¹‹å‰çš„é˜…è¯»è®¾ç½®
            const style = JSON.parse(localStorage.getItem('lili_reader_pref') || '{}');
            if(style.fontSize) setStyle('fontSize', style.fontSize);
            if(style.lineHeight) setStyle('lineHeight', style.lineHeight);
            if(style.bg) setTheme(style.bg, style.color);
        }

        function closeReader() {
            document.getElementById('readerModal').classList.remove('active');
            document.getElementById('settingPanel').classList.remove('open');
        }

        function toggleSettings(force) {
            const panel = document.getElementById('settingPanel');
            if(force === false) panel.classList.remove('open');
            else panel.classList.toggle('open');
        }

        // æ ·å¼å®æ—¶ä¿®æ”¹
        function setStyle(prop, val) {
            document.getElementById('readContent').style[prop] = val;
            savePref(prop, val);
        }

        function setTheme(bg, color) {
            const modal = document.getElementById('readerModal');
            modal.style.background = bg;
            modal.style.color = color;
            
            // ä¿å­˜èƒŒæ™¯åå¥½
            savePref('bg', bg);
            savePref('color', color);
        }

        function savePref(key, val) {
            const style = JSON.parse(localStorage.getItem('lili_reader_pref') || '{}');
            style[key] = val;
            localStorage.setItem('lili_reader_pref', JSON.stringify(style));
        }

        // è¿”å›ä¸»ç³»ç»Ÿ
        function goBackMain() {
            // å‡è®¾ä¸»ç³»ç»Ÿæ–‡ä»¶åæ˜¯ä¸»ç³»ç»Ÿ.txtï¼Œæµè§ˆå™¨æ‰“å¼€é€šå¸¸éœ€è¦æ˜¯ .html ç»“å°¾
            // å¦‚æœä½ çš„ä¸»æ–‡ä»¶åæ˜¯ "ä¸»ç³»ç»Ÿ.html" è¯·ä¿®æ”¹ä¸‹é¢è¿™è¡Œ
            // ä¸ºäº†å®‰å…¨èµ·è§ï¼Œè¿™é‡Œåšä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå†å²è®°å½•é‡Œæœ‰ï¼Œå°±åé€€ï¼Œæ²¡æœ‰å°±å°è¯•è·³è½¬
            if(document.referrer) {
                history.back();
            } else {
                window.location.href = 'ä¸»ç³»ç»Ÿ.txt'; // æˆ–è€…æ˜¯ index.html
                // æç¤ºï¼šå»ºè®®æŠŠ "ä¸»ç³»ç»Ÿ.txt" é‡å‘½åä¸º "index.html" ä½“éªŒæ›´å¥½
            }
        }

        // åˆå§‹åŒ–æ¸²æŸ“
        saveAndRender();

    </script>
</body>
</html>
