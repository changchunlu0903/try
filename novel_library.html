<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ“š æ¢¨æ¢¨è—ä¹¦é˜ (æ™ºèƒ½åˆ†ç« ç‰ˆ)</title>
    <style>
        /* --- 1. åŸºç¡€è®¾ç½® --- */
        @font-face {
            font-family: 'MyCustomFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --primary: #ffb7c5;
            --bg: #ffe6eb;
            --card-bg: #fff;
            --text: #5d4037;
            --accent: #ff8fa3;
        }

        body {
            font-family: 'MyCustomFont', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
            transition: background 0.3s;
        }

        /* --- 2. é¡¶éƒ¨æ  --- */
        .header {
            background: rgba(255,255,255,0.95); padding: 10px 15px;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 18px; font-weight: bold; color: var(--accent); }
        
        .search-box {
            background: #f0f0f0; border-radius: 20px; padding: 6px 15px;
            display: flex; align-items: center; gap: 5px;
        }
        .search-input {
            border: none; background: transparent; outline: none;
            width: 100%; font-size: 14px; color: #555;
        }

        .btn {
            border: none; padding: 6px 12px; border-radius: 15px;
            font-size: 13px; cursor: pointer; transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
        .btn-icon { background: transparent; font-size: 20px; padding: 5px; }

        /* --- 3. ä¹¦æ¶åˆ—è¡¨ --- */
        .grid {
            flex: 1; overflow-y: auto; padding: 15px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px; align-content: start;
        }
        
        .book {
            display: flex; flex-direction: column; gap: 5px; cursor: pointer;
            animation: fadeIn 0.3s;
        }
        .cover {
            aspect-ratio: 2/3; background: var(--card-bg); border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border: 2px solid transparent; transition: 0.2s; position: relative;
        }
        .book:hover .cover { transform: translateY(-3px); border-color: var(--accent); }
        .book-title { font-size: 13px; font-weight: bold; line-height: 1.3; max-height: 2.6em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .book-info { font-size: 10px; color: #888; }
        
        /* è¿›åº¦æ¡ */
        .progress-bar-bg { position: absolute; bottom: 0; left:0; width:100%; height:4px; background:#eee; border-radius: 0 0 8px 8px; overflow:hidden;}
        .progress-bar-fill { height:100%; background:var(--primary); width:0%; transition: width 0.3s; }

        .status-dot {
            position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; border-radius: 50%;
        }
        .dot-green { background: #4caf50; } 
        .dot-orange { background: #ff9800; }

        /* --- 4. è¯¦æƒ…é¡µ & ç›®å½• --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; animation: popIn 0.2s; }

        .detail-card {
            background: white; width: 85%; max-width: 400px;
            border-radius: 15px; overflow: hidden; display: flex; flex-direction: column;
        }
        .detail-header { background: var(--bg); padding: 20px; text-align: center; }
        .detail-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-label { font-size: 12px; color: #888; font-weight: bold; }
        .form-input {
            border: 1px solid #ddd; padding: 8px; border-radius: 8px;
            font-size: 14px; outline: none;
        }

        /* --- 5. é˜…è¯»å™¨ (ç« èŠ‚ç‰ˆ) --- */
        .reader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fdf6e3; z-index: 2000; display: none; flex-direction: column;
        }
        .reader.active { display: flex; }
        .reader-nav {
            padding: 10px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.9); border-bottom: 1px solid #eee; height: 50px; box-sizing: border-box;
        }
        
        .reader-container {
            flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        .reader-text {
            flex: 1; overflow-y: auto; padding: 20px 20px 80px 20px; /* åº•éƒ¨é¢„ç•™ç©ºé—´ */
            font-size: 18px; line-height: 1.8;
            white-space: pre-wrap; text-align: justify; max-width: 800px; margin: 0 auto;
        }
        
        /* åº•éƒ¨æ§åˆ¶æ¡ */
        .reader-footer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.95); padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            border-top: 1px solid #eee; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            box-sizing: border-box; gap: 10px;
        }
        .page-btn {
            background: var(--primary); color: white; border: none;
            padding: 8px 15px; border-radius: 20px; font-size: 14px; flex: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); white-space: nowrap;
        }
        .page-btn.secondary { background: #fff; color: #666; border: 1px solid #ddd; box-shadow:none; flex: 0 0 auto;}
        .chapter-info { font-size: 12px; color: #666; text-align: center; width: 100%; margin-bottom: 5px;}

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; padding: 20px; border-radius: 20px 20px 0 0;
            transform: translateY(100%); transition: 0.3s;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1); box-sizing: border-box; z-index: 2100;
        }
        .settings-panel.show { transform: translateY(0); }

        /* ç›®å½•ä¾§è¾¹æ  */
        .toc-drawer {
            position: fixed; top: 0; left: 0; width: 70%; max-width: 300px; height: 100%;
            background: white; z-index: 2200; box-shadow: 5px 0 15px rgba(0,0,0,0.1);
            transform: translateX(-100%); transition: 0.3s; display: flex; flex-direction: column;
        }
        .toc-drawer.open { transform: translateX(0); }
        .toc-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; background: var(--bg); color: var(--text); display:flex; justify-content:space-between; align-items:center;}
        .toc-list { flex: 1; overflow-y: auto; }
        .toc-item { 
            padding: 12px 15px; border-bottom: 1px solid #f5f5f5; font-size: 14px; cursor: pointer; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .toc-item.active { color: var(--primary); background: #fff0f5; font-weight: bold; }

        /* é®ç½©å±‚ (ç”¨äºç‚¹å‡»å…³é—­è®¾ç½®æˆ–ç›®å½•) */
        .touch-mask {
            position: fixed; top:0; left:0; width:100%; height:100%; z-index: 2050; display:none;
        }
        .touch-mask.active { display:block; }

        .back-home {
            position: fixed; bottom: 20px; right: 20px; width: 45px; height: 45px;
            background: white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center; font-size: 20px;
            border: 2px solid var(--primary); z-index: 90;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="title">ğŸ“š è—ä¹¦é˜ (æ™ºèƒ½ç« èŠ‚ç‰ˆ)</div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-icon" onclick="toggleTheme()" title="æ¢è‚¤">ğŸ¨</button>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥</button>
                <input type="file" id="fileInput" accept=".txt" multiple style="display:none" onchange="handleImport(this)">
            </div>
        </div>
        <div class="search-box">
            <span>ğŸ”</span>
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ä¹¦å..." onkeyup="handleSearch()">
        </div>
    </div>

    <div class="grid" id="bookGrid"></div>

    <div class="modal-overlay" id="detailModal">
        <div class="detail-card">
            <div class="detail-header">
                <div style="font-size:40px; margin-bottom:10px;">ğŸ“–</div>
                <div id="detailTitle" style="font-weight:bold; font-size:16px;"></div>
                <div id="detailCount" style="font-size:12px; color:#888; margin-top:5px;"></div>
            </div>
            <div class="detail-body">
                <div class="form-group">
                    <label class="form-label">é˜…è¯»çŠ¶æ€</label>
                    <select id="detailStatus" class="form-input">
                        <option value="reading">â³ è¿è½½ä¸­</option>
                        <option value="finished">âœ… å·²å®Œç»“</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æ¥æº / æ ‡ç­¾</label>
                    <input type="text" id="detailInfo" class="form-input" placeholder="ä¾‹å¦‚ï¼šæ™‹æ±Ÿã€ç”œå® ...">
                </div>
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-primary" style="flex:1; padding:10px;" onclick="startReading()">ğŸ“– è¿›å…¥é˜…è¯»</button>
                    <button class="btn" style="background:#ffebee; color:#d32f2f;" onclick="saveAndCloseDetail()">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn" onclick="deleteCurrentBook()">ğŸ—‘ï¸</button>
                </div>
                <button class="btn" style="width:100%; border:1px solid #ddd; background:white;" onclick="closeDetail()">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="reader" id="readerPage">
        <div class="reader-nav">
            <button class="btn btn-icon" onclick="closeReader()">â¬…ï¸</button>
            <span id="readerTitle" style="font-weight:bold; font-size:14px; overflow:hidden; white-space:nowrap; max-width:60%;">æ ‡é¢˜</span>
            <button class="btn btn-icon" onclick="toggleSettings()">âš™ï¸</button>
        </div>
        
        <div class="reader-container">
            <div class="reader-text" id="readerContent" onclick="toggleSettings(false)"></div>
        </div>

        <div style="position:absolute; bottom:60px; width:100%; text-align:center;">
             <div class="chapter-info" id="chapterInfo">ç¬¬ 1 ç« </div>
        </div>

        <div class="reader-footer" id="readerFooter">
            <button class="page-btn secondary" onclick="toggleToc()">ğŸ“‚ ç›®å½•</button>
            <button class="page-btn" onclick="prevChapter()">ä¸Šä¸€ç« </button>
            <button class="page-btn" onclick="nextChapter()">ä¸‹ä¸€ç« </button>
        </div>
        
        <div class="touch-mask" id="touchMask" onclick="closeOverlays()"></div>

        <div class="toc-drawer" id="tocDrawer">
            <div class="toc-header">
                <span>ğŸ“– ç›®å½•</span>
                <span onclick="toggleToc()" style="font-size:20px; cursor:pointer;">Ã—</span>
            </div>
            <div class="toc-list" id="tocList"></div>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <div style="margin-bottom:15px; display:flex; gap:10px;">
                <span style="font-size:12px;">èƒŒæ™¯</span>
                <div onclick="setTheme('#fdf6e3','#333')" style="width:30px;height:30px;background:#fdf6e3;border:1px solid #ccc;border-radius:50%;"></div>
                <div onclick="setTheme('#fff','#000')" style="width:30px;height:30px;background:#fff;border:1px solid #ccc;border-radius:50%;"></div>
                <div onclick="setTheme('#1a1a1a','#999')" style="width:30px;height:30px;background:#1a1a1a;border-radius:50%;"></div>
                <div onclick="setTheme('#c8e6c9','#1b5e20')" style="width:30px;height:30px;background:#c8e6c9;border-radius:50%;"></div>
            </div>
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <span style="font-size:12px;">å­—å·</span>
                <input type="range" min="14" max="32" value="18" style="flex:1" oninput="setStyle('fontSize', this.value+'px')">
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:12px;">è¡Œè·</span>
                <input type="range" min="1.4" max="2.5" step="0.1" value="1.8" style="flex:1" oninput="setStyle('lineHeight', this.value)">
            </div>
        </div>
    </div>

    <div class="back-home" onclick="goBackMain()">ğŸ </div>

    <script>
        /* ================= IndexedDB æ•°æ®åº“ ================= */
        const DB_NAME = 'LiliNovelDB_V2'; // å‡çº§æ•°æ®åº“ç‰ˆæœ¬
        const DB_VERSION = 1;
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains('novels')) {
                        const store = db.createObjectStore('novels', { keyPath: 'id' });
                    }
                };
                request.onsuccess = (e) => {
                    db = e.target.result;
                    renderBooks(); 
                    resolve(db);
                };
                request.onerror = (e) => reject(e);
            });
        }

        function addBookToDB(book) {
            const tx = db.transaction(['novels'], 'readwrite');
            tx.objectStore('novels').add(book);
            return new Promise(resolve => tx.oncomplete = resolve);
        }

        function getAllBooks() {
            return new Promise((resolve) => {
                const tx = db.transaction(['novels'], 'readonly');
                const request = tx.objectStore('novels').getAll();
                request.onsuccess = () => resolve(request.result);
            });
        }

        function updateBookInDB(book) {
            const tx = db.transaction(['novels'], 'readwrite');
            tx.objectStore('novels').put(book);
            return new Promise(resolve => tx.oncomplete = resolve);
        }

        function deleteBookFromDB(id) {
            const tx = db.transaction(['novels'], 'readwrite');
            tx.objectStore('novels').delete(id);
            return new Promise(resolve => tx.oncomplete = resolve);
        }

        /* ================= æ ¸å¿ƒï¼šæ™ºèƒ½åˆ†ç« é€»è¾‘ ================= */
        
        function splitContentIntoChapters(fullText) {
            // 1. å®šä¹‰ç« èŠ‚æ­£åˆ™ï¼šåŒ¹é… "ç¬¬Xç« " æˆ– "ç¬¬XèŠ‚" å¼€å¤´çš„è¡Œ
            const chapterRegex = /(?:^|\n)\s*(ç¬¬[0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]+[ç« å›èŠ‚][^\n]*)/g;
            
            let chapters = [];
            let lastIndex = 0;
            let match;

            // 2. å¾ªç¯æŸ¥æ‰¾ç« èŠ‚å¤´
            while ((match = chapterRegex.exec(fullText)) !== null) {
                // ä¿å­˜ä¸Šä¸€ç« çš„å†…å®¹ (ä»ä¸Šä¸€ä¸ªåŒ¹é…ç‚¹åˆ°å½“å‰åŒ¹é…ç‚¹)
                if (match.index > lastIndex) {
                    let content = fullText.substring(lastIndex, match.index).trim();
                    if (content.length > 0) {
                        // å¦‚æœç¬¬ä¸€æ®µæ²¡æœ‰æ ‡é¢˜ï¼Œé€šå¸¸æ˜¯åºç« æˆ–ç®€ä»‹
                        let title = chapters.length === 0 ? "ğŸ“– åºç« /ç®€ä»‹" : "ï¼ˆæœªçŸ¥ç« èŠ‚ï¼‰";
                        // å¦‚æœ chapters å·²ç»æœ‰ä¸Šä¸€ç« äº†ï¼Œé‚£ä¸Šä¸€ç« çš„æ ‡é¢˜å·²ç»å­˜äº†ï¼Œè¿™é‡Œä¸ç”¨åŠ¨
                        // ä¿®æ­£é€»è¾‘ï¼šæˆ‘ä»¬ä¿å­˜çš„æ˜¯ [lastIndex ~ match.index] è¿™æ®µå†…å®¹ï¼Œå®ƒå±äº "ä¸Šä¸€ä¸ªæ ‡é¢˜"
                        // æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠå†…å®¹è¿½åŠ åˆ°ä¸Šä¸€ä¸ªç« èŠ‚é‡Œï¼Ÿ
                        // ä¸ï¼Œæ›´å¥½çš„é€»è¾‘æ˜¯ï¼šå‘ç°æ–°æ ‡é¢˜ -> ç»“æŸæ—§ç« èŠ‚ -> å¼€å§‹æ–°ç« èŠ‚
                    }
                }
                
                // 3. æå–æ ‡é¢˜å’Œå¼€å§‹ä½ç½®
                // match[0] æ˜¯åŒ…å«æ¢è¡Œç¬¦çš„å®Œæ•´åŒ¹é…ï¼Œmatch[1] æ˜¯çº¯æ ‡é¢˜
                // æˆ‘ä»¬éœ€è¦æ‰¾åˆ°è¿™ä¸€ç« å†…å®¹çš„ç»“æŸä½ç½®ï¼ˆå³ä¸‹ä¸€ä¸ª match çš„å¼€å§‹ä½ç½®ï¼‰
            }

            // --- é‡‡ç”¨æ›´ç¨³å¥çš„ Split æ–¹æ³• ---
            
            // è¿™ç§ Split æ–¹æ³•ä¼šä¿ç•™åˆ†å‰²ç¬¦(æ ‡é¢˜)
            // ç»“æœç±»ä¼¼: ["", "ç¬¬1ç«  xxx", "å†…å®¹...", "ç¬¬2ç«  xxx", "å†…å®¹..."]
            const parts = fullText.split(/(?:^|\n)\s*(ç¬¬[0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]+[ç« å›èŠ‚][^\n]*)(?:\n|$)/);
            
            if (parts.length < 3) {
                // âš ï¸ æ²¡è¯†åˆ«å‡ºç« èŠ‚ï¼å¯èƒ½æ˜¯çŸ­ç¯‡æˆ–æ ¼å¼ä¸å¯¹
                // å¯ç”¨ã€å¼ºåˆ¶åˆ‡åˆ†æ¨¡å¼ã€‘ï¼šæ¯ 5000 å­—ä¸€ç« 
                console.log("æœªè¯†åˆ«åˆ°ç« èŠ‚ï¼Œå¯ç”¨å¼ºåˆ¶åˆ‡åˆ†...");
                const chunkSize = 5000;
                for (let i = 0; i < fullText.length; i += chunkSize) {
                    chapters.push({
                        title: `ç¬¬ ${Math.floor(i/chunkSize)+1} éƒ¨åˆ†`,
                        content: fullText.substring(i, i + chunkSize)
                    });
                }
            } else {
                // æ­£å¸¸è¯†åˆ«
                // parts[0] æ˜¯ç¬¬ä¸€ç« ä¹‹å‰çš„å†…å®¹ï¼ˆåºç« ï¼‰
                if(parts[0].trim()) {
                    chapters.push({ title: "ğŸ“– åºç« /å‰è¨€", content: parts[0] });
                }
                
                // åé¢æˆå¯¹å‡ºç°: [Title, Content, Title, Content...]
                for (let i = 1; i < parts.length; i += 2) {
                    let title = parts[i].trim();
                    let content = parts[i+1] || ""; // é˜²æ­¢undefined
                    chapters.push({ title: title, content: content });
                }
            }

            return chapters;
        }

        /* ================= ä¸šåŠ¡é€»è¾‘ ================= */
        
        let currentBook = null;
        let currentChapterIndex = 0;
        
        // 1. å¯¼å…¥
        async function handleImport(input) {
            const files = Array.from(input.files);
            if (!files.length) return;
            let count = 0;
            
            for (const file of files) {
                const text = await readFile(file);
                // âš¡ï¸ æ ¸å¿ƒï¼šè§£æç« èŠ‚
                const chapters = splitContentIntoChapters(text);
                
                const book = {
                    id: Date.now() + Math.random().toString(),
                    title: file.name.replace('.txt', ''),
                    chapters: chapters, // å­˜æ•°ç»„
                    chapterIndex: 0,    // å½“å‰è¯»åˆ°ç¬¬å‡ ç« 
                    status: 'reading',
                    info: '',
                    addDate: new Date().toLocaleDateString()
                };
                await addBookToDB(book);
                count++;
            }
            alert(`âœ… æˆåŠŸå¯¼å…¥ ${count} æœ¬ä¹¦ï¼\nå·²è‡ªåŠ¨ä¸ºæ‚¨åˆ†å¥½ç« èŠ‚ï¼Œé˜…è¯»è¶…çº§æµç•…~`);
            input.value = '';
            renderBooks();
        }

        function readFile(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsText(file);
            });
        }

        // 2. æ¸²æŸ“ä¹¦æ¶
        async function renderBooks(filterText = '') {
            const grid = document.getElementById('bookGrid');
            grid.innerHTML = '';
            let books = await getAllBooks();
            books.reverse();

            if (filterText) {
                books = books.filter(b => b.title.includes(filterText));
            }

            books.forEach(book => {
                const el = document.createElement('div');
                el.className = 'book';
                
                // è¿›åº¦æ¡è®¡ç®—
                const total = book.chapters.length;
                const current = (book.chapterIndex || 0) + 1;
                const percent = Math.round((current / total) * 100);
                const dot = book.status === 'finished' ? 'dot-green' : 'dot-orange';

                el.innerHTML = `
                    <div class="cover">
                        ğŸ“–
                        <div class="status-dot ${dot}"></div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width:${percent}%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="book-title">${book.title}</div>
                        <div class="book-info">å…± ${total} ç«  Â· å·²è¯» ${percent}%</div>
                    </div>
                `;
                el.onclick = () => openDetail(book);
                grid.appendChild(el);
            });
        }

        // 3. è¯¦æƒ…é¡µ
        function openDetail(book) {
            currentBook = book;
            document.getElementById('detailTitle').innerText = book.title;
            document.getElementById('detailCount').innerText = `å…± ${book.chapters.length} ç« `;
            document.getElementById('detailStatus').value = book.status;
            document.getElementById('detailInfo').value = book.info || '';
            document.getElementById('detailModal').classList.add('active');
        }
        function closeDetail() {
            document.getElementById('detailModal').classList.remove('active');
        }
        async function saveAndCloseDetail() {
            if(!currentBook) return;
            currentBook.status = document.getElementById('detailStatus').value;
            currentBook.info = document.getElementById('detailInfo').value;
            await updateBookInDB(currentBook);
            closeDetail();
            renderBooks();
        }
        async function deleteCurrentBook() {
            if(confirm(`åˆ é™¤ã€Š${currentBook.title}ã€‹ï¼Ÿ`)) {
                await deleteBookFromDB(currentBook.id);
                closeDetail();
                renderBooks();
            }
        }

        // 4. é˜…è¯»å™¨ (æŒ‰ç« èŠ‚æ˜¾ç¤º)
        function startReading() {
            if(!currentBook) return;
            
            // è½½å…¥è¿›åº¦
            currentChapterIndex = currentBook.chapterIndex || 0;
            if (currentChapterIndex >= currentBook.chapters.length) currentChapterIndex = 0;

            document.getElementById('readerTitle').innerText = currentBook.title;
            renderChapter();
            
            document.getElementById('readerPage').classList.add('active');
            closeDetail();

            // æ¢å¤è®¾ç½®
            const pref = JSON.parse(localStorage.getItem('lili_reader_pref_v3') || '{}');
            if(pref.fontSize) setStyle('fontSize', pref.fontSize);
            if(pref.lineHeight) setStyle('lineHeight', pref.lineHeight);
            if(pref.bg) setTheme(pref.bg, pref.color);
        }

        function renderChapter() {
            const chapter = currentBook.chapters[currentChapterIndex];
            if (!chapter) return;

            // æ¸²æŸ“å†…å®¹
            const container = document.getElementById('readerContent');
            // åœ¨å¼€å¤´åŠ ç²—æ˜¾ç¤ºç« èŠ‚å
            container.innerHTML = `<div style="font-weight:bold; font-size:1.2em; margin-bottom:20px;">${chapter.title}</div>` + chapter.content;
            container.scrollTop = 0; // å›åˆ°é¡¶éƒ¨

            // æ›´æ–°åº•éƒ¨ä¿¡æ¯
            document.getElementById('chapterInfo').innerText = `${chapter.title} (${currentChapterIndex + 1}/${currentBook.chapters.length})`;

            // è‡ªåŠ¨ä¿å­˜è¿›åº¦
            currentBook.chapterIndex = currentChapterIndex;
            updateBookInDB(currentBook);
        }

        function prevChapter() {
            if (currentChapterIndex > 0) {
                currentChapterIndex--;
                renderChapter();
            } else {
                alert("å·²ç»æ˜¯ç¬¬ä¸€ç« å•¦ï¼");
            }
        }

        function nextChapter() {
            if (currentChapterIndex < currentBook.chapters.length - 1) {
                currentChapterIndex++;
                renderChapter();
            } else {
                alert("æ­å–œï¼å·²ç»è¯»å®Œå•¦ï¼ğŸ‰");
                currentBook.status = 'finished';
                updateBookInDB(currentBook);
            }
        }

        // 5. ç›®å½•åŠŸèƒ½
        function toggleToc() {
            const drawer = document.getElementById('tocDrawer');
            const mask = document.getElementById('touchMask');
            
            if (drawer.classList.contains('open')) {
                drawer.classList.remove('open');
                mask.classList.remove('active');
            } else {
                renderTocList();
                drawer.classList.add('open');
                mask.classList.add('active');
            }
        }

        function renderTocList() {
            const listEl = document.getElementById('tocList');
            listEl.innerHTML = '';
            currentBook.chapters.forEach((chap, idx) => {
                const item = document.createElement('div');
                item.className = 'toc-item';
                if (idx === currentChapterIndex) item.classList.add('active');
                item.innerText = chap.title;
                item.onclick = () => {
                    currentChapterIndex = idx;
                    renderChapter();
                    toggleToc(); // å…³é—­ç›®å½•
                };
                listEl.appendChild(item);
            });
            // è‡ªåŠ¨æ»šåŠ¨åˆ°å½“å‰ç« èŠ‚ä½ç½®
            setTimeout(() => {
                const active = listEl.querySelector('.active');
                if(active) active.scrollIntoView({block: "center"});
            }, 100);
        }

        function closeOverlays() {
            document.getElementById('tocDrawer').classList.remove('open');
            document.getElementById('settingsPanel').classList.remove('show');
            document.getElementById('touchMask').classList.remove('active');
        }

        function closeReader() {
            document.getElementById('readerPage').classList.remove('active');
            renderBooks();
        }

        // 6. å…¶ä»–è®¾ç½®
        function toggleSettings(force) {
            const p = document.getElementById('settingsPanel');
            const mask = document.getElementById('touchMask');
            if(force === false) {
                p.classList.remove('show');
                mask.classList.remove('active');
            } else {
                p.classList.add('show');
                mask.classList.add('active');
            }
        }

        function toggleTheme() {
            const root = document.documentElement;
            const current = root.style.getPropertyValue('--bg');
            if (current.includes('#ffe6eb')) {
                root.style.setProperty('--primary', '#66bb6a'); root.style.setProperty('--bg', '#e8f5e9'); root.style.setProperty('--accent', '#43a047');
            } else if (current.includes('#e8f5e9')) {
                 root.style.setProperty('--primary', '#42a5f5'); root.style.setProperty('--bg', '#e3f2fd'); root.style.setProperty('--accent', '#1e88e5');
            } else {
                root.style.setProperty('--primary', '#ffb7c5'); root.style.setProperty('--bg', '#ffe6eb'); root.style.setProperty('--accent', '#ff8fa3');
            }
        }

        function setStyle(prop, val) {
            document.getElementById('readerContent').style[prop] = val;
            savePref(prop, val);
        }

        function setTheme(bg, color) {
            const page = document.getElementById('readerPage');
            page.style.background = bg;
            page.style.color = color;
            const footer = document.getElementById('readerFooter');
            
            if(bg === '#1a1a1a') {
                document.querySelector('.reader-nav').style.background = 'rgba(0,0,0,0.9)';
                document.querySelector('.reader-nav').style.color = '#ccc';
                footer.style.background = 'rgba(0,0,0,0.9)';
                footer.style.color = '#ccc';
            } else {
                document.querySelector('.reader-nav').style.background = 'rgba(255,255,255,0.9)';
                document.querySelector('.reader-nav').style.color = '#333';
                footer.style.background = 'rgba(255,255,255,0.9)';
                footer.style.color = '#333';
            }
            savePref('bg', bg);
            savePref('color', color);
        }

        function savePref(k, v) {
            const p = JSON.parse(localStorage.getItem('lili_reader_pref_v3') || '{}');
            p[k] = v;
            localStorage.setItem('lili_reader_pref_v3', JSON.stringify(p));
        }

        function goBackMain() {
            if (document.referrer) history.back();
            else window.location.href = 'ä¸»ç³»ç»Ÿ.txt';
        }

        function handleSearch() {
            renderBooks(document.getElementById('searchInput').value);
        }

        initDB();

    </script>
</body>
</html>
