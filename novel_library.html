<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ğŸ€ æ¢¨æ¢¨è—ä¹¦é˜ (V24.1 ä¿®å¤ç‰ˆ)</title>
    <style>
        /* ================= ğŸŒ¸ æ ¸å¿ƒç¾å­¦å®šä¹‰ ğŸŒ¸ ================= */
        
        @font-face {
            font-family: 'LiliFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            /* ğŸ¨ ç”œå¿ƒè‰²æ¿ */
            --primary: #ffb7c5;       /* æ¨±èŠ±ç²‰ */
            --primary-light: #fff0f5; /* æµ…ç²‰èƒŒæ™¯ */
            --primary-dark: #ff8fa3;  /* å¼ºè°ƒè‰² */
            --text-main: #6d5c5c;     /* å·§å…‹åŠ›æ–‡å­— */
            --glass: rgba(255, 255, 255, 0.85); /* ç£¨ç ‚ç»ç’ƒ */
            --shadow-soft: 0 10px 30px rgba(255, 183, 197, 0.25);
            --radius-box: 24px;
            
            /* ğŸ“– é˜…è¯»å™¨å˜é‡ (é»˜è®¤æ ·å¼) */
            --reader-font: 'LiliFont', sans-serif;
            --reader-size: 19px;
            --reader-line-height: 1.9;       /* è¡Œè· */
            --reader-letter-spacing: 1.5px;  /* å­—è· */
            --reader-para-spacing: 20px;     /* æ®µè· */
            --reader-padding: 25px;          /* è¾¹è· */
            --reader-bg: #fffbf0;
            --reader-color: #5d4037;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: 'LiliFont', sans-serif;
            background: linear-gradient(180deg, #fff0f5 0%, #fff 100%);
            color: var(--text-main);
            margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* ---------------- ğŸ§¸ é¡¶éƒ¨å¯¼èˆª ---------------- */
        .header {
            margin: 10px 15px; 
            background: var(--glass);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            padding: 15px 20px;
            border-radius: var(--radius-box);
            box-shadow: var(--shadow-soft);
            display: flex; flex-direction: column; gap: 12px;
            z-index: 100; border: 1px solid rgba(255,255,255,0.6);
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .title { 
            font-size: 18px; font-weight: 900; color: var(--primary-dark); 
            display: flex; align-items: center; gap: 5px;
        }
        .title::before { content: 'ğŸ€'; font-size: 1.2em; }

        .btn {
            border: none; padding: 8px 16px; border-radius: 20px;
            font-size: 13px; cursor: pointer; transition: all 0.2s;
            font-family: inherit; font-weight: bold;
            display: inline-flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn:active { transform: scale(0.92); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 12px rgba(255, 143, 163, 0.4); }
        .btn-ghost { background: white; border: 1px solid var(--primary); color: var(--primary-dark); }

        .search-box {
            background: #fff; border-radius: 20px; padding: 10px 15px;
            display: flex; align-items: center; gap: 8px; border: 2px solid #fff5f7;
        }
        .search-input { border: none; background: transparent; width: 100%; font-size: 14px; color: var(--text-main); font-family: inherit; }

        .filter-bar { display:flex; gap:8px; overflow-x:auto; padding: 5px 0; scrollbar-width: none; }
        .filter-btn {
            padding: 6px 14px; border-radius:12px; background:rgba(255,255,255,0.5); 
            color:#999; font-size:12px; border: 1px solid transparent; transition: 0.3s;
        }
        .filter-btn.active {
            background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255, 183, 197, 0.4);
        }

        /* ---------------- ğŸ“š ä¹¦æ¶æ ¼å­ ---------------- */
        .grid {
            flex: 1; overflow-y: auto; padding: 15px 20px 100px 20px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 20px; align-content: start;
        }
        .book { display: flex; flex-direction: column; gap: 8px; cursor: pointer; position: relative; }
        .book:active { transform: scale(0.95); }
        .cover {
            aspect-ratio: 2/3; background: white; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 36px; box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            border: 3px solid white; position: relative; overflow: hidden;
            background-size: cover; background-position: center;
        }
        .cover.has-img { font-size: 0; border: none; }
        .book-title { font-size: 13px; font-weight: bold; text-align: center; color: #555; line-height: 1.4; height: 2.8em; overflow: hidden; }
        .mini-progress { position: absolute; bottom: 10px; left: 15%; width: 70%; height: 4px; background: rgba(0,0,0,0.05); border-radius: 4px; overflow: hidden; }
        .mini-fill { height: 100%; background: var(--primary-dark); width: 0%; border-radius: 4px; }

        /* ---------------- âœ¨ è¯¦æƒ…é¡µå¼¹çª— ---------------- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 240, 245, 0.6); z-index: 1000; backdrop-filter: blur(8px);
            display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        .detail-card {
            background: rgba(255,255,255,0.9); width: 85%; max-width: 360px; 
            border-radius: 30px; padding: 30px; box-shadow: 0 20px 60px rgba(255, 183, 197, 0.3);
            border: 2px solid #fff; transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.active .detail-card { transform: scale(1); }
        .form-input { background: #fff5f7; border: 1px solid transparent; padding: 12px; border-radius: 15px; font-size: 14px; width: 100%; font-family: inherit; color: #666; }

        /* ---------------- ğŸ“– ç”œå¿ƒé˜…è¯»å™¨ ---------------- */
        .reader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--reader-bg); color: var(--reader-color);
            z-index: 2000; display: none; flex-direction: column;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.03' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='1'/%3E%3Ccircle cx='13' cy='13' r='1'/%3E%3C/g%3E%3C/svg%3E");
        }
        .reader.active { display: flex; animation: slideUp 0.4s; }

        /* æ‚¬æµ®å¯¼èˆªæ  */
        .reader-nav {
            position: absolute; top: 15px; left: 15px; right: 15px;
            height: 55px; padding: 0 15px; background: rgba(255,255,255,0.9); 
            backdrop-filter: blur(10px); border-radius: 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); z-index: 2010; transition: transform 0.3s;
        }
        .reader-nav.hidden { transform: translateY(-200%); }

        /* æ‚¬æµ®åº•éƒ¨æ  */
        .reader-footer {
            position: absolute; bottom: 25px; left: 15px; right: 15px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            padding: 10px; border-radius: 25px;
            display: flex; justify-content: space-between; gap: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); z-index: 2010; transition: transform 0.3s;
        }
        .reader-footer.hidden { transform: translateY(200%); }
        
        .page-btn {
            flex: 1; background: var(--primary-light); color: var(--text-main); 
            border: none; padding: 12px; border-radius: 18px; font-weight: bold;
        }

        /* é˜…è¯»å®¹å™¨ */
        .reader-container { 
            flex: 1; width: 100%; height: 100%;
            /* é»˜è®¤æ»šåŠ¨æ¨¡å¼ */
            overflow-y: auto; overflow-x: hidden; scroll-behavior: smooth;
            padding-top: 80px; padding-bottom: 100px; /* é¿å¼€æ‚¬æµ®æ  */
        }

        /* ğŸŒŸ å·¦å³ç¿»é¡µæ¨¡å¼ ğŸŒŸ */
       /* --- âœ¨ ä¿®å¤ï¼šå·¦å³ç¿»é¡µæ ¸å¿ƒæ’ç‰ˆ (è§£å†³è·³ç« é—®é¢˜) âœ¨ --- */
.reader-container.paging-mode {
    display: block;
    width: 100vw;
    height: 100vh;
    overflow: hidden; /* éšè—æ»šåŠ¨æ¡ */
    padding: 0 !important;
    position: relative;
}

.reader-container.paging-mode .reader-content {
    /* å…³é”®ï¼šç»å¯¹å®šä½é”æ­»é«˜åº¦ï¼Œå¼ºåˆ¶ç”Ÿæˆæ¨ªå‘åˆ— */
    position: absolute;
    top: 0; left: 0; bottom: 0;
    width: auto; /* è®©å®½åº¦è‡ªåŠ¨å»¶ä¼¸ */
    height: 100vh; 
    
    /* ä¸Šä¸‹ç•™ç™½ï¼Œå·¦å³ç•™ç™½ */
    padding: 60px var(--reader-padding) 80px var(--reader-padding); 
    box-sizing: border-box;
    
    /* CSSå¤šåˆ—å¸ƒå±€ */
    column-width: calc(100vw - (var(--reader-padding) * 2));
    column-gap: calc(var(--reader-padding) * 2); /* é¡µç¼ç­‰äºè¾¹è· */
    column-fill: auto;
}



        /* å†…å®¹æ’ç‰ˆ */
        .reader-content { margin: 0 auto; max-width: 800px; padding: 0 var(--reader-padding); }
        .reader-content p {
            font-family: var(--reader-font);
            font-size: var(--reader-size);
            line-height: var(--reader-line-height);       /* è¡Œè·åº”ç”¨ */
            letter-spacing: var(--reader-letter-spacing); /* å­—è·åº”ç”¨ */
            margin-bottom: var(--reader-para-spacing);    /* æ®µè·åº”ç”¨ */
            text-align: justify; text-indent: 2em; margin-top: 0;
            break-inside: avoid;
        }
        .chapter-title {
            text-align: center; margin: 40px 0; font-size: 1.4em; color: var(--primary-dark);
            position: relative; display: inline-block; width: 100%; break-inside: avoid;
        }

        /* ğŸŒŸ å…¨å±ç‚¹å‡»çƒ­åŒº (æ‡’äººæ¨¡å¼) ğŸŒŸ */
        .tap-zone { position: fixed; z-index: 1900; }
        /* é¡¶éƒ¨ä¿ç•™10%ç»™â€œä¸Šä¸€é¡µâ€(é˜²è¯¯è§¦)ï¼Œä¸­é—´20%ç»™èœå•ï¼Œå…¶ä½™å…¨éƒ¨æ˜¯ä¸‹ä¸€é¡µ */
        .tap-prev { top: 0; left: 0; width: 100%; height: 10%; } 
        .tap-menu { top: 35%; left: 30%; width: 40%; height: 30%; z-index: 1900; } 
        /* å…¶ä½™åŒºåŸŸå…¨è¦†ç›–ç”¨äºä¸‹ä¸€é¡µï¼Œä½†åœ¨HTMLç»“æ„ä¸­æ”¾åˆ°åº•å±‚ï¼Œä¸æŒ¡ä½ä¸Šé¢ä¸¤ä¸ª */
        .tap-next-layer { top: 0; left: 0; width: 100%; height: 100%; z-index: 1800; } 

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; border-radius: 35px 35px 0 0;
            padding: 30px; padding-bottom: 50px;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.1); z-index: 2100;
            transform: translateY(110%); transition: transform 0.4s;
        }
        .settings-panel.show { transform: translateY(0); }
        .setting-row { display: flex; align-items: center; margin-bottom: 25px; gap: 15px; font-size: 14px; font-weight: bold; color: #888; }
        
        input[type=range] { flex: 1; height: 8px; border-radius: 10px; background: #f0f0f0; appearance: none; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: white; border: 3px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .toc-drawer {
            position: fixed; top: 0; left: 0; width: 85%; height: 100%; background: #fff;
            transform: translateX(-100%); transition: 0.4s; z-index: 2200; display:flex; flex-direction:column;
            border-radius: 0 30px 30px 0; box-shadow: 10px 0 40px rgba(0,0,0,0.1);
        }
        .toc-drawer.open { transform: translateX(0); }
        .toc-list { padding: 15px; overflow-y: auto; }
        .toc-item { padding: 16px; border-bottom: 1px dashed #f0f0f0; font-size: 15px; color: #666; border-radius: 12px; margin-bottom: 5px; }
        .toc-item.active { background: var(--primary-light); color: var(--primary-dark); font-weight: bold; }

        .mask { position: fixed; inset:0; background:rgba(0,0,0,0.1); backdrop-filter:blur(2px); z-index:2050; display:none; }
        .mask.active { display:block; }
        .back-home { position: fixed; bottom: 30px; right: 20px; width: 55px; height: 55px; background: white; border-radius: 50%; box-shadow: 0 8px 20px rgba(255, 183, 197, 0.4); display: flex; justify-content: center; align-items: center; font-size: 26px; z-index: 90; border: 3px solid var(--primary); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* --- ğŸ› ï¸ ä¿®å¤ï¼šèœå•å±‚çº§ä¿®æ­£ --- */

/* 1. è®©é¡¶éƒ¨å’Œåº•éƒ¨æ æµ®åœ¨é®ç½©å±‚ä¸Šé¢ï¼Œè¿™æ ·å°±ä¸ä¼šæœ¦èƒ§ï¼Œä¹Ÿèƒ½ç‚¹å‡»äº† */
.reader-nav, .reader-footer {
    z-index: 2060 !important; /* åŸæ¥æ˜¯2010ï¼Œè¢«é®ç½©æŒ¡ä½äº† */
}

/* 2. é®ç½©å±‚ä¿æŒåœ¨ä¸­é—´ */
.mask {
    z-index: 2050 !important;
    background: rgba(0,0,0,0.3); /*ç¨å¾®æ·±ä¸€ç‚¹ï¼Œè®©èœå•æ›´æ¸…æ¥š*/
}

/* 3. ç¡®ä¿ç›®å½•å’Œè®¾ç½®é¢æ¿æœ€é«˜ */
.settings-panel { z-index: 2100 !important; }
.toc-drawer { z-index: 2200 !important; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="title">ğŸŒ¸ æ¢¨æ¢¨è—ä¹¦é˜</div>
            <div class="import-controls" style="display:flex; gap:8px;">
                <select id="encodingSelect" class="form-input" style="width:auto; padding:5px 10px; font-size:12px; border:1px solid #eee;">
                    <option value="utf-8">UTF-8</option>
                    <option value="gbk">GBK (è€ä¹¦)</option>
                </select>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥</button>
                <button class="btn btn-ghost" onclick="exportData()">ğŸ“¤ å¤‡ä»½</button>
                <input type="file" id="fileInput" accept=".txt" multiple style="display:none" onchange="handleImport(this)">
            </div>
        </div>
        <div class="search-box">
            <span style="font-size:16px;">ğŸ”</span>
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ä¹¦å..." onkeyup="renderBooks(this.value)">
        </div>
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterBooks('all', this)">å…¨éƒ¨</button>
            <button class="filter-btn" onclick="filterBooks('reading', this)">â³ è¿è½½ä¸­</button>
            <button class="filter-btn" onclick="filterBooks('finished', this)">âœ… å·²å®Œç»“</button>
            <button class="filter-btn" onclick="filterBooks('unread', this)">ğŸ”´ æœªè¯»å®Œ</button>
            <button class="filter-btn" onclick="filterBooks('read', this)">ğŸŸ¢ å·²è¯»å®Œ</button>
        </div>
    </div>

    <div class="grid" id="bookGrid"></div>

    <div class="modal-overlay" id="detailModal">
        <div class="detail-card">
            <div style="text-align:center; font-weight:bold; color:var(--primary-dark); font-size:18px; margin-bottom:5px;">âœ¨ ä¹¦ç±ä¿¡æ¯ âœ¨</div>
            <div style="display:flex; gap:15px; align-items:center;">
                <div id="previewCover" class="cover" style="width:80px; height:120px; font-size:30px; box-shadow:none; border:2px dashed #ffb7c5;">ğŸ“–</div>
                <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                    <button class="btn btn-ghost" onclick="document.getElementById('coverInput').click()">ğŸ“· æ¢å°é¢</button>
                    <button class="btn btn-ghost" style="border-color:#eee; color:#aaa;" onclick="removeCover()">ğŸ”„ è¿˜åŸ</button>
                    <input type="file" id="coverInput" accept="image/*" style="display:none" onchange="handleCoverChange(this)">
                </div>
            </div>
            <input type="text" id="editTitle" class="form-input" placeholder="ä¹¦å">
            <input type="text" id="editAuthor" class="form-input" placeholder="ä½œè€…">
            <div style="display:flex; gap:10px;">
                <select id="editStatus" class="form-input">
                    <option value="reading">â³ è¿è½½ä¸­</option>
                    <option value="finished">âœ… å·²å®Œç»“</option>
                </select>
                <input type="text" id="editTags" class="form-input" placeholder="æ ‡ç­¾">
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-primary" style="flex:1; padding:12px; font-size:16px;" onclick="saveDetailAndRead()">ğŸ’– å¼€å§‹é˜…è¯»</button>
                <button class="btn btn-ghost" onclick="saveDetailOnly()">ğŸ’¾ ä¿å­˜</button>
            </div>
            <button class="btn" style="color:#ff8fa3; background:none; margin-top:5px; font-size:12px;" onclick="deleteCurrentBook()">ğŸ—‘ï¸ åˆ é™¤æœ¬ä¹¦</button>
            <div style="position:absolute; top:15px; right:15px; font-size:24px; color:#ccc; cursor:pointer;" onclick="document.getElementById('detailModal').classList.remove('active')">Ã—</div>
        </div>
    </div>

    <div class="reader" id="readerPage">
        <div class="reader-nav" id="readerNav">
            <button class="btn btn-icon" onclick="closeReader()" style="font-size:18px;">â¬…ï¸</button>
            <span id="readerTitle" style="font-weight:bold; max-width:50%; overflow:hidden; white-space:nowrap; color:#555;">æ ‡é¢˜</span>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-icon" onclick="addBookmark()" style="font-size:18px;">ğŸ”–</button>
                <button class="btn btn-icon" onclick="toggleSettings()" style="font-size:18px;">âš™ï¸</button>
            </div>
        </div>
        
        <div class="reader-container" id="readerContainer">
            <div class="reader-content" id="readerContent"></div>
        </div>

        <div id="tapNextLayer" class="tap-zone tap-next-layer" 
     style="top:0; left:0; width:100%; height:100%; z-index:1800;" 
     ontouchstart="recordTouchStart(event)" 
     ontouchend="handleTouchEnd(event)"
     onclick="handleReaderTap('next')"> </div>


        <div class="tap-zone tap-prev" style="top:0; left:0; width:100%; height:10%; z-index:1900;" onclick="handleReaderTap('prev')"></div>
        <div class="tap-zone tap-menu" style="top:35%; left:30%; width:40%; height:30%; z-index:1900;" onclick="handleReaderTap('menu')"></div>

        <div class="reader-footer" id="readerFooter">
            <button class="page-btn" onclick="toggleToc()">ğŸ“‚ ç›®å½•/ä¹¦ç­¾</button>
            <button class="page-btn" onclick="prevChapter()">ä¸Šä¸€ç« </button>
            <button class="page-btn" onclick="nextChapter()">ä¸‹ä¸€ç« </button>
        </div>

        <div class="mask" id="touchMask" onclick="closeOverlays()"></div>

        <div class="toc-drawer" id="tocDrawer">
            <div style="padding:20px; border-bottom:1px solid #f5f5f5; display:flex; gap:10px;">
                <button class="btn btn-primary" style="flex:1; font-size:12px;" onclick="renderTocList('chapters')">ğŸ“‘ ç« èŠ‚</button>
                <button class="btn btn-ghost" style="flex:1; font-size:12px;" onclick="renderTocList('bookmarks')">ğŸ”– ä¹¦ç­¾</button>
            </div>
            <div class="toc-list" id="tocList"></div>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <div style="text-align:center; margin-bottom:20px; color:#aaa; font-size:12px;">â€”â€” é˜…è¯»è®¾ç½® â€”â€”</div>
            
            <div class="setting-row" style="background:#f9f9f9; padding:10px; border-radius:15px; justify-content:space-around;">
                <button class="btn" id="modeScrollBtn" onclick="changeReaderMode('scroll')" style="flex:1;">â†•ï¸ ä¸Šä¸‹æ»šåŠ¨</button>
                <button class="btn" id="modePageBtn" onclick="changeReaderMode('page')" style="flex:1;">â†”ï¸ å·¦å³ç¿»é¡µ</button>
            </div>

            <div class="setting-row">
                <span class="setting-label">åŠŸèƒ½</span>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-ghost" onclick="toggleFullScreen()">ğŸ“º å…¨å±</button>
                    <button class="btn btn-ghost" onclick="document.getElementById('fontInput').click()">ğŸ”¤ å¯¼å…¥å­—ä½“</button>
                </div>
                <input type="file" id="fontInput" accept=".ttf,.woff,.woff2" style="display:none" onchange="handleFontImport(this)">
            </div>

            <div class="setting-row">
                <span class="setting-label">ä¿¡çº¸</span>
                <div style="display:flex; gap:12px; overflow-x:auto; padding-bottom:5px;">
                    <div onclick="setTheme('#fffbf0','#4a3b32')" style="min-width:40px;height:40px;background:#fffbf0;border-radius:50%;border:2px solid #e0d0b0;"></div>
                    <div onclick="setTheme('#ffffff','#000')" style="min-width:40px;height:40px;background:#fff;border-radius:50%;border:2px solid #eee;"></div>
                    <div onclick="setTheme('#222','#ccc')" style="min-width:40px;height:40px;background:#222;border-radius:50%;border:2px solid #444;"></div>
                    <div onclick="setTheme('#e8f5e9','#1b5e20')" style="min-width:40px;height:40px;background:#e8f5e9;border-radius:50%;border:2px solid #c8e6c9;"></div>
                    <input type="color" id="customBgColor" onchange="setCustomColor(this.value)" style="min-width:35px; height:35px; padding:0; border:none; background:none;">
                    <button class="btn btn-ghost" style="padding:5px 10px; font-size:10px;" onclick="document.getElementById('bgImgInput').click()">ğŸ–¼ï¸</button>
                    <input type="file" id="bgImgInput" accept="image/*" style="display:none" onchange="setCustomBgImage(this)">
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">å­—å·</span>
                <input type="range" min="14" max="32" value="19" oninput="updateStyle('--reader-size', this.value + 'px')">
            </div>
            <div class="setting-row">
                <span class="setting-label">è¡Œè·</span>
                <input type="range" min="1.4" max="3.0" step="0.1" value="1.9" oninput="updateStyle('--reader-line-height', this.value)">
            </div>
            <div class="setting-row">
                <span class="setting-label">å­—è·</span>
                <input type="range" min="0" max="5" step="0.5" value="1.5" oninput="updateStyle('--reader-letter-spacing', this.value + 'px')">
            </div>
            <div class="setting-row">
                <span class="setting-label">æ®µè·</span>
                <input type="range" min="0" max="50" value="20" oninput="updateStyle('--reader-para-spacing', this.value + 'px')">
            </div>
            <div class="setting-row">
                <span class="setting-label">è¾¹è·</span>
                <input type="range" min="10" max="50" value="25" oninput="updateStyle('--reader-padding', this.value + 'px')">
            </div>
        </div>
    </div>

    <div class="back-home" onclick="if(document.referrer){history.back()}else{window.location.href='ä¸»ç³»ç»Ÿ.txt'}">ğŸ </div>

    <script>
        /* ================= 1. æ•°æ®åº“é…ç½® ================= */
        const DB_NAME = 'LiliNovelDB_V24_FIX'; 
        let db;

        function initDB() {
            return new Promise((resolve) => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if(!db.objectStoreNames.contains('novels')) db.createObjectStore('novels', { keyPath: 'id' });
                    if(!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
                };
                req.onsuccess = (e) => {
                    db = e.target.result;
                    loadGlobalSettings();
                    renderBooks();
                    resolve(db);
                };
            });
        }

        /* ================= 2. å¯¼å…¥ä¸å¯¼å‡º ================= */
        async function handleImport(input) {
            const files = Array.from(input.files);
            if (!files.length) return;
            const encoding = document.getElementById('encodingSelect').value;
            let count = 0;
            
            for (const file of files) {
                try {
                    const text = await readFile(file, encoding);
                    const chapters = splitChapters(text);
                    const book = {
                        id: Date.now() + Math.random().toString(),
                        title: file.name.replace('.txt', ''),
                        author: 'æœªçŸ¥',
                        chapters: chapters,
                        chapterIndex: 0,
                        status: 'reading',
                        cover: null,
                        tags: '',
                        addedAt: new Date().toLocaleDateString()
                    };
                    const tx = db.transaction('novels', 'readwrite');
                    tx.objectStore('novels').add(book);
                    await new Promise(r => tx.oncomplete = r);
                    count++;
                } catch (e) { alert(`âŒ å¯¼å…¥å¤±è´¥: ${file.name}`); }
            }
            alert(`ğŸ‰ æˆåŠŸå¯¼å…¥ ${count} æœ¬ä¹¦ï¼`);
            input.value = '';
            renderBooks();
        }

        function readFile(file, encoding) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, encoding);
            });
        }

        function splitChapters(text) {
            const regex = /(?:^|\n)\s*(ç¬¬[0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]+[ç« å›èŠ‚][^\n]*)/g;
            const parts = text.split(regex);
            if (parts.length < 3) {
                const chunks = []; const size = 3000;
                for(let i=0; i<text.length; i+=size) chunks.push({ title: `ç¬¬ ${Math.floor(i/size)+1} éƒ¨åˆ†`, content: text.substring(i, i+size) });
                return chunks;
            } else {
                const chapters = [];
                if(parts[0].trim()) chapters.push({title:"åºç« ", content:parts[0]});
                for(let i=1; i<parts.length; i+=2) chapters.push({ title: parts[i].trim(), content: parts[i+1] });
                return chapters;
            }
        }

        function exportData() {
            const tx = db.transaction('novels', 'readonly');
            tx.objectStore('novels').getAll().onsuccess = (e) => {
                const data = JSON.stringify(e.target.result);
                const blob = new Blob([data], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `æ¢¨æ¢¨è—ä¹¦é˜å¤‡ä»½_${new Date().toLocaleDateString()}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };
        }

        /* ================= 3. ä¹¦æ¶ä¸ç­›é€‰ ================= */
        let currentFilter = 'all';

        function filterBooks(type, btn) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderBooks();
        }

        function renderBooks(searchQuery = '') {
            const grid = document.getElementById('bookGrid');
            grid.innerHTML = '';
            
            db.transaction('novels', 'readonly').objectStore('novels').getAll().onsuccess = (e) => {
                let list = e.target.result.reverse();
                if(searchQuery) {
                    const q = searchQuery.toLowerCase();
                    list = list.filter(b => b.title.toLowerCase().includes(q) || (b.author && b.author.includes(q)));
                }
                if (currentFilter === 'reading') list = list.filter(b => b.status !== 'finished');
                if (currentFilter === 'finished') list = list.filter(b => b.status === 'finished');
                if (currentFilter === 'unread') list = list.filter(b => (b.chapterIndex || 0) < b.chapters.length - 1);
                if (currentFilter === 'read') list = list.filter(b => (b.chapterIndex || 0) >= b.chapters.length - 1);

                if(list.length === 0) {
                    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#ccc; margin-top:50px;">ç©ºç©ºå¦‚ä¹Ÿ...</div>';
                    return;
                }

                list.forEach(book => {
                    const progress = Math.round(((book.chapterIndex||0) / book.chapters.length)*100);
                    let coverHtml = book.cover ? 
                        `<div class="cover has-img" style="background-image:url(${book.cover})"></div>` : 
                        `<div class="cover">ğŸ“–
                             <div class="mini-progress"><div class="mini-fill" style="width:${progress}%"></div></div>
                         </div>`;
                    const el = document.createElement('div');
                    el.className = 'book';
                    el.innerHTML = `${coverHtml}<div class="book-title">${book.title}</div>`;
                    el.onclick = () => openDetail(book);
                    grid.appendChild(el);
                });
            };
        }

        /* ================= 4. è¯¦æƒ…é¡µ ================= */
        let currentBook = null;
        let tempCover = null;

        function openDetail(book) {
            currentBook = book;
            tempCover = book.cover;
            document.getElementById('editTitle').value = book.title;
            document.getElementById('editAuthor').value = book.author || '';
            document.getElementById('editStatus').value = book.status || 'reading';
            document.getElementById('editTags').value = book.tags || '';
            updateCoverPreview(book.cover);
            document.getElementById('detailModal').classList.add('active');
        }

        function updateCoverPreview(base64) {
            const div = document.getElementById('previewCover');
            if(base64) {
                div.innerText = ''; div.style.backgroundImage = `url(${base64})`; div.classList.add('has-img'); div.style.border='none';
            } else {
                div.innerText = 'ğŸ“–'; div.style.backgroundImage = 'none'; div.classList.remove('has-img'); div.style.border='1px dashed #ccc';
            }
        }

        function handleCoverChange(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { tempCover = e.target.result; updateCoverPreview(tempCover); };
            reader.readAsDataURL(file);
        }

        function removeCover() { tempCover = null; updateCoverPreview(null); }
        function saveDetailOnly() { updateBookInfo(); alert('å·²ä¿å­˜'); }
        function saveDetailAndRead() { updateBookInfo(); startReading(); }

        function updateBookInfo() {
            if(!currentBook) return;
            currentBook.title = document.getElementById('editTitle').value;
            currentBook.author = document.getElementById('editAuthor').value;
            currentBook.status = document.getElementById('editStatus').value;
            currentBook.tags = document.getElementById('editTags').value;
            currentBook.cover = tempCover;
            const tx = db.transaction('novels', 'readwrite');
            tx.objectStore('novels').put(currentBook);
            tx.oncomplete = () => renderBooks();
        }

        function deleteCurrentBook() {
            if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿ(ä¸å¯æ¢å¤)')) {
                const tx = db.transaction('novels', 'readwrite');
                tx.objectStore('novels').delete(currentBook.id);
                tx.oncomplete = () => { document.getElementById('detailModal').classList.remove('active'); renderBooks(); };
            }
        }

        /* ================= 5. é˜…è¯»å™¨æ ¸å¿ƒé€»è¾‘ ================= */
        let currentChapterIdx = 0;
        let readerMode = 'scroll'; // 'scroll' | 'page'

        function startReading() {
    if(!currentBook) return;
    document.getElementById('detailModal').classList.remove('active');
    document.getElementById('readerPage').classList.add('active');
    currentChapterIdx = currentBook.chapterIndex || 0;
    if(currentChapterIdx >= currentBook.chapters.length) currentChapterIdx = 0;
    document.getElementById('readerTitle').innerText = currentBook.title;
    
    renderChapter();

    // âœ¨ æ–°å¢ï¼šç›‘å¬æ»šåŠ¨ï¼Œå®ç°ä¸Šä¸‹æ¨¡å¼â€œè‡ªåŠ¨ç»­ç« â€
    const container = document.getElementById('readerContainer');
    container.onscroll = function() {
        if (readerMode === 'scroll') {
            // å¦‚æœæ»‘åˆ°äº†æœ€åº•éƒ¨ (è¯¯å·® 5px)
            if (container.scrollTop + container.clientHeight >= container.scrollHeight - 5) {
                // è¿™é‡ŒåŠ ä¸ªé˜²æŠ–ï¼Œé˜²æ­¢ç¬é—´è·³å¥½å‡ ç« ï¼Œå®é™…ä½“éªŒä¸­é€šå¸¸ç‚¹å‡»è§¦å‘æ›´ç¨³ï¼Œ
                // ä½†å¦‚æœä½ æƒ³è¦çº¯æ»‘åŠ¨è§¦å‘ï¼Œå¯ä»¥è§£å¼€ä¸‹é¢è¿™è¡Œçš„æ³¨é‡Šï¼š
                // nextChapter(); 
                
                // å»ºè®®ï¼šæ‡’äººæ¨¡å¼ä¸‹ï¼Œæ¨èè¿˜æ˜¯ä¿ç•™â€œæ»‘ä¸åŠ¨äº†å†ç‚¹ä¸€ä¸‹å±å¹•â€è¿›ä¸‹ä¸€ç« ï¼ˆå³ goNext çš„é€»è¾‘ï¼‰ï¼Œ
                // å¦åˆ™çœ‹æœ€åä¸€è¡Œå­—çš„æ—¶å€™å®¹æ˜“è¯¯è§¦ç›´æ¥è·³èµ°äº†ã€‚
                // ä¸Šé¢çš„ goNext() å·²ç»å®ç°äº†ï¼šæ»‘åˆ°åº• -> å†ç‚¹ä¸€ä¸‹ -> ä¸‹ä¸€ç« ã€‚
            }
        }
    };
}


        function renderChapter(jumpToEnd = false) {
    const chap = currentBook.chapters[currentChapterIdx];
    const contentDiv = document.getElementById('readerContent');
    // æ ‡é¢˜ç¾åŒ–
    let html = `<div class="chapter-title" style="margin-bottom:50px;">${chap.title}</div>`;
    const paragraphs = chap.content.split('\n');
    paragraphs.forEach(p => { if(p.trim()) html += `<p>${p.trim()}</p>`; });
    // åº•éƒ¨åŠ ä¸ªæç¤ºï¼Œé˜²æ­¢è§†è§‰çªç„¶æ–­æ‰
    html += `<div style="text-align:center; color:#ccc; margin-top:50px; font-size:12px;">- æœ¬ç« å®Œ -</div>`;
    contentDiv.innerHTML = html;
    
    const container = document.getElementById('readerContainer');
    if (readerMode === 'scroll') {
        container.classList.remove('paging-mode');
        container.scrollTop = 0;
    } else {
        container.classList.add('paging-mode');
        // å¼ºåˆ¶é‡ç»˜ï¼Œç¡®ä¿ scrollWidth è®¡ç®—æ­£ç¡®
        setTimeout(() => {
            if (jumpToEnd) {
                container.scrollLeft = container.scrollWidth;
            } else {
                container.scrollLeft = 0;
            }
        }, 50); // ç»™ä¸€ç‚¹ç‚¹å»¶è¿Ÿç­‰å¾…æ¸²æŸ“
    }
    
    // è‡ªåŠ¨ä¿å­˜è¿›åº¦
    currentBook.chapterIndex = currentChapterIdx;
    db.transaction('novels', 'readwrite').objectStore('novels').put(currentBook);
}


        /* --- æ™ºèƒ½ç‚¹å‡»å¤„ç† (æ‡’äººæ ¸å¿ƒ) --- */
        function handleReaderTap(zone) {
            if (zone === 'menu') {
                toggleMenu(); // ç‚¹å‡»ä¸­é—´ï¼šèœå•å¼€å…³
            } else if (zone === 'next') {
                // ç‚¹å‡»å…¶ä»–ï¼šä¸‹ä¸€é¡µ (å¦‚æœèœå•å¼€ç€ï¼Œå…ˆå…³èœå•)
                const nav = document.getElementById('readerNav');
                if (!nav.classList.contains('hidden')) toggleMenu();
                else goNext();
            } else if (zone === 'prev') {
                // é¡¶éƒ¨å°æ¡ï¼šä¸Šä¸€é¡µ
                goPrev();
            }
        }

     function goNext() {
    const container = document.getElementById('readerContainer');
    
    if (readerMode === 'scroll') {
        // ä¸Šä¸‹æ»šåŠ¨æ¨¡å¼
        // å¦‚æœå·²ç»åˆ°åº•äº† (å…è®¸ 10px è¯¯å·®)
        if (container.scrollTop + container.clientHeight >= container.scrollHeight - 10) {
            nextChapter(); // è‡ªåŠ¨ä¸‹ä¸€ç« 
        } else {
            // è¿˜æ²¡åˆ°åº•ï¼Œå‘ä¸‹æ»šå±
            container.scrollBy({ top: window.innerHeight * 0.8, behavior: 'smooth' });
        }
    } else {
        // âœ¨ å·¦å³ç¿»é¡µæ¨¡å¼ (ä¿®å¤ç‰ˆ)
        // åªæœ‰å½“ (å½“å‰ä½ç½® + å±å¹•å®½åº¦) >= æ€»å®½åº¦ æ—¶ï¼Œæ‰ç®—åˆ°åº•
        const pageWidth = container.clientWidth;
        const maxScroll = container.scrollWidth - pageWidth; // æœ€å¤§å¯æ»šè·ç¦»
        
        // è¿™é‡Œçš„ 2 æ˜¯å®¹é”™å€¼ï¼Œé˜²æ­¢æµè§ˆå™¨è®¡ç®—å°æ•°è¯¯å·®
        if (container.scrollLeft < maxScroll - 2) {
            container.scrollBy({ left: pageWidth, behavior: 'smooth' });
        } else {
            nextChapter(); // çœŸçš„ç¿»å®Œäº†ï¼Œè·³ä¸‹ä¸€ç« 
        }
    }
}



        function goPrev() {
            const container = document.getElementById('readerContainer');
            if (readerMode === 'scroll') {
                container.scrollBy({ top: -window.innerHeight * 0.8, behavior: 'smooth' });
            } else {
                const pageWidth = container.clientWidth;
                if (container.scrollLeft <= 0) {
                    prevChapter(); // åˆ°å¤´äº†ï¼Œä¸Šä¸€ç« 
                } else {
                    container.scrollBy({ left: -pageWidth, behavior: 'smooth' });
                }
            }
        }

        /* æ¨¡å¼åˆ‡æ¢ */
        // --- ğŸ”„ æ ¸å¿ƒä¿®å¤ï¼šåˆ‡æ¢æ¨¡å¼é€»è¾‘ ---
function changeReaderMode(mode) {
    readerMode = mode;
    saveSetting('readerMode', mode);
    
    // 1. æŒ‰é’®æ ·å¼åˆ‡æ¢
    document.getElementById('modeScrollBtn').className = mode === 'scroll' ? 'btn btn-primary' : 'btn btn-ghost';
    document.getElementById('modePageBtn').className = mode === 'page' ? 'btn btn-primary' : 'btn btn-ghost';
    
    // 2. æ ¸å¿ƒä¿®å¤ï¼šä¸Šä¸‹æ»šåŠ¨æ¨¡å¼æ—¶ï¼Œéšè—â€œå…¨å±ä¸‹ä¸€é¡µâ€çƒ­åŒº
    // è¿™æ ·ä½ å°±å¯ä»¥è‡ªç”±æ»‘åŠ¨ï¼Œä¸ä¼šè¯¯è§¦ç‚¹å‡»äº†
    const nextLayer = document.getElementById('tapNextLayer');
    if (mode === 'scroll') {
        nextLayer.style.display = 'none'; 
    } else {
        nextLayer.style.display = 'block'; // å·¦å³ç¿»é¡µæ¨¡å¼æ‰éœ€è¦å…¨å±ç‚¹å‡»
    }

    renderChapter();
    
    if(mode === 'page') alert('âœ¨ å·²åˆ‡æ¢ã€å·¦å³ç¿»é¡µã€‘\nç‚¹å±å¹•ä»»ä½•åœ°æ–¹éƒ½æ˜¯ä¸‹ä¸€é¡µï¼');
    if(mode === 'scroll') alert('âœ¨ å·²åˆ‡æ¢ã€ä¸Šä¸‹æ»šåŠ¨ã€‘\nç°åœ¨å¯ä»¥è‡ªç”±æ»‘åŠ¨å±å¹•äº†ï¼');
}


        /* èœå•å¼€å…³ */
        function toggleMenu() {
            const nav = document.getElementById('readerNav');
            const footer = document.getElementById('readerFooter');
            const mask = document.getElementById('touchMask');
            if (nav.classList.contains('hidden')) {
                nav.classList.remove('hidden'); footer.classList.remove('hidden'); mask.classList.add('active');
            } else {
                nav.classList.add('hidden'); footer.classList.add('hidden'); mask.classList.remove('active');
            }
        }

        /* é€šç”¨è·³è½¬ */
        function prevChapter() { 
            if(currentChapterIdx > 0) { 
                currentChapterIdx--; 
                // å¦‚æœæ˜¯ç¿»é¡µæ¨¡å¼ï¼Œç¿»å›ä¸Šä¸€ç« æ—¶ï¼Œä¼ å…¥ trueï¼Œè·³åˆ°ç« èŠ‚æœ«å°¾
                renderChapter(readerMode === 'page'); 
            } else { alert('å·²ç»æ˜¯ç¬¬ä¸€ç« å•¦'); } 
        }
        function nextChapter() { 
            if(currentChapterIdx < currentBook.chapters.length-1) { 
                currentChapterIdx++; 
                renderChapter(); 
            } else { 
                alert('æ­å–œçœ‹å®Œå•¦ï¼'); currentBook.status='finished'; updateBookInfo(); 
            } 
        }

        function closeReader() { document.getElementById('readerPage').classList.remove('active'); renderBooks(); }

        /* ================= 6. ä¹¦ç­¾ä¸ç›®å½• ================= */
        function addBookmark() {
            if (!currentBook) return;
            if (!currentBook.bookmarks) currentBook.bookmarks = [];
            const chap = currentBook.chapters[currentChapterIdx];
            currentBook.bookmarks.push({
                id: Date.now(), title: chap.title, chapterIdx: currentChapterIdx, time: new Date().toLocaleString()
            });
            db.transaction('novels', 'readwrite').objectStore('novels').put(currentBook);
            alert('ğŸ”– ä¹¦ç­¾å·²æ·»åŠ ï¼');
        }

        function renderTocList(type) {
            const list = document.getElementById('tocList');
            list.innerHTML = '';
            
            if (type === 'chapters') {
                const fragment = document.createDocumentFragment();
                currentBook.chapters.forEach((c, i) => {
                    const div = document.createElement('div');
                    div.className = `toc-item ${i===currentChapterIdx?'active':''}`;
                    div.innerText = c.title;
                    div.onclick = () => { currentChapterIdx = i; renderChapter(); closeOverlays(); };
                    fragment.appendChild(div);
                });
                list.appendChild(fragment);
                setTimeout(() => { const active = list.querySelector('.active'); if(active) active.scrollIntoView({block:'center'}); }, 100);
            } else {
                if (!currentBook.bookmarks || currentBook.bookmarks.length === 0) {
                    list.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">æš‚æ— ä¹¦ç­¾</div>';
                    return;
                }
                [...currentBook.bookmarks].reverse().forEach(bm => {
                    const div = document.createElement('div');
                    div.className = 'toc-item';
                    div.style.display='flex'; div.style.justifyContent='space-between';
                    div.innerHTML = `<div><div style="font-weight:bold">${bm.title}</div><div style="font-size:12px; color:#999">${bm.time}</div></div><button style="border:none;background:none;color:#ff6b6b;" onclick="deleteBookmark(${bm.id}, event)">ğŸ—‘ï¸</button>`;
                    div.onclick = () => { currentChapterIdx = bm.chapterIdx; renderChapter(); closeOverlays(); };
                    list.appendChild(div);
                });
            }
        }

        function deleteBookmark(id, event) {
            event.stopPropagation();
            if(confirm('åˆ é™¤?')) {
                currentBook.bookmarks = currentBook.bookmarks.filter(b => b.id !== id);
                db.transaction('novels', 'readwrite').objectStore('novels').put(currentBook);
                renderTocList('bookmarks');
            }
        }

        /* ================= 7. è®¾ç½®ä¸æŒä¹…åŒ– ================= */
        function updateStyle(varName, value) { document.documentElement.style.setProperty(varName, value); saveSetting(varName, value); }
        function saveSetting(key, val) { const tx = db.transaction('settings', 'readwrite'); tx.objectStore('settings').put({ key: key, value: val }); }

        function loadGlobalSettings() {
            const tx = db.transaction('settings', 'readonly');
            tx.objectStore('settings').getAll().onsuccess = (e) => {
                e.target.result.forEach(item => {
                    if (item.key === 'customFont' && item.value instanceof Blob) {
                         const fontUrl = URL.createObjectURL(item.value);
                         new FontFace('CustomUserFont', `url(${fontUrl})`).load().then(f => {
                            document.fonts.add(f); document.documentElement.style.setProperty('--reader-font', 'CustomUserFont, sans-serif');
                         });
                    } else if (item.key === 'readerMode') {
                        changeReaderMode(item.value);
                    } else if (item.key === 'customBg') {
                        applyCustomBg(item.value);
                    } else {
                        document.documentElement.style.setProperty(item.key, item.value);
                    }
                });
            };
        }

        function handleFontImport(input) {
            const file = input.files[0]; if(!file) return;
            const tx = db.transaction('settings', 'readwrite'); tx.objectStore('settings').put({ key: 'customFont', value: file });
            const fontUrl = URL.createObjectURL(file);
            new FontFace('CustomUserFont', `url(${fontUrl})`).load().then(f => {
                document.fonts.add(f); updateStyle('--reader-font', 'CustomUserFont, sans-serif'); alert('å­—ä½“å·²è®¾ç½®ï¼');
            });
        }

        function setCustomColor(color) { applyCustomBg({type:'color', val:color}); saveSetting('customBg', {type:'color', val:color}); }
        function setCustomBgImage(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { applyCustomBg({type:'image', val:e.target.result}); saveSetting('customBg', {type:'image', val:e.target.result}); };
            reader.readAsDataURL(file);
        }

        function applyCustomBg(bgData) {
            const page = document.getElementById('readerPage');
            if(bgData.type === 'color') {
                updateStyle('--reader-bg', bgData.val);
                page.style.backgroundImage = 'radial-gradient(#00000005 1px, transparent 1px)'; page.style.backgroundSize = '20px 20px';
            } else {
                page.style.background = 'none'; page.style.backgroundImage = `url(${bgData.val})`; page.style.backgroundSize = 'cover'; page.style.backgroundAttachment = 'fixed';
            }
            updateStyle('--reader-color', '#333');
        }

        function setTheme(bg, color) {
            updateStyle('--reader-bg', bg); updateStyle('--reader-color', color);
            document.getElementById('readerPage').style.backgroundImage = 'radial-gradient(#00000005 1px, transparent 1px)';
        }

        function toggleFullScreen() {
            const doc = window.document; const docEl = doc.documentElement;
            const req = docEl.requestFullscreen || docEl.webkitRequestFullScreen;
            const exit = doc.exitFullscreen || doc.webkitExitFullscreen;
            if(!doc.fullscreenElement && !doc.webkitFullscreenElement) { if(req) req.call(docEl); } else { if(exit) exit.call(doc); }
        }

        // 1. å¼ºåŠ›å¼€å…³è®¾ç½®é¢æ¿
function toggleSettings(force) {
    const p = document.getElementById('settingsPanel');
    const m = document.getElementById('touchMask');
    const n = document.getElementById('readerNav');
    const f = document.getElementById('readerFooter');
    
    // å¦‚æœä¼ å…¥ falseï¼Œæˆ–è€…é¢æ¿å·²ç»å¼€ç€ -> æ‰§è¡Œå…³é—­
    if (force === false || p.classList.contains('show')) {
        p.classList.remove('show');
        m.classList.remove('active');
        // æ”¶èµ·èœå•æ—¶ï¼ŒåŒæ—¶éšè—å¯¼èˆªæ  (å›åˆ°æ²‰æµ¸æ¨¡å¼)
        n.classList.add('hidden');
        f.classList.add('hidden');
    } else {
        // æ‰“å¼€
        p.classList.add('show');
        m.classList.add('active'); // é®ç½©å±‚æ¿€æ´»ï¼Œç‚¹å‡»é®ç½©å±‚ä¼šè§¦å‘ closeOverlays
        // æ‰“å¼€è®¾ç½®æ—¶ï¼Œå¯¼èˆªæ ä¹Ÿå¾—æ˜¾ç¤ºå‡ºæ¥
        n.classList.remove('hidden');
        f.classList.remove('hidden');
    }
}

        function toggleToc() {
            const d = document.getElementById('tocDrawer'); const m = document.getElementById('touchMask');
            d.classList.add('open'); m.classList.add('active');
            renderTocList('chapters'); // é»˜è®¤æ˜¾ç¤ºç« èŠ‚
        }
        // 2. å¼ºåŠ›å…³é—­æ‰€æœ‰è¦†ç›–å±‚ (ç‚¹å‡»é®ç½©/ä¸­é—´ è§¦å‘)
function closeOverlays() {
    // å…³æ‰è®¾ç½®
    document.getElementById('settingsPanel').classList.remove('show');
    // å…³æ‰ç›®å½•
    document.getElementById('tocDrawer').classList.remove('open');
    // å…³æ‰é®ç½©
    document.getElementById('touchMask').classList.remove('active');
    
    // é¡ºä¾¿æŠŠå¯¼èˆªæ ä¹Ÿæ”¶èµ·æ¥ (æ¢å¤é˜…è¯»çŠ¶æ€)
    document.getElementById('readerNav').classList.add('hidden');
    document.getElementById('readerFooter').classList.add('hidden');
}

/* ================= ğŸ–ï¸ æ‰‹åŠ¿æ§åˆ¶æ ¸å¿ƒ (æ»‘åŠ¨æ‰‹æ„Ÿä¼˜åŒ–) ================= */

let touchStartX = 0;
let touchStartY = 0;
let touchStartTime = 0;

// 1. æ‰‹æŒ‡æŒ‰ä¸‹ï¼šè®°å½•ä½ç½®å’Œæ—¶é—´
function recordTouchStart(e) {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
    touchStartTime = new Date().getTime();
}

// 2. æ‰‹æŒ‡æŠ¬èµ·ï¼šåˆ¤æ–­æ˜¯â€œç‚¹å‡»â€è¿˜æ˜¯â€œæ»‘åŠ¨â€
function handleTouchEnd(e) {
    const touchEndX = e.changedTouches[0].screenX;
    const touchEndY = e.changedTouches[0].screenY;
    const touchEndTime = new Date().getTime();

    const diffX = touchEndX - touchStartX;
    const diffY = touchEndY - touchStartY;
    const timeDiff = touchEndTime - touchStartTime;

    // --- åˆ¤æ–­é€»è¾‘ ---
    
    // å¦‚æœæ»‘åŠ¨è·ç¦»å¾ˆçŸ­ (å°äº 10px) -> è§†ä¸ºã€ç‚¹å‡»ã€‘
    if (Math.abs(diffX) < 10 && Math.abs(diffY) < 10) {
        // è®© onclick äº‹ä»¶å»å¤„ç†â€œä¸‹ä¸€é¡µâ€
        // è¿™é‡Œä¸åšæ“ä½œï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è§¦å‘ onclick
        return; 
    }

    // å¦‚æœæ»‘åŠ¨è·ç¦»è¾ƒé•¿ -> è§†ä¸ºã€æ»‘åŠ¨ã€‘
    // åªæœ‰åœ¨â€œå·¦å³ç¿»é¡µâ€æ¨¡å¼ä¸‹æ‰éœ€è¦å¤„ç†æ»‘åŠ¨ç¿»é¡µ
    // (ä¸Šä¸‹æ»šåŠ¨æ¨¡å¼è‡ªå¸¦åŸç”Ÿæ»‘åŠ¨ï¼Œä¸éœ€è¦æˆ‘ä»¬ç®¡)
    if (readerMode === 'page') {
        e.preventDefault(); // é˜»æ­¢é»˜è®¤æ»šåŠ¨ï¼Œåªæ‰§è¡Œç¿»é¡µ
        e.stopPropagation(); // é˜»æ­¢è§¦å‘ onclick

        // åˆ¤æ–­æ˜¯æ¨ªå‘æ»‘ è¿˜æ˜¯ ç«–å‘æ»‘
        if (Math.abs(diffX) > Math.abs(diffY)) {
            // --- æ¨ªå‘æ»‘åŠ¨ ---
            if (diffX > 50) {
                // ğŸ‘‰ å‘å³æ»‘ (æ‰‹æŒ‡ä»å·¦å¾€å³) -> ä¸Šä¸€é¡µ
                goPrev(); 
            } else if (diffX < -50) {
                // ğŸ‘ˆ å‘å·¦æ»‘ (æ‰‹æŒ‡ä»å³å¾€å·¦) -> ä¸‹ä¸€é¡µ
                goNext();
            }
        }
    }
}

// ä¿®æ”¹ goPrev å’Œ goNext ä»¥æ”¯æŒæ‰‹åŠ¿è°ƒç”¨
// (è¿™ä¸¤ä¸ªå‡½æ•°ä¹‹å‰å·²ç»æœ‰äº†ï¼Œè¿™é‡Œä¸éœ€è¦æ”¹åŠ¨ï¼Œç›´æ¥è°ƒç”¨å³å¯)


        initDB();
    </script>
</body>
</html>
