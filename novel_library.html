<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ“š æ¢¨æ¢¨è—ä¹¦é˜</title>
    <style>
        /* --- 1. æ ¸å¿ƒå­—ä½“ --- */
        @font-face {
            font-family: 'MyCustomFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            /* é»˜è®¤ï¼šå°‘å¥³ç²‰ä¸»é¢˜ (ç‹¬ç«‹äºä¸»ç³»ç»Ÿ) */
            --lib-primary: #ffb7c5;
            --lib-bg: #ffe6eb;
            --lib-card-bg: #fff;
            --lib-text: #6d5c5c;
            --lib-accent: #ff8fa3;
        }

        body {
            font-family: 'MyCustomFont', 'Microsoft YaHei', sans-serif;
            background-color: var(--lib-bg);
            color: var(--lib-text);
            margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* --- 2. é¡¶éƒ¨å¯¼èˆªæ  --- */
        .nav-header {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }
        .app-title {
            font-size: 18px; font-weight: bold; color: var(--lib-accent);
            display: flex; align-items: center; gap: 8px;
        }
        
        /* æŒ‰é’®é€šç”¨ */
        button { cursor: pointer; font-family: inherit; transition: 0.2s; border: none; outline: none; }
        button:active { transform: scale(0.95); }
        
        .btn-primary {
            background: var(--lib-primary); color: white;
            padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 13px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-icon {
            background: transparent; font-size: 20px; padding: 5px;
            color: var(--lib-text);
        }

        /* --- 3. ç­›é€‰å·¥å…·æ  --- */
        .filter-bar {
            padding: 10px 20px; background: rgba(255,255,255,0.4);
            display: flex; gap: 10px; overflow-x: auto;
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }
        .filter-btn {
            background: rgba(255,255,255,0.8); border: 1px solid transparent; color: #666;
            padding: 5px 12px; border-radius: 15px; font-size: 12px; white-space: nowrap;
        }
        .filter-btn.active {
            background: var(--lib-primary); color: white; border-color: var(--lib-primary);
        }

        /* --- 4. ä¹¦æ¶ç½‘æ ¼ --- */
        .library-grid {
            flex: 1; overflow-y: auto; padding: 20px;
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; align-content: start;
        }
        
        /* ä¹¦ç±å¡ç‰‡ */
        .book-card {
            background: var(--lib-card-bg); border-radius: 12px; padding: 15px;
            position: relative; display: flex; flex-direction: column;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border: 2px solid transparent;
            transition: all 0.2s; height: 160px;
        }
        .book-card:hover { transform: translateY(-3px); border-color: var(--lib-accent); }
        
        .book-icon { font-size: 36px; text-align: center; margin-bottom: 8px; }
        .book-title { 
            font-weight: bold; font-size: 14px; margin-bottom: 5px;
            color: var(--lib-text);
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            flex: 1; text-align: center;
        }
        .book-tags { display: flex; justify-content: center; gap: 4px; flex-wrap: wrap; margin-bottom: 8px; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; }
        
        .book-actions { display: flex; justify-content: center; gap: 10px; border-top: 1px dashed #eee; padding-top: 8px; }

        /* --- 5. çš®è‚¤åˆ‡æ¢èœå• --- */
        .skin-menu {
            position: absolute; top: 60px; right: 20px;
            background: white; padding: 10px; border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: none; flex-direction: column; gap: 8px; z-index: 500;
        }
        .skin-menu.show { display: flex; animation: fadeIn 0.2s; }
        .skin-option {
            display: flex; align-items: center; gap: 10px; padding: 5px 10px;
            cursor: pointer; font-size: 13px; border-radius: 6px;
        }
        .skin-option:hover { background: #f5f5f5; }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #ddd; }

        /* --- 6. é˜…è¯»å™¨ (å…¨å±è¦†ç›–) --- */
        .reader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fcf6e5; /* é»˜è®¤ç±³é»„æŠ¤çœ¼ */
            color: #333;
            z-index: 2000; display: none; flex-direction: column;
            transition: background 0.3s, color 0.3s;
        }
        .reader-overlay.active { display: flex; }

        .reader-top {
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.8); font-size: 14px; color: inherit;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .reader-content {
            flex: 1; overflow-y: auto; padding: 20px;
            font-size: 18px; line-height: 1.8; text-align: justify;
            white-space: pre-wrap; /* ä¿ç•™æ’ç‰ˆ */
            scroll-behavior: smooth;
            max-width: 800px; margin: 0 auto; /* å¤§å±é˜…è¯»é™åˆ¶å®½åº¦ */
        }

        /* é˜…è¯»å™¨è®¾ç½®é¢æ¿ */
        .reader-settings {
            background: #fff; padding: 20px; border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            position: absolute; bottom: 0; width: 100%; box-sizing: border-box;
            transform: translateY(100%); transition: transform 0.3s; color: #333;
        }
        .reader-settings.open { transform: translateY(0); }
        
        .setting-row { display: flex; align-items: center; margin-bottom: 15px; gap: 10px; font-size: 13px; }
        .setting-label { width: 40px; color: #888; font-weight: bold; }
        input[type=range] { flex: 1; accent-color: #ffb7c5; }

        /* è¿”å›ä¸»é¡µæ‚¬æµ®çƒ */
        .back-home-btn {
            position: fixed; bottom: 30px; right: 20px;
            width: 50px; height: 50px; border-radius: 50%;
            background: white; border: 3px solid var(--lib-primary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; cursor: pointer; z-index: 50; transition: transform 0.2s;
        }
        .back-home-btn:hover { transform: scale(1.1); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="nav-header">
        <div class="app-title">ğŸ“š æ¢¨æ¢¨è—ä¹¦é˜</div>
        <div style="display:flex; gap:10px;">
            <button class="btn-icon" onclick="toggleSkinMenu()" title="æ¢è‚¤">ğŸ¨</button>
            <button class="btn-primary" onclick="document.getElementById('importInput').click()">ğŸ“¥ å¯¼å…¥</button>
            <input type="file" id="importInput" accept=".txt" multiple style="display:none" onchange="importNovels(this)">
        </div>
    </div>

    <div class="skin-menu" id="skinMenu">
        <div class="skin-option" onclick="changeLibraryTheme('pink')">
            <div class="color-dot" style="background:#ffb7c5;"></div> å°‘å¥³ç²‰ (é»˜è®¤)
        </div>
        <div class="skin-option" onclick="changeLibraryTheme('green')">
            <div class="color-dot" style="background:#a5d6a7;"></div> æŠ¤çœ¼ç»¿
        </div>
        <div class="skin-option" onclick="changeLibraryTheme('blue')">
            <div class="color-dot" style="background:#90caf9;"></div> æ¸…çˆ½è“
        </div>
        <div class="skin-option" onclick="changeLibraryTheme('dark')">
            <div class="color-dot" style="background:#333;"></div> å¤œé—´æ¨¡å¼
        </div>
    </div>

    <div class="filter-bar">
        <button class="filter-btn active" onclick="filterList('all', this)">å…¨éƒ¨</button>
        <button class="filter-btn" onclick="filterList('reading', this)">â³ è¿è½½ä¸­</button>
        <button class="filter-btn" onclick="filterList('finished', this)">âœ… å·²å®Œç»“</button>
        <div style="width:1px; background:#ccc; opacity:0.5;"></div>
        <button class="filter-btn" onclick="filterList('unread', this)">ğŸ”´ æœªè¯»</button>
        <button class="filter-btn" onclick="filterList('read', this)">ğŸŸ¢ å·²è¯»</button>
    </div>

    <div class="library-grid" id="bookList">
        </div>

    <div class="back-home-btn" onclick="goBackMain()" title="è¿”å›ä¸»ç³»ç»Ÿ">ğŸ </div>

    <div class="reader-overlay" id="readerModal">
        <div class="reader-top">
            <button onclick="closeReader()" style="background:none; border:none; font-size:16px; cursor:pointer;">â¬…ï¸ è¿”å›</button>
            <span id="readTitle" style="font-weight:bold; max-width: 60%; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">æ ‡é¢˜</span>
            <button onclick="toggleSettings()" style="background:none; border:none; font-size:20px; cursor:pointer;">âš™ï¸</button>
        </div>
        
        <div class="reader-content" id="readContent" onclick="toggleSettings(false)">
            å†…å®¹åŠ è½½ä¸­...
        </div>

        <div class="reader-settings" id="settingPanel">
            <div class="setting-row">
                <span class="setting-label">èƒŒæ™¯</span>
                <div style="display:flex; gap:10px; flex:1; overflow-x:auto;">
                    <div onclick="setReaderTheme('#fcf6e5', '#333')" style="min-width:30px;height:30px;background:#fcf6e5;border-radius:50%;border:1px solid #ccc;"></div>
                    <div onclick="setReaderTheme('#ffffff', '#000')" style="min-width:30px;height:30px;background:#fff;border-radius:50%;border:1px solid #ccc;"></div>
                    <div onclick="setReaderTheme('#cce8cf', '#004d40')" style="min-width:30px;height:30px;background:#cce8cf;border-radius:50%;border:1px solid #b2dfdb;"></div>
                    <div onclick="setReaderTheme('#1a1a1a', '#b0b0b0')" style="min-width:30px;height:30px;background:#1a1a1a;border-radius:50%;border:1px solid #555;"></div>
                    <div onclick="setReaderTheme('#fff0f5', '#5d4037')" style="min-width:30px;height:30px;background:#fff0f5;border-radius:50%;border:1px solid #ffb7c5;"></div>
                </div>
            </div>
            <div class="setting-row">
                <span class="setting-label">å­—ä½“</span>
                <select onchange="setStyle('fontFamily', this.value)" style="flex:1; padding:5px; border-radius:5px; border:1px solid #ddd;">
                    <option value="'MyCustomFont', sans-serif">é»˜è®¤å¯çˆ±ä½“</option>
                    <option value="'Microsoft YaHei', sans-serif">å¾®è½¯é›…é»‘</option>
                    <option value="'Songti SC', serif">å®‹ä½“ (å°è¯´æ„Ÿ)</option>
                    <option value="'KaiTi', serif">æ¥·ä½“</option>
                </select>
            </div>
            <div class="setting-row">
                <span class="setting-label">å­—å·</span>
                <span style="font-size:12px">å°</span>
                <input type="range" min="14" max="32" value="18" oninput="setStyle('fontSize', this.value + 'px')">
                <span style="font-size:16px">å¤§</span>
            </div>
            <div class="setting-row">
                <span class="setting-label">è¡Œè·</span>
                <input type="range" min="1.2" max="2.5" step="0.1" value="1.8" oninput="setStyle('lineHeight', this.value)">
            </div>
            <div class="setting-row">
                <span class="setting-label">è¾¹è·</span>
                <input type="range" min="0" max="60" value="20" oninput="setStyle('padding', '20px ' + this.value + 'px')">
            </div>
        </div>
    </div>

    <script>
        // --- 1. æ•°æ®ä¸åˆå§‹åŒ– ---
        let novels = JSON.parse(localStorage.getItem('lili_novels') || '[]');
        
        // è¯»å–ç‹¬ç«‹çš„è—ä¹¦é˜ä¸»é¢˜
        const savedLibTheme = localStorage.getItem('lili_lib_theme') || 'pink';
        applyLibraryTheme(savedLibTheme);

        // --- 2. æ ¸å¿ƒé€»è¾‘ ---
        
        // å¯¼å…¥å°è¯´
        function importNovels(input) {
            const files = Array.from(input.files);
            if(files.length === 0) return;
            
            let loadedCount = 0;
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    novels.push({
                        id: Date.now() + Math.random().toString(),
                        title: file.name.replace('.txt', ''),
                        content: e.target.result,
                        status: 'reading', // reading / finished
                        isRead: false,     
                        addTime: new Date().toLocaleDateString()
                    });
                    loadedCount++;
                    if(loadedCount === files.length) {
                        saveAndRender();
                        alert(`æˆåŠŸå¯¼å…¥ ${loadedCount} æœ¬ä¹¦ï¼`);
                    }
                };
                reader.readAsText(file);
            });
            input.value = ''; // æ¸…ç©ºï¼Œå…è®¸é‡å¤é€‰åŒä¸€ä¸ªæ–‡ä»¶
        }

        // ä¿å­˜å¹¶åˆ·æ–°åˆ—è¡¨
        function saveAndRender(filter = 'all') {
            localStorage.setItem('lili_novels', JSON.stringify(novels));
            const grid = document.getElementById('bookList');
            grid.innerHTML = '';
            
            let list = novels;
            if(filter === 'reading') list = list.filter(n => n.status === 'reading');
            if(filter === 'finished') list = list.filter(n => n.status === 'finished');
            if(filter === 'unread') list = list.filter(n => !n.isRead);
            if(filter === 'read') list = list.filter(n => n.isRead);

            if(list.length === 0) {
                grid.innerHTML = '<div style="text-align:center;width:100%;color:#aaa;margin-top:50px;grid-column:1/-1;">ä¹¦æ¶ç©ºç©ºå¦‚ä¹Ÿ...</div>';
                return;
            }

            list.forEach(book => {
                const div = document.createElement('div');
                div.className = 'book-card';
                div.innerHTML = `
                    <div onclick="openReader('${book.id}')" style="cursor:pointer; flex:1; display:flex; flex-direction:column;">
                        <div class="book-icon">ğŸ“–</div>
                        <div class="book-title">${book.title}</div>
                        <div class="book-tags">
                            <span class="tag ${book.status === 'finished' ? 'tag-green' : 'tag-orange'}" style="background:${book.status === 'finished'?'#e8f5e9':'#fff3e0'};color:${book.status === 'finished'?'#2e7d32':'#ef6c00'}">
                                ${book.status === 'finished' ? 'å·²å®Œç»“' : 'è¿è½½ä¸­'}
                            </span>
                        </div>
                    </div>
                    <div class="book-actions">
                        <button class="btn-icon" style="font-size:14px;color:#888" onclick="toggleStatus('${book.id}', 'status')" title="åˆ‡æ¢è¿è½½/å®Œç»“">ğŸ·ï¸</button>
                        <button class="btn-icon" style="font-size:14px;color:${book.isRead?'#2ecc71':'#ccc'}" onclick="toggleStatus('${book.id}', 'isRead')" title="æ ‡è®°å·²è¯»">âœ”</button>
                        <button class="btn-icon" style="font-size:14px;color:#ff6b6b;" onclick="deleteBook('${book.id}')">ğŸ—‘ï¸</button>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function toggleStatus(id, field) {
            const book = novels.find(n => n.id === id);
            if(!book) return;
            if(field === 'status') book.status = book.status === 'reading' ? 'finished' : 'reading';
            else if(field === 'isRead') book.isRead = !book.isRead;
            saveAndRender();
        }

        function deleteBook(id) {
            if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿ')) {
                novels = novels.filter(n => n.id !== id);
                saveAndRender();
            }
        }

        function filterList(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            saveAndRender(type);
        }

        // --- 3. æ¢è‚¤ç³»ç»Ÿ (è—ä¹¦é˜ä¸“å±) ---
        function toggleSkinMenu() {
            const menu = document.getElementById('skinMenu');
            menu.classList.toggle('show');
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('skinMenu');
            const btn = document.querySelector('.btn-icon[title="æ¢è‚¤"]');
            if (!menu.contains(e.target) && e.target !== btn) {
                menu.classList.remove('show');
            }
        });

        function changeLibraryTheme(theme) {
            applyLibraryTheme(theme);
            localStorage.setItem('lili_lib_theme', theme);
            document.getElementById('skinMenu').classList.remove('show');
        }

        function applyLibraryTheme(theme) {
            const root = document.documentElement;
            if (theme === 'pink') {
                root.style.setProperty('--lib-primary', '#ffb7c5');
                root.style.setProperty('--lib-bg', '#ffe6eb');
                root.style.setProperty('--lib-card-bg', '#fff');
                root.style.setProperty('--lib-text', '#6d5c5c');
                root.style.setProperty('--lib-accent', '#ff8fa3');
            } else if (theme === 'green') {
                root.style.setProperty('--lib-primary', '#66bb6a');
                root.style.setProperty('--lib-bg', '#e8f5e9');
                root.style.setProperty('--lib-card-bg', '#fff');
                root.style.setProperty('--lib-text', '#1b5e20');
                root.style.setProperty('--lib-accent', '#43a047');
            } else if (theme === 'blue') {
                root.style.setProperty('--lib-primary', '#42a5f5');
                root.style.setProperty('--lib-bg', '#e3f2fd');
                root.style.setProperty('--lib-card-bg', '#fff');
                root.style.setProperty('--lib-text', '#0d47a1');
                root.style.setProperty('--lib-accent', '#1e88e5');
            } else if (theme === 'dark') {
                root.style.setProperty('--lib-primary', '#555');
                root.style.setProperty('--lib-bg', '#121212');
                root.style.setProperty('--lib-card-bg', '#1e1e1e');
                root.style.setProperty('--lib-text', '#e0e0e0');
                root.style.setProperty('--lib-accent', '#757575');
            }
        }


        // --- 4. é˜…è¯»å™¨åŠŸèƒ½ ---
        function openReader(id) {
            const book = novels.find(n => n.id === id);
            if(!book) return;
            
            document.getElementById('readTitle').innerText = book.title;
            document.getElementById('readContent').innerText = book.content;
            document.getElementById('readerModal').classList.add('active');
            
            // è¯»å–ä¹‹å‰çš„é˜…è¯»è®¾ç½®
            const style = JSON.parse(localStorage.getItem('lili_reader_pref') || '{}');
            if(style.fontSize) setStyle('fontSize', style.fontSize);
            if(style.lineHeight) setStyle('lineHeight', style.lineHeight);
            if(style.fontFamily) setStyle('fontFamily', style.fontFamily);
            if(style.padding) setStyle('padding', style.padding);
            if(style.bg) setReaderTheme(style.bg, style.color);
        }

        function closeReader() {
            document.getElementById('readerModal').classList.remove('active');
            document.getElementById('settingPanel').classList.remove('open');
        }

        function toggleSettings(force) {
            const panel = document.getElementById('settingPanel');
            if(force === false) panel.classList.remove('open');
            else panel.classList.toggle('open');
        }

        // æ ·å¼å®æ—¶ä¿®æ”¹
        function setStyle(prop, val) {
            document.getElementById('readContent').style[prop] = val;
            savePref(prop, val);
        }

        function setReaderTheme(bg, color) {
            const modal = document.getElementById('readerModal');
            modal.style.background = bg;
            modal.style.color = color;
            
            // ç¡®ä¿å¯¼èˆªæ é¢œè‰²é€‚é…
            const topBar = document.querySelector('.reader-top');
            if(bg === '#1a1a1a') {
                 topBar.style.background = 'rgba(0,0,0,0.5)';
                 topBar.style.color = '#ccc';
            } else {
                 topBar.style.background = 'rgba(255,255,255,0.8)';
                 topBar.style.color = '#333';
            }

            savePref('bg', bg);
            savePref('color', color);
        }

        function savePref(key, val) {
            const style = JSON.parse(localStorage.getItem('lili_reader_pref') || '{}');
            style[key] = val;
            localStorage.setItem('lili_reader_pref', JSON.stringify(style));
        }

        function goBackMain() {
             // å°è¯•æ£€æµ‹ä¸»æ–‡ä»¶åç§°ï¼Œå¦‚æœä¸çŸ¥é“å°±é»˜è®¤ index.html æˆ– ä¸»ç³»ç»Ÿ.txt
             if(document.referrer && document.referrer.indexOf('novel_library') === -1) {
                 history.back();
             } else {
                 window.location.href = 'ä¸»ç³»ç»Ÿ.txt'; // å¦‚æœä½ ä¸»ç³»ç»Ÿæ˜¯è¿™ä¸ªåå­—
             }
        }

        // åˆå§‹åŒ–
        saveAndRender();

    </script>
</body>
</html>
