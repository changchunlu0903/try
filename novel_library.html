<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>ğŸ“š æ¢¨æ¢¨è—ä¹¦é˜ (V19.0 å®Œç¾æ’ç‰ˆ)</title>
    <style>
        /* --- æ ¸å¿ƒå­—ä½“ä¸å˜é‡ --- */
        @font-face {
            font-family: 'DefaultFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            /* ä¸»é¢˜è‰² */
            --primary: #ffb7c5;
            --bg: #ffe6eb;
            --accent: #ff8fa3;
            --text: #5d4037;
            
            /* é˜…è¯»å™¨æ’ç‰ˆå˜é‡ (é»˜è®¤å€¼) */
            --reader-font: 'DefaultFont', sans-serif;
            --reader-size: 18px;
            --reader-line-height: 1.8;
            --reader-letter-spacing: 1px;
            --reader-para-spacing: 15px; /* æ®µè· */
            --reader-padding: 20px;      /* å·¦å³è¾¹è· */
            --reader-bg: #fdf6e3;
            --reader-color: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'DefaultFont', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- 1. é¡¶éƒ¨æ  --- */
        .header {
            background: rgba(255,255,255,0.95); padding: 10px 15px;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 18px; font-weight: bold; color: var(--accent); }
        
        .import-controls { display: flex; gap: 5px; align-items: center; }
        .encoding-select {
            font-size: 12px; padding: 5px; border-radius: 10px; border: 1px solid #ddd; background: #fff;
        }

        .search-box {
            background: #f0f0f0; border-radius: 20px; padding: 6px 15px;
            display: flex; align-items: center; gap: 5px;
        }
        .search-input { border: none; background: transparent; outline: none; width: 100%; font-size: 14px; }

        .btn {
            border: none; padding: 6px 12px; border-radius: 15px;
            font-size: 13px; cursor: pointer; transition: 0.2s; white-space: nowrap;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-icon { background: transparent; font-size: 20px; padding: 5px; }

        /* --- 2. ä¹¦æ¶ --- */
        .grid {
            flex: 1; overflow-y: auto; padding: 15px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px; align-content: start;
        }
        .book { display: flex; flex-direction: column; gap: 5px; cursor: pointer; }
        .cover {
            aspect-ratio: 2/3; background: #fff; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); position: relative;
        }
        .book-title { font-size: 13px; font-weight: bold; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        
        /* è¿›åº¦æ¡ */
        .progress-bar-bg { position: absolute; bottom: 0; left:0; width:100%; height:4px; background:#eee; border-radius: 0 0 8px 8px; }
        .progress-bar-fill { height:100%; background:var(--primary); width:0%; }

        /* --- 3. è¯¦æƒ…é¡µå¼¹çª— --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .detail-card {
            background: white; width: 85%; max-width: 400px; border-radius: 15px; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .detail-body { padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        /* --- 4. é˜…è¯»å™¨ (æ ¸å¿ƒä¼˜åŒ–) --- */
        .reader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--reader-bg); color: var(--reader-color);
            z-index: 2000; display: none; flex-direction: column;
        }
        .reader.active { display: flex; }

        .reader-nav {
            padding: 0 15px; height: 50px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.9); border-bottom: 1px solid #eee; flex-shrink: 0;
        }

        .reader-container {
            flex: 1; overflow-y: auto; overflow-x: hidden; /* é”æ­»æ¨ªå‘æ»šåŠ¨ */
            position: relative; width: 100%;
        }

        /* ğŸŒŸ æ ¸å¿ƒæ’ç‰ˆæ ·å¼ ğŸŒŸ */
        .reader-content {
            /* ä½¿ç”¨ padding å˜é‡æ§åˆ¶å·¦å³è¾¹è· */
            padding: 20px var(--reader-padding) 80px var(--reader-padding); 
            max-width: 100%; /* é”å®šå®½åº¦ */
            width: 100%;
            overflow-wrap: break-word; /* å¼ºåˆ¶æ–­è¡Œï¼Œé˜²æ­¢é•¿è‹±æ–‡æ’‘å¼€ */
            word-wrap: break-word;
            word-break: break-all;
        }

        /* ğŸŒŸ æ®µè½æ ·å¼ (æ§åˆ¶æ®µè·ã€è¡Œè·ã€å­—è·) ğŸŒŸ */
        .reader-content p {
            font-family: var(--reader-font);
            font-size: var(--reader-size);
            line-height: var(--reader-line-height);
            letter-spacing: var(--reader-letter-spacing);
            margin-bottom: var(--reader-para-spacing); /* æ®µè· */
            margin-top: 0;
            text-align: justify; /* ä¸¤ç«¯å¯¹é½ */
        }
        
        /* ç« èŠ‚æ ‡é¢˜ */
        .chapter-title {
            font-weight: bold; font-size: 1.4em; margin-bottom: 30px; 
            color: var(--primary); text-align: center;
        }

        /* åº•éƒ¨ç¿»é¡µæ  */
        .reader-footer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.95); padding: 10px 15px;
            display: flex; justify-content: space-between; gap: 10px;
            border-top: 1px solid #eee; z-index: 2010;
        }
        .page-btn { flex: 1; background: var(--primary); color: white; border: none; padding: 10px; border-radius: 20px; }

        /* --- 5. è®¾ç½®é¢æ¿ --- */
        .settings-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; padding: 20px; border-radius: 20px 20px 0 0;
            transform: translateY(100%); transition: 0.3s;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 2100;
            max-height: 70vh; overflow-y: auto;
        }
        .settings-panel.show { transform: translateY(0); }

        .setting-row { display: flex; align-items: center; margin-bottom: 15px; gap: 10px; font-size: 13px; color: #555; }
        .setting-label { width: 50px; font-weight: bold; flex-shrink: 0; }
        input[type=range] { flex: 1; accent-color: var(--primary); }

        /* ç›®å½• */
        .toc-drawer {
            position: fixed; top: 0; left: 0; width: 75%; height: 100%; background: white;
            transform: translateX(-100%); transition: 0.3s; z-index: 2200; display:flex; flex-direction:column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }
        .toc-drawer.open { transform: translateX(0); }
        .toc-list { flex:1; overflow-y:auto; }
        .toc-item { padding: 12px 15px; border-bottom: 1px solid #eee; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .toc-item.active { color: var(--primary); background: #fff0f5; font-weight:bold; }

        .mask { position: fixed; inset:0; background:rgba(0,0,0,0.3); z-index:2050; display:none; }
        .mask.active { display:block; }

        .back-home {
            position: fixed; bottom: 20px; right: 20px; width: 45px; height: 45px;
            background: white; border-radius: 50%; border: 2px solid var(--primary);
            display: flex; justify-content: center; align-items: center; font-size: 20px; z-index: 90;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="title">ğŸ“š è—ä¹¦é˜ Pro</div>
            <div class="import-controls">
                <select id="encodingSelect" class="encoding-select">
                    <option value="utf-8">UTF-8 (é»˜è®¤)</option>
                    <option value="gbk">GBK (è€ä¹¦ä¸“ç”¨)</option>
                </select>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥</button>
                <input type="file" id="fileInput" accept=".txt" multiple style="display:none" onchange="handleImport(this)">
            </div>
        </div>
        <div class="search-box">
            <span>ğŸ”</span>
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ä¹¦å..." onkeyup="renderBooks(this.value)">
        </div>
    </div>

    <div class="grid" id="bookGrid"></div>

    <div class="modal-overlay" id="detailModal">
        <div class="detail-card">
            <div class="detail-body">
                <h3 id="detailTitle" style="text-align:center; margin:0;">ä¹¦å</h3>
                <div id="detailInfo" style="text-align:center; color:#888; font-size:12px;"></div>
                <button class="btn btn-primary" style="padding:12px;" onclick="startReading()">ğŸ“– å¼€å§‹é˜…è¯»</button>
                <button class="btn" style="border:1px solid #ddd; background:white;" onclick="deleteCurrentBook()">ğŸ—‘ï¸ åˆ é™¤æœ¬ä¹¦</button>
                <button class="btn" onclick="document.getElementById('detailModal').classList.remove('active')">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="reader" id="readerPage">
        <div class="reader-nav">
            <button class="btn btn-icon" onclick="closeReader()">â¬…ï¸</button>
            <span id="readerTitle" style="font-weight:bold; font-size:14px; max-width:60%; overflow:hidden; white-space:nowrap;">æ ‡é¢˜</span>
            <button class="btn btn-icon" onclick="toggleSettings()">âš™ï¸</button>
        </div>
        
        <div class="reader-container">
            <div class="reader-content" id="readerContent" onclick="toggleSettings(false)"></div>
        </div>

        <div class="reader-footer" id="readerFooter">
            <button class="page-btn" style="background:#fff; color:#666; border:1px solid #ddd;" onclick="toggleToc()">ğŸ“‚ ç›®å½•</button>
            <button class="page-btn" onclick="prevChapter()">ä¸Šä¸€ç« </button>
            <button class="page-btn" onclick="nextChapter()">ä¸‹ä¸€ç« </button>
        </div>

        <div class="mask" id="touchMask" onclick="closeOverlays()"></div>

        <div class="toc-drawer" id="tocDrawer">
            <div style="padding:15px; border-bottom:1px solid #eee;">ğŸ“– ç›®å½•</div>
            <div class="toc-list" id="tocList"></div>
        </div>

        <div class="settings-panel" id="settingsPanel">
            
            <div class="setting-row" style="border-bottom:1px solid #eee; padding-bottom:10px;">
                <span class="setting-label">æ¢å­—ä½“</span>
                <button class="btn" style="border:1px solid #primary; color:var(--primary); background:#fff; flex:1;" onclick="document.getElementById('fontInput').click()">ğŸ“‚ å¯¼å…¥å­—ä½“æ–‡ä»¶(.ttf)</button>
                <input type="file" id="fontInput" accept=".ttf,.woff,.woff2" style="display:none" onchange="handleFontImport(this)">
            </div>

            <div class="setting-row">
                <span class="setting-label">èƒŒæ™¯</span>
                <div style="display:flex; gap:10px; flex:1;">
                    <div onclick="setTheme('#fdf6e3','#333')" style="width:30px;height:30px;background:#fdf6e3;border:1px solid #ccc;border-radius:50%;"></div>
                    <div onclick="setTheme('#ffffff','#000')" style="width:30px;height:30px;background:#ffffff;border:1px solid #ccc;border-radius:50%;"></div>
                    <div onclick="setTheme('#c8e6c9','#1b5e20')" style="width:30px;height:30px;background:#c8e6c9;border-radius:50%;"></div>
                    <div onclick="setTheme('#1a1a1a','#999')" style="width:30px;height:30px;background:#1a1a1a;border-radius:50%;"></div>
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">å­—å·</span>
                <input type="range" min="12" max="30" value="18" oninput="updateStyle('--reader-size', this.value + 'px')">
                <span style="font-size:12px;width:25px;" id="val_size">18</span>
            </div>
            <div class="setting-row">
                <span class="setting-label">è¡Œè·</span>
                <input type="range" min="1.0" max="3.0" step="0.1" value="1.8" oninput="updateStyle('--reader-line-height', this.value)">
            </div>
            <div class="setting-row">
                <span class="setting-label">å­—è·</span>
                <input type="range" min="0" max="10" step="0.5" value="1" oninput="updateStyle('--reader-letter-spacing', this.value + 'px')">
            </div>
            <div class="setting-row">
                <span class="setting-label">æ®µè·</span>
                <input type="range" min="0" max="50" value="15" oninput="updateStyle('--reader-para-spacing', this.value + 'px')">
            </div>
            <div class="setting-row">
                <span class="setting-label">è¾¹è·</span> <input type="range" min="0" max="60" value="20" oninput="updateStyle('--reader-padding', this.value + 'px')">
            </div>
        </div>
    </div>

    <div class="back-home" onclick="if(document.referrer){history.back()}else{window.location.href='ä¸»ç³»ç»Ÿ.txt'}">ğŸ </div>

    <script>
        /* ================= 1. æ•°æ®åº“ (IndexedDB) ================= */
        const DB_NAME = 'LiliNovelDB_V3'; // å‡çº§ç‰ˆæœ¬
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if(!db.objectStoreNames.contains('novels')) db.createObjectStore('novels', { keyPath: 'id' });
                    if(!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
                };
                req.onsuccess = (e) => {
                    db = e.target.result;
                    loadSettings();
                    renderBooks();
                    resolve(db);
                };
            });
        }

        /* ================= 2. å¯¼å…¥é€»è¾‘ (è§£å†³ä¹±ç ) ================= */
        
        async function handleImport(input) {
            const files = Array.from(input.files);
            if (!files.length) return;
            
            // è·å–ç”¨æˆ·é€‰æ‹©çš„ç¼–ç  (GBK or UTF-8)
            const encoding = document.getElementById('encodingSelect').value;
            let count = 0;

            for (const file of files) {
                try {
                    const text = await readFile(file, encoding);
                    // æ™ºèƒ½åˆ†ç« 
                    const chapters = splitChapters(text);
                    
                    const book = {
                        id: Date.now() + Math.random().toString(),
                        title: file.name.replace('.txt', ''),
                        chapters: chapters,
                        chapterIndex: 0,
                        addedAt: new Date().toLocaleDateString()
                    };
                    
                    const tx = db.transaction('novels', 'readwrite');
                    tx.objectStore('novels').add(book);
                    await new Promise(r => tx.oncomplete = r);
                    count++;
                } catch (e) {
                    alert(`å¯¼å…¥å¤±è´¥: ${file.name}\nè¯·å°è¯•åˆ‡æ¢ç¼–ç åé‡è¯•ã€‚`);
                }
            }
            alert(`âœ… æˆåŠŸå¯¼å…¥ ${count} æœ¬ä¹¦ï¼\nå¦‚æœä¸æ˜¾ç¤ºä¸­æ–‡ï¼Œè¯·åˆ‡æ¢å·¦ä¸Šè§’ç¼–ç ä¸º GBK å†è¯•ã€‚`);
            input.value = '';
            renderBooks();
        }

        function readFile(file, encoding) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, encoding); // å…³é”®ï¼šä½¿ç”¨æŒ‡å®šç¼–ç 
            });
        }

        // æ™ºèƒ½åˆ†ç« ï¼šå¦‚æœæ²¡æœ‰æ˜æ˜¾ç« èŠ‚ï¼Œæ¯3000å­—åˆ‡ä¸€ç« 
        function splitChapters(text) {
            // ç®€å•æ­£åˆ™åŒ¹é… "ç¬¬Xç« "
            const regex = /(?:^|\n)\s*(ç¬¬[0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]+[ç« å›èŠ‚][^\n]*)/g;
            const parts = text.split(regex);
            
            if (parts.length < 3) {
                // å¼ºåˆ¶åˆ‡åˆ†
                const chunks = [];
                const size = 3000;
                for(let i=0; i<text.length; i+=size) {
                    chunks.push({ title: `ç¬¬ ${Math.floor(i/size)+1} éƒ¨åˆ†`, content: text.substring(i, i+size) });
                }
                return chunks;
            } else {
                const chapters = [];
                if(parts[0].trim()) chapters.push({title:"åºç« ", content:parts[0]});
                for(let i=1; i<parts.length; i+=2) {
                    chapters.push({ title: parts[i].trim(), content: parts[i+1] });
                }
                return chapters;
            }
        }

        /* ================= 3. é˜…è¯»å™¨æ ¸å¿ƒ (è§£å†³æ’ç‰ˆ) ================= */
        let currentBook = null;
        let currentChapterIdx = 0;

        function startReading() {
            if(!currentBook) return;
            document.getElementById('detailModal').classList.remove('active');
            document.getElementById('readerPage').classList.add('active');
            
            currentChapterIdx = currentBook.chapterIndex || 0;
            if(currentChapterIdx >= currentBook.chapters.length) currentChapterIdx = 0;
            
            document.getElementById('readerTitle').innerText = currentBook.title;
            renderChapter();
        }

        function renderChapter() {
            const chap = currentBook.chapters[currentChapterIdx];
            const contentDiv = document.getElementById('readerContent');
            
            // 1. æ ‡é¢˜
            let html = `<div class="chapter-title">${chap.title}</div>`;
            
            // 2. æ ¸å¿ƒæ’ç‰ˆä¿®å¤ï¼šå°†æ¢è¡Œç¬¦è½¬ä¸º <p> æ ‡ç­¾
            // è¿™æ ·æ‰èƒ½å•ç‹¬æ§åˆ¶æ®µè· (margin-bottom)
            const paragraphs = chap.content.split('\n');
            paragraphs.forEach(p => {
                const trimmed = p.trim();
                if(trimmed) {
                    // æ¯ä¸€æ®µåŒ…è£¹åœ¨ P æ ‡ç­¾é‡Œï¼Œåˆ©ç”¨ CSS å˜é‡æ§åˆ¶é—´è·
                    html += `<p>${trimmed}</p>`;
                }
            });
            
            contentDiv.innerHTML = html;
            contentDiv.parentElement.scrollTop = 0; // å›åˆ°é¡¶éƒ¨
            
            // ä¿å­˜è¿›åº¦
            currentBook.chapterIndex = currentChapterIdx;
            const tx = db.transaction('novels', 'readwrite');
            tx.objectStore('novels').put(currentBook);
        }

        function prevChapter() {
            if(currentChapterIdx > 0) { currentChapterIdx--; renderChapter(); }
        }
        function nextChapter() {
            if(currentChapterIdx < currentBook.chapters.length-1) { currentChapterIdx++; renderChapter(); }
        }

        /* ================= 4. è®¾ç½®ä¸æ ·å¼ (å¯¼å…¥å­—ä½“ã€æ»‘å—) ================= */
        
        // æ ·å¼å®æ—¶æ›´æ–°
        function updateStyle(varName, value) {
            document.documentElement.style.setProperty(varName, value);
            saveSetting(varName, value);
        }

        // å¯¼å…¥å­—ä½“æ–‡ä»¶
        function handleFontImport(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const fontData = e.target.result;
                const fontFace = new FontFace('CustomUserFont', `url(${fontData})`);
                fontFace.load().then(loadedFace => {
                    document.fonts.add(loadedFace);
                    updateStyle('--reader-font', 'CustomUserFont, sans-serif');
                    alert('å­—ä½“å¯¼å…¥æˆåŠŸï¼âœ¨');
                });
            };
            reader.readAsDataURL(file); // è¯»å–ä¸ºBase64ä»¥åº”ç”¨
        }

        function setTheme(bg, color) {
            updateStyle('--reader-bg', bg);
            updateStyle('--reader-color', color);
            // å¯¼èˆªæ é€‚é…
            const navBg = bg === '#1a1a1a' ? 'rgba(0,0,0,0.9)' : 'rgba(255,255,255,0.9)';
            document.querySelector('.reader-nav').style.background = navBg;
            document.querySelector('.reader-nav').style.color = color;
            document.querySelector('.reader-footer').style.background = navBg;
            document.querySelector('.reader-footer').style.color = color;
        }

        // ä¿å­˜è®¾ç½®åˆ° DB
        function saveSetting(key, val) {
            const tx = db.transaction('settings', 'readwrite');
            tx.objectStore('settings').put({ key: key, value: val });
        }
        
        function loadSettings() {
            const tx = db.transaction('settings', 'readonly');
            const req = tx.objectStore('settings').getAll();
            req.onsuccess = (e) => {
                e.target.result.forEach(item => {
                    document.documentElement.style.setProperty(item.key, item.value);
                    // å°è¯•åŒæ­¥æ»‘å—ä½ç½® (å¯é€‰)
                });
            };
        }

        /* ================= 5. ç•Œé¢äº¤äº’ ================= */
        
        function renderBooks(filter='') {
            const grid = document.getElementById('bookGrid');
            grid.innerHTML = '';
            const tx = db.transaction('novels', 'readonly');
            const req = tx.objectStore('novels').getAll();
            req.onsuccess = (e) => {
                let list = e.target.result.reverse();
                if(filter) list = list.filter(b => b.title.includes(filter));
                
                list.forEach(book => {
                    const progress = Math.round(((book.chapterIndex||0) / book.chapters.length)*100);
                    const el = document.createElement('div');
                    el.className = 'book';
                    el.innerHTML = `
                        <div class="cover">
                            ğŸ“–
                            <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${progress}%"></div></div>
                        </div>
                        <div class="book-title">${book.title}</div>
                    `;
                    el.onclick = () => {
                        currentBook = book;
                        document.getElementById('detailTitle').innerText = book.title;
                        document.getElementById('detailInfo').innerText = `å…± ${book.chapters.length} ç«  Â· å·²è¯» ${progress}%`;
                        document.getElementById('detailModal').classList.add('active');
                    };
                    grid.appendChild(el);
                });
            };
        }

        function deleteCurrentBook() {
            if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
                const tx = db.transaction('novels', 'readwrite');
                tx.objectStore('novels').delete(currentBook.id);
                tx.oncomplete = () => {
                    document.getElementById('detailModal').classList.remove('active');
                    renderBooks();
                };
            }
        }

        function toggleSettings(force) {
            const p = document.getElementById('settingsPanel');
            const m = document.getElementById('touchMask');
            if(force === false) { p.classList.remove('show'); m.classList.remove('active'); }
            else { p.classList.toggle('show'); m.classList.toggle('active'); }
        }

        function toggleToc() {
            const d = document.getElementById('tocDrawer');
            const m = document.getElementById('touchMask');
            d.classList.add('open'); m.classList.add('active');
            
            const list = document.getElementById('tocList');
            list.innerHTML = '';
            currentBook.chapters.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = `toc-item ${i===currentChapterIdx?'active':''}`;
                div.innerText = c.title;
                div.onclick = () => {
                    currentChapterIdx = i;
                    renderChapter();
                    closeOverlays();
                };
                list.appendChild(div);
            });
        }

        function closeOverlays() {
            document.getElementById('settingsPanel').classList.remove('show');
            document.getElementById('tocDrawer').classList.remove('open');
            document.getElementById('touchMask').classList.remove('active');
        }

        function closeReader() {
            document.getElementById('readerPage').classList.remove('active');
            renderBooks();
        }

        initDB();

    </script>
</body>
</html>
