<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>ğŸ“š æ¢¨æ¢¨è—ä¹¦é˜ (V20.0 å…¨åŠŸèƒ½ç»ˆæç‰ˆ)</title>
    <style>
        /* ================= æ ¸å¿ƒæ ·å¼åŒºåŸŸ ================= */
        
        /* é»˜è®¤å­—ä½“ */
        @font-face {
            font-family: 'DefaultFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --primary: #ffb7c5;
            --bg: #ffe6eb;
            --accent: #ff8fa3;
            --text: #5d4037;
            
            /* é˜…è¯»å™¨å˜é‡ */
            --reader-font: 'DefaultFont', sans-serif;
            --reader-size: 18px;
            --reader-line-height: 1.8;
            --reader-letter-spacing: 1px;
            --reader-para-spacing: 15px; 
            --reader-padding: 20px;
            --reader-bg: #fdf6e3;
            --reader-color: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'DefaultFont', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* é¡¶éƒ¨æ  */
        .header {
            background: rgba(255,255,255,0.95); padding: 10px 15px;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 100;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 18px; font-weight: bold; color: var(--accent); }
        
        .import-controls { display: flex; gap: 5px; align-items: center; }
        .encoding-select { font-size: 12px; padding: 5px; border-radius: 10px; border: 1px solid #ddd; background: #fff; }

        .search-box {
            background: #f0f0f0; border-radius: 20px; padding: 6px 15px;
            display: flex; align-items: center; gap: 5px;
        }
        .search-input { border: none; background: transparent; outline: none; width: 100%; font-size: 14px; }

        /* ç­›é€‰æ æ ·å¼ */
        .filter-bar {
            display:flex; gap:10px; overflow-x:auto; padding-bottom: 5px;
        }
        .filter-btn {
            padding: 4px 12px; border-radius:15px; border:1px solid #ddd; background:white; color:#666; font-size:12px; white-space:nowrap;
        }
        .filter-btn.active { background:var(--primary); color:white; border-color:var(--primary); }

        .btn {
            border: none; padding: 6px 12px; border-radius: 15px;
            font-size: 13px; cursor: pointer; transition: 0.2s; white-space: nowrap;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-icon { background: transparent; font-size: 20px; padding: 5px; }

        /* ä¹¦æ¶ */
        .grid {
            flex: 1; overflow-y: auto; padding: 15px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px; align-content: start;
        }
        .book { display: flex; flex-direction: column; gap: 5px; cursor: pointer; }
        
        /* å°é¢æ ·å¼ (æ”¯æŒå›¾ç‰‡) */
        .cover {
            aspect-ratio: 2/3; 
            background-color: #fff; 
            background-size: cover; 
            background-position: center;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); position: relative;
            overflow: hidden;
        }
        .cover.has-img { font-size: 0; } /* æœ‰å›¾æ—¶ä¸æ˜¾ç¤ºemoji */

        .book-title { font-size: 13px; font-weight: bold; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .progress-bar-bg { position: absolute; bottom: 0; left:0; width:100%; height:4px; background:#eee; border-radius: 0 0 8px 8px; }
        .progress-bar-fill { height:100%; background:var(--primary); width:0%; }

        /* è¯¦æƒ…é¡µå¼¹çª— */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .detail-card {
            background: white; width: 90%; max-width: 400px; border-radius: 15px; overflow: hidden;
            display: flex; flex-direction: column; max-height: 90vh; overflow-y: auto;
        }
        .form-input { border: 1px solid #ddd; padding: 8px; border-radius: 8px; font-size: 14px; outline: none; width: 100%; }

        /* é˜…è¯»å™¨ */
        .reader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--reader-bg); color: var(--reader-color);
            z-index: 2000; display: none; flex-direction: column;
            background-size: cover; background-position: center; background-attachment: fixed;
        }
        .reader.active { display: flex; }

        .reader-nav {
            padding: 0 15px; height: 50px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.9); border-bottom: 1px solid #eee; flex-shrink: 0;
        }

        .reader-container { flex: 1; overflow-y: auto; overflow-x: hidden; width: 100%; }

        .reader-content {
            padding: 20px var(--reader-padding) 80px var(--reader-padding); 
            max-width: 100%; width: 100%;
            overflow-wrap: break-word; word-wrap: break-word; word-break: break-all;
        }

        /* ğŸŒŸ æ®µè½æ ·å¼ (å«é¦–è¡Œç¼©è¿›) ğŸŒŸ */
        .reader-content p {
            font-family: var(--reader-font);
            font-size: var(--reader-size);
            line-height: var(--reader-line-height);
            letter-spacing: var(--reader-letter-spacing);
            margin-bottom: var(--reader-para-spacing);
            text-align: justify;
            text-indent: 2em; /* é¦–è¡Œç¼©è¿› */
            margin-top: 0;
        }
        
        .chapter-title { font-weight: bold; font-size: 1.4em; margin-bottom: 30px; color: var(--primary); text-align: center; }

        .reader-footer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.95); padding: 10px 15px;
            display: flex; justify-content: space-between; gap: 10px;
            border-top: 1px solid #eee; z-index: 2010;
        }
        .page-btn { flex: 1; background: var(--primary); color: white; border: none; padding: 10px; border-radius: 20px; }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; padding: 20px; border-radius: 20px 20px 0 0;
            transform: translateY(100%); transition: 0.3s;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 2100;
            max-height: 70vh; overflow-y: auto;
        }
        .settings-panel.show { transform: translateY(0); }

        .setting-row { display: flex; align-items: center; margin-bottom: 15px; gap: 10px; font-size: 13px; color: #555; }
        .setting-label { width: 50px; font-weight: bold; flex-shrink: 0; }
        input[type=range] { flex: 1; accent-color: var(--primary); }

        /* ç›®å½• */
        .toc-drawer {
            position: fixed; top: 0; left: 0; width: 75%; height: 100%; background: white;
            transform: translateX(-100%); transition: 0.3s; z-index: 2200; display:flex; flex-direction:column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }
        .toc-drawer.open { transform: translateX(0); }
        .toc-list { flex:1; overflow-y:auto; }
        .toc-item { padding: 12px 15px; border-bottom: 1px solid #eee; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .toc-item.active { color: var(--primary); background: #fff0f5; font-weight:bold; }

        .mask { position: fixed; inset:0; background:rgba(0,0,0,0.3); z-index:2050; display:none; }
        .mask.active { display:block; }

        .back-home {
            position: fixed; bottom: 20px; right: 20px; width: 45px; height: 45px;
            background: white; border-radius: 50%; border: 2px solid var(--primary);
            display: flex; justify-content: center; align-items: center; font-size: 20px; z-index: 90;
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="title">ğŸ“š è—ä¹¦é˜ Pro</div>
            <div class="import-controls">
                <select id="encodingSelect" class="encoding-select">
                    <option value="utf-8">UTF-8</option>
                    <option value="gbk">GBK (è€ä¹¦)</option>
                </select>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥</button>
                <button class="btn" style="background:#fff; border:1px solid var(--primary); color:var(--primary);" onclick="exportData()">ğŸ“¤ å¯¼å‡º</button>
                <input type="file" id="fileInput" accept=".txt" multiple style="display:none" onchange="handleImport(this)">
            </div>
        </div>
        
        <div class="search-box">
            <span>ğŸ”</span>
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ä¹¦å..." onkeyup="renderBooks(this.value)">
        </div>

        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterBooks('all', this)">å…¨éƒ¨</button>
            <button class="filter-btn" onclick="filterBooks('reading', this)">â³ è¿è½½ä¸­</button>
            <button class="filter-btn" onclick="filterBooks('finished', this)">âœ… å·²å®Œç»“</button>
            <button class="filter-btn" onclick="filterBooks('unread', this)">ğŸ”´ æœªè¯»å®Œ</button>
            <button class="filter-btn" onclick="filterBooks('read', this)">ğŸŸ¢ å·²è¯»å®Œ</button>
        </div>
    </div>

    <div class="grid" id="bookGrid"></div>

    <div class="modal-overlay" id="detailModal">
        <div class="detail-card">
            <div class="detail-body" style="padding:15px; gap:10px; display: flex; flex-direction: column;">
                <div style="text-align:center; font-weight:bold; color:var(--primary); margin-bottom:5px;">ğŸ“ ç¼–è¾‘ä¹¦ç±ä¿¡æ¯</div>
                
                <div style="display:flex; gap:10px; align-items:center;">
                    <div id="previewCover" style="width:60px; height:90px; background:#eee; border-radius:5px; display:flex; justify-content:center; align-items:center; font-size:20px; background-size:cover;">ğŸ“–</div>
                    <div style="flex:1; display:flex; flex-direction:column; gap:5px;">
                        <button class="btn" style="font-size:12px; border:1px solid #ddd;" onclick="document.getElementById('coverInput').click()">ğŸ–¼ï¸ ä¸Šä¼ å°é¢å›¾</button>
                        <button class="btn" style="font-size:12px; border:1px solid #ddd;" onclick="removeCover()">ğŸ”„ æ¢å¤é»˜è®¤</button>
                        <input type="file" id="coverInput" accept="image/*" style="display:none" onchange="handleCoverChange(this)">
                    </div>
                </div>

                <input type="text" id="editTitle" class="form-input" placeholder="ä¹¦å">
                <input type="text" id="editAuthor" class="form-input" placeholder="ä½œè€…">
                
                <div style="display:flex; gap:5px;">
                    <select id="editStatus" class="form-input" style="flex:1">
                        <option value="reading">â³ è¿è½½ä¸­</option>
                        <option value="finished">âœ… å·²å®Œç»“</option>
                    </select>
                    <input type="text" id="editTags" class="form-input" style="flex:2" placeholder="æ ‡ç­¾">
                </div>

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-primary" style="flex:1; padding:10px;" onclick="saveDetailAndRead()">ğŸ“– ä¿å­˜å¹¶é˜…è¯»</button>
                    <button class="btn" onclick="saveDetailOnly()">ğŸ’¾ ä»…ä¿å­˜</button>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:5px;">
                    <button class="btn" style="color:#ff6b6b;" onclick="deleteCurrentBook()">ğŸ—‘ï¸ åˆ é™¤</button>
                    <button class="btn" onclick="document.getElementById('detailModal').classList.remove('active')">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <div class="reader" id="readerPage">
        <div class="reader-nav">
            <button class="btn btn-icon" onclick="closeReader()">â¬…ï¸</button>
            <span id="readerTitle" style="font-weight:bold; font-size:14px; max-width:60%; overflow:hidden; white-space:nowrap;">æ ‡é¢˜</span>
            <button class="btn btn-icon" onclick="toggleSettings()">âš™ï¸</button>
        </div>
        
        <div class="reader-container">
            <div class="reader-content" id="readerContent" onclick="toggleSettings(false)"></div>
        </div>

        <div class="reader-footer" id="readerFooter">
            <button class="page-btn" style="background:#fff; color:#666; border:1px solid #ddd;" onclick="toggleToc()">ğŸ“‚ ç›®å½•</button>
            <button class="page-btn" onclick="prevChapter()">ä¸Šä¸€ç« </button>
            <button class="page-btn" onclick="nextChapter()">ä¸‹ä¸€ç« </button>
        </div>

        <div class="mask" id="touchMask" onclick="closeOverlays()"></div>

        <div class="toc-drawer" id="tocDrawer">
            <div style="padding:15px; border-bottom:1px solid #eee;">ğŸ“– ç›®å½•</div>
            <div class="toc-list" id="tocList"></div>
        </div>

        <div class="settings-panel" id="settingsPanel">
            
            <div class="setting-row" style="justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:10px;">
                <span class="setting-label">åŠŸèƒ½</span>
                <div style="display:flex; gap:10px;">
                    <button class="btn" onclick="toggleFullScreen()">ğŸ“º å…¨å±</button>
                    <button class="btn" onclick="document.getElementById('fontInput').click()">ğŸ”¤ å¯¼å…¥å­—ä½“(æ°¸ä¹…)</button>
                </div>
                <input type="file" id="fontInput" accept=".ttf,.woff,.woff2" style="display:none" onchange="handleFontImport(this)">
            </div>

            <div class="setting-row">
                <span class="setting-label">èƒŒæ™¯</span>
                <div style="display:flex; gap:8px; overflow-x:auto; align-items:center;">
                    <div onclick="setTheme('#fdf6e3','#333')" style="width:30px;height:30px;background:#fdf6e3;border:1px solid #ccc;border-radius:50%;"></div>
                    <div onclick="setTheme('#ffffff','#000')" style="width:30px;height:30px;background:#ffffff;border:1px solid #ccc;border-radius:50%;"></div>
                    <div onclick="setTheme('#1a1a1a','#999')" style="width:30px;height:30px;background:#1a1a1a;border-radius:50%;"></div>
                    
                    <input type="color" id="customBgColor" onchange="setCustomColor(this.value)" style="width:30px; height:30px; border:none; padding:0; background:none;">
                    
                    <button class="btn" style="font-size:10px; padding:2px 5px;" onclick="document.getElementById('bgImgInput').click()">ğŸ–¼ï¸ å›¾ç‰‡</button>
                    <input type="file" id="bgImgInput" accept="image/*" style="display:none" onchange="setCustomBgImage(this)">
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">å­—å·</span>
                <input type="range" min="12" max="30" value="18" oninput="updateStyle('--reader-size', this.value + 'px')">
            </div>
            <div class="setting-row">
                <span class="setting-label">è¡Œè·</span>
                <input type="range" min="1.0" max="3.0" step="0.1" value="1.8" oninput="updateStyle('--reader-line-height', this.value)">
            </div>
            <div class="setting-row">
                <span class="setting-label">æ®µè·</span>
                <input type="range" min="0" max="50" value="15" oninput="updateStyle('--reader-para-spacing', this.value + 'px')">
            </div>
             <div class="setting-row">
                <span class="setting-label">è¾¹è·</span>
                <input type="range" min="0" max="60" value="20" oninput="updateStyle('--reader-padding', this.value + 'px')">
            </div>
        </div>
    </div>

    <div class="back-home" onclick="if(document.referrer){history.back()}else{window.location.href='ä¸»ç³»ç»Ÿ.txt'}">ğŸ </div>

    <script>
        /* ================= 1. æ•°æ®åº“é…ç½® ================= */
        const DB_NAME = 'LiliNovelDB_V5'; // å‡çº§æ•°æ®åº“ç‰ˆæœ¬ä»¥æ”¯æŒæ–°åŠŸèƒ½
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if(!db.objectStoreNames.contains('novels')) db.createObjectStore('novels', { keyPath: 'id' });
                    if(!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
                };
                req.onsuccess = (e) => {
                    db = e.target.result;
                    loadGlobalSettings(); // åŠ è½½å­—ä½“å’ŒèƒŒæ™¯
                    renderBooks();
                    resolve(db);
                };
            });
        }

        /* ================= 2. å¯¼å…¥ä¸å¯¼å‡º ================= */
        async function handleImport(input) {
            const files = Array.from(input.files);
            if (!files.length) return;
            const encoding = document.getElementById('encodingSelect').value;
            let count = 0;
            for (const file of files) {
                try {
                    const text = await readFile(file, encoding);
                    const chapters = splitChapters(text);
                    const book = {
                        id: Date.now() + Math.random().toString(),
                        title: file.name.replace('.txt', ''),
                        author: 'æœªçŸ¥',
                        chapters: chapters,
                        chapterIndex: 0,
                        status: 'reading',
                        cover: null,
                        tags: '',
                        addedAt: new Date().toLocaleDateString()
                    };
                    const tx = db.transaction('novels', 'readwrite');
                    tx.objectStore('novels').add(book);
                    await new Promise(r => tx.oncomplete = r);
                    count++;
                } catch (e) { alert(`å¯¼å…¥å¤±è´¥: ${file.name}`); }
            }
            alert(`âœ… æˆåŠŸå¯¼å…¥ ${count} æœ¬ä¹¦ï¼`);
            input.value = '';
            renderBooks();
        }

        function readFile(file, encoding) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, encoding);
            });
        }

        function splitChapters(text) {
            const regex = /(?:^|\n)\s*(ç¬¬[0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]+[ç« å›èŠ‚][^\n]*)/g;
            const parts = text.split(regex);
            if (parts.length < 3) {
                const chunks = []; const size = 3000;
                for(let i=0; i<text.length; i+=size) chunks.push({ title: `ç¬¬ ${Math.floor(i/size)+1} éƒ¨åˆ†`, content: text.substring(i, i+size) });
                return chunks;
            } else {
                const chapters = [];
                if(parts[0].trim()) chapters.push({title:"åºç« ", content:parts[0]});
                for(let i=1; i<parts.length; i+=2) chapters.push({ title: parts[i].trim(), content: parts[i+1] });
                return chapters;
            }
        }

        function exportData() {
            const tx = db.transaction('novels', 'readonly');
            const req = tx.objectStore('novels').getAll();
            req.onsuccess = (e) => {
                const data = JSON.stringify(e.target.result);
                const blob = new Blob([data], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `æ¢¨æ¢¨è—ä¹¦é˜å¤‡ä»½_${new Date().toLocaleDateString()}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };
        }

        /* ================= 3. ä¹¦æ¶ä¸ç­›é€‰ ================= */
        let currentFilter = 'all';

        function filterBooks(type, btn) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderBooks();
        }

        function renderBooks(searchQuery = '') {
            const grid = document.getElementById('bookGrid');
            grid.innerHTML = '';
            const tx = db.transaction('novels', 'readonly');
            const req = tx.objectStore('novels').getAll();
            
            req.onsuccess = (e) => {
                let list = e.target.result.reverse();
                if(searchQuery) {
                    const q = searchQuery.toLowerCase();
                    list = list.filter(b => b.title.toLowerCase().includes(q) || (b.author && b.author.toLowerCase().includes(q)));
                }

                if (currentFilter === 'reading') list = list.filter(b => b.status !== 'finished');
                if (currentFilter === 'finished') list = list.filter(b => b.status === 'finished');
                if (currentFilter === 'unread') list = list.filter(b => (b.chapterIndex || 0) < b.chapters.length - 1);
                if (currentFilter === 'read') list = list.filter(b => (b.chapterIndex || 0) >= b.chapters.length - 1);

                list.forEach(book => {
                    const progress = Math.round(((book.chapterIndex||0) / book.chapters.length)*100);
                    let coverHtml = book.cover ? `<div class="cover has-img" style="background-image:url(${book.cover})"></div>` : 
                        `<div class="cover">ğŸ“–<div class="book-title" style="position:absolute; padding:10px; text-align:center;">${book.title}</div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${progress}%"></div></div></div>`;

                    const el = document.createElement('div');
                    el.className = 'book';
                    el.innerHTML = `${coverHtml}<div style="font-size:12px; font-weight:bold; margin-top:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${book.title}</div><div style="font-size:10px; color:#888;">${book.author} Â· ${progress}%</div>`;
                    el.onclick = () => openDetail(book);
                    grid.appendChild(el);
                });
            };
        }

        /* ================= 4. è¯¦æƒ…é¡µä¸ç¼–è¾‘ ================= */
        let currentBook = null;
        let tempCover = null;

        function openDetail(book) {
            currentBook = book;
            tempCover = book.cover;
            document.getElementById('editTitle').value = book.title;
            document.getElementById('editAuthor').value = book.author || '';
            document.getElementById('editStatus').value = book.status || 'reading';
            document.getElementById('editTags').value = book.tags || '';
            updateCoverPreview(book.cover);
            document.getElementById('detailModal').classList.add('active');
        }

        function updateCoverPreview(base64) {
            const div = document.getElementById('previewCover');
            if(base64) {
                div.innerText = ''; div.style.backgroundImage = `url(${base64})`; div.classList.add('has-img');
            } else {
                div.innerText = 'ğŸ“–'; div.style.backgroundImage = 'none'; div.classList.remove('has-img');
            }
        }

        function handleCoverChange(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { tempCover = e.target.result; updateCoverPreview(tempCover); };
            reader.readAsDataURL(file);
        }

        function removeCover() { tempCover = null; updateCoverPreview(null); }

        function saveDetailOnly() { updateBookInfo(); alert('ä¿å­˜æˆåŠŸï¼'); }
        function saveDetailAndRead() { updateBookInfo(); startReading(); }

        function updateBookInfo() {
            if(!currentBook) return;
            currentBook.title = document.getElementById('editTitle').value;
            currentBook.author = document.getElementById('editAuthor').value;
            currentBook.status = document.getElementById('editStatus').value;
            currentBook.tags = document.getElementById('editTags').value;
            currentBook.cover = tempCover;
            const tx = db.transaction('novels', 'readwrite');
            tx.objectStore('novels').put(currentBook);
            tx.oncomplete = () => renderBooks();
        }

        function deleteCurrentBook() {
            if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
                const tx = db.transaction('novels', 'readwrite');
                tx.objectStore('novels').delete(currentBook.id);
                tx.oncomplete = () => { document.getElementById('detailModal').classList.remove('active'); renderBooks(); };
            }
        }

        /* ================= 5. é˜…è¯»å™¨é€»è¾‘ ================= */
        let currentChapterIdx = 0;

        function startReading() {
            if(!currentBook) return;
            document.getElementById('detailModal').classList.remove('active');
            document.getElementById('readerPage').classList.add('active');
            currentChapterIdx = currentBook.chapterIndex || 0;
            if(currentChapterIdx >= currentBook.chapters.length) currentChapterIdx = 0;
            document.getElementById('readerTitle').innerText = currentBook.title;
            renderChapter();
        }

        function renderChapter() {
            const chap = currentBook.chapters[currentChapterIdx];
            const contentDiv = document.getElementById('readerContent');
            let html = `<div class="chapter-title">${chap.title}</div>`;
            const paragraphs = chap.content.split('\n');
            paragraphs.forEach(p => { if(p.trim()) html += `<p>${p.trim()}</p>`; });
            contentDiv.innerHTML = html;
            contentDiv.parentElement.scrollTop = 0;
            
            currentBook.chapterIndex = currentChapterIdx;
            const tx = db.transaction('novels', 'readwrite');
            tx.objectStore('novels').put(currentBook);
        }

        function prevChapter() { if(currentChapterIdx > 0) { currentChapterIdx--; renderChapter(); } }
        function nextChapter() { if(currentChapterIdx < currentBook.chapters.length-1) { currentChapterIdx++; renderChapter(); } }

        function closeReader() { document.getElementById('readerPage').classList.remove('active'); renderBooks(); }

        /* ================= 6. è®¾ç½®ä¸æŒä¹…åŒ– ================= */
        function updateStyle(varName, value) {
            document.documentElement.style.setProperty(varName, value);
            saveSetting(varName, value);
        }

        function saveSetting(key, val) {
            const tx = db.transaction('settings', 'readwrite');
            tx.objectStore('settings').put({ key: key, value: val });
        }

        function loadGlobalSettings() {
            const tx = db.transaction('settings', 'readonly');
            const store = tx.objectStore('settings');
            store.getAll().onsuccess = (e) => {
                e.target.result.forEach(item => {
                    if (item.key === 'customFont' && item.value instanceof Blob) {
                         const fontUrl = URL.createObjectURL(item.value);
                         new FontFace('CustomUserFont', `url(${fontUrl})`).load().then(f => {
                            document.fonts.add(f);
                            document.documentElement.style.setProperty('--reader-font', 'CustomUserFont, sans-serif');
                         });
                    } else if (item.key === 'customBg') {
                        applyCustomBg(item.value);
                    } else {
                        document.documentElement.style.setProperty(item.key, item.value);
                    }
                });
            };
        }

        function handleFontImport(input) {
            const file = input.files[0]; if(!file) return;
            const tx = db.transaction('settings', 'readwrite');
            tx.objectStore('settings').put({ key: 'customFont', value: file });
            const fontUrl = URL.createObjectURL(file);
            new FontFace('CustomUserFont', `url(${fontUrl})`).load().then(f => {
                document.fonts.add(f);
                updateStyle('--reader-font', 'CustomUserFont, sans-serif');
                alert('å­—ä½“å·²æ°¸ä¹…ä¿å­˜ï¼');
            });
        }

        function setCustomColor(color) { applyCustomBg({type:'color', val:color}); saveSetting('customBg', {type:'color', val:color}); }
        function setCustomBgImage(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { applyCustomBg({type:'image', val:e.target.result}); saveSetting('customBg', {type:'image', val:e.target.result}); };
            reader.readAsDataURL(file);
        }

        function applyCustomBg(bgData) {
            if(bgData.type === 'color') {
                updateStyle('--reader-bg', bgData.val);
                document.getElementById('readerPage').style.backgroundImage = 'none';
            } else {
                document.getElementById('readerPage').style.background = 'none';
                document.getElementById('readerPage').style.backgroundImage = `url(${bgData.val})`;
            }
            updateStyle('--reader-color', '#333');
        }

        function setTheme(bg, color) {
            updateStyle('--reader-bg', bg); updateStyle('--reader-color', color);
            const navBg = bg === '#1a1a1a' ? 'rgba(0,0,0,0.9)' : 'rgba(255,255,255,0.9)';
            document.querySelector('.reader-nav').style.background = navBg;
            document.querySelector('.reader-nav').style.color = color;
            document.querySelector('.reader-footer').style.background = navBg;
            document.querySelector('.reader-footer').style.color = color;
            document.getElementById('readerPage').style.backgroundImage = 'none';
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }

        /* ç•Œé¢å¼€å…³ */
        function toggleSettings(force) {
            const p = document.getElementById('settingsPanel'); const m = document.getElementById('touchMask');
            if(force===false){p.classList.remove('show');m.classList.remove('active');} else{p.classList.toggle('show');m.classList.toggle('active');}
        }
        function toggleToc() {
            const d = document.getElementById('tocDrawer'); const m = document.getElementById('touchMask');
            d.classList.add('open'); m.classList.add('active');
            const list = document.getElementById('tocList'); list.innerHTML = '';
            currentBook.chapters.forEach((c, i) => {
                const div = document.createElement('div'); div.className = `toc-item ${i===currentChapterIdx?'active':''}`;
                div.innerText = c.title; div.onclick = () => { currentChapterIdx = i; renderChapter(); closeOverlays(); };
                list.appendChild(div);
            });
        }
        function closeOverlays() {
            document.getElementById('settingsPanel').classList.remove('show');
            document.getElementById('tocDrawer').classList.remove('open');
            document.getElementById('touchMask').classList.remove('active');
        }

        initDB();
    </script>
</body>
</html>
