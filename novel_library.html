<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ğŸŒ¸ æ¢¨æ¢¨è—ä¹¦é˜ (ç”œå¿ƒç‰ˆ V21.0)</title>
    <style>
        /* ================= æ ¸å¿ƒæ ·å¼ï¼šèŒåŒ–å®šä¹‰ ================= */
        
        @font-face {
            font-family: 'LiliFont';
            src: url('https://files.catbox.moe/cweam3.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            /* ğŸ¬ ç”œå¿ƒè‰²æ¿ */
            --primary: #ffb7c5;      /* æ¨±èŠ±ç²‰ */
            --primary-dark: #ff8fa3; /* æ·±ç²‰ */
            --bg-color: #fff0f5;     /* æµ…ç²‰èƒŒæ™¯ */
            --card-bg: rgba(255, 255, 255, 0.85);
            --text-main: #6d5c5c;    /* å·§å…‹åŠ›è‰²æ–‡å­— */
            --glass: rgba(255, 255, 255, 0.7);
            --shadow: 0 8px 20px rgba(255, 183, 197, 0.3);
            
            /* ğŸ“– é˜…è¯»å™¨é»˜è®¤å˜é‡ */
            --reader-font: 'LiliFont', sans-serif;
            --reader-size: 18px;
            --reader-line-height: 1.8;
            --reader-letter-spacing: 1px;
            --reader-para-spacing: 15px;
            --reader-padding: 20px;
            --reader-bg: #fdf6e3;
            --reader-color: #333;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            font-family: 'LiliFont', sans-serif;
            background: linear-gradient(135deg, #fff0f5 0%, #ffe6eb 100%);
            color: var(--text-main);
            margin: 0; padding: 0;
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* ---------------- é¡¶éƒ¨æ  (æ¯›ç»ç’ƒ) ---------------- */
        .header {
            background: var(--glass);
            backdrop-filter: blur(10px); /* æ¯›ç»ç’ƒ */
            -webkit-backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex; flex-direction: column; gap: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            z-index: 100;
            border-radius: 0 0 25px 25px;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 20px; font-weight: bold; color: var(--primary-dark); text-shadow: 1px 1px 0 #fff; }

        /* å¯çˆ±çš„æŒ‰é’® */
        .btn {
            border: none; padding: 8px 15px; border-radius: 20px;
            font-size: 13px; cursor: pointer; transition: 0.2s; white-space: nowrap;
            font-family: 'LiliFont', sans-serif;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn:active { transform: scale(0.95); }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 10px rgba(255, 143, 163, 0.4);
        }
        .btn-ghost {
            background: rgba(255,255,255,0.8);
            border: 1px solid var(--primary);
            color: var(--primary-dark);
        }

        /* æœç´¢æ¡† */
        .search-box {
            background: white; border-radius: 25px; padding: 8px 15px;
            display: flex; align-items: center; gap: 8px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);
            border: 1px solid #ffe6eb;
        }
        .search-input { border: none; background: transparent; width: 100%; font-size: 14px; color: var(--text-main); font-family: 'LiliFont'; }

        /* ç­›é€‰èƒ¶å›Š */
        .filter-bar { display:flex; gap:8px; overflow-x:auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-btn {
            padding: 5px 15px; border-radius:15px; background:rgba(255,255,255,0.6); 
            color:#888; font-size:12px; white-space:nowrap; border: 1px solid transparent;
            transition: 0.3s;
        }
        .filter-btn.active {
            background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(255, 183, 197, 0.5);
        }

        /* ---------------- ä¹¦æ¶åŒºåŸŸ ---------------- */
        .grid {
            flex: 1; overflow-y: auto; padding: 20px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr));
            gap: 20px; align-content: start;
        }

        .book {
            display: flex; flex-direction: column; gap: 8px; cursor: pointer;
            transition: 0.3s;
            animation: fadeIn 0.5s ease;
        }
        .book:active { transform: scale(0.95); }

        .cover {
            aspect-ratio: 2/3; 
            background: white;
            background-size: cover; background-position: center;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            position: relative; overflow: hidden;
            border: 2px solid white;
        }
        .cover.has-img { font-size: 0; border: none; }
        
        .book-title { 
            font-size: 13px; font-weight: bold; text-align: center; color: #555;
            overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; 
        }

        .progress-bar {
            position: absolute; bottom: 8px; left: 10%; width: 80%; height: 4px;
            background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden;
        }
        .progress-fill { height: 100%; background: var(--primary-dark); width: 0%; border-radius: 4px; }

        /* ---------------- è¯¦æƒ…é¡µ & å¼¹çª— ---------------- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(109, 92, 92, 0.4); z-index: 1000;
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .detail-card {
            background: rgba(255,255,255,0.95); width: 85%; max-width: 380px; 
            border-radius: 25px; padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transform: translateY(20px); transition: transform 0.3s;
            display: flex; flex-direction: column; gap: 15px;
        }
        .modal-overlay.active .detail-card { transform: translateY(0); }

        .form-input {
            background: #f9f9f9; border: 1px solid #eee; padding: 10px; 
            border-radius: 12px; font-size: 14px; width: 100%; font-family: 'LiliFont';
        }
        .form-input:focus { border-color: var(--primary); background: white; }

        /* ---------------- ğŸ“– æ²‰æµ¸å¼é˜…è¯»å™¨ ---------------- */
        .reader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--reader-bg); color: var(--reader-color);
            z-index: 2000; display: none; flex-direction: column;
            /* çº¸å¼ çº¹ç† */
            background-image: radial-gradient(#00000005 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .reader.active { display: flex; animation: slideUp 0.3s ease; }

        .reader-nav {
            padding: 0 15px; height: 55px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05); flex-shrink: 0;
        }

        .reader-container { flex: 1; overflow-y: auto; overflow-x: hidden; width: 100%; scroll-behavior: smooth; }

        .reader-content {
            padding: 20px var(--reader-padding) 100px var(--reader-padding); 
            max-width: 100%; width: 100%;
        }

        .reader-content p {
            font-family: var(--reader-font);
            font-size: var(--reader-size);
            line-height: var(--reader-line-height);
            letter-spacing: var(--reader-letter-spacing);
            margin-bottom: var(--reader-para-spacing);
            text-align: justify;
            text-indent: 2em; /* é¦–è¡Œç¼©è¿› */
            margin-top: 0;
        }

        .chapter-title {
            font-size: 1.5em; font-weight: bold; text-align: center; margin: 30px 0;
            color: var(--primary-dark); 
            border-bottom: 2px dashed var(--primary); padding-bottom: 10px; display: inline-block;
        }

        /* é˜…è¯»å™¨åº•éƒ¨æ  */
        .reader-footer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 10px 20px 20px 20px;
            display: flex; justify-content: space-between; gap: 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 2010;
        }
        .page-btn {
            flex: 1; background: var(--bg-color); color: var(--text-main); border: 1px solid var(--primary); 
            padding: 12px; border-radius: 15px; font-weight: bold;
        }
        .page-btn:active { background: var(--primary); color: white; }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: white; border-radius: 30px 30px 0 0;
            padding: 25px; padding-bottom: 40px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15); z-index: 2100;
            transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .settings-panel.show { transform: translateY(0); }

        .setting-row { display: flex; align-items: center; margin-bottom: 20px; gap: 15px; color: #666; font-size: 14px; }
        
        /* ğŸ¬ ç³–æœæ»‘å— */
        input[type=range] {
            flex: 1; height: 6px; border-radius: 5px; background: #eee;
            appearance: none; -webkit-appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%;
            background: var(--primary); border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ä¾§è¾¹ç›®å½• */
        .toc-drawer {
            position: fixed; top: 0; left: 0; width: 80%; height: 100%; background: #fffafc;
            transform: translateX(-100%); transition: 0.3s; z-index: 2200; display:flex; flex-direction:column;
            box-shadow: 5px 0 20px rgba(0,0,0,0.1);
        }
        .toc-drawer.open { transform: translateX(0); }
        .toc-list { padding: 10px; overflow-y: auto; }
        .toc-item { 
            padding: 15px; border-bottom: 1px dashed #eee; font-size: 14px; color: #555; 
            border-radius: 10px; margin-bottom: 5px;
        }
        .toc-item.active { background: var(--primary); color: white; border:none; }

        /* é®ç½© */
        .mask { position: fixed; inset:0; background:rgba(0,0,0,0.2); z-index:2050; display:none; backdrop-filter: blur(2px); }
        .mask.active { display:block; }

        /* è¿”å›æŒ‰é’® */
        .back-home {
            position: fixed; bottom: 25px; right: 25px; width: 50px; height: 50px;
            background: white; border-radius: 50%; 
            box-shadow: 0 5px 15px rgba(255, 183, 197, 0.5);
            display: flex; justify-content: center; align-items: center; font-size: 24px; z-index: 90;
            border: 2px solid var(--primary);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="title">ğŸŒ¸ æ¢¨æ¢¨è—ä¹¦é˜</div>
            <div class="import-controls" style="display:flex; gap:8px;">
                <select id="encodingSelect" class="form-input" style="width:auto; padding:5px; font-size:12px;">
                    <option value="utf-8">UTF-8</option>
                    <option value="gbk">GBK (ä¹±ç é€‰æˆ‘)</option>
                </select>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">ğŸ“¥ å¯¼å…¥</button>
                <button class="btn btn-ghost" onclick="exportData()">ğŸ“¤ å¤‡ä»½</button>
                <input type="file" id="fileInput" accept=".txt" multiple style="display:none" onchange="handleImport(this)">
            </div>
        </div>
        
        <div class="search-box">
            <span>ğŸ”</span>
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢ä¹¦å..." onkeyup="renderBooks(this.value)">
        </div>

        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterBooks('all', this)">å…¨éƒ¨</button>
            <button class="filter-btn" onclick="filterBooks('reading', this)">â³ è¿è½½ä¸­</button>
            <button class="filter-btn" onclick="filterBooks('finished', this)">âœ… å·²å®Œç»“</button>
            <button class="filter-btn" onclick="filterBooks('unread', this)">ğŸ”´ æœªè¯»å®Œ</button>
            <button class="filter-btn" onclick="filterBooks('read', this)">ğŸŸ¢ å·²è¯»å®Œ</button>
        </div>
    </div>

    <div class="grid" id="bookGrid"></div>

    <div class="modal-overlay" id="detailModal">
        <div class="detail-card">
            <div style="text-align:center; font-weight:bold; color:var(--primary-dark); font-size:16px;">âœ¨ ä¹¦ç±ä¿¡æ¯ âœ¨</div>
            
            <div style="display:flex; gap:15px; align-items:center;">
                <div id="previewCover" class="cover" style="width:70px; height:105px; font-size:24px; box-shadow:none; border:1px dashed #ccc;">ğŸ“–</div>
                <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
                    <button class="btn btn-ghost" onclick="document.getElementById('coverInput').click()">ğŸ“· æ¢å°é¢</button>
                    <button class="btn btn-ghost" style="border-color:#ccc; color:#888;" onclick="removeCover()">ğŸ”„ è¿˜åŸ</button>
                    <input type="file" id="coverInput" accept="image/*" style="display:none" onchange="handleCoverChange(this)">
                </div>
            </div>

            <input type="text" id="editTitle" class="form-input" placeholder="ä¹¦å">
            <input type="text" id="editAuthor" class="form-input" placeholder="ä½œè€…">
            
            <div style="display:flex; gap:10px;">
                <select id="editStatus" class="form-input">
                    <option value="reading">â³ è¿è½½ä¸­</option>
                    <option value="finished">âœ… å·²å®Œç»“</option>
                </select>
                <input type="text" id="editTags" class="form-input" placeholder="æ ‡ç­¾">
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-primary" style="flex:1; padding:12px; font-size:15px;" onclick="saveDetailAndRead()">ğŸ’– å¼€å§‹é˜…è¯»</button>
                <button class="btn btn-ghost" onclick="saveDetailOnly()">ğŸ’¾ ä¿å­˜</button>
            </div>
            
            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                <button class="btn" style="color:#ff6b6b; background:none;" onclick="deleteCurrentBook()">ğŸ—‘ï¸ åˆ é™¤æœ¬ä¹¦</button>
                <button class="btn" style="color:#888; background:none;" onclick="document.getElementById('detailModal').classList.remove('active')">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="reader" id="readerPage">
        <div class="reader-nav">
            <button class="btn btn-icon" onclick="closeReader()" style="font-size:18px;">â¬…ï¸</button>
            <span id="readerTitle" style="font-weight:bold; max-width:60%; overflow:hidden; white-space:nowrap;">æ ‡é¢˜</span>
            <button class="btn btn-icon" onclick="toggleSettings()">âš™ï¸</button>
        </div>
        
        <div class="reader-container">
            <div class="reader-content" id="readerContent" onclick="toggleSettings(false)"></div>
        </div>

        <div class="reader-footer" id="readerFooter">
            <button class="page-btn" onclick="toggleToc()">ğŸ“‚ ç›®å½•</button>
            <button class="page-btn" onclick="prevChapter()">ä¸Šä¸€ç« </button>
            <button class="page-btn" onclick="nextChapter()">ä¸‹ä¸€ç« </button>
        </div>

        <div class="mask" id="touchMask" onclick="closeOverlays()"></div>

        <div class="toc-drawer" id="tocDrawer">
            <div style="padding:20px; font-weight:bold; color:var(--primary-dark); background:#fff;">ğŸ“‘ ç« èŠ‚ç›®å½•</div>
            <div class="toc-list" id="tocList"></div>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <div style="text-align:center; margin-bottom:20px; color:#aaa; font-size:12px;">â€”â€” é˜…è¯»è®¾ç½® â€”â€”</div>
            
            <div class="setting-row" style="justify-content:space-between;">
                <span class="setting-label">åŠŸèƒ½</span>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-ghost" onclick="toggleFullScreen()">ğŸ“º å…¨å±æ¨¡å¼</button>
                    <button class="btn btn-ghost" onclick="document.getElementById('fontInput').click()">ğŸ”¤ å¯¼å…¥å­—ä½“</button>
                </div>
                <input type="file" id="fontInput" accept=".ttf,.woff,.woff2" style="display:none" onchange="handleFontImport(this)">
            </div>

            <div class="setting-row">
                <span class="setting-label">ä¿¡çº¸</span>
                <div style="display:flex; gap:10px; overflow-x:auto;">
                    <div onclick="setTheme('#fdf6e3','#333')" style="min-width:35px;height:35px;background:#fdf6e3;border-radius:50%;border:2px solid #ddd;"></div>
                    <div onclick="setTheme('#ffffff','#000')" style="min-width:35px;height:35px;background:#fff;border-radius:50%;border:2px solid #ddd;"></div>
                    <div onclick="setTheme('#1a1a1a','#999')" style="min-width:35px;height:35px;background:#1a1a1a;border-radius:50%;"></div>
                    <div onclick="setTheme('#e8f5e9','#1b5e20')" style="min-width:35px;height:35px;background:#e8f5e9;border-radius:50%;border:2px solid #c8e6c9;"></div>
                    
                    <input type="color" id="customBgColor" onchange="setCustomColor(this.value)" style="min-width:35px; height:35px; padding:0; border:none; background:none;">
                    <button class="btn btn-ghost" style="padding:5px 10px; font-size:10px;" onclick="document.getElementById('bgImgInput').click()">ğŸ–¼ï¸å›¾</button>
                    <input type="file" id="bgImgInput" accept="image/*" style="display:none" onchange="setCustomBgImage(this)">
                </div>
            </div>

            <div class="setting-row">
                <span class="setting-label">å­—å·</span>
                <span style="font-size:12px">å°</span>
                <input type="range" min="12" max="32" value="18" oninput="updateStyle('--reader-size', this.value + 'px')">
                <span style="font-size:12px">å¤§</span>
            </div>
            
            <div class="setting-row">
                <span class="setting-label">è¡Œè·</span>
                <input type="range" min="1.0" max="3.0" step="0.1" value="1.8" oninput="updateStyle('--reader-line-height', this.value)">
            </div>
            
            <div class="setting-row">
                <span class="setting-label">è¾¹è·</span>
                <input type="range" min="0" max="60" value="20" oninput="updateStyle('--reader-padding', this.value + 'px')">
            </div>
        </div>
    </div>

    <div class="back-home" onclick="if(document.referrer){history.back()}else{window.location.href='ä¸»ç³»ç»Ÿ.txt'}">ğŸ </div>

    <script>
        /* ================= 1. æ•°æ®åº“é…ç½® ================= */
        const DB_NAME = 'LiliNovelDB_V21'; 
        let db;

        function initDB() {
            return new Promise((resolve) => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if(!db.objectStoreNames.contains('novels')) db.createObjectStore('novels', { keyPath: 'id' });
                    if(!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
                };
                req.onsuccess = (e) => {
                    db = e.target.result;
                    loadGlobalSettings();
                    renderBooks();
                    resolve(db);
                };
            });
        }

        /* ================= 2. å¯¼å…¥ä¸å¯¼å‡º ================= */
        async function handleImport(input) {
            const files = Array.from(input.files);
            if (!files.length) return;
            const encoding = document.getElementById('encodingSelect').value;
            let count = 0;
            
            for (const file of files) {
                try {
                    const text = await readFile(file, encoding);
                    const chapters = splitChapters(text);
                    const book = {
                        id: Date.now() + Math.random().toString(),
                        title: file.name.replace('.txt', ''),
                        author: 'æœªçŸ¥',
                        chapters: chapters,
                        chapterIndex: 0,
                        status: 'reading',
                        cover: null,
                        tags: '',
                        addedAt: new Date().toLocaleDateString()
                    };
                    const tx = db.transaction('novels', 'readwrite');
                    tx.objectStore('novels').add(book);
                    await new Promise(r => tx.oncomplete = r);
                    count++;
                } catch (e) { alert(`âŒ å¯¼å…¥å¤±è´¥: ${file.name}`); }
            }
            alert(`ğŸ‰ æˆåŠŸå¯¼å…¥ ${count} æœ¬ä¹¦ï¼`);
            input.value = '';
            renderBooks();
        }

        function readFile(file, encoding) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file, encoding);
            });
        }

        function splitChapters(text) {
            // æ™ºèƒ½åˆ†ç« æ­£åˆ™
            const regex = /(?:^|\n)\s*(ç¬¬[0-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]+[ç« å›èŠ‚][^\n]*)/g;
            const parts = text.split(regex);
            if (parts.length < 3) {
                const chunks = []; const size = 3000;
                for(let i=0; i<text.length; i+=size) chunks.push({ title: `ç¬¬ ${Math.floor(i/size)+1} éƒ¨åˆ†`, content: text.substring(i, i+size) });
                return chunks;
            } else {
                const chapters = [];
                if(parts[0].trim()) chapters.push({title:"åºç« ", content:parts[0]});
                for(let i=1; i<parts.length; i+=2) chapters.push({ title: parts[i].trim(), content: parts[i+1] });
                return chapters;
            }
        }

        function exportData() {
            const tx = db.transaction('novels', 'readonly');
            tx.objectStore('novels').getAll().onsuccess = (e) => {
                const data = JSON.stringify(e.target.result);
                const blob = new Blob([data], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `æ¢¨æ¢¨è—ä¹¦é˜å¤‡ä»½_${new Date().toLocaleDateString()}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };
        }

        /* ================= 3. ä¹¦æ¶ä¸ç­›é€‰ ================= */
        let currentFilter = 'all';

        function filterBooks(type, btn) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderBooks();
        }

        function renderBooks(searchQuery = '') {
            const grid = document.getElementById('bookGrid');
            grid.innerHTML = '';
            
            db.transaction('novels', 'readonly').objectStore('novels').getAll().onsuccess = (e) => {
                let list = e.target.result.reverse();
                if(searchQuery) {
                    const q = searchQuery.toLowerCase();
                    list = list.filter(b => b.title.toLowerCase().includes(q) || (b.author && b.author.includes(q)));
                }

                if (currentFilter === 'reading') list = list.filter(b => b.status !== 'finished');
                if (currentFilter === 'finished') list = list.filter(b => b.status === 'finished');
                if (currentFilter === 'unread') list = list.filter(b => (b.chapterIndex || 0) < b.chapters.length - 1);
                if (currentFilter === 'read') list = list.filter(b => (b.chapterIndex || 0) >= b.chapters.length - 1);

                if(list.length === 0) {
                    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#ccc; margin-top:50px;">ç©ºç©ºå¦‚ä¹Ÿ...</div>';
                    return;
                }

                list.forEach(book => {
                    const progress = Math.round(((book.chapterIndex||0) / book.chapters.length)*100);
                    let coverHtml = book.cover ? 
                        `<div class="cover has-img" style="background-image:url(${book.cover})"></div>` : 
                        `<div class="cover">ğŸ“–
                             <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
                         </div>`;

                    const el = document.createElement('div');
                    el.className = 'book';
                    el.innerHTML = `${coverHtml}<div class="book-title">${book.title}</div>`;
                    el.onclick = () => openDetail(book);
                    grid.appendChild(el);
                });
            };
        }

        /* ================= 4. è¯¦æƒ…é¡µä¸ç¼–è¾‘ ================= */
        let currentBook = null;
        let tempCover = null;

        function openDetail(book) {
            currentBook = book;
            tempCover = book.cover;
            document.getElementById('editTitle').value = book.title;
            document.getElementById('editAuthor').value = book.author || '';
            document.getElementById('editStatus').value = book.status || 'reading';
            document.getElementById('editTags').value = book.tags || '';
            updateCoverPreview(book.cover);
            document.getElementById('detailModal').classList.add('active');
        }

        function updateCoverPreview(base64) {
            const div = document.getElementById('previewCover');
            if(base64) {
                div.innerText = ''; div.style.backgroundImage = `url(${base64})`; div.classList.add('has-img'); div.style.border='none';
            } else {
                div.innerText = 'ğŸ“–'; div.style.backgroundImage = 'none'; div.classList.remove('has-img'); div.style.border='1px dashed #ccc';
            }
        }

        function handleCoverChange(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { tempCover = e.target.result; updateCoverPreview(tempCover); };
            reader.readAsDataURL(file);
        }

        function removeCover() { tempCover = null; updateCoverPreview(null); }
        function saveDetailOnly() { updateBookInfo(); alert('å·²ä¿å­˜'); }
        function saveDetailAndRead() { updateBookInfo(); startReading(); }

        function updateBookInfo() {
            if(!currentBook) return;
            currentBook.title = document.getElementById('editTitle').value;
            currentBook.author = document.getElementById('editAuthor').value;
            currentBook.status = document.getElementById('editStatus').value;
            currentBook.tags = document.getElementById('editTags').value;
            currentBook.cover = tempCover;
            const tx = db.transaction('novels', 'readwrite');
            tx.objectStore('novels').put(currentBook);
            tx.oncomplete = () => renderBooks();
        }

        function deleteCurrentBook() {
            if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿ(ä¸å¯æ¢å¤)')) {
                const tx = db.transaction('novels', 'readwrite');
                tx.objectStore('novels').delete(currentBook.id);
                tx.oncomplete = () => { document.getElementById('detailModal').classList.remove('active'); renderBooks(); };
            }
        }

        /* ================= 5. é˜…è¯»å™¨é€»è¾‘ ================= */
        let currentChapterIdx = 0;

        function startReading() {
            if(!currentBook) return;
            document.getElementById('detailModal').classList.remove('active');
            document.getElementById('readerPage').classList.add('active');
            currentChapterIdx = currentBook.chapterIndex || 0;
            if(currentChapterIdx >= currentBook.chapters.length) currentChapterIdx = 0;
            document.getElementById('readerTitle').innerText = currentBook.title;
            renderChapter();
        }

        function renderChapter() {
            const chap = currentBook.chapters[currentChapterIdx];
            const contentDiv = document.getElementById('readerContent');
            let html = `<div class="chapter-title" style="text-align:center">${chap.title}</div>`;
            
            // æ–‡æœ¬æ ¼å¼åŒ–
            const paragraphs = chap.content.split('\n');
            paragraphs.forEach(p => { 
                if(p.trim()) html += `<p>${p.trim()}</p>`; 
            });
            
            contentDiv.innerHTML = html;
            contentDiv.parentElement.scrollTop = 0;
            
            // ä¿å­˜è¿›åº¦
            currentBook.chapterIndex = currentChapterIdx;
            const tx = db.transaction('novels', 'readwrite');
            tx.objectStore('novels').put(currentBook);
        }

        function prevChapter() { if(currentChapterIdx > 0) { currentChapterIdx--; renderChapter(); } else { alert('å·²ç»æ˜¯ç¬¬ä¸€ç« å•¦'); } }
        function nextChapter() { if(currentChapterIdx < currentBook.chapters.length-1) { currentChapterIdx++; renderChapter(); } else { alert('æ­å–œçœ‹å®Œå•¦ï¼'); currentBook.status='finished'; updateBookInfo(); } }
        function closeReader() { document.getElementById('readerPage').classList.remove('active'); renderBooks(); }

        /* ================= 6. å¼ºåŠ›å…¨å±å…¼å®¹ ================= */
        function toggleFullScreen() {
            const doc = window.document;
            const docEl = doc.documentElement;

            const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
            const cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

            if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
                if(requestFullScreen) {
                    requestFullScreen.call(docEl).catch(err => {
                        alert("æ‚¨çš„æµè§ˆå™¨é™åˆ¶äº†å…¨å±åŠŸèƒ½ï¼Œè¯·å°è¯•åœ¨æµè§ˆå™¨èœå•ä¸­ç‚¹å‡»'æ·»åŠ åˆ°ä¸»å±å¹•'ã€‚");
                    });
                } else {
                    alert("å½“å‰è®¾å¤‡ä¸æ”¯æŒè‡ªåŠ¨å…¨å±ï¼Œè¯·æ‰‹åŠ¨éšè—åœ°å€æ ã€‚");
                }
            } else {
                if(cancelFullScreen) cancelFullScreen.call(doc);
            }
        }

        /* ================= 7. è®¾ç½®ä¸æŒä¹…åŒ– ================= */
        function updateStyle(varName, value) {
            document.documentElement.style.setProperty(varName, value);
            saveSetting(varName, value);
        }

        function saveSetting(key, val) {
            const tx = db.transaction('settings', 'readwrite');
            tx.objectStore('settings').put({ key: key, value: val });
        }

        function loadGlobalSettings() {
            const tx = db.transaction('settings', 'readonly');
            tx.objectStore('settings').getAll().onsuccess = (e) => {
                e.target.result.forEach(item => {
                    if (item.key === 'customFont' && item.value instanceof Blob) {
                         const fontUrl = URL.createObjectURL(item.value);
                         new FontFace('CustomUserFont', `url(${fontUrl})`).load().then(f => {
                            document.fonts.add(f);
                            document.documentElement.style.setProperty('--reader-font', 'CustomUserFont, sans-serif');
                         });
                    } else if (item.key === 'customBg') {
                        applyCustomBg(item.value);
                    } else {
                        document.documentElement.style.setProperty(item.key, item.value);
                    }
                });
            };
        }

        function handleFontImport(input) {
            const file = input.files[0]; if(!file) return;
            const tx = db.transaction('settings', 'readwrite');
            tx.objectStore('settings').put({ key: 'customFont', value: file });
            const fontUrl = URL.createObjectURL(file);
            new FontFace('CustomUserFont', `url(${fontUrl})`).load().then(f => {
                document.fonts.add(f);
                updateStyle('--reader-font', 'CustomUserFont, sans-serif');
                alert('å­—ä½“å·²è®¾ç½®ï¼');
            });
        }

        function setCustomColor(color) { applyCustomBg({type:'color', val:color}); saveSetting('customBg', {type:'color', val:color}); }
        function setCustomBgImage(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { applyCustomBg({type:'image', val:e.target.result}); saveSetting('customBg', {type:'image', val:e.target.result}); };
            reader.readAsDataURL(file);
        }

        function applyCustomBg(bgData) {
            const page = document.getElementById('readerPage');
            if(bgData.type === 'color') {
                updateStyle('--reader-bg', bgData.val);
                page.style.backgroundImage = 'radial-gradient(#00000005 1px, transparent 1px)'; // ä¿ç•™çº¹ç†
                page.style.backgroundSize = '20px 20px';
            } else {
                page.style.background = 'none';
                page.style.backgroundImage = `url(${bgData.val})`;
                page.style.backgroundSize = 'cover';
                page.style.backgroundAttachment = 'fixed';
            }
            updateStyle('--reader-color', '#333');
        }

        function setTheme(bg, color) {
            updateStyle('--reader-bg', bg); updateStyle('--reader-color', color);
            document.getElementById('readerPage').style.backgroundImage = 'radial-gradient(#00000005 1px, transparent 1px)';
            document.getElementById('readerPage').style.backgroundSize = '20px 20px';
        }

        /* ç•Œé¢å¼€å…³ */
        function toggleSettings(force) {
            const p = document.getElementById('settingsPanel'); const m = document.getElementById('touchMask');
            if(force===false){p.classList.remove('show');m.classList.remove('active');} else{p.classList.toggle('show');m.classList.toggle('active');}
        }
        function toggleToc() {
            const d = document.getElementById('tocDrawer'); const m = document.getElementById('touchMask');
            d.classList.add('open'); m.classList.add('active');
            const list = document.getElementById('tocList'); list.innerHTML = '';
            
            // ä¼˜åŒ–ï¼šä¸€æ¬¡æ€§æ’å…¥ï¼Œå‡å°‘é‡ç»˜
            const fragment = document.createDocumentFragment();
            currentBook.chapters.forEach((c, i) => {
                const div = document.createElement('div'); 
                div.className = `toc-item ${i===currentChapterIdx?'active':''}`;
                div.innerText = c.title; 
                div.onclick = () => { currentChapterIdx = i; renderChapter(); closeOverlays(); };
                fragment.appendChild(div);
            });
            list.appendChild(fragment);
            
            // è‡ªåŠ¨æ»šåŠ¨
            setTimeout(() => { const active = list.querySelector('.active'); if(active) active.scrollIntoView({block:'center'}); }, 100);
        }
        function closeOverlays() {
            document.getElementById('settingsPanel').classList.remove('show');
            document.getElementById('tocDrawer').classList.remove('open');
            document.getElementById('touchMask').classList.remove('active');
        }

        initDB();
    </script>
</body>
</html>
