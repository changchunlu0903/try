<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ¨ Loppy çµé­‚ç”»æ‰‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <style>
        @font-face { font-family: 'MyCutieFont'; src: url('https://files.catbox.moe/cweam3.ttf') format('truetype'); font-display: swap; }
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; -webkit-tap-highlight-color: transparent; }
        
        body { font-family: 'MyCutieFont', sans-serif; background: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* é¡¶éƒ¨ */
        .top-bar { padding: 10px; background: rgba(255,255,255,0.8); display: flex; justify-content: space-between; align-items: center; border-bottom: 2px dashed #ff9a9e; z-index: 100; }
        .back-btn { text-decoration: none; font-size: 20px; cursor: pointer; }
        .game-info { font-size: 16px; color: #ff6b81; font-weight: bold; }

        /* ä¸»åŒºåŸŸ */
        .main-area { flex: 1; display: flex; position: relative; overflow: hidden; }
        
        /* ä¾§è¾¹æ  */
        .sidebar { width: 80px; background: rgba(255,255,255,0.5); border-right: 2px dashed #fff; overflow-y: auto; padding: 5px; display: flex; flex-direction: column; gap: 5px; }
        .player-card { background: #fff; border-radius: 10px; padding: 5px; text-align: center; border: 2px solid #fff; transition: 0.3s; opacity: 0.7; }
        .player-card.active { border-color: #ff9a9e; transform: scale(1.05); opacity: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .p-name { font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .p-score { font-size: 12px; color: #ff7675; font-weight: bold; }

        /* ç”»æ¿å®¹å™¨ */
        .canvas-container { flex: 1; position: relative; background: #fff; margin: 10px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 4px solid #a29bfe; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        canvas { touch-action: none; width: 100%; height: 100%; border-radius: 15px; }

        /* é®ç½©å±‚ (é¢˜ç›®/ç­‰å¾…/ç»“æœ) */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; display: none; text-align: center; padding: 20px; }
        .overlay-title { font-size: 24px; color: #a29bfe; margin-bottom: 10px; }
        .overlay-text { font-size: 40px; color: #ff9a9e; font-weight: bold; margin-bottom: 20px; text-shadow: 2px 2px 0 #fff; }
        
        /* æ¥é¾™å›¾ç‰‡é¢„è§ˆåŒº */
        .relay-img-preview { max-width: 80%; max-height: 50%; border: 4px solid #333; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* èŠå¤©åŒº */
        .chat-area { position: absolute; bottom: 10px; right: 10px; width: 200px; height: 150px; background: rgba(255,255,255,0.8); border-radius: 15px; border: 2px solid #fff; display: flex; flex-direction: column; overflow: hidden; pointer-events: none; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 5px; font-size: 12px; pointer-events: auto; }
        .chat-msg { margin-bottom: 2px; }
        .chat-msg.sys { color: #a29bfe; font-style: italic; }
        .chat-input-box { display: flex; padding: 5px; background: #fff; pointer-events: auto; }
        .chat-ipt { flex: 1; border: 1px solid #ddd; border-radius: 5px; padding: 3px; outline: none; }

        /* å·¥å…·æ  */
        .tools-bar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: #fff; padding: 10px; border-radius: 50px; display: none; gap: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 50; }
        .color-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; }
        .color-btn.active { transform: scale(1.2); border-color: #555; }
        
        /* å¼¹çª— */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-box { background: #fff; padding: 30px; border-radius: 30px; width: 90%; max-width: 400px; text-align: center; border: 4px solid #ffb7c5; }
        .btn { padding: 10px 20px; border-radius: 20px; border: none; font-size: 14px; color: white; cursor: pointer; margin: 5px; font-family: inherit; }
        .btn-pink { background: #ff9a9e; }
        .btn-blue { background: #74b9ff; }
        .ipt { width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #ddd; margin-bottom: 10px; text-align: center; }

        /* ç»“æœå±•ç¤º */
        .result-scroll { max-height: 60vh; overflow-y: auto; width: 100%; text-align: left; }
        .result-item { border-bottom: 1px dashed #ddd; padding: 10px; }
        .result-img { max-width: 100px; border: 1px solid #ccc; vertical-align: middle; }
    </style>
</head>
<body>

    <div class="top-bar">
        <a href="game_loppy.html" class="back-btn">ğŸ”™</a>
        <div class="game-info" id="statusText">ç­‰å¾…å¼€å§‹...</div>
        <div></div>
    </div>

    <div class="main-area">
        <div class="sidebar" id="playerList"></div>

        <div class="canvas-container">
            <canvas id="gameCanvas"></canvas>

            <div class="overlay" id="gameOverlay">
                <div class="overlay-title" id="overlayTitle">å‡†å¤‡</div>
                
                <div id="wordDisplay" style="display:none;">
                    <div class="overlay-text" id="wordText">é¢˜ç›®</div>
                    <button class="btn btn-pink" onclick="startDrawing()">ğŸ–Œï¸ å¼€å§‹ç”»</button>
                    <button class="btn btn-blue" onclick="changeWord()">ğŸ”„ æ¢ä¸€é¢˜</button>
                </div>

                <div id="imgDisplay" style="display:none; flex-direction:column; align-items:center;">
                    <img id="relayImg" class="relay-img-preview" src="">
                    <input type="text" class="ipt" id="relayGuessInput" placeholder="ä½ è§‰å¾—è¿™æ˜¯ä»€ä¹ˆï¼Ÿ">
                    <button class="btn btn-pink" onclick="submitRelayGuess()">âœ… æäº¤çŒœæµ‹</button>
                </div>

                <div id="waitDisplay" style="display:none;">
                    <div class="overlay-text" style="font-size:20px; color:#aaa;">ç­‰å¾…å…¶ä»–äºº...</div>
                </div>

                <div id="hostControls" style="display:none; flex-direction:column; gap:10px;">
                    <div style="font-size:12px; color:#888;">è¯·é€‰æ‹©æ¨¡å¼ï¼š</div>
                    <button class="btn btn-blue" onclick="startClassic()">ğŸ¨ ç«é€ŸçŒœç”» (ä¸€äººç”»å¤§å®¶çŒœ)</button>
                    <button class="btn btn-pink" onclick="startRelay()">ğŸ§© çµé­‚æ¥é¾™ (ç”»->çŒœ->ç”»->çŒœ)</button>
                </div>

                <div id="resultDisplay" style="display:none; width:100%;">
                    <div class="result-scroll" id="resultList"></div>
                    <button class="btn btn-pink" onclick="document.getElementById('resultDisplay').style.display='none'; if(isHost) document.getElementById('hostControls').style.display='flex';">ğŸ”™ä»¥æ­¤ç±»æ¨ä¸‹ä¸€ä½</button>
                </div>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-msgs" id="chatList"></div>
            <div class="chat-input-box" id="chatInputArea">
                <input type="text" class="ipt chat-ipt" id="chatInput" placeholder="èŠå¤©/ç«é€ŸçŒœé¢˜..." onkeydown="if(event.keyCode==13) sendChat()">
            </div>
        </div>
    </div>

    <div class="tools-bar" id="toolBar">
        <div class="color-btn" style="background:#000" onclick="setColor('#000')"></div>
        <div class="color-btn" style="background:#ff7675" onclick="setColor('#ff7675')"></div>
        <div class="color-btn" style="background:#fdcb6e" onclick="setColor('#fdcb6e')"></div>
        <div class="color-btn" style="background:#55efc4" onclick="setColor('#55efc4')"></div>
        <div class="color-btn" style="background:#74b9ff" onclick="setColor('#74b9ff')"></div>
        <button class="btn" style="padding:5px 10px; background:#ddd; color:#555;" onclick="clearCanvas()">ğŸ—‘ï¸</button>
        <button class="btn btn-blue" onclick="finishDrawing()">âœ… ç”»å¥½äº†</button>
    </div>

    <div class="modal" id="loginModal">
        <div class="modal-box">
            <h2 style="color:#ff9a9e;">ğŸ¨ çµé­‚ç”»æ‰‹</h2>
            <input type="text" class="ipt" id="myName" placeholder="ä½ çš„åå­—">
            <div id="lobbyBtns">
                <button class="btn btn-pink" onclick="createRoom()">ğŸ‘‘ æˆ‘æ˜¯æˆ¿ä¸»</button>
                <div style="margin:5px; color:#ccc;">- æˆ– -</div>
                <input type="text" class="ipt" id="hostIdInput" placeholder="æˆ¿ä¸»ID">
                <button class="btn btn-blue" onclick="joinRoom()">ğŸš€ åŠ å…¥æˆ¿é—´</button>
            </div>
            <div id="hostWait" style="display:none;">
                <p>æˆ¿å·: <span id="myRoomId" style="color:#ff6b81; font-weight:bold; cursor:pointer;" onclick="copyId()">...</span></p>
                <p>äººæ•°: <span id="waitCount">1</span></p>
                <button class="btn btn-pink" onclick="enterGame()">è¿›å…¥å¤§å…</button>
            </div>
        </div>
    </div>

    <script>
        // ================= é…ç½® =================
        const AI_WORDS = ["è‹¹æœ", "å¥¥ç‰¹æ›¼", "é©¬æ¡¶", "æµ·ç»µå®å®", "çç å¥¶èŒ¶", "æ”¾å±", "ç§ƒå¤´", "æ¯”åŸºå°¼", "åˆå»", "å£å’š", "å…¬ä¸»æŠ±", "é»‘ä¸", "å¥³ä»†è£…", "çš®é­"];
        
        let peer = null, connList = [], hostConn = null;
        let myId = null, myName = "", isHost = false;
        let players = []; // {id, name, score}
        
        // æ¸¸æˆçŠ¶æ€
        let mode = ''; // 'classic' or 'relay'
        let currentDrawer = null;
        let currentWord = '';
        
        // æ¥é¾™ä¸“ç”¨çŠ¶æ€
        let relayQueue = []; // æ¥é¾™é¡ºåº [p1, p2, p3...]
        let relayStep = 0;   // å½“å‰ç¬¬å‡ æ£’
        let relayHistory = []; // è®°å½•å…¨è¿‡ç¨‹ {player, type, content}
        let relayStarterIndex = 0; // è®°å½•è°æ˜¯ç¬¬ä¸€æ£’ï¼Œç”¨äºâ€œä»¥æ­¤ç±»æ¨â€

        let canvas, ctx, isDrawing = false;

        window.onload = () => {
            const saved = localStorage.getItem('draw_name');
            if(saved) document.getElementById('myName').value = saved;
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            initCanvasEvents();
        };

        function resizeCanvas() { canvas.width = canvas.parentElement.clientWidth; canvas.height = canvas.parentElement.clientHeight; }

        // ================= 1. è”æœº =================
        try {
            peer = new Peer(null, { debug: 2 });
            peer.on('open', id => myId = id);
        } catch(e) {}

        function createRoom() {
            myName = document.getElementById('myName').value || "æˆ¿ä¸»";
            localStorage.setItem('draw_name', myName);
            isHost = true;
            players = [{ id: myId, name: myName, score: 0 }];
            document.getElementById('lobbyBtns').style.display = 'none';
            document.getElementById('hostWait').style.display = 'block';
            document.getElementById('myRoomId').innerText = myId;
            
            peer.on('connection', conn => {
                connList.push(conn);
                conn.on('open', () => conn.send({ type: 'WELCOME', players: players }));
                conn.on('data', data => handleData(data, conn));
                conn.on('close', () => {
                    players = players.filter(p => p.id !== conn.peer);
                    broadcast({ type: 'UPDATE_PLAYERS', players: players });
                });
            });
        }

        function joinRoom() {
            myName = document.getElementById('myName').value || "ç©å®¶";
            localStorage.setItem('draw_name', myName);
            const hostId = document.getElementById('hostIdInput').value.trim();
            if(!hostId) return alert('è¯·è¾“å…¥æˆ¿å·');
            hostConn = peer.connect(hostId, { metadata: { name: myName } });
            hostConn.on('open', () => {
                document.getElementById('loginModal').style.display = 'none';
                showOverlay('wait', 'ç­‰å¾…æˆ¿ä¸»å¼€å§‹...');
            });
            hostConn.on('data', data => handleData(data));
        }

        function enterGame() {
            broadcast({ type: 'ENTER_GAME' });
            showOverlay('host', 'è¯·é€‰æ‹©æ¨¡å¼');
            document.getElementById('loginModal').style.display = 'none';
        }

        // ================= 2. æ¶ˆæ¯å¤„ç† =================
        function handleData(data, conn) {
            if (isHost) {
                // æˆ¿ä¸»é€»è¾‘
                if (data.type === 'LOGIN') {
                    players.push({ id: conn.peer, name: data.name, score: 0 });
                    document.getElementById('waitCount').innerText = players.length;
                    broadcast({ type: 'UPDATE_PLAYERS', players: players });
                }
                else if (data.type === 'DRAW_DATA') { broadcast(data); drawLine(data); }
                else if (data.type === 'CLEAR') { broadcast(data); ctx.clearRect(0,0,canvas.width,canvas.height); }
                
                // ç«é€ŸçŒœé¢˜é€»è¾‘
                else if (data.type === 'GUESS_CLASSIC') {
                    if (mode === 'classic' && data.content === currentWord) {
                        broadcast({ type: 'WINNER', name: data.name, answer: currentWord });
                        setTimeout(nextRoundClassic, 3000);
                    } else {
                        broadcast({ type: 'CHAT', name: data.name, content: data.content });
                    }
                }
                
                // æ¥é¾™æäº¤é€»è¾‘
                else if (data.type === 'RELAY_SUBMIT') {
                    handleRelayStep(data);
                }
            }

            // é€šç”¨é€»è¾‘
            if (data.type === 'WELCOME') { hostConn.send({ type: 'LOGIN', name: myName }); }
            else if (data.type === 'UPDATE_PLAYERS') { players = data.players; renderPlayers(); }
            else if (data.type === 'ENTER_GAME') { 
                document.getElementById('loginModal').style.display = 'none'; 
                if(!isHost) showOverlay('wait', 'ç­‰å¾…æˆ¿ä¸»é€‰æ‹©æ¨¡å¼...');
            }
            else if (data.type === 'DRAW_DATA') { drawLine(data); }
            else if (data.type === 'CLEAR') { ctx.clearRect(0,0,canvas.width,canvas.height); }
            else if (data.type === 'CHAT') { addLog(data.name, data.content); }
            
            // æ¸¸æˆæŒ‡ä»¤
            else if (data.type === 'START_CLASSIC') { startRoundUI(data); }
            else if (data.type === 'WINNER') { addLog('ç³»ç»Ÿ', `ğŸ‰ ${data.name} çŒœå¯¹äº†ï¼š${data.answer}!`, 'sys'); }
            
            // æ¥é¾™æŒ‡ä»¤
            else if (data.type === 'RELAY_YOUR_TURN') { startRelayTurnUI(data); }
            else if (data.type === 'RELAY_WAIT') { showOverlay('wait', `æ­£åœ¨ç”± ${data.name} è¿›è¡Œ ${data.act}...`); }
            else if (data.type === 'RELAY_GAMEOVER') { showRelayResult(data.history); }
        }

        function broadcast(msg) {
            if (isHost) {
                if(msg.type !== 'DRAW_DATA') handleData(msg); 
                connList.forEach(c => c.send(msg));
            } else { hostConn.send(msg); }
        }

        // ================= 3. ç«é€Ÿæ¨¡å¼ (Classic) =================
        function startClassic() {
            mode = 'classic';
            nextRoundClassic();
        }

        function nextRoundClassic() {
            const drawer = players[Math.floor(Math.random() * players.length)];
            currentDrawer = drawer.id;
            currentWord = AI_WORDS[Math.floor(Math.random() * AI_WORDS.length)];
            broadcast({ type: 'START_CLASSIC', drawer: drawer.id, name: drawer.name, word: currentWord });
        }

        function startRoundUI(data) {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            renderPlayers();
            document.getElementById('statusText').innerText = `ç”»æ‰‹ï¼š${data.name}`;
            
            if (myId === data.drawer) {
                showOverlay('word', data.word);
                // æˆ‘æ˜¯ç”»æ‰‹ï¼Œä¸èƒ½è¾“å…¥
                document.getElementById('chatInputArea').style.display = 'none';
            } else {
                showOverlay('none'); // çŒœé¢˜è€…çœ‹ç”»å¸ƒ
                document.getElementById('toolBar').style.display = 'none';
                document.getElementById('chatInputArea').style.display = 'flex';
            }
        }

        // ================= 4. çµé­‚æ¥é¾™ (Relay) æ ¸å¿ƒé€»è¾‘ =================
        
        // æˆ¿ä¸»ç‚¹å‡»â€œå¼€å§‹æ¥é¾™â€
        function startRelay() {
            mode = 'relay';
            // æ ¹æ® relayStarterIndex å†³å®šé¡ºåº
            // ä¾‹å¦‚ [A, B, C]ï¼Œç¬¬ä¸€è½® Aå¼€å¤´ã€‚ç¬¬äºŒè½® Bå¼€å¤´ -> [B, C, A]
            let p = [...players];
            // è½®è½¬æ•°ç»„
            for(let i=0; i<relayStarterIndex; i++) p.push(p.shift());
            
            relayQueue = p;
            relayStep = 0;
            relayHistory = [];
            
            // ç¬¬ä¸€æ­¥ï¼šé€‰è¯
            currentWord = AI_WORDS[Math.floor(Math.random() * AI_WORDS.length)];
            
            // è®°å½•åˆå§‹è¯
            relayHistory.push({ type: 'word', content: currentWord, name: 'ç³»ç»Ÿ' });

            // è§¦å‘ç¬¬ä¸€ä¸ªäººç”»ç”»
            triggerRelayStep();
            
            // å‡†å¤‡ä¸‹ä¸€æ¬¡èµ·å§‹äºº
            relayStarterIndex = (relayStarterIndex + 1) % players.length;
        }

        function triggerRelayStep() {
            // æ£€æŸ¥æ˜¯å¦ç»“æŸ
            if (relayStep >= relayQueue.length) {
                broadcast({ type: 'RELAY_GAMEOVER', history: relayHistory });
                return;
            }

            const p = relayQueue[relayStep];
            const isDrawingTurn = (relayStep % 2 === 0); // å¶æ•°æ­¥ç”»ï¼Œå¥‡æ•°æ­¥çŒœ
            const lastContent = relayHistory[relayHistory.length - 1].content;

            // é€šçŸ¥è¿™ä¸ªäººæ“ä½œï¼Œå…¶ä»–äººç­‰å¾…
            connList.forEach(c => {
                if (c.peer === p.id) {
                    c.send({ type: 'RELAY_YOUR_TURN', act: isDrawingTurn?'draw':'guess', content: lastContent });
                } else {
                    c.send({ type: 'RELAY_WAIT', name: p.name, act: isDrawingTurn?'ç”»ç”»':'çŒœé¢˜' });
                }
            });
            // å¦‚æœæˆ¿ä¸»è‡ªå·±æ˜¯è¿™ä¸ªäºº
            if (myId === p.id) {
                handleData({ type: 'RELAY_YOUR_TURN', act: isDrawingTurn?'draw':'guess', content: lastContent });
            } else {
                handleData({ type: 'RELAY_WAIT', name: p.name, act: isDrawingTurn?'ç”»ç”»':'çŒœé¢˜' });
            }
        }

        function startRelayTurnUI(data) {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            document.getElementById('statusText').innerText = "è½®åˆ°ä½ äº†ï¼";

            if (data.act === 'draw') {
                // è½®åˆ°æˆ‘ç”»ï¼šå†…å®¹æ˜¯æ–‡å­—
                showOverlay('word', data.content);
            } else {
                // è½®åˆ°æˆ‘çŒœï¼šå†…å®¹æ˜¯å›¾ç‰‡URL
                showOverlay('guess_img', data.content);
            }
        }

        // æäº¤æ¥é¾™ç»“æœ (ç”»å®Œ/çŒœå®Œ)
        function handleRelayStep(data) {
            // data: { content: "å›¾ç‰‡URL" æˆ– "æ–‡å­—" }
            const p = relayQueue[relayStep];
            const type = (relayStep % 2 === 0) ? 'img' : 'text';
            
            relayHistory.push({ name: p.name, type: type, content: data.content });
            relayStep++;
            triggerRelayStep(); // ä¸‹ä¸€æ­¥
        }

        // ================= 5. æ“ä½œäº¤äº’ =================
        
        // ç”»æ‰‹ç‚¹å‡»â€œå¼€å§‹ç”»â€
        function startDrawing() {
            hideOverlay();
            document.getElementById('toolBar').style.display = 'flex';
        }

        // ç”»æ‰‹ç‚¹å‡»â€œæ¢ä¸€é¢˜â€
        function changeWord() {
            if(mode === 'classic') {
                if(isHost) {
                    currentWord = AI_WORDS[Math.floor(Math.random() * AI_WORDS.length)];
                    broadcast({ type: 'START_CLASSIC', drawer: myId, name: myName, word: currentWord });
                } else {
                    alert('åªæœ‰æˆ¿ä¸»èƒ½æ¢é¢˜(å·æ‡’æ²¡å†™)');
                }
            } else {
                // æ¥é¾™æ¨¡å¼æ¢é¢˜ (ä»…é™ç¬¬ä¸€æ£’)
                if(relayStep === 0) {
                    currentWord = AI_WORDS[Math.floor(Math.random() * AI_WORDS.length)];
                    // æ›´æ–°å†å²ç¬¬ä¸€æ¡
                    relayHistory[0].content = currentWord;
                    // åˆ·æ–°UI
                    document.getElementById('wordText').innerText = currentWord;
                }
            }
        }

        // ç”»æ‰‹ç‚¹å‡»â€œç”»å¥½äº†â€
        function finishDrawing() {
            if (mode === 'classic') {
                alert('ç«é€Ÿæ¨¡å¼ä¸éœ€è¦ç‚¹è¿™ä¸ªï¼Œç­‰ä»–ä»¬çŒœå¯¹å°±è¡Œï¼');
            } else {
                // æ¥é¾™æ¨¡å¼ï¼šæäº¤ç”»ä½œ
                const imgData = canvas.toDataURL();
                const msg = { type: 'RELAY_SUBMIT', content: imgData };
                if(isHost) handleRelayStep(msg); else hostConn.send(msg);
            }
        }

        // çŒœé¢˜è€…æäº¤çŒœæµ‹ (æ¥é¾™)
        function submitRelayGuess() {
            const val = document.getElementById('relayGuessInput').value.trim();
            if(!val) return;
            const msg = { type: 'RELAY_SUBMIT', content: val };
            if(isHost) handleRelayStep(msg); else hostConn.send(msg);
        }

        // ç«é€Ÿæ¨¡å¼èŠå¤©æ¡†å›è½¦
        function sendChat() {
            const val = document.getElementById('chatInput').value.trim();
            if(!val) return;
            const msg = { type: 'GUESS_CLASSIC', name: myName, content: val };
            if(isHost) handleData(msg); else hostConn.send(msg);
            document.getElementById('chatInput').value = '';
        }

        // ================= 6. è¾…åŠ©å‡½æ•° =================
        function showOverlay(type, data) {
            document.querySelectorAll('.overlay > div').forEach(d => d.style.display='none');
            document.getElementById('gameOverlay').style.display = 'flex';
            
            if(type === 'word') {
                document.getElementById('wordDisplay').style.display = 'block';
                document.getElementById('wordText').innerText = data;
                document.getElementById('overlayTitle').innerText = "ä½ è¦ç”»çš„æ˜¯ï¼š";
            } else if (type === 'guess_img') {
                document.getElementById('imgDisplay').style.display = 'flex';
                document.getElementById('relayImg').src = data;
                document.getElementById('relayGuessInput').value = '';
                document.getElementById('overlayTitle').innerText = "ä¸Šä¸€æ£’ç”»äº†å•¥ï¼Ÿ";
            } else if (type === 'wait') {
                document.getElementById('waitDisplay').style.display = 'block';
                document.querySelector('#waitDisplay .overlay-text').innerText = data;
            } else if (type === 'host') {
                document.getElementById('hostControls').style.display = 'flex';
                document.getElementById('overlayTitle').innerText = "æˆ¿ä¸»æ§åˆ¶å°";
            } else if (type === 'none') {
                document.getElementById('gameOverlay').style.display = 'none';
            }
        }

        function hideOverlay() { document.getElementById('gameOverlay').style.display = 'none'; }

        function showRelayResult(history) {
            const list = document.getElementById('resultList');
            list.innerHTML = '';
            
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'result-item';
                if (item.type === 'word' || item.type === 'text') {
                    div.innerHTML = `<b>${item.name}</b>: <span style="font-size:20px; color:#ff9a9e;">${item.content}</span>`;
                } else {
                    div.innerHTML = `<b>${item.name}</b> ç”»äº†:<br><img src="${item.content}" class="result-img">`;
                }
                list.appendChild(div);
            });

            document.getElementById('gameOverlay').style.display = 'flex';
            document.getElementById('resultDisplay').style.display = 'block';
            document.getElementById('overlayTitle').innerText = "çµé­‚ç”»ä½œå¤§èµ";
        }

        // ç”»æ¿ä¸å·¥å…·
        let currentColor = '#000';
        let lastX, lastY;
        function initCanvasEvents() {
            canvas.onmousedown = e => { isDrawing=true; lastX=e.offsetX; lastY=e.offsetY; };
            canvas.onmousemove = e => { if(isDrawing) sendDraw(e.offsetX, e.offsetY); };
            canvas.onmouseup = () => isDrawing=false;
            
            canvas.ontouchstart = e => { e.preventDefault(); const r=canvas.getBoundingClientRect(); isDrawing=true; lastX=e.touches[0].clientX-r.left; lastY=e.touches[0].clientY-r.top; };
            canvas.ontouchmove = e => { e.preventDefault(); if(isDrawing) { const r=canvas.getBoundingClientRect(); sendDraw(e.touches[0].clientX-r.left, e.touches[0].clientY-r.top); } };
            canvas.ontouchend = () => isDrawing=false;
        }
        function sendDraw(x, y) {
            const w = canvas.width, h = canvas.height;
            const data = { type:'DRAW_DATA', x1:lastX/w, y1:lastY/h, x2:x/w, y2:y/h, color:currentColor };
            drawLine(data);
            if(isHost) broadcast(data); else hostConn.send(data);
            lastX = x; lastY = y;
        }
        function drawLine(d) {
            const w = canvas.width, h = canvas.height;
            ctx.beginPath();
            ctx.moveTo(d.x1*w, d.y1*h); ctx.lineTo(d.x2*w, d.y2*h);
            ctx.strokeStyle = d.color; ctx.lineWidth = d.color==='#fff'?20:3; ctx.lineCap='round'; ctx.stroke();
        }
        function setColor(c) { currentColor = c; }
        function clearCanvas() { 
            ctx.clearRect(0,0,canvas.width,canvas.height);
            if(isHost) broadcast({type:'CLEAR'}); else hostConn.send({type:'CLEAR'});
        }

        function renderPlayers() {
            const div = document.getElementById('playerList');
            div.innerHTML = '';
            players.forEach(p => {
                const card = document.createElement('div');
                card.className = `player-card ${p.id===currentDrawer?'active':''}`;
                card.innerHTML = `<div style="font-size:20px;">ğŸ§¸</div><div class="p-name">${p.name}</div><div class="p-score">${p.score}</div>`;
                div.appendChild(card);
            });
        }
        function addLog(n, t, c='') {
            const box = document.getElementById('chatList');
            box.innerHTML += `<div class="chat-msg ${c}">${n}: ${t}</div>`;
            box.scrollTop = box.scrollHeight;
        }
        function copyId() { navigator.clipboard.writeText(myId).then(()=>alert('æˆ¿å·å·²å¤åˆ¶')); }
    </script>
</body>
</html>
