<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ¨ Loppy çµé­‚ç”»æ‰‹ (AIç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <style>
        @font-face { font-family: 'MyCutieFont'; src: url('https://files.catbox.moe/cweam3.ttf') format('truetype'); font-display: swap; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'MyCutieFont', sans-serif;
            background: linear-gradient(135deg, #fff1eb 0%, #ace0f9 100%);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* é¡¶éƒ¨ */
        .top-bar {
            padding: 10px; background: rgba(255,255,255,0.8); display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px dashed #ff9a9e; z-index: 100;
        }
        .back-btn { text-decoration: none; font-size: 20px; cursor: pointer; }
        .game-info { font-size: 16px; color: #ff6b81; font-weight: bold; }
        .timer { font-size: 20px; color: #a29bfe; font-weight: bold; }

        /* ä¸»åŒºåŸŸ */
        .main-area { flex: 1; display: flex; position: relative; overflow: hidden; }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 80px; background: rgba(255,255,255,0.5); border-right: 2px dashed #fff;
            overflow-y: auto; padding: 5px; display: flex; flex-direction: column; gap: 5px;
        }
        .player-card {
            background: #fff; border-radius: 10px; padding: 5px; text-align: center; border: 2px solid #fff;
            transition: 0.3s;
        }
        .player-card.active { border-color: #ff9a9e; transform: scale(1.05); }
        .player-card.drawer { border-color: #a29bfe; background: #f3e5f5; }
        .p-avatar { font-size: 24px; }
        .p-name { font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .p-score { font-size: 12px; color: #ff7675; font-weight: bold; }

        /* ç”»æ¿ */
        .canvas-container {
            flex: 1; position: relative; background: #fff; margin: 10px; border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 4px solid #a29bfe;
            display: flex; justify-content: center; align-items: center; cursor: crosshair;
        }
        canvas { touch-action: none; width: 100%; height: 100%; border-radius: 15px; }
        
        /* é®ç½© & é¢˜åº“é€‰æ‹© */
        .word-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 20;
            display: none; 
        }
        .word-text { font-size: 40px; color: #ff9a9e; margin-bottom: 20px; text-align: center; text-shadow: 2px 2px 0 #fff;}
        
        .mode-select-box {
            display: flex; flex-direction: column; gap: 15px; width: 80%; max-width: 300px;
        }
        .mode-title { font-size: 18px; color: #888; margin-bottom: 5px; }
        
        /* èŠå¤© */
        .chat-area {
            position: absolute; bottom: 10px; right: 10px; width: 200px; height: 150px;
            background: rgba(255,255,255,0.8); border-radius: 15px; border: 2px solid #fff;
            display: flex; flex-direction: column; overflow: hidden; pointer-events: none;
        }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 5px; font-size: 12px; pointer-events: auto;}
        .chat-msg { margin-bottom: 2px; }
        .chat-msg.correct { color: #00b894; font-weight: bold; background: #e0f2f1; padding: 2px; border-radius: 4px;}
        .chat-msg.sys { color: #a29bfe; font-style: italic; }
        .chat-input-box { display: flex; padding: 5px; background: #fff; pointer-events: auto; }
        .chat-ipt { flex: 1; border: 1px solid #ddd; border-radius: 5px; padding: 3px; outline: none; }

        /* å·¥å…·æ  */
        .tools-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #fff; padding: 10px; border-radius: 50px; display: none; gap: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 50;
        }
        .color-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; }
        .color-btn.active { transform: scale(1.2); border-color: #555; }
        .tool-btn { font-size: 20px; cursor: pointer; padding: 0 10px; }

        /* å¼¹çª— */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #fff; padding: 30px; border-radius: 30px; width: 90%; max-width: 400px;
            text-align: center; border: 4px solid #ffb7c5; position: relative;
        }
        .btn {
            padding: 12px 25px; border-radius: 20px; border: none; font-size: 16px;
            color: white; cursor: pointer; margin-top: 10px; width: 100%; font-family: inherit;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-pink { background: linear-gradient(45deg, #ff9a9e, #fad0c4); }
        .btn-blue { background: linear-gradient(45deg, #a18cd1, #fbc2eb); }
        .btn-spicy { background: linear-gradient(45deg, #ff758c, #ff7eb3); border: 2px solid #fff; box-shadow: 0 4px 10px rgba(255, 117, 140, 0.4); }
        .btn-pure { background: linear-gradient(45deg, #84fab0, #8fd3f4); color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        
        .ipt { width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #ddd; margin-bottom: 10px; text-align: center; }

    </style>
</head>
<body>

    <div class="top-bar">
        <a href="game_loppy.html" class="back-btn">ğŸ”™</a>
        <div class="game-info" id="statusText">ç­‰å¾…å¼€å§‹...</div>
        <div class="timer" id="timerDisplay"></div>
    </div>

    <div class="main-area">
        <div class="sidebar" id="playerList"></div>

        <div class="canvas-container" id="canvasBox">
            <canvas id="gameCanvas"></canvas>
            
            <div class="word-overlay" id="wordOverlay">
                <div class="word-text" id="overlayText">ç­‰å¾…æˆ¿ä¸»é€‰æ‹©...</div>
                
                <div id="hostControls" style="display:none;" class="mode-select-box">
                    <div class="mode-title">âœ¨ è¯·é€‰æ‹© AI å‡ºé¢˜é£æ ¼ âœ¨</div>
                    <button class="btn btn-blue" onclick="startGame('normal')">ğŸŒˆ æ™®é€šç‰ˆ (æ—¥å¸¸å¿«ä¹)</button>
                    <button class="btn btn-pure" onclick="startGame('pure')">ğŸŒ¸ çº¯æƒ…ç‰ˆ (ç”œç”œæ‹çˆ±)</button>
                    <button class="btn btn-spicy" onclick="startGame('spicy')">ğŸ’‹ åˆºæ¿€ç‰ˆ (è„¸çº¢å¿ƒè·³)</button>
                </div>
                
                <div id="drawerControls" style="display:none;">
                    <button class="btn btn-pink" onclick="startDrawing()">ğŸ–Œï¸ å¼€å§‹ä½œç”»</button>
                    <button class="btn btn-blue" onclick="skipWord()" style="margin-top:10px; background:#ccc;">ğŸ”„ æ¢ä¸€ä¸ªè¯</button>
                </div>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-msgs" id="chatList"></div>
            <div class="chat-input-box" id="guessInputArea">
                <input type="text" class="ipt chat-ipt" id="guessInput" placeholder="è¾“å…¥ç­”æ¡ˆ..." onkeydown="if(event.keyCode==13) sendGuess()">
            </div>
        </div>
    </div>

    <div class="tools-bar" id="toolBar">
        <div class="color-btn" style="background:#000" onclick="setColor('#000000')"></div>
        <div class="color-btn" style="background:#ff7675" onclick="setColor('#ff7675')"></div>
        <div class="color-btn" style="background:#fdcb6e" onclick="setColor('#fdcb6e')"></div>
        <div class="color-btn" style="background:#55efc4" onclick="setColor('#55efc4')"></div>
        <div class="color-btn" style="background:#74b9ff" onclick="setColor('#74b9ff')"></div>
        <div class="tool-btn" onclick="setColor('#ffffff')" title="æ©¡çš®æ“¦">ğŸ§½</div>
        <div class="tool-btn" onclick="clearCanvas(true)" title="æ¸…ç©º">ğŸ—‘ï¸</div>
    </div>

    <div class="modal" id="loginModal">
        <div class="modal-box">
            <h2 style="color:#ff9a9e; margin-bottom:15px;">ğŸ¨ çµé­‚ç”»æ‰‹</h2>
            <input type="text" class="ipt" id="myName" placeholder="ä½ çš„åå­—">
            
            <div id="lobbyBtns">
                <button class="btn btn-pink" onclick="createRoom()">ğŸ‘‘ æˆ‘æ˜¯æˆ¿ä¸» (å»ºæˆ¿)</button>
                <div style="margin:10px; color:#aaa;">- æˆ– -</div>
                <input type="text" class="ipt" id="hostIdInput" placeholder="è¾“å…¥æˆ¿å·">
                <button class="btn btn-blue" onclick="joinRoom()">ğŸš€ åŠ å…¥æˆ¿é—´</button>
            </div>

            <div id="hostWait" style="display:none;">
                <p>æˆ¿å·: <span id="myRoomId" style="color:#ff6b81; font-weight:bold; user-select:all;" onclick="copyId()">...</span></p>
                <p style="font-size:12px; color:#888;">(æœ€å°‘3äºº)</p>
                <p>å½“å‰äººæ•°: <span id="waitCount">1</span></p>
                <button class="btn btn-pink" onclick="enterGame()">è¿›å…¥æ¸¸æˆå¤§å…</button>
            </div>
        </div>
    </div>

    <script>
        // ================= ğŸ”¥ AI è¯åº“é…ç½® ğŸ”¥ =================
        // ä½ å¯ä»¥åœ¨è¿™é‡Œè‡ªå·±åŠ è¯ï¼è¶Šå¤šè¶Šå¥½ç©ï¼
        const AI_WORDS = {
            // ğŸŒˆ æ™®é€šç‰ˆï¼šæ—¥å¸¸ã€æç¬‘ã€ç‰©å“
            normal: [
                "è‹¹æœ", "å¥¥ç‰¹æ›¼", "é©¬æ¡¶", "ç”µè„‘", "æµ·ç»µå®å®", "çç å¥¶èŒ¶", "æ³•æ‹‰åˆ©", "çš®å¡ä¸˜", "ç«é”…", 
                "æ”¾å±", "ç§ƒå¤´", "æ–¹ä¾¿é¢", "äºŒç»´ç ", "å°çŒªä½©å¥‡", "ä»™äººæŒ", "æ¯”åŸºå°¼", "å“¥æ–¯æ‹‰", "æŒ–æ˜æœº",
                "WiFi", "å£ç½©", "è‡ªæ‹", "è¾£æ¡", "ä½œä¸š", "ç§æˆ¿é’±", "è‚Œè‚‰ç”·", "å¹¿åœºèˆ"
            ],
            
            // ğŸŒ¸ çº¯æƒ…ç‰ˆï¼šæ‹çˆ±ã€æµªæ¼«ã€å°‘å¥³å¿ƒ
            pure: [
                "åˆå»", "æƒ…ä¹¦", "å£å’š", "æ‘¸å¤´æ€", "å©šç¤¼", "å…¬ä¸»æŠ±", "çœ‹æ˜Ÿæ˜Ÿ", "æ‘©å¤©è½®", "çº¢çº¿", 
                "ä¸€è§é’Ÿæƒ…", "ç”·æœ‹å‹", "åƒé†‹", "æ’’å¨‡", "å‘Šç™½æ°”çƒ", "æœ€èŒèº«é«˜å·®", "çƒ›å…‰æ™šé¤", 
                "æ¯”å¿ƒ", "å®šæƒ…ä¿¡ç‰©", "è‰è“å°", "å›´å·¾", "å·å·çœ‹ä½ ", "æ—©å®‰å»"
            ],
            
            // ğŸ’‹ åˆºæ¿€ç‰ˆ (Loppyç‰¹ä¾›)ï¼šç¨å¾®å¸¦ç‚¹é¢œè‰²ä½†ä¸è¿‡åˆ†ï¼Œé€‚åˆå¯†å‹
            spicy: [
                "é”éª¨", "é»‘ä¸", "å’¬è€³æœµ", "å¥³ä»†è£…", "çš®é­", "æ¹¿èº«", "æ†ç»‘", "ç§è‰è“", "å¤§é•¿è…¿", 
                "æµ´å®¤", "é’¢ç®¡èˆ", "çƒˆç„°çº¢å”‡", "éœ¸é“æ€»è£", "æ·±V", "ç»å¯¹é¢†åŸŸ", "æ‰‹é“", "å°é‡çŒ«", 
                "è…¹è‚Œ", "åšåäº‹", "å·æƒ…", "è†æ•", "æ’•ä¸è¢œ", "æµ´å®¤play" 
            ]
        };

        // ================= æ¸¸æˆå˜é‡ =================
        let peer = null, connList = [], hostConn = null;
        let myId = null, myName = "";
        let isHost = false;
        let players = []; 
        
        let currentCategory = 'normal'; // å½“å‰é€‰çš„é¢˜åº“
        let currentWord = '';
        let drawerId = null;
        let isDrawing = false;
        let ctx = null, canvas = null;
        let hasGuessedRight = false; // æœ¬è½®æ˜¯å¦çŒœå¯¹è¿‡

        window.onload = () => {
            const savedName = localStorage.getItem('draw_name');
            if(savedName) document.getElementById('myName').value = savedName;
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            initCanvasEvents();
        };

        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }

        // ================= 1. è”æœº =================
        try {
            peer = new Peer(null, { debug: 2 });
            peer.on('open', id => myId = id);
            peer.on('error', err => alert('è”æœºé”™è¯¯:' + err.type));
        } catch(e) { alert('ç»„ä»¶åŠ è½½å¤±è´¥'); }

        function createRoom() {
            myName = document.getElementById('myName').value.trim() || "æˆ¿ä¸»";
            localStorage.setItem('draw_name', myName);
            isHost = true;
            players = [{ id: myId, name: myName, score: 0 }];
            
            document.getElementById('lobbyBtns').style.display = 'none';
            document.getElementById('hostWait').style.display = 'block';
            document.getElementById('myRoomId').innerText = myId;

            peer.on('connection', conn => {
                connList.push(conn);
                conn.on('open', () => conn.send({ type: 'WELCOME', players: players }));
                conn.on('data', data => handleData(data, conn));
                conn.on('close', () => {
                    players = players.filter(p => p.id !== conn.peer);
                    broadcast({ type: 'UPDATE_PLAYERS', players: players });
                });
            });
        }

        function joinRoom() {
            myName = document.getElementById('myName').value.trim() || "ç©å®¶";
            localStorage.setItem('draw_name', myName);
            const hostId = document.getElementById('hostIdInput').value.trim();
            if(!hostId) return alert('è¯·è¾“å…¥æˆ¿å·');

            hostConn = peer.connect(hostId, { metadata: { name: myName } });
            hostConn.on('open', () => {
                document.getElementById('loginModal').style.display = 'none';
                addLog('ç³»ç»Ÿ', 'å·²è¿æ¥æˆ¿ä¸»');
            });
            hostConn.on('data', data => handleData(data));
            hostConn.on('close', () => { alert('æˆ¿ä¸»æ–­å¼€'); location.reload(); });
        }

        function enterGame() {
            broadcast({ type: 'ENTER_GAME' });
            initGameUI();
        }

        // ================= 2. æ•°æ®å¤„ç† =================
        function handleData(data, senderConn) {
            if (isHost) {
                if (data.type === 'LOGIN') {
                    players.push({ id: senderConn.peer, name: data.name, score: 0 });
                    document.getElementById('waitCount').innerText = players.length;
                    broadcast({ type: 'UPDATE_PLAYERS', players: players });
                }
                else if (data.type === 'DRAW_DATA') {
                    broadcast(data); drawOnCanvas(data);
                }
                else if (data.type === 'SKIP_WORD') {
                    // ç”»å¸ˆè¯·æ±‚æ¢è¯
                    currentWord = getRandomWord();
                    broadcast({ type: 'UPDATE_WORD', word: currentWord, drawerId: drawerId });
                }
                else if (data.type === 'GUESS') {
                    // çŒœé¢˜é€»è¾‘
                    if (data.content === currentWord) {
                        let p = players.find(x => x.id === data.from);
                        let d = players.find(x => x.id === drawerId);
                        
                        // é˜²æ­¢é‡å¤åŠ åˆ†
                        if (!data.hasWon) {
                            if(p) p.score += 10;
                            if(d) d.score += 5;
                            broadcast({ type: 'CORRECT_GUESS', winner: p.name, answer: currentWord, players: players });
                            // çŒœå¯¹ç›´æ¥ä¸‹ä¸€è½®
                            setTimeout(nextRound, 2000); 
                        }
                    } else {
                        broadcast({ type: 'CHAT', name: data.name, content: data.content });
                    }
                }
            } 
            
            // é€šç”¨é€»è¾‘
            if (data.type === 'WELCOME') { hostConn.send({ type: 'LOGIN', name: myName }); }
            else if (data.type === 'UPDATE_PLAYERS') { players = data.players; renderPlayerList(); if(isHost) document.getElementById('waitCount').innerText = players.length; }
            else if (data.type === 'ENTER_GAME') { initGameUI(); }
            else if (data.type === 'DRAW_DATA') { drawOnCanvas(data); }
            else if (data.type === 'CLEAR_CANVAS') { ctx.clearRect(0, 0, canvas.width, canvas.height); }
            else if (data.type === 'CHAT') { addLog(data.name, data.content); }
            else if (data.type === 'ROUND_START') { startRoundUI(data); }
            else if (data.type === 'UPDATE_WORD') { updateWordUI(data); } // æ¢è¯åˆ·æ–°
            else if (data.type === 'CORRECT_GUESS') {
                addLog('ç³»ç»Ÿ', `ğŸ‰ ${data.winner} çŒœå¯¹äº†ï¼š${data.answer}!`, 'correct');
                players = data.players;
                renderPlayerList();
            }
        }

        function broadcast(msg) {
            if(isHost) {
                if(msg.type !== 'DRAW_DATA') handleData(msg); 
                connList.forEach(c => c.send(msg));
            } else {
                hostConn.send(msg);
            }
        }

        // ================= 3. æ¸¸æˆæµç¨‹ =================
        function initGameUI() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('wordOverlay').style.display = 'flex';
            if(isHost) {
                document.getElementById('overlayText').innerText = "æˆ¿ä¸»è¯·é€‰æ‹©é¢˜åº“";
                document.getElementById('hostControls').style.display = 'flex';
            } else {
                document.getElementById('overlayText').innerText = "ç­‰å¾…æˆ¿ä¸»é€‰é¢˜...";
            }
        }

        function startGame(category) {
            currentCategory = category;
            // å¼€å§‹å¾ªç¯
            startRoundLoop(0);
        }

        let roundIdx = -1;
        function nextRound() {
            startRoundLoop((roundIdx + 1) % players.length);
        }

        function startRoundLoop(idx) {
            roundIdx = idx;
            drawerId = players[idx].id;
            currentWord = getRandomWord();
            
            // å¹¿æ’­
            broadcast({
                type: 'ROUND_START',
                drawerId: drawerId,
                word: currentWord
            });
        }

        function getRandomWord() {
            const list = AI_WORDS[currentCategory];
            return list[Math.floor(Math.random() * list.length)];
        }

        // UI å“åº”
        function startRoundUI(data) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawerId = data.drawerId;
            currentWord = data.word; // å®¢æˆ·ç«¯ä¹Ÿè¦å­˜ä¸€ä¸‹ç”¨äºæ ¸å¯¹
            renderPlayerList();
            
            const isMe = (myId === drawerId);
            const overlay = document.getElementById('wordOverlay');
            const toolBar = document.getElementById('toolBar');
            const inputArea = document.getElementById('guessInputArea');
            const drawerControls = document.getElementById('drawerControls');

            // éšè—æˆ¿ä¸»æ§ä»¶
            document.getElementById('hostControls').style.display = 'none';

            if (isMe) {
                // æˆ‘æ˜¯ç”»å¸ˆ
                overlay.style.display = 'flex';
                document.getElementById('overlayText').innerHTML = `é¢˜ç›®ï¼š<span style="color:#a29bfe;font-size:50px;">${data.word}</span><br><span style="font-size:20px;color:#888;">(è¯·ä¸è¦å†™å‡ºç­”æ¡ˆ)</span>`;
                drawerControls.style.display = 'block';
                toolBar.style.display = 'none'; // å¼€å§‹ç”»ä¹‹å‰ä¸æ˜¾ç¤ºå·¥å…·
                inputArea.style.display = 'none';
            } else {
                // æˆ‘æ˜¯çŒœé¢˜è€…
                overlay.style.display = 'none';
                toolBar.style.display = 'none';
                drawerControls.style.display = 'none';
                inputArea.style.display = 'flex';
                let dName = players.find(p=>p.id===drawerId)?.name || "ç”»å¸ˆ";
                document.getElementById('statusText').innerText = `æ­£åœ¨ç”»ç”»: ${dName}`;
            }
        }

        // ç”»å¸ˆç‚¹å‡»â€œå¼€å§‹ä½œç”»â€
        function startDrawing() {
            document.getElementById('wordOverlay').style.display = 'none';
            document.getElementById('toolBar').style.display = 'flex';
        }

        // ç”»å¸ˆç‚¹å‡»â€œæ¢ä¸€ä¸ªè¯â€
        function skipWord() {
            if(isHost) {
                // æˆ¿ä¸»ç›´æ¥æ¢
                currentWord = getRandomWord();
                broadcast({ type: 'UPDATE_WORD', word: currentWord, drawerId: drawerId });
            } else {
                // ç©å®¶è¯·æ±‚æˆ¿ä¸»æ¢
                hostConn.send({ type: 'SKIP_WORD' });
            }
        }

        function updateWordUI(data) {
            // åªæœ‰ç”»å¸ˆèƒ½çœ‹åˆ°æ–°è¯æ›´æ–°
            if(myId === data.drawerId) {
                currentWord = data.word;
                document.getElementById('overlayText').innerHTML = `é¢˜ç›®ï¼š<span style="color:#a29bfe;font-size:50px;">${data.word}</span><br><span style="font-size:20px;color:#888;">(è¯·ä¸è¦å†™å‡ºç­”æ¡ˆ)</span>`;
            }
        }

        // ================= 4. ç”»æ¿é€»è¾‘ =================
        let painting = false;
        let currentColor = '#000000';
        let lastX = 0, lastY = 0;

        function initCanvasEvents() {
            canvas.onmousedown = (e) => startDraw(e.offsetX, e.offsetY);
            canvas.onmousemove = (e) => moveDraw(e.offsetX, e.offsetY);
            canvas.onmouseup = endDraw;
            
            canvas.ontouchstart = (e) => {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                startDraw(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
            };
            canvas.ontouchmove = (e) => {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                moveDraw(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
            };
            canvas.ontouchend = endDraw;
        }

        function startDraw(x, y) {
            if (myId !== drawerId) return;
            painting = true; lastX = x; lastY = y;
        }

        function moveDraw(x, y) {
            if (!painting) return;
            const w = canvas.width; const h = canvas.height;
            const drawData = { type: 'DRAW_DATA', x1: lastX/w, y1: lastY/h, x2: x/w, y2: y/h, color: currentColor };
            drawOnCanvas(drawData);
            if(isHost) broadcast(drawData); else hostConn.send(drawData);
            lastX = x; lastY = y;
        }

        function endDraw() { painting = false; }

        function drawOnCanvas(data) {
            const w = canvas.width; const h = canvas.height;
            ctx.beginPath();
            ctx.moveTo(data.x1 * w, data.y1 * h);
            ctx.lineTo(data.x2 * w, data.y2 * h);
            ctx.strokeStyle = data.color;
            ctx.lineWidth = data.color === '#ffffff' ? 20 : 3;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        function setColor(c) { currentColor = c; }
        function clearCanvas(send) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if(send) { if(isHost) broadcast({type:'CLEAR_CANVAS'}); else hostConn.send({type:'CLEAR_CANVAS'}); }
        }

        // ================= 5. èŠå¤©ä¸è¾…åŠ© =================
        function sendGuess() {
            const ipt = document.getElementById('guessInput');
            const val = ipt.value.trim();
            if(!val) return;
            const msg = { type: 'GUESS', name: myName, content: val, from: myId };
            if(isHost) handleData(msg); else hostConn.send(msg);
            ipt.value = '';
        }

        function addLog(name, text, type='') {
            const list = document.getElementById('chatList');
            const div = document.createElement('div');
            div.className = `chat-msg ${type}`;
            div.innerText = `${name}: ${text}`;
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }

        function renderPlayerList() {
            const list = document.getElementById('playerList');
            list.innerHTML = '';
            players.forEach(p => {
                let div = document.createElement('div');
                div.className = `player-card ${p.id === drawerId ? 'drawer' : ''}`;
                div.innerHTML = `<div class="p-avatar">ğŸ§¸</div><div class="p-name">${p.name}</div><div class="p-score">${p.score}</div>`;
                list.appendChild(div);
            });
        }

        function copyId() { navigator.clipboard.writeText(myId).then(()=>alert('æˆ¿å·å·²å¤åˆ¶')); }
    </script>
</body>
</html>
